<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒƒãƒ—ãƒ™ãƒ¼ã‚¹åº§æ¨™ä¿®æ­£ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f8ff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .map-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        #map {
            height: 100%;
            border-radius: 10px;
        }
        .step {
            background: #e8f4ff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 5px solid #007bff;
        }
        .step h4 {
            margin: 0 0 10px 0;
            color: #007bff;
        }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
            font-size: 16px;
        }
        button:hover {
            background: #218838;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .store-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
        }
        .store-item:hover {
            background: #e9ecef;
        }
        .store-item.selected {
            background: #d4edda;
            border-color: #28a745;
        }
        .store-item.processed {
            background: #d1ecf1;
            border-color: #bee5eb;
        }
        .address-search {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
        .result-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        .coordinates {
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .search-marker {
            background: #ff4444;
            border: 2px solid white;
            border-radius: 50%;
            width: 12px;
            height: 12px;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- å·¦å´: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="control-panel">
            <h2>ğŸ—ºï¸ ãƒãƒƒãƒ—ãƒ™ãƒ¼ã‚¹åº§æ¨™ä¿®æ­£</h2>
            
            <div class="step">
                <h4>ğŸ“‹ å‡¦ç†ã®æµã‚Œ</h4>
                <p>1ï¸âƒ£ Googleãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ã‹ã‚‰ä½æ‰€å–å¾—</p>
                <p>2ï¸âƒ£ ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—ã§ä½æ‰€æ¤œç´¢</p>
                <p>3ï¸âƒ£ ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã§åº§æ¨™å–å¾—</p>
                <p>4ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åº§æ¨™ä¿å­˜</p>
            </div>
            
            <button onclick="loadStores()">åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿</button>
            
            <div id="storesList"></div>
            
            <div id="currentProcess" style="display: none;">
                <h3>ç¾åœ¨å‡¦ç†ä¸­ã®åº—èˆ—</h3>
                <div id="currentStore"></div>
                
                <h4>æŠ½å‡ºã—ãŸä½æ‰€</h4>
                <input type="text" id="extractedAddress" class="address-search" placeholder="ä½æ‰€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™">
                
                <button onclick="searchOnMap()">ãƒãƒƒãƒ—ã§ä½æ‰€æ¤œç´¢</button>
                <button onclick="useCurrentCoordinates()" id="useCoordinatesBtn" disabled>ã“ã®ä½ç½®ã®åº§æ¨™ã‚’ä½¿ç”¨</button>
                <button onclick="skipCurrentStore()">ã“ã®åº—èˆ—ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>
                
                <div class="result-display" id="resultDisplay"></div>
            </div>
        </div>
        
        <!-- å³å´: ãƒãƒƒãƒ— -->
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://lywfaolwvkewuouvkzlk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5d2Zhb2x3dmtld3VvdXZremxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDg2NjcsImV4cCI6MjA2OTk4NDY2N30.wBGCHOLbP6ew7Bnvxrq0sKSm1EnHk5NNE1sWWH7ff60';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let map;
        let stores = [];
        let currentStoreIndex = 0;
        let searchMarker = null;
        let clickedCoordinates = null;
        
        // ãƒãƒƒãƒ—åˆæœŸåŒ–
        function initMap() {
            map = L.map('map').setView([35.1694, 136.8754], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            map.on('click', function(e) {
                clickedCoordinates = e.latlng;
                updateClickedPosition(e.latlng);
            });
        }
        
        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadStores() {
            log('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
            
            try {
                const { data: allStores, error } = await supabase
                    .from('stores')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                
                stores = allStores || [];
                log(`${stores.length}åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`);
                
                displayStoresList();
                
            } catch (error) {
                log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // åº—èˆ—ãƒªã‚¹ãƒˆè¡¨ç¤º
        function displayStoresList() {
            const storesList = document.getElementById('storesList');
            let html = '<h3>åº—èˆ—ä¸€è¦§ (ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ)</h3>';
            
            stores.forEach((store, index) => {
                const hasCoordinates = store.latitude && store.longitude && 
                    parseFloat(store.latitude) !== 0 && parseFloat(store.longitude) !== 0;
                
                const statusClass = hasCoordinates ? 'processed' : '';
                const statusIcon = hasCoordinates ? 'âœ…' : 'âŒ';
                
                html += `
                    <div class="store-item ${statusClass}" onclick="selectStore(${index})">
                        <strong>${statusIcon} ${store.name}</strong>
                        <div class="coordinates">
                            ç¾åœ¨åº§æ¨™: ${store.latitude || 'ãªã—'}, ${store.longitude || 'ãªã—'}
                        </div>
                        <small>${store.address || 'ä½æ‰€ãªã—'}</small>
                    </div>
                `;
            });
            
            storesList.innerHTML = html;
        }
        
        // åº—èˆ—é¸æŠ
        function selectStore(index) {
            currentStoreIndex = index;
            const store = stores[index];
            
            // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.store-item').forEach((item, i) => {
                item.classList.toggle('selected', i === index);
            });
            
            // ç¾åœ¨å‡¦ç†ä¸­ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('currentProcess').style.display = 'block';
            
            // åº—èˆ—æƒ…å ±è¡¨ç¤º
            document.getElementById('currentStore').innerHTML = `
                <strong>${store.name}</strong><br>
                <small>ID: ${store.id}</small>
            `;
            
            // ä½æ‰€æŠ½å‡º
            const extractedAddress = extractAddressFromStore(store);
            document.getElementById('extractedAddress').value = extractedAddress;
            
            log(`åº—èˆ—é¸æŠ: ${store.name}`);
            log(`æŠ½å‡ºã—ãŸä½æ‰€: ${extractedAddress}`);
        }
        
        // Googleãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ã‹ã‚‰ä½æ‰€æŠ½å‡º
        function extractAddressFromStore(store) {
            // ã¿ã¡ã®ã‚Šå¼å½“ã®ç‰¹åˆ¥å‡¦ç†
            if (store.name && store.name.includes('ã¿ã¡ã®ã‚Šå¼å½“')) {
                return 'æ„›çŸ¥çœŒåå¤å±‹å¸‚è¥¿åŒºæµ„å¿ƒ1ä¸ç›®4-6';
            }
            
            // æˆåŸçŸ³äº•ã®ç‰¹åˆ¥å‡¦ç†
            if (store.name && store.name.includes('æˆåŸçŸ³äº•')) {
                return 'æ„›çŸ¥çœŒåå¤å±‹å¸‚ä¸­æ‘åŒºåé§…1-1-4 åå¤å±‹ã†ã¾ã„ã‚‚ã‚“é€šã‚Š';
            }
            
            // æ—¢å­˜ã®ä½æ‰€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
            if (store.address && store.address.trim()) {
                return store.address.trim();
            }
            
            // Googleãƒãƒƒãƒ—URLã‹ã‚‰ä½æ‰€æŠ½å‡º
            const urlFields = ['google_maps_url', 'maps_url', 'url', 'link', 'website'];
            
            for (const field of urlFields) {
                const url = store[field];
                if (!url || typeof url !== 'string') continue;
                
                try {
                    const decodedUrl = decodeURIComponent(url);
                    
                    // q= ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ä½æ‰€æŠ½å‡º
                    const qMatch = decodedUrl.match(/[?&]q=([^&]+)/);
                    if (qMatch) {
                        const address = qMatch[1].replace(/\\+/g, ' ');
                        if (address.includes('åå¤å±‹') || address.includes('æ„›çŸ¥')) {
                            return address;
                        }
                    }
                    
                } catch (e) {
                    // URLãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                }
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            return store.name + ' åå¤å±‹';
        }
        
        // ãƒãƒƒãƒ—ã§ä½æ‰€æ¤œç´¢ï¼ˆNominatimã‚’ä½¿ç”¨ï¼‰
        async function searchOnMap() {
            const address = document.getElementById('extractedAddress').value;
            if (!address) return;
            
            log(`ä½æ‰€æ¤œç´¢ä¸­: ${address}`);
            
            try {
                // Nominatimæ¤œç´¢ï¼ˆç›´æ¥å‘¼ã³å‡ºã—ã€CORSã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚ã‚Šï¼‰
                const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=jp&limit=1`;
                
                let searchResult = null;
                
                try {
                    const response = await fetch(searchUrl);
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        searchResult = {
                            lat: parseFloat(data[0].lat),
                            lng: parseFloat(data[0].lon),
                            display_name: data[0].display_name
                        };
                    }
                } catch (corsError) {
                    log('CORSåˆ¶é™ã«ã‚ˆã‚Šå¤–éƒ¨æ¤œç´¢ãŒå¤±æ•—ã€ãƒ­ãƒ¼ã‚«ãƒ«æ¨å®šã‚’ä½¿ç”¨ã—ã¾ã™');
                }
                
                // ãƒ­ãƒ¼ã‚«ãƒ«æ¨å®šã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (!searchResult) {
                    searchResult = estimateLocationFromAddress(address);
                }
                
                if (searchResult) {
                    // ãƒãƒƒãƒ—ã‚’ç§»å‹•
                    map.setView([searchResult.lat, searchResult.lng], 16);
                    
                    // æ¤œç´¢ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
                    if (searchMarker) {
                        map.removeLayer(searchMarker);
                    }
                    
                    searchMarker = L.marker([searchResult.lat, searchResult.lng], {
                        icon: L.divIcon({
                            className: 'search-marker',
                            html: '<div style="background: #ff4444; border: 2px solid white; border-radius: 50%; width: 16px; height: 16px;"></div>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map);
                    
                    searchMarker.bindPopup(`æ¤œç´¢çµæœ: ${address}`).openPopup();
                    
                    // ã‚¯ãƒªãƒƒã‚¯åº§æ¨™ã‚’ã‚»ãƒƒãƒˆ
                    clickedCoordinates = L.latLng(searchResult.lat, searchResult.lng);
                    updateClickedPosition(clickedCoordinates);
                    
                    log(`æ¤œç´¢æˆåŠŸ: ${searchResult.lat.toFixed(6)}, ${searchResult.lng.toFixed(6)}`);
                } else {
                    log('ä½æ‰€æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
                
            } catch (error) {
                log(`æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ä½ç½®æ¨å®š
        function estimateLocationFromAddress(address) {
            const nagoyaAreas = {
                'ä¸­æ‘åŒº': { lat: 35.1694, lng: 136.8754 },
                'è¥¿åŒº': { lat: 35.1890, lng: 136.8954 },
                'ä¸­åŒº': { lat: 35.1681, lng: 136.9066 },
                'æ˜­å’ŒåŒº': { lat: 35.1475, lng: 136.9342 },
                'åå¤å±‹é§…': { lat: 35.1706, lng: 136.8814 },
                'æ „': { lat: 35.1681, lng: 136.9066 },
                'æµ„å¿ƒ': { lat: 35.1938, lng: 136.8901 },
                'åºƒå°è·¯': { lat: 35.1696, lng: 136.8831 }
            };
            
            for (const [area, coords] of Object.entries(nagoyaAreas)) {
                if (address.includes(area)) {
                    return coords;
                }
            }
            
            return nagoyaAreas['åå¤å±‹é§…']; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        }
        
        // ã‚¯ãƒªãƒƒã‚¯ä½ç½®æ›´æ–°
        function updateClickedPosition(latlng) {
            document.getElementById('useCoordinatesBtn').disabled = false;
            log(`ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ä½ç½®: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`);
        }
        
        // ç¾åœ¨ã®åº§æ¨™ã‚’ä½¿ç”¨
        async function useCurrentCoordinates() {
            if (!clickedCoordinates || currentStoreIndex < 0) return;
            
            const store = stores[currentStoreIndex];
            const lat = clickedCoordinates.lat;
            const lng = clickedCoordinates.lng;
            
            log(`åº§æ¨™æ›´æ–°ä¸­: ${store.name} â†’ (${lat.toFixed(6)}, ${lng.toFixed(6)})`);
            
            try {
                const success = await updateStoreCoordinates(store.id, lat, lng);
                
                if (success) {
                    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                    stores[currentStoreIndex].latitude = lat.toString();
                    stores[currentStoreIndex].longitude = lng.toString();
                    
                    log(`âœ… åº§æ¨™æ›´æ–°æˆåŠŸ: ${store.name}`, 'success');
                    
                    // ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
                    displayStoresList();
                    
                    // æ¬¡ã®åº—èˆ—ã¸
                    nextStore();
                } else {
                    log(`âŒ åº§æ¨™æ›´æ–°å¤±æ•—: ${store.name}`, 'error');
                }
                
            } catch (error) {
                log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åº§æ¨™æ›´æ–°
        async function updateStoreCoordinates(storeId, lat, lng) {
            try {
                // æŸ”è»Ÿãªã‚«ãƒ©ãƒ åå¯¾å¿œ
                const updateData = {
                    latitude: lat.toString(),
                    longitude: lng.toString()
                };
                
                const { error } = await supabase
                    .from('stores')
                    .update(updateData)
                    .eq('id', storeId);
                
                return !error;
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }
        
        // æ¬¡ã®åº—èˆ—ã¸
        function nextStore() {
            const nextIndex = stores.findIndex((store, index) => 
                index > currentStoreIndex && 
                (!store.latitude || !store.longitude || 
                 parseFloat(store.latitude) === 0 || parseFloat(store.longitude) === 0)
            );
            
            if (nextIndex !== -1) {
                selectStore(nextIndex);
            } else {
                log('å…¨ã¦ã®åº—èˆ—ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                document.getElementById('currentProcess').style.display = 'none';
            }
        }
        
        // ç¾åœ¨ã®åº—èˆ—ã‚’ã‚¹ã‚­ãƒƒãƒ—
        function skipCurrentStore() {
            nextStore();
        }
        
        // ãƒ­ã‚°æ©Ÿèƒ½
        function log(message, type = 'info') {
            const resultDisplay = document.getElementById('resultDisplay');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            
            if (resultDisplay) {
                resultDisplay.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
                resultDisplay.scrollTop = resultDisplay.scrollHeight;
            }
            
            console.log(message);
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            log('ãƒãƒƒãƒ—ãƒ™ãƒ¼ã‚¹åº§æ¨™ä¿®æ­£ã‚·ã‚¹ãƒ†ãƒ ãŒæº–å‚™ã§ãã¾ã—ãŸ');
        });
    </script>
</body>
</html>