<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº§æ¨™ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .store-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .store-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .coordinate-info {
            font-family: monospace;
            background: #e8e8e8;
            padding: 5px;
            margin: 5px 0;
            border-radius: 3px;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .map-url {
            font-size: 0.9em;
            color: #666;
            word-break: break-all;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” åº§æ¨™ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
        <p>åº—èˆ—ã®åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã€å•é¡Œã®ã‚ã‚‹åº§æ¨™ã‚’ç‰¹å®šã—ã¾ã™ã€‚</p>
        
        <button onclick="analyzeCoordinates()">åº§æ¨™åˆ†æé–‹å§‹</button>
        <button onclick="showOnlyProblematic()">å•é¡Œã®ã‚ã‚‹åº—èˆ—ã®ã¿è¡¨ç¤º</button>
        
        <div id="results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://lywfaolwvkewuouvkzlk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5d2Zhb2x3dmtld3VvdXZremxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDg2NjcsImV4cCI6MjA2OTk4NDY2N30.wBGCHOLbP6ew7Bnvxrq0sKSm1EnHk5NNE1sWWH7ff60';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let storesData = [];
        let problematicStores = [];
        
        // åå¤å±‹å¸‚ã®å¤§ã¾ã‹ãªåº§æ¨™ç¯„å›²
        const NAGOYA_BOUNDS = {
            north: 35.3,
            south: 35.0,
            east: 137.0,
            west: 136.7
        };
        
        async function analyzeCoordinates() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
            
            try {
                const { data: stores, error } = await supabase
                    .from('stores')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                
                storesData = stores || [];
                problematicStores = [];
                
                let html = `<h2>åˆ†æçµæœ (${storesData.length}åº—èˆ—)</h2>`;
                
                let validCoords = 0;
                let invalidCoords = 0;
                let missingCoords = 0;
                let outsideNagoya = 0;
                
                storesData.forEach(store => {
                    const analysis = analyzeStore(store);
                    
                    if (analysis.hasProblems) {
                        problematicStores.push({ store, analysis });
                    }
                    
                    switch (analysis.status) {
                        case 'valid': validCoords++; break;
                        case 'invalid': invalidCoords++; break;
                        case 'missing': missingCoords++; break;
                        case 'outside': outsideNagoya++; break;
                    }
                    
                    html += createStoreHTML(store, analysis);
                });
                
                // çµ±è¨ˆæƒ…å ±
                const statsHtml = `
                    <div class="success">
                        <h3>ğŸ“Š åº§æ¨™çµ±è¨ˆ</h3>
                        <p>âœ… æœ‰åŠ¹ãªåº§æ¨™: ${validCoords}åº—èˆ—</p>
                        <p>âŒ ç„¡åŠ¹ãªåº§æ¨™: ${invalidCoords}åº—èˆ—</p>
                        <p>âš ï¸ åº§æ¨™ãªã—: ${missingCoords}åº—èˆ—</p>
                        <p>ğŸ—ºï¸ åå¤å±‹å¸‚å¤–: ${outsideNagoya}åº—èˆ—</p>
                        <p><strong>å•é¡Œã®ã‚ã‚‹åº—èˆ—: ${problematicStores.length}åº—èˆ—</strong></p>
                    </div>
                `;
                
                resultsDiv.innerHTML = statsHtml + html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        function analyzeStore(store) {
            const lat = parseFloat(store.latitude);
            const lng = parseFloat(store.longitude);
            
            let status = 'valid';
            let issues = [];
            let hasProblems = false;
            
            // åº§æ¨™ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
            if (!store.latitude || !store.longitude) {
                status = 'missing';
                issues.push('åº§æ¨™ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                hasProblems = true;
            }
            // åº§æ¨™ã®æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯
            else if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
                status = 'invalid';
                issues.push('ç„¡åŠ¹ãªåº§æ¨™å€¤ã§ã™');
                hasProblems = true;
            }
            // åå¤å±‹å¸‚å†…ã‹ãƒã‚§ãƒƒã‚¯
            else if (lat < NAGOYA_BOUNDS.south || lat > NAGOYA_BOUNDS.north || 
                     lng < NAGOYA_BOUNDS.west || lng > NAGOYA_BOUNDS.east) {
                status = 'outside';
                issues.push('åå¤å±‹å¸‚å¤–ã®åº§æ¨™ã§ã™');
                hasProblems = true;
            }
            
            // Googleãƒãƒƒãƒ—URLåˆ†æ
            const extractedCoords = extractCoordinatesFromGoogleMaps(store);
            
            return {
                status,
                issues,
                hasProblems,
                currentCoords: { lat, lng },
                extractedCoords,
                hasUrl: hasGoogleMapsUrl(store)
            };
        }
        
        function createStoreHTML(store, analysis) {
            let cssClass = '';
            let statusIcon = '';
            
            switch (analysis.status) {
                case 'valid':
                    cssClass = 'success';
                    statusIcon = 'âœ…';
                    break;
                case 'invalid':
                    cssClass = 'error';
                    statusIcon = 'âŒ';
                    break;
                case 'missing':
                    cssClass = 'warning';
                    statusIcon = 'âš ï¸';
                    break;
                case 'outside':
                    cssClass = 'warning';
                    statusIcon = 'ğŸ—ºï¸';
                    break;
            }
            
            return `
                <div class="store-item ${cssClass}">
                    <div class="store-name">${statusIcon} ${store.name} (${store.category || 'ã‚«ãƒ†ã‚´ãƒªãªã—'})</div>
                    <div class="coordinate-info">
                        ç¾åœ¨ã®åº§æ¨™: ${store.latitude || 'ãªã—'}, ${store.longitude || 'ãªã—'}
                        ${analysis.extractedCoords ? 
                            `<br>æŠ½å‡ºå¯èƒ½åº§æ¨™: ${analysis.extractedCoords.lat}, ${analysis.extractedCoords.lng}` : 
                            '<br>URLåº§æ¨™: æŠ½å‡ºå¤±æ•—'
                        }
                    </div>
                    ${analysis.issues.length > 0 ? 
                        `<div class="warning">å•é¡Œ: ${analysis.issues.join(', ')}</div>` : ''
                    }
                    <div class="map-url">ä½æ‰€: ${store.address || 'ä½æ‰€ãªã—'}</div>
                    ${getUrlsFromStore(store)}
                </div>
            `;
        }
        
        function getUrlsFromStore(store) {
            const urlFields = ['google_maps_url', 'maps_url', 'url', 'link', 'google_maps', 'map_link', 'website'];
            let urls = [];
            
            urlFields.forEach(field => {
                if (store[field] && store[field].includes('google')) {
                    urls.push(`<div class="map-url">${field}: ${store[field]}</div>`);
                }
            });
            
            return urls.join('');
        }
        
        function hasGoogleMapsUrl(store) {
            const urlFields = ['google_maps_url', 'maps_url', 'url', 'link', 'google_maps', 'map_link', 'website'];
            
            for (const field of urlFields) {
                if (store[field] && typeof store[field] === 'string' && store[field].includes('google')) {
                    return true;
                }
            }
            
            return Object.values(store).some(value => 
                typeof value === 'string' && (
                    value.includes('maps.google') || 
                    value.includes('goo.gl/maps') ||
                    (value.includes('@') && value.includes(','))
                )
            );
        }
        
        function extractCoordinatesFromGoogleMaps(store) {
            const urlFields = ['google_maps_url', 'maps_url', 'url', 'link', 'google_maps', 'map_link', 'website'];
            let mapUrl = null;
            
            for (const field of urlFields) {
                if (store[field] && typeof store[field] === 'string' && store[field].includes('google')) {
                    mapUrl = store[field];
                    break;
                }
            }
            
            if (!mapUrl) {
                for (const [key, value] of Object.entries(store)) {
                    if (typeof value === 'string' && (
                        value.includes('maps.google') || 
                        value.includes('goo.gl/maps') ||
                        (value.includes('@') && value.includes(','))
                    )) {
                        mapUrl = value;
                        break;
                    }
                }
            }
            
            if (!mapUrl) return null;
            
            const patterns = [
                /@(-?\d+\.?\d*),(-?\d+\.?\d*),/,
                /!3d(-?\d+\.?\d*).*!4d(-?\d+\.?\d*)/,
                /ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/,
                /q=(-?\d+\.?\d*),(-?\d+\.?\d*)/,
                /center=(-?\d+\.?\d*),(-?\d+\.?\d*)/
            ];
            
            for (const pattern of patterns) {
                const match = mapUrl.match(pattern);
                if (match) {
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    
                    if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
                        return { lat, lng };
                    }
                }
            }
            
            return null;
        }
        
        function showOnlyProblematic() {
            if (problematicStores.length === 0) {
                alert('å…ˆã«åˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            let html = `<h2>ğŸš¨ å•é¡Œã®ã‚ã‚‹åº—èˆ— (${problematicStores.length}åº—èˆ—)</h2>`;
            
            problematicStores.forEach(({ store, analysis }) => {
                html += createStoreHTML(store, analysis);
            });
            
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>