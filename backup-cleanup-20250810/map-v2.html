<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
    <title>ã‚°ãƒ«ãƒ³ã¦ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ— - åå¤å±‹</title>
    <link rel="icon" href="favicon.png" type="image/png">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-green: #98D8C8;
            --light-green: #B8E8D8;
            --dark-green: #78C8B8;
            --primary-pink: #FFB6C1;
            --accent-peach: #FFDAB9;
            --white: #ffffff;
            --bg-cream: #faf8f5;
            --text-dark: #333333;
            --shadow: rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', sans-serif;
            background: var(--bg-cream);
            overflow-x: hidden;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--primary-green) 100%);
            color: var(--text-dark);
            padding: 1rem;
            box-shadow: 0 2px 10px var(--shadow);
            position: relative;
            z-index: 1001;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .hamburger-btn {
            background: none;
            border: none;
            cursor: pointer;
            flex-direction: column;
            display: none;
        }

        .hamburger-line {
            width: 25px;
            height: 3px;
            background: var(--text-dark);
            margin: 3px 0;
            transition: 0.3s;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-right {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .admin-toggle-btn {
            background: var(--white);
            color: var(--text-dark);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .admin-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .admin-toggle-btn.active {
            background: var(--dark-green);
            color: var(--white);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--text-dark);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        /* çµ±è¨ˆè¡¨ç¤º */
        .stats {
            background: var(--white);
            padding: 1rem;
            display: flex;
            justify-content: center;
            gap: 2rem;
            box-shadow: 0 2px 5px var(--shadow);
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-green);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-dark);
            margin-top: 0.2rem;
        }

        /* æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
        .search-section {
            background: var(--white);
            padding: 1rem;
            box-shadow: 0 2px 5px var(--shadow);
        }

        #searchInput {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--light-green);
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        #searchInput:focus {
            border-color: var(--primary-green);
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: var(--light-green);
            color: var(--text-dark);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: var(--primary-green);
            color: var(--white);
        }

        /* åœ°å›³ */
        #map {
            height: 70vh;
            width: 100%;
            z-index: 1;
        }

        /* ç®¡ç†è€…ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .admin-section {
            background: var(--accent-peach);
            padding: 1rem;
            margin: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .admin-section h3 {
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        .admin-section button {
            background: var(--primary-green);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 0.5rem;
            transition: background 0.3s;
        }

        .admin-section button:hover {
            background: var(--dark-green);
        }

        /* ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--white);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--text-dark);
        }

        .review-form {
            margin-top: 1rem;
        }

        .review-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .review-form input,
        .review-form textarea,
        .review-form select {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .review-form button {
            background: var(--primary-green);
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-green);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .stats {
                gap: 1rem;
            }

            .filter-buttons {
                justify-content: center;
            }

            #map {
                height: 60vh;
            }

            .hamburger-btn {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <header>
        <div class="header-content">
            <div class="header-left">
                <button class="hamburger-btn" id="hamburgerBtn">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                <h1><i class="fas fa-map-marked-alt"></i>ã‚°ãƒ«ãƒ³ã¦ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—</h1>
                <span style="font-size: 0.8rem; color: var(--accent-peach);">presents by naco</span>
            </div>
            <div class="header-right">
                <div class="user-info" id="userInfo" style="display: none;">
                    <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
                    <span id="userName"></span>
                    <button onclick="handleLogout()" class="admin-toggle-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
                <button onclick="handleLogin()" class="admin-toggle-btn" id="loginBtn">ğŸ“§ ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button onclick="toggleAdminMode()" class="admin-toggle-btn" id="adminToggleBtn" style="display: none;">
                    <i class="fas fa-cog"></i> ç®¡ç†
                </button>
            </div>
        </div>
    </header>

    <!-- çµ±è¨ˆè¡¨ç¤º -->
    <div class="stats">
        <div class="stat-item">
            <div class="stat-number" id="totalStores">-</div>
            <div class="stat-label">ç·åº—èˆ—æ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="visibleStores">-</div>
            <div class="stat-label">è¡¨ç¤ºä¸­</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="totalReviews">-</div>
            <div class="stat-label">ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°</div>
        </div>
    </div>

    <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="search-section">
        <input type="text" id="searchInput" placeholder="åº—åãƒ»ä½æ‰€ãƒ»ã‚«ãƒ†ã‚´ãƒªã§æ¤œç´¢...">
        <div class="filter-buttons" id="filterButtons"></div>
    </div>

    <!-- åœ°å›³ -->
    <div id="map"></div>

    <!-- ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ -->
    <div id="adminSection" class="admin-section" style="display: none;">
        <h3><i class="fas fa-cog"></i> ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</h3>
        <button id="coordinateFixBtn"><i class="fas fa-map-pin"></i> åº§æ¨™ã‚’ä¿®æ­£</button>
        <button onclick="showStoreForm()"><i class="fas fa-plus"></i> åº—èˆ—è¿½åŠ </button>
        <button onclick="exportData()"><i class="fas fa-download"></i> ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>

    <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeReviewModal()">&times;</span>
            <h2 id="reviewModalTitle">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿</h2>
            <form class="review-form" id="reviewForm">
                <label for="reviewRating">è©•ä¾¡:</label>
                <select id="reviewRating">
                    <option value="5">â­â­â­â­â­ ç´ æ™´ã‚‰ã—ã„</option>
                    <option value="4">â­â­â­â­ è‰¯ã„</option>
                    <option value="3">â­â­â­ æ™®é€š</option>
                    <option value="2">â­â­ ã„ã¾ã„ã¡</option>
                    <option value="1">â­ æ‚ªã„</option>
                </select>

                <label for="reviewComment">ã‚³ãƒ¡ãƒ³ãƒˆ:</label>
                <textarea id="reviewComment" rows="4" placeholder="ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ã®å¯¾å¿œçŠ¶æ³ã‚„æ„Ÿæƒ³ã‚’æ•™ãˆã¦ãã ã•ã„"></textarea>

                <label>
                    <input type="checkbox" id="reviewVisited"> å®Ÿéš›ã«è¨ªå•ã—ã¾ã—ãŸ
                </label>

                <button type="submit">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿</button>
            </form>
            
            <div id="existingReviews"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module" src="supabase-client.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let map, markers = [], storesData = [], reviewsData = [];
        let currentUser = null, adminMode = false;
        let selectedStoreId = null;

        // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¹ã‚¿ã‚¤ãƒ«
        const categoryStyles = {
            'å’Œé£Ÿ': { color: '#ff6b6b', icon: 'fa-utensils' },
            'æ´‹é£Ÿ': { color: '#4ecdc4', icon: 'fa-pizza-slice' },
            'ã‚«ãƒ•ã‚§': { color: '#f7b731', icon: 'fa-coffee' },
            'ãƒ‘ãƒ³å±‹': { color: '#5f27cd', icon: 'fa-bread-slice' },
            'è²©å£²åº—': { color: '#00d2d3', icon: 'fa-gift' },
            'ã‚¹ã‚¤ãƒ¼ãƒ„': { color: '#ff9ff3', icon: 'fa-ice-cream' },
            'ãã®ä»–': { color: '#95a5a6', icon: 'fa-store' }
        };

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        async function initApp() {
            console.log('ğŸš€ ã‚°ãƒ«ãƒ³ã¦ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—v2 åˆæœŸåŒ–é–‹å§‹');
            showLoading();

            try {
                // åœ°å›³åˆæœŸåŒ–
                initMap();

                // èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
                await checkAuthStatus();

                // åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                await loadStores();

                // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                await loadReviews();

                // çµ±è¨ˆæ›´æ–°
                updateStats();

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ç”Ÿæˆ
                generateFilterButtons();

                // æ¤œç´¢æ©Ÿèƒ½åˆæœŸåŒ–
                initializeSearch();

                console.log('âœ… åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            } finally {
                hideLoading();
            }
        }

        // åœ°å›³åˆæœŸåŒ–
        function initMap() {
            map = L.map('map').setView([35.1815, 136.9066], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            console.log('âœ… åœ°å›³åˆæœŸåŒ–å®Œäº†');
        }

        // èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        async function checkAuthStatus() {
            const { data: { session } } = await window.supabase.auth.getSession();
            if (session) {
                await handleAuthSuccess(session.user);
            }

            // èªè¨¼çŠ¶æ…‹ç›£è¦–
            window.supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN') {
                    await handleAuthSuccess(session.user);
                } else if (event === 'SIGNED_OUT') {
                    handleAuthSignOut();
                }
            });
        }

        // èªè¨¼æˆåŠŸå‡¦ç†
        async function handleAuthSuccess(user) {
            currentUser = user;
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('adminToggleBtn').style.display = 'block';
            document.getElementById('userName').textContent = user.email;
            document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
            console.log('âœ… èªè¨¼æˆåŠŸ:', user.email);
        }

        // èªè¨¼è§£é™¤å‡¦ç†
        function handleAuthSignOut() {
            currentUser = null;
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('adminToggleBtn').style.display = 'none';
            adminMode = false;
            document.getElementById('adminSection').style.display = 'none';
        }

        // ãƒ­ã‚°ã‚¤ãƒ³
        async function handleLogin() {
            await window.supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.href
                }
            });
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        async function handleLogout() {
            await window.supabase.auth.signOut();
        }

        // ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleAdminMode() {
            adminMode = !adminMode;
            const adminSection = document.getElementById('adminSection');
            const toggleBtn = document.getElementById('adminToggleBtn');
            
            if (adminMode) {
                adminSection.style.display = 'block';
                toggleBtn.classList.add('active');
            } else {
                adminSection.style.display = 'none';
                toggleBtn.classList.remove('active');
            }
        }

        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadStores() {
            try {
                const { data: stores, error } = await window.supabase
                    .from('stores')
                    .select('*')
                    .order('name');

                if (error) throw error;

                storesData = stores;
                displayStores(stores);
                console.log(`âœ… ${stores.length}ä»¶ã®åº—èˆ—ã‚’èª­ã¿è¾¼ã¿`);
            } catch (error) {
                console.error('âŒ åº—èˆ—ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadReviews() {
            try {
                const { data: reviews, error } = await window.supabase
                    .from('store_reviews')
                    .select('*');

                if (error) throw error;

                reviewsData = reviews;
                console.log(`âœ… ${reviews.length}ä»¶ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã¿`);
            } catch (error) {
                console.error('âŒ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // åº—èˆ—è¡¨ç¤º
        function displayStores(stores) {
            // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            stores.forEach(store => {
                if (store.latitude && store.longitude) {
                    const style = categoryStyles[store.category] || categoryStyles['ãã®ä»–'];
                    
                    const customIcon = L.divIcon({
                        html: `<div style="background-color: ${style.color}; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
                            <i class="fas ${style.icon}"></i>
                        </div>`,
                        className: 'custom-div-icon',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });

                    const marker = L.marker([store.latitude, store.longitude], {
                        icon: customIcon
                    }).addTo(map);

                    const storeReviews = reviewsData.filter(r => r.store_id === store.id);
                    const avgRating = storeReviews.length > 0 ? 
                        (storeReviews.reduce((sum, r) => sum + r.rating, 0) / storeReviews.length).toFixed(1) : 
                        'ãªã—';

                    marker.bindPopup(`
                        <div style="min-width: 200px;">
                            <h3 style="margin: 0 0 0.5rem 0; color: ${style.color};">
                                <i class="fas ${style.icon}"></i> ${store.name}
                            </h3>
                            <p style="margin: 0.25rem 0; color: #666;">
                                <i class="fas fa-map-marker-alt"></i> ${store.address}
                            </p>
                            <p style="margin: 0.25rem 0;">
                                <span style="background: ${style.color}; color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.8rem;">
                                    ${store.category}
                                </span>
                            </p>
                            <p style="margin: 0.5rem 0;">
                                <i class="fas fa-star" style="color: gold;"></i> 
                                å¹³å‡è©•ä¾¡: ${avgRating} (${storeReviews.length}ä»¶)
                            </p>
                            <button onclick="openReviewModal(${store.id}, '${store.name}')" 
                                    style="background: ${style.color}; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 0.5rem;">
                                <i class="fas fa-comment"></i> ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ã‚‹ãƒ»æŠ•ç¨¿
                            </button>
                        </div>
                    `);

                    markers.push(marker);
                }
            });
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ç”Ÿæˆ
        function generateFilterButtons() {
            const filterButtons = document.getElementById('filterButtons');
            const categories = [...new Set(storesData.map(store => store.category))];
            
            filterButtons.innerHTML = `
                <button class="filter-btn active" onclick="filterStores('all')">
                    <i class="fas fa-list"></i> ã™ã¹ã¦
                </button>
            `;

            categories.forEach(category => {
                const style = categoryStyles[category] || categoryStyles['ãã®ä»–'];
                filterButtons.innerHTML += `
                    <button class="filter-btn" onclick="filterStores('${category}')" style="background-color: ${style.color}; color: white;">
                        <i class="fas ${style.icon}"></i> ${category}
                    </button>
                `;
            });
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterStores(category) {
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            let filteredStores;
            if (category === 'all') {
                filteredStores = storesData;
            } else {
                filteredStores = storesData.filter(store => store.category === category);
            }

            displayStores(filteredStores);
            updateStats(filteredStores);
        }

        // æ¤œç´¢æ©Ÿèƒ½åˆæœŸåŒ–
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (query === '') {
                    displayStores(storesData);
                    updateStats();
                    return;
                }

                const filteredStores = storesData.filter(store => 
                    store.name.toLowerCase().includes(query) ||
                    store.address.toLowerCase().includes(query) ||
                    store.category.toLowerCase().includes(query) ||
                    (store.description && store.description.toLowerCase().includes(query))
                );

                displayStores(filteredStores);
                updateStats(filteredStores);
            });
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats(stores = storesData) {
            document.getElementById('totalStores').textContent = storesData.length;
            document.getElementById('visibleStores').textContent = stores.length;
            document.getElementById('totalReviews').textContent = reviewsData.length;
        }

        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã
        function openReviewModal(storeId, storeName) {
            selectedStoreId = storeId;
            document.getElementById('reviewModalTitle').textContent = `${storeName} ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼`;
            document.getElementById('reviewModal').style.display = 'block';
            
            // æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            displayExistingReviews(storeId);
        }

        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        function closeReviewModal() {
            document.getElementById('reviewModal').style.display = 'none';
            selectedStoreId = null;
        }

        // æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        function displayExistingReviews(storeId) {
            const storeReviews = reviewsData.filter(r => r.store_id === storeId);
            const reviewsContainer = document.getElementById('existingReviews');
            
            if (storeReviews.length === 0) {
                reviewsContainer.innerHTML = '<p>ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã—ã¦ãã ã•ã„ï¼</p>';
                return;
            }

            reviewsContainer.innerHTML = '<h3>æ—¢å­˜ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>' + 
                storeReviews.map(review => `
                    <div style="border: 1px solid #ddd; padding: 1rem; margin: 0.5rem 0; border-radius: 5px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div>
                                ${'â­'.repeat(review.rating)}
                                ${review.visited ? '<span style="background: green; color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.8rem;">è¨ªå•æ¸ˆã¿</span>' : ''}
                            </div>
                            <small>${new Date(review.created_at).toLocaleDateString()}</small>
                        </div>
                        <p>${review.comment}</p>
                    </div>
                `).join('');
        }

        // ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('reviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                return;
            }

            const rating = parseInt(document.getElementById('reviewRating').value);
            const comment = document.getElementById('reviewComment').value;
            const visited = document.getElementById('reviewVisited').checked;

            try {
                const { data, error } = await window.supabase
                    .from('store_reviews')
                    .insert([{
                        store_id: selectedStoreId,
                        user_id: currentUser.id,
                        rating,
                        comment,
                        visited
                    }]);

                if (error) throw error;

                alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼');
                closeReviewModal();
                
                // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                await loadReviews();
                displayStores(storesData);
                updateStats();
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('reviewForm').reset();
            } catch (error) {
                console.error('âŒ ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const modal = document.getElementById('reviewModal');
            if (event.target == modal) {
                closeReviewModal();
            }
        }

        // DOMContentLoadedæ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>