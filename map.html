<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
    <title>グルテンフリーマップ - nacoコミュニティ</title>
    <link rel="icon" href="favicon.png" type="image/png">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CL6YY713PG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-CL6YY713PG');
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Comfortaa:wght@300;400;700&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- セキュリティユーティリティ -->
    <script src="security-utils.js"></script>
    <!-- エラーハンドリング -->
    <script src="error-handler.js"></script>
    <!-- パフォーマンス管理 -->
    <script src="performance-manager.js"></script>
    <!-- 位置情報サービス -->
    <script src="location-service.js"></script>
    
    <style>
        :root {
            /* 前回のスクリーンショットに近いパステルカラー */
            --primary-pink: #FFB6C1;      /* より鮮やかなピンク */
            --secondary-mint: #98D8C8;    /* ミントグリーン */
            --accent-lavender: #DDA0DD;   /* ラベンダー */
            --accent-peach: #FFDAB9;      /* ピーチプル */
            --accent-sky: #B0E0E6;        /* パウダーブルー */
            --accent-yellow: #F0E68C;     /* カーキ */
            
            /* ベースカラー */
            --white: #ffffff;
            --cream: #FFF8F5;             /* クリーム */
            --light-gray: #F0F8FF;        /* ライトブルーグレー */
            --text-dark: #4A4A4A;         /* ソフトグレー */
            --text-light: #8A8A8A;
            
            /* シャドウ */
            --shadow-soft: rgba(255, 182, 193, 0.3);
            --shadow-medium: rgba(255, 182, 193, 0.4);
            --shadow-strong: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #FFF 50%, var(--accent-sky) 100%);
            color: var(--text-dark);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--secondary-mint) 100%);
            color: var(--text-dark);
            padding: 1.2rem;
            box-shadow: 0 4px 20px var(--shadow-soft);
            position: relative;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-family: 'Comfortaa', 'Noto Sans JP', cursive;
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            color: #4A4A4A;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8);
            letter-spacing: 0.5px;
        }
        
        .logo-text {
            color: #2D2D2D;
            font-weight: 700;
            position: relative;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
        }
        
        .logo-text::after {
            content: '✨';
            position: absolute;
            top: -8px;
            right: -15px;
            font-size: 1rem;
            color: var(--primary-pink);
            animation: sparkle 2s ease-in-out infinite;
        }
        
        /* グラデーションアニメーション */
        @keyframes gradient-shift {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }
        
        /* スパークルアニメーション */
        @keyframes sparkle {
            0%, 100% {
                opacity: 0.7;
                transform: scale(1) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.2) rotate(180deg);
            }
        }

        .naco-character {
            width: 58px;
            height: 58px;
            background-image: url('naco-character.png.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-right: 0.8rem;
            border-radius: 50%;
            box-shadow: 0 3px 12px rgba(255, 182, 193, 0.4);
            animation: gentle-float 3s ease-in-out infinite;
        }

        /* nacoキャラクターにホバー時の反応を追加 */
        .naco-character:hover {
            animation-duration: 1.5s; /* ホバー時は少し早く */
            cursor: pointer;
            transform: scale(1.05);
        }

        /* nacoキャラクターの優しい浮遊アニメーション */
        @keyframes gentle-float {
            0%, 100% {
                transform: translateY(0px);
                box-shadow: 0 3px 12px rgba(255, 182, 193, 0.4);
            }
            50% {
                transform: translateY(-6px);
                box-shadow: 0 8px 20px rgba(255, 182, 193, 0.5);
            }
        }
        
        .logo i {
            font-size: 1.8rem;
            color: var(--secondary-mint);
        }

        .community-badge {
            font-family: 'Kalam', 'Noto Sans JP', cursive;
            background: var(--white);
            color: var(--primary-pink);
            padding: 0.4rem 1rem;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 400;
            margin-left: 1rem;
            box-shadow: 0 3px 15px var(--shadow-soft);
            border: 2px solid var(--primary-pink);
            position: relative;
            overflow: hidden;
        }
        
        .community-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: badge-shine 3s ease-in-out infinite;
        }
        
        @keyframes badge-shine {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .auth-btn {
            background: var(--white);
            border: 2px solid var(--primary-pink);
            color: var(--primary-pink);
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auth-btn:hover {
            background: var(--primary-pink);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--shadow-medium);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-mint);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 500;
            box-shadow: 0 2px 10px var(--shadow-soft);
        }


        /* Main Container */
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
            max-width: 1200px;
            margin: 0 auto;
            gap: 1rem;
            padding: 1rem;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 8px 30px var(--shadow-soft);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .search-header {
            background: linear-gradient(135deg, var(--accent-peach) 0%, var(--secondary-mint) 100%);
            padding: 1rem;
            text-align: center;
        }

        .search-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 0.6rem;
        }

        .search-box {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            background: var(--white);
            box-shadow: inset 0 1px 8px var(--shadow-soft);
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            box-shadow: inset 0 2px 10px var(--shadow-medium), 0 0 0 3px var(--primary-pink);
        }

        .search-box::placeholder {
            color: var(--text-light);
        }

        /* Compact Sidebar Stats */
        .sidebar-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 0.5rem;
            padding: 0.5rem 0.8rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }

        .sidebar-stat-item {
            text-align: center;
            flex: 1;
        }

        .sidebar-stat-number {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-pink);
            margin-bottom: 0.1rem;
        }

        .sidebar-stat-label {
            font-size: 0.65rem;
            color: var(--text-light);
            font-weight: 400;
            line-height: 1;
        }

        .filters {
            padding: 0.6rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.3rem;
        }

        .filter-btn {
            background: var(--light-gray);
            border: none;
            color: var(--text-dark);
            padding: 0.4rem 0.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 400;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.2rem;
            white-space: nowrap;
        }
        
        .filter-btn i {
            font-size: 0.8rem;
        }

        .filter-btn.active {
            color: var(--white);
            transform: scale(1.05);
            box-shadow: 0 4px 15px var(--shadow-medium);
        }

        /* カテゴリ別フィルターボタンの洗練されたカラー */
        .filter-btn[data-category="all"].active {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-lavender) 100%);
            box-shadow: 0 4px 15px rgba(255, 182, 193, 0.4);
        }

        .filter-btn[data-category="和食"].active {
            background: linear-gradient(135deg, #ffffff 0%, #E67E22 100%);
            box-shadow: 0 4px 15px rgba(230, 126, 34, 0.4);
            border: 1px solid #E67E22;
        }

        .filter-btn[data-category="洋食"].active {
            background: linear-gradient(135deg, #ffffff 0%, #27AE60 100%);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            border: 1px solid #27AE60;
        }

        .filter-btn[data-category="カフェ"].active {
            background: linear-gradient(135deg, #ffffff 0%, #8B4513 100%);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.4);
            border: 1px solid #8B4513;
        }

        .filter-btn[data-category="スイーツ"].active {
            background: linear-gradient(135deg, #ffffff 0%, #E91E63 100%);
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
            border: 1px solid #E91E63;
        }

        .filter-btn[data-category="パン屋"].active {
            background: linear-gradient(135deg, #ffffff 0%, #8E44AD 100%);
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.4);
            border: 1px solid #8E44AD;
        }

        .filter-btn[data-category="販売店"].active {
            background: linear-gradient(135deg, #ffffff 0%, #FFD700 100%);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            border: 1px solid #FFD700;
        }

        .filter-btn:hover:not(.active) {
            background: var(--accent-sky);
            transform: translateY(-1px);
        }

        /* Store List */
        .store-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .store-item {
            background: linear-gradient(135deg, var(--white) 0%, var(--cream) 100%);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.6rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .store-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--shadow-medium);
            border-color: var(--primary-pink);
        }

        .store-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .store-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .store-distance {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
            color: var(--primary-pink);
            font-weight: 500;
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.1), rgba(255, 192, 203, 0.2));
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 182, 193, 0.3);
            white-space: nowrap;
            min-width: fit-content;
        }

        .store-distance i {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* 新しい店舗カテゴリデザイン */
        .store-category-wrapper {
            margin-bottom: 0.8rem;
        }

        .store-category-new {
            display: inline-block;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            border: 2px solid rgba(255,255,255,0.3);
        }

        /* 店舗名のスタイル改善 */
        .store-name .name-text {
            margin-left: 0.3rem;
        }

        /* 新しいアクションボタンデザイン */
        .store-actions-new {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 1rem;
        }

        .action-btn-new {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            border: none;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 60px;
        }

        .action-btn-new i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .action-btn-new span {
            line-height: 1;
        }

        /* 詳細ボタン（プライマリ） */
        .action-btn-primary {
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            box-shadow: 0 3px 8px rgba(74, 144, 226, 0.2);
        }

        .action-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
            background: linear-gradient(135deg, #5A9EF0 0%, #4585C8 100%);
        }

        /* 地図ボタン（セカンダリ） */
        .action-btn-secondary {
            background: linear-gradient(135deg, #6C7B7F 0%, #546E7A 100%);
            color: white;
            box-shadow: 0 3px 8px rgba(108, 123, 127, 0.2);
        }

        .action-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 123, 127, 0.3);
            background: linear-gradient(135deg, #7C8B8F 0%, #647E8A 100%);
        }

        /* レビューボタン（アクセント） */
        .action-btn-accent {
            background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%);
            color: white;
            box-shadow: 0 3px 8px rgba(233, 30, 99, 0.2);
        }

        .action-btn-accent:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.3);
            background: linear-gradient(135deg, #F12E73 0%, #D2286B 100%);
        }

        .store-category {
            display: inline-block;
            background: var(--accent-mint);
            color: var(--white);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.8rem;
        }

        .store-category.和食 { background: linear-gradient(45deg, #FFB6C1, #FFC0CB); }
        .store-category.洋食 { background: linear-gradient(45deg, #27AE60, #2ECC71); }
        .store-category.カフェ { background: linear-gradient(45deg, #8B4513, #A0522D); }
        .store-category.パン屋 { background: linear-gradient(45deg, #8E44AD, #9B59B6); }
        .store-category.スイーツ { background: linear-gradient(45deg, #FFE4E1, #FFF0F5); }
        .store-category.販売店 { background: linear-gradient(45deg, #98D8C8, #B0E0E6); }
        .store-category.その他 { background: linear-gradient(45deg, #98D8C8, #B0E0E6); }

        .store-address {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .store-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: space-between;
        }

        .action-btn {
            background: var(--white);
            border: 1px solid var(--primary-pink);
            color: var(--primary-pink);
            padding: 0.5rem 0.8rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .action-btn:hover {
            background: var(--primary-pink);
            color: var(--white);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px var(--shadow-medium);
        }

        .no-stores {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
            font-style: italic;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 8px 30px var(--shadow-soft);
            overflow: hidden;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 20px;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--cream) 0%, var(--white) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 1.2rem;
            color: var(--text-dark);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-gray);
            border-left: 4px solid var(--primary-pink);
            border-right: 4px solid var(--secondary-mint);
            border-radius: 50%;
            animation: gentle-spin 2s ease-in-out infinite;
            margin-bottom: 1rem;
        }

        @keyframes gentle-spin {
            0% { 
                transform: rotate(0deg) scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: rotate(180deg) scale(1.05);
                opacity: 1;
            }
            100% { 
                transform: rotate(360deg) scale(1);
                opacity: 0.8;
            }
        }

        .loading-overlay.hidden {
            display: none;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
        }

        .store-detail-modal {
            max-width: 600px;
        }

        .store-images-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin: 20px 0;
            height: 250px;
        }

        .main-image {
            grid-row: span 2;
            position: relative;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .main-image:hover img {
            transform: scale(1.05);
        }

        .secondary-images {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .secondary-image {
            height: 120px;
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .secondary-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .secondary-image:hover img {
            transform: scale(1.05);
        }

        .image-placeholder {
            color: #adb5bd;
            font-size: 14px;
            text-align: center;
        }

        /* Lightbox Styles */
        .lightbox-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .lightbox-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .lightbox-close {
            position: absolute;
            top: -50px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 40px;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }

        .lightbox-close:hover {
            opacity: 0.7;
        }

        .lightbox-navigation {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }

        .lightbox-prev, .lightbox-next {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 30px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
            pointer-events: auto;
            margin: 0 20px;
        }

        .lightbox-prev:hover, .lightbox-next:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .lightbox-counter {
            color: white;
            margin-top: 20px;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
        }

        .store-detail-info {
            margin-top: 20px;
        }

        .store-detail-section {
            margin-bottom: 20px;
        }

        .store-detail-section h4 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 16px;
        }

        .store-detail-section p {
            color: #6c757d;
            line-height: 1.5;
            margin: 0;
        }

        .store-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .store-action-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .store-action-btn:hover {
            background: var(--accent);
            transform: translateY(-2px);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-gray);
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--primary-pink);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--light-gray);
            color: var(--text-dark);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--cream);
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-pink);
            background: var(--white);
            box-shadow: 0 0 0 3px var(--shadow-soft);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-pink);
        }

        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-lavender) 100%);
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--light-gray);
            color: var(--text-dark);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            margin-left: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--accent-sky);
            transform: translateY(-1px);
        }

        /* Message Styles */
        .error-message {
            color: #e74c3c;
            background: linear-gradient(135deg, #fdf2f2 0%, #fbeaea 100%);
            border: 1px solid #f5c6cb;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .success-message {
            color: #27ae60;
            background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e8 100%);
            border: 1px solid #c3e6cb;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
                padding: 0.5rem;
            }
            
            .sidebar {
                width: 100%;
                height: 300px;
            }
            
            .map-container {
                height: 400px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .sidebar-stats {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .sidebar-stat-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .sidebar-stat-number {
                font-size: 1.2rem;
            }

            .filter-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .store-actions {
                flex-direction: column;
            }
        }

        /* Custom Leaflet Popup Styles */
        .leaflet-popup-content-wrapper {
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 8px 30px var(--shadow-soft);
        }

        .leaflet-popup-content {
            margin: 15px;
        }

        .popup-store-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-pink);
            margin-bottom: 0.5rem;
        }

        .popup-category {
            display: inline-block;
            background: var(--accent-mint);
            color: var(--white);
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .popup-address {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .popup-btn {
            background: var(--primary-pink);
            color: var(--white);
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .popup-btn:hover {
            background: var(--secondary-lavender);
            transform: translateY(-1px);
        }

        /* 洗練されたマーカーのスタイル */
        .sophisticated-marker-wrapper {
            background: transparent !important;
            border: none !important;
        }

        .sophisticated-marker {
            cursor: pointer !important;
            user-select: none;
            position: relative;
            width: 28px;
            height: 44px;
            transition: transform 0.2s ease;
        }

        .sophisticated-marker:hover {
            transform: scale(1.08);
        }

        .marker-teardrop {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sophisticated-marker:hover .marker-teardrop {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.25), 0 4px 10px rgba(0,0,0,0.15);
        }

        /* カスタムポップアップのスタイル */
        .custom-popup {
            font-family: 'Noto Sans JP', sans-serif;
            line-height: 1.4;
            min-width: 200px;
        }

        .custom-popup h4 {
            font-family: 'Comfortaa', 'Noto Sans JP', sans-serif;
        }

        /* Leaflet popup カスタマイズ */
        .leaflet-popup-content-wrapper {
            border-radius: 15px !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
            border: 2px solid var(--primary-pink);
        }

        .leaflet-popup-tip {
            background: var(--white) !important;
            border: 2px solid var(--primary-pink);
            border-top: none !important;
            border-right: none !important;
        }

        /* Floating notification */
        .floating-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            font-weight: 500;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* 現在地マーカーのスタイル */
        .current-location-wrapper {
            background: transparent !important;
            border: none !important;
        }

        .current-location-marker {
            position: relative;
            width: 28px;
            height: 28px;
            cursor: pointer;
        }

        .location-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 50%, #45B7D1 100%);
            border: 4px solid white;
            border-radius: 50%;
            box-shadow: 
                0 0 0 3px rgba(255, 107, 107, 0.3),
                0 0 0 6px rgba(255, 255, 255, 0.8),
                0 6px 20px rgba(255, 107, 107, 0.6),
                0 0 30px rgba(69, 183, 209, 0.4);
            z-index: 1001;
            animation: dotPulse 2.5s ease-in-out infinite;
        }

        .location-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 28px;
            height: 28px;
            background: radial-gradient(circle, rgba(255, 107, 107, 0.6) 0%, rgba(69, 183, 209, 0.3) 50%, rgba(78, 205, 196, 0.2) 70%, transparent 100%);
            border-radius: 50%;
            animation: pulse 2s ease-out infinite;
        }

        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0.9;
            }
            50% {
                transform: translate(-50%, -50%) scale(2.5);
                opacity: 0.5;
            }
            100% {
                transform: translate(-50%, -50%) scale(4.0);
                opacity: 0;
            }
        }

        @keyframes dotPulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                filter: brightness(1);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.15);
                filter: brightness(1.2);
            }
        }

        /* 現在地ボタン */
        .location-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: var(--white);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            color: var(--primary-pink);
            font-size: 16px;
        }

        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            background: var(--primary-pink);
            color: white;
        }

        .location-btn.loading {
            animation: spin 1s linear infinite;
        }

        /* ピンモードボタン */
        .pin-mode-btn {
            position: absolute;
            top: 10px;
            right: 60px;
            z-index: 1000;
            background: var(--white);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .pin-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            background: #FF6B35;
            color: white;
        }

        .pin-mode-btn.active {
            background: #FF6B35;
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }

        .pin-mode-btn i {
            font-size: 1rem;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }


        /* 距離表示 */
        .distance-badge {
            display: inline-block;
            background: rgba(66, 133, 244, 0.1);
            color: #4285f4;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        /* 検索地点マーカー */
        .search-location-marker {
            position: relative;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #9b59b6, #e74c3c);
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 0 0 2px rgba(155, 89, 182, 0.3),
                0 4px 15px rgba(155, 89, 182, 0.4);
            animation: searchPulse 3s ease-in-out infinite;
        }

        .search-location-marker i {
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .search-location-wrapper {
            background: transparent !important;
            border: none !important;
        }

        @keyframes searchPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 
                    0 0 0 2px rgba(155, 89, 182, 0.3),
                    0 4px 15px rgba(155, 89, 182, 0.4);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 
                    0 0 0 4px rgba(155, 89, 182, 0.4),
                    0 6px 20px rgba(155, 89, 182, 0.5);
            }
        }

        /* 検索ポップアップ */
        .search-popup h4 {
            margin: 0 0 8px 0;
            color: var(--text-dark);
            font-size: 1.1rem;
        }

        .search-popup .region {
            margin: 4px 0;
            color: var(--primary-pink);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .search-popup .address {
            margin: 4px 0 0 0;
            color: var(--text-light);
            font-size: 0.8rem;
            line-height: 1.3;
        }

        /* ユーザーピンマーカー */
        .user-pin-marker {
            position: relative;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #FF6B35 0%, #E55A2B 100%);
            border: 3px solid white;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 0 0 2px rgba(255, 107, 53, 0.3),
                0 4px 15px rgba(255, 107, 53, 0.4);
            animation: userPinPulse 3s ease-in-out infinite;
        }

        .user-pin-marker::before {
            content: '';
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(0deg);
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50% 50% 50% 0;
            border: 2px solid #FF6B35;
        }

        .user-pin-marker::after {
            content: '';
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(0deg);
            width: 10px;
            height: 10px;
            background: #FF6B35;
            border-radius: 50%;
            z-index: 1;
        }

        .user-pin-wrapper {
            background: transparent !important;
            border: none !important;
        }

        @keyframes userPinPulse {
            0%, 100% {
                transform: rotate(-45deg) scale(1);
                box-shadow: 
                    0 0 0 2px rgba(255, 107, 53, 0.3),
                    0 4px 15px rgba(255, 107, 53, 0.4);
            }
            50% {
                transform: rotate(-45deg) scale(1.05);
                box-shadow: 
                    0 0 0 4px rgba(255, 107, 53, 0.4),
                    0 6px 20px rgba(255, 107, 53, 0.5);
            }
        }

        .nearest-badge {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
            animation: sparkle 2s ease-in-out infinite;
        }

        .filter-btn[data-category="nearby"].active {
            background: linear-gradient(135deg, #ffffff 0%, #4285f4 100%);
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4);
            border: 1px solid #4285f4;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div>nacoコミュニティマップを読み込み中...</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="naco-character"></div>
                <div class="logo-text">グルテンフリーマップ</div>
                <span class="community-badge">ビヨグル倶楽部 presents by naco</span>
            </div>
            <div class="user-info">
                <div id="loginSection" style="display: none;">
                    <button class="auth-btn" onclick="handleLogin()">
                        <i class="fab fa-google"></i>
                        ログイン
                    </button>
                </div>
                <div id="userSection" style="display: none;">
                    <div class="user-avatar" id="userAvatar">N</div>
                    <button class="auth-btn" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        ログアウト
                    </button>
                </div>
            </div>
        </div>
    </header>


    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="search-header">
                <div class="search-title">
                    <i class="fas fa-search"></i>
                    お店を探す
                </div>
                <input type="text" class="search-box" id="searchBox" placeholder="店名・住所・駅名で検索... (例: 渋谷駅、大阪城)">
                
                <!-- Stats moved to sidebar -->
                <div class="sidebar-stats">
                    <div class="sidebar-stat-item">
                        <div class="sidebar-stat-number" id="totalStores">-</div>
                        <div class="sidebar-stat-label">総店舗数</div>
                    </div>
                    <div class="sidebar-stat-item">
                        <div class="sidebar-stat-number" id="visibleStores">-</div>
                        <div class="sidebar-stat-label">表示中</div>
                    </div>
                    <div class="sidebar-stat-item">
                        <div class="sidebar-stat-number" id="reviewCount">-</div>
                        <div class="sidebar-stat-label">総レビュー数</div>
                    </div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-grid">
                    <button class="filter-btn active" data-category="all">
                        <i class="fas fa-th-large"></i> すべて
                    </button>
                    <button class="filter-btn" data-category="和食">
                        <i class="fas fa-bowl-rice"></i> 和食
                    </button>
                    <button class="filter-btn" data-category="洋食">
                        <i class="fas fa-utensils"></i> 洋食
                    </button>
                    <button class="filter-btn" data-category="カフェ">
                        <i class="fas fa-coffee"></i> カフェ
                    </button>
                    <button class="filter-btn" data-category="パン屋">
                        <i class="fas fa-bread-slice"></i> パン屋
                    </button>
                    <button class="filter-btn" data-category="スイーツ">
                        <i class="fas fa-birthday-cake"></i> スイーツ
                    </button>
                    <button class="filter-btn" data-category="販売店">
                        <i class="fas fa-shopping-bag"></i> 販売店
                    </button>
                </div>
                
                <!-- 表示モード切り替え（ログイン時のみ表示） -->
                <div id="displayModeSection" style="
                    margin-top: 8px; 
                    padding: 8px 6px; 
                    border-top: 1px solid #eee;
                    display: none;
                ">
                    <div style="font-size: 12px; color: #666; margin-bottom: 6px;">
                        <i class="fas fa-eye"></i> 表示モード
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                        <button class="display-mode-btn active" data-mode="normal" onclick="changeDisplayMode('normal')" style="
                            padding: 6px 8px;
                            border: 1px solid #ddd;
                            border-radius: 12px;
                            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-lavender) 100%);
                            color: white;
                            font-size: 11px;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                        ">
                            <i class="fas fa-home"></i>
                            <span>通常表示</span>
                        </button>
                        <button class="display-mode-btn" data-mode="all" onclick="changeDisplayMode('all')" style="
                            padding: 6px 8px;
                            border: 1px solid #ddd;
                            border-radius: 12px;
                            background: white;
                            color: #333;
                            font-size: 11px;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                        ">
                            <i class="fas fa-globe"></i>
                            <span>全表示</span>
                        </button>
                        <button class="display-mode-btn" data-mode="want_to_go" onclick="changeDisplayMode('want_to_go')" style="
                            padding: 6px 8px;
                            border: 1px solid #667eea;
                            border-radius: 12px;
                            background: white;
                            color: #667eea;
                            font-size: 11px;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                        ">
                            <i class="fas fa-bookmark"></i>
                            <span>行きたい</span>
                        </button>
                        <button class="display-mode-btn" data-mode="visited" onclick="changeDisplayMode('visited')" style="
                            padding: 6px 8px;
                            border: 1px solid #48bb78;
                            border-radius: 12px;
                            background: white;
                            color: #48bb78;
                            font-size: 11px;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                        ">
                            <i class="fas fa-check-circle"></i>
                            <span>行った</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="store-list" id="storeList">
                <!-- Stores will be populated here -->
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            <button class="location-btn" id="locationBtn" onclick="getCurrentLocation()" title="現在地を表示">
                <i class="fas fa-location-arrow"></i>
            </button>
            <button class="pin-mode-btn" id="pinModeBtn" onclick="togglePinMode()" title="ピンを立てる">
                <i class="fas fa-map-marker-alt"></i>
            </button>
        </div>
    </div>

    <!-- Store Detail Modal -->
    <div id="storeDetailModal" class="modal">
        <div class="modal-content store-detail-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="storeDetailTitle">店舗詳細</h3>
                <button class="close-btn" onclick="closeStoreDetailModal()">&times;</button>
            </div>
            <div id="storeDetailBody">
                <!-- Store details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Image Lightbox Modal -->
    <div id="lightboxModal" class="lightbox-modal">
        <div class="lightbox-content">
            <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
            <img id="lightboxImage" class="lightbox-image" src="" alt="">
            <div class="lightbox-navigation">
                <button class="lightbox-prev" onclick="prevImage()">‹</button>
                <button class="lightbox-next" onclick="nextImage()">›</button>
            </div>
            <div class="lightbox-counter" id="lightboxCounter">1 / 3</div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="reviewModalTitle">レビューを投稿</h3>
                <button class="close-btn" onclick="closeReviewModal()">&times;</button>
            </div>
            <div id="reviewModalBody">
                <!-- Review form will be populated here -->
            </div>
        </div>
    </div>

    <!-- robots.txt content (for reference) -->
    <!-- 
    User-agent: *
    Disallow: /
    -->

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster plugin for performance -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <script>
        // 認証チェックを最初に実行
        (async function() {
            console.log('🛡️ 認証チェック開始...');
            
            const SUPABASE_URL = 'https://lywfaolwvkewuouvkzlk.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5d2Zhb2x3dmtld3VvdXZremxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDg2NjcsImV4cCI6MjA2OTk4NDY2N30.wBGCHOLbP6ew7Bnvxrq0sKSm1EnHk5NNE1sWWH7ff60';
            
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            window.supabase = supabaseClient;
            
            // セッション確認
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            
            if (error) {
                console.error('❌ セッション確認エラー:', error);
                redirectToLogin();
                return;
            }
            
            if (!session || !session.user) {
                console.log('❌ セッションなし - ログインが必要');
                redirectToLogin();
                return;
            }
            
            // ユーザーが許可されているかチェック
            const { data: allowedUser, error: checkError } = await supabaseClient
                .from('allowed_users')
                .select('email')
                .eq('email', session.user.email)
                .single();
            
            if (checkError && checkError.code !== 'PGRST116') {
                console.error('❌ 許可チェックエラー:', checkError);
                redirectToLogin();
                return;
            }
            
            if (!allowedUser) {
                console.log('❌ 未許可ユーザー - アクセス拒否');
                await supabaseClient.auth.signOut();
                alert(`アクセスが許可されていないアカウントです。\n${session.user.email}\n\nアクセス申請についてはbettger3000@yahoo.co.jpまでお問い合わせください。`);
                redirectToLogin();
                return;
            }
            
            console.log('✅ 認証OK - アプリを開始');
            window.currentUser = session.user;
            
            // ユーザー情報を表示
            updateUserDisplay(session.user);
            
            // アプリケーション初期化
            initApp();
            
            function redirectToLogin() {
                window.location.href = 'https://bettger3000.github.io/nagoya-glutenfree-map/login.html';
            }
            
            function updateUserDisplay(user) {
                // ログインセクションを非表示
                document.getElementById('loginSection').style.display = 'none';
                
                // ユーザーセクションを表示
                document.getElementById('userSection').style.display = 'flex';
                
                // ユーザー名の最初の文字をアバターに表示
                const avatar = document.getElementById('userAvatar');
                if (avatar && user.email) {
                    avatar.textContent = user.email.charAt(0).toUpperCase();
                }
                
                console.log('✅ ユーザー表示を更新しました:', user.email);
            }
        })();

        // Global variables
        let map;
        let markers = [];
        let stores = [];
        let currentUser = null;
        let reviews = [];
        let userStoreLists = []; // ユーザーのお店リスト
        let pinModeActive = false;
        let userPin = null;

        // Category icons and colors
        const categoryConfig = {
            '和食': { icon: 'fas fa-grip-lines-vertical', color: '#FFB6C1' },
            '洋食': { icon: 'fas fa-utensils', color: '#27AE60' },
            'カフェ': { icon: 'fas fa-coffee', color: '#8B4513' },
            'パン屋': { icon: 'fas fa-bread-slice', color: '#8E44AD' },
            'スイーツ': { icon: 'fas fa-ice-cream', color: '#FFE4E1' },
            '販売店': { icon: 'fas fa-shopping-bag', color: '#98D8C8' },
            'その他': { icon: 'fas fa-store', color: '#B0E0E6' }
        };

        // 全国主要ランドマーク・POIデータベース
        const landmarkDatabase = {
            // 北海道
            "札幌駅": { lat: 43.0642, lng: 141.3469, region: "北海道" },
            "札幌時計台": { lat: 43.0639, lng: 141.3537, region: "北海道" },
            "すすきの": { lat: 43.0548, lng: 141.3535, region: "北海道" },
            "新千歳空港": { lat: 42.7747, lng: 141.6920, region: "北海道" },
            
            // 東北
            "仙台駅": { lat: 38.2608, lng: 140.8814, region: "宮城県" },
            "青森駅": { lat: 40.8278, lng: 140.7407, region: "青森県" },
            
            // 関東
            "東京駅": { lat: 35.6812, lng: 139.7671, region: "東京都" },
            "新宿駅": { lat: 35.6896, lng: 139.7006, region: "東京都" },
            "渋谷駅": { lat: 35.6580, lng: 139.7016, region: "東京都" },
            "池袋駅": { lat: 35.7295, lng: 139.7107, region: "東京都" },
            "上野駅": { lat: 35.7140, lng: 139.7774, region: "東京都" },
            "浅草": { lat: 35.7148, lng: 139.7967, region: "東京都" },
            "銀座": { lat: 35.6717, lng: 139.7650, region: "東京都" },
            "原宿": { lat: 35.6702, lng: 139.7026, region: "東京都" },
            "お台場": { lat: 35.6266, lng: 139.7736, region: "東京都" },
            "東京スカイツリー": { lat: 35.7101, lng: 139.8107, region: "東京都" },
            "東京タワー": { lat: 35.6586, lng: 139.7454, region: "東京都" },
            "新宿都庁": { lat: 35.6893, lng: 139.6918, region: "東京都" },
            "羽田空港": { lat: 35.5494, lng: 139.7798, region: "東京都" },
            "成田空港": { lat: 35.7720, lng: 140.3929, region: "千葉県" },
            "横浜駅": { lat: 35.4658, lng: 139.6225, region: "神奈川県" },
            "みなとみらい": { lat: 35.4563, lng: 139.6364, region: "神奈川県" },
            "鎌倉": { lat: 35.3192, lng: 139.5466, region: "神奈川県" },
            "大宮駅": { lat: 35.9063, lng: 139.6239, region: "埼玉県" },
            "千葉駅": { lat: 35.6058, lng: 140.1061, region: "千葉県" },
            
            // 中部
            "名古屋駅": { lat: 35.1815, lng: 136.9066, region: "愛知県" },
            "名古屋城": { lat: 35.1856, lng: 136.8997, region: "愛知県" },
            "栄": { lat: 35.1677, lng: 136.9089, region: "愛知県" },
            "大須": { lat: 35.1588, lng: 136.9008, region: "愛知県" },
            "金山駅": { lat: 35.1432, lng: 136.8989, region: "愛知県" },
            "中部国際空港": { lat: 34.8584, lng: 136.8047, region: "愛知県" },
            "静岡駅": { lat: 34.9756, lng: 138.3829, region: "静岡県" },
            "浜松駅": { lat: 34.7040, lng: 137.7346, region: "静岡県" },
            "金沢駅": { lat: 36.5782, lng: 136.6477, region: "石川県" },
            "富山駅": { lat: 36.7015, lng: 137.2136, region: "富山県" },
            "長野駅": { lat: 36.6434, lng: 138.1884, region: "長野県" },
            
            // 関西
            "大阪駅": { lat: 34.7024, lng: 135.4959, region: "大阪府" },
            "梅田": { lat: 34.7053, lng: 135.4979, region: "大阪府" },
            "難波": { lat: 34.6668, lng: 135.5000, region: "大阪府" },
            "天王寺": { lat: 34.6456, lng: 135.5066, region: "大阪府" },
            "大阪城": { lat: 34.6873, lng: 135.5262, region: "大阪府" },
            "通天閣": { lat: 34.6523, lng: 135.5063, region: "大阪府" },
            "USJ": { lat: 34.6658, lng: 135.4321, region: "大阪府" },
            "関西国際空港": { lat: 34.4347, lng: 135.2441, region: "大阪府" },
            "京都駅": { lat: 34.9859, lng: 135.7581, region: "京都府" },
            "清水寺": { lat: 34.9949, lng: 135.7849, region: "京都府" },
            "金閣寺": { lat: 35.0394, lng: 135.7292, region: "京都府" },
            "嵐山": { lat: 35.0096, lng: 135.6689, region: "京都府" },
            "祇園": { lat: 35.0036, lng: 135.7756, region: "京都府" },
            "神戸駅": { lat: 34.6765, lng: 135.1885, region: "兵庫県" },
            "三宮": { lat: 34.6939, lng: 135.1955, region: "兵庫県" },
            "奈良駅": { lat: 34.6851, lng: 135.8048, region: "奈良県" },
            "東大寺": { lat: 34.6890, lng: 135.8396, region: "奈良県" },
            
            // 中国
            "広島駅": { lat: 34.3975, lng: 132.4756, region: "広島県" },
            "広島平和記念公園": { lat: 34.3955, lng: 132.4536, region: "広島県" },
            "岡山駅": { lat: 34.6661, lng: 133.9184, region: "岡山県" },
            
            // 四国
            "高松駅": { lat: 34.3513, lng: 134.0436, region: "香川県" },
            "松山駅": { lat: 33.8389, lng: 132.7661, region: "愛媛県" },
            
            // 九州
            "博多駅": { lat: 33.5904, lng: 130.4017, region: "福岡県" },
            "天神": { lat: 33.5906, lng: 130.4015, region: "福岡県" },
            "福岡空港": { lat: 33.5859, lng: 130.4510, region: "福岡県" },
            "長崎駅": { lat: 32.7503, lng: 129.8779, region: "長崎県" },
            "熊本駅": { lat: 32.8031, lng: 130.6889, region: "熊本県" },
            "鹿児島中央駅": { lat: 31.5815, lng: 130.5421, region: "鹿児島県" },
            "那覇空港": { lat: 26.1958, lng: 127.6458, region: "沖縄県" },
            "国際通り": { lat: 26.2124, lng: 127.6792, region: "沖縄県" }
        };

        // Initialize application
        async function initApp() {
            console.log('🚀 nacoコミュニティマップ初期化開始');
            
            try {
                // Supabase is already initialized in auth check
                supabase = window.supabase;
                console.log('✅ Supabase初期化確認');

                // Check authentication
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    updateUserUI(true);
                    console.log('✅ ユーザー認証済み:', currentUser.email);
                } else {
                    updateUserUI(false);
                    console.log('ℹ️ 未認証ユーザー');
                }

                // Initialize map with slight delay to ensure DOM is ready
                setTimeout(() => {
                    initMap();
                }, 100);

                // Wait a bit more before loading data
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Load data with error handling
                await Promise.allSettled([
                    loadStores(),
                    loadReviews(),
                    loadUserStoreLists()
                ]);
                
                updateStats();

                // Setup event listeners
                setupEventListeners();
                
                // ログイン後に自動的に現在地を取得して距離順にソート
                if (currentUser) {
                    console.log('🔍 ログインユーザーの現在地を自動取得します...');
                    setTimeout(async () => {
                        await autoDetectLocation();
                    }, 500);
                }

                // Hide loading overlay
                document.getElementById('loadingOverlay').classList.add('hidden');

                console.log('✅ nacoコミュニティマップ初期化完了');
            } catch (error) {
                console.error('❌ 初期化エラー:', error);
                showNotification('アプリケーションの初期化に失敗しました', 'error');
            }
        }

        // Initialize map (Nagoya center)
        function initMap() {
            console.log('🗺️ マップ初期化開始...');
            
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('❌ map要素が見つかりません');
                return;
            }
            
            console.log('📍 map要素確認完了:', mapElement);
            
            try {
                // Center on Nagoya Station as default
                map = L.map('map').setView([35.1815, 136.9066], 12);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);

                // Add click event for pin mode
                map.on('click', function(e) {
                    if (pinModeActive) {
                        const { lat, lng } = e.latlng;
                        
                        // Create user pin
                        createUserPin(lat, lng);
                        
                        // Show stores near pin
                        showStoresNearUserPin(lat, lng);
                        
                        // Exit pin mode
                        pinModeActive = false;
                        document.getElementById('pinModeBtn').classList.remove('active');
                        map.getContainer().style.cursor = '';
                        
                        showNotification('📌 ピンを立てました！この地点から近い順に店舗を表示しています', 'success');
                    }
                });

                console.log('✅ 名古屋駅中心でマップ初期化完了');
            } catch (error) {
                console.error('❌ マップ初期化エラー:', error);
            }
        }

        // Load stores from Supabase
        async function loadStores() {
            try {
                console.log('📍 店舗データ取得中...');
                
                // パフォーマンス最適化: キャッシュチェック
                if (window.performanceManager) {
                    const cachedStores = performanceManager.getCachedApiResponse('stores');
                    if (cachedStores) {
                        console.log('✅ キャッシュから店舗データを取得');
                        stores = cachedStores;
                        updateStoreList(stores);
                        if (map) {
                            requestAnimationFrame(() => updateMapMarkers(stores));
                        }
                        return;
                    }
                }
                
                // キャッシュを避けるためのタイムスタンプ
                const timestamp = new Date().getTime();
                console.log(`🔄 データベース読み込み強制リフレッシュ: ${timestamp}`);
                
                const { data, error } = await supabase
                    .from('stores')
                    .select('*')
                    .order('name');

                if (error) throw error;

                // Store coordinates - simple approach like original app
                stores = (data || []).map(store => {
                    return {
                        ...store,
                        // Convert database fields to original format for compatibility
                        lat: store.latitude,
                        lng: store.longitude
                    };
                });
                console.log(`✅ ${stores.length}件の有効な店舗データ取得完了`);

                // キャッシュに保存
                if (window.performanceManager) {
                    performanceManager.cacheApiResponse('stores', stores);
                }

                // Update UI
                updateStoreList(stores);
                
                // Wait for map to be initialized before adding markers
                if (map) {
                    requestAnimationFrame(() => {
                        updateMapMarkers(stores);
                        // Auto-fit map to show all stores nationwide
                        fitMapToAllStores(stores);
                    });
                } else {
                    console.warn('⚠️ マップ未初期化のため、マーカー作成を待機中...');
                    // Retry after a short delay
                    setTimeout(() => {
                        if (map) {
                            console.log('🔄 マップ初期化完了後にマーカー作成');
                            updateMapMarkers(stores);
                            fitMapToAllStores(stores);
                        } else {
                            console.error('❌ マップ初期化がタイムアウトしました');
                        }
                    }, 500);
                }

            } catch (error) {
                console.error('❌ 店舗データ取得エラー:', error);
                showNotification('店舗データの取得に失敗しました', 'error');
                stores = []; // エラー時は空配列に
            }
        }

        // Load reviews from Supabase
        async function loadReviews() {
            try {
                const { data, error } = await supabase
                    .from('store_reviews')
                    .select('*');

                if (error) throw error;

                reviews = data || [];
                console.log(`✅ ${reviews.length}件のレビューデータ取得完了`);

            } catch (error) {
                console.error('❌ レビューデータ取得エラー:', error);
                reviews = [];
            }
        }

        // Load user store lists from Supabase
        async function loadUserStoreLists() {
            try {
                // ログインしていない場合は空配列
                if (!currentUser) {
                    userStoreLists = [];
                    return;
                }

                console.log('📋 ユーザーのお店リスト取得中...');

                const { data, error } = await supabase
                    .from('user_store_lists')
                    .select('*')
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                userStoreLists = data || [];
                console.log(`✅ ${userStoreLists.length}件のお店リストデータ取得完了`);

            } catch (error) {
                console.error('❌ お店リストデータ取得エラー:', error);
                userStoreLists = [];
            }
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalStores').textContent = stores.length;
            document.getElementById('visibleStores').textContent = stores.length;
            document.getElementById('reviewCount').textContent = reviews.length;
        }

        // Update store list in sidebar
        function updateStoreList(storesToShow) {
            const storeList = document.getElementById('storeList');
            
            if (storesToShow.length === 0) {
                storeList.innerHTML = '<div class="no-stores"><i class="fas fa-search"></i><br>該当する店舗がありません</div>';
                return;
            }

            // 現在地が取得されている場合は距離順でソート
            let processedStores = storesToShow;
            if (window.locationService && locationService.getCurrentLocation()) {
                processedStores = locationService.addDistanceToStores(storesToShow);
                processedStores = locationService.sortByDistance(processedStores);
            }

            // パフォーマンス最適化: requestAnimationFrameで描画を最適化
            requestAnimationFrame(() => {
                const htmlContent = processedStores.map(store => {
                    const config = categoryConfig[store.category] || categoryConfig['その他'];
                    
                    // 距離情報の表示
                    const distanceHtml = store.distanceText ? 
                        `<div class="store-distance">
                            <i class="fas fa-route"></i>
                            ${store.distanceText}
                        </div>` : '';

                    return `
                    <div class="store-item" onclick="selectStore(${store.id})">
                        <!-- Header with store name and distance -->
                        <div class="store-header">
                            <div class="store-name">
                                <i class="${config.icon}" style="color: ${config.color};"></i>
                                <span class="name-text">${currentSearchQuery ? highlightSearchTerm(store.name, currentSearchQuery) : escapeHtml(store.name)}</span>
                            </div>
                            ${distanceHtml}
                        </div>
                        
                        <!-- Category with better contrast -->
                        <div class="store-category-wrapper">
                            <span class="store-category-new" style="background: ${config.color};">
                                ${escapeHtml(store.category)}
                            </span>
                        </div>
                        
                        <!-- Address -->
                        <div class="store-address">
                            <i class="fas fa-map-marker-alt"></i>
                            ${currentSearchQuery ? highlightSearchTerm(store.address, currentSearchQuery) : escapeHtml(store.address)}
                        </div>
                        
                        ${currentSearchQuery ? `
                            <div style="
                                background: #e8f4f8;
                                color: #2c5282;
                                padding: 6px 10px;
                                border-radius: 12px;
                                font-size: 11px;
                                margin-bottom: 8px;
                                border-left: 3px solid #4299e1;
                            ">
                                <i class="fas fa-search"></i> マッチ: ${getMatchReason(store, currentSearchQuery)}
                            </div>
                        ` : ''}
                        
                        <!-- Balanced action buttons -->
                        <div class="store-actions-new">
                            <button class="action-btn-new action-btn-primary" onclick="event.stopPropagation(); showStoreDetail(${store.id})">
                                <i class="fas fa-info-circle"></i>
                                <span>詳細</span>
                            </button>
                            <button class="action-btn-new action-btn-secondary" onclick="event.stopPropagation(); showOnMap(${store.id})">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>地図</span>
                            </button>
                            <button class="action-btn-new action-btn-accent" onclick="event.stopPropagation(); openReviewModal(${store.id}, '${escapeHtml(store.name)}')">
                                <i class="fas fa-heart"></i>
                                <span>レビュー</span>
                            </button>
                        </div>
                        
                        <!-- User list buttons (only shown when logged in) -->
                        ${currentUser ? `
                            <div class="user-list-actions" style="
                                display: flex;
                                gap: 8px;
                                margin-top: 10px;
                                padding-top: 10px;
                                border-top: 1px solid #eee;
                            ">
                                ${getWantToGoButton(store.id)}
                                ${getVisitedButton(store.id)}
                            </div>
                        ` : ''}
                    </div>
                `;
                }).join('');
                
                // パフォーマンス最適化: 一括でDOMを更新
                storeList.innerHTML = htmlContent;
                document.getElementById('visibleStores').textContent = storesToShow.length;
            });
        }

        // Update map markers
        // カテゴリ別マーカー設定（洗練されたデザイン）
        function getCategoryMarkerStyle(category) {
            const styles = {
                '和食': {
                    icon: 'fas fa-bowl-rice',  // お米/丼
                    color: '#E67E22',  // 温かみのあるオレンジ
                    shadowColor: 'rgba(230, 126, 34, 0.5)',
                    size: '14px'
                },
                '洋食': {
                    icon: 'fas fa-utensils',  // ナイフフォーク
                    color: '#27AE60',  // グリーン系
                    shadowColor: 'rgba(39, 174, 96, 0.5)',
                    size: '14px'
                },
                'カフェ': {
                    icon: 'fas fa-coffee',
                    color: '#8B4513',  // 茶色系
                    shadowColor: 'rgba(139, 69, 19, 0.5)',
                    size: '14px'
                },
                'スイーツ': {
                    icon: 'fas fa-birthday-cake',
                    color: '#E91E63',  // 鮮やかなピンク
                    shadowColor: 'rgba(233, 30, 99, 0.5)',
                    size: '14px'
                },
                'パン屋': {
                    icon: 'fas fa-bread-slice',  // パンアイコン
                    color: '#8E44AD',  // パープル系
                    shadowColor: 'rgba(142, 68, 173, 0.5)',
                    size: '14px'
                },
                '販売店': {
                    icon: 'fas fa-shopping-bag',
                    color: '#FFD700',  // イエロー
                    shadowColor: 'rgba(255, 215, 0, 0.5)',
                    size: '14px'
                }
            };
            
            return styles[category] || {
                icon: 'fas fa-map-marker-alt',
                color: '#9370DB',  // ミディアムパープル
                shadowColor: 'rgba(147, 112, 219, 0.4)',
                size: '14px'
            };
        }

        // 洗練されたカスタムマーカーアイコンを作成（表示モード対応）
        function createCustomIcon(category, store = null) {
            const style = getCategoryMarkerStyle(category);
            let markerColor = style.color;
            let borderColor = 'rgba(255,255,255,0.3)';
            let shadowColor = style.shadowColor;
            let badgeHtml = '';
            
            // 表示モードと店舗のリスト状態に応じてマーカーを装飾
            if (store && currentDisplayMode === 'all') {
                const isWantToGo = isInUserList(store.id, 'want_to_go');
                const isVisited = isInUserList(store.id, 'visited');
                
                if (isVisited) {
                    // 行った店舗: 緑の枠線
                    borderColor = '#48bb78';
                    shadowColor = 'rgba(72, 187, 120, 0.5)';
                    badgeHtml = `
                        <div style="
                            position: absolute;
                            top: -6px;
                            right: -6px;
                            background: #48bb78;
                            color: white;
                            border-radius: 50%;
                            width: 16px;
                            height: 16px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 10px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        ">
                            <i class="fas fa-check"></i>
                        </div>
                    `;
                } else if (isWantToGo) {
                    // 行きたい店舗: 紫の枠線
                    borderColor = '#667eea';
                    shadowColor = 'rgba(102, 126, 234, 0.5)';
                    badgeHtml = `
                        <div style="
                            position: absolute;
                            top: -6px;
                            right: -6px;
                            background: #667eea;
                            color: white;
                            border-radius: 50%;
                            width: 16px;
                            height: 16px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 10px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        ">
                            <i class="fas fa-bookmark"></i>
                        </div>
                    `;
                }
            } else if (store && (currentDisplayMode === 'want_to_go' || currentDisplayMode === 'visited')) {
                // 専用モード時のマーカー色変更
                if (currentDisplayMode === 'want_to_go') {
                    markerColor = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    shadowColor = 'rgba(102, 126, 234, 0.5)';
                    borderColor = '#667eea';
                } else if (currentDisplayMode === 'visited') {
                    markerColor = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                    shadowColor = 'rgba(72, 187, 120, 0.5)';
                    borderColor = '#48bb78';
                }
            }
            
            const iconHtml = `
                <div class="sophisticated-marker">
                    <div class="marker-teardrop" style="
                        width: 28px;
                        height: 38px;
                        background: ${markerColor};
                        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
                        position: relative;
                        box-shadow: 
                            0 4px 12px ${shadowColor},
                            0 2px 4px rgba(0,0,0,0.1);
                        border: 2px solid ${borderColor};
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        transform-origin: center bottom;
                    ">
                        <div class="marker-point" style="
                            position: absolute;
                            bottom: -1px;
                            left: 50%;
                            transform: translateX(-50%) rotate(45deg);
                            width: 8px;
                            height: 8px;
                            background: ${typeof markerColor === 'string' && markerColor.includes('gradient') ? style.color : markerColor};
                            border-radius: 0 0 0 50%;
                        "></div>
                        <i class="${style.icon}" style="
                            color: white;
                            font-size: 14px;
                            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
                            z-index: 10;
                            margin-top: -2px;
                        "></i>
                    </div>
                    ${badgeHtml}
                </div>
            `;
            
            return L.divIcon({
                html: iconHtml,
                className: 'sophisticated-marker-wrapper',
                iconSize: [28, 44],
                iconAnchor: [14, 44],
                popupAnchor: [0, -44]
            });
        }

        // マーカークラスターグループ（パフォーマンス最適化）
        let markerClusterGroup = null;
        
        function updateMapMarkers(storesToShow) {
            console.log(`🗺️ マーカー更新開始: ${storesToShow.length}件の店舗`);
            
            if (!map) {
                console.error('❌ マップが初期化されていません');
                return;
            }
            
            // パフォーマンス最適化: クラスターグループで既存マーカーを一括削除
            if (markerClusterGroup) {
                map.removeLayer(markerClusterGroup);
                markerClusterGroup = null;
            }
            markers = [];

            // Add new markers with custom icons
            let successCount = 0;
            let failCount = 0;
            const newMarkers = [];
            
            // パフォーマンス測定開始
            if (window.performanceManager) {
                performanceManager.startMeasure('marker-creation');
            }
            
            storesToShow.forEach(store => {
                try {
                    // Original app style: simple check for lat/lng existence
                    if (store.lat && store.lng) {
                        console.log(`📍 マーカー作成: ${store.name} at [${store.lat}, ${store.lng}]`);
                        
                        const customIcon = createCustomIcon(store.category, store);
                        const style = getCategoryMarkerStyle(store.category);
                        
                        const marker = L.marker([store.lat, store.lng], { icon: customIcon })
                            .bindPopup(`
                                <div class="custom-popup" style="
                                    min-width: 220px;
                                    background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
                                    border-radius: 16px;
                                    padding: 0;
                                    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
                                    border: 1px solid rgba(0,0,0,0.06);
                                    overflow: hidden;
                                ">
                                    <!-- Header with store name -->
                                    <div style="
                                        background: linear-gradient(135deg, ${style.color} 0%, ${style.borderColor || style.color} 100%);
                                        padding: 16px 18px 14px;
                                        margin: 0;
                                    ">
                                        <h3 style="
                                            margin: 0;
                                            color: white;
                                            font-size: 18px;
                                            font-weight: 700;
                                            line-height: 1.2;
                                            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
                                            letter-spacing: 0.3px;
                                        ">${escapeHtml(store.name)}</h3>
                                        <div style="
                                            margin: 8px 0 0 0;
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                        ">
                                            <span style="
                                                background: rgba(255,255,255,0.25);
                                                color: white;
                                                padding: 4px 12px;
                                                border-radius: 20px;
                                                font-size: 12px;
                                                font-weight: 500;
                                                border: 1px solid rgba(255,255,255,0.3);
                                            ">${escapeHtml(store.category)}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Content area -->
                                    <div style="padding: 16px 18px;">
                                        <div style="
                                            margin: 0 0 16px 0;
                                            color: #666;
                                            font-size: 13px;
                                            line-height: 1.4;
                                            display: flex;
                                            align-items: flex-start;
                                            gap: 6px;
                                        ">
                                            <span style="color: #999; margin-top: 1px;">📍</span>
                                            <span>${escapeHtml(store.address)}</span>
                                        </div>
                                        
                                        <!-- Subtle detail button -->
                                        <button onclick="showStoreDetail(${store.id})" style="
                                            width: 100%;
                                            background: rgba(74, 144, 226, 0.08);
                                            color: #4A90E2;
                                            border: 1px solid rgba(74, 144, 226, 0.2);
                                            padding: 12px 16px;
                                            border-radius: 12px;
                                            font-size: 13px;
                                            font-weight: 500;
                                            cursor: pointer;
                                            transition: all 0.2s ease;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            gap: 6px;
                                        " onmouseover="
                                            this.style.background='rgba(74, 144, 226, 0.12)';
                                            this.style.borderColor='rgba(74, 144, 226, 0.3)';
                                            this.style.transform='translateY(-1px)';
                                        " onmouseout="
                                            this.style.background='rgba(74, 144, 226, 0.08)';
                                            this.style.borderColor='rgba(74, 144, 226, 0.2)';
                                            this.style.transform='translateY(0)';
                                        ">
                                            <span style="font-size: 12px;">ℹ️</span>
                                            詳細を見る
                                        </button>
                                    </div>
                                </div>
                            `)
                            ;
                        
                        newMarkers.push(marker);
                        markers.push(marker);
                        successCount++;
                    } else {
                        console.warn(`⚠️ スキップ: ${store.name} - 座標なし`);
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                    console.error(`❌ マーカー作成エラー (${store.name}):`, error);
                }
            });
            
            // パフォーマンス最適化: マーカークラスタリングを使用
            if (newMarkers.length > 0) {
                // クラスターグループの設定
                markerClusterGroup = L.markerClusterGroup({
                    maxClusterRadius: 50,           // クラスター半径
                    spiderfyOnMaxZoom: true,        // 最大ズーム時に展開
                    showCoverageOnHover: false,     // ホバー時の範囲表示を無効化
                    zoomToBoundsOnClick: true,      // クリック時にズーム
                    disableClusteringAtZoom: 16,    // ズームレベル16以上ではクラスタリング無効
                    animate: true,                   // アニメーション有効
                    animateAddingMarkers: false,     // マーカー追加時のアニメーションは無効（パフォーマンス）
                    chunkedLoading: true,            // チャンク単位での読み込み
                    chunkInterval: 200,              // チャンク間隔
                    chunkDelay: 50                   // チャンク遅延
                });
                
                // マーカーをクラスターグループに追加
                markerClusterGroup.addLayers(newMarkers);
                map.addLayer(markerClusterGroup);
            }
            
            // パフォーマンス測定終了
            if (window.performanceManager) {
                performanceManager.endMeasure('marker-creation');
            }
            
            console.log(`📊 マーカー作成結果: 成功 ${successCount}件, 失敗 ${failCount}件`);
        }

        // Fit map to show all stores nationwide
        function fitMapToAllStores(stores) {
            try {
                const storesWithCoords = stores.filter(store => store.lat && store.lng);
                if (storesWithCoords.length > 0) {
                    console.log(`🗾 全国対応: ${storesWithCoords.length}件の店舗に地図を調整中...`);
                    
                    const bounds = L.latLngBounds(
                        storesWithCoords.map(store => [store.lat, store.lng])
                    );
                    
                    map.fitBounds(bounds, { 
                        padding: [20, 20], 
                        maxZoom: 12 // Prevent zooming in too much for nationwide view
                    });
                    
                    console.log('✅ 全国の店舗が表示されるよう地図を調整完了');
                } else {
                    console.warn('⚠️ 座標のある店舗が見つかりません');
                }
            } catch (error) {
                console.error('❌ 地図調整エラー:', error);
            }
        }

        // Select store (highlight and center on map)
        function selectStore(storeId) {
            try {
                const store = stores.find(s => s.id === storeId);
                if (!store) {
                    console.warn('店舗が見つかりません:', storeId);
                    return;
                }
                
                // Original app style: use lat/lng if they exist
                if (store.lat && store.lng) {
                    map.setView([store.lat, store.lng], 15);
                } else {
                    console.warn(`店舗の座標がありません: ${store.name}`);
                }
                
                // Find and open popup for this store's marker
                const marker = markers.find(m => {
                    try {
                        const markerLatLng = m.getLatLng();
                        return Math.abs(markerLatLng.lat - store.latitude) < 0.00001 && 
                               Math.abs(markerLatLng.lng - store.longitude) < 0.00001;
                    } catch (e) {
                        return false;
                    }
                });
                
                if (marker) {
                    marker.openPopup();
                }
            } catch (error) {
                console.error('店舗選択エラー:', error);
            }
        }

        // Show store on map
        function showOnMap(storeId) {
            selectStore(storeId);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            const searchBox = document.getElementById('searchBox');
            searchBox.addEventListener('input', handleSearch);

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', handleFilter);
            });
            
            
            // 現在地サービスの初期化
            initLocationService();

            // Auth state change listener
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('🔐 認証状態変更:', event, session?.user?.email);
                
                if (session) {
                    currentUser = session.user;
                    updateUserUI(true);
                    // ログイン後にユーザーリストを読み込み
                    await loadUserStoreLists();
                    updateStoreList(stores); // UIを更新
                } else {
                    currentUser = null;
                    userStoreLists = []; // ログアウト時にリストをクリア
                    updateUserUI(false);
                    updateStoreList(stores); // UIを更新
                }
            });
        }

        // Handle search with enhanced search fields
        async function handleSearch(event) {
            const query = event.target.value.trim();
            
            if (query === '') {
                currentSearchQuery = ''; // 検索クエリをクリア
                updateStoreList(stores);
                updateMapMarkers(stores);
                // 検索クリア時は検索情報を非表示
                hideSearchInfo();
                return;
            }
            
            const lowerQuery = query.toLowerCase();
            
            // 拡張検索: 複数フィールドから検索
            const filtered = stores.filter(store => {
                // 各フィールドを安全にチェック
                const nameMatch = store.name && store.name.toLowerCase().includes(lowerQuery);
                const addressMatch = store.address && store.address.toLowerCase().includes(lowerQuery);
                const categoryMatch = store.category && store.category.toLowerCase().includes(lowerQuery);
                const descriptionMatch = store.description && store.description.toLowerCase().includes(lowerQuery);
                const nacoCommentMatch = store.nacoComment && store.nacoComment.toLowerCase().includes(lowerQuery);
                const hoursMatch = store.hours && store.hours.toLowerCase().includes(lowerQuery);
                const closedMatch = store.closed && store.closed.toLowerCase().includes(lowerQuery);
                
                // どれか一つでもマッチすればtrue
                return nameMatch || addressMatch || categoryMatch || descriptionMatch || 
                       nacoCommentMatch || hoursMatch || closedMatch;
            });
            
            // 検索結果の詳細を表示
            if (filtered.length > 0) {
                currentSearchQuery = query; // 検索クエリを保存
                updateStoreList(filtered);
                updateMapMarkers(filtered);
                showSearchInfo(query, filtered.length);
                return;
            }
            
            // 店舗が見つからない場合、ランドマーク検索を試行
            await searchLandmarkAndShowNearbyStores(query);
        }
        
        // 検索情報を表示
        function showSearchInfo(query, resultCount) {
            // 既存の検索情報を削除
            hideSearchInfo();
            
            // 検索情報を作成
            const searchInfo = document.createElement('div');
            searchInfo.id = 'searchInfo';
            searchInfo.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 10px 15px;
                font-size: 13px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #ddd;
            `;
            
            searchInfo.innerHTML = `
                <span>
                    <i class="fas fa-search"></i> 
                    「${escapeHtml(query)}」の検索結果: ${resultCount}件
                </span>
                <button onclick="clearSearch()" style="
                    background: rgba(255,255,255,0.2);
                    border: 1px solid rgba(255,255,255,0.3);
                    color: white;
                    padding: 4px 10px;
                    border-radius: 15px;
                    font-size: 11px;
                    cursor: pointer;
                ">
                    <i class="fas fa-times"></i> クリア
                </button>
            `;
            
            // フィルターセクションの前に挿入
            const filtersSection = document.querySelector('.filters');
            filtersSection.parentNode.insertBefore(searchInfo, filtersSection);
        }
        
        // 検索情報を非表示
        function hideSearchInfo() {
            const searchInfo = document.getElementById('searchInfo');
            if (searchInfo) {
                searchInfo.remove();
            }
        }
        
        // 検索をクリア
        function clearSearch() {
            document.getElementById('searchBox').value = '';
            currentSearchQuery = ''; // 検索クエリをクリア
            updateStoreList(stores);
            updateMapMarkers(stores);
            hideSearchInfo();
        }
        
        // 検索キーワードをハイライト表示する関数
        function highlightSearchTerm(text, searchTerm) {
            if (!text || !searchTerm) return text || '';
            
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            return text.replace(regex, '<mark style="background: #fff3cd; padding: 2px 4px; border-radius: 3px;">$1</mark>');
        }
        
        // 正規表現の特殊文字をエスケープ
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // 検索にマッチした理由を表示
        function getMatchReason(store, searchTerm) {
            const lowerQuery = searchTerm.toLowerCase();
            const reasons = [];
            
            if (store.name && store.name.toLowerCase().includes(lowerQuery)) {
                reasons.push('店名');
            }
            if (store.address && store.address.toLowerCase().includes(lowerQuery)) {
                reasons.push('住所');
            }
            if (store.category && store.category.toLowerCase().includes(lowerQuery)) {
                reasons.push('カテゴリー');
            }
            if (store.description && store.description.toLowerCase().includes(lowerQuery)) {
                reasons.push('詳細');
            }
            if (store.nacoComment && store.nacoComment.toLowerCase().includes(lowerQuery)) {
                reasons.push('コメント');
            }
            if (store.hours && store.hours.toLowerCase().includes(lowerQuery)) {
                reasons.push('営業時間');
            }
            if (store.closed && store.closed.toLowerCase().includes(lowerQuery)) {
                reasons.push('定休日');
            }
            
            return reasons.join('・');
        }
        
        // お店リスト関連のヘルパー関数
        function isInUserList(storeId, listType) {
            return userStoreLists.some(item => 
                item.store_id === storeId && item.list_type === listType
            );
        }
        
        function getWantToGoButton(storeId) {
            const isAdded = isInUserList(storeId, 'want_to_go');
            const buttonClass = isAdded ? 'user-list-btn active' : 'user-list-btn';
            const icon = isAdded ? 'fas fa-bookmark' : 'far fa-bookmark';
            const text = isAdded ? '行きたい済' : '行きたい';
            
            return `
                <button class="${buttonClass}" onclick="event.stopPropagation(); toggleUserList(${storeId}, 'want_to_go')" style="
                    background: ${isAdded ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white'};
                    color: ${isAdded ? 'white' : '#667eea'};
                    border: 2px solid #667eea;
                    padding: 6px 12px;
                    border-radius: 15px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                    flex: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 4px;
                ">
                    <i class="${icon}"></i>
                    <span>${text}</span>
                </button>
            `;
        }
        
        function getVisitedButton(storeId) {
            const isAdded = isInUserList(storeId, 'visited');
            const buttonClass = isAdded ? 'user-list-btn active' : 'user-list-btn';
            const icon = isAdded ? 'fas fa-check-circle' : 'far fa-circle';
            const text = isAdded ? '行った済' : '行った';
            
            return `
                <button class="${buttonClass}" onclick="event.stopPropagation(); toggleUserList(${storeId}, 'visited')" style="
                    background: ${isAdded ? 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)' : 'white'};
                    color: ${isAdded ? 'white' : '#48bb78'};
                    border: 2px solid #48bb78;
                    padding: 6px 12px;
                    border-radius: 15px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                    flex: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 4px;
                ">
                    <i class="${icon}"></i>
                    <span>${text}</span>
                </button>
            `;
        }
        
        // ユーザーリストの登録・削除処理
        async function toggleUserList(storeId, listType) {
            if (!currentUser) {
                showNotification('リストに追加するにはログインが必要です', 'error');
                return;
            }
            
            try {
                const isCurrentlyInList = isInUserList(storeId, listType);
                
                if (isCurrentlyInList) {
                    // 削除処理
                    const { error } = await supabase
                        .from('user_store_lists')
                        .delete()
                        .eq('user_id', currentUser.id)
                        .eq('store_id', storeId)
                        .eq('list_type', listType);
                        
                    if (error) throw error;
                    
                    // ローカルデータから削除
                    userStoreLists = userStoreLists.filter(item => 
                        !(item.user_id === currentUser.id && 
                          item.store_id === storeId && 
                          item.list_type === listType)
                    );
                    
                    const actionText = listType === 'want_to_go' ? '行きたい' : '行った';
                    showNotification(`${actionText}リストから削除しました`, 'success');
                    
                } else {
                    // 追加処理
                    const newItem = {
                        user_id: currentUser.id,
                        store_id: storeId,
                        list_type: listType,
                        created_at: new Date().toISOString()
                    };
                    
                    const { data, error } = await supabase
                        .from('user_store_lists')
                        .insert([newItem])
                        .select();
                        
                    if (error) throw error;
                    
                    // ローカルデータに追加
                    if (data && data.length > 0) {
                        userStoreLists.push(data[0]);
                    }
                    
                    const actionText = listType === 'want_to_go' ? '行きたい' : '行った';
                    showNotification(`${actionText}リストに追加しました`, 'success');
                }
                
                // UIを更新（店舗リストを再描画）
                const currentStores = document.getElementById('storeList').children.length > 0 ? 
                    getCurrentDisplayedStores() : stores;
                updateStoreList(currentStores);
                
            } catch (error) {
                console.error('❌ ユーザーリスト更新エラー:', error);
                showNotification('リストの更新に失敗しました', 'error');
            }
        }
        
        // 現在表示されている店舗を取得（フィルター状態を維持）
        function getCurrentDisplayedStores() {
            // フィルター状態に応じて現在の店舗リストを返す
            let currentStores = stores;
            
            // カテゴリフィルターを適用
            if (activeFilters.categories.size > 0) {
                currentStores = currentStores.filter(store => 
                    activeFilters.categories.has(store.category)
                );
            }
            
            // 検索フィルターを適用
            if (currentSearchQuery) {
                const lowerQuery = currentSearchQuery.toLowerCase();
                currentStores = currentStores.filter(store => {
                    const nameMatch = store.name && store.name.toLowerCase().includes(lowerQuery);
                    const addressMatch = store.address && store.address.toLowerCase().includes(lowerQuery);
                    const categoryMatch = store.category && store.category.toLowerCase().includes(lowerQuery);
                    const descriptionMatch = store.description && store.description.toLowerCase().includes(lowerQuery);
                    const nacoCommentMatch = store.nacoComment && store.nacoComment.toLowerCase().includes(lowerQuery);
                    const hoursMatch = store.hours && store.hours.toLowerCase().includes(lowerQuery);
                    const closedMatch = store.closed && store.closed.toLowerCase().includes(lowerQuery);
                    
                    return nameMatch || addressMatch || categoryMatch || descriptionMatch || 
                           nacoCommentMatch || hoursMatch || closedMatch;
                });
            }
            
            return currentStores;
        }
        
        // 表示モード切り替え関数
        function changeDisplayMode(mode) {
            currentDisplayMode = mode;
            
            // ボタンのアクティブ状態を更新
            document.querySelectorAll('.display-mode-btn').forEach(btn => {
                const isActive = btn.dataset.mode === mode;
                btn.classList.toggle('active', isActive);
                
                if (isActive) {
                    // アクティブボタンのスタイル
                    if (mode === 'normal') {
                        btn.style.background = 'linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-lavender) 100%)';
                        btn.style.color = 'white';
                    } else if (mode === 'all') {
                        btn.style.background = 'linear-gradient(135deg, #4a5568 0%, #2d3748 100%)';
                        btn.style.color = 'white';
                    } else if (mode === 'want_to_go') {
                        btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        btn.style.color = 'white';
                    } else if (mode === 'visited') {
                        btn.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                        btn.style.color = 'white';
                    }
                } else {
                    // 非アクティブボタンのスタイル
                    btn.style.background = 'white';
                    if (mode === 'want_to_go') {
                        btn.style.color = '#667eea';
                    } else if (mode === 'visited') {
                        btn.style.color = '#48bb78';
                    } else {
                        btn.style.color = '#333';
                    }
                }
            });
            
            // 表示を更新
            updateDisplayForMode();
        }
        
        // モードに応じて表示を更新
        function updateDisplayForMode() {
            const filteredStores = getStoresForDisplayMode(currentDisplayMode);
            updateStoreList(filteredStores);
            updateMapMarkers(filteredStores);
            
            // 表示件数を更新
            document.getElementById('visibleStores').textContent = filteredStores.length;
            
            // モードに応じた通知
            const modeNames = {
                'normal': '通常表示',
                'all': '全表示（通常+行きたい+行った）',
                'want_to_go': '行きたいお店',
                'visited': '行ったお店'
            };
            
            if (currentDisplayMode !== 'normal') {
                showNotification(`${modeNames[currentDisplayMode]}に切り替えました`, 'info');
            }
        }
        
        // 表示モードに応じた店舗を取得
        function getStoresForDisplayMode(mode) {
            let baseStores = getCurrentDisplayedStores(); // 検索・フィルター適用済み
            
            switch (mode) {
                case 'normal':
                    return baseStores; // 通常表示（すべての店舗）
                    
                case 'all':
                    // 全表示: 通常 + 行きたい + 行った（重複除去）
                    return baseStores; // マーカーで視覚的に区別
                    
                case 'want_to_go':
                    // 行きたい店舗のみ
                    const wantToGoStoreIds = userStoreLists
                        .filter(item => item.list_type === 'want_to_go')
                        .map(item => item.store_id);
                    return baseStores.filter(store => wantToGoStoreIds.includes(store.id));
                    
                case 'visited':
                    // 行った店舗のみ
                    const visitedStoreIds = userStoreLists
                        .filter(item => item.list_type === 'visited')
                        .map(item => item.store_id);
                    return baseStores.filter(store => visitedStoreIds.includes(store.id));
                    
                default:
                    return baseStores;
            }
        }

        // ランドマーク検索と周辺店舗表示
        async function searchLandmarkAndShowNearbyStores(query) {
            try {
                // 1. プリセットランドマークから検索
                const landmark = findLandmarkFromPresets(query);
                if (landmark) {
                    await showStoresNearLocation(landmark, `${query}周辺`);
                    return;
                }

                // 2. ジオコーディングで検索
                const geocodedLocation = await geocodeQuery(query);
                if (geocodedLocation) {
                    await showStoresNearLocation(geocodedLocation, `${query}周辺`);
                    return;
                }

                // 3. どちらも見つからない場合
                console.log(`⚠️ 「${query}」に該当する店舗・場所が見つかりませんでした`);
                updateStoreList(stores); // 全店舗を表示

            } catch (error) {
                console.error('❌ 検索エラー:', error);
                updateStoreList(stores);
            }
        }

        // プリセットランドマークから検索
        function findLandmarkFromPresets(query) {
            const queryLower = query.toLowerCase();
            
            // 完全一致検索
            for (const [name, data] of Object.entries(landmarkDatabase)) {
                if (name.toLowerCase() === queryLower) {
                    console.log(`✅ プリセットランドマーク発見: ${name}`);
                    return { lat: data.lat, lng: data.lng, name: name, region: data.region };
                }
            }

            // 部分一致検索
            for (const [name, data] of Object.entries(landmarkDatabase)) {
                if (name.toLowerCase().includes(queryLower) || queryLower.includes(name.toLowerCase())) {
                    console.log(`✅ プリセットランドマーク発見（部分一致）: ${name}`);
                    return { lat: data.lat, lng: data.lng, name: name, region: data.region };
                }
            }

            return null;
        }

        // ジオコーディング検索
        async function geocodeQuery(query) {
            if (!window.locationService) {
                return null;
            }

            try {
                console.log(`🔍 ジオコーディング検索: ${query}`);
                const result = await locationService.geocodeAddress(query);
                if (result) {
                    console.log(`✅ ジオコーディング成功:`, result);
                    return { 
                        lat: result.lat, 
                        lng: result.lng, 
                        name: query,
                        address: result.display_name 
                    };
                }
            } catch (error) {
                console.log('⚠️ ジオコーディング失敗:', error);
            }

            return null;
        }

        // 指定地点周辺の店舗を表示
        async function showStoresNearLocation(location, searchTitle) {
            try {
                // マップを指定地点に移動
                map.setView([location.lat, location.lng], 13);

                // 検索地点マーカーを追加
                addSearchLocationMarker(location);

                // 周辺店舗を距離順で取得（半径20km以内）
                const storesWithDistance = window.locationService 
                    ? locationService.addDistanceToStores(stores, location)
                    : stores;
                
                const nearbyStores = window.locationService
                    ? locationService.getStoresWithinRadius(stores, 20, location) // 20km以内
                    : stores;

                const sortedStores = window.locationService
                    ? locationService.sortByDistance(nearbyStores)
                    : nearbyStores;

                // 表示を更新
                updateStoreList(sortedStores);
                updateMapMarkers(sortedStores);

                // 成功ログ
                console.log(`✅ ${searchTitle} 周辺店舗表示完了: ${sortedStores.length}件`);

            } catch (error) {
                console.error('❌ 周辺店舗表示エラー:', error);
            }
        }

        // 検索地点マーカーを追加
        function addSearchLocationMarker(location) {
            // 既存の検索マーカーを削除
            if (window.searchLocationMarker) {
                map.removeLayer(window.searchLocationMarker);
            }

            // 検索地点マーカーを作成
            const iconHtml = `
                <div class="search-location-marker">
                    <i class="fas fa-search"></i>
                </div>
            `;
            
            const customIcon = L.divIcon({
                html: iconHtml,
                className: 'search-location-wrapper',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            window.searchLocationMarker = L.marker([location.lat, location.lng], { 
                icon: customIcon,
                zIndexOffset: 900
            }).addTo(map);

            // ポップアップを追加
            const popupContent = `
                <div class="search-popup">
                    <h4>${location.name}</h4>
                    ${location.region ? `<p class="region">${location.region}</p>` : ''}
                    ${location.address ? `<p class="address">${location.address}</p>` : ''}
                </div>
            `;
            window.searchLocationMarker.bindPopup(popupContent);
        }

        // Global state for filters and search
        let activeFilters = {
            categories: new Set()
        };
        let currentSearchQuery = '';
        let currentDisplayMode = 'normal'; // 'normal', 'all', 'want_to_go', 'visited'
        
        // Handle filter with multiple selection support
        function handleFilter(event) {
            const button = event.target.closest('.filter-btn');
            const category = button.dataset.category;
            
            if (category === 'all') {
                // Clear all category filters
                activeFilters.categories.clear();
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');
            } else {
                // Toggle category filter
                document.querySelector('.filter-btn[data-category="all"]').classList.remove('active');
                
                if (activeFilters.categories.has(category)) {
                    activeFilters.categories.delete(category);
                    button.classList.remove('active');
                } else {
                    activeFilters.categories.add(category);
                    button.classList.add('active');
                }
                
                // If no filters active, activate "all"
                if (activeFilters.categories.size === 0) {
                    document.querySelector('.filter-btn[data-category="all"]').classList.add('active');
                }
            }
            
            applyAllFilters();
        }
        
        // Apply all active filters
        function applyAllFilters() {
            let filtered = stores;
            
            // Apply category filters
            if (activeFilters.categories.size > 0) {
                filtered = filtered.filter(store => 
                    activeFilters.categories.has(store.category)
                );
            }
            
            // Update displays with filtered results
            updateStoreList(filtered);
            updateMapMarkers(filtered);
        }

        // Update user UI
        function updateUserUI(isLoggedIn) {
            const loginSection = document.getElementById('loginSection');
            const userSection = document.getElementById('userSection');
            const userAvatar = document.getElementById('userAvatar');
            const displayModeSection = document.getElementById('displayModeSection');

            if (isLoggedIn && currentUser) {
                loginSection.style.display = 'none';
                userSection.style.display = 'flex';
                displayModeSection.style.display = 'block'; // 表示モードセクションを表示
                
                // Set avatar initial
                const name = currentUser.user_metadata?.full_name || currentUser.email;
                userAvatar.textContent = name.charAt(0).toUpperCase();
            } else {
                loginSection.style.display = 'block';
                userSection.style.display = 'none';
                displayModeSection.style.display = 'none'; // 表示モードセクションを非表示
                
                // ログアウト時は通常表示に戻す
                currentDisplayMode = 'normal';
            }
        }

        // Handle login
        async function handleLogin() {
            try {
                console.log('🔐 ログイン処理開始');
                
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.href
                    }
                });

                if (error) throw error;

            } catch (error) {
                console.error('❌ ログインエラー:', error);
                showNotification('ログインに失敗しました', 'error');
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                console.log('🔓 ログアウト処理開始');
                
                const { error } = await supabase.auth.signOut();
                if (error) throw error;

                showNotification('ログアウトしました', 'success');

            } catch (error) {
                console.error('❌ ログアウトエラー:', error);
                showNotification('ログアウトに失敗しました', 'error');
            }
        }

        // Open review modal
        function openReviewModal(storeId, storeName) {
            if (!currentUser) {
                showNotification('レビューを投稿するにはログインが必要です', 'error');
                return;
            }

            const modal = document.getElementById('reviewModal');
            const title = document.getElementById('reviewModalTitle');
            const body = document.getElementById('reviewModalBody');

            title.innerHTML = `<i class="fas fa-heart"></i> ${storeName} のレビュー`;
            
            body.innerHTML = `
                <div class="review-form">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-comment-alt"></i>
                            コメント
                        </label>
                        <textarea class="form-textarea" id="reviewComment" placeholder="このお店のグルテンフリー対応について、みんなにシェアしましょう♪" required></textarea>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="reviewVisited">
                            <label for="reviewVisited">実際に訪問しました</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn-primary" onclick="submitReview(${storeId})">
                            <i class="fas fa-heart"></i> レビューを投稿
                        </button>
                        <button class="btn-secondary" onclick="closeReviewModal()">
                            キャンセル
                        </button>
                    </div>
                    <div id="reviewMessage"></div>
                </div>
            `;

            modal.style.display = 'flex';
        }

        // Close review modal
        function closeReviewModal() {
            document.getElementById('reviewModal').style.display = 'none';
        }

        // Submit review
        async function submitReview(storeId) {
            const comment = document.getElementById('reviewComment').value.trim();
            const visited = document.getElementById('reviewVisited').checked;
            const messageDiv = document.getElementById('reviewMessage');

            if (!comment) {
                messageDiv.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-circle"></i>コメントを入力してください</div>';
                return;
            }

            try {
                const { error } = await supabase
                    .from('store_reviews')
                    .insert({
                        store_id: storeId,
                        user_id: currentUser.id,
                        comment: comment,
                        visited: visited,
                        rating: 5 // デフォルト評価
                    });

                if (error) throw error;

                messageDiv.innerHTML = '<div class="success-message"><i class="fas fa-check-circle"></i>レビューを投稿しました！</div>';
                
                // Reload reviews
                await loadReviews();
                updateStats();
                
                setTimeout(() => {
                    closeReviewModal();
                    showNotification('レビューの投稿ありがとうございます！', 'success');
                }, 2000);

            } catch (error) {
                console.error('❌ レビュー投稿エラー:', error);
                messageDiv.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-circle"></i>レビューの投稿に失敗しました</div>';
            }
        }

        // Show floating notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `floating-notification ${type === 'error' ? 'error-message' : 'success-message'}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                ${message}
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 4000);
        }

        // Location service functions
        function initLocationService() {
            if (typeof window.locationService === 'undefined') {
                console.warn('⚠️ LocationService not available');
                return;
            }
            console.log('📍 LocationService初期化完了');
        }

        // Pin mode functions
        function togglePinMode() {
            pinModeActive = !pinModeActive;
            const pinBtn = document.getElementById('pinModeBtn');
            
            if (pinModeActive) {
                pinBtn.classList.add('active');
                map.getContainer().style.cursor = 'crosshair';
                showNotification('📌 地図をクリックしてピンを立ててください', 'info');
            } else {
                pinBtn.classList.remove('active');
                map.getContainer().style.cursor = '';
                showNotification('ピンモードを終了しました', 'info');
            }
        }

        // Create user pin marker
        function createUserPin(lat, lng) {
            // Remove existing user pin
            if (userPin) {
                map.removeLayer(userPin);
            }

            const iconHtml = `<div class="user-pin-marker"></div>`;
            
            const customIcon = L.divIcon({
                html: iconHtml,
                className: 'user-pin-wrapper',
                iconSize: [32, 32],
                iconAnchor: [16, 30]
            });

            userPin = L.marker([lat, lng], { 
                icon: customIcon,
                zIndexOffset: 1100
            }).addTo(map);

            const popupContent = `
                <div class="pin-popup">
                    <h4>📌 指定地点</h4>
                    <p>この地点から近い店舗順に表示しています</p>
                    <button onclick="removeUserPin()" style="
                        background: #ff4757;
                        color: white;
                        border: none;
                        padding: 6px 12px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 12px;
                        margin-top: 8px;
                    ">ピンを削除</button>
                </div>
            `;
            userPin.bindPopup(popupContent);

            return userPin;
        }

        // Remove user pin
        function removeUserPin() {
            if (userPin) {
                map.removeLayer(userPin);
                userPin = null;
                updateStoreList(stores); // Reset to original order
                showNotification('ピンを削除しました', 'success');
            }
        }

        // Show stores near user pin
        function showStoresNearUserPin(lat, lng) {
            if (!window.locationService) {
                console.warn('LocationService not available for user pin');
                return;
            }

            try {
                const pinLocation = { lat, lng };
                
                // Calculate distances and sort
                const storesWithDistance = locationService.addDistanceToStores(stores, pinLocation);
                const sortedStores = locationService.sortByDistance(storesWithDistance);
                
                // Update display
                updateStoreList(sortedStores);
                updateMapMarkers(sortedStores);
                
                console.log(`✅ 指定地点周辺の店舗 ${sortedStores.length}件を距離順で表示`);
                
            } catch (error) {
                console.error('❌ ピン周辺店舗表示エラー:', error);
            }
        }

        // Auto-detect user location on app startup
        async function autoDetectLocation() {
            if (typeof window.locationService === 'undefined') {
                console.warn('⚠️ LocationService not available for auto-detection');
                return;
            }

            // Check if geolocation is supported
            if (!locationService.isSupported()) {
                console.log('📍 位置情報APIがサポートされていません');
                return;
            }

            try {
                console.log('📍 自動現在地取得を開始（静かに実行）...');
                
                // 初回ログイン時のみ、位置情報許可を促す
                const hasLocationPermission = localStorage.getItem('locationPermissionGranted');
                if (!hasLocationPermission) {
                    showNotification('📍 現在地を取得して最寄りの店舗を表示します', 'info');
                }
                
                // Try to get current position with a shorter timeout for initial load
                const location = await locationService.getCurrentPosition({
                    timeout: 8000, // 8秒でタイムアウト
                    enableHighAccuracy: false // 初期取得は低精度でも速度優先
                });
                
                if (location) {
                    console.log('✅ 自動現在地取得成功:', location);
                    
                    // 位置情報許可を記録
                    localStorage.setItem('locationPermissionGranted', 'true');
                    
                    // Create and add current location marker
                    if (window.currentLocationMarker) {
                        map.removeLayer(window.currentLocationMarker);
                        if (window.currentLocationMarker.accuracyCircle) {
                            map.removeLayer(window.currentLocationMarker.accuracyCircle);
                        }
                    }
                    
                    const marker = locationService.createCurrentLocationMarker(location);
                    window.currentLocationMarker = marker;
                    
                    marker.addTo(map);
                    if (marker.accuracyCircle) {
                        marker.accuracyCircle.addTo(map);
                    }
                    
                    // Move map to current location
                    map.setView([location.lat, location.lng], 14);
                    
                    // Update store list with distance sorting
                    updateStoreList(stores);
                    
                    // 自動取得時は通知を表示しない（静かに実行）
                    console.log('✅ 自動現在地取得完了：店舗リストを距離順で更新しました');
                }
                
            } catch (error) {
                console.log('📍 自動現在地取得をスキップ:', error.message);
                // Don't show error notification for auto-detection failure
                // User can still manually get location if needed
            }
        }


        async function getCurrentLocation() {
            if (typeof window.locationService === 'undefined') {
                showNotification('位置情報サービスが利用できません', 'error');
                return;
            }

            try {
                showNotification('現在地を取得中...', 'info');
                
                const location = await locationService.getCurrentPosition();
                
                if (location) {
                    // 現在地マーカーを作成・追加
                    if (window.currentLocationMarker) {
                        map.removeLayer(window.currentLocationMarker);
                        if (window.currentLocationMarker.accuracyCircle) {
                            map.removeLayer(window.currentLocationMarker.accuracyCircle);
                        }
                    }
                    
                    const marker = locationService.createCurrentLocationMarker(location);
                    window.currentLocationMarker = marker;
                    
                    marker.addTo(map);
                    if (marker.accuracyCircle) {
                        marker.accuracyCircle.addTo(map);
                    }
                    
                    // 現在地にマップを移動
                    map.setView([location.lat, location.lng], 15);
                    
                    showNotification('現在地を取得しました', 'success');
                } else {
                    showNotification('現在地の取得に失敗しました', 'error');
                }
            } catch (error) {
                console.error('❌ 現在地取得エラー:', error);
                showNotification('現在地の取得に失敗しました', 'error');
            }
        }


        // Utility functions
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize when DOM is loaded
        // DOMContentLoaded removed - initApp called after auth check

        // Handle modal clicks outside content
        document.getElementById('reviewModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeReviewModal();
            }
        });

        // Store detail modal event listeners
        document.getElementById('storeDetailModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeStoreDetailModal();
            }
        });

        // Lightbox modal event listeners
        document.getElementById('lightboxModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeLightbox();
            }
        });

        // Global variables for lightbox
        let currentImages = [];
        let currentImageIndex = 0;
        
        // Helper functions for store details
        function formatBusinessHours(hours) {
            if (!hours) return '営業時間情報なし';
            // Parse business hours if it's in a structured format
            if (typeof hours === 'object') {
                return Object.entries(hours)
                    .map(([day, time]) => `${day}: ${time}`)
                    .join('<br>');
            }
            return hours;
        }
        
        
        function isOpenNow(hours) {
            // Simple check for current time
            const now = new Date();
            const currentHour = now.getHours();
            const currentDay = now.getDay();
            
            // This is a simplified check - would need proper parsing of hours format
            if (!hours) return null;
            
            // Return null if we can't determine
            return null;
        }

        // Show store detail modal
        function showStoreDetail(storeId) {
            const store = stores.find(s => s.id === storeId);
            if (!store) {
                console.error('Store not found:', storeId);
                return;
            }

            // Set title with category badge
            const categoryStyle = getCategoryMarkerStyle(store.category);
            document.getElementById('storeDetailTitle').innerHTML = `
                <span style="font-weight: 700;">${escapeHtml(store.name)}</span>
                <span style="
                    background: ${categoryStyle.color};
                    color: white;
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-weight: 500;
                    margin-left: 10px;
                    display: inline-block;
                ">${escapeHtml(store.category)}</span>
            `;

            // Create images array
            currentImages = [];
            if (store.image_url) currentImages.push(store.image_url);
            if (store.image_url_2) currentImages.push(store.image_url_2);
            if (store.image_url_3) currentImages.push(store.image_url_3);
            // 互換性のため旧フィールドも対応
            if (store.imageUrl) currentImages.push(store.imageUrl);
            if (store.imageUrl2) currentImages.push(store.imageUrl2);
            if (store.imageUrl3) currentImages.push(store.imageUrl3);

            // Build store detail content
            const detailBody = document.getElementById('storeDetailBody');
            detailBody.innerHTML = `
                <div class="store-images-container">
                    <div class="main-image" onclick="openLightbox(0)">
                        ${currentImages[0] ? 
                            `<img src="${currentImages[0]}" alt="${store.name}">` : 
                            '<div class="image-placeholder">画像なし</div>'
                        }
                    </div>
                    <div class="secondary-images">
                        <div class="secondary-image" onclick="openLightbox(1)">
                            ${currentImages[1] ? 
                                `<img src="${currentImages[1]}" alt="${store.name}">` : 
                                '<div class="image-placeholder">画像なし</div>'
                            }
                        </div>
                        <div class="secondary-image" onclick="openLightbox(2)">
                            ${currentImages[2] ? 
                                `<img src="${currentImages[2]}" alt="${store.name}">` : 
                                '<div class="image-placeholder">画像なし</div>'
                            }
                        </div>
                    </div>
                </div>

                <div class="store-detail-info">
                    <div class="store-detail-section">
                        <h4><i class="fas fa-map-marker-alt"></i> 住所</h4>
                        <p>${store.address || '住所情報なし'}</p>
                        ${store.lat && store.lng && window.locationService && locationService.getCurrentLocation() ? `
                            <p style="color: #4CAF50; font-size: 14px; margin-top: 8px;">
                                <i class="fas fa-route"></i> 
                                現在地から ${locationService.formatDistance(
                                    locationService.calculateDistance(
                                        locationService.getCurrentLocation().lat,
                                        locationService.getCurrentLocation().lng,
                                        store.lat,
                                        store.lng
                                    )
                                )}
                            </p>
                        ` : ''}
                    </div>

                    <div class="store-detail-section">
                        <h4><i class="fas fa-clock"></i> 営業時間</h4>
                        <p>${formatBusinessHours(store.hours || store.business_hours)}</p>
                    </div>

                    ${store.closed || store.holiday ? `
                        <div class="store-detail-section">
                            <h4><i class="fas fa-calendar-times"></i> 定休日</h4>
                            <p>${store.closed || store.holiday}</p>
                        </div>
                    ` : ''}
                    
                    ${store.phone ? `
                        <div class="store-detail-section">
                            <h4><i class="fas fa-phone"></i> 電話番号</h4>
                            <p><a href="tel:${store.phone}" style="color: #4CAF50; text-decoration: none;">${store.phone}</a></p>
                        </div>
                    ` : ''}

                    ${store.description ? `
                        <div class="store-detail-section">
                            <h4><i class="fas fa-info-circle"></i> 詳細</h4>
                            <p>${store.description}</p>
                        </div>
                    ` : ''}

                    ${store.nacoComment ? `
                        <div class="store-detail-section">
                            <h4><i class="fas fa-user-circle"></i> nacoさんのコメント</h4>
                            <p style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary);">${store.nacoComment}</p>
                        </div>
                    ` : ''}

                    <div class="store-actions">
                        ${store.lat && store.lng ? `
                            <button class="store-action-btn" onclick="showOnMap(${store.id}); closeStoreDetailModal();">
                                <i class="fas fa-map"></i> 地図で表示
                            </button>
                        ` : ''}
                        
                        ${store.website ? `
                            <a href="${store.website}" target="_blank" class="store-action-btn">
                                <i class="fas fa-globe"></i> ウェブサイト
                            </a>
                        ` : ''}
                        
                        ${store.instagram ? `
                            <a href="${store.instagram}" target="_blank" class="store-action-btn">
                                <i class="fab fa-instagram"></i> Instagram
                            </a>
                        ` : ''}
                        
                        ${store.googleMapsUrl || (store.lat && store.lng) ? `
                            <a href="${store.googleMapsUrl || `https://www.google.com/maps?q=${store.lat},${store.lng}`}" target="_blank" class="store-action-btn">
                                <i class="fas fa-directions"></i> Google Maps
                            </a>
                        ` : ''}

                        <button class="store-action-btn" onclick="openReviewModal(${store.id})">
                            <i class="fas fa-star"></i> レビュー
                        </button>
                    </div>
                </div>
            `;

            // Show modal
            document.getElementById('storeDetailModal').style.display = 'flex';
        }

        // Close store detail modal
        function closeStoreDetailModal() {
            document.getElementById('storeDetailModal').style.display = 'none';
        }

        // Open lightbox
        function openLightbox(imageIndex) {
            if (!currentImages || currentImages.length === 0) return;
            
            currentImageIndex = imageIndex;
            const image = currentImages[currentImageIndex];
            
            if (image) {
                document.getElementById('lightboxImage').src = image;
                document.getElementById('lightboxCounter').textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
                document.getElementById('lightboxModal').style.display = 'flex';
            }
        }

        // Close lightbox
        function closeLightbox() {
            document.getElementById('lightboxModal').style.display = 'none';
        }

        // Navigate to previous image
        function prevImage() {
            if (currentImages.length === 0) return;
            currentImageIndex = currentImageIndex > 0 ? currentImageIndex - 1 : currentImages.length - 1;
            document.getElementById('lightboxImage').src = currentImages[currentImageIndex];
            document.getElementById('lightboxCounter').textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
        }

        // Navigate to next image
        function nextImage() {
            if (currentImages.length === 0) return;
            currentImageIndex = currentImageIndex < currentImages.length - 1 ? currentImageIndex + 1 : 0;
            document.getElementById('lightboxImage').src = currentImages[currentImageIndex];
            document.getElementById('lightboxCounter').textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
        }

        // Keyboard navigation for lightbox
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('lightboxModal').style.display === 'flex') {
                switch(e.key) {
                    case 'Escape':
                        closeLightbox();
                        break;
                    case 'ArrowLeft':
                        prevImage();
                        break;
                    case 'ArrowRight':
                        nextImage();
                        break;
                }
            }
        });

        // 遅延読み込み画像を作成
        function createLazyImage(src, alt, className = '') {
            const imgId = 'lazy-img-' + Math.random().toString(36).substr(2, 9);
            
            // DOMが更新された後に遅延読み込みを登録
            setTimeout(() => {
                const img = document.getElementById(imgId);
                if (img) {
                    performanceManager.registerLazyImage(img, src, alt);
                }
            }, 100);
            
            return `<img id="${imgId}" alt="${escapeHtml(alt)}" class="${className} lazy-image">`;
        }

        // Make functions globally available for onclick handlers
        window.openReviewModal = openReviewModal;
        window.closeReviewModal = closeReviewModal;
        window.submitReview = submitReview;
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        window.selectStore = selectStore;
        window.showOnMap = showOnMap;
        window.createLazyImage = createLazyImage;
        
        // ページアンロード時のクリーンアップ
        window.addEventListener('beforeunload', () => {
            if (window.performanceManager) {
                performanceManager.cleanup();
            }
        });
    </script>
</body>
</html>