// ÂêçÂè§Â±ã„Ç∞„É´„ÉÜ„É≥„Éï„É™„Éº„Éû„ÉÉ„Éó v3 - „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥
import { getSupabaseClient } from './supabase-client.js';

class GlutenFreeMap {
    constructor() {
        this.supabase = getSupabaseClient();
        this.map = null;
        this.markers = [];
        this.stores = [];
        this.filteredStores = [];
        this.currentFilter = 'all';
        this.searchQuery = '';
        
        // DOMË¶ÅÁ¥†
        this.elements = {
            loading: document.getElementById('loading'),
            storeCount: document.getElementById('store-count'),
            searchInput: document.getElementById('search-input'),
            filterTabs: document.getElementById('filter-tabs'),
            modal: document.getElementById('store-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            closeModal: document.getElementById('close-modal')
        };
        
        this.init();
    }
    
    async init() {
        console.log('üöÄ „Ç∞„É´„ÉÜ„É≥„Éï„É™„Éº„Éû„ÉÉ„Éó v3 ÂàùÊúüÂåñÈñãÂßã');
        
        try {
            // Âú∞Âõ≥ÂàùÊúüÂåñ
            this.initMap();
            
            // Â∫óËàó„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
            await this.loadStores();
            
            // UIÂàùÊúüÂåñ
            this.initUI();
            
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÂÆå‰∫Ü
            this.hideLoading();
            
            console.log('‚úÖ ÂàùÊúüÂåñÂÆå‰∫Ü');
            
        } catch (error) {
            console.error('‚ùå ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            this.showError('„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }
    }
    
    initMap() {
        console.log('üó∫Ô∏è Âú∞Âõ≥„ÇíÂàùÊúüÂåñ‰∏≠...');
        
        // ÂêçÂè§Â±ãÂ∏Ç‰∏≠ÂøÉÈÉ®
        this.map = L.map('map').setView([35.1694, 136.8754], 12);
        
        // OpenStreetMap„Çø„Ç§„É´
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(this.map);
        
        console.log('‚úÖ Âú∞Âõ≥ÂàùÊúüÂåñÂÆå‰∫Ü');
    }
    
    async loadStores() {
        console.log('üè™ Â∫óËàó„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
        
        try {
            const { data: stores, error } = await this.supabase
                .from('stores')
                .select('*')
                .order('name');
            
            if (error) {
                throw error;
            }
            
            this.stores = stores || [];
            this.filteredStores = [...this.stores];
            
            console.log(`‚úÖ ${this.stores.length} Â∫óËàó„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÅøÂÆå‰∫Ü`);
            
            // Â∫óËàó„ÇíÂú∞Âõ≥„Å´Ë°®Á§∫
            this.displayStores();
            
            // „Éï„Ç£„É´„Çø„Éº„Çø„Éñ„ÇíÁîüÊàê
            this.generateFilterTabs();
            
            // Áµ±Ë®àÊõ¥Êñ∞
            this.updateStats();
            
        } catch (error) {
            console.error('‚ùå Â∫óËàó„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            throw new Error(`Â∫óËàó„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
        }
    }
    
    displayStores() {
        console.log(`üìç ${this.filteredStores.length} Â∫óËàó„ÇíÂú∞Âõ≥„Å´Ë°®Á§∫‰∏≠...`);
        
        // Êó¢Â≠ò„Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„Ç¢
        this.clearMarkers();
        
        // ÂêÑÂ∫óËàó„Å´„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
        this.filteredStores.forEach(store => {
            if (this.isValidCoordinate(store.latitude, store.longitude)) {
                const marker = this.createStoreMarker(store);
                this.markers.push(marker);
            }
        });
        
        console.log(`‚úÖ ${this.markers.length} ÂÄã„ÅÆ„Éû„Éº„Ç´„Éº„ÇíË°®Á§∫ÂÆå‰∫Ü`);
    }
    
    createStoreMarker(store) {
        const categoryColors = {
            'ÂíåÈ£ü': '#ff6b6b',
            'Ê¥ãÈ£ü': '#4ecdc4', 
            '„Ç´„Éï„Çß': '#f7b731',
            '„Éë„É≥Â±ã': '#5f27cd',
            'Ë≤©Â£≤Â∫ó': '#00d2d3',
            '„Çπ„Ç§„Éº„ÉÑ': '#ff9ff3'
        };
        
        const color = categoryColors[store.category] || '#98D8C8';
        
        // „Ç´„Çπ„Çø„É†„Ç¢„Ç§„Ç≥„É≥‰ΩúÊàê
        const icon = L.divIcon({
            html: `<div class="custom-marker" style="background-color: ${color};">
                     <i class="fas fa-utensils"></i>
                   </div>`,
            className: 'custom-marker-container',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        const marker = L.marker([store.latitude, store.longitude], { icon })
            .addTo(this.map);
        
        // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
        marker.on('click', () => {
            this.showStoreDetail(store);
        });
        
        // „Éõ„Éê„Éº„Åß„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó
        marker.bindTooltip(
            `<strong>${store.name}</strong><br>${store.category}`,
            { direction: 'top', offset: [0, -15] }
        );
        
        return marker;
    }
    
    showStoreDetail(store) {
        console.log('üìã Â∫óËàóË©≥Á¥∞„ÇíË°®Á§∫:', store.name);
        
        this.elements.modalTitle.textContent = store.name;
        
        this.elements.modalBody.innerHTML = `
            <div class="store-info">
                <div class="store-category">${store.category}</div>
                <div class="store-address">
                    <i class="fas fa-map-marker-alt"></i>
                    ${store.address}
                </div>
                ${store.description ? `
                    <div class="store-description">
                        <p>${store.description}</p>
                    </div>
                ` : ''}
                ${store.phone ? `
                    <div class="store-contact">
                        <i class="fas fa-phone"></i>
                        <a href="tel:${store.phone}">${store.phone}</a>
                    </div>
                ` : ''}
                ${store.website ? `
                    <div class="store-website">
                        <i class="fas fa-globe"></i>
                        <a href="${store.website}" target="_blank">„Ç¶„Çß„Éñ„Çµ„Ç§„Éà</a>
                    </div>
                ` : ''}
                ${store.opening_hours ? `
                    <div class="store-hours">
                        <i class="fas fa-clock"></i>
                        ${store.opening_hours}
                    </div>
                ` : ''}
            </div>
        `;
        
        this.elements.modal.classList.add('show');
    }
    
    generateFilterTabs() {
        const categories = [...new Set(this.stores.map(store => store.category))];
        
        // „Åô„Åπ„Å¶‰ª•Â§ñ„ÅÆ„Çø„Éñ„ÇíËøΩÂä†
        categories.forEach(category => {
            const count = this.stores.filter(store => store.category === category).length;
            const tab = document.createElement('button');
            tab.className = 'filter-tab';
            tab.dataset.category = category;
            tab.textContent = `${category} (${count})`;
            
            tab.addEventListener('click', () => {
                this.setFilter(category);
            });
            
            this.elements.filterTabs.appendChild(tab);
        });
        
        console.log(`‚úÖ ${categories.length} ÂÄã„ÅÆ„Éï„Ç£„É´„Çø„Éº„Çø„Éñ„ÇíÁîüÊàê`);
    }
    
    setFilter(category) {
        this.currentFilter = category;
        
        // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„ÉñÊõ¥Êñ∞
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.classList.toggle('active', 
                tab.dataset.category === category || 
                (category === 'all' && tab.textContent.includes('„Åô„Åπ„Å¶'))
            );
        });
        
        // „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®
        this.applyFilters();
        
        console.log(`üè∑Ô∏è „Éï„Ç£„É´„Çø„ÉºÂ§âÊõ¥: ${category}`);
    }
    
    applyFilters() {
        let filtered = [...this.stores];
        
        // „Ç´„ÉÜ„Ç¥„É™„Éº„Éï„Ç£„É´„Çø„Éº
        if (this.currentFilter !== 'all') {
            filtered = filtered.filter(store => store.category === this.currentFilter);
        }
        
        // Ê§úÁ¥¢„Éï„Ç£„É´„Çø„Éº
        if (this.searchQuery) {
            const query = this.searchQuery.toLowerCase();
            filtered = filtered.filter(store => 
                store.name.toLowerCase().includes(query) ||
                store.address.toLowerCase().includes(query) ||
                (store.description && store.description.toLowerCase().includes(query))
            );
        }
        
        this.filteredStores = filtered;
        this.displayStores();
        this.updateStats();
    }
    
    initUI() {
        // Ê§úÁ¥¢Ê©üËÉΩ
        this.elements.searchInput.addEventListener('input', (e) => {
            this.searchQuery = e.target.value.trim();
            this.applyFilters();
        });
        
        // „É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã
        this.elements.closeModal.addEventListener('click', () => {
            this.elements.modal.classList.remove('show');
        });
        
        this.elements.modal.addEventListener('click', (e) => {
            if (e.target === this.elements.modal) {
                this.elements.modal.classList.remove('show');
            }
        });
        
        // „Äå„Åô„Åπ„Å¶„Äç„Çø„Éñ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
        document.querySelector('[data-category="all"]').addEventListener('click', () => {
            this.setFilter('all');
        });
        
        console.log('‚úÖ UIÂàùÊúüÂåñÂÆå‰∫Ü');
    }
    
    updateStats() {
        this.elements.storeCount.textContent = this.filteredStores.length;
    }
    
    clearMarkers() {
        this.markers.forEach(marker => {
            this.map.removeLayer(marker);
        });
        this.markers = [];
    }
    
    isValidCoordinate(lat, lng) {
        return lat && lng && 
               !isNaN(lat) && !isNaN(lng) &&
               lat >= -90 && lat <= 90 &&
               lng >= -180 && lng <= 180;
    }
    
    hideLoading() {
        this.elements.loading.classList.add('hide');
        setTimeout(() => {
            this.elements.loading.style.display = 'none';
        }, 500);
    }
    
    showError(message) {
        this.elements.loading.innerHTML = `
            <div class="loading-content">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                <h2>„Ç®„É©„Éº</h2>
                <p>${message}</p>
                <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: white; border: none; border-radius: 5px; cursor: pointer;">
                    ÂÜçË™≠„ÅøËæº„Åø
                </button>
            </div>
        `;
    }
}

// DOMContentLoadedÊôÇ„Å´„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÈñãÂßã
document.addEventListener('DOMContentLoaded', () => {
    console.log('üì± DOMË™≠„ÅøËæº„ÅøÂÆå‰∫Ü - „Ç¢„Éó„É™ÈñãÂßã');
    new GlutenFreeMap();
});

// „Ç∞„É≠„Éº„Éê„É´„Ç¢„ÇØ„Çª„ÇπÁî®
window.GlutenFreeMap = GlutenFreeMap;