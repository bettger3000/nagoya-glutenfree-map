<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>グルテンフリーマップ - nacoコミュニティ</title>
    <link rel="icon" href="favicon.png" type="image/png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e3f2fd;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .custom-popup {
            min-width: 250px;
        }

        .store-info h3 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .store-info p {
            color: #718096;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .store-category {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-top: 5px;
        }

        .auth-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            padding: 10px 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 14px;
            color: #2d3748;
        }

        .auth-button:hover {
            border-color: #FFB6C1;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>マップを読み込み中...</p>
        </div>
    </div>

    <div id="map"></div>
    
    <button id="authBtn" class="auth-button">
        <i class="fab fa-google"></i> ログイン
    </button>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        const supabase = createClient(
            'https://lywfaolwvkewuouvkzlk.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5d2Zhb2x3dmtld3VvdXZremxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDg2NjcsImV4cCI6MjA2OTk4NDY2N30.wBGCHOLbP6ew7Bnvxrq0sKSm1EnHk5NNE1sWWH7ff60'
        );

        let map;
        let currentUser = null;

        // マップ初期化
        function initMap() {
            map = L.map('map').setView([35.1815, 136.9066], 12); // 名古屋

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        // 店舗データ読み込み
        async function loadStores() {
            try {
                const { data: stores, error } = await supabase
                    .from('stores')
                    .select('*');

                if (error) {
                    console.error('店舗データエラー:', error);
                    // サンプルデータを表示
                    const sampleStores = [
                        {
                            name: "グルテンフリーカフェ",
                            address: "名古屋市中区栄",
                            latitude: 35.1681,
                            longitude: 136.9082,
                            category: "カフェ",
                            description: "完全グルテンフリー対応のカフェ"
                        }
                    ];
                    displayStores(sampleStores);
                    return;
                }

                displayStores(stores || []);
            } catch (error) {
                console.error('読み込みエラー:', error);
            }
        }

        // 店舗表示
        function displayStores(stores) {
            const categoryColors = {
                'カフェ': '#E53E3E',
                'レストラン': '#38A169', 
                'ベーカリー': '#D69E2E',
                '販売店': '#3182CE',
                'その他': '#718096'
            };

            stores.forEach(store => {
                if (store.latitude && store.longitude) {
                    const color = categoryColors[store.category] || '#718096';
                    
                    const marker = L.circleMarker([store.latitude, store.longitude], {
                        radius: 8,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    const popupContent = `
                        <div class="store-info">
                            <h3>${store.name}</h3>
                            <p><i class="fas fa-map-marker-alt"></i> ${store.address}</p>
                            ${store.description ? `<p>${store.description}</p>` : ''}
                            <span class="store-category" style="background-color: ${color}20; color: ${color};">
                                ${store.category}
                            </span>
                        </div>
                    `;

                    marker.bindPopup(popupContent, { className: 'custom-popup' });
                }
            });
        }

        // 認証チェック
        async function checkAuth() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    document.getElementById('authBtn').innerHTML = `
                        <i class="fas fa-user"></i> ${session.user.email}
                    `;
                    return true;
                }
                return false;
            } catch (error) {
                console.error('認証エラー:', error);
                return false;
            }
        }

        // ログインボタン
        document.getElementById('authBtn').addEventListener('click', async () => {
            if (currentUser) {
                // ログアウト
                await supabase.auth.signOut();
                location.reload();
            } else {
                // ログイン
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google'
                });
                if (error) console.error('ログインエラー:', error);
            }
        });

        // アプリ初期化
        async function initApp() {
            console.log('アプリ初期化開始');
            
            // マップ初期化
            initMap();
            
            // 認証チェック
            await checkAuth();
            
            // 店舗読み込み
            await loadStores();
            
            // ローディング非表示
            document.getElementById('loading').style.display = 'none';
            
            console.log('初期化完了');
        }

        // ページ読み込み完了後に実行
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>