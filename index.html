<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ã‚»ãƒªã‚¢ãƒƒã‚¯ç—…ãƒ»ã‚°ãƒ«ãƒ†ãƒ³éæ•ç—‡ã®æ–¹å‘ã‘ã®åå¤å±‹å¸‚å†…ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼å¯¾å¿œåº—èˆ—ãƒãƒƒãƒ—ã€‚">
    <title>åå¤å±‹ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ— - ãƒ­ã‚°ã‚¤ãƒ³</title>
    
    <!-- Favicon -->
    <link rel="icon" href="favicon.png" type="image/png">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CL6YY713PG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-CL6YY713PG');
    </script>
</head>
<body>
    <script>
        // èªè¨¼ãƒã‚§ãƒƒã‚¯ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†
        console.log('ğŸ”„ index.htmlã‹ã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†é–‹å§‹...');
        
        // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä¸€æ™‚çš„ã«ä½œæˆã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
        import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm').then(({ createClient }) => {
            const SUPABASE_URL = 'https://lywfaolwvkewuouvkzlk.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5d2Zhb2x3dmtld3VvdXZremxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDg2NjcsImV4cCI6MjA2OTk4NDY2N30.wBGCHOLbP6ew7Bnvxrq0sKSm1EnHk5NNE1sWWH7ff60';
            
            const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            window.supabase = supabase; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
            
            supabase.auth.getSession().then(async ({ data: { session }, error }) => {
                const statusEl = document.getElementById('statusMessage');
                
                if (error) {
                    console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                    if (statusEl) statusEl.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...';
                    setTimeout(() => {
                        window.location.href = 'https://bettger3000.github.io/nagoya-glutenfree-map/login.html';
                    }, 2000);
                    return;
                }
                
                if (session && session.user) {
                    console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹ - è¨±å¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ãƒã‚§ãƒƒã‚¯ä¸­...');
                    if (statusEl) statusEl.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç¢ºèªä¸­...';
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const { data: allowedUser, error: checkError } = await supabase
                        .from('allowed_users')
                        .select('email')
                        .eq('email', session.user.email)
                        .single();
                    
                    if (checkError && checkError.code !== 'PGRST116') {
                        console.error('âŒ è¨±å¯ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', checkError);
                        if (statusEl) statusEl.textContent = 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®ç¢ºèªã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                        setTimeout(() => {
                            window.location.href = 'https://bettger3000.github.io/nagoya-glutenfree-map/login.html';
                        }, 2000);
                        return;
                    }
                    
                    if (!allowedUser) {
                        console.log('âŒ æœªè¨±å¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸');
                        if (statusEl) statusEl.textContent = 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...';
                        await supabase.auth.signOut();
                        setTimeout(() => {
                            window.location.href = 'https://bettger3000.github.io/nagoya-glutenfree-map/login.html';
                        }, 2000);
                        return;
                    }
                    
                    console.log('âœ… è¨±å¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª - new-map.htmlã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                    if (statusEl) statusEl.textContent = 'ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ç¢ºèªæ¸ˆã¿ã€‚ãƒãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...';
                    setTimeout(() => {
                        window.location.href = 'https://bettger3000.github.io/nagoya-glutenfree-map/new-map.html';
                    }, 1000);
                } else {
                    console.log('â„¹ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã— - login.htmlã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                    if (statusEl) statusEl.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...';
                    setTimeout(() => {
                        window.location.href = 'https://bettger3000.github.io/nagoya-glutenfree-map/login.html';
                    }, 1000);
                }
            });
        }).catch(error => {
            console.error('âŒ Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
            const statusEl = document.getElementById('statusMessage');
            if (statusEl) statusEl.textContent = 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...';
            setTimeout(() => {
                window.location.href = 'https://bettger3000.github.io/nagoya-glutenfree-map/login.html';
            }, 2000);
        });
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨ - ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒã‚§ãƒƒã‚¯å¯èƒ½
        window.debugAuth = {
            checkSession: async () => {
                const { data, error } = await supabase.auth.getSession();
                console.log('Session:', data, 'Error:', error);
                return data;
            },
            checkAllowedUsers: async () => {
                const { data, error } = await supabase.from('allowed_users').select('*');
                console.log('Allowed users:', data, 'Error:', error);
                return data;
            },
            logout: async () => {
                await supabase.auth.signOut();
                console.log('Logged out');
            }
        };
        console.log('ğŸ”§ Debug tools available: window.debugAuth');
    </script>
    
    <div style="
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #ffb6c1 0%, #98d8c8 100%);
        color: white;
        text-align: center;
    ">
        <div>
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ°</div>
            <h1>åå¤å±‹ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—</h1>
            <p style="margin: 20px 0;" id="statusMessage">èªè¨¼æƒ…å ±ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...</p>
            <div style="
                width: 40px;
                height: 40px;
                border: 4px solid rgba(255,255,255,0.3);
                border-top-color: white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 20px auto;
            "></div>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>