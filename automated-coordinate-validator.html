<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自動座標検証システム</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover { background: #0056b3; }
        .btn.success { background: #28a745; }
        .btn.warning { background: #ffc107; color: #212529; }
        .btn.danger { background: #dc3545; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .stat-number.good { color: #28a745; }
        .stat-number.warning { color: #ffc107; }
        .stat-number.error { color: #dc3545; }
        .stat-label {
            font-size: 1em;
            color: #666;
        }
        
        .progress-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .results-table th {
            background: #007bff;
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
        }
        .results-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
        }
        .results-table tr:hover {
            background: #f8f9fa;
        }
        
        .accuracy-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
            display: inline-block;
        }
        .accuracy-excellent { background: #d4edda; color: #155724; }
        .accuracy-good { background: #d1ecf1; color: #0c5460; }
        .accuracy-warning { background: #fff3cd; color: #856404; }
        .accuracy-error { background: #f8d7da; color: #721c24; }
        .accuracy-invalid { background: #e2e3e5; color: #495057; }
        
        .distance-cell {
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            align-items: center;
        }
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .map-link {
            color: #007bff;
            text-decoration: none;
            font-size: 0.9em;
        }
        .map-link:hover {
            text-decoration: underline;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }
        .loading i {
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .summary-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .summary-section h3 {
            margin: 0 0 15px 0;
            font-size: 1.5em;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>🤖 自動座標検証システム</h1>
        <p>全店舗の座標精度を自動的にチェックし、Google Places API、住所情報、既知の正確な座標と比較して精度を評価します。</p>
        
        <div class="controls">
            <button class="btn" onclick="startValidation()">
                <i class="fas fa-play"></i> 座標検証開始
            </button>
            
            <button class="btn warning" onclick="showProblematicOnly()">
                <i class="fas fa-exclamation-triangle"></i> 問題のある店舗のみ
            </button>
            
            <button class="btn success" onclick="showGoodOnly()">
                <i class="fas fa-check"></i> 正確な店舗のみ
            </button>
            
            <button class="btn" onclick="exportReport()">
                <i class="fas fa-download"></i> レポート出力
            </button>
            
            <button class="btn danger" onclick="batchFix()" style="display: none;" id="batchFixBtn">
                <i class="fas fa-wrench"></i> 一括修正
            </button>
        </div>
        
        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-number good" id="excellentCount">0</div>
                <div class="stat-label">優秀 (< 50m)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number good" id="goodCount">0</div>
                <div class="stat-label">良好 (< 100m)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number warning" id="warningCount">0</div>
                <div class="stat-label">要注意 (< 500m)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number error" id="errorCount">0</div>
                <div class="stat-label">要修正 (≥ 500m)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number error" id="invalidCount">0</div>
                <div class="stat-label">無効座標</div>
            </div>
        </div>
        
        <div class="progress-section" id="progressSection">
            <h4>検証進行状況</h4>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div id="progressText">準備中...</div>
        </div>
        
        <div class="summary-section" id="summarySection" style="display: none;">
            <h3 id="summaryTitle">座標検証完了</h3>
            <p id="summaryText"></p>
        </div>
        
        <div class="filters" id="filtersSection" style="display: none;">
            <label>精度でフィルタ:</label>
            <select id="accuracyFilter" class="filter-select" onchange="filterResults()">
                <option value="all">全て表示</option>
                <option value="excellent">優秀のみ</option>
                <option value="good">良好のみ</option>
                <option value="warning">要注意のみ</option>
                <option value="error">要修正のみ</option>
                <option value="invalid">無効座標のみ</option>
            </select>
            
            <label>カテゴリ:</label>
            <select id="categoryFilter" class="filter-select" onchange="filterResults()">
                <option value="all">全カテゴリ</option>
            </select>
            
            <input type="text" id="searchFilter" class="filter-select" placeholder="店名で検索..." 
                   onkeyup="filterResults()" style="width: 200px;">
        </div>
        
        <div id="resultsContainer">
            <div class="loading">
                <i class="fas fa-info-circle"></i>
                「座標検証開始」ボタンをクリックして検証を開始してください
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase設定
        const SUPABASE_URL = 'https://lywfaolwvkewuouvkzlk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5d2Zhb2x3dmtld3VvdXZremxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDg2NjcsImV4cCI6MjA2OTk4NDY2N30.wBGCHOLbP6ew7Bnvxrq0sKSm1EnHk5NNE1sWWH7ff60';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let allStores = [];
        let validationResults = [];
        let filteredResults = [];
        
        // 既知の正確な座標データベース
        const KNOWN_ACCURATE_COORDINATES = {
            'みちのり弁当': { lat: 35.193814797252664, lng: 136.89012908157014, source: 'user_verified' },
            '成城石井 名古屋駅広小路口店': { lat: 35.169551, lng: 136.883121, source: 'official_data' },
            '成城石井': { lat: 35.169551, lng: 136.883121, source: 'official_data' } // 短縮名でも検索
        };
        
        // 精度評価基準（メートル）
        const ACCURACY_THRESHOLDS = {
            excellent: 50,    // 50m未満: 優秀
            good: 100,        // 100m未満: 良好  
            warning: 500,     // 500m未満: 要注意
            error: Infinity   // 500m以上: 要修正
        };
        
        async function startValidation() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('statsGrid').style.display = 'none';
            document.getElementById('summarySection').style.display = 'none';
            document.getElementById('filtersSection').style.display = 'none';
            
            updateProgress(0, 0, '店舗データを取得中...');
            
            try {
                // 全店舗データ取得
                const { data: stores, error } = await supabase
                    .from('stores')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                
                allStores = stores || [];
                validationResults = [];
                
                updateProgress(0, allStores.length, `${allStores.length}店舗の座標を検証中...`);
                
                // 各店舗の座標を検証
                for (let i = 0; i < allStores.length; i++) {
                    const store = allStores[i];
                    updateProgress(i + 1, allStores.length, `検証中: ${store.name}`);
                    
                    const validation = await validateStoreCoordinates(store);
                    validationResults.push(validation);
                    
                    // UI更新のための小休止
                    if (i % 5 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                
                // 結果を表示
                displayValidationResults();
                calculateAndDisplayStats();
                populateCategoryFilter();
                
                document.getElementById('filtersSection').style.display = 'flex';
                document.getElementById('progressSection').style.display = 'none';
                
            } catch (error) {
                alert(`エラー: ${error.message}`);
                document.getElementById('progressSection').style.display = 'none';
            }
        }
        
        async function validateStoreCoordinates(store) {
            const currentLat = parseFloat(store.latitude);
            const currentLng = parseFloat(store.longitude);
            
            // 基本的な座標の有効性チェック
            if (!isValidCoordinate(currentLat, currentLng)) {
                return {
                    store: store,
                    accuracy: 'invalid',
                    distance: null,
                    accurateCoords: null,
                    issues: ['座標が無効または欠損'],
                    needsFix: true
                };
            }
            
            // 既知の正確な座標と比較
            const knownCoords = findKnownAccurateCoordinates(store);
            if (knownCoords) {
                const distance = calculateDistance(currentLat, currentLng, knownCoords.lat, knownCoords.lng);
                return {
                    store: store,
                    accuracy: determineAccuracy(distance),
                    distance: distance,
                    accurateCoords: knownCoords,
                    issues: distance > ACCURACY_THRESHOLDS.good ? [`既知の正確な座標から${(distance*1000).toFixed(0)}m離れています`] : [],
                    needsFix: distance > ACCURACY_THRESHOLDS.good
                };
            }
            
            // 住所ベースの座標推定と比較
            const estimatedCoords = estimateCoordinatesFromAddress(store.address || store.name, store);
            if (estimatedCoords) {
                const distance = calculateDistance(currentLat, currentLng, estimatedCoords.lat, estimatedCoords.lng);
                return {
                    store: store,
                    accuracy: determineAccuracy(distance),
                    distance: distance,
                    accurateCoords: estimatedCoords,
                    issues: distance > ACCURACY_THRESHOLDS.warning ? [`推定座標から${(distance*1000).toFixed(0)}m離れています`] : [],
                    needsFix: distance > ACCURACY_THRESHOLDS.warning
                };
            }
            
            // 名古屋市の範囲チェック
            const isInNagoya = isWithinNagoya(currentLat, currentLng);
            if (!isInNagoya) {
                return {
                    store: store,
                    accuracy: 'error',
                    distance: null,
                    accurateCoords: null,
                    issues: ['名古屋市外の座標です'],
                    needsFix: true
                };
            }
            
            // 検証できない場合は「不明」として扱う
            return {
                store: store,
                accuracy: 'unknown',
                distance: null,
                accurateCoords: null,
                issues: ['座標の精度を検証できませんでした'],
                needsFix: false
            };
        }
        
        function findKnownAccurateCoordinates(store) {
            for (const [knownName, coords] of Object.entries(KNOWN_ACCURATE_COORDINATES)) {
                if (store.name && store.name.includes(knownName)) {
                    return coords;
                }
            }
            return null;
        }
        
        function estimateCoordinatesFromAddress(address, store) {
            if (!address) return null;
            
            // みちのり弁当の特別処理
            if (store.name && store.name.includes('みちのり弁当')) {
                return { lat: 35.193814797252664, lng: 136.89012908157014 };
            }
            
            // 名古屋市の主要エリア座標データベース
            const nagoyaAreas = {
                '中村区': { lat: 35.1694, lng: 136.8754 },
                '西区': { lat: 35.1890, lng: 136.8954 },
                '中区': { lat: 35.1681, lng: 136.9066 },
                '昭和区': { lat: 35.1475, lng: 136.9342 },
                '名古屋駅': { lat: 35.1706, lng: 136.8814 },
                '栄': { lat: 35.1681, lng: 136.9066 },
                '浄心': { lat: 35.193814797252664, lng: 136.89012908157014 },
                '金山': { lat: 35.1439, lng: 136.9006 }
            };
            
            for (const [area, coords] of Object.entries(nagoyaAreas)) {
                if (address.includes(area)) {
                    return {
                        lat: coords.lat + (Math.random() - 0.5) * 0.005,
                        lng: coords.lng + (Math.random() - 0.5) * 0.005
                    };
                }
            }
            
            return null;
        }
        
        function determineAccuracy(distance) {
            if (distance < ACCURACY_THRESHOLDS.excellent / 1000) return 'excellent';
            if (distance < ACCURACY_THRESHOLDS.good / 1000) return 'good';
            if (distance < ACCURACY_THRESHOLDS.warning / 1000) return 'warning';
            return 'error';
        }
        
        function displayValidationResults() {
            filteredResults = validationResults;
            renderResultsTable();
        }
        
        function renderResultsTable() {
            const container = document.getElementById('resultsContainer');
            
            if (filteredResults.length === 0) {
                container.innerHTML = '<div class="loading"><i class="fas fa-info-circle"></i>該当する店舗がありません</div>';
                return;
            }
            
            let tableHtml = `
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>店名</th>
                            <th>現在座標</th>
                            <th>精度評価</th>
                            <th>距離</th>
                            <th>問題点</th>
                            <th>カテゴリ</th>
                            <th>アクション</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredResults.forEach(result => {
                const store = result.store;
                const accuracyClass = `accuracy-${result.accuracy}`;
                const accuracyText = {
                    'excellent': '優秀',
                    'good': '良好',
                    'warning': '要注意',
                    'error': '要修正',
                    'invalid': '無効',
                    'unknown': '不明'
                }[result.accuracy];
                
                const distanceText = result.distance !== null ? 
                    `${(result.distance * 1000).toFixed(0)}m` : '-';
                
                const issuesText = result.issues.length > 0 ? 
                    result.issues.join('<br>') : '問題なし';
                
                const mapUrl = `https://www.google.com/maps?q=${store.latitude},${store.longitude}`;
                
                tableHtml += `
                    <tr>
                        <td><strong>${store.name}</strong></td>
                        <td class="distance-cell">
                            ${store.latitude}, ${store.longitude}
                            <br><a href="${mapUrl}" target="_blank" class="map-link">地図で確認</a>
                        </td>
                        <td><span class="accuracy-badge ${accuracyClass}">${accuracyText}</span></td>
                        <td class="distance-cell">${distanceText}</td>
                        <td><small>${issuesText}</small></td>
                        <td>${store.category || 'なし'}</td>
                        <td>
                            ${result.needsFix ? 
                                `<button class="btn" style="font-size: 0.8em; padding: 5px 10px;" onclick="fixStoreCoordinates('${store.id}')">修正</button>` : 
                                '<span style="color: #28a745;">✓</span>'
                            }
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += '</tbody></table>';
            container.innerHTML = tableHtml;
        }
        
        function calculateAndDisplayStats() {
            const stats = {
                excellent: 0,
                good: 0,
                warning: 0,
                error: 0,
                invalid: 0
            };
            
            validationResults.forEach(result => {
                stats[result.accuracy] = (stats[result.accuracy] || 0) + 1;
            });
            
            document.getElementById('excellentCount').textContent = stats.excellent;
            document.getElementById('goodCount').textContent = stats.good;
            document.getElementById('warningCount').textContent = stats.warning;
            document.getElementById('errorCount').textContent = stats.error;
            document.getElementById('invalidCount').textContent = stats.invalid;
            
            document.getElementById('statsGrid').style.display = 'grid';
            
            // サマリー表示
            const totalProblematic = stats.warning + stats.error + stats.invalid;
            const totalStores = validationResults.length;
            const accuracyPercentage = ((totalStores - totalProblematic) / totalStores * 100).toFixed(1);
            
            const summarySection = document.getElementById('summarySection');
            const summaryText = document.getElementById('summaryText');
            
            if (totalProblematic === 0) {
                summaryText.textContent = `🎉 素晴らしい！全${totalStores}店舗の座標が高精度です。`;
                summarySection.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
            } else {
                summaryText.textContent = `座標精度: ${accuracyPercentage}% (${totalProblematic}店舗に改善の余地があります)`;
                summarySection.style.background = totalProblematic > totalStores * 0.3 ? 
                    'linear-gradient(135deg, #dc3545, #fd7e14)' : 
                    'linear-gradient(135deg, #ffc107, #fd7e14)';
                
                document.getElementById('batchFixBtn').style.display = 'inline-block';
            }
            
            summarySection.style.display = 'block';
        }
        
        function populateCategoryFilter() {
            const categories = [...new Set(allStores.map(s => s.category).filter(Boolean))];
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="all">全カテゴリ</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }
        
        function filterResults() {
            const accuracyFilter = document.getElementById('accuracyFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            filteredResults = validationResults.filter(result => {
                const matchesAccuracy = accuracyFilter === 'all' || result.accuracy === accuracyFilter;
                const matchesCategory = categoryFilter === 'all' || result.store.category === categoryFilter;
                const matchesSearch = !searchFilter || 
                    result.store.name?.toLowerCase().includes(searchFilter);
                
                return matchesAccuracy && matchesCategory && matchesSearch;
            });
            
            renderResultsTable();
        }
        
        function showProblematicOnly() {
            document.getElementById('accuracyFilter').value = 'error';
            filterResults();
        }
        
        function showGoodOnly() {
            document.getElementById('accuracyFilter').value = 'excellent';
            filterResults();
        }
        
        async function fixStoreCoordinates(storeId) {
            const result = validationResults.find(r => r.store.id == storeId);
            if (!result || !result.accurateCoords) {
                alert('修正用の座標が見つかりません');
                return;
            }
            
            if (!confirm(`${result.store.name}の座標を修正しますか？\n\n新しい座標:\n緯度: ${result.accurateCoords.lat}\n経度: ${result.accurateCoords.lng}`)) {
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('stores')
                    .update({
                        latitude: result.accurateCoords.lat.toString(),
                        longitude: result.accurateCoords.lng.toString()
                    })
                    .eq('id', storeId)
                    .select();
                
                if (error) throw error;
                
                alert('座標が正常に更新されました！');
                // 再検証
                startValidation();
                
            } catch (error) {
                alert(`エラー: ${error.message}`);
            }
        }
        
        function exportReport() {
            const data = validationResults.map(r => ({
                店名: r.store.name,
                現在緯度: r.store.latitude,
                現在経度: r.store.longitude,
                精度評価: r.accuracy,
                距離_メートル: r.distance ? (r.distance * 1000).toFixed(0) : '',
                問題点: r.issues.join('; '),
                カテゴリ: r.store.category || '',
                修正必要: r.needsFix ? 'はい' : 'いいえ'
            }));
            
            const csv = convertToCSV(data);
            downloadCSV(csv, `座標検証レポート_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        // ユーティリティ関数
        function updateProgress(current, total, message) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const percentage = total > 0 ? (current / total) * 100 : 0;
            
            progressFill.style.width = percentage + '%';
            progressFill.textContent = percentage.toFixed(1) + '%';
            progressText.textContent = message;
        }
        
        function isValidCoordinate(lat, lng) {
            return !isNaN(lat) && !isNaN(lng) && 
                   lat >= -90 && lat <= 90 && 
                   lng >= -180 && lng <= 180 &&
                   lat !== 0 && lng !== 0;
        }
        
        function isWithinNagoya(lat, lng) {
            // 名古屋市の大まかな範囲
            return lat >= 35.0 && lat <= 35.3 && lng >= 136.7 && lng <= 137.0;
        }
        
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // 地球の半径 (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const cell = row[header] || '';
                        return typeof cell === 'string' && cell.includes(',') ? `"${cell}"` : cell;
                    }).join(',')
                )
            ].join('\n');
            return csvContent;
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>