<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>セキュア管理画面 - グルテンフリーマップ</title>
    
    <!-- Google tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CL6YY713PG"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-CL6YY713PG');
    </script>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-pink: #ffb6c1;
            --primary-green: #98d8c8;
            --success-green: #28a745;
            --danger-red: #dc3545;
            --warning-orange: #ffc107;
            --info-blue: #17a2b8;
            --dark-gray: #4a4a4a;
            --light-gray: #f8f9fa;
            --border-color: #e9ecef;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', 'Meiryo', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--primary-green) 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            color: var(--dark-gray);
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--light-gray);
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .user-info .welcome {
            color: var(--dark-gray);
            font-weight: bold;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--primary-green) 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-weight: 500;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn.btn-success {
            background: var(--success-green);
        }
        
        .btn.btn-danger {
            background: var(--danger-red);
        }
        
        .btn.btn-warning {
            background: var(--warning-orange);
            color: var(--dark-gray);
        }
        
        .btn.btn-info {
            background: var(--info-blue);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .controls {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .controls h2 {
            color: var(--dark-gray);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .table-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--primary-green) 100%);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background-color: var(--light-gray);
        }
        
        .category-badge {
            padding: 6px 12px;
            border-radius: 15px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        
        .category-和食 { background-color: #ff6b6b; }
        .category-洋食 { background-color: #4ecdc4; }
        .category-カフェ { background-color: #f7b731; }
        .category-パン屋 { background-color: #5f27cd; }
        .category-販売店 { background-color: #00d2d3; }
        .category-スイーツ { background-color: #ff69b4; }
        
        .visit-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .visit-status.naco {
            background-color: #ffe6e6;
            color: #d32f2f;
        }
        
        .visit-status.member {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .visit-status.unvisited {
            background-color: #f5f5f5;
            color: #666;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            max-height: 90vh;
            margin: 50px auto;
            padding: 40px;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .modal-header h2 {
            color: var(--dark-gray);
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: var(--light-gray);
            color: var(--dark-gray);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-gray);
            font-weight: bold;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(152, 216, 200, 0.1);
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }
        
        .status {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .csv-drop-zone {
            border: 3px dashed var(--primary-green);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s;
            cursor: pointer;
            background: var(--light-gray);
        }
        
        .csv-drop-zone:hover,
        .csv-drop-zone.dragover {
            border-color: var(--primary-pink);
            background: #fff;
            transform: translateY(-2px);
        }
        
        .csv-drop-zone i {
            font-size: 48px;
            color: var(--primary-green);
            margin-bottom: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-green);
            margin-bottom: 5px;
        }
        
        .stat-card .label {
            color: var(--dark-gray);
            font-size: 14px;
        }
        
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .login-container h1 {
            color: var(--dark-gray);
            margin-bottom: 30px;
        }
        
        .login-form .form-group {
            text-align: left;
            margin-bottom: 25px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .controls, .table-container {
                padding: 20px;
            }
            
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ログイン画面 -->
    <div id="loginContainer" class="login-container">
        <h1><i class="fas fa-shield-alt"></i> セキュア管理画面</h1>
        <p style="margin-bottom: 30px; color: #666;">グルテンフリーマップ管理者専用</p>
        
        <form id="loginForm" class="login-form">
            <div class="form-group">
                <label for="email">メールアドレス</label>
                <input type="email" id="email" required>
            </div>
            
            <div class="form-group">
                <label for="password">パスワード</label>
                <input type="password" id="password" required>
            </div>
            
            <button type="submit" class="btn" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> ログイン
            </button>
            
            <div style="text-align: center; margin: 20px 0; color: #666;">または</div>
            
            <button type="button" class="btn" onclick="window.createAccount()" style="
                width: 100%;
                background: #28a745;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                margin-top: 10px;
            ">
                <i class="fas fa-user-plus"></i> 新規アカウントを作成
            </button>
            
            <button type="button" class="btn" onclick="window.loginWithGitHub()" style="
                width: 100%;
                background: #333;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                margin-top: 10px;
            ">
                <i class="fab fa-github"></i> GitHubでログイン
            </button>
        </form>
        
        <div id="loginStatus" class="status"></div>
    </div>

    <!-- メイン管理画面 -->
    <div id="mainContainer" class="container" style="display: none;">
        <div class="header">
            <h1><i class="fas fa-cogs"></i> セキュア管理画面</h1>
            <p>グルテンフリーマップ - 店舗データ管理</p>
        </div>

        <div class="user-info">
            <div class="welcome">
                <i class="fas fa-user"></i> ようこそ、<span id="userEmail"></span>さん
            </div>
            <button class="btn btn-danger" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> ログアウト
            </button>
        </div>

        <!-- 統計情報 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="number" id="totalStores">0</div>
                <div class="label">総店舗数</div>
            </div>
            <div class="stat-card">
                <div class="number" id="nacoVisited">0</div>
                <div class="label">naco訪問済み</div>
            </div>
            <div class="stat-card">
                <div class="number" id="memberVisited">0</div>
                <div class="label">メンバー訪問済み</div>
            </div>
            <div class="stat-card">
                <div class="number" id="unvisited">0</div>
                <div class="label">未確認店舗</div>
            </div>
        </div>

        <!-- 操作パネル -->
        <div class="controls">
            <h2><i class="fas fa-tools"></i> 管理操作</h2>
            <div class="button-grid">
                <button class="btn btn-success" onclick="showAddModal()">
                    <i class="fas fa-plus"></i> 新しい店舗を追加
                </button>
                <button class="btn btn-info" onclick="showCSVModal()">
                    <i class="fas fa-file-csv"></i> CSVアップロード
                </button>
                <button class="btn btn-warning" onclick="exportData()">
                    <i class="fas fa-download"></i> データエクスポート
                </button>
                <button class="btn" onclick="reloadData()">
                    <i class="fas fa-sync-alt"></i> データ再読み込み
                </button>
            </div>
        </div>

        <div id="status" class="status"></div>

        <!-- 店舗一覧テーブル -->
        <div class="table-container">
            <h2><i class="fas fa-table"></i> 店舗一覧</h2>
            <table id="storesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>店舗名</th>
                        <th>カテゴリー</th>
                        <th>住所</th>
                        <th>GF対応</th>
                        <th>訪問ステータス</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="storesTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- 店舗追加・編集モーダル -->
    <div id="storeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">新しい店舗を追加</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="storeForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="storeName">店舗名 <span style="color: red;">*</span></label>
                        <input type="text" id="storeName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="storeCategory">カテゴリー <span style="color: red;">*</span></label>
                        <select id="storeCategory" required>
                            <option value="">選択してください</option>
                            <option value="和食">和食</option>
                            <option value="洋食">洋食</option>
                            <option value="カフェ">カフェ</option>
                            <option value="パン屋">パン屋</option>
                            <option value="販売店">販売店</option>
                            <option value="スイーツ">スイーツ</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label for="storeAddress">住所 <span style="color: red;">*</span></label>
                    <input type="text" id="storeAddress" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="storeLat">緯度</label>
                        <input type="number" id="storeLat" step="0.0001" placeholder="例: 35.1709">
                    </div>
                    
                    <div class="form-group">
                        <label for="storeLng">経度</label>
                        <input type="number" id="storeLng" step="0.0001" placeholder="例: 136.8833">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="storeHours">営業時間</label>
                        <input type="text" id="storeHours" placeholder="例: 10:00-19:00">
                    </div>
                    
                    <div class="form-group">
                        <label for="storeClosed">定休日</label>
                        <input type="text" id="storeClosed" placeholder="例: 月曜日">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="storeTel">電話番号</label>
                        <input type="text" id="storeTel" placeholder="例: 052-123-4567">
                    </div>
                    
                    <div class="form-group">
                        <label for="storeGfType">GF対応</label>
                        <select id="storeGfType">
                            <option value="">選択してください</option>
                            <option value="完全GF">完全GF</option>
                            <option value="部分GF">部分GF</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label for="storeDescription">店舗説明</label>
                    <textarea id="storeDescription" placeholder="店舗の特徴や詳細情報を入力"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="storeVisitStatus">訪問ステータス</label>
                        <select id="storeVisitStatus">
                            <option value="">選択してください</option>
                            <option value="naco">🔴 naco訪問済み</option>
                            <option value="member">🟡 メンバー訪問済み</option>
                            <option value="unvisited">🤍 未確認店舗</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="storeCheckedBy">確認者</label>
                        <input type="text" id="storeCheckedBy" placeholder="確認した人の名前">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="storeWebsite">ウェブサイト</label>
                        <input type="url" id="storeWebsite" placeholder="https://example.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="storeInstagram">Instagram</label>
                        <input type="url" id="storeInstagram" placeholder="https://instagram.com/username">
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label for="storeImageUrl">メイン画像URL</label>
                    <input type="url" id="storeImageUrl" placeholder="https://example.com/image.jpg">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="storeImageUrl2">追加画像URL1</label>
                        <input type="url" id="storeImageUrl2" placeholder="https://example.com/image2.jpg">
                    </div>
                    
                    <div class="form-group">
                        <label for="storeImageUrl3">追加画像URL2</label>
                        <input type="url" id="storeImageUrl3" placeholder="https://example.com/image3.jpg">
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">
                        <i class="fas fa-save"></i> 保存
                    </button>
                    <button type="button" class="btn" onclick="closeModal()" style="flex: 1;">
                        <i class="fas fa-times"></i> キャンセル
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- CSVアップロードモーダル -->
    <div id="csvModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>CSVアップロード</h2>
                <button class="close-btn" onclick="closeCSVModal()">&times;</button>
            </div>
            
            <div class="csv-drop-zone" id="csvDropZone">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>CSVファイルをドラッグ＆ドロップ</h3>
                <p>または、<strong>クリックしてファイルを選択</strong></p>
                <input type="file" id="csvFile" accept=".csv" style="display: none;">
            </div>
            
            <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--info-blue);">
                <h4><i class="fas fa-info-circle"></i> CSVフォーマット</h4>
                <p><strong>ファイル構造：</strong></p>
                <ul style="font-size: 12px; margin: 8px 0; padding-left: 20px;">
                    <li><strong>1行目：</strong> 列名（ヘッダー）</li>
                    <li><strong>2行目：</strong> 入力例（スキップされます）</li>
                    <li><strong>3行目以降：</strong> データ行</li>
                </ul>
                <p><strong>推奨列名：</strong></p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 5px; font-size: 12px; margin-top: 8px;">
                    <span>• 店舗名 (必須)</span>
                    <span>• カテゴリー</span>
                    <span>• 住所</span>
                    <span>• 緯度</span>
                    <span>• 経度</span>
                    <span>• 営業時間</span>
                    <span>• 定休日</span>
                    <span>• 電話番号</span>
                    <span>• 説明</span>
                    <span>• GF対応</span>
                    <span>• 訪問ステータス</span>
                    <span>• 確認者</span>
                </div>
                <p style="margin-top: 8px; font-size: 12px; color: #666;">
                    ※ 英語名（name, category, address等）にも対応しています
                </p>
            </div>

            <div id="csvPreview" style="display: none;">
                <h3>プレビュー</h3>
                <div id="csvPreviewContent"></div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-success" id="csvUploadBtn" onclick="uploadCSV()" disabled>
                    <i class="fas fa-upload"></i> アップロード
                </button>
                <button class="btn" onclick="closeCSVModal()">
                    <i class="fas fa-times"></i> キャンセル
                </button>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // グローバル変数
        let supabaseClient = null;
        
        // Supabase初期化
        function initSupabase() {
            const { createClient } = supabase;
            const SUPABASE_URL = 'https://lywfaolwvkewuouvkzlk.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5d2Zhb2x3dmtld3VvdXZremxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDg2NjcsImV4cCI6MjA2OTk4NDY2N30.wBGCHOLbP6ew7Bnvxrq0sKSm1EnHk5NNE1sWWH7ff60';
            
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            window.supabase = supabaseClient;
            return supabaseClient;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Supabaseを初期化
            initSupabase();
        
        let storesData = [];
        let editingStoreId = null;
        
        // アカウント作成（グローバル関数）
        async function createAccount() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showStatus('メールアドレスとパスワードを入力してください', 'error');
                return;
            }
            
            // メールアドレス制限を削除（どのメールアドレスでも作成可能）
            
            try {
                showStatus('アカウントを作成中...', 'info');
                
                const { data, error } = await window.supabase.auth.signUp({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                if (data.user) {
                    showStatus('アカウントが作成されました。メール認証を確認してからログインしてください。', 'success');
                }
                
            } catch (error) {
                showStatus(`アカウント作成エラー: ${error.message}`, 'error');
            }
        }
        
        // ステータス表示（グローバル関数）
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status') || document.getElementById('loginStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            statusDiv.style.display = 'flex';
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // GitHubログイン（グローバル関数）
        async function loginWithGitHub() {
            try {
                showStatus('GitHubでログイン中...', 'info');
                
                const { data, error } = await window.supabase.auth.signInWithOAuth({
                    provider: 'github',
                    options: {
                        redirectTo: window.location.href
                    }
                });
                
                if (error) throw error;
                
            } catch (error) {
                showStatus(`GitHubログインエラー: ${error.message}`, 'error');
            }
        }

        // グローバルに登録
        window.createAccount = createAccount;
        window.loginWithGitHub = loginWithGitHub;
        window.showStatus = showStatus;
        
            // 認証状態変化の監視
            supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session) {
                showStatus('ログインに成功しました', 'success');
                setTimeout(() => {
                    showMainContainer();
                    document.getElementById('userEmail').textContent = session.user.email;
                    loadStoresData();
                }, 1000);
            } else if (event === 'SIGNED_OUT') {
                showLoginContainer();
            }
        });

            // 初期化
            checkAuth();
            setupEventListeners();
            setupStoreForm();
            setupCSVUpload();
        });
        
        // 認証チェック
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (user) {
                showMainContainer();
                document.getElementById('userEmail').textContent = user.email;
                await loadStoresData();
            } else {
                showLoginContainer();
            }
        }
        

        // ログイン処理
        async function login(email, password) {
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                if (data.user) {
                    showStatus('ログインに成功しました', 'success');
                    setTimeout(() => {
                        showMainContainer();
                        document.getElementById('userEmail').textContent = data.user.email;
                        loadStoresData();
                    }, 1000);
                } else {
                    throw new Error('管理者権限がありません');
                }
                
            } catch (error) {
                showStatus(`ログインエラー: ${error.message}`, 'error');
            }
        }
        
        // ログアウト処理
        window.logout = async function() {
            await supabase.auth.signOut();
            showLoginContainer();
        };
        
        // 画面表示切り替え
        function showLoginContainer() {
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
        }
        
        function showMainContainer() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
        }
        
        // イベントリスナー設定
        function setupEventListeners() {
            // ログインフォーム
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                login(email, password);
            });
            
        }
        
        // 店舗データ読み込み
        async function loadStoresData() {
            try {
                showStatus('データを読み込み中...', 'info');
                
                const { data, error } = await supabase
                    .from('stores')
                    .select('*')
                    .order('id', { ascending: true });
                
                if (error) throw error;
                
                storesData = data;
                updateStoresTable();
                updateStats();
                showStatus(`${storesData.length}件の店舗データを読み込みました`, 'success');
                
            } catch (error) {
                showStatus(`データ読み込みエラー: ${error.message}`, 'error');
            }
        }
        
        // 統計情報更新
        function updateStats() {
            const total = storesData.length;
            const naco = storesData.filter(s => s.visit_status === 'naco').length;
            const member = storesData.filter(s => s.visit_status === 'member').length;
            const unvisited = storesData.filter(s => !s.visit_status || s.visit_status === 'unvisited').length;
            
            document.getElementById('totalStores').textContent = total;
            document.getElementById('nacoVisited').textContent = naco;
            document.getElementById('memberVisited').textContent = member;
            document.getElementById('unvisited').textContent = unvisited;
        }
        
        // テーブル更新
        function updateStoresTable() {
            const tbody = document.getElementById('storesTableBody');
            tbody.innerHTML = '';
            
            storesData.forEach(store => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${store.id}</td>
                    <td>${store.name}</td>
                    <td><span class="category-badge category-${store.category}">${store.category || '未分類'}</span></td>
                    <td>${store.address || '住所未登録'}</td>
                    <td>${store.gluten_free_type || '未設定'}</td>
                    <td><span class="visit-status ${store.visit_status || 'unvisited'}">${getVisitStatusDisplay(store.visit_status)}</span></td>
                    <td>
                        <button class="btn" onclick="editStore(${store.id})" style="padding: 5px 10px; margin: 2px;">
                            <i class="fas fa-edit"></i> 編集
                        </button>
                        <button class="btn btn-danger" onclick="deleteStore(${store.id})" style="padding: 5px 10px; margin: 2px;">
                            <i class="fas fa-trash"></i> 削除
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 訪問ステータス表示
        function getVisitStatusDisplay(status) {
            switch (status) {
                case 'naco': return '🔴 naco訪問済み';
                case 'member': return '🟡 メンバー訪問済み';
                case 'unvisited': return '🤍 未確認店舗';
                default: return '🤍 未確認店舗';
            }
        }
        
        
        // グローバル関数
        window.showAddModal = function() {
            editingStoreId = null;
            document.getElementById('modalTitle').textContent = '新しい店舗を追加';
            document.getElementById('storeForm').reset();
            document.getElementById('storeModal').style.display = 'block';
        };
        
        window.editStore = function(id) {
            const store = storesData.find(s => s.id === id);
            if (!store) return;
            
            editingStoreId = id;
            document.getElementById('modalTitle').textContent = '店舗情報を編集';
            
            // フォームに値を設定
            document.getElementById('storeName').value = store.name || '';
            document.getElementById('storeCategory').value = store.category || '';
            document.getElementById('storeAddress').value = store.address || '';
            document.getElementById('storeLat').value = store.lat || '';
            document.getElementById('storeLng').value = store.lng || '';
            document.getElementById('storeHours').value = store.hours || '';
            document.getElementById('storeClosed').value = store.closed || '';
            document.getElementById('storeTel').value = store.tel || '';
            document.getElementById('storeDescription').value = store.description || '';
            document.getElementById('storeGfType').value = store.gluten_free_type || '';
            document.getElementById('storeVisitStatus').value = store.visit_status || '';
            document.getElementById('storeCheckedBy').value = store.checked_by || '';
            document.getElementById('storeWebsite').value = store.website || '';
            document.getElementById('storeInstagram').value = store.instagram || '';
            document.getElementById('storeImageUrl').value = store.image_url || '';
            document.getElementById('storeImageUrl2').value = store.image_url2 || '';
            document.getElementById('storeImageUrl3').value = store.image_url3 || '';
            
            document.getElementById('storeModal').style.display = 'block';
        };
        
        window.deleteStore = async function(id) {
            if (!confirm('この店舗を削除しますか？')) return;
            
            try {
                const { error } = await supabase
                    .from('stores')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showStatus('店舗を削除しました', 'success');
                await loadStoresData();
                
            } catch (error) {
                showStatus(`削除エラー: ${error.message}`, 'error');
            }
        };
        
        window.closeModal = function() {
            document.getElementById('storeModal').style.display = 'none';
        };
        
        window.showCSVModal = function() {
            document.getElementById('csvModal').style.display = 'block';
        };
        
        window.closeCSVModal = function() {
            document.getElementById('csvModal').style.display = 'none';
        };
        
        window.reloadData = function() {
            loadStoresData();
        };
        
        window.exportData = function() {
            // CSVエクスポート機能（後で実装）
            showStatus('エクスポート機能は準備中です', 'info');
        };
        
        // CSVアップロード機能
        let csvData = null;
        
        function setupCSVUpload() {
            const dropZone = document.getElementById('csvDropZone');
            const fileInput = document.getElementById('csvFile');
            const preview = document.getElementById('csvPreview');
            const previewContent = document.getElementById('csvPreviewContent');
            const uploadBtn = document.getElementById('csvUploadBtn');

            // ドラッグ&ドロップイベント
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.background = '#e8f5e8';
                dropZone.style.borderColor = 'var(--success-green)';
            });
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.background = 'var(--light-gray)';
                dropZone.style.borderColor = 'var(--primary-green)';
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.background = 'var(--light-gray)';
                dropZone.style.borderColor = 'var(--primary-green)';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleCSVFile(files[0]);
                }
            });

            // ファイル選択イベント
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleCSVFile(e.target.files[0]);
                }
            });
        }

        function handleCSVFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showStatus('CSVファイルを選択してください', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                parseCSV(csvText);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(csvText) {
            try {
                // BOM（Byte Order Mark）を除去
                csvText = csvText.replace(/^\uFEFF/, '');
                
                const lines = csvText.trim().split('\n');
                
                if (lines.length < 3) {
                    throw new Error('CSVファイルには最低3行必要です（ヘッダー行とデータ行）');
                }
                
                // 1行目をヘッダーとして使用
                const headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/"/g, ''));
                
                // 3行目以降をデータ行として処理（2行目は入力例なのでスキップ）
                csvData = [];
                for (let i = 2; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length > 0 && values.some(v => v.trim() !== '')) {
                        const row = {};
                        headers.forEach((header, index) => {
                            if (index < values.length) {
                                row[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
                            } else {
                                row[header] = '';
                            }
                        });
                        csvData.push(row);
                    }
                }

                showCSVPreview(headers, csvData.slice(0, 5));
                document.getElementById('csvUploadBtn').disabled = false;
                showStatus(`${csvData.length}行のデータを読み込みました（2行目の入力例はスキップ）`, 'success');
                
            } catch (error) {
                showStatus(`CSVパースエラー: ${error.message}`, 'error');
                console.error('CSV Parse Error:', error);
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }

        function showCSVPreview(headers, data) {
            const preview = document.getElementById('csvPreview');
            const content = document.getElementById('csvPreviewContent');
            
            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 12px;"><thead><tr>';
            headers.forEach(header => {
                html += `<th style="border: 1px solid #ddd; padding: 5px; background: #f0f0f0;">${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td style="border: 1px solid #ddd; padding: 5px;">${row[header] || ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            content.innerHTML = html;
            preview.style.display = 'block';
        }

        async function uploadCSV() {
            if (!csvData || csvData.length === 0) {
                showStatus('アップロードするデータがありません', 'error');
                return;
            }

            try {
                showStatus('CSVデータをアップロード中...', 'info');
                
                // データを変換
                const storeData = csvData.map(row => {
                    // 訪問ステータスの変換
                    let visitStatus = '未確認';
                    const rawVisitStatus = row['訪問ステータス'] || row['visit_status'] || '';
                    if (rawVisitStatus === 'naco') visitStatus = 'naco';
                    else if (rawVisitStatus === 'member') visitStatus = 'member';
                    else if (rawVisitStatus === 'unvisited') visitStatus = '未確認';
                    
                    // GF対応の変換
                    let gfType = '対応可能';
                    const rawGfType = row['GF対応'] || row['gluten_free_type'] || '';
                    if (rawGfType === '完全GF' || rawGfType === '専門店') gfType = '専門店';
                    else if (rawGfType === '部分GF' || rawGfType === '対応可能') gfType = '対応可能';
                    
                    return {
                        name: row['店舗名'] || row['name'] || '',
                        category: row['カテゴリー'] || row['category'] || '',
                        address: row['住所'] || row['address'] || '',
                        lat: parseFloat(row['緯度'] || row['lat'] || row['latitude']) || null,
                        lng: parseFloat(row['経度'] || row['lng'] || row['longitude']) || null,
                        hours: row['営業時間'] || row['hours'] || '',
                        closed: row['定休日'] || row['closed'] || '',
                        tel: row['電話番号'] || row['tel'] || row['phone'] || '',
                        description: row['店舗説明'] || row['説明'] || row['description'] || '',
                        gluten_free_type: gfType,
                        visit_status: visitStatus,
                        checked_by: row['確認者'] || row['checked_by'] || '',
                        website: row['ウェブサイト'] || row['website'] || '',
                        instagram: row['Instagram'] || row['instagram'] || '',
                        image_url: row['メイン画像URL'] || row['画像URL'] || row['image_url'] || '',
                        image_url2: row['追加画像URL1'] || row['image_url2'] || '',
                        image_url3: row['追加画像URL2'] || row['image_url3'] || ''
                    };
                });

                // Supabaseに一括挿入
                const { data, error } = await window.supabase
                    .from('stores')
                    .insert(storeData);

                if (error) throw error;

                showStatus(`${storeData.length}件の店舗データをアップロードしました`, 'success');
                closeCSVModal();
                await loadStoresData();
                
            } catch (error) {
                showStatus(`アップロードエラー: ${error.message}`, 'error');
            }
        }

        window.uploadCSV = uploadCSV;

        // 店舗フォーム送信の設定
        function setupStoreForm() {
            if (document.getElementById('storeForm')) {
                document.getElementById('storeForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = {
                name: document.getElementById('storeName').value,
                category: document.getElementById('storeCategory').value,
                address: document.getElementById('storeAddress').value,
                lat: document.getElementById('storeLat').value ? parseFloat(document.getElementById('storeLat').value) : null,
                lng: document.getElementById('storeLng').value ? parseFloat(document.getElementById('storeLng').value) : null,
                hours: document.getElementById('storeHours').value,
                closed: document.getElementById('storeClosed').value,
                tel: document.getElementById('storeTel').value,
                description: document.getElementById('storeDescription').value,
                gluten_free_type: document.getElementById('storeGfType').value,
                visit_status: document.getElementById('storeVisitStatus').value,
                checked_by: document.getElementById('storeCheckedBy').value,
                website: document.getElementById('storeWebsite').value,
                instagram: document.getElementById('storeInstagram').value,
                image_url: document.getElementById('storeImageUrl').value,
                image_url2: document.getElementById('storeImageUrl2').value,
                image_url3: document.getElementById('storeImageUrl3').value
                    };
                    
                    try {
                        let result;
                        if (editingStoreId) {
                            // 更新
                            result = await supabase
                                .from('stores')
                                .update(formData)
                                .eq('id', editingStoreId);
                        } else {
                            // 新規追加
                            result = await supabase
                                .from('stores')
                                .insert(formData);
                        }
                        
                        if (result.error) throw result.error;
                        
                        showStatus(editingStoreId ? '店舗情報を更新しました' : '新しい店舗を追加しました', 'success');
                        closeModal();
                        await loadStoresData();
                        
                    } catch (error) {
                        showStatus(`保存エラー: ${error.message}`, 'error');
                    }
                });
            }
        }
        
    </script>
</body>
</html>