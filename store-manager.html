<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—èˆ—ç®¡ç†ãƒ„ãƒ¼ãƒ« - ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—</title>
    <style>
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #F8C8DC, #E8B4FF);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #F8C8DC, #E8B4FF);
            padding: 20px;
            text-align: center;
            color: #2D2D2D;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .tab.active {
            background: white;
            border-bottom: 3px solid #F8C8DC;
            color: #2D2D2D;
            font-weight: bold;
        }
        .tab:hover:not(.active) {
            background: #e9ecef;
        }
        .tab-content {
            display: none;
            padding: 20px;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2D2D2D;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #F8C8DC;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #E8B4FF;
            box-shadow: 0 0 0 3px rgba(232, 180, 255, 0.2);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .btn {
            background: #F8C8DC;
            color: #2D2D2D;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #E8B4FF;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn.secondary {
            background: #6c757d;
            color: white;
        }
        .btn.secondary:hover {
            background: #5a6268;
        }
        .btn.danger {
            background: #dc3545;
            color: white;
        }
        .btn.danger:hover {
            background: #c82333;
        }
        .stores-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .stores-table th, .stores-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .stores-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2D2D2D;
        }
        .stores-table tr:hover {
            background: #f8f9fa;
        }
        .coordinate-display {
            font-family: monospace;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #28a745; }
        .status-missing { background: #dc3545; }
        .status-partial { background: #ffc107; }
        .log-area {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        .coordinate-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #F8C8DC;
            border-radius: 25px;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .bulk-actions {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #F8C8DC, #E8B4FF);
            width: 0%;
            transition: width 0.3s ease;
        }
        .map-preview {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            border: 2px solid #F8C8DC;
            margin-top: 15px;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ åº—èˆ—ç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>
            <p>ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã—ã¾ã™</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('add-store')">ğŸ“ æ–°åº—èˆ—è¿½åŠ </button>
            <button class="tab" onclick="switchTab('manage-coordinates')">ğŸ—ºï¸ åº§æ¨™ç®¡ç†</button>
            <button class="tab" onclick="switchTab('bulk-operations')">âš™ï¸ ä¸€æ‹¬æ“ä½œ</button>
        </div>
        
        <!-- æ–°åº—èˆ—è¿½åŠ ã‚¿ãƒ– -->
        <div id="add-store" class="tab-content active">
            <h2>æ–°åº—èˆ—ã‚’è¿½åŠ </h2>
            <form id="addStoreForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="storeName">åº—èˆ—å *</label>
                        <input type="text" id="storeName" required>
                    </div>
                    <div class="form-group">
                        <label for="storeCategory">ã‚«ãƒ†ã‚´ãƒª *</label>
                        <select id="storeCategory" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="ã‚«ãƒ•ã‚§">ã‚«ãƒ•ã‚§</option>
                            <option value="æ´‹é£Ÿ">æ´‹é£Ÿ</option>
                            <option value="å’Œé£Ÿ">å’Œé£Ÿ</option>
                            <option value="ã‚¹ã‚¤ãƒ¼ãƒ„">ã‚¹ã‚¤ãƒ¼ãƒ„</option>
                            <option value="ãƒ™ãƒ¼ã‚«ãƒªãƒ¼">ãƒ™ãƒ¼ã‚«ãƒªãƒ¼</option>
                            <option value="è²©å£²åº—">è²©å£²åº—</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="storeAddress">ä½æ‰€ *</label>
                    <input type="text" id="storeAddress" placeholder="ä¾‹: æ±äº¬éƒ½æ¸‹è°·åŒºç¥å—1-1-1" required>
                    <button type="button" class="btn" onclick="geocodeAddress()" style="margin-top: 10px;">
                        ğŸ“ ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’è‡ªå‹•å–å¾—
                    </button>
                </div>
                
                <div class="coordinate-form" id="coordinateForm" style="display: none;">
                    <h4>ğŸ“ åº§æ¨™æƒ…å ±</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="storeLatitude">ç·¯åº¦</label>
                            <input type="number" id="storeLatitude" step="0.0001" readonly>
                        </div>
                        <div class="form-group">
                            <label for="storeLongitude">çµŒåº¦</label>
                            <input type="number" id="storeLongitude" step="0.0001" readonly>
                        </div>
                    </div>
                    <div id="mapPreview" class="map-preview"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="storeHours">å–¶æ¥­æ™‚é–“</label>
                        <input type="text" id="storeHours" placeholder="ä¾‹: 10:00-18:00">
                    </div>
                    <div class="form-group">
                        <label for="storeClosed">å®šä¼‘æ—¥</label>
                        <input type="text" id="storeClosed" placeholder="ä¾‹: æœˆæ›œæ—¥">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="storeDescription">èª¬æ˜</label>
                    <textarea id="storeDescription" rows="3" placeholder="åº—èˆ—ã®ç‰¹å¾´ã‚„ãŠã™ã™ã‚æƒ…å ±"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="storeWebsite">ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</label>
                        <input type="url" id="storeWebsite" placeholder="https://">
                    </div>
                    <div class="form-group">
                        <label for="storeInstagram">Instagram</label>
                        <input type="url" id="storeInstagram" placeholder="https://instagram.com/">
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h4>ğŸ“¸ åº—èˆ—ç”»åƒï¼ˆæœ€å¤§3æšï¼‰</h4>
                    <div class="form-group">
                        <label for="imageUrl1">ç”»åƒ1 URL</label>
                        <input type="url" id="imageUrl1" placeholder="https://example.com/image1.jpg">
                    </div>
                    <div class="form-group">
                        <label for="imageUrl2">ç”»åƒ2 URL</label>
                        <input type="url" id="imageUrl2" placeholder="https://example.com/image2.jpg">
                    </div>
                    <div class="form-group">
                        <label for="imageUrl3">ç”»åƒ3 URL</label>
                        <input type="url" id="imageUrl3" placeholder="https://example.com/image3.jpg">
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn">âœ¨ åº—èˆ—ã‚’è¿½åŠ </button>
                    <button type="button" class="btn secondary" onclick="resetForm()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </form>
        </div>
        
        <!-- åº§æ¨™ç®¡ç†ã‚¿ãƒ– -->
        <div id="manage-coordinates" class="tab-content">
            <h2>åº—èˆ—åº§æ¨™ç®¡ç†</h2>
            <input type="text" class="search-box" id="storeSearch" placeholder="ğŸ” åº—èˆ—åã§æ¤œç´¢..." onkeyup="filterStores()">
            
            <div class="bulk-actions">
                <strong>ä¸€æ‹¬æ“ä½œ:</strong>
                <button class="btn" onclick="autoGeocodeAll()">ğŸ“ å…¨åº—èˆ—ã®åº§æ¨™ã‚’è‡ªå‹•å–å¾—</button>
                <button class="btn secondary" onclick="exportCoordinates()">ğŸ“‹ åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <div class="progress-bar" id="bulkProgress" style="display: none;">
                    <div class="progress-fill" id="bulkProgressFill"></div>
                </div>
            </div>
            
            <div id="storesTableContainer">
                <table class="stores-table" id="storesTable">
                    <thead>
                        <tr>
                            <th>çŠ¶æ…‹</th>
                            <th>åº—èˆ—å</th>
                            <th>ä½æ‰€</th>
                            <th>åº§æ¨™</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="storesTableBody">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ä¸€æ‹¬æ“ä½œã‚¿ãƒ– -->
        <div id="bulk-operations" class="tab-content">
            <h2>ä¸€æ‹¬æ“ä½œ</h2>
            
            <div class="bulk-actions">
                <h3>ğŸ“Š çµ±è¨ˆæƒ…å ±</h3>
                <div id="statsDisplay">
                    <!-- çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º -->
                </div>
            </div>
            
            <div class="bulk-actions">
                <h3>ğŸ”§ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ“ä½œ</h3>
                <button class="btn" onclick="validateAllCoordinates()">âœ… å…¨åº§æ¨™ã‚’æ¤œè¨¼</button>
                <button class="btn" onclick="fixDuplicateCoordinates()">ğŸ”„ é‡è¤‡åº§æ¨™ã‚’ä¿®æ­£</button>
                <button class="btn secondary" onclick="backupDatabase()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
            </div>
            
            <div class="log-area" id="operationLog" style="display: none;">
                <!-- æ“ä½œãƒ­ã‚° -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://lywfaolwvkewuouvkzlk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5d2Zhb2x3dmtld3VvdXZremxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDg2NjcsImV4cCI6MjA2OTk4NDY2N30.wBGCHOLbP6ew7Bnvxrq0sKSm1EnHk5NNE1sWWH7ff60';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let stores = [];
        let previewMap = null;
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // åº§æ¨™ç®¡ç†ã‚¿ãƒ–ãŒé–‹ã‹ã‚ŒãŸæ™‚ã«åº—èˆ—ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
            if (tabName === 'manage-coordinates') {
                loadStores();
            } else if (tabName === 'bulk-operations') {
                loadStats();
            }
        }
        
        // ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’å–å¾—ï¼ˆNominatim APIä½¿ç”¨ï¼‰
        async function geocodeAddress() {
            const address = document.getElementById('storeAddress').value;
            if (!address) {
                alert('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                log('ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’å–å¾—ä¸­: ' + address);
                
                // Nominatim APIï¼ˆOpenStreetMapï¼‰ã‚’ä½¿ç”¨
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ' Japan')}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    document.getElementById('storeLatitude').value = lat;
                    document.getElementById('storeLongitude').value = lng;
                    
                    // åº§æ¨™ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                    document.getElementById('coordinateForm').style.display = 'block';
                    
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
                    showPreviewMap(lat, lng);
                    
                    log(`âœ… åº§æ¨™å–å¾—æˆåŠŸ: [${lat}, ${lng}]`);
                } else {
                    alert('ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    log('âŒ åº§æ¨™å–å¾—å¤±æ•—: ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                alert('åº§æ¨™å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                log('âŒ åº§æ¨™å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
        function showPreviewMap(lat, lng) {
            const mapContainer = document.getElementById('mapPreview');
            
            // æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚’å‰Šé™¤
            if (previewMap) {
                previewMap.remove();
            }
            
            // æ–°ã—ã„ãƒãƒƒãƒ—ã‚’ä½œæˆ
            previewMap = L.map('mapPreview').setView([lat, lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(previewMap);
            
            // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            L.marker([lat, lng]).addTo(previewMap)
                .bindPopup('æ–°åº—èˆ—ã®ä½ç½®')
                .openPopup();
        }
        
        // æ–°åº—èˆ—è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('addStoreForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('storeName').value,
                category: document.getElementById('storeCategory').value,
                address: document.getElementById('storeAddress').value,
                latitude: document.getElementById('storeLatitude').value || null,
                longitude: document.getElementById('storeLongitude').value || null,
                hours: document.getElementById('storeHours').value || null,
                closed: document.getElementById('storeClosed').value || null,
                description: document.getElementById('storeDescription').value || null,
                website: document.getElementById('storeWebsite').value || null,
                instagram: document.getElementById('storeInstagram').value || null,
                imageUrl: document.getElementById('imageUrl1').value || null,
                imageUrl2: document.getElementById('imageUrl2').value || null,
                imageUrl3: document.getElementById('imageUrl3').value || null
            };
            
            try {
                log('æ–°åº—èˆ—ã‚’è¿½åŠ ä¸­: ' + formData.name);
                
                const { data, error } = await supabase
                    .from('stores')
                    .insert([formData])
                    .select();
                
                if (error) throw error;
                
                alert('åº—èˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
                log('âœ… åº—èˆ—è¿½åŠ æˆåŠŸ: ' + formData.name);
                resetForm();
            } catch (error) {
                console.error('Store addition error:', error);
                alert('åº—èˆ—è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                log('âŒ åº—èˆ—è¿½åŠ ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        });
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetForm() {
            document.getElementById('addStoreForm').reset();
            document.getElementById('coordinateForm').style.display = 'none';
            
            if (previewMap) {
                previewMap.remove();
                previewMap = null;
            }
        }
        
        // åº—èˆ—ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadStores() {
            try {
                log('åº—èˆ—ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                
                const { data, error } = await supabase
                    .from('stores')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                
                stores = data;
                displayStores(stores);
                log(`âœ… ${stores.length}ä»¶ã®åº—èˆ—ã‚’èª­ã¿è¾¼ã¿å®Œäº†`);
            } catch (error) {
                console.error('Load stores error:', error);
                log('âŒ åº—èˆ—èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        // åº—èˆ—ä¸€è¦§ã‚’è¡¨ç¤º
        function displayStores(storesToShow) {
            const tbody = document.getElementById('storesTableBody');
            tbody.innerHTML = '';
            
            storesToShow.forEach(store => {
                const row = document.createElement('tr');
                
                // åº§æ¨™ã®çŠ¶æ…‹ã‚’åˆ¤å®š
                const hasCoordinates = store.latitude && store.longitude;
                const statusClass = hasCoordinates ? 'status-ok' : 'status-missing';
                const statusText = hasCoordinates ? 'å®Œäº†' : 'æœªè¨­å®š';
                
                row.innerHTML = `
                    <td><span class="status-indicator ${statusClass}"></span>${statusText}</td>
                    <td><strong>${store.name}</strong><br><small>${store.category || 'æœªåˆ†é¡'}</small></td>
                    <td>${store.address || 'ä½æ‰€æœªè¨­å®š'}</td>
                    <td class="coordinate-display">
                        ${hasCoordinates ? `${store.latitude}, ${store.longitude}` : 'æœªè¨­å®š'}
                    </td>
                    <td>
                        <button class="btn" onclick="editStoreCoordinates(${store.id})" style="font-size: 12px; padding: 6px 12px;">ç·¨é›†</button>
                        ${!hasCoordinates ? `<button class="btn" onclick="geocodeStore(${store.id})" style="font-size: 12px; padding: 6px 12px;">è‡ªå‹•å–å¾—</button>` : ''}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // åº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterStores() {
            const searchTerm = document.getElementById('storeSearch').value.toLowerCase();
            const filteredStores = stores.filter(store => 
                store.name.toLowerCase().includes(searchTerm) ||
                (store.address && store.address.toLowerCase().includes(searchTerm))
            );
            displayStores(filteredStores);
        }
        
        // å€‹åˆ¥åº—èˆ—ã®åº§æ¨™ã‚’è‡ªå‹•å–å¾—
        async function geocodeStore(storeId) {
            const store = stores.find(s => s.id === storeId);
            if (!store || !store.address) {
                alert('ä½æ‰€ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            try {
                log(`åº§æ¨™è‡ªå‹•å–å¾—: ${store.name}`);
                
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(store.address + ' Japan')}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    const { error } = await supabase
                        .from('stores')
                        .update({ latitude: lat, longitude: lng })
                        .eq('id', storeId);
                    
                    if (error) throw error;
                    
                    log(`âœ… ${store.name}ã®åº§æ¨™ã‚’æ›´æ–°: [${lat}, ${lng}]`);
                    loadStores(); // ä¸€è¦§ã‚’æ›´æ–°
                } else {
                    log(`âŒ ${store.name}: åº§æ¨™å–å¾—å¤±æ•—`);
                    alert('ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
            } catch (error) {
                console.error('Geocode error:', error);
                log(`âŒ ${store.name}: ã‚¨ãƒ©ãƒ¼ - ${error.message}`);
            }
        }
        
        // çµ±è¨ˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿
        async function loadStats() {
            try {
                const { data, error } = await supabase
                    .from('stores')
                    .select('latitude, longitude, category');
                
                if (error) throw error;
                
                const total = data.length;
                const withCoordinates = data.filter(s => s.latitude && s.longitude).length;
                const withoutCoordinates = total - withCoordinates;
                
                const categoryStats = {};
                data.forEach(store => {
                    const category = store.category || 'æœªåˆ†é¡';
                    categoryStats[category] = (categoryStats[category] || 0) + 1;
                });
                
                let statsHtml = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                        <div style="text-align: center; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #2D2D2D;">${total}</div>
                            <div>ç·åº—èˆ—æ•°</div>
                        </div>
                        <div style="text-align: center; background: #d4edda; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #155724;">${withCoordinates}</div>
                            <div>åº§æ¨™è¨­å®šæ¸ˆã¿</div>
                        </div>
                        <div style="text-align: center; background: #f8d7da; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #721c24;">${withoutCoordinates}</div>
                            <div>åº§æ¨™æœªè¨­å®š</div>
                        </div>
                    </div>
                    <h4>ã‚«ãƒ†ã‚´ãƒªåˆ¥çµ±è¨ˆ</h4>
                    <ul>
                `;
                
                Object.entries(categoryStats).forEach(([category, count]) => {
                    statsHtml += `<li>${category}: ${count}ä»¶</li>`;
                });
                
                statsHtml += '</ul>';
                
                document.getElementById('statsDisplay').innerHTML = statsHtml;
            } catch (error) {
                console.error('Stats error:', error);
                log('âŒ çµ±è¨ˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        // ãƒ­ã‚°å‡ºåŠ›
        function log(message) {
            console.log(message);
            const logArea = document.getElementById('operationLog');
            if (logArea) {
                const timestamp = new Date().toLocaleTimeString();
                logArea.textContent += `[${timestamp}] ${message}\n`;
                logArea.style.display = 'block';
                logArea.scrollTop = logArea.scrollHeight;
            }
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('åº—èˆ—ç®¡ç†ãƒ„ãƒ¼ãƒ«ã‚’åˆæœŸåŒ–ä¸­...');
        });
    </script>
</body>
</html>