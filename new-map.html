<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
    <title>ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ— - nacoã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</title>
    <link rel="icon" href="favicon.png" type="image/png">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CL6YY713PG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-CL6YY713PG');
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Comfortaa:wght@300;400;700&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ -->
    <script src="security-utils.js"></script>
    <!-- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° -->
    <script src="error-handler.js"></script>
    <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç®¡ç† -->
    <script src="performance-manager.js"></script>
    <!-- ä½ç½®æƒ…å ±ã‚µãƒ¼ãƒ“ã‚¹ -->
    <script src="location-service.js"></script>
    
    <style>
        :root {
            /* å‰å›ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã«è¿‘ã„ãƒ‘ã‚¹ãƒ†ãƒ«ã‚«ãƒ©ãƒ¼ */
            --primary-pink: #FFB6C1;      /* ã‚ˆã‚Šé®®ã‚„ã‹ãªãƒ”ãƒ³ã‚¯ */
            --secondary-mint: #98D8C8;    /* ãƒŸãƒ³ãƒˆã‚°ãƒªãƒ¼ãƒ³ */
            --accent-lavender: #DDA0DD;   /* ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼ */
            --accent-peach: #FFDAB9;      /* ãƒ”ãƒ¼ãƒãƒ—ãƒ« */
            --accent-sky: #B0E0E6;        /* ãƒ‘ã‚¦ãƒ€ãƒ¼ãƒ–ãƒ«ãƒ¼ */
            --accent-yellow: #F0E68C;     /* ã‚«ãƒ¼ã‚­ */
            
            /* ãƒ™ãƒ¼ã‚¹ã‚«ãƒ©ãƒ¼ */
            --white: #ffffff;
            --cream: #FFF8F5;             /* ã‚¯ãƒªãƒ¼ãƒ  */
            --light-gray: #F0F8FF;        /* ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼ã‚°ãƒ¬ãƒ¼ */
            --text-dark: #4A4A4A;         /* ã‚½ãƒ•ãƒˆã‚°ãƒ¬ãƒ¼ */
            --text-light: #8A8A8A;
            
            /* ã‚·ãƒ£ãƒ‰ã‚¦ */
            --shadow-soft: rgba(255, 182, 193, 0.3);
            --shadow-medium: rgba(255, 182, 193, 0.4);
            --shadow-strong: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #FFF 50%, var(--accent-sky) 100%);
            color: var(--text-dark);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--secondary-mint) 60%, var(--accent-peach) 100%);
            color: var(--text-dark);
            padding: 1.2rem;
            box-shadow: 0 4px 20px var(--shadow-soft);
            position: relative;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-family: 'Comfortaa', 'Noto Sans JP', sans-serif;
            font-size: 1.6rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            color: #3D3D3D;
            text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.6);
            letter-spacing: 0.3px;
            line-height: 1.2;
        }
        
        .logo-text {
            color: #2D2D2D;
            font-weight: 600;
            position: relative;
            text-shadow: 0.5px 0.5px 2px rgba(255, 255, 255, 0.7);
            font-size: 1rem;
        }
        
        .logo-text::after {
            content: 'âœ¨';
            position: absolute;
            top: -6px;
            right: -12px;
            font-size: 0.9rem;
            color: var(--accent-lavender);
            animation: sparkle 3s ease-in-out infinite;
            opacity: 0.8;
        }
        
        /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes gradient-shift {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }
        
        /* ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes sparkle {
            0%, 100% {
                opacity: 0.7;
                transform: scale(1) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.2) rotate(180deg);
            }
        }

        .naco-character {
            width: 52px;
            height: 52px;
            background-image: url('naco-character.png.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-right: 0.6rem;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(255, 182, 193, 0.5);
            animation: gentle-float 4s ease-in-out infinite;
            border: 2px solid rgba(255, 255, 255, 0.6);
        }

        /* nacoã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ãƒ›ãƒãƒ¼æ™‚ã®åå¿œã‚’è¿½åŠ  */
        .naco-character:hover {
            animation-duration: 1.5s; /* ãƒ›ãƒãƒ¼æ™‚ã¯å°‘ã—æ—©ã */
            cursor: pointer;
            transform: scale(1.05);
        }

        /* nacoã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å„ªã—ã„æµ®éŠã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes gentle-float {
            0%, 100% {
                transform: translateY(0px);
                box-shadow: 0 3px 12px rgba(255, 182, 193, 0.4);
            }
            50% {
                transform: translateY(-6px);
                box-shadow: 0 8px 20px rgba(255, 182, 193, 0.5);
            }
        }
        
        .logo i {
            font-size: 1.8rem;
            color: var(--secondary-mint);
        }

        .community-badge {
            font-family: 'Kalam', 'Noto Sans JP', cursive;
            background: var(--white);
            color: var(--primary-pink);
            padding: 0.4rem 1rem;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 400;
            margin-left: 1rem;
            box-shadow: 0 3px 15px var(--shadow-soft);
            border: 2px solid var(--primary-pink);
            position: relative;
            overflow: hidden;
        }
        
        .community-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: badge-shine 3s ease-in-out infinite;
        }
        
        @keyframes badge-shine {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .auth-btn {
            background: var(--white);
            border: 2px solid var(--primary-pink);
            color: var(--primary-pink);
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auth-btn:hover {
            background: var(--primary-pink);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--shadow-medium);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-mint);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 500;
            box-shadow: 0 2px 10px var(--shadow-soft);
        }


        /* Main Container */
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
            max-width: 1200px;
            margin: 0 auto;
            gap: 1rem;
            padding: 1rem;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 8px 30px var(--shadow-soft);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px); /* ã‚ˆã‚Šå¤šãã®é«˜ã•ã‚’ç¢ºä¿ */
        }

        .search-header, .sidebar-header {
            background: linear-gradient(135deg, var(--accent-peach) 0%, var(--secondary-mint) 100%);
            padding: 1rem;
            text-align: center;
        }

        .search-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 0.6rem;
        }
        
        .mobile-title {
            display: none;
        }
        
        .desktop-title {
            display: inline;
        }

        .search-box {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            background: var(--white);
            box-shadow: inset 0 1px 8px var(--shadow-soft);
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            box-shadow: inset 0 2px 10px var(--shadow-medium), 0 0 0 3px var(--primary-pink);
        }

        .search-box::placeholder {
            color: var(--text-light);
        }

        /* Compact Sidebar Stats */
        .sidebar-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 0.5rem;
            padding: 0.5rem 0.8rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }

        .sidebar-stat-item {
            text-align: center;
            flex: 1;
        }

        .sidebar-stat-number {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-pink);
            margin-bottom: 0.1rem;
        }

        .sidebar-stat-label {
            font-size: 0.65rem;
            color: var(--text-light);
            font-weight: 400;
            line-height: 1;
        }

        .filters {
            padding: 0.6rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.3rem;
        }

        .filter-btn {
            background: var(--light-gray);
            border: none;
            color: var(--text-dark);
            padding: 0.4rem 0.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 400;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.2rem;
            white-space: nowrap;
        }
        
        .filter-btn i {
            font-size: 0.8rem;
        }

        .filter-btn.active {
            color: var(--white);
            transform: scale(1.05);
            box-shadow: 0 4px 15px var(--shadow-medium);
        }

        /* ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®æ´—ç·´ã•ã‚ŒãŸã‚«ãƒ©ãƒ¼ */
        .filter-btn[data-category="all"].active {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-lavender) 100%);
            box-shadow: 0 4px 15px rgba(255, 182, 193, 0.4);
        }

        .filter-btn[data-category="å’Œé£Ÿ"].active {
            background: linear-gradient(135deg, #ffffff 0%, #E67E22 100%);
            box-shadow: 0 4px 15px rgba(230, 126, 34, 0.4);
            border: 1px solid #E67E22;
        }

        .filter-btn[data-category="æ´‹é£Ÿ"].active {
            background: linear-gradient(135deg, #ffffff 0%, #27AE60 100%);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            border: 1px solid #27AE60;
        }

        .filter-btn[data-category="ã‚«ãƒ•ã‚§"].active {
            background: linear-gradient(135deg, #ffffff 0%, #8B4513 100%);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.4);
            border: 1px solid #8B4513;
        }

        .filter-btn[data-category="ã‚¹ã‚¤ãƒ¼ãƒ„"].active {
            background: linear-gradient(135deg, #ffffff 0%, #E91E63 100%);
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
            border: 1px solid #E91E63;
        }

        .filter-btn[data-category="ãƒ‘ãƒ³å±‹"].active {
            background: linear-gradient(135deg, #ffffff 0%, #8E44AD 100%);
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.4);
            border: 1px solid #8E44AD;
        }

        .filter-btn[data-category="è²©å£²åº—"].active {
            background: linear-gradient(135deg, #ffffff 0%, #FFD700 100%);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            border: 1px solid #FFD700;
        }

        .filter-btn:hover:not(.active) {
            background: var(--accent-sky);
            transform: translateY(-1px);
        }

        /* Store List */
        .store-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
            scrollbar-width: thin;
            scrollbar-color: var(--primary-pink) transparent;
        }
        
        .store-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .store-list::-webkit-scrollbar-track {
            background: rgba(255, 182, 193, 0.1);
            border-radius: 4px;
        }
        
        .store-list::-webkit-scrollbar-thumb {
            background: var(--primary-pink);
            border-radius: 4px;
            opacity: 0.7;
        }
        
        .store-list::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-mint);
            opacity: 1;
        }

        .store-item {
            background: linear-gradient(135deg, var(--white) 0%, var(--cream) 100%);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 0.8rem; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å°‘ã—ç¸®å° */
            margin-bottom: 0.5rem; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ç¸®å°ã—ã¦ã‚ˆã‚Šå¤šãè¡¨ç¤º */
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 3px 15px var(--shadow-soft);
        }

        .store-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--shadow-medium);
            border-color: var(--primary-pink);
        }

        .store-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.4rem; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ç¸®å° */
        }

        .store-name {
            font-weight: 600;
            font-size: 1.0rem; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°‘ã—ç¸®å° */
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            line-height: 1.2; /* è¡Œé–“ã‚’èª¿æ•´ */
        }

        .store-distance {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
            color: var(--primary-pink);
            font-weight: 500;
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.1), rgba(255, 192, 203, 0.2));
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 182, 193, 0.3);
            white-space: nowrap;
            min-width: fit-content;
        }

        .store-distance i {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* æ–°ã—ã„åº—èˆ—ã‚«ãƒ†ã‚´ãƒªãƒ‡ã‚¶ã‚¤ãƒ³ */
        .store-category-wrapper {
            margin-bottom: 0.6rem; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ç¸®å° */
        }

        .store-category-new {
            display: inline-block;
            color: white;
            padding: 4px 10px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç¸®å° */
            border-radius: 16px;
            font-size: 0.75rem; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2); /* ãƒœãƒ¼ãƒ€ãƒ¼ã‚’ç·šç´°ã« */
        }

        /* åº—èˆ—åã®ã‚¹ã‚¿ã‚¤ãƒ«æ”¹å–„ */
        .store-name .name-text {
            margin-left: 0.3rem;
        }

        /* æ–°ã—ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .store-actions-new {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px; /* ã‚®ãƒ£ãƒƒãƒ—ã‚’ç¸®å° */
            margin-top: 0.8rem; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ç¸®å° */
        }

        .action-btn-new {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            border: none;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 60px;
        }

        .action-btn-new i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .action-btn-new span {
            line-height: 1;
        }

        /* è©³ç´°ãƒœã‚¿ãƒ³ï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒªï¼‰ */
        .action-btn-primary {
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            box-shadow: 0 3px 8px rgba(74, 144, 226, 0.2);
        }

        .action-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
            background: linear-gradient(135deg, #5A9EF0 0%, #4585C8 100%);
        }

        /* åœ°å›³ãƒœã‚¿ãƒ³ï¼ˆã‚»ã‚«ãƒ³ãƒ€ãƒªï¼‰ */
        .action-btn-secondary {
            background: linear-gradient(135deg, #6C7B7F 0%, #546E7A 100%);
            color: white;
            box-shadow: 0 3px 8px rgba(108, 123, 127, 0.2);
        }

        .action-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 123, 127, 0.3);
            background: linear-gradient(135deg, #7C8B8F 0%, #647E8A 100%);
        }

        /* ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼‰ */
        .action-btn-accent {
            background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%);
            color: white;
            box-shadow: 0 3px 8px rgba(233, 30, 99, 0.2);
        }

        .action-btn-accent:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.3);
            background: linear-gradient(135deg, #F12E73 0%, #D2286B 100%);
        }

        .store-category {
            display: inline-block;
            background: var(--accent-mint);
            color: var(--white);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.8rem;
        }

        .store-category.å’Œé£Ÿ { background: linear-gradient(45deg, #FFB6C1, #FFC0CB); }
        .store-category.æ´‹é£Ÿ { background: linear-gradient(45deg, #27AE60, #2ECC71); }
        .store-category.ã‚«ãƒ•ã‚§ { background: linear-gradient(45deg, #8B4513, #A0522D); }
        .store-category.ãƒ‘ãƒ³å±‹ { background: linear-gradient(45deg, #8E44AD, #9B59B6); }
        .store-category.ã‚¹ã‚¤ãƒ¼ãƒ„ { background: linear-gradient(45deg, #FFE4E1, #FFF0F5); }
        .store-category.è²©å£²åº— { background: linear-gradient(45deg, #98D8C8, #B0E0E6); }
        .store-category.ãã®ä»– { background: linear-gradient(45deg, #98D8C8, #B0E0E6); }

        .store-address {
            color: var(--text-light);
            font-size: 0.85rem; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ç¸®å° */
            margin-bottom: 0.6rem; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ç¸®å° */
            display: flex;
            align-items: center;
            gap: 0.5rem;
            line-height: 1.3; /* è¡Œé–“ã‚’èª¿æ•´ */
        }

        .store-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: space-between;
        }

        .action-btn {
            background: var(--white);
            border: 1px solid var(--primary-pink);
            color: var(--primary-pink);
            padding: 0.5rem 0.8rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .action-btn:hover {
            background: var(--primary-pink);
            color: var(--white);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px var(--shadow-medium);
        }

        .no-stores {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
            font-style: italic;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 8px 30px var(--shadow-soft);
            overflow: hidden;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 20px;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--cream) 0%, var(--white) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 1.2rem;
            color: var(--text-dark);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-gray);
            border-left: 4px solid var(--primary-pink);
            border-right: 4px solid var(--secondary-mint);
            border-radius: 50%;
            animation: gentle-spin 2s ease-in-out infinite;
            margin-bottom: 1rem;
        }

        @keyframes gentle-spin {
            0% { 
                transform: rotate(0deg) scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: rotate(180deg) scale(1.05);
                opacity: 1;
            }
            100% { 
                transform: rotate(360deg) scale(1);
                opacity: 0.8;
            }
        }

        .loading-overlay.hidden {
            display: none;
        }

        /* Modal Styles - Enhanced */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--white) 0%, var(--cream) 100%);
            padding: 0;
            border-radius: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.4),
                0 8px 24px rgba(255, 182, 193, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.6);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .modal.show .modal-content {
            transform: scale(1) translateY(0);
        }

        .store-detail-modal {
            max-width: 650px;
            width: 95%;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœãƒ‡ã‚£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            max-height: calc(85vh - 140px); /* ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ã‚’é™¤ã */
        }
        
        .store-images-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 12px;
            margin-bottom: 2rem;
            height: 280px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .main-image {
            grid-row: span 2;
            position: relative;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(135deg, var(--light-gray) 0%, #f8f9fa 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .main-image:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 182, 193, 0.3);
        }
        
        .main-image:hover img {
            transform: scale(1.05);
        }

        .secondary-images {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .secondary-image {
            height: 120px;
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .secondary-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .secondary-image:hover img {
            transform: scale(1.05);
        }

        .image-placeholder {
            color: #adb5bd;
            font-size: 14px;
            text-align: center;
        }

        /* Lightbox Styles */
        .lightbox-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .lightbox-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .lightbox-close {
            position: absolute;
            top: -50px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 40px;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }

        .lightbox-close:hover {
            opacity: 0.7;
        }

        .lightbox-navigation {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }

        .lightbox-prev, .lightbox-next {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 30px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
            pointer-events: auto;
            margin: 0 20px;
        }

        .lightbox-prev:hover, .lightbox-next:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .lightbox-counter {
            color: white;
            margin-top: 20px;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
        }

        .store-detail-info {
            margin-top: 1rem;
        }

        .store-detail-section {
            background: rgba(255, 255, 255, 0.5);
            padding: 1.2rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 182, 193, 0.2);
            transition: all 0.3s ease;
        }
        
        .store-detail-section:hover {
            background: rgba(255, 255, 255, 0.7);
            border-color: rgba(255, 182, 193, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 182, 193, 0.2);
        }

        .store-detail-section h4 {
            color: var(--primary-pink);
            margin-bottom: 0.8rem;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .store-detail-section h4 i {
            color: var(--secondary-mint);
            width: 18px;
            text-align: center;
        }

        .store-detail-section p {
            color: var(--text-dark);
            line-height: 1.6;
            margin: 0;
            font-size: 0.95rem;
        }

        .store-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid rgba(255, 182, 193, 0.2);
        }

        .store-action-btn {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--secondary-mint) 100%);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 3px 12px rgba(255, 182, 193, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .store-action-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 20px rgba(255, 182, 193, 0.4);
            background: linear-gradient(135deg, var(--secondary-mint) 0%, var(--primary-pink) 100%);
        }
        
        .store-action-btn i {
            font-size: 1rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 2rem 2rem 1rem 2rem;
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--secondary-mint) 100%);
            border-radius: 24px 24px 0 0;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="30" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="70" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
            pointer-events: none;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
            margin-right: 1rem;
        }
        
        .modal-store-name {
            font-family: 'Comfortaa', 'Noto Sans JP', sans-serif;
            letter-spacing: 0.5px;
        }
        
        .modal-category-badge {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.3);
            display: inline-block;
            width: fit-content;
        }

        .close-btn {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            font-size: 1.6rem;
            cursor: pointer;
            color: white;
            padding: 0;
            line-height: 1;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-weight: 300;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: rotate(90deg) scale(1.1);
            border-color: rgba(255,255,255,0.5);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--cream);
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-pink);
            background: var(--white);
            box-shadow: 0 0 0 3px var(--shadow-soft);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-pink);
        }

        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-lavender) 100%);
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--light-gray);
            color: var(--text-dark);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            margin-left: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--accent-sky);
            transform: translateY(-1px);
        }

        /* Message Styles */
        .error-message {
            color: #e74c3c;
            background: linear-gradient(135deg, #fdf2f2 0%, #fbeaea 100%);
            border: 1px solid #f5c6cb;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .success-message {
            color: #27ae60;
            background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e8 100%);
            border: 1px solid #c3e6cb;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Responsive Design - Mobile First */
        @media (max-width: 768px) {
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
            .header {
                padding: 0.5rem;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1001;
            }
            
            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 0.5rem;
            }
            
            .logo {
                font-size: 1.1rem;
                gap: 0.4rem;
                font-weight: 500;
            }
            
            .logo-text {
                display: none; /* ã‚¿ã‚¤ãƒˆãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’éè¡¨ç¤º */
            }
            
            .naco-character {
                width: 36px;
                height: 36px;
                margin-right: 0.3rem;
            }
            
            .community-badge {
                display: none; /* ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒƒã‚¸ã‚’éè¡¨ç¤º */
            }
            
            /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã®èª¿æ•´ - ãƒãƒƒãƒ—ä¸­å¿ƒãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
            .main-container {
                flex-direction: column; /* é€šå¸¸é †åºï¼šãƒãƒƒãƒ—ãŒä¸Šã€ãƒªã‚¹ãƒˆãŒä¸‹ */
                height: 100vh;
                padding: 0;
                gap: 0;
                margin-top: 0; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¯fixed positionã®ãŸã‚ä¸è¦ */
                padding-top: 50px; /* ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ã®å†…å´ä½™ç™½ */
                box-sizing: border-box;
            }
            
            /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ‡ã‚¶ã‚¤ãƒ³ */
            .sidebar {
                width: 100%;
                height: calc(30vh - 15px); /* 30% - paddingèª¿æ•´ */
                min-height: calc(30vh - 15px);
                max-height: calc(30vh - 15px);
                order: 2; /* ãƒãƒƒãƒ—ã®ä¸‹ã«é…ç½® */
                position: relative;
                transition: all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
                display: flex;
                flex-direction: column;
                border-top: 3px solid rgba(255, 182, 193, 0.3);
                border-radius: 20px 20px 0 0;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
                z-index: 1000;
            }
            
            /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ã« */
            .sidebar.collapsed {
                height: 60px;
                min-height: 60px;
                max-height: 60px;
            }
            
            /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒƒãƒ—ã§å…¨ç”»é¢è¡¨ç¤º - æ»‘ã‚‰ã‹ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ã */
            .sidebar.expanded {
                height: 80vh !important;
                max-height: 80vh !important;
                min-height: 80vh !important;
                position: fixed;
                top: 50px;
                left: 0;
                right: 0;
                z-index: 2000;
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
                transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                transform: translateY(0);
            }
            
            .sidebar.expanded .store-list {
                max-height: 60vh !important;
                min-height: 300px;
            }
            
            .sidebar-header {
                padding: 0.8rem 1rem;
                font-size: 1rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: linear-gradient(135deg, var(--primary-pink) 0%, var(--secondary-mint) 100%);
                border-radius: 12px 12px 0 0;
                transition: all 0.3s ease;
                cursor: pointer;
                user-select: none;
            }
            
            .sidebar-header:hover {
                background: linear-gradient(135deg, #ff9fb3 0%, #7ec7b7 100%);
                transform: translateY(-1px);
                box-shadow: 0 4px 15px rgba(255, 182, 193, 0.4);
            }
            
            .sidebar-header:active {
                transform: translateY(0);
                background: linear-gradient(135deg, #ff8fa8 0%, #6eb5a4 100%);
            }
            
            .sidebar-header::after {
                content: 'â–²'; /* ä¸Šå‘ãçŸ¢å° - é–‹ã„ã¦ã„ã‚‹çŠ¶æ…‹ */
                font-size: 1rem;
                transition: transform 0.3s;
                color: #666;
            }
            
            .sidebar.collapsed .sidebar-header::after {
                content: 'â–¼'; /* ä¸‹å‘ãçŸ¢å° - æŠ˜ã‚ŠãŸãŸã¾ã‚ŒãŸçŠ¶æ…‹ */
                transform: none;
            }
            
            .sidebar.collapsed .sidebar-header {
                background: linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-lavender) 50%);
                cursor: pointer;
                position: relative;
            }
            
            .sidebar.collapsed .sidebar-header::before {
                content: 'è¿‘ãã®åº—èˆ—ã‚’è¡¨ç¤º ğŸ‘†';
                position: absolute;
                right: 35px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 0.8rem;
                color: rgba(255, 255, 255, 0.9);
                pointer-events: none;
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 0.7; }
                50% { opacity: 1; }
            }
            
            .sidebar-stats {
                display: none; /* çµ±è¨ˆæƒ…å ±ã‚’éè¡¨ç¤º */
            }
            
            .sidebar.collapsed .search-section,
            .sidebar.collapsed .filter-grid,
            .sidebar.collapsed .store-list {
                display: none;
            }
            
            /* ãƒ¢ãƒã‚¤ãƒ«ã§ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºåˆ‡æ›¿ */
            .mobile-title {
                display: inline;
            }
            
            .desktop-title {
                display: none;
            }
            
            /* æ¤œç´¢ãƒãƒ¼ã®æœ€é©åŒ– */
            .search-section {
                padding: 1rem;
            }
            
            .search-input {
                font-size: 16px; /* iOSã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */
                padding: 0.8rem 1rem;
                min-height: 44px;
            }
            
            /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã®èª¿æ•´ */
            .filter-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                padding: 0 1rem 1rem;
            }
            
            .filter-btn {
                min-height: 44px;
                font-size: 0.9rem;
                padding: 0.6rem 0.8rem;
            }
            
            /* åº—èˆ—ãƒªã‚¹ãƒˆã®æœ€é©åŒ– - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º */
            .store-list {
                max-height: 18vh; /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«èª¿æ•´ */
                min-height: 120px; /* æœ€å°é«˜ã•ã‚’ç¶­æŒ */
                padding: 0.3rem 1rem 0.5rem;
                overflow-y: auto;
                flex: 1;
            }
            
            .store-item {
                margin-bottom: 0.5rem;
                padding: 0.8rem;
                border-radius: 12px;
                background: rgba(255, 255, 255, 0.8);
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                cursor: pointer;
                transition: all 0.3s ease;
                border-left: 3px solid transparent;
            }
            
            .store-item:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.12);
                border-left: 3px solid var(--primary-pink);
                background: rgba(255, 255, 255, 0.95);
            }
            
            .store-item {
                padding: 1rem;
                margin-bottom: 0.5rem;
            }
            
            .store-name {
                font-size: 1rem;
                line-height: 1.4;
            }
            
            .store-category {
                font-size: 0.85rem;
                padding: 0.3rem 0.6rem;
            }
            
            .store-address {
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            /* ãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠã®èª¿æ•´ - ãƒ¡ã‚¤ãƒ³è¡¨ç¤º */
            .map-container {
                flex: 1;
                height: calc(70vh - 35px); /* 70% - paddingèª¿æ•´ */
                min-height: 350px;
                order: 1; /* ãƒãƒƒãƒ—ã‚’ä¸Šã«é…ç½® */
                position: relative;
                z-index: 1;
            }
            
            
            /* èªè¨¼ãƒœã‚¿ãƒ³ã®æœ€é©åŒ– */
            .auth-btn {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
                min-height: 36px;
                border-radius: 18px;
            }
            
            /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ã®èª¿æ•´ */
            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }
            
            /* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
            .user-info {
                gap: 0.5rem;
            }
            
            /* åº—èˆ—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®èª¿æ•´ */
            .store-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .store-action-btn {
                min-height: 44px;
                font-size: 0.9rem;
                padding: 0.7rem 1rem;
            }
            
            /* è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®èª¿æ•´ */
            .display-mode-controls {
                padding: 0.75rem 1rem;
            }
            
            .display-mode-btn {
                min-height: 40px;
                font-size: 0.85rem;
                padding: 0.6rem 0.8rem;
            }
        }
        
        /* å°å‹ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å‘ã‘ã®è¿½åŠ èª¿æ•´ */
        @media (max-width: 480px) {
            .header {
                padding: 0.4rem;
            }
            
            .naco-character {
                width: 32px;
                height: 32px;
            }
            
            .main-container {
                margin-top: 45px;
            }
            
            .sidebar {
                height: 28vh; /* å°ã•ãªã‚¹ãƒãƒ›ã§ã‚‚ãƒãƒƒãƒ—ã‚’é‡è¦– */
                max-height: 28vh;
                min-height: 28vh;
            }
            
            .sidebar.collapsed {
                height: 50px;
            }
            
            .map-container {
                height: 72vh; /* ã‚ˆã‚Šå¤šãã®é ˜åŸŸã‚’ãƒãƒƒãƒ—ã« */
                min-height: 350px;
            }
            
            .filter-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.3rem;
            }
            
            .filter-btn {
                font-size: 0.8rem;
                padding: 0.5rem;
                min-height: 36px;
            }
            
            .store-list {
                max-height: 25vh;
                min-height: 180px;
            }
            
            .store-item {
                margin-bottom: 0.6rem;
                padding: 0.8rem;
            }
        }

        /* Custom Leaflet Popup Styles */
        .leaflet-popup-content-wrapper {
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 8px 30px var(--shadow-soft);
        }

        .leaflet-popup-content {
            margin: 15px;
        }

        .popup-store-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-pink);
            margin-bottom: 0.5rem;
        }

        .popup-category {
            display: inline-block;
            background: var(--accent-mint);
            color: var(--white);
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .popup-address {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .popup-btn {
            background: var(--primary-pink);
            color: var(--white);
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .popup-btn:hover {
            background: var(--secondary-lavender);
            transform: translateY(-1px);
        }

        /* æ´—ç·´ã•ã‚ŒãŸãƒãƒ¼ã‚«ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .sophisticated-marker-wrapper {
            background: transparent !important;
            border: none !important;
        }

        .sophisticated-marker {
            cursor: pointer !important;
            user-select: none;
            position: relative;
            width: 28px;
            height: 44px;
            transition: transform 0.2s ease;
        }

        .sophisticated-marker:hover {
            transform: scale(1.08);
        }

        .marker-teardrop {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sophisticated-marker:hover .marker-teardrop {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.25), 0 4px 10px rgba(0,0,0,0.15);
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .custom-popup {
            font-family: 'Noto Sans JP', sans-serif;
            line-height: 1.4;
            min-width: 200px;
        }

        .custom-popup h4 {
            font-family: 'Comfortaa', 'Noto Sans JP', sans-serif;
        }

        /* Leaflet popup ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .leaflet-popup-content-wrapper {
            border-radius: 15px !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
            border: 2px solid var(--primary-pink);
        }

        .leaflet-popup-tip {
            background: var(--white) !important;
            border: 2px solid var(--primary-pink);
            border-top: none !important;
            border-right: none !important;
        }

        /* Floating notification */
        .floating-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            font-weight: 500;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .current-location-wrapper {
            background: transparent !important;
            border: none !important;
        }

        .current-location-marker {
            position: relative;
            width: 28px;
            height: 28px;
            cursor: pointer;
        }

        .location-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 50%, #45B7D1 100%);
            border: 4px solid white;
            border-radius: 50%;
            box-shadow: 
                0 0 0 3px rgba(255, 107, 107, 0.3),
                0 0 0 6px rgba(255, 255, 255, 0.8),
                0 6px 20px rgba(255, 107, 107, 0.6),
                0 0 30px rgba(69, 183, 209, 0.4);
            z-index: 1001;
            animation: dotPulse 2.5s ease-in-out infinite;
        }

        .location-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 28px;
            height: 28px;
            background: radial-gradient(circle, rgba(255, 107, 107, 0.6) 0%, rgba(69, 183, 209, 0.3) 50%, rgba(78, 205, 196, 0.2) 70%, transparent 100%);
            border-radius: 50%;
            animation: pulse 2s ease-out infinite;
        }

        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0.9;
            }
            50% {
                transform: translate(-50%, -50%) scale(2.5);
                opacity: 0.5;
            }
            100% {
                transform: translate(-50%, -50%) scale(4.0);
                opacity: 0;
            }
        }

        @keyframes dotPulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                filter: brightness(1);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.15);
                filter: brightness(1.2);
            }
        }

        /* ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ */
        .location-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: var(--white);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            color: var(--primary-pink);
            font-size: 16px;
        }

        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            background: var(--primary-pink);
            color: white;
        }

        .location-btn.loading {
            animation: spin 1s linear infinite;
        }

        /* ãƒ”ãƒ³ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */
        .pin-mode-btn {
            position: absolute;
            top: 10px;
            right: 60px;
            z-index: 1000;
            background: var(--white);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .pin-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            background: #FF6B35;
            color: white;
        }

        .pin-mode-btn.active {
            background: #FF6B35;
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }

        .pin-mode-btn i {
            font-size: 1rem;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }


        /* è·é›¢è¡¨ç¤º */
        .distance-badge {
            display: inline-block;
            background: rgba(66, 133, 244, 0.1);
            color: #4285f4;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        /* æ¤œç´¢åœ°ç‚¹ãƒãƒ¼ã‚«ãƒ¼ */
        .search-location-marker {
            position: relative;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #9b59b6, #e74c3c);
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 0 0 2px rgba(155, 89, 182, 0.3),
                0 4px 15px rgba(155, 89, 182, 0.4);
            animation: searchPulse 3s ease-in-out infinite;
        }

        .search-location-marker i {
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .search-location-wrapper {
            background: transparent !important;
            border: none !important;
        }

        @keyframes searchPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 
                    0 0 0 2px rgba(155, 89, 182, 0.3),
                    0 4px 15px rgba(155, 89, 182, 0.4);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 
                    0 0 0 4px rgba(155, 89, 182, 0.4),
                    0 6px 20px rgba(155, 89, 182, 0.5);
            }
        }

        /* æ¤œç´¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .search-popup h4 {
            margin: 0 0 8px 0;
            color: var(--text-dark);
            font-size: 1.1rem;
        }

        .search-popup .region {
            margin: 4px 0;
            color: var(--primary-pink);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .search-popup .address {
            margin: 4px 0 0 0;
            color: var(--text-light);
            font-size: 0.8rem;
            line-height: 1.3;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ”ãƒ³ãƒãƒ¼ã‚«ãƒ¼ */
        .user-pin-marker {
            position: relative;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #FF6B35 0%, #E55A2B 100%);
            border: 3px solid white;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 0 0 2px rgba(255, 107, 53, 0.3),
                0 4px 15px rgba(255, 107, 53, 0.4);
            animation: userPinPulse 3s ease-in-out infinite;
        }

        .user-pin-marker::before {
            content: '';
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(0deg);
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50% 50% 50% 0;
            border: 2px solid #FF6B35;
        }

        .user-pin-marker::after {
            content: '';
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(0deg);
            width: 10px;
            height: 10px;
            background: #FF6B35;
            border-radius: 50%;
            z-index: 1;
        }

        .user-pin-wrapper {
            background: transparent !important;
            border: none !important;
        }

        @keyframes userPinPulse {
            0%, 100% {
                transform: rotate(-45deg) scale(1);
                box-shadow: 
                    0 0 0 2px rgba(255, 107, 53, 0.3),
                    0 4px 15px rgba(255, 107, 53, 0.4);
            }
            50% {
                transform: rotate(-45deg) scale(1.05);
                box-shadow: 
                    0 0 0 4px rgba(255, 107, 53, 0.4),
                    0 6px 20px rgba(255, 107, 53, 0.5);
            }
        }

        .nearest-badge {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
            animation: sparkle 2s ease-in-out infinite;
        }

        .filter-btn[data-category="nearby"].active {
            background: linear-gradient(135deg, #ffffff 0%, #4285f4 100%);
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4);
            border: 1px solid #4285f4;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div>nacoã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="naco-character"></div>
                <div class="logo-text">ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—</div>
                <span class="community-badge">ãƒ“ãƒ¨ã‚°ãƒ«å€¶æ¥½éƒ¨ presents by naco</span>
            </div>
            <div class="user-info">
                <div id="loginSection" style="display: none;">
                    <button class="auth-btn" onclick="handleLogin()">
                        <i class="fab fa-google"></i>
                        ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                </div>
                <div id="userSection" style="display: none;">
                    <div class="user-avatar" id="userAvatar">N</div>
                    <button class="auth-btn" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </div>
            </div>
        </div>
    </header>


    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="search-title">
                    <i class="fas fa-list"></i>
                    <span class="mobile-title">åº—èˆ—ä¸€è¦§</span>
                    <span class="desktop-title">ãŠåº—ã‚’æ¢ã™</span>
                </div>
                <input type="text" class="search-box" id="searchBox" placeholder="åº—åãƒ»ä½æ‰€ãƒ»é§…åã§æ¤œç´¢... (ä¾‹: æ¸‹è°·é§…ã€å¤§é˜ªåŸ)">
                
                <!-- Stats moved to sidebar -->
                <div class="sidebar-stats">
                    <div class="sidebar-stat-item">
                        <div class="sidebar-stat-number" id="totalStores">-</div>
                        <div class="sidebar-stat-label">ç·åº—èˆ—æ•°</div>
                    </div>
                    <div class="sidebar-stat-item">
                        <div class="sidebar-stat-number" id="visibleStores">-</div>
                        <div class="sidebar-stat-label">è¡¨ç¤ºä¸­</div>
                    </div>
                    <div class="sidebar-stat-item">
                        <div class="sidebar-stat-number" id="reviewCount">-</div>
                        <div class="sidebar-stat-label">ç·ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°</div>
                    </div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-grid">
                    <button class="filter-btn active" data-category="all">
                        <i class="fas fa-th-large"></i> ã™ã¹ã¦
                    </button>
                    <button class="filter-btn" data-category="å’Œé£Ÿ">
                        <i class="fas fa-bowl-rice"></i> å’Œé£Ÿ
                    </button>
                    <button class="filter-btn" data-category="æ´‹é£Ÿ">
                        <i class="fas fa-utensils"></i> æ´‹é£Ÿ
                    </button>
                    <button class="filter-btn" data-category="ã‚«ãƒ•ã‚§">
                        <i class="fas fa-coffee"></i> ã‚«ãƒ•ã‚§
                    </button>
                    <button class="filter-btn" data-category="ãƒ‘ãƒ³å±‹">
                        <i class="fas fa-bread-slice"></i> ãƒ‘ãƒ³å±‹
                    </button>
                    <button class="filter-btn" data-category="ã‚¹ã‚¤ãƒ¼ãƒ„">
                        <i class="fas fa-birthday-cake"></i> ã‚¹ã‚¤ãƒ¼ãƒ„
                    </button>
                    <button class="filter-btn" data-category="è²©å£²åº—">
                        <i class="fas fa-shopping-bag"></i> è²©å£²åº—
                    </button>
                </div>
                
                <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
                <div id="displayModeSection" style="
                    margin-top: 8px; 
                    padding: 8px 6px; 
                    border-top: 1px solid #eee;
                    display: none;
                ">
                    <div style="font-size: 12px; color: #666; margin-bottom: 6px;">
                        <i class="fas fa-eye"></i> è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                        <button class="display-mode-btn active" data-mode="normal" onclick="changeDisplayMode('normal')" style="
                            padding: 6px 8px;
                            border: 1px solid #ddd;
                            border-radius: 12px;
                            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-lavender) 100%);
                            color: white;
                            font-size: 11px;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                        ">
                            <i class="fas fa-home"></i>
                            <span>é€šå¸¸è¡¨ç¤º</span>
                        </button>
                        <button class="display-mode-btn" data-mode="all" onclick="changeDisplayMode('all')" style="
                            padding: 6px 8px;
                            border: 1px solid #ddd;
                            border-radius: 12px;
                            background: white;
                            color: #333;
                            font-size: 11px;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                        ">
                            <i class="fas fa-globe"></i>
                            <span>å…¨è¡¨ç¤º</span>
                        </button>
                        <button class="display-mode-btn" data-mode="want_to_go" onclick="changeDisplayMode('want_to_go')" style="
                            padding: 6px 8px;
                            border: 1px solid #667eea;
                            border-radius: 12px;
                            background: white;
                            color: #667eea;
                            font-size: 11px;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                        ">
                            <i class="fas fa-bookmark"></i>
                            <span>è¡ŒããŸã„</span>
                        </button>
                        <button class="display-mode-btn" data-mode="visited" onclick="changeDisplayMode('visited')" style="
                            padding: 6px 8px;
                            border: 1px solid #48bb78;
                            border-radius: 12px;
                            background: white;
                            color: #48bb78;
                            font-size: 11px;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                        ">
                            <i class="fas fa-check-circle"></i>
                            <span>è¡Œã£ãŸ</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="store-list" id="storeList">
                <!-- Stores will be populated here -->
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            <button class="location-btn" id="locationBtn" onclick="getCurrentLocation()" title="ç¾åœ¨åœ°ã‚’è¡¨ç¤º">
                <i class="fas fa-location-arrow"></i>
            </button>
            <button class="pin-mode-btn" id="pinModeBtn" onclick="togglePinMode()" title="ãƒ”ãƒ³ã‚’ç«‹ã¦ã‚‹">
                <i class="fas fa-map-marker-alt"></i>
            </button>
        </div>
    </div>

    <!-- Store Detail Modal -->
    <div id="storeDetailModal" class="modal">
        <div class="modal-content store-detail-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="storeDetailTitle">åº—èˆ—è©³ç´°</h3>
                <button class="close-btn" onclick="closeStoreDetailModal()">&times;</button>
            </div>
            <div id="storeDetailBody" class="modal-body">
                <!-- Store details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Image Lightbox Modal -->
    <div id="lightboxModal" class="lightbox-modal">
        <div class="lightbox-content">
            <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
            <img id="lightboxImage" class="lightbox-image" src="" alt="">
            <div class="lightbox-navigation">
                <button class="lightbox-prev" onclick="prevImage()">â€¹</button>
                <button class="lightbox-next" onclick="nextImage()">â€º</button>
            </div>
            <div class="lightbox-counter" id="lightboxCounter">1 / 3</div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="reviewModalTitle">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿</h3>
                <button class="close-btn" onclick="closeReviewModal()">&times;</button>
            </div>
            <div id="reviewModalBody">
                <!-- Review form will be populated here -->
            </div>
        </div>
    </div>

    <!-- robots.txt content (for reference) -->
    <!-- 
    User-agent: *
    Disallow: /
    -->

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster plugin for performance -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- Supabase -->
    <!-- Supabase UMD version removed to avoid conflicts with ES module -->
    <script type="module" src="supabase-client.js"></script>

    <script>
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ï¼ˆèªè¨¼ãƒã‚§ãƒƒã‚¯ã¯index.htmlã§å®Œäº†æ¸ˆã¿ï¼‰
        (async function() {
            console.log('ğŸš€ nacoã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒƒãƒ—ç›´æ¥é–‹å§‹ï¼ˆèªè¨¼æ¸ˆã¿ï¼‰');
            
            // Wait for supabase client to be loaded from ES module
            let waitCount = 0;
            const maxWaitTime = 50;
            while (!window.supabase && waitCount < maxWaitTime) {
                console.log(`â³ Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèª­ã¿è¾¼ã¿å¾…ã¡... (${waitCount + 1}/${maxWaitTime})`);
                await new Promise(resolve => setTimeout(resolve, 100));
                waitCount++;
            }
            
            if (!window.supabase) {
                console.error('âŒ Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
                // èªè¨¼ãŒå¿…è¦ãªãƒšãƒ¼ã‚¸ãªã®ã§ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²ã
                const redirectCount = parseInt(sessionStorage.getItem('pageRedirectCount') || '0');
                if (redirectCount > 2) {
                    console.error('âŒ æœ€å¤§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå›æ•°ã‚’è¶…é - å¼·åˆ¶ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸');
                    sessionStorage.removeItem('pageRedirectCount');
                    window.location.replace('https://bettger3000.github.io/nagoya-glutenfree-map/login.html');
                } else {
                    sessionStorage.setItem('pageRedirectCount', String(redirectCount + 1));
                    window.location.replace('https://bettger3000.github.io/nagoya-glutenfree-map/');
                }
                return;
            }
            
            console.log('âœ… Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
            const { data: { session } } = await window.supabase.auth.getSession();
            if (session && session.user) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ãƒ€ãƒ–ãƒ«ãƒã‚§ãƒƒã‚¯
                const { data: allowedUser, error } = await window.supabase
                    .from('allowed_users')
                    .select('email')
                    .eq('email', session.user.email)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    console.error('âŒ è¨±å¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                    window.location.replace('https://bettger3000.github.io/nagoya-glutenfree-map/');
                    return;
                }
                
                if (!allowedUser) {
                    console.log('âŒ æœªè¨±å¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹æ¤œå‡º - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ');
                    await window.supabase.auth.signOut();
                    alert('ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    window.location.replace('https://bettger3000.github.io/nagoya-glutenfree-map/login.html');
                    return;
                }
                
                window.currentUser = session.user;
                updateUserDisplay(session.user);
                console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¨­å®šå®Œäº†:', session.user.email);
                // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ­£å¸¸ãªèªè¨¼å®Œäº†ï¼‰
                sessionStorage.removeItem('pageRedirectCount');
            } else {
                console.log('âŒ new-map.html: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã— - ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                window.location.replace('https://bettger3000.github.io/nagoya-glutenfree-map/');
                return;
            }
            
            // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
            initApp();
            
            function updateUserDisplay(user) {
                // ãƒ­ã‚°ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                document.getElementById('loginSection').style.display = 'none';
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                document.getElementById('userSection').style.display = 'flex';
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®æœ€åˆã®æ–‡å­—ã‚’ã‚¢ãƒã‚¿ãƒ¼ã«è¡¨ç¤º
                const avatar = document.getElementById('userAvatar');
                if (avatar && user.email) {
                    avatar.textContent = user.email.charAt(0).toUpperCase();
                }
                
                console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã—ãŸ:', user.email);
            }
        })();

        // Global variables
        let map;
        let markers = [];
        let stores = [];
        let currentUser = null;
        let reviews = [];
        let userStoreLists = []; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŠåº—ãƒªã‚¹ãƒˆ
        let pinModeActive = false;
        let userPin = null;

        // Category icons and colors
        const categoryConfig = {
            'å’Œé£Ÿ': { icon: 'fas fa-grip-lines-vertical', color: '#FFB6C1' },
            'æ´‹é£Ÿ': { icon: 'fas fa-utensils', color: '#27AE60' },
            'ã‚«ãƒ•ã‚§': { icon: 'fas fa-coffee', color: '#8B4513' },
            'ãƒ‘ãƒ³å±‹': { icon: 'fas fa-bread-slice', color: '#8E44AD' },
            'ã‚¹ã‚¤ãƒ¼ãƒ„': { icon: 'fas fa-ice-cream', color: '#FFE4E1' },
            'è²©å£²åº—': { icon: 'fas fa-shopping-bag', color: '#98D8C8' },
            'ãã®ä»–': { icon: 'fas fa-store', color: '#B0E0E6' }
        };

        // å…¨å›½ä¸»è¦ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ãƒ»POIãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        const landmarkDatabase = {
            // åŒ—æµ·é“
            "æœ­å¹Œé§…": { lat: 43.0642, lng: 141.3469, region: "åŒ—æµ·é“" },
            "æœ­å¹Œæ™‚è¨ˆå°": { lat: 43.0639, lng: 141.3537, region: "åŒ—æµ·é“" },
            "ã™ã™ãã®": { lat: 43.0548, lng: 141.3535, region: "åŒ—æµ·é“" },
            "æ–°åƒæ­³ç©ºæ¸¯": { lat: 42.7747, lng: 141.6920, region: "åŒ—æµ·é“" },
            
            // æ±åŒ—
            "ä»™å°é§…": { lat: 38.2608, lng: 140.8814, region: "å®®åŸçœŒ" },
            "é’æ£®é§…": { lat: 40.8278, lng: 140.7407, region: "é’æ£®çœŒ" },
            
            // é–¢æ±
            "æ±äº¬é§…": { lat: 35.6812, lng: 139.7671, region: "æ±äº¬éƒ½" },
            "æ–°å®¿é§…": { lat: 35.6896, lng: 139.7006, region: "æ±äº¬éƒ½" },
            "æ¸‹è°·é§…": { lat: 35.6580, lng: 139.7016, region: "æ±äº¬éƒ½" },
            "æ± è¢‹é§…": { lat: 35.7295, lng: 139.7107, region: "æ±äº¬éƒ½" },
            "ä¸Šé‡é§…": { lat: 35.7140, lng: 139.7774, region: "æ±äº¬éƒ½" },
            "æµ…è‰": { lat: 35.7148, lng: 139.7967, region: "æ±äº¬éƒ½" },
            "éŠ€åº§": { lat: 35.6717, lng: 139.7650, region: "æ±äº¬éƒ½" },
            "åŸå®¿": { lat: 35.6702, lng: 139.7026, region: "æ±äº¬éƒ½" },
            "ãŠå°å ´": { lat: 35.6266, lng: 139.7736, region: "æ±äº¬éƒ½" },
            "æ±äº¬ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼": { lat: 35.7101, lng: 139.8107, region: "æ±äº¬éƒ½" },
            "æ±äº¬ã‚¿ãƒ¯ãƒ¼": { lat: 35.6586, lng: 139.7454, region: "æ±äº¬éƒ½" },
            "æ–°å®¿éƒ½åº": { lat: 35.6893, lng: 139.6918, region: "æ±äº¬éƒ½" },
            "ç¾½ç”°ç©ºæ¸¯": { lat: 35.5494, lng: 139.7798, region: "æ±äº¬éƒ½" },
            "æˆç”°ç©ºæ¸¯": { lat: 35.7720, lng: 140.3929, region: "åƒè‘‰çœŒ" },
            "æ¨ªæµœé§…": { lat: 35.4658, lng: 139.6225, region: "ç¥å¥ˆå·çœŒ" },
            "ã¿ãªã¨ã¿ã‚‰ã„": { lat: 35.4563, lng: 139.6364, region: "ç¥å¥ˆå·çœŒ" },
            "éŒå€‰": { lat: 35.3192, lng: 139.5466, region: "ç¥å¥ˆå·çœŒ" },
            "å¤§å®®é§…": { lat: 35.9063, lng: 139.6239, region: "åŸ¼ç‰çœŒ" },
            "åƒè‘‰é§…": { lat: 35.6058, lng: 140.1061, region: "åƒè‘‰çœŒ" },
            
            // ä¸­éƒ¨
            "åå¤å±‹é§…": { lat: 35.1815, lng: 136.9066, region: "æ„›çŸ¥çœŒ" },
            "åå¤å±‹åŸ": { lat: 35.1856, lng: 136.8997, region: "æ„›çŸ¥çœŒ" },
            "æ „": { lat: 35.1677, lng: 136.9089, region: "æ„›çŸ¥çœŒ" },
            "å¤§é ˆ": { lat: 35.1588, lng: 136.9008, region: "æ„›çŸ¥çœŒ" },
            "é‡‘å±±é§…": { lat: 35.1432, lng: 136.8989, region: "æ„›çŸ¥çœŒ" },
            "ä¸­éƒ¨å›½éš›ç©ºæ¸¯": { lat: 34.8584, lng: 136.8047, region: "æ„›çŸ¥çœŒ" },
            "é™å²¡é§…": { lat: 34.9756, lng: 138.3829, region: "é™å²¡çœŒ" },
            "æµœæ¾é§…": { lat: 34.7040, lng: 137.7346, region: "é™å²¡çœŒ" },
            "é‡‘æ²¢é§…": { lat: 36.5782, lng: 136.6477, region: "çŸ³å·çœŒ" },
            "å¯Œå±±é§…": { lat: 36.7015, lng: 137.2136, region: "å¯Œå±±çœŒ" },
            "é•·é‡é§…": { lat: 36.6434, lng: 138.1884, region: "é•·é‡çœŒ" },
            
            // é–¢è¥¿
            "å¤§é˜ªé§…": { lat: 34.7024, lng: 135.4959, region: "å¤§é˜ªåºœ" },
            "æ¢…ç”°": { lat: 34.7053, lng: 135.4979, region: "å¤§é˜ªåºœ" },
            "é›£æ³¢": { lat: 34.6668, lng: 135.5000, region: "å¤§é˜ªåºœ" },
            "å¤©ç‹å¯º": { lat: 34.6456, lng: 135.5066, region: "å¤§é˜ªåºœ" },
            "å¤§é˜ªåŸ": { lat: 34.6873, lng: 135.5262, region: "å¤§é˜ªåºœ" },
            "é€šå¤©é–£": { lat: 34.6523, lng: 135.5063, region: "å¤§é˜ªåºœ" },
            "USJ": { lat: 34.6658, lng: 135.4321, region: "å¤§é˜ªåºœ" },
            "é–¢è¥¿å›½éš›ç©ºæ¸¯": { lat: 34.4347, lng: 135.2441, region: "å¤§é˜ªåºœ" },
            "äº¬éƒ½é§…": { lat: 34.9859, lng: 135.7581, region: "äº¬éƒ½åºœ" },
            "æ¸…æ°´å¯º": { lat: 34.9949, lng: 135.7849, region: "äº¬éƒ½åºœ" },
            "é‡‘é–£å¯º": { lat: 35.0394, lng: 135.7292, region: "äº¬éƒ½åºœ" },
            "åµå±±": { lat: 35.0096, lng: 135.6689, region: "äº¬éƒ½åºœ" },
            "ç¥‡åœ’": { lat: 35.0036, lng: 135.7756, region: "äº¬éƒ½åºœ" },
            "ç¥æˆ¸é§…": { lat: 34.6765, lng: 135.1885, region: "å…µåº«çœŒ" },
            "ä¸‰å®®": { lat: 34.6939, lng: 135.1955, region: "å…µåº«çœŒ" },
            "å¥ˆè‰¯é§…": { lat: 34.6851, lng: 135.8048, region: "å¥ˆè‰¯çœŒ" },
            "æ±å¤§å¯º": { lat: 34.6890, lng: 135.8396, region: "å¥ˆè‰¯çœŒ" },
            
            // ä¸­å›½
            "åºƒå³¶é§…": { lat: 34.3975, lng: 132.4756, region: "åºƒå³¶çœŒ" },
            "åºƒå³¶å¹³å’Œè¨˜å¿µå…¬åœ’": { lat: 34.3955, lng: 132.4536, region: "åºƒå³¶çœŒ" },
            "å²¡å±±é§…": { lat: 34.6661, lng: 133.9184, region: "å²¡å±±çœŒ" },
            
            // å››å›½
            "é«˜æ¾é§…": { lat: 34.3513, lng: 134.0436, region: "é¦™å·çœŒ" },
            "æ¾å±±é§…": { lat: 33.8389, lng: 132.7661, region: "æ„›åª›çœŒ" },
            
            // ä¹å·
            "åšå¤šé§…": { lat: 33.5904, lng: 130.4017, region: "ç¦å²¡çœŒ" },
            "å¤©ç¥": { lat: 33.5906, lng: 130.4015, region: "ç¦å²¡çœŒ" },
            "ç¦å²¡ç©ºæ¸¯": { lat: 33.5859, lng: 130.4510, region: "ç¦å²¡çœŒ" },
            "é•·å´é§…": { lat: 32.7503, lng: 129.8779, region: "é•·å´çœŒ" },
            "ç†Šæœ¬é§…": { lat: 32.8031, lng: 130.6889, region: "ç†Šæœ¬çœŒ" },
            "é¹¿å…å³¶ä¸­å¤®é§…": { lat: 31.5815, lng: 130.5421, region: "é¹¿å…å³¶çœŒ" },
            "é‚£è¦‡ç©ºæ¸¯": { lat: 26.1958, lng: 127.6458, region: "æ²–ç¸„çœŒ" },
            "å›½éš›é€šã‚Š": { lat: 26.2124, lng: 127.6792, region: "æ²–ç¸„çœŒ" }
        };

        // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã‚µã‚¤ãƒ‰ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
        function initMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const sidebarHeader = document.querySelector('.sidebar-header');
            const storeList = document.querySelector('.store-list');
            
            if (window.innerWidth <= 768 && sidebarHeader) {
                // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯åˆæœŸçŠ¶æ…‹ã§é€šå¸¸è¡¨ç¤ºï¼ˆ30vhï¼‰
                let currentState = 'normal'; // normal, collapsed, expanded
                
                // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                sidebarHeader.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // çŠ¶æ…‹ã‚µã‚¤ã‚¯ãƒ«: normal â†’ collapsed â†’ expanded â†’ normal
                    if (currentState === 'normal') {
                        sidebar.classList.add('collapsed');
                        sidebar.classList.remove('expanded');
                        currentState = 'collapsed';
                        console.log('ğŸ“‹ åº—èˆ—ä¸€è¦§ã‚’æŠ˜ã‚ŠãŸãŸã¿');
                    } else if (currentState === 'collapsed') {
                        sidebar.classList.remove('collapsed');
                        sidebar.classList.add('expanded');
                        currentState = 'expanded';
                        console.log('ğŸ“œ åº—èˆ—ä¸€è¦§ã‚’å…¨ç”»é¢è¡¨ç¤º');
                    } else {
                        sidebar.classList.remove('expanded');
                        sidebar.classList.remove('collapsed');
                        currentState = 'normal';
                        console.log('ğŸ“‹ åº—èˆ—ä¸€è¦§ã‚’é€šå¸¸è¡¨ç¤º');
                    }
                    
                    // ãƒãƒƒãƒ—ã®ãƒªã‚µã‚¤ã‚ºã‚’ãƒˆãƒªã‚¬ãƒ¼
                    if (window.map) {
                        setTimeout(() => {
                            map.invalidateSize();
                        }, 400);
                    }
                });
                
                // ã‚¹ãƒ¯ã‚¤ãƒ—æ“ä½œã®æ¤œå‡º
                let startY = 0;
                let startTime = 0;
                
                sidebarHeader.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                    startTime = Date.now();
                });
                
                sidebarHeader.addEventListener('touchend', (e) => {
                    const endY = e.changedTouches[0].clientY;
                    const endTime = Date.now();
                    const deltaY = startY - endY;
                    const deltaTime = endTime - startTime;
                    const velocity = Math.abs(deltaY) / deltaTime;
                    
                    // ã‚ˆã‚Šæ•æ„Ÿãªã‚¹ãƒ¯ã‚¤ãƒ—æ¤œå‡ºï¼ˆè·é›¢ã¾ãŸã¯é€Ÿåº¦ï¼‰
                    if ((deltaY > 30 || velocity > 0.3) && deltaTime < 400 && currentState === 'normal') {
                        sidebar.classList.add('expanded');
                        currentState = 'expanded';
                        console.log('ğŸ‘† ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¢ãƒƒãƒ—ã§å…¨ç”»é¢è¡¨ç¤º');
                        
                        // æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ã®ã¿ï¼‰
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                        
                        if (window.map) {
                            setTimeout(() => map.invalidateSize(), 400);
                        }
                    }
                    // ä¸‹å‘ãã‚¹ãƒ¯ã‚¤ãƒ—ã§é–‰ã˜ã‚‹
                    else if ((deltaY < -30 || velocity > 0.3) && deltaTime < 400 && currentState === 'expanded') {
                        sidebar.classList.remove('expanded');
                        currentState = 'normal';
                        console.log('ğŸ‘‡ ã‚¹ãƒ¯ã‚¤ãƒ—ãƒ€ã‚¦ãƒ³ã§é€šå¸¸è¡¨ç¤º');
                        
                        if (navigator.vibrate) {
                            navigator.vibrate(30);
                        }
                        
                        if (window.map) {
                            setTimeout(() => map.invalidateSize(), 400);
                        }
                    }
                });
                
                // ã‚¿ãƒƒãƒ—å¯èƒ½ãªã“ã¨ã‚’ç¤ºã™ã‚¹ã‚¿ã‚¤ãƒ«
                sidebarHeader.style.cursor = 'pointer';
                sidebarHeader.style.userSelect = 'none';
            }
        }
        
        // Initialize application
        async function initApp() {
            console.log('ğŸš€ nacoã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒƒãƒ—åˆæœŸåŒ–é–‹å§‹');
            
            try {
                // Supabase is already initialized in auth check
                supabase = window.supabase;
                console.log('âœ… SupabaseåˆæœŸåŒ–ç¢ºèª');

                // Check authentication
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    updateUserUI(true);
                    console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ¸ˆã¿:', currentUser.email);
                } else {
                    updateUserUI(false);
                    console.log('â„¹ï¸ æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼');
                }

                // Initialize map with slight delay to ensure DOM is ready
                setTimeout(() => {
                    initMap();
                    initMobileSidebar(); // ãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®åˆæœŸåŒ–
                }, 100);

                // Wait a bit more before loading data
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Load data with error handling
                await Promise.allSettled([
                    loadStores(),
                    loadReviews(),
                    loadUserStoreLists()
                ]);
                
                updateStats();

                // Setup event listeners
                setupEventListeners();
                
                // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è‡ªå‹•çš„ã«ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦è·é›¢é †ã«ã‚½ãƒ¼ãƒˆ
                if (currentUser) {
                    console.log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾åœ¨åœ°ã‚’è‡ªå‹•å–å¾—ã—ã¾ã™...');
                    setTimeout(async () => {
                        await autoDetectLocation();
                    }, 500);
                }

                // Hide loading overlay
                document.getElementById('loadingOverlay').classList.add('hidden');

                console.log('âœ… nacoã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒƒãƒ—åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // Initialize map (Nagoya center)
        function initMap() {
            console.log('ğŸ—ºï¸ ãƒãƒƒãƒ—åˆæœŸåŒ–é–‹å§‹...');
            
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('âŒ mapè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            console.log('ğŸ“ mapè¦ç´ ç¢ºèªå®Œäº†:', mapElement);
            
            try {
                // Center on Nagoya Station as default
                map = L.map('map').setView([35.1815, 136.9066], 12);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);
                
                // åˆæœŸã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š
                currentZoom = map.getZoom();
                
                // ã‚ºãƒ¼ãƒ å¤‰æ›´æ™‚ã«ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºã‚’å‹•çš„ã«æ›´æ–°
                map.on('zoomend', function() {
                    const newZoom = map.getZoom();
                    if (newZoom !== currentZoom) {
                        console.log(`ğŸ” ã‚ºãƒ¼ãƒ å¤‰æ›´: ${currentZoom} â†’ ${newZoom}`);
                        currentZoom = newZoom;
                        updateAllMarkerSizes();
                    }
                });
                
                // ã™ã¹ã¦ã®ãƒãƒ¼ã‚«ãƒ¼ã®ã‚µã‚¤ã‚ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
                function updateAllMarkerSizes() {
                    console.log(`ğŸ”„ ã™ã¹ã¦ã®ãƒãƒ¼ã‚«ãƒ¼ã®ã‚µã‚¤ã‚ºã‚’æ›´æ–°ä¸­... (ã‚ºãƒ¼ãƒ : ${currentZoom})`);
                    
                    // ãƒ¡ã‚¤ãƒ³ã®åº—èˆ—ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
                    markers.forEach(marker => {
                        const store = marker.options.storeData;
                        if (store) {
                            const newIcon = createCustomIcon(store.category, store, currentZoom);
                            marker.setIcon(newIcon);
                        }
                    });
                }

                // Add click event for pin mode
                map.on('click', function(e) {
                    if (pinModeActive) {
                        const { lat, lng } = e.latlng;
                        
                        // Create user pin
                        createUserPin(lat, lng);
                        
                        // Show stores near pin
                        showStoresNearUserPin(lat, lng);
                        
                        // Exit pin mode
                        pinModeActive = false;
                        document.getElementById('pinModeBtn').classList.remove('active');
                        map.getContainer().style.cursor = '';
                        
                        showNotification('ğŸ“Œ ãƒ”ãƒ³ã‚’ç«‹ã¦ã¾ã—ãŸï¼ã“ã®åœ°ç‚¹ã‹ã‚‰è¿‘ã„é †ã«åº—èˆ—ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™', 'success');
                    }
                });

                console.log('âœ… åå¤å±‹é§…ä¸­å¿ƒã§ãƒãƒƒãƒ—åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('âŒ ãƒãƒƒãƒ—åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // Load stores from Supabase
        async function loadStores() {
            try {
                console.log('ğŸ“ åº—èˆ—ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...');
                
                // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
                if (window.performanceManager) {
                    const cachedStores = performanceManager.getCachedApiResponse('stores');
                    if (cachedStores) {
                        console.log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—');
                        stores = cachedStores;
                        updateStoreList(stores);
                        if (map) {
                            requestAnimationFrame(() => updateMapMarkers(stores));
                        }
                        return;
                    }
                }
                
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’é¿ã‘ã‚‹ãŸã‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
                const timestamp = new Date().getTime();
                console.log(`ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥: ${timestamp}`);
                
                const { data, error } = await supabase
                    .from('stores')
                    .select('*')
                    .order('name');

                if (error) throw error;

                // Store coordinates - simple approach like original app
                stores = (data || []).map(store => {
                    return {
                        ...store,
                        // Convert database fields to original format for compatibility
                        lat: store.latitude,
                        lng: store.longitude
                    };
                });
                console.log(`âœ… ${stores.length}ä»¶ã®æœ‰åŠ¹ãªåº—èˆ—ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†`);

                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                if (window.performanceManager) {
                    performanceManager.cacheApiResponse('stores', stores);
                }

                // Update UI
                updateStoreList(stores);
                
                // Wait for map to be initialized before adding markers
                if (map) {
                    requestAnimationFrame(() => {
                        updateMapMarkers(stores);
                        // Auto-fit map to show all stores nationwide
                        fitMapToAllStores(stores);
                    });
                } else {
                    console.warn('âš ï¸ ãƒãƒƒãƒ—æœªåˆæœŸåŒ–ã®ãŸã‚ã€ãƒãƒ¼ã‚«ãƒ¼ä½œæˆã‚’å¾…æ©Ÿä¸­...');
                    // Retry after a short delay
                    setTimeout(() => {
                        if (map) {
                            console.log('ğŸ”„ ãƒãƒƒãƒ—åˆæœŸåŒ–å®Œäº†å¾Œã«ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ');
                            updateMapMarkers(stores);
                            fitMapToAllStores(stores);
                        } else {
                            console.error('âŒ ãƒãƒƒãƒ—åˆæœŸåŒ–ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                        }
                    }, 500);
                }

            } catch (error) {
                console.error('âŒ åº—èˆ—ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                stores = []; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºé…åˆ—ã«
            }
        }

        // Load reviews from Supabase
        async function loadReviews() {
            try {
                const { data, error } = await supabase
                    .from('store_reviews')
                    .select('*');

                if (error) throw error;

                reviews = data || [];
                console.log(`âœ… ${reviews.length}ä»¶ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†`);

            } catch (error) {
                console.error('âŒ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                reviews = [];
            }
        }

        // Load user store lists from Supabase
        async function loadUserStoreLists() {
            try {
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ç©ºé…åˆ—
                if (!currentUser) {
                    userStoreLists = [];
                    return;
                }

                console.log('ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŠåº—ãƒªã‚¹ãƒˆå–å¾—ä¸­...');

                const { data, error } = await supabase
                    .from('user_store_lists')
                    .select('*')
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                userStoreLists = data || [];
                console.log(`âœ… ${userStoreLists.length}ä»¶ã®ãŠåº—ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†`);

            } catch (error) {
                console.error('âŒ ãŠåº—ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                userStoreLists = [];
            }
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalStores').textContent = stores.length;
            document.getElementById('visibleStores').textContent = stores.length;
            document.getElementById('reviewCount').textContent = reviews.length;
        }

        // Update store list in sidebar
        function updateStoreList(storesToShow) {
            const storeList = document.getElementById('storeList');
            
            if (storesToShow.length === 0) {
                storeList.innerHTML = '<div class="no-stores"><i class="fas fa-search"></i><br>è©²å½“ã™ã‚‹åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // ç¾åœ¨åœ°ãŒå–å¾—ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è·é›¢é †ã§ã‚½ãƒ¼ãƒˆ
            let processedStores = storesToShow;
            if (window.locationService && locationService.getCurrentLocation()) {
                processedStores = locationService.addDistanceToStores(storesToShow);
                processedStores = locationService.sortByDistance(processedStores);
            }

            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: requestAnimationFrameã§æç”»ã‚’æœ€é©åŒ–
            requestAnimationFrame(() => {
                const htmlContent = processedStores.map(store => {
                    const config = categoryConfig[store.category] || categoryConfig['ãã®ä»–'];
                    
                    // è·é›¢æƒ…å ±ã®è¡¨ç¤º
                    const distanceHtml = store.distanceText ? 
                        `<div class="store-distance">
                            <i class="fas fa-route"></i>
                            ${store.distanceText}
                        </div>` : '';

                    return `
                    <div class="store-item" onclick="selectStore(${store.id})">
                        <!-- Header with store name and distance -->
                        <div class="store-header">
                            <div class="store-name">
                                <i class="${config.icon}" style="color: ${config.color};"></i>
                                <span class="name-text">${currentSearchQuery ? highlightSearchTerm(store.name, currentSearchQuery) : escapeHtml(store.name)}</span>
                            </div>
                            ${distanceHtml}
                        </div>
                        
                        <!-- Category with better contrast -->
                        <div class="store-category-wrapper">
                            <span class="store-category-new" style="background: ${config.color};">
                                ${escapeHtml(store.category)}
                            </span>
                        </div>
                        
                        <!-- Address -->
                        <div class="store-address">
                            <i class="fas fa-map-marker-alt"></i>
                            ${currentSearchQuery ? highlightSearchTerm(store.address, currentSearchQuery) : escapeHtml(store.address)}
                        </div>
                        
                        ${currentSearchQuery ? `
                            <div style="
                                background: #e8f4f8;
                                color: #2c5282;
                                padding: 6px 10px;
                                border-radius: 12px;
                                font-size: 11px;
                                margin-bottom: 8px;
                                border-left: 3px solid #4299e1;
                            ">
                                <i class="fas fa-search"></i> ãƒãƒƒãƒ: ${getMatchReason(store, currentSearchQuery)}
                            </div>
                        ` : ''}
                        
                        <!-- Balanced action buttons -->
                        <div class="store-actions-new">
                            <button class="action-btn-new action-btn-primary" onclick="event.stopPropagation(); showStoreDetail(${store.id})">
                                <i class="fas fa-info-circle"></i>
                                <span>è©³ç´°</span>
                            </button>
                            <button class="action-btn-new action-btn-secondary" onclick="event.stopPropagation(); showOnMap(${store.id})">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>åœ°å›³</span>
                            </button>
                            <button class="action-btn-new action-btn-accent" onclick="event.stopPropagation(); openReviewModal(${store.id}, '${escapeHtml(store.name)}')">
                                <i class="fas fa-heart"></i>
                                <span>ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
                            </button>
                        </div>
                        
                        <!-- User list buttons (only shown when logged in) -->
                        ${currentUser ? `
                            <div class="user-list-actions" style="
                                display: flex;
                                gap: 8px;
                                margin-top: 10px;
                                padding-top: 10px;
                                border-top: 1px solid #eee;
                            ">
                                ${getWantToGoButton(store.id)}
                                ${getVisitedButton(store.id)}
                            </div>
                        ` : ''}
                    </div>
                `;
                }).join('');
                
                // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: ä¸€æ‹¬ã§DOMã‚’æ›´æ–°
                storeList.innerHTML = htmlContent;
                document.getElementById('visibleStores').textContent = storesToShow.length;
            });
        }

        // Update map markers
        // ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒãƒ¼ã‚«ãƒ¼è¨­å®šï¼ˆæ´—ç·´ã•ã‚ŒãŸãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰
        function getCategoryMarkerStyle(category) {
            const styles = {
                'å’Œé£Ÿ': {
                    icon: 'fas fa-bowl-rice',  // ãŠç±³/ä¸¼
                    color: '#E67E22',  // æ¸©ã‹ã¿ã®ã‚ã‚‹ã‚ªãƒ¬ãƒ³ã‚¸
                    shadowColor: 'rgba(230, 126, 34, 0.5)',
                    size: '14px'
                },
                'æ´‹é£Ÿ': {
                    icon: 'fas fa-utensils',  // ãƒŠã‚¤ãƒ•ãƒ•ã‚©ãƒ¼ã‚¯
                    color: '#27AE60',  // ã‚°ãƒªãƒ¼ãƒ³ç³»
                    shadowColor: 'rgba(39, 174, 96, 0.5)',
                    size: '14px'
                },
                'ã‚«ãƒ•ã‚§': {
                    icon: 'fas fa-coffee',
                    color: '#8B4513',  // èŒ¶è‰²ç³»
                    shadowColor: 'rgba(139, 69, 19, 0.5)',
                    size: '14px'
                },
                'ã‚¹ã‚¤ãƒ¼ãƒ„': {
                    icon: 'fas fa-birthday-cake',
                    color: '#E91E63',  // é®®ã‚„ã‹ãªãƒ”ãƒ³ã‚¯
                    shadowColor: 'rgba(233, 30, 99, 0.5)',
                    size: '14px'
                },
                'ãƒ‘ãƒ³å±‹': {
                    icon: 'fas fa-bread-slice',  // ãƒ‘ãƒ³ã‚¢ã‚¤ã‚³ãƒ³
                    color: '#8E44AD',  // ãƒ‘ãƒ¼ãƒ—ãƒ«ç³»
                    shadowColor: 'rgba(142, 68, 173, 0.5)',
                    size: '14px'
                },
                'è²©å£²åº—': {
                    icon: 'fas fa-shopping-bag',
                    color: '#FFD700',  // ã‚¤ã‚¨ãƒ­ãƒ¼
                    shadowColor: 'rgba(255, 215, 0, 0.5)',
                    size: '14px'
                }
            };
            
            return styles[category] || {
                icon: 'fas fa-map-marker-alt',
                color: '#9370DB',  // ãƒŸãƒ‡ã‚£ã‚¢ãƒ ãƒ‘ãƒ¼ãƒ—ãƒ«
                shadowColor: 'rgba(147, 112, 219, 0.4)',
                size: '14px'
            };
        }

        // ç¾åœ¨ã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’è¿½è·¡
        let currentZoom = 14;
        
        // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã«åŸºã¥ã„ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
        function getIconSizeForZoom(zoom) {
            // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ« 10-18 ã«å¯¾ã—ã¦é©åˆ‡ãªã‚µã‚¤ã‚ºã‚’è¨­å®š
            const minZoom = 10;
            const maxZoom = 18;
            const minSize = 18; // æœ€å°ã‚µã‚¤ã‚º
            const maxSize = 36; // æœ€å¤§ã‚µã‚¤ã‚º
            
            // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’ç¯„å›²å†…ã«åˆ¶é™
            const clampedZoom = Math.max(minZoom, Math.min(maxZoom, zoom));
            
            // ãƒªãƒ‹ã‚¢ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
            const size = minSize + ((clampedZoom - minZoom) / (maxZoom - minZoom)) * (maxSize - minSize);
            return Math.round(size);
        }
        
        // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã«åŸºã¥ã„ã¦ã‚·ãƒ£ãƒ‰ã‚¦ã¨ãƒœãƒ¼ãƒ€ãƒ¼ã®å¼·åº¦ã‚’è¨ˆç®—
        function getVisibilityEnhancement(zoom) {
            // ã‚ºãƒ¼ãƒ ãŒé«˜ã„ã»ã©ï¼ˆæ‹¡å¤§æ™‚ï¼‰ã‚·ãƒ£ãƒ‰ã‚¦ã¨ãƒœãƒ¼ãƒ€ãƒ¼ã‚’å¼·ãã™ã‚‹
            const shadowIntensity = Math.min(1, zoom / 15); // 0-1ã®ç¯„å›²
            const borderWidth = Math.max(2, Math.min(4, zoom / 4)); // 2-4pxã®ç¯„å›²
            
            return {
                shadowIntensity,
                borderWidth
            };
        }

        // æ´—ç·´ã•ã‚ŒãŸã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œæˆï¼ˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ + å‹•çš„ã‚µã‚¤ã‚ºèª¿æ•´ï¼‰
        function createCustomIcon(category, store = null, zoom = null) {
            // ç¾åœ¨ã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’ä½¿ç”¨ï¼ˆå¼•æ•°ã§æŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰
            const iconZoom = zoom !== null ? zoom : currentZoom;
            const iconSize = getIconSizeForZoom(iconZoom);
            const iconHeight = Math.round(iconSize * 1.35); // ãƒ†ã‚£ã‚¢ãƒ‰ãƒ­ãƒƒãƒ—å½¢çŠ¶ã®ãŸã‚é«˜ã•ã‚’èª¿æ•´
            const enhancement = getVisibilityEnhancement(iconZoom);
            
            const style = getCategoryMarkerStyle(category);
            let markerColor = style.color;
            let borderColor = 'rgba(255,255,255,0.8)'; // ã‚ˆã‚Šæ˜ç¢ºãªå¢ƒç•Œç·š
            let shadowColor = style.shadowColor;
            let badgeHtml = '';
            
            // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã¨åº—èˆ—ã®ãƒªã‚¹ãƒˆçŠ¶æ…‹ã«å¿œã˜ã¦ãƒãƒ¼ã‚«ãƒ¼ã‚’è£…é£¾
            if (store && currentDisplayMode === 'all') {
                const isWantToGo = isInUserList(store.id, 'want_to_go');
                const isVisited = isInUserList(store.id, 'visited');
                
                if (isVisited) {
                    // è¡Œã£ãŸåº—èˆ—: ç·‘ã®æ ç·š
                    borderColor = '#48bb78';
                    shadowColor = 'rgba(72, 187, 120, 0.5)';
                    badgeHtml = `
                        <div style="
                            position: absolute;
                            top: -6px;
                            right: -6px;
                            background: #48bb78;
                            color: white;
                            border-radius: 50%;
                            width: 16px;
                            height: 16px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 10px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        ">
                            <i class="fas fa-check"></i>
                        </div>
                    `;
                } else if (isWantToGo) {
                    // è¡ŒããŸã„åº—èˆ—: ç´«ã®æ ç·š
                    borderColor = '#667eea';
                    shadowColor = 'rgba(102, 126, 234, 0.5)';
                    badgeHtml = `
                        <div style="
                            position: absolute;
                            top: -6px;
                            right: -6px;
                            background: #667eea;
                            color: white;
                            border-radius: 50%;
                            width: 16px;
                            height: 16px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 10px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        ">
                            <i class="fas fa-bookmark"></i>
                        </div>
                    `;
                }
            } else if (store && (currentDisplayMode === 'want_to_go' || currentDisplayMode === 'visited')) {
                // å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒãƒ¼ã‚«ãƒ¼è‰²å¤‰æ›´
                if (currentDisplayMode === 'want_to_go') {
                    markerColor = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    shadowColor = 'rgba(102, 126, 234, 0.5)';
                    borderColor = '#667eea';
                } else if (currentDisplayMode === 'visited') {
                    markerColor = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                    shadowColor = 'rgba(72, 187, 120, 0.5)';
                    borderColor = '#48bb78';
                }
            }
            
            // ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å‹•çš„ã«èª¿æ•´
            const iconFontSize = Math.round(iconSize * 0.5);
            const pointSize = Math.round(iconSize * 0.28);
            const badgeSize = Math.round(iconSize * 0.55);
            const badgeOffset = Math.round(-iconSize * 0.2);
            
            const iconHtml = `
                <div class="sophisticated-marker">
                    <div class="marker-teardrop" style="
                        width: ${iconSize}px;
                        height: ${iconHeight}px;
                        background: ${markerColor};
                        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
                        position: relative;
                        box-shadow: 
                            0 ${Math.round(6 * enhancement.shadowIntensity)}px ${Math.round(16 * enhancement.shadowIntensity)}px ${shadowColor.replace('0.4', (0.4 * enhancement.shadowIntensity).toFixed(1))},
                            0 ${Math.round(3 * enhancement.shadowIntensity)}px ${Math.round(8 * enhancement.shadowIntensity)}px rgba(0,0,0,${(0.15 * enhancement.shadowIntensity).toFixed(2)}),
                            inset 0 1px 0 rgba(255,255,255,0.3);
                        border: ${enhancement.borderWidth}px solid ${borderColor};
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        transform-origin: center bottom;
                        transition: all 0.2s ease-out;
                    ">
                        <div class="marker-point" style="
                            position: absolute;
                            bottom: -${Math.round(enhancement.borderWidth/2)}px;
                            left: 50%;
                            transform: translateX(-50%) rotate(45deg);
                            width: ${pointSize}px;
                            height: ${pointSize}px;
                            background: ${typeof markerColor === 'string' && markerColor.includes('gradient') ? style.color : markerColor};
                            border-radius: 0 0 0 50%;
                            border: ${Math.max(1, Math.round(enhancement.borderWidth/2))}px solid ${borderColor};
                        "></div>
                        <i class="${style.icon}" style="
                            color: white;
                            font-size: ${iconFontSize}px;
                            text-shadow: 
                                0 1px 2px rgba(0,0,0,${(0.5 * enhancement.shadowIntensity).toFixed(2)}),
                                0 2px 4px rgba(0,0,0,${(0.3 * enhancement.shadowIntensity).toFixed(2)});
                            z-index: 10;
                            margin-top: -2px;
                            filter: drop-shadow(0 0 2px rgba(0,0,0,0.3));
                        "></i>
                    </div>
                    ${badgeHtml.replace(/16px/g, `${badgeSize}px`).replace(/-6px/g, `${badgeOffset}px`)}
                </div>
            `;
            
            return L.divIcon({
                html: iconHtml,
                className: 'sophisticated-marker-wrapper',
                iconSize: [iconSize, iconHeight],
                iconAnchor: [Math.round(iconSize/2), iconHeight],
                popupAnchor: [0, -iconHeight]
            });
        }

        // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
        let markerClusterGroup = null;
        
        function updateMapMarkers(storesToShow) {
            console.log(`ğŸ—ºï¸ ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°é–‹å§‹: ${storesToShow.length}ä»¶ã®åº—èˆ—`);
            
            if (!map) {
                console.error('âŒ ãƒãƒƒãƒ—ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã§æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼ã‚’ä¸€æ‹¬å‰Šé™¤
            if (markerClusterGroup) {
                map.removeLayer(markerClusterGroup);
                markerClusterGroup = null;
            }
            markers = [];

            // Add new markers with custom icons
            let successCount = 0;
            let failCount = 0;
            const newMarkers = [];
            
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šé–‹å§‹
            if (window.performanceManager) {
                performanceManager.startMeasure('marker-creation');
            }
            
            storesToShow.forEach(store => {
                try {
                    // Original app style: simple check for lat/lng existence
                    if (store.lat && store.lng) {
                        console.log(`ğŸ“ ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ: ${store.name} at [${store.lat}, ${store.lng}]`);
                        
                        const customIcon = createCustomIcon(store.category, store, currentZoom);
                        const style = getCategoryMarkerStyle(store.category);
                        
                        const marker = L.marker([store.lat, store.lng], { 
                            icon: customIcon,
                            storeData: store // ãƒãƒ¼ã‚«ãƒ¼ã«åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                        })
                            .bindPopup(`
                                <div class="custom-popup" style="
                                    min-width: 220px;
                                    background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
                                    border-radius: 16px;
                                    padding: 0;
                                    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
                                    border: 1px solid rgba(0,0,0,0.06);
                                    overflow: hidden;
                                ">
                                    <!-- Header with store name -->
                                    <div style="
                                        background: linear-gradient(135deg, ${style.color} 0%, ${style.borderColor || style.color} 100%);
                                        padding: 16px 18px 14px;
                                        margin: 0;
                                    ">
                                        <h3 style="
                                            margin: 0;
                                            color: white;
                                            font-size: 18px;
                                            font-weight: 700;
                                            line-height: 1.2;
                                            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
                                            letter-spacing: 0.3px;
                                        ">${escapeHtml(store.name)}</h3>
                                        <div style="
                                            margin: 8px 0 0 0;
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                        ">
                                            <span style="
                                                background: rgba(255,255,255,0.25);
                                                color: white;
                                                padding: 4px 12px;
                                                border-radius: 20px;
                                                font-size: 12px;
                                                font-weight: 500;
                                                border: 1px solid rgba(255,255,255,0.3);
                                            ">${escapeHtml(store.category)}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Content area -->
                                    <div style="padding: 16px 18px;">
                                        <div style="
                                            margin: 0 0 16px 0;
                                            color: #666;
                                            font-size: 13px;
                                            line-height: 1.4;
                                            display: flex;
                                            align-items: flex-start;
                                            gap: 6px;
                                        ">
                                            <span style="color: #999; margin-top: 1px;">ğŸ“</span>
                                            <span>${escapeHtml(store.address)}</span>
                                        </div>
                                        
                                        <!-- Subtle detail button -->
                                        <button onclick="showStoreDetail(${store.id})" style="
                                            width: 100%;
                                            background: rgba(74, 144, 226, 0.08);
                                            color: #4A90E2;
                                            border: 1px solid rgba(74, 144, 226, 0.2);
                                            padding: 12px 16px;
                                            border-radius: 12px;
                                            font-size: 13px;
                                            font-weight: 500;
                                            cursor: pointer;
                                            transition: all 0.2s ease;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            gap: 6px;
                                        " onmouseover="
                                            this.style.background='rgba(74, 144, 226, 0.12)';
                                            this.style.borderColor='rgba(74, 144, 226, 0.3)';
                                            this.style.transform='translateY(-1px)';
                                        " onmouseout="
                                            this.style.background='rgba(74, 144, 226, 0.08)';
                                            this.style.borderColor='rgba(74, 144, 226, 0.2)';
                                            this.style.transform='translateY(0)';
                                        ">
                                            <span style="font-size: 12px;">â„¹ï¸</span>
                                            è©³ç´°ã‚’è¦‹ã‚‹
                                        </button>
                                    </div>
                                </div>
                            `)
                            ;
                        
                        newMarkers.push(marker);
                        markers.push(marker);
                        successCount++;
                    } else {
                        console.warn(`âš ï¸ ã‚¹ã‚­ãƒƒãƒ—: ${store.name} - åº§æ¨™ãªã—`);
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                    console.error(`âŒ ãƒãƒ¼ã‚«ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼ (${store.name}):`, error);
                }
            });
            
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã‚’ä½¿ç”¨
            if (newMarkers.length > 0) {
                // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã®è¨­å®š
                markerClusterGroup = L.markerClusterGroup({
                    maxClusterRadius: 50,           // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼åŠå¾„
                    spiderfyOnMaxZoom: true,        // æœ€å¤§ã‚ºãƒ¼ãƒ æ™‚ã«å±•é–‹
                    showCoverageOnHover: false,     // ãƒ›ãƒãƒ¼æ™‚ã®ç¯„å›²è¡¨ç¤ºã‚’ç„¡åŠ¹åŒ–
                    zoomToBoundsOnClick: true,      // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚ºãƒ¼ãƒ 
                    disableClusteringAtZoom: 16,    // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«16ä»¥ä¸Šã§ã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ç„¡åŠ¹
                    animate: true,                   // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æœ‰åŠ¹
                    animateAddingMarkers: false,     // ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç„¡åŠ¹ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼‰
                    chunkedLoading: true,            // ãƒãƒ£ãƒ³ã‚¯å˜ä½ã§ã®èª­ã¿è¾¼ã¿
                    chunkInterval: 200,              // ãƒãƒ£ãƒ³ã‚¯é–“éš”
                    chunkDelay: 50                   // ãƒãƒ£ãƒ³ã‚¯é…å»¶
                });
                
                // ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ 
                markerClusterGroup.addLayers(newMarkers);
                map.addLayer(markerClusterGroup);
            }
            
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šçµ‚äº†
            if (window.performanceManager) {
                performanceManager.endMeasure('marker-creation');
            }
            
            console.log(`ğŸ“Š ãƒãƒ¼ã‚«ãƒ¼ä½œæˆçµæœ: æˆåŠŸ ${successCount}ä»¶, å¤±æ•— ${failCount}ä»¶`);
        }

        // Fit map to show all stores nationwide
        function fitMapToAllStores(stores) {
            try {
                const storesWithCoords = stores.filter(store => store.lat && store.lng);
                if (storesWithCoords.length > 0) {
                    console.log(`ğŸ—¾ å…¨å›½å¯¾å¿œ: ${storesWithCoords.length}ä»¶ã®åº—èˆ—ã«åœ°å›³ã‚’èª¿æ•´ä¸­...`);
                    
                    const bounds = L.latLngBounds(
                        storesWithCoords.map(store => [store.lat, store.lng])
                    );
                    
                    map.fitBounds(bounds, { 
                        padding: [20, 20], 
                        maxZoom: 12 // Prevent zooming in too much for nationwide view
                    });
                    
                    console.log('âœ… å…¨å›½ã®åº—èˆ—ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†åœ°å›³ã‚’èª¿æ•´å®Œäº†');
                } else {
                    console.warn('âš ï¸ åº§æ¨™ã®ã‚ã‚‹åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                console.error('âŒ åœ°å›³èª¿æ•´ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // Select store (highlight and center on map)
        function selectStore(storeId) {
            try {
                const store = stores.find(s => s.id === storeId);
                if (!store) {
                    console.warn('åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', storeId);
                    return;
                }
                
                // Original app style: use lat/lng if they exist
                if (store.lat && store.lng) {
                    map.setView([store.lat, store.lng], 15);
                } else {
                    console.warn(`åº—èˆ—ã®åº§æ¨™ãŒã‚ã‚Šã¾ã›ã‚“: ${store.name}`);
                }
                
                // Find and open popup for this store's marker
                const marker = markers.find(m => {
                    try {
                        const markerLatLng = m.getLatLng();
                        return Math.abs(markerLatLng.lat - store.latitude) < 0.00001 && 
                               Math.abs(markerLatLng.lng - store.longitude) < 0.00001;
                    } catch (e) {
                        return false;
                    }
                });
                
                if (marker) {
                    marker.openPopup();
                }
            } catch (error) {
                console.error('åº—èˆ—é¸æŠã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // Show store on map
        function showOnMap(storeId) {
            selectStore(storeId);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            const searchBox = document.getElementById('searchBox');
            searchBox.addEventListener('input', handleSearch);

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', handleFilter);
            });
            
            
            // ç¾åœ¨åœ°ã‚µãƒ¼ãƒ“ã‚¹ã®åˆæœŸåŒ–
            initLocationService();

            // Auth state change listener
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('ğŸ” èªè¨¼çŠ¶æ…‹å¤‰æ›´:', event, session?.user?.email);
                
                if (session) {
                    currentUser = session.user;
                    updateUserUI(true);
                    // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
                    await loadUserStoreLists();
                    updateStoreList(stores); // UIã‚’æ›´æ–°
                } else {
                    currentUser = null;
                    userStoreLists = []; // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
                    updateUserUI(false);
                    updateStoreList(stores); // UIã‚’æ›´æ–°
                }
            });
        }

        // Handle search with enhanced search fields
        async function handleSearch(event) {
            const query = event.target.value.trim();
            
            if (query === '') {
                currentSearchQuery = ''; // æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’ã‚¯ãƒªã‚¢
                updateStoreList(stores);
                updateMapMarkers(stores);
                // æ¤œç´¢ã‚¯ãƒªã‚¢æ™‚ã¯æ¤œç´¢æƒ…å ±ã‚’éè¡¨ç¤º
                hideSearchInfo();
                return;
            }
            
            const lowerQuery = query.toLowerCase();
            
            // æ‹¡å¼µæ¤œç´¢: è¤‡æ•°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰æ¤œç´¢
            const filtered = stores.filter(store => {
                // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å®‰å…¨ã«ãƒã‚§ãƒƒã‚¯
                const nameMatch = store.name && store.name.toLowerCase().includes(lowerQuery);
                const addressMatch = store.address && store.address.toLowerCase().includes(lowerQuery);
                const categoryMatch = store.category && store.category.toLowerCase().includes(lowerQuery);
                const descriptionMatch = store.description && store.description.toLowerCase().includes(lowerQuery);
                const nacoCommentMatch = store.nacoComment && store.nacoComment.toLowerCase().includes(lowerQuery);
                const hoursMatch = store.hours && store.hours.toLowerCase().includes(lowerQuery);
                const closedMatch = store.closed && store.closed.toLowerCase().includes(lowerQuery);
                
                // ã©ã‚Œã‹ä¸€ã¤ã§ã‚‚ãƒãƒƒãƒã™ã‚Œã°true
                return nameMatch || addressMatch || categoryMatch || descriptionMatch || 
                       nacoCommentMatch || hoursMatch || closedMatch;
            });
            
            // æ¤œç´¢çµæœã®è©³ç´°ã‚’è¡¨ç¤º
            if (filtered.length > 0) {
                currentSearchQuery = query; // æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’ä¿å­˜
                updateStoreList(filtered);
                updateMapMarkers(filtered);
                showSearchInfo(query, filtered.length);
                return;
            }
            
            // åº—èˆ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯æ¤œç´¢ã‚’è©¦è¡Œ
            await searchLandmarkAndShowNearbyStores(query);
        }
        
        // æ¤œç´¢æƒ…å ±ã‚’è¡¨ç¤º
        function showSearchInfo(query, resultCount) {
            // æ—¢å­˜ã®æ¤œç´¢æƒ…å ±ã‚’å‰Šé™¤
            hideSearchInfo();
            
            // æ¤œç´¢æƒ…å ±ã‚’ä½œæˆ
            const searchInfo = document.createElement('div');
            searchInfo.id = 'searchInfo';
            searchInfo.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 10px 15px;
                font-size: 13px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #ddd;
            `;
            
            searchInfo.innerHTML = `
                <span>
                    <i class="fas fa-search"></i> 
                    ã€Œ${escapeHtml(query)}ã€ã®æ¤œç´¢çµæœ: ${resultCount}ä»¶
                </span>
                <button onclick="clearSearch()" style="
                    background: rgba(255,255,255,0.2);
                    border: 1px solid rgba(255,255,255,0.3);
                    color: white;
                    padding: 4px 10px;
                    border-radius: 15px;
                    font-size: 11px;
                    cursor: pointer;
                ">
                    <i class="fas fa-times"></i> ã‚¯ãƒªã‚¢
                </button>
            `;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å‰ã«æŒ¿å…¥
            const filtersSection = document.querySelector('.filters');
            filtersSection.parentNode.insertBefore(searchInfo, filtersSection);
        }
        
        // æ¤œç´¢æƒ…å ±ã‚’éè¡¨ç¤º
        function hideSearchInfo() {
            const searchInfo = document.getElementById('searchInfo');
            if (searchInfo) {
                searchInfo.remove();
            }
        }
        
        // æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢
        function clearSearch() {
            document.getElementById('searchBox').value = '';
            currentSearchQuery = ''; // æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’ã‚¯ãƒªã‚¢
            updateStoreList(stores);
            updateMapMarkers(stores);
            hideSearchInfo();
        }
        
        // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã™ã‚‹é–¢æ•°
        function highlightSearchTerm(text, searchTerm) {
            if (!text || !searchTerm) return text || '';
            
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            return text.replace(regex, '<mark style="background: #fff3cd; padding: 2px 4px; border-radius: 3px;">$1</mark>');
        }
        
        // æ­£è¦è¡¨ç¾ã®ç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // æ¤œç´¢ã«ãƒãƒƒãƒã—ãŸç†ç”±ã‚’è¡¨ç¤º
        function getMatchReason(store, searchTerm) {
            const lowerQuery = searchTerm.toLowerCase();
            const reasons = [];
            
            if (store.name && store.name.toLowerCase().includes(lowerQuery)) {
                reasons.push('åº—å');
            }
            if (store.address && store.address.toLowerCase().includes(lowerQuery)) {
                reasons.push('ä½æ‰€');
            }
            if (store.category && store.category.toLowerCase().includes(lowerQuery)) {
                reasons.push('ã‚«ãƒ†ã‚´ãƒªãƒ¼');
            }
            if (store.description && store.description.toLowerCase().includes(lowerQuery)) {
                reasons.push('è©³ç´°');
            }
            if (store.nacoComment && store.nacoComment.toLowerCase().includes(lowerQuery)) {
                reasons.push('ã‚³ãƒ¡ãƒ³ãƒˆ');
            }
            if (store.hours && store.hours.toLowerCase().includes(lowerQuery)) {
                reasons.push('å–¶æ¥­æ™‚é–“');
            }
            if (store.closed && store.closed.toLowerCase().includes(lowerQuery)) {
                reasons.push('å®šä¼‘æ—¥');
            }
            
            return reasons.join('ãƒ»');
        }
        
        // ãŠåº—ãƒªã‚¹ãƒˆé–¢é€£ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function isInUserList(storeId, listType) {
            return userStoreLists.some(item => 
                item.store_id === storeId && item.list_type === listType
            );
        }
        
        function getWantToGoButton(storeId) {
            const isAdded = isInUserList(storeId, 'want_to_go');
            const buttonClass = isAdded ? 'user-list-btn active' : 'user-list-btn';
            const icon = isAdded ? 'fas fa-bookmark' : 'far fa-bookmark';
            const text = isAdded ? 'è¡ŒããŸã„æ¸ˆ' : 'è¡ŒããŸã„';
            
            return `
                <button class="${buttonClass}" onclick="event.stopPropagation(); toggleUserList(${storeId}, 'want_to_go')" style="
                    background: ${isAdded ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white'};
                    color: ${isAdded ? 'white' : '#667eea'};
                    border: 2px solid #667eea;
                    padding: 6px 12px;
                    border-radius: 15px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                    flex: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 4px;
                ">
                    <i class="${icon}"></i>
                    <span>${text}</span>
                </button>
            `;
        }
        
        function getVisitedButton(storeId) {
            const isAdded = isInUserList(storeId, 'visited');
            const buttonClass = isAdded ? 'user-list-btn active' : 'user-list-btn';
            const icon = isAdded ? 'fas fa-check-circle' : 'far fa-circle';
            const text = isAdded ? 'è¡Œã£ãŸæ¸ˆ' : 'è¡Œã£ãŸ';
            
            return `
                <button class="${buttonClass}" onclick="event.stopPropagation(); toggleUserList(${storeId}, 'visited')" style="
                    background: ${isAdded ? 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)' : 'white'};
                    color: ${isAdded ? 'white' : '#48bb78'};
                    border: 2px solid #48bb78;
                    padding: 6px 12px;
                    border-radius: 15px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                    flex: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 4px;
                ">
                    <i class="${icon}"></i>
                    <span>${text}</span>
                </button>
            `;
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®ç™»éŒ²ãƒ»å‰Šé™¤å‡¦ç†
        async function toggleUserList(storeId, listType) {
            if (!currentUser) {
                showNotification('ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™', 'error');
                return;
            }
            
            try {
                const isCurrentlyInList = isInUserList(storeId, listType);
                
                if (isCurrentlyInList) {
                    // å‰Šé™¤å‡¦ç†
                    const { error } = await supabase
                        .from('user_store_lists')
                        .delete()
                        .eq('user_id', currentUser.id)
                        .eq('store_id', storeId)
                        .eq('list_type', listType);
                        
                    if (error) throw error;
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‰Šé™¤
                    userStoreLists = userStoreLists.filter(item => 
                        !(item.user_id === currentUser.id && 
                          item.store_id === storeId && 
                          item.list_type === listType)
                    );
                    
                    const actionText = listType === 'want_to_go' ? 'è¡ŒããŸã„' : 'è¡Œã£ãŸ';
                    showNotification(`${actionText}ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
                    
                } else {
                    // è¿½åŠ å‡¦ç†å‰ã«ã€åå¯¾ã®ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ï¼ˆæ’ä»–çš„é¸æŠï¼‰
                    const oppositeListType = listType === 'want_to_go' ? 'visited' : 'want_to_go';
                    const isInOppositeList = isInUserList(storeId, oppositeListType);
                    
                    if (isInOppositeList) {
                        // åå¯¾ã®ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                        const { error: deleteError } = await supabase
                            .from('user_store_lists')
                            .delete()
                            .eq('user_id', currentUser.id)
                            .eq('store_id', storeId)
                            .eq('list_type', oppositeListType);
                            
                        if (deleteError) throw deleteError;
                        
                        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‰Šé™¤
                        userStoreLists = userStoreLists.filter(item => 
                            !(item.user_id === currentUser.id && 
                              item.store_id === storeId && 
                              item.list_type === oppositeListType)
                        );
                    }
                    
                    // è¿½åŠ å‡¦ç†
                    const newItem = {
                        user_id: currentUser.id,
                        store_id: storeId,
                        list_type: listType,
                        created_at: new Date().toISOString()
                    };
                    
                    const { data, error } = await supabase
                        .from('user_store_lists')
                        .insert([newItem])
                        .select();
                        
                    if (error) throw error;
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
                    if (data && data.length > 0) {
                        userStoreLists.push(data[0]);
                    }
                    
                    const actionText = listType === 'want_to_go' ? 'è¡ŒããŸã„' : 'è¡Œã£ãŸ';
                    const oppositeActionText = oppositeListType === 'want_to_go' ? 'è¡ŒããŸã„' : 'è¡Œã£ãŸ';
                    
                    if (isInOppositeList) {
                        showNotification(`${oppositeActionText}ãƒªã‚¹ãƒˆã‹ã‚‰${actionText}ãƒªã‚¹ãƒˆã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');
                    } else {
                        showNotification(`${actionText}ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
                    }
                }
                
                // UIã‚’æ›´æ–°ï¼ˆåº—èˆ—ãƒªã‚¹ãƒˆã‚’å†æç”»ï¼‰
                const currentStores = document.getElementById('storeList').children.length > 0 ? 
                    getCurrentDisplayedStores() : stores;
                updateStoreList(currentStores);
                
            } catch (error) {
                console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ãƒªã‚¹ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹åº—èˆ—ã‚’å–å¾—ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã‚’ç¶­æŒï¼‰
        function getCurrentDisplayedStores() {
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã«å¿œã˜ã¦ç¾åœ¨ã®åº—èˆ—ãƒªã‚¹ãƒˆã‚’è¿”ã™
            let currentStores = stores;
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
            if (activeFilters.categories.size > 0) {
                currentStores = currentStores.filter(store => 
                    activeFilters.categories.has(store.category)
                );
            }
            
            // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
            if (currentSearchQuery) {
                const lowerQuery = currentSearchQuery.toLowerCase();
                currentStores = currentStores.filter(store => {
                    const nameMatch = store.name && store.name.toLowerCase().includes(lowerQuery);
                    const addressMatch = store.address && store.address.toLowerCase().includes(lowerQuery);
                    const categoryMatch = store.category && store.category.toLowerCase().includes(lowerQuery);
                    const descriptionMatch = store.description && store.description.toLowerCase().includes(lowerQuery);
                    const nacoCommentMatch = store.nacoComment && store.nacoComment.toLowerCase().includes(lowerQuery);
                    const hoursMatch = store.hours && store.hours.toLowerCase().includes(lowerQuery);
                    const closedMatch = store.closed && store.closed.toLowerCase().includes(lowerQuery);
                    
                    return nameMatch || addressMatch || categoryMatch || descriptionMatch || 
                           nacoCommentMatch || hoursMatch || closedMatch;
                });
            }
            
            return currentStores;
        }
        
        // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function changeDisplayMode(mode) {
            currentDisplayMode = mode;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.display-mode-btn').forEach(btn => {
                const isActive = btn.dataset.mode === mode;
                btn.classList.toggle('active', isActive);
                
                if (isActive) {
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«
                    if (mode === 'normal') {
                        btn.style.background = 'linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-lavender) 100%)';
                        btn.style.color = 'white';
                    } else if (mode === 'all') {
                        btn.style.background = 'linear-gradient(135deg, #4a5568 0%, #2d3748 100%)';
                        btn.style.color = 'white';
                    } else if (mode === 'want_to_go') {
                        btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        btn.style.color = 'white';
                    } else if (mode === 'visited') {
                        btn.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                        btn.style.color = 'white';
                    }
                } else {
                    // éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«
                    btn.style.background = 'white';
                    if (mode === 'want_to_go') {
                        btn.style.color = '#667eea';
                    } else if (mode === 'visited') {
                        btn.style.color = '#48bb78';
                    } else {
                        btn.style.color = '#333';
                    }
                }
            });
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            updateDisplayForMode();
        }
        
        // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦è¡¨ç¤ºã‚’æ›´æ–°
        function updateDisplayForMode() {
            const filteredStores = getStoresForDisplayMode(currentDisplayMode);
            updateStoreList(filteredStores);
            updateMapMarkers(filteredStores);
            
            // è¡¨ç¤ºä»¶æ•°ã‚’æ›´æ–°
            document.getElementById('visibleStores').textContent = filteredStores.length;
            
            // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸé€šçŸ¥
            const modeNames = {
                'normal': 'é€šå¸¸è¡¨ç¤º',
                'all': 'å…¨è¡¨ç¤ºï¼ˆé€šå¸¸+è¡ŒããŸã„+è¡Œã£ãŸï¼‰',
                'want_to_go': 'è¡ŒããŸã„ãŠåº—',
                'visited': 'è¡Œã£ãŸãŠåº—'
            };
            
            if (currentDisplayMode !== 'normal') {
                showNotification(`${modeNames[currentDisplayMode]}ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, 'info');
            }
        }
        
        // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸåº—èˆ—ã‚’å–å¾—
        function getStoresForDisplayMode(mode) {
            let baseStores = getCurrentDisplayedStores(); // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨æ¸ˆã¿
            
            switch (mode) {
                case 'normal':
                    return baseStores; // é€šå¸¸è¡¨ç¤ºï¼ˆã™ã¹ã¦ã®åº—èˆ—ï¼‰
                    
                case 'all':
                    // å…¨è¡¨ç¤º: é€šå¸¸ + è¡ŒããŸã„ + è¡Œã£ãŸï¼ˆé‡è¤‡é™¤å»ï¼‰
                    return baseStores; // ãƒãƒ¼ã‚«ãƒ¼ã§è¦–è¦šçš„ã«åŒºåˆ¥
                    
                case 'want_to_go':
                    // è¡ŒããŸã„åº—èˆ—ã®ã¿
                    const wantToGoStoreIds = userStoreLists
                        .filter(item => item.list_type === 'want_to_go')
                        .map(item => item.store_id);
                    return baseStores.filter(store => wantToGoStoreIds.includes(store.id));
                    
                case 'visited':
                    // è¡Œã£ãŸåº—èˆ—ã®ã¿
                    const visitedStoreIds = userStoreLists
                        .filter(item => item.list_type === 'visited')
                        .map(item => item.store_id);
                    return baseStores.filter(store => visitedStoreIds.includes(store.id));
                    
                default:
                    return baseStores;
            }
        }

        // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯æ¤œç´¢ã¨å‘¨è¾ºåº—èˆ—è¡¨ç¤º
        async function searchLandmarkAndShowNearbyStores(query) {
            try {
                // 1. ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‹ã‚‰æ¤œç´¢
                const landmark = findLandmarkFromPresets(query);
                if (landmark) {
                    await showStoresNearLocation(landmark, `${query}å‘¨è¾º`);
                    return;
                }

                // 2. ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§æ¤œç´¢
                const geocodedLocation = await geocodeQuery(query);
                if (geocodedLocation) {
                    await showStoresNearLocation(geocodedLocation, `${query}å‘¨è¾º`);
                    return;
                }

                // 3. ã©ã¡ã‚‰ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
                console.log(`âš ï¸ ã€Œ${query}ã€ã«è©²å½“ã™ã‚‹åº—èˆ—ãƒ»å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
                updateStoreList(stores); // å…¨åº—èˆ—ã‚’è¡¨ç¤º

            } catch (error) {
                console.error('âŒ æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                updateStoreList(stores);
            }
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‹ã‚‰æ¤œç´¢
        function findLandmarkFromPresets(query) {
            const queryLower = query.toLowerCase();
            
            // å®Œå…¨ä¸€è‡´æ¤œç´¢
            for (const [name, data] of Object.entries(landmarkDatabase)) {
                if (name.toLowerCase() === queryLower) {
                    console.log(`âœ… ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ç™ºè¦‹: ${name}`);
                    return { lat: data.lat, lng: data.lng, name: name, region: data.region };
                }
            }

            // éƒ¨åˆ†ä¸€è‡´æ¤œç´¢
            for (const [name, data] of Object.entries(landmarkDatabase)) {
                if (name.toLowerCase().includes(queryLower) || queryLower.includes(name.toLowerCase())) {
                    console.log(`âœ… ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ç™ºè¦‹ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰: ${name}`);
                    return { lat: data.lat, lng: data.lng, name: name, region: data.region };
                }
            }

            return null;
        }

        // ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¤œç´¢
        async function geocodeQuery(query) {
            if (!window.locationService) {
                return null;
            }

            try {
                console.log(`ğŸ” ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¤œç´¢: ${query}`);
                const result = await locationService.geocodeAddress(query);
                if (result) {
                    console.log(`âœ… ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æˆåŠŸ:`, result);
                    return { 
                        lat: result.lat, 
                        lng: result.lng, 
                        name: query,
                        address: result.display_name 
                    };
                }
            } catch (error) {
                console.log('âš ï¸ ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å¤±æ•—:', error);
            }

            return null;
        }

        // æŒ‡å®šåœ°ç‚¹å‘¨è¾ºã®åº—èˆ—ã‚’è¡¨ç¤º
        async function showStoresNearLocation(location, searchTitle) {
            try {
                // ãƒãƒƒãƒ—ã‚’æŒ‡å®šåœ°ç‚¹ã«ç§»å‹•
                map.setView([location.lat, location.lng], 13);

                // æ¤œç´¢åœ°ç‚¹ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
                addSearchLocationMarker(location);

                // å‘¨è¾ºåº—èˆ—ã‚’è·é›¢é †ã§å–å¾—ï¼ˆåŠå¾„20kmä»¥å†…ï¼‰
                const storesWithDistance = window.locationService 
                    ? locationService.addDistanceToStores(stores, location)
                    : stores;
                
                const nearbyStores = window.locationService
                    ? locationService.getStoresWithinRadius(stores, 20, location) // 20kmä»¥å†…
                    : stores;

                const sortedStores = window.locationService
                    ? locationService.sortByDistance(nearbyStores)
                    : nearbyStores;

                // è¡¨ç¤ºã‚’æ›´æ–°
                updateStoreList(sortedStores);
                updateMapMarkers(sortedStores);

                // æˆåŠŸãƒ­ã‚°
                console.log(`âœ… ${searchTitle} å‘¨è¾ºåº—èˆ—è¡¨ç¤ºå®Œäº†: ${sortedStores.length}ä»¶`);

            } catch (error) {
                console.error('âŒ å‘¨è¾ºåº—èˆ—è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // æ¤œç´¢åœ°ç‚¹ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
        function addSearchLocationMarker(location) {
            // æ—¢å­˜ã®æ¤œç´¢ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
            if (window.searchLocationMarker) {
                map.removeLayer(window.searchLocationMarker);
            }

            // æ¤œç´¢åœ°ç‚¹ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
            const iconHtml = `
                <div class="search-location-marker">
                    <i class="fas fa-search"></i>
                </div>
            `;
            
            const customIcon = L.divIcon({
                html: iconHtml,
                className: 'search-location-wrapper',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            window.searchLocationMarker = L.marker([location.lat, location.lng], { 
                icon: customIcon,
                zIndexOffset: 900
            }).addTo(map);

            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¿½åŠ 
            const popupContent = `
                <div class="search-popup">
                    <h4>${location.name}</h4>
                    ${location.region ? `<p class="region">${location.region}</p>` : ''}
                    ${location.address ? `<p class="address">${location.address}</p>` : ''}
                </div>
            `;
            window.searchLocationMarker.bindPopup(popupContent);
        }

        // Global state for filters and search
        let activeFilters = {
            categories: new Set()
        };
        let currentSearchQuery = '';
        let currentDisplayMode = 'normal'; // 'normal', 'all', 'want_to_go', 'visited'
        
        // Handle filter with multiple selection support
        function handleFilter(event) {
            const button = event.target.closest('.filter-btn');
            const category = button.dataset.category;
            
            if (category === 'all') {
                // Clear all category filters
                activeFilters.categories.clear();
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');
            } else {
                // Toggle category filter
                document.querySelector('.filter-btn[data-category="all"]').classList.remove('active');
                
                if (activeFilters.categories.has(category)) {
                    activeFilters.categories.delete(category);
                    button.classList.remove('active');
                } else {
                    activeFilters.categories.add(category);
                    button.classList.add('active');
                }
                
                // If no filters active, activate "all"
                if (activeFilters.categories.size === 0) {
                    document.querySelector('.filter-btn[data-category="all"]').classList.add('active');
                }
            }
            
            applyAllFilters();
        }
        
        // Apply all active filters
        function applyAllFilters() {
            let filtered = stores;
            
            // Apply category filters
            if (activeFilters.categories.size > 0) {
                filtered = filtered.filter(store => 
                    activeFilters.categories.has(store.category)
                );
            }
            
            // Update displays with filtered results
            updateStoreList(filtered);
            updateMapMarkers(filtered);
        }

        // Update user UI
        function updateUserUI(isLoggedIn) {
            const loginSection = document.getElementById('loginSection');
            const userSection = document.getElementById('userSection');
            const userAvatar = document.getElementById('userAvatar');
            const displayModeSection = document.getElementById('displayModeSection');

            if (isLoggedIn && currentUser) {
                loginSection.style.display = 'none';
                userSection.style.display = 'flex';
                displayModeSection.style.display = 'block'; // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                
                // Set avatar initial
                const name = currentUser.user_metadata?.full_name || currentUser.email;
                userAvatar.textContent = name.charAt(0).toUpperCase();
            } else {
                loginSection.style.display = 'block';
                userSection.style.display = 'none';
                displayModeSection.style.display = 'none'; // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                
                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã¯é€šå¸¸è¡¨ç¤ºã«æˆ»ã™
                currentDisplayMode = 'normal';
            }
        }

        // Handle login
        async function handleLogin() {
            try {
                console.log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†é–‹å§‹');
                
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.href
                    }
                });

                if (error) throw error;

            } catch (error) {
                console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                console.log('ğŸ”“ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†é–‹å§‹');
                
                const { error } = await supabase.auth.signOut();
                if (error) throw error;

                showNotification('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'success');

            } catch (error) {
                console.error('âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // Open review modal
        function openReviewModal(storeId, storeName) {
            if (!currentUser) {
                showNotification('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™', 'error');
                return;
            }

            const modal = document.getElementById('reviewModal');
            const title = document.getElementById('reviewModalTitle');
            const body = document.getElementById('reviewModalBody');

            title.innerHTML = `<i class="fas fa-heart"></i> ${storeName} ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼`;
            
            body.innerHTML = `
                <div class="review-form">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-comment-alt"></i>
                            ã‚³ãƒ¡ãƒ³ãƒˆ
                        </label>
                        <textarea class="form-textarea" id="reviewComment" placeholder="ã“ã®ãŠåº—ã®ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼å¯¾å¿œã«ã¤ã„ã¦ã€ã¿ã‚“ãªã«ã‚·ã‚§ã‚¢ã—ã¾ã—ã‚‡ã†â™ª" required></textarea>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="reviewVisited">
                            <label for="reviewVisited">å®Ÿéš›ã«è¨ªå•ã—ã¾ã—ãŸ</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn-primary" onclick="submitReview(${storeId})">
                            <i class="fas fa-heart"></i> ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿
                        </button>
                        <button class="btn-secondary" onclick="closeReviewModal()">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                    <div id="reviewMessage"></div>
                </div>
            `;

            modal.style.display = 'flex';
        }

        // Close review modal
        function closeReviewModal() {
            document.getElementById('reviewModal').style.display = 'none';
        }

        // Submit review
        async function submitReview(storeId) {
            const comment = document.getElementById('reviewComment').value.trim();
            const visited = document.getElementById('reviewVisited').checked;
            const messageDiv = document.getElementById('reviewMessage');

            if (!comment) {
                messageDiv.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-circle"></i>ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
                return;
            }

            try {
                const { error } = await supabase
                    .from('store_reviews')
                    .insert({
                        store_id: storeId,
                        user_id: currentUser.id,
                        comment: comment,
                        visited: visited,
                        rating: 5 // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè©•ä¾¡
                    });

                if (error) throw error;

                messageDiv.innerHTML = '<div class="success-message"><i class="fas fa-check-circle"></i>ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼</div>';
                
                // Reload reviews
                await loadReviews();
                updateStats();
                
                setTimeout(() => {
                    closeReviewModal();
                    showNotification('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æŠ•ç¨¿ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼', 'success');
                }, 2000);

            } catch (error) {
                console.error('âŒ ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error);
                messageDiv.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-circle"></i>ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // Show floating notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `floating-notification ${type === 'error' ? 'error-message' : 'success-message'}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                ${message}
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 4000);
        }

        // Location service functions
        function initLocationService() {
            if (typeof window.locationService === 'undefined') {
                console.warn('âš ï¸ LocationService not available');
                return;
            }
            console.log('ğŸ“ LocationServiceåˆæœŸåŒ–å®Œäº†');
        }

        // Pin mode functions
        function togglePinMode() {
            pinModeActive = !pinModeActive;
            const pinBtn = document.getElementById('pinModeBtn');
            
            if (pinModeActive) {
                pinBtn.classList.add('active');
                map.getContainer().style.cursor = 'crosshair';
                showNotification('ğŸ“Œ åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ”ãƒ³ã‚’ç«‹ã¦ã¦ãã ã•ã„', 'info');
            } else {
                pinBtn.classList.remove('active');
                map.getContainer().style.cursor = '';
                showNotification('ãƒ”ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã¾ã—ãŸ', 'info');
            }
        }

        // Create user pin marker
        function createUserPin(lat, lng) {
            // Remove existing user pin
            if (userPin) {
                map.removeLayer(userPin);
            }

            const iconHtml = `<div class="user-pin-marker"></div>`;
            
            const customIcon = L.divIcon({
                html: iconHtml,
                className: 'user-pin-wrapper',
                iconSize: [32, 32],
                iconAnchor: [16, 30]
            });

            userPin = L.marker([lat, lng], { 
                icon: customIcon,
                zIndexOffset: 1100
            }).addTo(map);

            const popupContent = `
                <div class="pin-popup">
                    <h4>ğŸ“Œ æŒ‡å®šåœ°ç‚¹</h4>
                    <p>ã“ã®åœ°ç‚¹ã‹ã‚‰è¿‘ã„åº—èˆ—é †ã«è¡¨ç¤ºã—ã¦ã„ã¾ã™</p>
                    <button onclick="removeUserPin()" style="
                        background: #ff4757;
                        color: white;
                        border: none;
                        padding: 6px 12px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 12px;
                        margin-top: 8px;
                    ">ãƒ”ãƒ³ã‚’å‰Šé™¤</button>
                </div>
            `;
            userPin.bindPopup(popupContent);

            return userPin;
        }

        // Remove user pin
        function removeUserPin() {
            if (userPin) {
                map.removeLayer(userPin);
                userPin = null;
                updateStoreList(stores); // Reset to original order
                showNotification('ãƒ”ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }

        // Show stores near user pin
        function showStoresNearUserPin(lat, lng) {
            if (!window.locationService) {
                console.warn('LocationService not available for user pin');
                return;
            }

            try {
                const pinLocation = { lat, lng };
                
                // Calculate distances and sort
                const storesWithDistance = locationService.addDistanceToStores(stores, pinLocation);
                const sortedStores = locationService.sortByDistance(storesWithDistance);
                
                // Update display
                updateStoreList(sortedStores);
                updateMapMarkers(sortedStores);
                
                console.log(`âœ… æŒ‡å®šåœ°ç‚¹å‘¨è¾ºã®åº—èˆ— ${sortedStores.length}ä»¶ã‚’è·é›¢é †ã§è¡¨ç¤º`);
                
            } catch (error) {
                console.error('âŒ ãƒ”ãƒ³å‘¨è¾ºåº—èˆ—è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // Auto-detect user location on app startup
        async function autoDetectLocation() {
            if (typeof window.locationService === 'undefined') {
                console.warn('âš ï¸ LocationService not available for auto-detection');
                return;
            }

            // Check if geolocation is supported
            if (!locationService.isSupported()) {
                console.log('ğŸ“ ä½ç½®æƒ…å ±APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            try {
                console.log('ğŸ“ è‡ªå‹•ç¾åœ¨åœ°å–å¾—ã‚’é–‹å§‹ï¼ˆé™ã‹ã«å®Ÿè¡Œï¼‰...');
                
                // åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿ã€ä½ç½®æƒ…å ±è¨±å¯ã‚’ä¿ƒã™
                const hasLocationPermission = localStorage.getItem('locationPermissionGranted');
                if (!hasLocationPermission) {
                    showNotification('ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦æœ€å¯„ã‚Šã®åº—èˆ—ã‚’è¡¨ç¤ºã—ã¾ã™', 'info');
                }
                
                // Try to get current position with a shorter timeout for initial load
                const location = await locationService.getCurrentPosition({
                    timeout: 8000, // 8ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                    enableHighAccuracy: false // åˆæœŸå–å¾—ã¯ä½ç²¾åº¦ã§ã‚‚é€Ÿåº¦å„ªå…ˆ
                });
                
                if (location) {
                    console.log('âœ… è‡ªå‹•ç¾åœ¨åœ°å–å¾—æˆåŠŸ:', location);
                    
                    // ä½ç½®æƒ…å ±è¨±å¯ã‚’è¨˜éŒ²
                    localStorage.setItem('locationPermissionGranted', 'true');
                    
                    // Create and add current location marker
                    if (window.currentLocationMarker) {
                        map.removeLayer(window.currentLocationMarker);
                        if (window.currentLocationMarker.accuracyCircle) {
                            map.removeLayer(window.currentLocationMarker.accuracyCircle);
                        }
                    }
                    
                    const marker = locationService.createCurrentLocationMarker(location);
                    window.currentLocationMarker = marker;
                    
                    marker.addTo(map);
                    if (marker.accuracyCircle) {
                        marker.accuracyCircle.addTo(map);
                    }
                    
                    // Move map to current location
                    map.setView([location.lat, location.lng], 14);
                    
                    // Update store list with distance sorting
                    updateStoreList(stores);
                    
                    // è‡ªå‹•å–å¾—æ™‚ã¯é€šçŸ¥ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆé™ã‹ã«å®Ÿè¡Œï¼‰
                    console.log('âœ… è‡ªå‹•ç¾åœ¨åœ°å–å¾—å®Œäº†ï¼šåº—èˆ—ãƒªã‚¹ãƒˆã‚’è·é›¢é †ã§æ›´æ–°ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.log('ğŸ“ è‡ªå‹•ç¾åœ¨åœ°å–å¾—ã‚’ã‚¹ã‚­ãƒƒãƒ—:', error.message);
                // Don't show error notification for auto-detection failure
                // User can still manually get location if needed
            }
        }


        async function getCurrentLocation() {
            if (typeof window.locationService === 'undefined') {
                showNotification('ä½ç½®æƒ…å ±ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                return;
            }

            try {
                showNotification('ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...', 'info');
                
                const location = await locationService.getCurrentPosition();
                
                if (location) {
                    // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆãƒ»è¿½åŠ 
                    if (window.currentLocationMarker) {
                        map.removeLayer(window.currentLocationMarker);
                        if (window.currentLocationMarker.accuracyCircle) {
                            map.removeLayer(window.currentLocationMarker.accuracyCircle);
                        }
                    }
                    
                    const marker = locationService.createCurrentLocationMarker(location);
                    window.currentLocationMarker = marker;
                    
                    marker.addTo(map);
                    if (marker.accuracyCircle) {
                        marker.accuracyCircle.addTo(map);
                    }
                    
                    // ç¾åœ¨åœ°ã«ãƒãƒƒãƒ—ã‚’ç§»å‹•
                    map.setView([location.lat, location.lng], 15);
                    
                    showNotification('ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸ', 'success');
                } else {
                    showNotification('ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('âŒ ç¾åœ¨åœ°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }


        // Utility functions
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize when DOM is loaded
        // DOMContentLoaded removed - initApp called after auth check

        // Handle modal clicks outside content
        document.getElementById('reviewModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeReviewModal();
            }
        });

        // Store detail modal event listeners
        document.getElementById('storeDetailModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeStoreDetailModal();
            }
        });

        // Lightbox modal event listeners
        document.getElementById('lightboxModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeLightbox();
            }
        });

        // Global variables for lightbox
        let currentImages = [];
        let currentImageIndex = 0;
        
        // Helper functions for store details
        function formatBusinessHours(hours) {
            if (!hours) return 'å–¶æ¥­æ™‚é–“æƒ…å ±ãªã—';
            // Parse business hours if it's in a structured format
            if (typeof hours === 'object') {
                return Object.entries(hours)
                    .map(([day, time]) => `${day}: ${time}`)
                    .join('<br>');
            }
            return hours;
        }
        
        
        function isOpenNow(hours) {
            // Simple check for current time
            const now = new Date();
            const currentHour = now.getHours();
            const currentDay = now.getDay();
            
            // This is a simplified check - would need proper parsing of hours format
            if (!hours) return null;
            
            // Return null if we can't determine
            return null;
        }

        // Show store detail modal
        function showStoreDetail(storeId) {
            const store = stores.find(s => s.id === storeId);
            if (!store) {
                console.error('Store not found:', storeId);
                return;
            }

            // Set title with category badge
            const categoryStyle = getCategoryMarkerStyle(store.category);
            document.getElementById('storeDetailTitle').innerHTML = `
                <div class="modal-store-name">${escapeHtml(store.name)}</div>
                <div class="modal-category-badge">${escapeHtml(store.category)}</div>
            `;

            // Create images array
            currentImages = [];
            if (store.image_url) currentImages.push(store.image_url);
            if (store.image_url_2) currentImages.push(store.image_url_2);
            if (store.image_url_3) currentImages.push(store.image_url_3);
            // äº’æ›æ€§ã®ãŸã‚æ—§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚å¯¾å¿œ
            if (store.imageUrl) currentImages.push(store.imageUrl);
            if (store.imageUrl2) currentImages.push(store.imageUrl2);
            if (store.imageUrl3) currentImages.push(store.imageUrl3);

            // Build store detail content
            const detailBody = document.getElementById('storeDetailBody');
            detailBody.innerHTML = `
                <div class="store-images-container">
                    <div class="main-image" onclick="openLightbox(0)">
                        ${currentImages[0] ? 
                            `<img src="${currentImages[0]}" alt="${store.name}">` : 
                            '<div class="image-placeholder">ç”»åƒãªã—</div>'
                        }
                    </div>
                    <div class="secondary-images">
                        <div class="secondary-image" onclick="openLightbox(1)">
                            ${currentImages[1] ? 
                                `<img src="${currentImages[1]}" alt="${store.name}">` : 
                                '<div class="image-placeholder">ç”»åƒãªã—</div>'
                            }
                        </div>
                        <div class="secondary-image" onclick="openLightbox(2)">
                            ${currentImages[2] ? 
                                `<img src="${currentImages[2]}" alt="${store.name}">` : 
                                '<div class="image-placeholder">ç”»åƒãªã—</div>'
                            }
                        </div>
                    </div>
                </div>

                <div class="store-detail-info">
                    <div class="store-detail-section">
                        <h4><i class="fas fa-map-marker-alt"></i> ä½æ‰€</h4>
                        <p>${store.address || 'ä½æ‰€æƒ…å ±ãªã—'}</p>
                        ${store.lat && store.lng && window.locationService && locationService.getCurrentLocation() ? `
                            <p style="color: #4CAF50; font-size: 14px; margin-top: 8px;">
                                <i class="fas fa-route"></i> 
                                ç¾åœ¨åœ°ã‹ã‚‰ ${locationService.formatDistance(
                                    locationService.calculateDistance(
                                        locationService.getCurrentLocation().lat,
                                        locationService.getCurrentLocation().lng,
                                        store.lat,
                                        store.lng
                                    )
                                )}
                            </p>
                        ` : ''}
                    </div>

                    <div class="store-detail-section">
                        <h4><i class="fas fa-clock"></i> å–¶æ¥­æ™‚é–“</h4>
                        <p>${formatBusinessHours(store.hours || store.business_hours)}</p>
                    </div>

                    ${store.closed || store.holiday ? `
                        <div class="store-detail-section">
                            <h4><i class="fas fa-calendar-times"></i> å®šä¼‘æ—¥</h4>
                            <p>${store.closed || store.holiday}</p>
                        </div>
                    ` : ''}
                    
                    ${store.phone ? `
                        <div class="store-detail-section">
                            <h4><i class="fas fa-phone"></i> é›»è©±ç•ªå·</h4>
                            <p><a href="tel:${store.phone}" style="color: #4CAF50; text-decoration: none;">${store.phone}</a></p>
                        </div>
                    ` : ''}

                    ${store.description ? `
                        <div class="store-detail-section">
                            <h4><i class="fas fa-info-circle"></i> è©³ç´°</h4>
                            <p>${store.description}</p>
                        </div>
                    ` : ''}

                    ${store.nacoComment ? `
                        <div class="store-detail-section">
                            <h4><i class="fas fa-user-circle"></i> nacoã•ã‚“ã®ã‚³ãƒ¡ãƒ³ãƒˆ</h4>
                            <p style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary);">${store.nacoComment}</p>
                        </div>
                    ` : ''}

                    <div class="store-actions">
                        ${store.lat && store.lng ? `
                            <button class="store-action-btn" onclick="showOnMap(${store.id}); closeStoreDetailModal();">
                                <i class="fas fa-map"></i> åœ°å›³ã§è¡¨ç¤º
                            </button>
                        ` : ''}
                        
                        ${store.website ? `
                            <a href="${store.website}" target="_blank" class="store-action-btn">
                                <i class="fas fa-globe"></i> ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ
                            </a>
                        ` : ''}
                        
                        ${store.instagram ? `
                            <a href="${store.instagram}" target="_blank" class="store-action-btn">
                                <i class="fab fa-instagram"></i> Instagram
                            </a>
                        ` : ''}
                        
                        ${store.googleMapsUrl || (store.lat && store.lng) ? `
                            <a href="${store.googleMapsUrl || `https://www.google.com/maps?q=${store.lat},${store.lng}`}" target="_blank" class="store-action-btn">
                                <i class="fas fa-directions"></i> Google Maps
                            </a>
                        ` : ''}

                        <button class="store-action-btn" onclick="openReviewModal(${store.id})">
                            <i class="fas fa-star"></i> ãƒ¬ãƒ“ãƒ¥ãƒ¼
                        </button>
                    </div>
                </div>
            `;

            // Show modal with animation
            const modal = document.getElementById('storeDetailModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        // Close store detail modal
        function closeStoreDetailModal() {
            const modal = document.getElementById('storeDetailModal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // Open lightbox
        function openLightbox(imageIndex) {
            if (!currentImages || currentImages.length === 0) return;
            
            currentImageIndex = imageIndex;
            const image = currentImages[currentImageIndex];
            
            if (image) {
                document.getElementById('lightboxImage').src = image;
                document.getElementById('lightboxCounter').textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
                document.getElementById('lightboxModal').style.display = 'flex';
            }
        }

        // Close lightbox
        function closeLightbox() {
            document.getElementById('lightboxModal').style.display = 'none';
        }

        // Navigate to previous image
        function prevImage() {
            if (currentImages.length === 0) return;
            currentImageIndex = currentImageIndex > 0 ? currentImageIndex - 1 : currentImages.length - 1;
            document.getElementById('lightboxImage').src = currentImages[currentImageIndex];
            document.getElementById('lightboxCounter').textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
        }

        // Navigate to next image
        function nextImage() {
            if (currentImages.length === 0) return;
            currentImageIndex = currentImageIndex < currentImages.length - 1 ? currentImageIndex + 1 : 0;
            document.getElementById('lightboxImage').src = currentImages[currentImageIndex];
            document.getElementById('lightboxCounter').textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
        }

        // Keyboard navigation for lightbox
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('lightboxModal').style.display === 'flex') {
                switch(e.key) {
                    case 'Escape':
                        closeLightbox();
                        break;
                    case 'ArrowLeft':
                        prevImage();
                        break;
                    case 'ArrowRight':
                        nextImage();
                        break;
                }
            }
        });

        // é…å»¶èª­ã¿è¾¼ã¿ç”»åƒã‚’ä½œæˆ
        function createLazyImage(src, alt, className = '') {
            const imgId = 'lazy-img-' + Math.random().toString(36).substr(2, 9);
            
            // DOMãŒæ›´æ–°ã•ã‚ŒãŸå¾Œã«é…å»¶èª­ã¿è¾¼ã¿ã‚’ç™»éŒ²
            setTimeout(() => {
                const img = document.getElementById(imgId);
                if (img) {
                    performanceManager.registerLazyImage(img, src, alt);
                }
            }, 100);
            
            return `<img id="${imgId}" alt="${escapeHtml(alt)}" class="${className} lazy-image">`;
        }

        // Make functions globally available for onclick handlers
        window.openReviewModal = openReviewModal;
        window.closeReviewModal = closeReviewModal;
        window.submitReview = submitReview;
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        window.selectStore = selectStore;
        window.showOnMap = showOnMap;
        window.createLazyImage = createLazyImage;
        
        // ãƒšãƒ¼ã‚¸ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (window.performanceManager) {
                performanceManager.cleanup();
            }
        });
        
        // ç·Šæ€¥ä¿®æ­£: ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ nacoã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒƒãƒ—åˆæœŸåŒ–é–‹å§‹...');
            
            // å¼·åˆ¶ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤ï¼ˆ15ç§’å¾Œï¼‰
            setTimeout(() => {
                console.warn('â° å¼·åˆ¶ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤');
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay && !loadingOverlay.classList.contains('hidden')) {
                    loadingOverlay.classList.add('hidden');
                    console.log('ğŸ”§ ç·Šæ€¥ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤å®Ÿè¡Œ');
                }
            }, 15000);
            
            try {
                // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
                let attempts = 0;
                while (!window.supabase && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.supabase) {
                    throw new Error('Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // åŸºæœ¬åˆæœŸåŒ–
                supabase = window.supabase;
                
                // ãƒãƒƒãƒ—åˆæœŸåŒ–
                if (typeof initMap === 'function') {
                    await initMap();
                }
                
                // åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
                try {
                    if (typeof loadStores === 'function') {
                        await Promise.race([
                            loadStores(),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')), 10000)
                            )
                        ]);
                    }
                } catch (storeError) {
                    console.warn('âš ï¸ åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—:', storeError);
                    // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãªã—ã§ã‚‚ç¶šè¡Œ
                }
                
                // ãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ãƒ‰ãƒãƒ¼åˆæœŸåŒ–
                if (typeof initMobileSidebar === 'function') {
                    initMobileSidebar();
                }
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                }
                
                console.log('âœ… nacoã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒƒãƒ—åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                }
                
                // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                document.body.innerHTML += `
                    <div style="
                        position: fixed; top: 50%; left: 50%; 
                        transform: translate(-50%, -50%); 
                        background: white; padding: 2rem; 
                        border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                        text-align: center; z-index: 10000;
                    ">
                        <h3>ã‚¢ãƒ—ãƒªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</h3>
                        <p>ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
                        <button onclick="location.reload()" style="
                            background: #FFB6C1; border: none; padding: 0.5rem 1rem; 
                            border-radius: 5px; cursor: pointer; margin-top: 1rem;
                        ">ãƒªãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>