<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
    <title>„Ç∞„É´„ÉÜ„É≥„Éï„É™„Éº„Éû„ÉÉ„Éó - naco„Ç≥„Éü„É•„Éã„ÉÜ„Ç£</title>
    <link rel="icon" href="favicon.png" type="image/png">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CL6YY713PG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-CL6YY713PG');
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Comfortaa:wght@300;400;700&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- „Çª„Ç≠„É•„É™„ÉÜ„Ç£„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ -->
    <script src="security-utils.js"></script>
    <!-- „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞ -->
    <script src="error-handler.js"></script>
    <!-- „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÁÆ°ÁêÜ -->
    <script src="performance-manager.js"></script>
    <!-- ‰ΩçÁΩÆÊÉÖÂ†±„Çµ„Éº„Éì„Çπ -->
    <script src="location-service.js"></script>
    
    <style>
        :root {
            /* ÂâçÂõû„ÅÆ„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„Å´Ëøë„ÅÑ„Éë„Çπ„ÉÜ„É´„Ç´„É©„Éº */
            --primary-pink: #FFB6C1;      /* „Çà„ÇäÈÆÆ„ÇÑ„Åã„Å™„Éî„É≥„ÇØ */
            --secondary-mint: #98D8C8;    /* „Éü„É≥„Éà„Ç∞„É™„Éº„É≥ */
            --accent-lavender: #DDA0DD;   /* „É©„Éô„É≥„ÉÄ„Éº */
            --accent-peach: #FFDAB9;      /* „Éî„Éº„ÉÅ„Éó„É´ */
            --accent-sky: #B0E0E6;        /* „Éë„Ç¶„ÉÄ„Éº„Éñ„É´„Éº */
            --accent-yellow: #F0E68C;     /* „Ç´„Éº„Ç≠ */
            
            /* „Éô„Éº„Çπ„Ç´„É©„Éº */
            --white: #ffffff;
            --cream: #FFF8F5;             /* „ÇØ„É™„Éº„É† */
            --light-gray: #F0F8FF;        /* „É©„Ç§„Éà„Éñ„É´„Éº„Ç∞„É¨„Éº */
            --text-dark: #4A4A4A;         /* „ÇΩ„Éï„Éà„Ç∞„É¨„Éº */
            --text-light: #8A8A8A;
            
            /* „Ç∑„É£„Éâ„Ç¶ */
            --shadow-soft: rgba(255, 182, 193, 0.3);
            --shadow-medium: rgba(255, 182, 193, 0.4);
            --shadow-strong: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #FFF 50%, var(--accent-sky) 100%);
            color: var(--text-dark);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--secondary-mint) 100%);
            color: var(--text-dark);
            padding: 1.2rem;
            box-shadow: 0 4px 20px var(--shadow-soft);
            position: relative;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-family: 'Comfortaa', 'Noto Sans JP', cursive;
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            color: #4A4A4A;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8);
            letter-spacing: 0.5px;
        }
        
        .logo-text {
            color: #2D2D2D;
            font-weight: 700;
            position: relative;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
        }
        
        .logo-text::after {
            content: '‚ú®';
            position: absolute;
            top: -8px;
            right: -15px;
            font-size: 1rem;
            color: var(--primary-pink);
            animation: sparkle 2s ease-in-out infinite;
        }
        
        /* „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes gradient-shift {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }
        
        /* „Çπ„Éë„Éº„ÇØ„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes sparkle {
            0%, 100% {
                opacity: 0.7;
                transform: scale(1) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.2) rotate(180deg);
            }
        }

        .naco-character {
            width: 58px;
            height: 58px;
            background-image: url('naco-character.png.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-right: 0.8rem;
            border-radius: 50%;
            box-shadow: 0 3px 12px rgba(255, 182, 193, 0.4);
            animation: gentle-float 3s ease-in-out infinite;
        }

        /* naco„Ç≠„É£„É©„ÇØ„Çø„Éº„Å´„Éõ„Éê„ÉºÊôÇ„ÅÆÂèçÂøú„ÇíËøΩÂä† */
        .naco-character:hover {
            animation-duration: 1.5s; /* „Éõ„Éê„ÉºÊôÇ„ÅØÂ∞ë„ÅóÊó©„Åè */
            cursor: pointer;
            transform: scale(1.05);
        }

        /* naco„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂÑ™„Åó„ÅÑÊµÆÈÅä„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes gentle-float {
            0%, 100% {
                transform: translateY(0px);
                box-shadow: 0 3px 12px rgba(255, 182, 193, 0.4);
            }
            50% {
                transform: translateY(-6px);
                box-shadow: 0 8px 20px rgba(255, 182, 193, 0.5);
            }
        }
        
        .logo i {
            font-size: 1.8rem;
            color: var(--secondary-mint);
        }

        .community-badge {
            font-family: 'Kalam', 'Noto Sans JP', cursive;
            background: var(--white);
            color: var(--primary-pink);
            padding: 0.4rem 1rem;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 400;
            margin-left: 1rem;
            box-shadow: 0 3px 15px var(--shadow-soft);
            border: 2px solid var(--primary-pink);
            position: relative;
            overflow: hidden;
        }
        
        .community-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: badge-shine 3s ease-in-out infinite;
        }
        
        @keyframes badge-shine {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .auth-btn {
            background: var(--white);
            border: 2px solid var(--primary-pink);
            color: var(--primary-pink);
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auth-btn:hover {
            background: var(--primary-pink);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--shadow-medium);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-mint);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 500;
            box-shadow: 0 2px 10px var(--shadow-soft);
        }


        /* Main Container */
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
            max-width: 1200px;
            margin: 0 auto;
            gap: 1rem;
            padding: 1rem;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 8px 30px var(--shadow-soft);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px); /* „Çà„ÇäÂ§ö„Åè„ÅÆÈ´ò„Åï„ÇíÁ¢∫‰øù */
        }

        .search-header, .sidebar-header {
            background: linear-gradient(135deg, var(--accent-peach) 0%, var(--secondary-mint) 100%);
            padding: 1rem;
            text-align: center;
        }

        .search-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 0.6rem;
        }
        
        .mobile-title {
            display: none;
        }
        
        .desktop-title {
            display: inline;
        }

        .search-box {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            background: var(--white);
            box-shadow: inset 0 1px 8px var(--shadow-soft);
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            box-shadow: inset 0 2px 10px var(--shadow-medium), 0 0 0 3px var(--primary-pink);
        }

        .search-box::placeholder {
            color: var(--text-light);
        }

        /* Compact Sidebar Stats */
        .sidebar-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 0.5rem;
            padding: 0.5rem 0.8rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }

        .sidebar-stat-item {
            text-align: center;
            flex: 1;
        }

        .sidebar-stat-number {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-pink);
            margin-bottom: 0.1rem;
        }

        .sidebar-stat-label {
            font-size: 0.65rem;
            color: var(--text-light);
            font-weight: 400;
            line-height: 1;
        }

        .filters {
            padding: 0.6rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.3rem;
        }

        .filter-btn {
            background: var(--light-gray);
            border: none;
            color: var(--text-dark);
            padding: 0.4rem 0.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 400;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.2rem;
            white-space: nowrap;
        }
        
        .filter-btn i {
            font-size: 0.8rem;
        }

        .filter-btn.active {
            color: var(--white);
            transform: scale(1.05);
            box-shadow: 0 4px 15px var(--shadow-medium);
        }

        /* „Ç´„ÉÜ„Ç¥„É™Âà•„Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÅÆÊ¥óÁ∑¥„Åï„Çå„Åü„Ç´„É©„Éº */
        .filter-btn[data-category="all"].active {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-lavender) 100%);
            box-shadow: 0 4px 15px rgba(255, 182, 193, 0.4);
        }

        .filter-btn[data-category="ÂíåÈ£ü"].active {
            background: linear-gradient(135deg, #ffffff 0%, #E67E22 100%);
            box-shadow: 0 4px 15px rgba(230, 126, 34, 0.4);
            border: 1px solid #E67E22;
        }

        .filter-btn[data-category="Ê¥ãÈ£ü"].active {
            background: linear-gradient(135deg, #ffffff 0%, #27AE60 100%);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            border: 1px solid #27AE60;
        }

        .filter-btn[data-category="„Ç´„Éï„Çß"].active {
            background: linear-gradient(135deg, #ffffff 0%, #8B4513 100%);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.4);
            border: 1px solid #8B4513;
        }

        .filter-btn[data-category="„Çπ„Ç§„Éº„ÉÑ"].active {
            background: linear-gradient(135deg, #ffffff 0%, #E91E63 100%);
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
            border: 1px solid #E91E63;
        }

        .filter-btn[data-category="„Éë„É≥Â±ã"].active {
            background: linear-gradient(135deg, #ffffff 0%, #8E44AD 100%);
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.4);
            border: 1px solid #8E44AD;
        }

        .filter-btn[data-category="Ë≤©Â£≤Â∫ó"].active {
            background: linear-gradient(135deg, #ffffff 0%, #FFD700 100%);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            border: 1px solid #FFD700;
        }

        .filter-btn:hover:not(.active) {
            background: var(--accent-sky);
            transform: translateY(-1px);
        }

        /* Store List */
        .store-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÅÆ„Çπ„Çø„Ç§„É™„É≥„Ç∞ */
            scrollbar-width: thin;
            scrollbar-color: var(--primary-pink) transparent;
        }
        
        .store-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .store-list::-webkit-scrollbar-track {
            background: rgba(255, 182, 193, 0.1);
            border-radius: 4px;
        }
        
        .store-list::-webkit-scrollbar-thumb {
            background: var(--primary-pink);
            border-radius: 4px;
            opacity: 0.7;
        }
        
        .store-list::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-mint);
            opacity: 1;
        }

        .store-item {
            background: linear-gradient(135deg, var(--white) 0%, var(--cream) 100%);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 0.8rem; /* „Éë„Éá„Ç£„É≥„Ç∞„ÇíÂ∞ë„ÅóÁ∏ÆÂ∞è */
            margin-bottom: 0.5rem; /* „Éû„Éº„Ç∏„É≥„ÇíÁ∏ÆÂ∞è„Åó„Å¶„Çà„ÇäÂ§ö„ÅèË°®Á§∫ */
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 3px 15px var(--shadow-soft);
        }

        .store-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--shadow-medium);
            border-color: var(--primary-pink);
        }

        .store-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.4rem; /* „Éû„Éº„Ç∏„É≥„ÇíÁ∏ÆÂ∞è */
        }

        .store-name {
            font-weight: 600;
            font-size: 1.0rem; /* „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÇíÂ∞ë„ÅóÁ∏ÆÂ∞è */
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            line-height: 1.2; /* Ë°åÈñì„ÇíË™øÊï¥ */
        }

        .store-distance {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
            color: var(--primary-pink);
            font-weight: 500;
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.1), rgba(255, 192, 203, 0.2));
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 182, 193, 0.3);
            white-space: nowrap;
            min-width: fit-content;
        }

        .store-distance i {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Êñ∞„Åó„ÅÑÂ∫óËàó„Ç´„ÉÜ„Ç¥„É™„Éá„Ç∂„Ç§„É≥ */
        .store-category-wrapper {
            margin-bottom: 0.6rem; /* „Éû„Éº„Ç∏„É≥„ÇíÁ∏ÆÂ∞è */
        }

        .store-category-new {
            display: inline-block;
            color: white;
            padding: 4px 10px; /* „Éë„Éá„Ç£„É≥„Ç∞„ÇíÁ∏ÆÂ∞è */
            border-radius: 16px;
            font-size: 0.75rem; /* „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÇíÂ∞è„Åï„Åè */
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2); /* „Éú„Éº„ÉÄ„Éº„ÇíÁ∑öÁ¥∞„Å´ */
        }

        /* Â∫óËàóÂêç„ÅÆ„Çπ„Çø„Ç§„É´ÊîπÂñÑ */
        .store-name .name-text {
            margin-left: 0.3rem;
        }

        /* Êñ∞„Åó„ÅÑ„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥„Éá„Ç∂„Ç§„É≥ */
        .store-actions-new {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px; /* „ÇÆ„É£„ÉÉ„Éó„ÇíÁ∏ÆÂ∞è */
            margin-top: 0.8rem; /* „Éû„Éº„Ç∏„É≥„ÇíÁ∏ÆÂ∞è */
        }

        .action-btn-new {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            border: none;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 60px;
        }

        .action-btn-new i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .action-btn-new span {
            line-height: 1;
        }

        /* Ë©≥Á¥∞„Éú„Çø„É≥Ôºà„Éó„É©„Ç§„Éû„É™Ôºâ */
        .action-btn-primary {
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            box-shadow: 0 3px 8px rgba(74, 144, 226, 0.2);
        }

        .action-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
            background: linear-gradient(135deg, #5A9EF0 0%, #4585C8 100%);
        }

        /* Âú∞Âõ≥„Éú„Çø„É≥Ôºà„Çª„Ç´„É≥„ÉÄ„É™Ôºâ */
        .action-btn-secondary {
            background: linear-gradient(135deg, #6C7B7F 0%, #546E7A 100%);
            color: white;
            box-shadow: 0 3px 8px rgba(108, 123, 127, 0.2);
        }

        .action-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 123, 127, 0.3);
            background: linear-gradient(135deg, #7C8B8F 0%, #647E8A 100%);
        }

        /* „É¨„Éì„É•„Éº„Éú„Çø„É≥Ôºà„Ç¢„ÇØ„Çª„É≥„ÉàÔºâ */
        .action-btn-accent {
            background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%);
            color: white;
            box-shadow: 0 3px 8px rgba(233, 30, 99, 0.2);
        }

        .action-btn-accent:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.3);
            background: linear-gradient(135deg, #F12E73 0%, #D2286B 100%);
        }

        .store-category {
            display: inline-block;
            background: var(--accent-mint);
            color: var(--white);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.8rem;
        }

        .store-category.ÂíåÈ£ü { background: linear-gradient(45deg, #FFB6C1, #FFC0CB); }
        .store-category.Ê¥ãÈ£ü { background: linear-gradient(45deg, #27AE60, #2ECC71); }
        .store-category.„Ç´„Éï„Çß { background: linear-gradient(45deg, #8B4513, #A0522D); }
        .store-category.„Éë„É≥Â±ã { background: linear-gradient(45deg, #8E44AD, #9B59B6); }
        .store-category.„Çπ„Ç§„Éº„ÉÑ { background: linear-gradient(45deg, #FFE4E1, #FFF0F5); }
        .store-category.Ë≤©Â£≤Â∫ó { background: linear-gradient(45deg, #98D8C8, #B0E0E6); }
        .store-category.„Åù„ÅÆ‰ªñ { background: linear-gradient(45deg, #98D8C8, #B0E0E6); }

        .store-address {
            color: var(--text-light);
            font-size: 0.85rem; /* „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÇíÁ∏ÆÂ∞è */
            margin-bottom: 0.6rem; /* „Éû„Éº„Ç∏„É≥„ÇíÁ∏ÆÂ∞è */
            display: flex;
            align-items: center;
            gap: 0.5rem;
            line-height: 1.3; /* Ë°åÈñì„ÇíË™øÊï¥ */
        }

        .store-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: space-between;
        }

        .action-btn {
            background: var(--white);
            border: 1px solid var(--primary-pink);
            color: var(--primary-pink);
            padding: 0.5rem 0.8rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .action-btn:hover {
            background: var(--primary-pink);
            color: var(--white);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px var(--shadow-medium);
        }

        .no-stores {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
            font-style: italic;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 8px 30px var(--shadow-soft);
            overflow: hidden;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 20px;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--cream) 0%, var(--white) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 1.2rem;
            color: var(--text-dark);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-gray);
            border-left: 4px solid var(--primary-pink);
            border-right: 4px solid var(--secondary-mint);
            border-radius: 50%;
            animation: gentle-spin 2s ease-in-out infinite;
            margin-bottom: 1rem;
        }

        @keyframes gentle-spin {
            0% { 
                transform: rotate(0deg) scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: rotate(180deg) scale(1.05);
                opacity: 1;
            }
            100% { 
                transform: rotate(360deg) scale(1);
                opacity: 0.8;
            }
        }

        .loading-overlay.hidden {
            display: none;
        }

        /* Modal Styles - Enhanced */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--white) 0%, var(--cream) 100%);
            padding: 0;
            border-radius: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.4),
                0 8px 24px rgba(255, 182, 193, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.6);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .modal.show .modal-content {
            transform: scale(1) translateY(0);
        }

        .store-detail-modal {
            max-width: 650px;
            width: 95%;
        }

        /* „É¢„Éº„ÉÄ„É´„Éú„Éá„Ç£„ÅÆ„Çπ„Çø„Ç§„É´ */
        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            max-height: calc(85vh - 140px); /* „Éò„ÉÉ„ÉÄ„ÉºÂàÜ„ÇíÈô§„Åè */
        }
        
        .store-images-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 12px;
            margin-bottom: 2rem;
            height: 280px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .main-image {
            grid-row: span 2;
            position: relative;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(135deg, var(--light-gray) 0%, #f8f9fa 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .main-image:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 182, 193, 0.3);
        }
        
        .main-image:hover img {
            transform: scale(1.05);
        }

        .secondary-images {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .secondary-image {
            height: 120px;
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .secondary-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .secondary-image:hover img {
            transform: scale(1.05);
        }

        .image-placeholder {
            color: #adb5bd;
            font-size: 14px;
            text-align: center;
        }

        /* Lightbox Styles */
        .lightbox-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .lightbox-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .lightbox-close {
            position: absolute;
            top: -50px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 40px;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }

        .lightbox-close:hover {
            opacity: 0.7;
        }

        .lightbox-navigation {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }

        .lightbox-prev, .lightbox-next {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 30px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
            pointer-events: auto;
            margin: 0 20px;
        }

        .lightbox-prev:hover, .lightbox-next:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .lightbox-counter {
            color: white;
            margin-top: 20px;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
        }

        .store-detail-info {
            margin-top: 1rem;
        }

        .store-detail-section {
            background: rgba(255, 255, 255, 0.5);
            padding: 1.2rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 182, 193, 0.2);
            transition: all 0.3s ease;
        }
        
        .store-detail-section:hover {
            background: rgba(255, 255, 255, 0.7);
            border-color: rgba(255, 182, 193, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 182, 193, 0.2);
        }

        .store-detail-section h4 {
            color: var(--primary-pink);
            margin-bottom: 0.8rem;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .store-detail-section h4 i {
            color: var(--secondary-mint);
            width: 18px;
            text-align: center;
        }

        .store-detail-section p {
            color: var(--text-dark);
            line-height: 1.6;
            margin: 0;
            font-size: 0.95rem;
        }

        .store-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid rgba(255, 182, 193, 0.2);
        }

        .store-action-btn {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--secondary-mint) 100%);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 3px 12px rgba(255, 182, 193, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .store-action-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 20px rgba(255, 182, 193, 0.4);
            background: linear-gradient(135deg, var(--secondary-mint) 0%, var(--primary-pink) 100%);
        }
        
        .store-action-btn i {
            font-size: 1rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 2rem 2rem 1rem 2rem;
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--secondary-mint) 100%);
            border-radius: 24px 24px 0 0;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="30" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="70" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
            pointer-events: none;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
            margin-right: 1rem;
        }
        
        .modal-store-name {
            font-family: 'Comfortaa', 'Noto Sans JP', sans-serif;
            letter-spacing: 0.5px;
        }
        
        .modal-category-badge {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.3);
            display: inline-block;
            width: fit-content;
        }

        .close-btn {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            font-size: 1.6rem;
            cursor: pointer;
            color: white;
            padding: 0;
            line-height: 1;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-weight: 300;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: rotate(90deg) scale(1.1);
            border-color: rgba(255,255,255,0.5);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--cream);
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-pink);
            background: var(--white);
            box-shadow: 0 0 0 3px var(--shadow-soft);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-pink);
        }

        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-lavender) 100%);
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--light-gray);
            color: var(--text-dark);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            margin-left: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--accent-sky);
            transform: translateY(-1px);
        }

        /* Message Styles */
        .error-message {
            color: #e74c3c;
            background: linear-gradient(135deg, #fdf2f2 0%, #fbeaea 100%);
            border: 1px solid #f5c6cb;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .success-message {
            color: #27ae60;
            background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e8 100%);
            border: 1px solid #c3e6cb;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Responsive Design - Mobile First */
        @media (max-width: 768px) {
            /* „Éò„ÉÉ„ÉÄ„Éº„ÅÆ„É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ - „Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            .header {
                padding: 0.5rem;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1001;
            }
            
            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 0.5rem;
            }
            
            .logo {
                font-size: 1rem;
                gap: 0.3rem;
            }
            
            .logo-text {
                display: none; /* „Çø„Ç§„Éà„É´„ÉÜ„Ç≠„Çπ„Éà„ÇíÈùûË°®Á§∫ */
            }
            
            .naco-character {
                width: 36px;
                height: 36px;
                margin-right: 0.3rem;
            }
            
            .community-badge {
                display: none; /* „Ç≥„Éü„É•„Éã„ÉÜ„Ç£„Éê„ÉÉ„Ç∏„ÇíÈùûË°®Á§∫ */
            }
            
            /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä„ÅÆË™øÊï¥ - „Éû„ÉÉ„Éó‰∏≠ÂøÉ„É¨„Ç§„Ç¢„Ç¶„Éà */
            .main-container {
                flex-direction: column-reverse; /* „Éû„ÉÉ„Éó„Çí‰∏ä„Å´ */
                height: 100vh;
                padding: 0;
                gap: 0;
                margin-top: 50px; /* Âõ∫ÂÆö„Éò„ÉÉ„ÉÄ„ÉºÂàÜ„ÅÆ‰ΩôÁôΩ */
            }
            
            /* „Çµ„Ç§„Éâ„Éê„Éº„ÅÆ„É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ - „Ç≥„É≥„Éë„ÇØ„Éà„Éá„Ç∂„Ç§„É≥ */
            .sidebar {
                width: 100%;
                height: 30vh; /* „Éû„ÉÉ„Éó‰ºòÂÖà„ÅÆ„Åü„ÇÅÈ´ò„Åï„ÇíÊ∏õ„Çâ„Åó„Å¶„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
                min-height: 30vh;
                max-height: 30vh;
                order: 2;
                position: relative;
                transition: all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
                display: flex;
                flex-direction: column;
                border-top: 3px solid rgba(255, 182, 193, 0.3);
                border-radius: 20px 20px 0 0;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
                z-index: 1000;
            }
            
            /* „Çµ„Ç§„Éâ„Éê„Éº„ÇíÂ±ïÈñã/Êäò„Çä„Åü„Åü„ÅøÂèØËÉΩ„Å´ */
            .sidebar.collapsed {
                height: 60px;
                min-height: 60px;
                max-height: 60px;
            }
            
            /* „Çπ„É©„Ç§„Éâ„Ç¢„ÉÉ„Éó„ÅßÂÖ®ÁîªÈù¢Ë°®Á§∫ - Êªë„Çâ„Åã„Å™„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„Åç */
            .sidebar.expanded {
                height: 80vh !important;
                max-height: 80vh !important;
                min-height: 80vh !important;
                position: fixed;
                top: 50px;
                left: 0;
                right: 0;
                z-index: 2000;
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
                transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                transform: translateY(0);
            }
            
            .sidebar.expanded .store-list {
                max-height: 60vh !important;
                min-height: 300px;
            }
            
            .sidebar-header {
                padding: 0.8rem 1rem;
                font-size: 1rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: linear-gradient(135deg, var(--primary-pink) 0%, var(--secondary-mint) 100%);
                border-radius: 12px 12px 0 0;
                transition: all 0.3s ease;
                cursor: pointer;
                user-select: none;
            }
            
            .sidebar-header:hover {
                background: linear-gradient(135deg, #ff9fb3 0%, #7ec7b7 100%);
                transform: translateY(-1px);
                box-shadow: 0 4px 15px rgba(255, 182, 193, 0.4);
            }
            
            .sidebar-header:active {
                transform: translateY(0);
                background: linear-gradient(135deg, #ff8fa8 0%, #6eb5a4 100%);
            }
            
            .sidebar-header::after {
                content: '‚ñ≤'; /* ‰∏äÂêë„ÅçÁü¢Âç∞ - Èñã„ÅÑ„Å¶„ÅÑ„ÇãÁä∂ÊÖã */
                font-size: 1rem;
                transition: transform 0.3s;
                color: #666;
            }
            
            .sidebar.collapsed .sidebar-header::after {
                content: '‚ñº'; /* ‰∏ãÂêë„ÅçÁü¢Âç∞ - Êäò„Çä„Åü„Åü„Åæ„Çå„ÅüÁä∂ÊÖã */
                transform: none;
            }
            
            .sidebar.collapsed .sidebar-header {
                background: linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-lavender) 50%);
                cursor: pointer;
                position: relative;
            }
            
            .sidebar.collapsed .sidebar-header::before {
                content: 'Ëøë„Åè„ÅÆÂ∫óËàó„ÇíË°®Á§∫ üëÜ';
                position: absolute;
                right: 35px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 0.8rem;
                color: rgba(255, 255, 255, 0.9);
                pointer-events: none;
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 0.7; }
                50% { opacity: 1; }
            }
            
            .sidebar-stats {
                display: none; /* Áµ±Ë®àÊÉÖÂ†±„ÇíÈùûË°®Á§∫ */
            }
            
            .sidebar.collapsed .search-section,
            .sidebar.collapsed .filter-grid,
            .sidebar.collapsed .store-list {
                display: none;
            }
            
            /* „É¢„Éê„Ç§„É´„Åß„Çø„Ç§„Éà„É´Ë°®Á§∫ÂàáÊõø */
            .mobile-title {
                display: inline;
            }
            
            .desktop-title {
                display: none;
            }
            
            /* Ê§úÁ¥¢„Éê„Éº„ÅÆÊúÄÈÅ©Âåñ */
            .search-section {
                padding: 1rem;
            }
            
            .search-input {
                font-size: 16px; /* iOS„ÅÆ„Ç∫„Éº„É†Èò≤Ê≠¢ */
                padding: 0.8rem 1rem;
                min-height: 44px;
            }
            
            /* „Éï„Ç£„É´„Çø„Éº„Ç∞„É™„ÉÉ„Éâ„ÅÆË™øÊï¥ */
            .filter-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                padding: 0 1rem 1rem;
            }
            
            .filter-btn {
                min-height: 44px;
                font-size: 0.9rem;
                padding: 0.6rem 0.8rem;
            }
            
            /* Â∫óËàó„É™„Çπ„Éà„ÅÆÊúÄÈÅ©Âåñ - „Ç≥„É≥„Éë„ÇØ„ÉàË°®Á§∫ */
            .store-list {
                max-height: 18vh; /* „Ç≥„É≥„Éë„ÇØ„Éà„Å´Ë™øÊï¥ */
                min-height: 120px; /* ÊúÄÂ∞èÈ´ò„Åï„ÇíÁ∂≠ÊåÅ */
                padding: 0.3rem 1rem 0.5rem;
                overflow-y: auto;
                flex: 1;
            }
            
            .store-item {
                margin-bottom: 0.5rem;
                padding: 0.8rem;
                border-radius: 12px;
                background: rgba(255, 255, 255, 0.8);
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                cursor: pointer;
                transition: all 0.3s ease;
                border-left: 3px solid transparent;
            }
            
            .store-item:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.12);
                border-left: 3px solid var(--primary-pink);
                background: rgba(255, 255, 255, 0.95);
            }
            
            .store-item {
                padding: 1rem;
                margin-bottom: 0.5rem;
            }
            
            .store-name {
                font-size: 1rem;
                line-height: 1.4;
            }
            
            .store-category {
                font-size: 0.85rem;
                padding: 0.3rem 0.6rem;
            }
            
            .store-address {
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            /* „Éû„ÉÉ„Éó„Ç≥„É≥„ÉÜ„Éä„ÅÆË™øÊï¥ - „É°„Ç§„É≥Ë°®Á§∫ */
            .map-container {
                flex: 1;
                height: calc(70vh - 50px); /* 70%„Çí„Éû„ÉÉ„Éó„Å´ÈÖçÂàÜ */
                min-height: 400px;
                order: 1;
                position: relative;
                z-index: 1;
            }
            
            .sidebar:not(.collapsed) + .map-container {
                height: calc(60vh - 50px);
            }
            
            /* Ë™çË®º„Éú„Çø„É≥„ÅÆÊúÄÈÅ©Âåñ */
            .auth-btn {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
                min-height: 36px;
                border-radius: 18px;
            }
            
            /* „É¶„Éº„Ç∂„Éº„Ç¢„Éê„Çø„Éº„ÅÆË™øÊï¥ */
            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }
            
            /* „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Çí„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            .user-info {
                gap: 0.5rem;
            }
            
            /* Â∫óËàó„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆË™øÊï¥ */
            .store-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .store-action-btn {
                min-height: 44px;
                font-size: 0.9rem;
                padding: 0.7rem 1rem;
            }
            
            /* Ë°®Á§∫„É¢„Éº„Éâ„Éú„Çø„É≥„ÅÆË™øÊï¥ */
            .display-mode-controls {
                padding: 0.75rem 1rem;
            }
            
            .display-mode-btn {
                min-height: 40px;
                font-size: 0.85rem;
                padding: 0.6rem 0.8rem;
            }
        }
        
        /* Â∞èÂûã„Çπ„Éû„Éº„Éà„Éï„Ç©„É≥Âêë„Åë„ÅÆËøΩÂä†Ë™øÊï¥ */
        @media (max-width: 480px) {
            .header {
                padding: 0.4rem;
            }
            
            .naco-character {
                width: 32px;
                height: 32px;
            }
            
            .main-container {
                margin-top: 45px;
            }
            
            .sidebar {
                height: 28vh; /* Â∞è„Åï„Å™„Çπ„Éû„Éõ„Åß„ÇÇ„Éû„ÉÉ„Éó„ÇíÈáçË¶ñ */
                max-height: 28vh;
                min-height: 28vh;
            }
            
            .sidebar.collapsed {
                height: 50px;
            }
            
            .map-container {
                height: calc(72vh - 45px); /* „Çà„ÇäÂ§ö„Åè„ÅÆÈ†òÂüü„Çí„Éû„ÉÉ„Éó„Å´ */
                min-height: 350px;
            }
            
            .filter-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.3rem;
            }
            
            .filter-btn {
                font-size: 0.8rem;
                padding: 0.5rem;
                min-height: 36px;
            }
            
            .store-list {
                max-height: 25vh;
                min-height: 180px;
            }
            
            .store-item {
                margin-bottom: 0.6rem;
                padding: 0.8rem;
            }
        }

        /* Custom Leaflet Popup Styles */
        .leaflet-popup-content-wrapper {
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 8px 30px var(--shadow-soft);
        }

        .leaflet-popup-content {
            margin: 15px;
        }

        .popup-store-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-pink);
            margin-bottom: 0.5rem;
        }

        .popup-category {
            display: inline-block;
            background: var(--accent-mint);
            color: var(--white);
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .popup-address {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .popup-btn {
            background: var(--primary-pink);
            color: var(--white);
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .popup-btn:hover {
            background: var(--secondary-lavender);
            transform: translateY(-1px);
        }

        /* Ê¥óÁ∑¥„Åï„Çå„Åü„Éû„Éº„Ç´„Éº„ÅÆ„Çπ„Çø„Ç§„É´ */
        .sophisticated-marker-wrapper {
            background: transparent !important;
            border: none !important;
        }

        .sophisticated-marker {
            cursor: pointer !important;
            user-select: none;
            position: relative;
            width: 28px;
            height: 44px;
            transition: transform 0.2s ease;
        }

        .sophisticated-marker:hover {
            transform: scale(1.08);
        }

        .marker-teardrop {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sophisticated-marker:hover .marker-teardrop {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.25), 0 4px 10px rgba(0,0,0,0.15);
        }

        /* „Ç´„Çπ„Çø„É†„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆ„Çπ„Çø„Ç§„É´ */
        .custom-popup {
            font-family: 'Noto Sans JP', sans-serif;
            line-height: 1.4;
            min-width: 200px;
        }

        .custom-popup h4 {
            font-family: 'Comfortaa', 'Noto Sans JP', sans-serif;
        }

        /* Leaflet popup „Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
        .leaflet-popup-content-wrapper {
            border-radius: 15px !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
            border: 2px solid var(--primary-pink);
        }

        .leaflet-popup-tip {
            background: var(--white) !important;
            border: 2px solid var(--primary-pink);
            border-top: none !important;
            border-right: none !important;
        }

        /* Floating notification */
        .floating-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            font-weight: 500;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ÁèæÂú®Âú∞„Éû„Éº„Ç´„Éº„ÅÆ„Çπ„Çø„Ç§„É´ */
        .current-location-wrapper {
            background: transparent !important;
            border: none !important;
        }

        .current-location-marker {
            position: relative;
            width: 28px;
            height: 28px;
            cursor: pointer;
        }

        .location-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 50%, #45B7D1 100%);
            border: 4px solid white;
            border-radius: 50%;
            box-shadow: 
                0 0 0 3px rgba(255, 107, 107, 0.3),
                0 0 0 6px rgba(255, 255, 255, 0.8),
                0 6px 20px rgba(255, 107, 107, 0.6),
                0 0 30px rgba(69, 183, 209, 0.4);
            z-index: 1001;
            animation: dotPulse 2.5s ease-in-out infinite;
        }

        .location-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 28px;
            height: 28px;
            background: radial-gradient(circle, rgba(255, 107, 107, 0.6) 0%, rgba(69, 183, 209, 0.3) 50%, rgba(78, 205, 196, 0.2) 70%, transparent 100%);
            border-radius: 50%;
            animation: pulse 2s ease-out infinite;
        }

        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0.9;
            }
            50% {
                transform: translate(-50%, -50%) scale(2.5);
                opacity: 0.5;
            }
            100% {
                transform: translate(-50%, -50%) scale(4.0);
                opacity: 0;
            }
        }

        @keyframes dotPulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                filter: brightness(1);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.15);
                filter: brightness(1.2);
            }
        }

        /* ÁèæÂú®Âú∞„Éú„Çø„É≥ */
        .location-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: var(--white);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            color: var(--primary-pink);
            font-size: 16px;
        }

        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            background: var(--primary-pink);
            color: white;
        }

        .location-btn.loading {
            animation: spin 1s linear infinite;
        }

        /* „Éî„É≥„É¢„Éº„Éâ„Éú„Çø„É≥ */
        .pin-mode-btn {
            position: absolute;
            top: 10px;
            right: 60px;
            z-index: 1000;
            background: var(--white);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .pin-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            background: #FF6B35;
            color: white;
        }

        .pin-mode-btn.active {
            background: #FF6B35;
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }

        .pin-mode-btn i {
            font-size: 1rem;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }


        /* Ë∑ùÈõ¢Ë°®Á§∫ */
        .distance-badge {
            display: inline-block;
            background: rgba(66, 133, 244, 0.1);
            color: #4285f4;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        /* Ê§úÁ¥¢Âú∞ÁÇπ„Éû„Éº„Ç´„Éº */
        .search-location-marker {
            position: relative;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #9b59b6, #e74c3c);
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 0 0 2px rgba(155, 89, 182, 0.3),
                0 4px 15px rgba(155, 89, 182, 0.4);
            animation: searchPulse 3s ease-in-out infinite;
        }

        .search-location-marker i {
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .search-location-wrapper {
            background: transparent !important;
            border: none !important;
        }

        @keyframes searchPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 
                    0 0 0 2px rgba(155, 89, 182, 0.3),
                    0 4px 15px rgba(155, 89, 182, 0.4);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 
                    0 0 0 4px rgba(155, 89, 182, 0.4),
                    0 6px 20px rgba(155, 89, 182, 0.5);
            }
        }

        /* Ê§úÁ¥¢„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
        .search-popup h4 {
            margin: 0 0 8px 0;
            color: var(--text-dark);
            font-size: 1.1rem;
        }

        .search-popup .region {
            margin: 4px 0;
            color: var(--primary-pink);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .search-popup .address {
            margin: 4px 0 0 0;
            color: var(--text-light);
            font-size: 0.8rem;
            line-height: 1.3;
        }

        /* „É¶„Éº„Ç∂„Éº„Éî„É≥„Éû„Éº„Ç´„Éº */
        .user-pin-marker {
            position: relative;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #FF6B35 0%, #E55A2B 100%);
            border: 3px solid white;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 0 0 2px rgba(255, 107, 53, 0.3),
                0 4px 15px rgba(255, 107, 53, 0.4);
            animation: userPinPulse 3s ease-in-out infinite;
        }

        .user-pin-marker::before {
            content: '';
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(0deg);
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50% 50% 50% 0;
            border: 2px solid #FF6B35;
        }

        .user-pin-marker::after {
            content: '';
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(0deg);
            width: 10px;
            height: 10px;
            background: #FF6B35;
            border-radius: 50%;
            z-index: 1;
        }

        .user-pin-wrapper {
            background: transparent !important;
            border: none !important;
        }

        @keyframes userPinPulse {
            0%, 100% {
                transform: rotate(-45deg) scale(1);
                box-shadow: 
                    0 0 0 2px rgba(255, 107, 53, 0.3),
                    0 4px 15px rgba(255, 107, 53, 0.4);
            }
            50% {
                transform: rotate(-45deg) scale(1.05);
                box-shadow: 
                    0 0 0 4px rgba(255, 107, 53, 0.4),
                    0 6px 20px rgba(255, 107, 53, 0.5);
            }
        }

        .nearest-badge {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
            animation: sparkle 2s ease-in-out infinite;
        }

        .filter-btn[data-category="nearby"].active {
            background: linear-gradient(135deg, #ffffff 0%, #4285f4 100%);
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4);
            border: 1px solid #4285f4;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div>naco„Ç≥„Éü„É•„Éã„ÉÜ„Ç£„Éû„ÉÉ„Éó„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="naco-character"></div>
                <div class="logo-text">„Ç∞„É´„ÉÜ„É≥„Éï„É™„Éº„Éû„ÉÉ„Éó</div>
                <span class="community-badge">„Éì„É®„Ç∞„É´ÂÄ∂Ê•ΩÈÉ® presents by naco</span>
            </div>
            <div class="user-info">
                <div id="loginSection" style="display: none;">
                    <button class="auth-btn" onclick="handleLogin()">
                        <i class="fab fa-google"></i>
                        „É≠„Ç∞„Ç§„É≥
                    </button>
                </div>
                <div id="userSection" style="display: none;">
                    <div class="user-avatar" id="userAvatar">N</div>
                    <button class="auth-btn" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        „É≠„Ç∞„Ç¢„Ç¶„Éà
                    </button>
                </div>
            </div>
        </div>
    </header>


    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="search-title">
                    <i class="fas fa-list"></i>
                    <span class="mobile-title">Â∫óËàó‰∏ÄË¶ß</span>
                    <span class="desktop-title">„ÅäÂ∫ó„ÇíÊé¢„Åô</span>
                </div>
                <input type="text" class="search-box" id="searchBox" placeholder="Â∫óÂêç„Éª‰ΩèÊâÄ„ÉªÈßÖÂêç„ÅßÊ§úÁ¥¢... (‰æã: Ê∏ãË∞∑ÈßÖ„ÄÅÂ§ßÈò™Âüé)">
                
                <!-- Stats moved to sidebar -->
                <div class="sidebar-stats">
                    <div class="sidebar-stat-item">
                        <div class="sidebar-stat-number" id="totalStores">-</div>
                        <div class="sidebar-stat-label">Á∑èÂ∫óËàóÊï∞</div>
                    </div>
                    <div class="sidebar-stat-item">
                        <div class="sidebar-stat-number" id="visibleStores">-</div>
                        <div class="sidebar-stat-label">Ë°®Á§∫‰∏≠</div>
                    </div>
                    <div class="sidebar-stat-item">
                        <div class="sidebar-stat-number" id="reviewCount">-</div>
                        <div class="sidebar-stat-label">Á∑è„É¨„Éì„É•„ÉºÊï∞</div>
                    </div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-grid">
                    <button class="filter-btn active" data-category="all">
                        <i class="fas fa-th-large"></i> „Åô„Åπ„Å¶
                    </button>
                    <button class="filter-btn" data-category="ÂíåÈ£ü">
                        <i class="fas fa-bowl-rice"></i> ÂíåÈ£ü
                    </button>
                    <button class="filter-btn" data-category="Ê¥ãÈ£ü">
                        <i class="fas fa-utensils"></i> Ê¥ãÈ£ü
                    </button>
                    <button class="filter-btn" data-category="„Ç´„Éï„Çß">
                        <i class="fas fa-coffee"></i> „Ç´„Éï„Çß
                    </button>
                    <button class="filter-btn" data-category="„Éë„É≥Â±ã">
                        <i class="fas fa-bread-slice"></i> „Éë„É≥Â±ã
                    </button>
                    <button class="filter-btn" data-category="„Çπ„Ç§„Éº„ÉÑ">
                        <i class="fas fa-birthday-cake"></i> „Çπ„Ç§„Éº„ÉÑ
                    </button>
                    <button class="filter-btn" data-category="Ë≤©Â£≤Â∫ó">
                        <i class="fas fa-shopping-bag"></i> Ë≤©Â£≤Â∫ó
                    </button>
                </div>
                
                <!-- Ë°®Á§∫„É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàÔºà„É≠„Ç∞„Ç§„É≥ÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ -->
                <div id="displayModeSection" style="
                    margin-top: 8px; 
                    padding: 8px 6px; 
                    border-top: 1px solid #eee;
                    display: none;
                ">
                    <div style="font-size: 12px; color: #666; margin-bottom: 6px;">
                        <i class="fas fa-eye"></i> Ë°®Á§∫„É¢„Éº„Éâ
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                        <button class="display-mode-btn active" data-mode="normal" onclick="changeDisplayMode('normal')" style="
                            padding: 6px 8px;
                            border: 1px solid #ddd;
                            border-radius: 12px;
                            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-lavender) 100%);
                            color: white;
                            font-size: 11px;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                        ">
                            <i class="fas fa-home"></i>
                            <span>ÈÄöÂ∏∏Ë°®Á§∫</span>
                        </button>
                        <button class="display-mode-btn" data-mode="all" onclick="changeDisplayMode('all')" style="
                            padding: 6px 8px;
                            border: 1px solid #ddd;
                            border-radius: 12px;
                            background: white;
                            color: #333;
                            font-size: 11px;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                        ">
                            <i class="fas fa-globe"></i>
                            <span>ÂÖ®Ë°®Á§∫</span>
                        </button>
                        <button class="display-mode-btn" data-mode="want_to_go" onclick="changeDisplayMode('want_to_go')" style="
                            padding: 6px 8px;
                            border: 1px solid #667eea;
                            border-radius: 12px;
                            background: white;
                            color: #667eea;
                            font-size: 11px;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                        ">
                            <i class="fas fa-bookmark"></i>
                            <span>Ë°å„Åç„Åü„ÅÑ</span>
                        </button>
                        <button class="display-mode-btn" data-mode="visited" onclick="changeDisplayMode('visited')" style="
                            padding: 6px 8px;
                            border: 1px solid #48bb78;
                            border-radius: 12px;
                            background: white;
                            color: #48bb78;
                            font-size: 11px;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                        ">
                            <i class="fas fa-check-circle"></i>
                            <span>Ë°å„Å£„Åü</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="store-list" id="storeList">
                <!-- Stores will be populated here -->
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            <button class="location-btn" id="locationBtn" onclick="getCurrentLocation()" title="ÁèæÂú®Âú∞„ÇíË°®Á§∫">
                <i class="fas fa-location-arrow"></i>
            </button>
            <button class="pin-mode-btn" id="pinModeBtn" onclick="togglePinMode()" title="„Éî„É≥„ÇíÁ´ã„Å¶„Çã">
                <i class="fas fa-map-marker-alt"></i>
            </button>
        </div>
    </div>

    <!-- Store Detail Modal -->
    <div id="storeDetailModal" class="modal">
        <div class="modal-content store-detail-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="storeDetailTitle">Â∫óËàóË©≥Á¥∞</h3>
                <button class="close-btn" onclick="closeStoreDetailModal()">&times;</button>
            </div>
            <div id="storeDetailBody" class="modal-body">
                <!-- Store details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Image Lightbox Modal -->
    <div id="lightboxModal" class="lightbox-modal">
        <div class="lightbox-content">
            <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
            <img id="lightboxImage" class="lightbox-image" src="" alt="">
            <div class="lightbox-navigation">
                <button class="lightbox-prev" onclick="prevImage()">‚Äπ</button>
                <button class="lightbox-next" onclick="nextImage()">‚Ä∫</button>
            </div>
            <div class="lightbox-counter" id="lightboxCounter">1 / 3</div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="reviewModalTitle">„É¨„Éì„É•„Éº„ÇíÊäïÁ®ø</h3>
                <button class="close-btn" onclick="closeReviewModal()">&times;</button>
            </div>
            <div id="reviewModalBody">
                <!-- Review form will be populated here -->
            </div>
        </div>
    </div>

    <!-- robots.txt content (for reference) -->
    <!-- 
    User-agent: *
    Disallow: /
    -->

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster plugin for performance -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- Supabase -->
    <!-- Supabase UMD version removed to avoid conflicts with ES module -->
    <script type="module" src="supabase-client.js"></script>

    <script>
        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñÔºàË™çË®º„ÉÅ„Çß„ÉÉ„ÇØ„ÅØindex.html„ÅßÂÆå‰∫ÜÊ∏à„ÅøÔºâ
        (async function() {
            console.log('üöÄ naco„Ç≥„Éü„É•„Éã„ÉÜ„Ç£„Éû„ÉÉ„ÉóÁõ¥Êé•ÈñãÂßãÔºàË™çË®ºÊ∏à„ÅøÔºâ');
            
            // Wait for supabase client to be loaded from ES module
            let waitCount = 0;
            const maxWaitTime = 50;
            while (!window.supabase && waitCount < maxWaitTime) {
                console.log(`‚è≥ Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàË™≠„ÅøËæº„ÅøÂæÖ„Å°... (${waitCount + 1}/${maxWaitTime})`);
                await new Promise(resolve => setTimeout(resolve, 100));
                waitCount++;
            }
            
            if (!window.supabase) {
                console.error('‚ùå Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàË™≠„ÅøËæº„Åø„Çø„Ç§„É†„Ç¢„Ç¶„Éà');
                // Ë™çË®º„ÅåÂøÖË¶Å„Å™„Éö„Éº„Ç∏„Å™„ÅÆ„ÅßÁõ¥Êé•„Ç¢„ÇØ„Çª„Çπ„ÇíÈò≤„Åê
                const redirectCount = parseInt(sessionStorage.getItem('pageRedirectCount') || '0');
                if (redirectCount > 2) {
                    console.error('‚ùå ÊúÄÂ§ß„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂõûÊï∞„ÇíË∂ÖÈÅé - Âº∑Âà∂„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏');
                    sessionStorage.removeItem('pageRedirectCount');
                    window.location.replace('https://bettger3000.github.io/nagoya-glutenfree-map/login.html');
                } else {
                    sessionStorage.setItem('pageRedirectCount', String(redirectCount + 1));
                    window.location.replace('https://bettger3000.github.io/nagoya-glutenfree-map/');
                }
                return;
            }
            
            console.log('‚úÖ Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶„É¶„Éº„Ç∂„ÉºË°®Á§∫„ÇíÊõ¥Êñ∞
            const { data: { session } } = await window.supabase.auth.getSession();
            if (session && session.user) {
                // „É¶„Éº„Ç∂„Éº„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÄ„Éñ„É´„ÉÅ„Çß„ÉÉ„ÇØ
                const { data: allowedUser, error } = await window.supabase
                    .from('allowed_users')
                    .select('email')
                    .eq('email', session.user.email)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    console.error('‚ùå Ë®±ÂèØ„É¶„Éº„Ç∂„Éº„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', error);
                    window.location.replace('https://bettger3000.github.io/nagoya-glutenfree-map/');
                    return;
                }
                
                if (!allowedUser) {
                    console.log('‚ùå Êú™Ë®±ÂèØ„É¶„Éº„Ç∂„Éº„ÅÆ„Ç¢„ÇØ„Çª„ÇπÊ§úÂá∫ - „É≠„Ç∞„Ç¢„Ç¶„Éà');
                    await window.supabase.auth.signOut();
                    alert('„Åì„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÅØ„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                    window.location.replace('https://bettger3000.github.io/nagoya-glutenfree-map/login.html');
                    return;
                }
                
                window.currentUser = session.user;
                updateUserDisplay(session.user);
                console.log('‚úÖ „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë®≠ÂÆöÂÆå‰∫Ü:', session.user.email);
                // „É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Ç´„Ç¶„É≥„Éà„Çí„É™„Çª„ÉÉ„ÉàÔºàÊ≠£Â∏∏„Å™Ë™çË®ºÂÆå‰∫ÜÔºâ
                sessionStorage.removeItem('pageRedirectCount');
            } else {
                console.log('‚ùå new-map.html: „Çª„ÉÉ„Ç∑„Éß„É≥„Å™„Åó - „É™„ÉÄ„Ç§„É¨„ÇØ„Éà');
                window.location.replace('https://bettger3000.github.io/nagoya-glutenfree-map/');
                return;
            }
            
            // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
            initApp();
            
            function updateUserDisplay(user) {
                // „É≠„Ç∞„Ç§„É≥„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈùûË°®Á§∫
                document.getElementById('loginSection').style.display = 'none';
                
                // „É¶„Éº„Ç∂„Éº„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
                document.getElementById('userSection').style.display = 'flex';
                
                // „É¶„Éº„Ç∂„ÉºÂêç„ÅÆÊúÄÂàù„ÅÆÊñáÂ≠ó„Çí„Ç¢„Éê„Çø„Éº„Å´Ë°®Á§∫
                const avatar = document.getElementById('userAvatar');
                if (avatar && user.email) {
                    avatar.textContent = user.email.charAt(0).toUpperCase();
                }
                
                console.log('‚úÖ „É¶„Éº„Ç∂„ÉºË°®Á§∫„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü:', user.email);
            }
        })();

        // Global variables
        let map;
        let markers = [];
        let stores = [];
        let currentUser = null;
        let reviews = [];
        let userStoreLists = []; // „É¶„Éº„Ç∂„Éº„ÅÆ„ÅäÂ∫ó„É™„Çπ„Éà
        let pinModeActive = false;
        let userPin = null;

        // Category icons and colors
        const categoryConfig = {
            'ÂíåÈ£ü': { icon: 'fas fa-grip-lines-vertical', color: '#FFB6C1' },
            'Ê¥ãÈ£ü': { icon: 'fas fa-utensils', color: '#27AE60' },
            '„Ç´„Éï„Çß': { icon: 'fas fa-coffee', color: '#8B4513' },
            '„Éë„É≥Â±ã': { icon: 'fas fa-bread-slice', color: '#8E44AD' },
            '„Çπ„Ç§„Éº„ÉÑ': { icon: 'fas fa-ice-cream', color: '#FFE4E1' },
            'Ë≤©Â£≤Â∫ó': { icon: 'fas fa-shopping-bag', color: '#98D8C8' },
            '„Åù„ÅÆ‰ªñ': { icon: 'fas fa-store', color: '#B0E0E6' }
        };

        // ÂÖ®ÂõΩ‰∏ªË¶Å„É©„É≥„Éâ„Éû„Éº„ÇØ„ÉªPOI„Éá„Éº„Çø„Éô„Éº„Çπ
        const landmarkDatabase = {
            // ÂåóÊµ∑ÈÅì
            "Êú≠ÂπåÈßÖ": { lat: 43.0642, lng: 141.3469, region: "ÂåóÊµ∑ÈÅì" },
            "Êú≠ÂπåÊôÇË®àÂè∞": { lat: 43.0639, lng: 141.3537, region: "ÂåóÊµ∑ÈÅì" },
            "„Åô„Åô„Åç„ÅÆ": { lat: 43.0548, lng: 141.3535, region: "ÂåóÊµ∑ÈÅì" },
            "Êñ∞ÂçÉÊ≠≥Á©∫Ê∏Ø": { lat: 42.7747, lng: 141.6920, region: "ÂåóÊµ∑ÈÅì" },
            
            // Êù±Âåó
            "‰ªôÂè∞ÈßÖ": { lat: 38.2608, lng: 140.8814, region: "ÂÆÆÂüéÁúå" },
            "ÈùíÊ£ÆÈßÖ": { lat: 40.8278, lng: 140.7407, region: "ÈùíÊ£ÆÁúå" },
            
            // Èñ¢Êù±
            "Êù±‰∫¨ÈßÖ": { lat: 35.6812, lng: 139.7671, region: "Êù±‰∫¨ÈÉΩ" },
            "Êñ∞ÂÆøÈßÖ": { lat: 35.6896, lng: 139.7006, region: "Êù±‰∫¨ÈÉΩ" },
            "Ê∏ãË∞∑ÈßÖ": { lat: 35.6580, lng: 139.7016, region: "Êù±‰∫¨ÈÉΩ" },
            "Ê±†Ë¢ãÈßÖ": { lat: 35.7295, lng: 139.7107, region: "Êù±‰∫¨ÈÉΩ" },
            "‰∏äÈáéÈßÖ": { lat: 35.7140, lng: 139.7774, region: "Êù±‰∫¨ÈÉΩ" },
            "ÊµÖËçâ": { lat: 35.7148, lng: 139.7967, region: "Êù±‰∫¨ÈÉΩ" },
            "ÈäÄÂ∫ß": { lat: 35.6717, lng: 139.7650, region: "Êù±‰∫¨ÈÉΩ" },
            "ÂéüÂÆø": { lat: 35.6702, lng: 139.7026, region: "Êù±‰∫¨ÈÉΩ" },
            "„ÅäÂè∞Â†¥": { lat: 35.6266, lng: 139.7736, region: "Êù±‰∫¨ÈÉΩ" },
            "Êù±‰∫¨„Çπ„Ç´„Ç§„ÉÑ„É™„Éº": { lat: 35.7101, lng: 139.8107, region: "Êù±‰∫¨ÈÉΩ" },
            "Êù±‰∫¨„Çø„ÉØ„Éº": { lat: 35.6586, lng: 139.7454, region: "Êù±‰∫¨ÈÉΩ" },
            "Êñ∞ÂÆøÈÉΩÂ∫Å": { lat: 35.6893, lng: 139.6918, region: "Êù±‰∫¨ÈÉΩ" },
            "ÁæΩÁî∞Á©∫Ê∏Ø": { lat: 35.5494, lng: 139.7798, region: "Êù±‰∫¨ÈÉΩ" },
            "ÊàêÁî∞Á©∫Ê∏Ø": { lat: 35.7720, lng: 140.3929, region: "ÂçÉËëâÁúå" },
            "Ê®™ÊµúÈßÖ": { lat: 35.4658, lng: 139.6225, region: "Á•ûÂ•àÂ∑ùÁúå" },
            "„Åø„Å™„Å®„Åø„Çâ„ÅÑ": { lat: 35.4563, lng: 139.6364, region: "Á•ûÂ•àÂ∑ùÁúå" },
            "ÈéåÂÄâ": { lat: 35.3192, lng: 139.5466, region: "Á•ûÂ•àÂ∑ùÁúå" },
            "Â§ßÂÆÆÈßÖ": { lat: 35.9063, lng: 139.6239, region: "ÂüºÁéâÁúå" },
            "ÂçÉËëâÈßÖ": { lat: 35.6058, lng: 140.1061, region: "ÂçÉËëâÁúå" },
            
            // ‰∏≠ÈÉ®
            "ÂêçÂè§Â±ãÈßÖ": { lat: 35.1815, lng: 136.9066, region: "ÊÑõÁü•Áúå" },
            "ÂêçÂè§Â±ãÂüé": { lat: 35.1856, lng: 136.8997, region: "ÊÑõÁü•Áúå" },
            "Ê†Ñ": { lat: 35.1677, lng: 136.9089, region: "ÊÑõÁü•Áúå" },
            "Â§ßÈ†à": { lat: 35.1588, lng: 136.9008, region: "ÊÑõÁü•Áúå" },
            "ÈáëÂ±±ÈßÖ": { lat: 35.1432, lng: 136.8989, region: "ÊÑõÁü•Áúå" },
            "‰∏≠ÈÉ®ÂõΩÈöõÁ©∫Ê∏Ø": { lat: 34.8584, lng: 136.8047, region: "ÊÑõÁü•Áúå" },
            "ÈùôÂ≤°ÈßÖ": { lat: 34.9756, lng: 138.3829, region: "ÈùôÂ≤°Áúå" },
            "ÊµúÊùæÈßÖ": { lat: 34.7040, lng: 137.7346, region: "ÈùôÂ≤°Áúå" },
            "ÈáëÊ≤¢ÈßÖ": { lat: 36.5782, lng: 136.6477, region: "Áü≥Â∑ùÁúå" },
            "ÂØåÂ±±ÈßÖ": { lat: 36.7015, lng: 137.2136, region: "ÂØåÂ±±Áúå" },
            "Èï∑ÈáéÈßÖ": { lat: 36.6434, lng: 138.1884, region: "Èï∑ÈáéÁúå" },
            
            // Èñ¢Ë•ø
            "Â§ßÈò™ÈßÖ": { lat: 34.7024, lng: 135.4959, region: "Â§ßÈò™Â∫ú" },
            "Ê¢ÖÁî∞": { lat: 34.7053, lng: 135.4979, region: "Â§ßÈò™Â∫ú" },
            "Èõ£Ê≥¢": { lat: 34.6668, lng: 135.5000, region: "Â§ßÈò™Â∫ú" },
            "Â§©ÁéãÂØ∫": { lat: 34.6456, lng: 135.5066, region: "Â§ßÈò™Â∫ú" },
            "Â§ßÈò™Âüé": { lat: 34.6873, lng: 135.5262, region: "Â§ßÈò™Â∫ú" },
            "ÈÄöÂ§©Èñ£": { lat: 34.6523, lng: 135.5063, region: "Â§ßÈò™Â∫ú" },
            "USJ": { lat: 34.6658, lng: 135.4321, region: "Â§ßÈò™Â∫ú" },
            "Èñ¢Ë•øÂõΩÈöõÁ©∫Ê∏Ø": { lat: 34.4347, lng: 135.2441, region: "Â§ßÈò™Â∫ú" },
            "‰∫¨ÈÉΩÈßÖ": { lat: 34.9859, lng: 135.7581, region: "‰∫¨ÈÉΩÂ∫ú" },
            "Ê∏ÖÊ∞¥ÂØ∫": { lat: 34.9949, lng: 135.7849, region: "‰∫¨ÈÉΩÂ∫ú" },
            "ÈáëÈñ£ÂØ∫": { lat: 35.0394, lng: 135.7292, region: "‰∫¨ÈÉΩÂ∫ú" },
            "ÂµêÂ±±": { lat: 35.0096, lng: 135.6689, region: "‰∫¨ÈÉΩÂ∫ú" },
            "Á•áÂúí": { lat: 35.0036, lng: 135.7756, region: "‰∫¨ÈÉΩÂ∫ú" },
            "Á•ûÊà∏ÈßÖ": { lat: 34.6765, lng: 135.1885, region: "ÂÖµÂ∫´Áúå" },
            "‰∏âÂÆÆ": { lat: 34.6939, lng: 135.1955, region: "ÂÖµÂ∫´Áúå" },
            "Â•àËâØÈßÖ": { lat: 34.6851, lng: 135.8048, region: "Â•àËâØÁúå" },
            "Êù±Â§ßÂØ∫": { lat: 34.6890, lng: 135.8396, region: "Â•àËâØÁúå" },
            
            // ‰∏≠ÂõΩ
            "Â∫ÉÂ≥∂ÈßÖ": { lat: 34.3975, lng: 132.4756, region: "Â∫ÉÂ≥∂Áúå" },
            "Â∫ÉÂ≥∂Âπ≥ÂíåË®òÂøµÂÖ¨Âúí": { lat: 34.3955, lng: 132.4536, region: "Â∫ÉÂ≥∂Áúå" },
            "Â≤°Â±±ÈßÖ": { lat: 34.6661, lng: 133.9184, region: "Â≤°Â±±Áúå" },
            
            // ÂõõÂõΩ
            "È´òÊùæÈßÖ": { lat: 34.3513, lng: 134.0436, region: "È¶ôÂ∑ùÁúå" },
            "ÊùæÂ±±ÈßÖ": { lat: 33.8389, lng: 132.7661, region: "ÊÑõÂ™õÁúå" },
            
            // ‰πùÂ∑û
            "ÂçöÂ§öÈßÖ": { lat: 33.5904, lng: 130.4017, region: "Á¶èÂ≤°Áúå" },
            "Â§©Á•û": { lat: 33.5906, lng: 130.4015, region: "Á¶èÂ≤°Áúå" },
            "Á¶èÂ≤°Á©∫Ê∏Ø": { lat: 33.5859, lng: 130.4510, region: "Á¶èÂ≤°Áúå" },
            "Èï∑Â¥éÈßÖ": { lat: 32.7503, lng: 129.8779, region: "Èï∑Â¥éÁúå" },
            "ÁÜäÊú¨ÈßÖ": { lat: 32.8031, lng: 130.6889, region: "ÁÜäÊú¨Áúå" },
            "ÈπøÂÖêÂ≥∂‰∏≠Â§ÆÈßÖ": { lat: 31.5815, lng: 130.5421, region: "ÈπøÂÖêÂ≥∂Áúå" },
            "ÈÇ£Ë¶áÁ©∫Ê∏Ø": { lat: 26.1958, lng: 127.6458, region: "Ê≤ñÁ∏ÑÁúå" },
            "ÂõΩÈöõÈÄö„Çä": { lat: 26.2124, lng: 127.6792, region: "Ê≤ñÁ∏ÑÁúå" }
        };

        // „É¢„Éê„Ç§„É´Âêë„Åë„Çµ„Ç§„Éâ„Éê„ÉºÊäò„Çä„Åü„Åü„ÅøÊ©üËÉΩ
        function initMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const sidebarHeader = document.querySelector('.sidebar-header');
            const storeList = document.querySelector('.store-list');
            
            if (window.innerWidth <= 768 && sidebarHeader) {
                // „É¢„Éê„Ç§„É´„Åß„ÅØÂàùÊúüÁä∂ÊÖã„ÅßÈÄöÂ∏∏Ë°®Á§∫Ôºà30vhÔºâ
                let currentState = 'normal'; // normal, collapsed, expanded
                
                // „Çµ„Ç§„Éâ„Éê„Éº„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
                sidebarHeader.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Áä∂ÊÖã„Çµ„Ç§„ÇØ„É´: normal ‚Üí collapsed ‚Üí expanded ‚Üí normal
                    if (currentState === 'normal') {
                        sidebar.classList.add('collapsed');
                        sidebar.classList.remove('expanded');
                        currentState = 'collapsed';
                        console.log('üìã Â∫óËàó‰∏ÄË¶ß„ÇíÊäò„Çä„Åü„Åü„Åø');
                    } else if (currentState === 'collapsed') {
                        sidebar.classList.remove('collapsed');
                        sidebar.classList.add('expanded');
                        currentState = 'expanded';
                        console.log('üìú Â∫óËàó‰∏ÄË¶ß„ÇíÂÖ®ÁîªÈù¢Ë°®Á§∫');
                    } else {
                        sidebar.classList.remove('expanded');
                        sidebar.classList.remove('collapsed');
                        currentState = 'normal';
                        console.log('üìã Â∫óËàó‰∏ÄË¶ß„ÇíÈÄöÂ∏∏Ë°®Á§∫');
                    }
                    
                    // „Éû„ÉÉ„Éó„ÅÆ„É™„Çµ„Ç§„Ç∫„Çí„Éà„É™„Ç¨„Éº
                    if (window.map) {
                        setTimeout(() => {
                            map.invalidateSize();
                        }, 400);
                    }
                });
                
                // „Çπ„ÉØ„Ç§„ÉóÊìç‰Ωú„ÅÆÊ§úÂá∫
                let startY = 0;
                let startTime = 0;
                
                sidebarHeader.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                    startTime = Date.now();
                });
                
                sidebarHeader.addEventListener('touchend', (e) => {
                    const endY = e.changedTouches[0].clientY;
                    const endTime = Date.now();
                    const deltaY = startY - endY;
                    const deltaTime = endTime - startTime;
                    const velocity = Math.abs(deltaY) / deltaTime;
                    
                    // „Çà„ÇäÊïèÊÑü„Å™„Çπ„ÉØ„Ç§„ÉóÊ§úÂá∫ÔºàË∑ùÈõ¢„Åæ„Åü„ÅØÈÄüÂ∫¶Ôºâ
                    if ((deltaY > 30 || velocity > 0.3) && deltaTime < 400 && currentState === 'normal') {
                        sidebar.classList.add('expanded');
                        currentState = 'expanded';
                        console.log('üëÜ „Çπ„ÉØ„Ç§„Éó„Ç¢„ÉÉ„Éó„ÅßÂÖ®ÁîªÈù¢Ë°®Á§∫');
                        
                        // ÊåØÂãï„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºàÂØæÂøú„Éá„Éê„Ç§„Çπ„ÅÆ„ÅøÔºâ
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                        
                        if (window.map) {
                            setTimeout(() => map.invalidateSize(), 400);
                        }
                    }
                    // ‰∏ãÂêë„Åç„Çπ„ÉØ„Ç§„Éó„ÅßÈñâ„Åò„Çã
                    else if ((deltaY < -30 || velocity > 0.3) && deltaTime < 400 && currentState === 'expanded') {
                        sidebar.classList.remove('expanded');
                        currentState = 'normal';
                        console.log('üëá „Çπ„ÉØ„Ç§„Éó„ÉÄ„Ç¶„É≥„ÅßÈÄöÂ∏∏Ë°®Á§∫');
                        
                        if (navigator.vibrate) {
                            navigator.vibrate(30);
                        }
                        
                        if (window.map) {
                            setTimeout(() => map.invalidateSize(), 400);
                        }
                    }
                });
                
                // „Çø„ÉÉ„ÉóÂèØËÉΩ„Å™„Åì„Å®„ÇíÁ§∫„Åô„Çπ„Çø„Ç§„É´
                sidebarHeader.style.cursor = 'pointer';
                sidebarHeader.style.userSelect = 'none';
            }
        }
        
        // Initialize application
        async function initApp() {
            console.log('üöÄ naco„Ç≥„Éü„É•„Éã„ÉÜ„Ç£„Éû„ÉÉ„ÉóÂàùÊúüÂåñÈñãÂßã');
            
            try {
                // Supabase is already initialized in auth check
                supabase = window.supabase;
                console.log('‚úÖ SupabaseÂàùÊúüÂåñÁ¢∫Ë™ç');

                // Check authentication
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    updateUserUI(true);
                    console.log('‚úÖ „É¶„Éº„Ç∂„ÉºË™çË®ºÊ∏à„Åø:', currentUser.email);
                } else {
                    updateUserUI(false);
                    console.log('‚ÑπÔ∏è Êú™Ë™çË®º„É¶„Éº„Ç∂„Éº');
                }

                // Initialize map with slight delay to ensure DOM is ready
                setTimeout(() => {
                    initMap();
                    initMobileSidebar(); // „É¢„Éê„Ç§„É´„Çµ„Ç§„Éâ„Éê„Éº„ÅÆÂàùÊúüÂåñ
                }, 100);

                // Wait a bit more before loading data
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Load data with error handling
                await Promise.allSettled([
                    loadStores(),
                    loadReviews(),
                    loadUserStoreLists()
                ]);
                
                updateStats();

                // Setup event listeners
                setupEventListeners();
                
                // „É≠„Ç∞„Ç§„É≥Âæå„Å´Ëá™ÂãïÁöÑ„Å´ÁèæÂú®Âú∞„ÇíÂèñÂæó„Åó„Å¶Ë∑ùÈõ¢È†Ü„Å´„ÇΩ„Éº„Éà
                if (currentUser) {
                    console.log('üîç „É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÅÆÁèæÂú®Âú∞„ÇíËá™ÂãïÂèñÂæó„Åó„Åæ„Åô...');
                    setTimeout(async () => {
                        await autoDetectLocation();
                    }, 500);
                }

                // Hide loading overlay
                document.getElementById('loadingOverlay').classList.add('hidden');

                console.log('‚úÖ naco„Ç≥„Éü„É•„Éã„ÉÜ„Ç£„Éû„ÉÉ„ÉóÂàùÊúüÂåñÂÆå‰∫Ü');
            } catch (error) {
                console.error('‚ùå ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                showNotification('„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // Initialize map (Nagoya center)
        function initMap() {
            console.log('üó∫Ô∏è „Éû„ÉÉ„ÉóÂàùÊúüÂåñÈñãÂßã...');
            
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('‚ùå mapË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            console.log('üìç mapË¶ÅÁ¥†Á¢∫Ë™çÂÆå‰∫Ü:', mapElement);
            
            try {
                // Center on Nagoya Station as default
                map = L.map('map').setView([35.1815, 136.9066], 12);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                // ÂàùÊúü„Ç∫„Éº„É†„É¨„Éô„É´„ÇíË®≠ÂÆö
                currentZoom = map.getZoom();
                
                // „Ç∫„Éº„É†Â§âÊõ¥ÊôÇ„Å´„Ç¢„Ç§„Ç≥„É≥„Çµ„Ç§„Ç∫„ÇíÂãïÁöÑ„Å´Êõ¥Êñ∞
                map.on('zoomend', function() {
                    const newZoom = map.getZoom();
                    if (newZoom !== currentZoom) {
                        console.log(`üîç „Ç∫„Éº„É†Â§âÊõ¥: ${currentZoom} ‚Üí ${newZoom}`);
                        currentZoom = newZoom;
                        updateAllMarkerSizes();
                    }
                });
                
                // „Åô„Åπ„Å¶„ÅÆ„Éû„Éº„Ç´„Éº„ÅÆ„Çµ„Ç§„Ç∫„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
                function updateAllMarkerSizes() {
                    console.log(`üîÑ „Åô„Åπ„Å¶„ÅÆ„Éû„Éº„Ç´„Éº„ÅÆ„Çµ„Ç§„Ç∫„ÇíÊõ¥Êñ∞‰∏≠... („Ç∫„Éº„É†: ${currentZoom})`);
                    
                    // „É°„Ç§„É≥„ÅÆÂ∫óËàó„Éû„Éº„Ç´„Éº„ÇíÊõ¥Êñ∞
                    markers.forEach(marker => {
                        const store = marker.options.storeData;
                        if (store) {
                            const newIcon = createCustomIcon(store.category, store, currentZoom);
                            marker.setIcon(newIcon);
                        }
                    });
                }

                // Add click event for pin mode
                map.on('click', function(e) {
                    if (pinModeActive) {
                        const { lat, lng } = e.latlng;
                        
                        // Create user pin
                        createUserPin(lat, lng);
                        
                        // Show stores near pin
                        showStoresNearUserPin(lat, lng);
                        
                        // Exit pin mode
                        pinModeActive = false;
                        document.getElementById('pinModeBtn').classList.remove('active');
                        map.getContainer().style.cursor = '';
                        
                        showNotification('üìå „Éî„É≥„ÇíÁ´ã„Å¶„Åæ„Åó„ÅüÔºÅ„Åì„ÅÆÂú∞ÁÇπ„Åã„ÇâËøë„ÅÑÈ†Ü„Å´Â∫óËàó„ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô', 'success');
                    }
                });

                console.log('‚úÖ ÂêçÂè§Â±ãÈßÖ‰∏≠ÂøÉ„Åß„Éû„ÉÉ„ÉóÂàùÊúüÂåñÂÆå‰∫Ü');
            } catch (error) {
                console.error('‚ùå „Éû„ÉÉ„ÉóÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
        }

        // Load stores from Supabase
        async function loadStores() {
            try {
                console.log('üìç Â∫óËàó„Éá„Éº„ÇøÂèñÂæó‰∏≠...');
                
                // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ: „Ç≠„É£„ÉÉ„Ç∑„É•„ÉÅ„Çß„ÉÉ„ÇØ
                if (window.performanceManager) {
                    const cachedStores = performanceManager.getCachedApiResponse('stores');
                    if (cachedStores) {
                        console.log('‚úÖ „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâÂ∫óËàó„Éá„Éº„Çø„ÇíÂèñÂæó');
                        stores = cachedStores;
                        updateStoreList(stores);
                        if (map) {
                            requestAnimationFrame(() => updateMapMarkers(stores));
                        }
                        return;
                    }
                }
                
                // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÈÅø„Åë„Çã„Åü„ÇÅ„ÅÆ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó
                const timestamp = new Date().getTime();
                console.log(`üîÑ „Éá„Éº„Çø„Éô„Éº„ÇπË™≠„ÅøËæº„ÅøÂº∑Âà∂„É™„Éï„É¨„ÉÉ„Ç∑„É•: ${timestamp}`);
                
                const { data, error } = await supabase
                    .from('stores')
                    .select('*')
                    .order('name');

                if (error) throw error;

                // Store coordinates - simple approach like original app
                stores = (data || []).map(store => {
                    return {
                        ...store,
                        // Convert database fields to original format for compatibility
                        lat: store.latitude,
                        lng: store.longitude
                    };
                });
                console.log(`‚úÖ ${stores.length}‰ª∂„ÅÆÊúâÂäπ„Å™Â∫óËàó„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫Ü`);

                // „Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠ò
                if (window.performanceManager) {
                    performanceManager.cacheApiResponse('stores', stores);
                }

                // Update UI
                updateStoreList(stores);
                
                // Wait for map to be initialized before adding markers
                if (map) {
                    requestAnimationFrame(() => {
                        updateMapMarkers(stores);
                        // Auto-fit map to show all stores nationwide
                        fitMapToAllStores(stores);
                    });
                } else {
                    console.warn('‚ö†Ô∏è „Éû„ÉÉ„ÉóÊú™ÂàùÊúüÂåñ„ÅÆ„Åü„ÇÅ„ÄÅ„Éû„Éº„Ç´„Éº‰ΩúÊàê„ÇíÂæÖÊ©ü‰∏≠...');
                    // Retry after a short delay
                    setTimeout(() => {
                        if (map) {
                            console.log('üîÑ „Éû„ÉÉ„ÉóÂàùÊúüÂåñÂÆå‰∫ÜÂæå„Å´„Éû„Éº„Ç´„Éº‰ΩúÊàê');
                            updateMapMarkers(stores);
                            fitMapToAllStores(stores);
                        } else {
                            console.error('‚ùå „Éû„ÉÉ„ÉóÂàùÊúüÂåñ„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü');
                        }
                    }, 500);
                }

            } catch (error) {
                console.error('‚ùå Â∫óËàó„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', error);
                showNotification('Â∫óËàó„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                stores = []; // „Ç®„É©„ÉºÊôÇ„ÅØÁ©∫ÈÖçÂàó„Å´
            }
        }

        // Load reviews from Supabase
        async function loadReviews() {
            try {
                const { data, error } = await supabase
                    .from('store_reviews')
                    .select('*');

                if (error) throw error;

                reviews = data || [];
                console.log(`‚úÖ ${reviews.length}‰ª∂„ÅÆ„É¨„Éì„É•„Éº„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫Ü`);

            } catch (error) {
                console.error('‚ùå „É¨„Éì„É•„Éº„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', error);
                reviews = [];
            }
        }

        // Load user store lists from Supabase
        async function loadUserStoreLists() {
            try {
                // „É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÁ©∫ÈÖçÂàó
                if (!currentUser) {
                    userStoreLists = [];
                    return;
                }

                console.log('üìã „É¶„Éº„Ç∂„Éº„ÅÆ„ÅäÂ∫ó„É™„Çπ„ÉàÂèñÂæó‰∏≠...');

                const { data, error } = await supabase
                    .from('user_store_lists')
                    .select('*')
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                userStoreLists = data || [];
                console.log(`‚úÖ ${userStoreLists.length}‰ª∂„ÅÆ„ÅäÂ∫ó„É™„Çπ„Éà„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫Ü`);

            } catch (error) {
                console.error('‚ùå „ÅäÂ∫ó„É™„Çπ„Éà„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', error);
                userStoreLists = [];
            }
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalStores').textContent = stores.length;
            document.getElementById('visibleStores').textContent = stores.length;
            document.getElementById('reviewCount').textContent = reviews.length;
        }

        // Update store list in sidebar
        function updateStoreList(storesToShow) {
            const storeList = document.getElementById('storeList');
            
            if (storesToShow.length === 0) {
                storeList.innerHTML = '<div class="no-stores"><i class="fas fa-search"></i><br>Ë©≤ÂΩì„Åô„ÇãÂ∫óËàó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            // ÁèæÂú®Âú∞„ÅåÂèñÂæó„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØË∑ùÈõ¢È†Ü„Åß„ÇΩ„Éº„Éà
            let processedStores = storesToShow;
            if (window.locationService && locationService.getCurrentLocation()) {
                processedStores = locationService.addDistanceToStores(storesToShow);
                processedStores = locationService.sortByDistance(processedStores);
            }

            // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ: requestAnimationFrame„ÅßÊèèÁîª„ÇíÊúÄÈÅ©Âåñ
            requestAnimationFrame(() => {
                const htmlContent = processedStores.map(store => {
                    const config = categoryConfig[store.category] || categoryConfig['„Åù„ÅÆ‰ªñ'];
                    
                    // Ë∑ùÈõ¢ÊÉÖÂ†±„ÅÆË°®Á§∫
                    const distanceHtml = store.distanceText ? 
                        `<div class="store-distance">
                            <i class="fas fa-route"></i>
                            ${store.distanceText}
                        </div>` : '';

                    return `
                    <div class="store-item" onclick="selectStore(${store.id})">
                        <!-- Header with store name and distance -->
                        <div class="store-header">
                            <div class="store-name">
                                <i class="${config.icon}" style="color: ${config.color};"></i>
                                <span class="name-text">${currentSearchQuery ? highlightSearchTerm(store.name, currentSearchQuery) : escapeHtml(store.name)}</span>
                            </div>
                            ${distanceHtml}
                        </div>
                        
                        <!-- Category with better contrast -->
                        <div class="store-category-wrapper">
                            <span class="store-category-new" style="background: ${config.color};">
                                ${escapeHtml(store.category)}
                            </span>
                        </div>
                        
                        <!-- Address -->
                        <div class="store-address">
                            <i class="fas fa-map-marker-alt"></i>
                            ${currentSearchQuery ? highlightSearchTerm(store.address, currentSearchQuery) : escapeHtml(store.address)}
                        </div>
                        
                        ${currentSearchQuery ? `
                            <div style="
                                background: #e8f4f8;
                                color: #2c5282;
                                padding: 6px 10px;
                                border-radius: 12px;
                                font-size: 11px;
                                margin-bottom: 8px;
                                border-left: 3px solid #4299e1;
                            ">
                                <i class="fas fa-search"></i> „Éû„ÉÉ„ÉÅ: ${getMatchReason(store, currentSearchQuery)}
                            </div>
                        ` : ''}
                        
                        <!-- Balanced action buttons -->
                        <div class="store-actions-new">
                            <button class="action-btn-new action-btn-primary" onclick="event.stopPropagation(); showStoreDetail(${store.id})">
                                <i class="fas fa-info-circle"></i>
                                <span>Ë©≥Á¥∞</span>
                            </button>
                            <button class="action-btn-new action-btn-secondary" onclick="event.stopPropagation(); showOnMap(${store.id})">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>Âú∞Âõ≥</span>
                            </button>
                            <button class="action-btn-new action-btn-accent" onclick="event.stopPropagation(); openReviewModal(${store.id}, '${escapeHtml(store.name)}')">
                                <i class="fas fa-heart"></i>
                                <span>„É¨„Éì„É•„Éº</span>
                            </button>
                        </div>
                        
                        <!-- User list buttons (only shown when logged in) -->
                        ${currentUser ? `
                            <div class="user-list-actions" style="
                                display: flex;
                                gap: 8px;
                                margin-top: 10px;
                                padding-top: 10px;
                                border-top: 1px solid #eee;
                            ">
                                ${getWantToGoButton(store.id)}
                                ${getVisitedButton(store.id)}
                            </div>
                        ` : ''}
                    </div>
                `;
                }).join('');
                
                // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ: ‰∏ÄÊã¨„ÅßDOM„ÇíÊõ¥Êñ∞
                storeList.innerHTML = htmlContent;
                document.getElementById('visibleStores').textContent = storesToShow.length;
            });
        }

        // Update map markers
        // „Ç´„ÉÜ„Ç¥„É™Âà•„Éû„Éº„Ç´„ÉºË®≠ÂÆöÔºàÊ¥óÁ∑¥„Åï„Çå„Åü„Éá„Ç∂„Ç§„É≥Ôºâ
        function getCategoryMarkerStyle(category) {
            const styles = {
                'ÂíåÈ£ü': {
                    icon: 'fas fa-bowl-rice',  // „ÅäÁ±≥/‰∏º
                    color: '#E67E22',  // Ê∏©„Åã„Åø„ÅÆ„ÅÇ„Çã„Ç™„É¨„É≥„Ç∏
                    shadowColor: 'rgba(230, 126, 34, 0.5)',
                    size: '14px'
                },
                'Ê¥ãÈ£ü': {
                    icon: 'fas fa-utensils',  // „Éä„Ç§„Éï„Éï„Ç©„Éº„ÇØ
                    color: '#27AE60',  // „Ç∞„É™„Éº„É≥Á≥ª
                    shadowColor: 'rgba(39, 174, 96, 0.5)',
                    size: '14px'
                },
                '„Ç´„Éï„Çß': {
                    icon: 'fas fa-coffee',
                    color: '#8B4513',  // Ëå∂Ëâ≤Á≥ª
                    shadowColor: 'rgba(139, 69, 19, 0.5)',
                    size: '14px'
                },
                '„Çπ„Ç§„Éº„ÉÑ': {
                    icon: 'fas fa-birthday-cake',
                    color: '#E91E63',  // ÈÆÆ„ÇÑ„Åã„Å™„Éî„É≥„ÇØ
                    shadowColor: 'rgba(233, 30, 99, 0.5)',
                    size: '14px'
                },
                '„Éë„É≥Â±ã': {
                    icon: 'fas fa-bread-slice',  // „Éë„É≥„Ç¢„Ç§„Ç≥„É≥
                    color: '#8E44AD',  // „Éë„Éº„Éó„É´Á≥ª
                    shadowColor: 'rgba(142, 68, 173, 0.5)',
                    size: '14px'
                },
                'Ë≤©Â£≤Â∫ó': {
                    icon: 'fas fa-shopping-bag',
                    color: '#FFD700',  // „Ç§„Ç®„É≠„Éº
                    shadowColor: 'rgba(255, 215, 0, 0.5)',
                    size: '14px'
                }
            };
            
            return styles[category] || {
                icon: 'fas fa-map-marker-alt',
                color: '#9370DB',  // „Éü„Éá„Ç£„Ç¢„É†„Éë„Éº„Éó„É´
                shadowColor: 'rgba(147, 112, 219, 0.4)',
                size: '14px'
            };
        }

        // ÁèæÂú®„ÅÆ„Ç∫„Éº„É†„É¨„Éô„É´„ÇíËøΩË∑°
        let currentZoom = 14;
        
        // „Ç∫„Éº„É†„É¨„Éô„É´„Å´Âü∫„Å•„ÅÑ„Å¶„Ç¢„Ç§„Ç≥„É≥„Çµ„Ç§„Ç∫„ÇíË®àÁÆó
        function getIconSizeForZoom(zoom) {
            // „Ç∫„Éº„É†„É¨„Éô„É´ 10-18 „Å´ÂØæ„Åó„Å¶ÈÅ©Âàá„Å™„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆö
            const minZoom = 10;
            const maxZoom = 18;
            const minSize = 18; // ÊúÄÂ∞è„Çµ„Ç§„Ç∫
            const maxSize = 36; // ÊúÄÂ§ß„Çµ„Ç§„Ç∫
            
            // „Ç∫„Éº„É†„É¨„Éô„É´„ÇíÁØÑÂõ≤ÂÜÖ„Å´Âà∂Èôê
            const clampedZoom = Math.max(minZoom, Math.min(maxZoom, zoom));
            
            // „É™„Éã„Ç¢„Çπ„Ç±„Éº„É™„É≥„Ç∞
            const size = minSize + ((clampedZoom - minZoom) / (maxZoom - minZoom)) * (maxSize - minSize);
            return Math.round(size);
        }
        
        // „Ç∫„Éº„É†„É¨„Éô„É´„Å´Âü∫„Å•„ÅÑ„Å¶„Ç∑„É£„Éâ„Ç¶„Å®„Éú„Éº„ÉÄ„Éº„ÅÆÂº∑Â∫¶„ÇíË®àÁÆó
        function getVisibilityEnhancement(zoom) {
            // „Ç∫„Éº„É†„ÅåÈ´ò„ÅÑ„Åª„Å©ÔºàÊã°Â§ßÊôÇÔºâ„Ç∑„É£„Éâ„Ç¶„Å®„Éú„Éº„ÉÄ„Éº„ÇíÂº∑„Åè„Åô„Çã
            const shadowIntensity = Math.min(1, zoom / 15); // 0-1„ÅÆÁØÑÂõ≤
            const borderWidth = Math.max(2, Math.min(4, zoom / 4)); // 2-4px„ÅÆÁØÑÂõ≤
            
            return {
                shadowIntensity,
                borderWidth
            };
        }

        // Ê¥óÁ∑¥„Åï„Çå„Åü„Ç´„Çπ„Çø„É†„Éû„Éº„Ç´„Éº„Ç¢„Ç§„Ç≥„É≥„Çí‰ΩúÊàêÔºàË°®Á§∫„É¢„Éº„ÉâÂØæÂøú + ÂãïÁöÑ„Çµ„Ç§„Ç∫Ë™øÊï¥Ôºâ
        function createCustomIcon(category, store = null, zoom = null) {
            // ÁèæÂú®„ÅÆ„Ç∫„Éº„É†„É¨„Éô„É´„Çí‰ΩøÁî®ÔºàÂºïÊï∞„ÅßÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥ÂêàÔºâ
            const iconZoom = zoom !== null ? zoom : currentZoom;
            const iconSize = getIconSizeForZoom(iconZoom);
            const iconHeight = Math.round(iconSize * 1.35); // „ÉÜ„Ç£„Ç¢„Éâ„É≠„ÉÉ„ÉóÂΩ¢Áä∂„ÅÆ„Åü„ÇÅÈ´ò„Åï„ÇíË™øÊï¥
            const enhancement = getVisibilityEnhancement(iconZoom);
            
            const style = getCategoryMarkerStyle(category);
            let markerColor = style.color;
            let borderColor = 'rgba(255,255,255,0.8)'; // „Çà„ÇäÊòéÁ¢∫„Å™Â¢ÉÁïåÁ∑ö
            let shadowColor = style.shadowColor;
            let badgeHtml = '';
            
            // Ë°®Á§∫„É¢„Éº„Éâ„Å®Â∫óËàó„ÅÆ„É™„Çπ„ÉàÁä∂ÊÖã„Å´Âøú„Åò„Å¶„Éû„Éº„Ç´„Éº„ÇíË£ÖÈ£æ
            if (store && currentDisplayMode === 'all') {
                const isWantToGo = isInUserList(store.id, 'want_to_go');
                const isVisited = isInUserList(store.id, 'visited');
                
                if (isVisited) {
                    // Ë°å„Å£„ÅüÂ∫óËàó: Á∑ë„ÅÆÊû†Á∑ö
                    borderColor = '#48bb78';
                    shadowColor = 'rgba(72, 187, 120, 0.5)';
                    badgeHtml = `
                        <div style="
                            position: absolute;
                            top: -6px;
                            right: -6px;
                            background: #48bb78;
                            color: white;
                            border-radius: 50%;
                            width: 16px;
                            height: 16px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 10px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        ">
                            <i class="fas fa-check"></i>
                        </div>
                    `;
                } else if (isWantToGo) {
                    // Ë°å„Åç„Åü„ÅÑÂ∫óËàó: Á¥´„ÅÆÊû†Á∑ö
                    borderColor = '#667eea';
                    shadowColor = 'rgba(102, 126, 234, 0.5)';
                    badgeHtml = `
                        <div style="
                            position: absolute;
                            top: -6px;
                            right: -6px;
                            background: #667eea;
                            color: white;
                            border-radius: 50%;
                            width: 16px;
                            height: 16px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 10px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        ">
                            <i class="fas fa-bookmark"></i>
                        </div>
                    `;
                }
            } else if (store && (currentDisplayMode === 'want_to_go' || currentDisplayMode === 'visited')) {
                // Â∞ÇÁî®„É¢„Éº„ÉâÊôÇ„ÅÆ„Éû„Éº„Ç´„ÉºËâ≤Â§âÊõ¥
                if (currentDisplayMode === 'want_to_go') {
                    markerColor = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    shadowColor = 'rgba(102, 126, 234, 0.5)';
                    borderColor = '#667eea';
                } else if (currentDisplayMode === 'visited') {
                    markerColor = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                    shadowColor = 'rgba(72, 187, 120, 0.5)';
                    borderColor = '#48bb78';
                }
            }
            
            // „Ç¢„Ç§„Ç≥„É≥„ÅÆ„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÇíÂãïÁöÑ„Å´Ë™øÊï¥
            const iconFontSize = Math.round(iconSize * 0.5);
            const pointSize = Math.round(iconSize * 0.28);
            const badgeSize = Math.round(iconSize * 0.55);
            const badgeOffset = Math.round(-iconSize * 0.2);
            
            const iconHtml = `
                <div class="sophisticated-marker">
                    <div class="marker-teardrop" style="
                        width: ${iconSize}px;
                        height: ${iconHeight}px;
                        background: ${markerColor};
                        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
                        position: relative;
                        box-shadow: 
                            0 ${Math.round(6 * enhancement.shadowIntensity)}px ${Math.round(16 * enhancement.shadowIntensity)}px ${shadowColor.replace('0.4', (0.4 * enhancement.shadowIntensity).toFixed(1))},
                            0 ${Math.round(3 * enhancement.shadowIntensity)}px ${Math.round(8 * enhancement.shadowIntensity)}px rgba(0,0,0,${(0.15 * enhancement.shadowIntensity).toFixed(2)}),
                            inset 0 1px 0 rgba(255,255,255,0.3);
                        border: ${enhancement.borderWidth}px solid ${borderColor};
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        transform-origin: center bottom;
                        transition: all 0.2s ease-out;
                    ">
                        <div class="marker-point" style="
                            position: absolute;
                            bottom: -${Math.round(enhancement.borderWidth/2)}px;
                            left: 50%;
                            transform: translateX(-50%) rotate(45deg);
                            width: ${pointSize}px;
                            height: ${pointSize}px;
                            background: ${typeof markerColor === 'string' && markerColor.includes('gradient') ? style.color : markerColor};
                            border-radius: 0 0 0 50%;
                            border: ${Math.max(1, Math.round(enhancement.borderWidth/2))}px solid ${borderColor};
                        "></div>
                        <i class="${style.icon}" style="
                            color: white;
                            font-size: ${iconFontSize}px;
                            text-shadow: 
                                0 1px 2px rgba(0,0,0,${(0.5 * enhancement.shadowIntensity).toFixed(2)}),
                                0 2px 4px rgba(0,0,0,${(0.3 * enhancement.shadowIntensity).toFixed(2)});
                            z-index: 10;
                            margin-top: -2px;
                            filter: drop-shadow(0 0 2px rgba(0,0,0,0.3));
                        "></i>
                    </div>
                    ${badgeHtml.replace(/16px/g, `${badgeSize}px`).replace(/-6px/g, `${badgeOffset}px`)}
                </div>
            `;
            
            return L.divIcon({
                html: iconHtml,
                className: 'sophisticated-marker-wrapper',
                iconSize: [iconSize, iconHeight],
                iconAnchor: [Math.round(iconSize/2), iconHeight],
                popupAnchor: [0, -iconHeight]
            });
        }

        // „Éû„Éº„Ç´„Éº„ÇØ„É©„Çπ„Çø„Éº„Ç∞„É´„Éº„ÉóÔºà„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©ÂåñÔºâ
        let markerClusterGroup = null;
        
        function updateMapMarkers(storesToShow) {
            console.log(`üó∫Ô∏è „Éû„Éº„Ç´„ÉºÊõ¥Êñ∞ÈñãÂßã: ${storesToShow.length}‰ª∂„ÅÆÂ∫óËàó`);
            
            if (!map) {
                console.error('‚ùå „Éû„ÉÉ„Éó„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }
            
            // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ: „ÇØ„É©„Çπ„Çø„Éº„Ç∞„É´„Éº„Éó„ÅßÊó¢Â≠ò„Éû„Éº„Ç´„Éº„Çí‰∏ÄÊã¨ÂâäÈô§
            if (markerClusterGroup) {
                map.removeLayer(markerClusterGroup);
                markerClusterGroup = null;
            }
            markers = [];

            // Add new markers with custom icons
            let successCount = 0;
            let failCount = 0;
            const newMarkers = [];
            
            // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊ∏¨ÂÆöÈñãÂßã
            if (window.performanceManager) {
                performanceManager.startMeasure('marker-creation');
            }
            
            storesToShow.forEach(store => {
                try {
                    // Original app style: simple check for lat/lng existence
                    if (store.lat && store.lng) {
                        console.log(`üìç „Éû„Éº„Ç´„Éº‰ΩúÊàê: ${store.name} at [${store.lat}, ${store.lng}]`);
                        
                        const customIcon = createCustomIcon(store.category, store, currentZoom);
                        const style = getCategoryMarkerStyle(store.category);
                        
                        const marker = L.marker([store.lat, store.lng], { 
                            icon: customIcon,
                            storeData: store // „Éû„Éº„Ç´„Éº„Å´Â∫óËàó„Éá„Éº„Çø„Çí‰øùÂ≠ò
                        })
                            .bindPopup(`
                                <div class="custom-popup" style="
                                    min-width: 220px;
                                    background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
                                    border-radius: 16px;
                                    padding: 0;
                                    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
                                    border: 1px solid rgba(0,0,0,0.06);
                                    overflow: hidden;
                                ">
                                    <!-- Header with store name -->
                                    <div style="
                                        background: linear-gradient(135deg, ${style.color} 0%, ${style.borderColor || style.color} 100%);
                                        padding: 16px 18px 14px;
                                        margin: 0;
                                    ">
                                        <h3 style="
                                            margin: 0;
                                            color: white;
                                            font-size: 18px;
                                            font-weight: 700;
                                            line-height: 1.2;
                                            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
                                            letter-spacing: 0.3px;
                                        ">${escapeHtml(store.name)}</h3>
                                        <div style="
                                            margin: 8px 0 0 0;
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                        ">
                                            <span style="
                                                background: rgba(255,255,255,0.25);
                                                color: white;
                                                padding: 4px 12px;
                                                border-radius: 20px;
                                                font-size: 12px;
                                                font-weight: 500;
                                                border: 1px solid rgba(255,255,255,0.3);
                                            ">${escapeHtml(store.category)}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Content area -->
                                    <div style="padding: 16px 18px;">
                                        <div style="
                                            margin: 0 0 16px 0;
                                            color: #666;
                                            font-size: 13px;
                                            line-height: 1.4;
                                            display: flex;
                                            align-items: flex-start;
                                            gap: 6px;
                                        ">
                                            <span style="color: #999; margin-top: 1px;">üìç</span>
                                            <span>${escapeHtml(store.address)}</span>
                                        </div>
                                        
                                        <!-- Subtle detail button -->
                                        <button onclick="showStoreDetail(${store.id})" style="
                                            width: 100%;
                                            background: rgba(74, 144, 226, 0.08);
                                            color: #4A90E2;
                                            border: 1px solid rgba(74, 144, 226, 0.2);
                                            padding: 12px 16px;
                                            border-radius: 12px;
                                            font-size: 13px;
                                            font-weight: 500;
                                            cursor: pointer;
                                            transition: all 0.2s ease;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            gap: 6px;
                                        " onmouseover="
                                            this.style.background='rgba(74, 144, 226, 0.12)';
                                            this.style.borderColor='rgba(74, 144, 226, 0.3)';
                                            this.style.transform='translateY(-1px)';
                                        " onmouseout="
                                            this.style.background='rgba(74, 144, 226, 0.08)';
                                            this.style.borderColor='rgba(74, 144, 226, 0.2)';
                                            this.style.transform='translateY(0)';
                                        ">
                                            <span style="font-size: 12px;">‚ÑπÔ∏è</span>
                                            Ë©≥Á¥∞„ÇíË¶ã„Çã
                                        </button>
                                    </div>
                                </div>
                            `)
                            ;
                        
                        newMarkers.push(marker);
                        markers.push(marker);
                        successCount++;
                    } else {
                        console.warn(`‚ö†Ô∏è „Çπ„Ç≠„ÉÉ„Éó: ${store.name} - Â∫ßÊ®ô„Å™„Åó`);
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                    console.error(`‚ùå „Éû„Éº„Ç´„Éº‰ΩúÊàê„Ç®„É©„Éº (${store.name}):`, error);
                }
            });
            
            // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ: „Éû„Éº„Ç´„Éº„ÇØ„É©„Çπ„Çø„É™„É≥„Ç∞„Çí‰ΩøÁî®
            if (newMarkers.length > 0) {
                // „ÇØ„É©„Çπ„Çø„Éº„Ç∞„É´„Éº„Éó„ÅÆË®≠ÂÆö
                markerClusterGroup = L.markerClusterGroup({
                    maxClusterRadius: 50,           // „ÇØ„É©„Çπ„Çø„ÉºÂçäÂæÑ
                    spiderfyOnMaxZoom: true,        // ÊúÄÂ§ß„Ç∫„Éº„É†ÊôÇ„Å´Â±ïÈñã
                    showCoverageOnHover: false,     // „Éõ„Éê„ÉºÊôÇ„ÅÆÁØÑÂõ≤Ë°®Á§∫„ÇíÁÑ°ÂäπÂåñ
                    zoomToBoundsOnClick: true,      // „ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´„Ç∫„Éº„É†
                    disableClusteringAtZoom: 16,    // „Ç∫„Éº„É†„É¨„Éô„É´16‰ª•‰∏ä„Åß„ÅØ„ÇØ„É©„Çπ„Çø„É™„É≥„Ç∞ÁÑ°Âäπ
                    animate: true,                   // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÊúâÂäπ
                    animateAddingMarkers: false,     // „Éû„Éº„Ç´„ÉºËøΩÂä†ÊôÇ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅØÁÑ°ÂäπÔºà„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÔºâ
                    chunkedLoading: true,            // „ÉÅ„É£„É≥„ÇØÂçò‰Ωç„Åß„ÅÆË™≠„ÅøËæº„Åø
                    chunkInterval: 200,              // „ÉÅ„É£„É≥„ÇØÈñìÈöî
                    chunkDelay: 50                   // „ÉÅ„É£„É≥„ÇØÈÅÖÂª∂
                });
                
                // „Éû„Éº„Ç´„Éº„Çí„ÇØ„É©„Çπ„Çø„Éº„Ç∞„É´„Éº„Éó„Å´ËøΩÂä†
                markerClusterGroup.addLayers(newMarkers);
                map.addLayer(markerClusterGroup);
            }
            
            // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊ∏¨ÂÆöÁµÇ‰∫Ü
            if (window.performanceManager) {
                performanceManager.endMeasure('marker-creation');
            }
            
            console.log(`üìä „Éû„Éº„Ç´„Éº‰ΩúÊàêÁµêÊûú: ÊàêÂäü ${successCount}‰ª∂, Â§±Êïó ${failCount}‰ª∂`);
        }

        // Fit map to show all stores nationwide
        function fitMapToAllStores(stores) {
            try {
                const storesWithCoords = stores.filter(store => store.lat && store.lng);
                if (storesWithCoords.length > 0) {
                    console.log(`üóæ ÂÖ®ÂõΩÂØæÂøú: ${storesWithCoords.length}‰ª∂„ÅÆÂ∫óËàó„Å´Âú∞Âõ≥„ÇíË™øÊï¥‰∏≠...`);
                    
                    const bounds = L.latLngBounds(
                        storesWithCoords.map(store => [store.lat, store.lng])
                    );
                    
                    map.fitBounds(bounds, { 
                        padding: [20, 20], 
                        maxZoom: 12 // Prevent zooming in too much for nationwide view
                    });
                    
                    console.log('‚úÖ ÂÖ®ÂõΩ„ÅÆÂ∫óËàó„ÅåË°®Á§∫„Åï„Çå„Çã„Çà„ÅÜÂú∞Âõ≥„ÇíË™øÊï¥ÂÆå‰∫Ü');
                } else {
                    console.warn('‚ö†Ô∏è Â∫ßÊ®ô„ÅÆ„ÅÇ„ÇãÂ∫óËàó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }
            } catch (error) {
                console.error('‚ùå Âú∞Âõ≥Ë™øÊï¥„Ç®„É©„Éº:', error);
            }
        }

        // Select store (highlight and center on map)
        function selectStore(storeId) {
            try {
                const store = stores.find(s => s.id === storeId);
                if (!store) {
                    console.warn('Â∫óËàó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', storeId);
                    return;
                }
                
                // Original app style: use lat/lng if they exist
                if (store.lat && store.lng) {
                    map.setView([store.lat, store.lng], 15);
                } else {
                    console.warn(`Â∫óËàó„ÅÆÂ∫ßÊ®ô„Åå„ÅÇ„Çä„Åæ„Åõ„Çì: ${store.name}`);
                }
                
                // Find and open popup for this store's marker
                const marker = markers.find(m => {
                    try {
                        const markerLatLng = m.getLatLng();
                        return Math.abs(markerLatLng.lat - store.latitude) < 0.00001 && 
                               Math.abs(markerLatLng.lng - store.longitude) < 0.00001;
                    } catch (e) {
                        return false;
                    }
                });
                
                if (marker) {
                    marker.openPopup();
                }
            } catch (error) {
                console.error('Â∫óËàóÈÅ∏Êäû„Ç®„É©„Éº:', error);
            }
        }

        // Show store on map
        function showOnMap(storeId) {
            selectStore(storeId);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            const searchBox = document.getElementById('searchBox');
            searchBox.addEventListener('input', handleSearch);

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', handleFilter);
            });
            
            
            // ÁèæÂú®Âú∞„Çµ„Éº„Éì„Çπ„ÅÆÂàùÊúüÂåñ
            initLocationService();

            // Auth state change listener
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('üîê Ë™çË®ºÁä∂ÊÖãÂ§âÊõ¥:', event, session?.user?.email);
                
                if (session) {
                    currentUser = session.user;
                    updateUserUI(true);
                    // „É≠„Ç∞„Ç§„É≥Âæå„Å´„É¶„Éº„Ç∂„Éº„É™„Çπ„Éà„ÇíË™≠„ÅøËæº„Åø
                    await loadUserStoreLists();
                    updateStoreList(stores); // UI„ÇíÊõ¥Êñ∞
                } else {
                    currentUser = null;
                    userStoreLists = []; // „É≠„Ç∞„Ç¢„Ç¶„ÉàÊôÇ„Å´„É™„Çπ„Éà„Çí„ÇØ„É™„Ç¢
                    updateUserUI(false);
                    updateStoreList(stores); // UI„ÇíÊõ¥Êñ∞
                }
            });
        }

        // Handle search with enhanced search fields
        async function handleSearch(event) {
            const query = event.target.value.trim();
            
            if (query === '') {
                currentSearchQuery = ''; // Ê§úÁ¥¢„ÇØ„Ç®„É™„Çí„ÇØ„É™„Ç¢
                updateStoreList(stores);
                updateMapMarkers(stores);
                // Ê§úÁ¥¢„ÇØ„É™„Ç¢ÊôÇ„ÅØÊ§úÁ¥¢ÊÉÖÂ†±„ÇíÈùûË°®Á§∫
                hideSearchInfo();
                return;
            }
            
            const lowerQuery = query.toLowerCase();
            
            // Êã°ÂºµÊ§úÁ¥¢: Ë§áÊï∞„Éï„Ç£„Éº„É´„Éâ„Åã„ÇâÊ§úÁ¥¢
            const filtered = stores.filter(store => {
                // ÂêÑ„Éï„Ç£„Éº„É´„Éâ„ÇíÂÆâÂÖ®„Å´„ÉÅ„Çß„ÉÉ„ÇØ
                const nameMatch = store.name && store.name.toLowerCase().includes(lowerQuery);
                const addressMatch = store.address && store.address.toLowerCase().includes(lowerQuery);
                const categoryMatch = store.category && store.category.toLowerCase().includes(lowerQuery);
                const descriptionMatch = store.description && store.description.toLowerCase().includes(lowerQuery);
                const nacoCommentMatch = store.nacoComment && store.nacoComment.toLowerCase().includes(lowerQuery);
                const hoursMatch = store.hours && store.hours.toLowerCase().includes(lowerQuery);
                const closedMatch = store.closed && store.closed.toLowerCase().includes(lowerQuery);
                
                // „Å©„Çå„Åã‰∏Ä„Å§„Åß„ÇÇ„Éû„ÉÉ„ÉÅ„Åô„Çå„Å∞true
                return nameMatch || addressMatch || categoryMatch || descriptionMatch || 
                       nacoCommentMatch || hoursMatch || closedMatch;
            });
            
            // Ê§úÁ¥¢ÁµêÊûú„ÅÆË©≥Á¥∞„ÇíË°®Á§∫
            if (filtered.length > 0) {
                currentSearchQuery = query; // Ê§úÁ¥¢„ÇØ„Ç®„É™„Çí‰øùÂ≠ò
                updateStoreList(filtered);
                updateMapMarkers(filtered);
                showSearchInfo(query, filtered.length);
                return;
            }
            
            // Â∫óËàó„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅ„É©„É≥„Éâ„Éû„Éº„ÇØÊ§úÁ¥¢„ÇíË©¶Ë°å
            await searchLandmarkAndShowNearbyStores(query);
        }
        
        // Ê§úÁ¥¢ÊÉÖÂ†±„ÇíË°®Á§∫
        function showSearchInfo(query, resultCount) {
            // Êó¢Â≠ò„ÅÆÊ§úÁ¥¢ÊÉÖÂ†±„ÇíÂâäÈô§
            hideSearchInfo();
            
            // Ê§úÁ¥¢ÊÉÖÂ†±„Çí‰ΩúÊàê
            const searchInfo = document.createElement('div');
            searchInfo.id = 'searchInfo';
            searchInfo.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 10px 15px;
                font-size: 13px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #ddd;
            `;
            
            searchInfo.innerHTML = `
                <span>
                    <i class="fas fa-search"></i> 
                    „Äå${escapeHtml(query)}„Äç„ÅÆÊ§úÁ¥¢ÁµêÊûú: ${resultCount}‰ª∂
                </span>
                <button onclick="clearSearch()" style="
                    background: rgba(255,255,255,0.2);
                    border: 1px solid rgba(255,255,255,0.3);
                    color: white;
                    padding: 4px 10px;
                    border-radius: 15px;
                    font-size: 11px;
                    cursor: pointer;
                ">
                    <i class="fas fa-times"></i> „ÇØ„É™„Ç¢
                </button>
            `;
            
            // „Éï„Ç£„É´„Çø„Éº„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÂâç„Å´ÊåøÂÖ•
            const filtersSection = document.querySelector('.filters');
            filtersSection.parentNode.insertBefore(searchInfo, filtersSection);
        }
        
        // Ê§úÁ¥¢ÊÉÖÂ†±„ÇíÈùûË°®Á§∫
        function hideSearchInfo() {
            const searchInfo = document.getElementById('searchInfo');
            if (searchInfo) {
                searchInfo.remove();
            }
        }
        
        // Ê§úÁ¥¢„Çí„ÇØ„É™„Ç¢
        function clearSearch() {
            document.getElementById('searchBox').value = '';
            currentSearchQuery = ''; // Ê§úÁ¥¢„ÇØ„Ç®„É™„Çí„ÇØ„É™„Ç¢
            updateStoreList(stores);
            updateMapMarkers(stores);
            hideSearchInfo();
        }
        
        // Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„Çí„Éè„Ç§„É©„Ç§„ÉàË°®Á§∫„Åô„ÇãÈñ¢Êï∞
        function highlightSearchTerm(text, searchTerm) {
            if (!text || !searchTerm) return text || '';
            
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            return text.replace(regex, '<mark style="background: #fff3cd; padding: 2px 4px; border-radius: 3px;">$1</mark>');
        }
        
        // Ê≠£Ë¶èË°®Áèæ„ÅÆÁâπÊÆäÊñáÂ≠ó„Çí„Ç®„Çπ„Ç±„Éº„Éó
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // Ê§úÁ¥¢„Å´„Éû„ÉÉ„ÉÅ„Åó„ÅüÁêÜÁî±„ÇíË°®Á§∫
        function getMatchReason(store, searchTerm) {
            const lowerQuery = searchTerm.toLowerCase();
            const reasons = [];
            
            if (store.name && store.name.toLowerCase().includes(lowerQuery)) {
                reasons.push('Â∫óÂêç');
            }
            if (store.address && store.address.toLowerCase().includes(lowerQuery)) {
                reasons.push('‰ΩèÊâÄ');
            }
            if (store.category && store.category.toLowerCase().includes(lowerQuery)) {
                reasons.push('„Ç´„ÉÜ„Ç¥„É™„Éº');
            }
            if (store.description && store.description.toLowerCase().includes(lowerQuery)) {
                reasons.push('Ë©≥Á¥∞');
            }
            if (store.nacoComment && store.nacoComment.toLowerCase().includes(lowerQuery)) {
                reasons.push('„Ç≥„É°„É≥„Éà');
            }
            if (store.hours && store.hours.toLowerCase().includes(lowerQuery)) {
                reasons.push('Âñ∂Ê•≠ÊôÇÈñì');
            }
            if (store.closed && store.closed.toLowerCase().includes(lowerQuery)) {
                reasons.push('ÂÆö‰ºëÊó•');
            }
            
            return reasons.join('„Éª');
        }
        
        // „ÅäÂ∫ó„É™„Çπ„ÉàÈñ¢ÈÄ£„ÅÆ„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function isInUserList(storeId, listType) {
            return userStoreLists.some(item => 
                item.store_id === storeId && item.list_type === listType
            );
        }
        
        function getWantToGoButton(storeId) {
            const isAdded = isInUserList(storeId, 'want_to_go');
            const buttonClass = isAdded ? 'user-list-btn active' : 'user-list-btn';
            const icon = isAdded ? 'fas fa-bookmark' : 'far fa-bookmark';
            const text = isAdded ? 'Ë°å„Åç„Åü„ÅÑÊ∏à' : 'Ë°å„Åç„Åü„ÅÑ';
            
            return `
                <button class="${buttonClass}" onclick="event.stopPropagation(); toggleUserList(${storeId}, 'want_to_go')" style="
                    background: ${isAdded ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white'};
                    color: ${isAdded ? 'white' : '#667eea'};
                    border: 2px solid #667eea;
                    padding: 6px 12px;
                    border-radius: 15px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                    flex: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 4px;
                ">
                    <i class="${icon}"></i>
                    <span>${text}</span>
                </button>
            `;
        }
        
        function getVisitedButton(storeId) {
            const isAdded = isInUserList(storeId, 'visited');
            const buttonClass = isAdded ? 'user-list-btn active' : 'user-list-btn';
            const icon = isAdded ? 'fas fa-check-circle' : 'far fa-circle';
            const text = isAdded ? 'Ë°å„Å£„ÅüÊ∏à' : 'Ë°å„Å£„Åü';
            
            return `
                <button class="${buttonClass}" onclick="event.stopPropagation(); toggleUserList(${storeId}, 'visited')" style="
                    background: ${isAdded ? 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)' : 'white'};
                    color: ${isAdded ? 'white' : '#48bb78'};
                    border: 2px solid #48bb78;
                    padding: 6px 12px;
                    border-radius: 15px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                    flex: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 4px;
                ">
                    <i class="${icon}"></i>
                    <span>${text}</span>
                </button>
            `;
        }
        
        // „É¶„Éº„Ç∂„Éº„É™„Çπ„Éà„ÅÆÁôªÈå≤„ÉªÂâäÈô§Âá¶ÁêÜ
        async function toggleUserList(storeId, listType) {
            if (!currentUser) {
                showNotification('„É™„Çπ„Éà„Å´ËøΩÂä†„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô', 'error');
                return;
            }
            
            try {
                const isCurrentlyInList = isInUserList(storeId, listType);
                
                if (isCurrentlyInList) {
                    // ÂâäÈô§Âá¶ÁêÜ
                    const { error } = await supabase
                        .from('user_store_lists')
                        .delete()
                        .eq('user_id', currentUser.id)
                        .eq('store_id', storeId)
                        .eq('list_type', listType);
                        
                    if (error) throw error;
                    
                    // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„Åã„ÇâÂâäÈô§
                    userStoreLists = userStoreLists.filter(item => 
                        !(item.user_id === currentUser.id && 
                          item.store_id === storeId && 
                          item.list_type === listType)
                    );
                    
                    const actionText = listType === 'want_to_go' ? 'Ë°å„Åç„Åü„ÅÑ' : 'Ë°å„Å£„Åü';
                    showNotification(`${actionText}„É™„Çπ„Éà„Åã„ÇâÂâäÈô§„Åó„Åæ„Åó„Åü`, 'success');
                    
                } else {
                    // ËøΩÂä†Âá¶ÁêÜÂâç„Å´„ÄÅÂèçÂØæ„ÅÆ„É™„Çπ„Éà„Åã„ÇâÂâäÈô§ÔºàÊéí‰ªñÁöÑÈÅ∏ÊäûÔºâ
                    const oppositeListType = listType === 'want_to_go' ? 'visited' : 'want_to_go';
                    const isInOppositeList = isInUserList(storeId, oppositeListType);
                    
                    if (isInOppositeList) {
                        // ÂèçÂØæ„ÅÆ„É™„Çπ„Éà„Åã„ÇâÂâäÈô§
                        const { error: deleteError } = await supabase
                            .from('user_store_lists')
                            .delete()
                            .eq('user_id', currentUser.id)
                            .eq('store_id', storeId)
                            .eq('list_type', oppositeListType);
                            
                        if (deleteError) throw deleteError;
                        
                        // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„Åã„ÇâÂâäÈô§
                        userStoreLists = userStoreLists.filter(item => 
                            !(item.user_id === currentUser.id && 
                              item.store_id === storeId && 
                              item.list_type === oppositeListType)
                        );
                    }
                    
                    // ËøΩÂä†Âá¶ÁêÜ
                    const newItem = {
                        user_id: currentUser.id,
                        store_id: storeId,
                        list_type: listType,
                        created_at: new Date().toISOString()
                    };
                    
                    const { data, error } = await supabase
                        .from('user_store_lists')
                        .insert([newItem])
                        .select();
                        
                    if (error) throw error;
                    
                    // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„Å´ËøΩÂä†
                    if (data && data.length > 0) {
                        userStoreLists.push(data[0]);
                    }
                    
                    const actionText = listType === 'want_to_go' ? 'Ë°å„Åç„Åü„ÅÑ' : 'Ë°å„Å£„Åü';
                    const oppositeActionText = oppositeListType === 'want_to_go' ? 'Ë°å„Åç„Åü„ÅÑ' : 'Ë°å„Å£„Åü';
                    
                    if (isInOppositeList) {
                        showNotification(`${oppositeActionText}„É™„Çπ„Éà„Åã„Çâ${actionText}„É™„Çπ„Éà„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, 'success');
                    } else {
                        showNotification(`${actionText}„É™„Çπ„Éà„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü`, 'success');
                    }
                }
                
                // UI„ÇíÊõ¥Êñ∞ÔºàÂ∫óËàó„É™„Çπ„Éà„ÇíÂÜçÊèèÁîªÔºâ
                const currentStores = document.getElementById('storeList').children.length > 0 ? 
                    getCurrentDisplayedStores() : stores;
                updateStoreList(currentStores);
                
            } catch (error) {
                console.error('‚ùå „É¶„Éº„Ç∂„Éº„É™„Çπ„ÉàÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                showNotification('„É™„Çπ„Éà„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        // ÁèæÂú®Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÂ∫óËàó„ÇíÂèñÂæóÔºà„Éï„Ç£„É´„Çø„ÉºÁä∂ÊÖã„ÇíÁ∂≠ÊåÅÔºâ
        function getCurrentDisplayedStores() {
            // „Éï„Ç£„É´„Çø„ÉºÁä∂ÊÖã„Å´Âøú„Åò„Å¶ÁèæÂú®„ÅÆÂ∫óËàó„É™„Çπ„Éà„ÇíËøî„Åô
            let currentStores = stores;
            
            // „Ç´„ÉÜ„Ç¥„É™„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®
            if (activeFilters.categories.size > 0) {
                currentStores = currentStores.filter(store => 
                    activeFilters.categories.has(store.category)
                );
            }
            
            // Ê§úÁ¥¢„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®
            if (currentSearchQuery) {
                const lowerQuery = currentSearchQuery.toLowerCase();
                currentStores = currentStores.filter(store => {
                    const nameMatch = store.name && store.name.toLowerCase().includes(lowerQuery);
                    const addressMatch = store.address && store.address.toLowerCase().includes(lowerQuery);
                    const categoryMatch = store.category && store.category.toLowerCase().includes(lowerQuery);
                    const descriptionMatch = store.description && store.description.toLowerCase().includes(lowerQuery);
                    const nacoCommentMatch = store.nacoComment && store.nacoComment.toLowerCase().includes(lowerQuery);
                    const hoursMatch = store.hours && store.hours.toLowerCase().includes(lowerQuery);
                    const closedMatch = store.closed && store.closed.toLowerCase().includes(lowerQuery);
                    
                    return nameMatch || addressMatch || categoryMatch || descriptionMatch || 
                           nacoCommentMatch || hoursMatch || closedMatch;
                });
            }
            
            return currentStores;
        }
        
        // Ë°®Á§∫„É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàÈñ¢Êï∞
        function changeDisplayMode(mode) {
            currentDisplayMode = mode;
            
            // „Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.display-mode-btn').forEach(btn => {
                const isActive = btn.dataset.mode === mode;
                btn.classList.toggle('active', isActive);
                
                if (isActive) {
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´
                    if (mode === 'normal') {
                        btn.style.background = 'linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-lavender) 100%)';
                        btn.style.color = 'white';
                    } else if (mode === 'all') {
                        btn.style.background = 'linear-gradient(135deg, #4a5568 0%, #2d3748 100%)';
                        btn.style.color = 'white';
                    } else if (mode === 'want_to_go') {
                        btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        btn.style.color = 'white';
                    } else if (mode === 'visited') {
                        btn.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                        btn.style.color = 'white';
                    }
                } else {
                    // Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´
                    btn.style.background = 'white';
                    if (mode === 'want_to_go') {
                        btn.style.color = '#667eea';
                    } else if (mode === 'visited') {
                        btn.style.color = '#48bb78';
                    } else {
                        btn.style.color = '#333';
                    }
                }
            });
            
            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
            updateDisplayForMode();
        }
        
        // „É¢„Éº„Éâ„Å´Âøú„Åò„Å¶Ë°®Á§∫„ÇíÊõ¥Êñ∞
        function updateDisplayForMode() {
            const filteredStores = getStoresForDisplayMode(currentDisplayMode);
            updateStoreList(filteredStores);
            updateMapMarkers(filteredStores);
            
            // Ë°®Á§∫‰ª∂Êï∞„ÇíÊõ¥Êñ∞
            document.getElementById('visibleStores').textContent = filteredStores.length;
            
            // „É¢„Éº„Éâ„Å´Âøú„Åò„ÅüÈÄöÁü•
            const modeNames = {
                'normal': 'ÈÄöÂ∏∏Ë°®Á§∫',
                'all': 'ÂÖ®Ë°®Á§∫ÔºàÈÄöÂ∏∏+Ë°å„Åç„Åü„ÅÑ+Ë°å„Å£„ÅüÔºâ',
                'want_to_go': 'Ë°å„Åç„Åü„ÅÑ„ÅäÂ∫ó',
                'visited': 'Ë°å„Å£„Åü„ÅäÂ∫ó'
            };
            
            if (currentDisplayMode !== 'normal') {
                showNotification(`${modeNames[currentDisplayMode]}„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü`, 'info');
            }
        }
        
        // Ë°®Á§∫„É¢„Éº„Éâ„Å´Âøú„Åò„ÅüÂ∫óËàó„ÇíÂèñÂæó
        function getStoresForDisplayMode(mode) {
            let baseStores = getCurrentDisplayedStores(); // Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®Ê∏à„Åø
            
            switch (mode) {
                case 'normal':
                    return baseStores; // ÈÄöÂ∏∏Ë°®Á§∫Ôºà„Åô„Åπ„Å¶„ÅÆÂ∫óËàóÔºâ
                    
                case 'all':
                    // ÂÖ®Ë°®Á§∫: ÈÄöÂ∏∏ + Ë°å„Åç„Åü„ÅÑ + Ë°å„Å£„ÅüÔºàÈáçË§áÈô§ÂéªÔºâ
                    return baseStores; // „Éû„Éº„Ç´„Éº„ÅßË¶ñË¶öÁöÑ„Å´Âå∫Âà•
                    
                case 'want_to_go':
                    // Ë°å„Åç„Åü„ÅÑÂ∫óËàó„ÅÆ„Åø
                    const wantToGoStoreIds = userStoreLists
                        .filter(item => item.list_type === 'want_to_go')
                        .map(item => item.store_id);
                    return baseStores.filter(store => wantToGoStoreIds.includes(store.id));
                    
                case 'visited':
                    // Ë°å„Å£„ÅüÂ∫óËàó„ÅÆ„Åø
                    const visitedStoreIds = userStoreLists
                        .filter(item => item.list_type === 'visited')
                        .map(item => item.store_id);
                    return baseStores.filter(store => visitedStoreIds.includes(store.id));
                    
                default:
                    return baseStores;
            }
        }

        // „É©„É≥„Éâ„Éû„Éº„ÇØÊ§úÁ¥¢„Å®Âë®Ëæ∫Â∫óËàóË°®Á§∫
        async function searchLandmarkAndShowNearbyStores(query) {
            try {
                // 1. „Éó„É™„Çª„ÉÉ„Éà„É©„É≥„Éâ„Éû„Éº„ÇØ„Åã„ÇâÊ§úÁ¥¢
                const landmark = findLandmarkFromPresets(query);
                if (landmark) {
                    await showStoresNearLocation(landmark, `${query}Âë®Ëæ∫`);
                    return;
                }

                // 2. „Ç∏„Ç™„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„ÅßÊ§úÁ¥¢
                const geocodedLocation = await geocodeQuery(query);
                if (geocodedLocation) {
                    await showStoresNearLocation(geocodedLocation, `${query}Âë®Ëæ∫`);
                    return;
                }

                // 3. „Å©„Å°„Çâ„ÇÇË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà
                console.log(`‚ö†Ô∏è „Äå${query}„Äç„Å´Ë©≤ÂΩì„Åô„ÇãÂ∫óËàó„ÉªÂ†¥ÊâÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü`);
                updateStoreList(stores); // ÂÖ®Â∫óËàó„ÇíË°®Á§∫

            } catch (error) {
                console.error('‚ùå Ê§úÁ¥¢„Ç®„É©„Éº:', error);
                updateStoreList(stores);
            }
        }

        // „Éó„É™„Çª„ÉÉ„Éà„É©„É≥„Éâ„Éû„Éº„ÇØ„Åã„ÇâÊ§úÁ¥¢
        function findLandmarkFromPresets(query) {
            const queryLower = query.toLowerCase();
            
            // ÂÆåÂÖ®‰∏ÄËá¥Ê§úÁ¥¢
            for (const [name, data] of Object.entries(landmarkDatabase)) {
                if (name.toLowerCase() === queryLower) {
                    console.log(`‚úÖ „Éó„É™„Çª„ÉÉ„Éà„É©„É≥„Éâ„Éû„Éº„ÇØÁô∫Ë¶ã: ${name}`);
                    return { lat: data.lat, lng: data.lng, name: name, region: data.region };
                }
            }

            // ÈÉ®ÂàÜ‰∏ÄËá¥Ê§úÁ¥¢
            for (const [name, data] of Object.entries(landmarkDatabase)) {
                if (name.toLowerCase().includes(queryLower) || queryLower.includes(name.toLowerCase())) {
                    console.log(`‚úÖ „Éó„É™„Çª„ÉÉ„Éà„É©„É≥„Éâ„Éû„Éº„ÇØÁô∫Ë¶ãÔºàÈÉ®ÂàÜ‰∏ÄËá¥Ôºâ: ${name}`);
                    return { lat: data.lat, lng: data.lng, name: name, region: data.region };
                }
            }

            return null;
        }

        // „Ç∏„Ç™„Ç≥„Éº„Éá„Ç£„É≥„Ç∞Ê§úÁ¥¢
        async function geocodeQuery(query) {
            if (!window.locationService) {
                return null;
            }

            try {
                console.log(`üîç „Ç∏„Ç™„Ç≥„Éº„Éá„Ç£„É≥„Ç∞Ê§úÁ¥¢: ${query}`);
                const result = await locationService.geocodeAddress(query);
                if (result) {
                    console.log(`‚úÖ „Ç∏„Ç™„Ç≥„Éº„Éá„Ç£„É≥„Ç∞ÊàêÂäü:`, result);
                    return { 
                        lat: result.lat, 
                        lng: result.lng, 
                        name: query,
                        address: result.display_name 
                    };
                }
            } catch (error) {
                console.log('‚ö†Ô∏è „Ç∏„Ç™„Ç≥„Éº„Éá„Ç£„É≥„Ç∞Â§±Êïó:', error);
            }

            return null;
        }

        // ÊåáÂÆöÂú∞ÁÇπÂë®Ëæ∫„ÅÆÂ∫óËàó„ÇíË°®Á§∫
        async function showStoresNearLocation(location, searchTitle) {
            try {
                // „Éû„ÉÉ„Éó„ÇíÊåáÂÆöÂú∞ÁÇπ„Å´ÁßªÂãï
                map.setView([location.lat, location.lng], 13);

                // Ê§úÁ¥¢Âú∞ÁÇπ„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
                addSearchLocationMarker(location);

                // Âë®Ëæ∫Â∫óËàó„ÇíË∑ùÈõ¢È†Ü„ÅßÂèñÂæóÔºàÂçäÂæÑ20km‰ª•ÂÜÖÔºâ
                const storesWithDistance = window.locationService 
                    ? locationService.addDistanceToStores(stores, location)
                    : stores;
                
                const nearbyStores = window.locationService
                    ? locationService.getStoresWithinRadius(stores, 20, location) // 20km‰ª•ÂÜÖ
                    : stores;

                const sortedStores = window.locationService
                    ? locationService.sortByDistance(nearbyStores)
                    : nearbyStores;

                // Ë°®Á§∫„ÇíÊõ¥Êñ∞
                updateStoreList(sortedStores);
                updateMapMarkers(sortedStores);

                // ÊàêÂäü„É≠„Ç∞
                console.log(`‚úÖ ${searchTitle} Âë®Ëæ∫Â∫óËàóË°®Á§∫ÂÆå‰∫Ü: ${sortedStores.length}‰ª∂`);

            } catch (error) {
                console.error('‚ùå Âë®Ëæ∫Â∫óËàóË°®Á§∫„Ç®„É©„Éº:', error);
            }
        }

        // Ê§úÁ¥¢Âú∞ÁÇπ„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
        function addSearchLocationMarker(location) {
            // Êó¢Â≠ò„ÅÆÊ§úÁ¥¢„Éû„Éº„Ç´„Éº„ÇíÂâäÈô§
            if (window.searchLocationMarker) {
                map.removeLayer(window.searchLocationMarker);
            }

            // Ê§úÁ¥¢Âú∞ÁÇπ„Éû„Éº„Ç´„Éº„Çí‰ΩúÊàê
            const iconHtml = `
                <div class="search-location-marker">
                    <i class="fas fa-search"></i>
                </div>
            `;
            
            const customIcon = L.divIcon({
                html: iconHtml,
                className: 'search-location-wrapper',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            window.searchLocationMarker = L.marker([location.lat, location.lng], { 
                icon: customIcon,
                zIndexOffset: 900
            }).addTo(map);

            // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíËøΩÂä†
            const popupContent = `
                <div class="search-popup">
                    <h4>${location.name}</h4>
                    ${location.region ? `<p class="region">${location.region}</p>` : ''}
                    ${location.address ? `<p class="address">${location.address}</p>` : ''}
                </div>
            `;
            window.searchLocationMarker.bindPopup(popupContent);
        }

        // Global state for filters and search
        let activeFilters = {
            categories: new Set()
        };
        let currentSearchQuery = '';
        let currentDisplayMode = 'normal'; // 'normal', 'all', 'want_to_go', 'visited'
        
        // Handle filter with multiple selection support
        function handleFilter(event) {
            const button = event.target.closest('.filter-btn');
            const category = button.dataset.category;
            
            if (category === 'all') {
                // Clear all category filters
                activeFilters.categories.clear();
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');
            } else {
                // Toggle category filter
                document.querySelector('.filter-btn[data-category="all"]').classList.remove('active');
                
                if (activeFilters.categories.has(category)) {
                    activeFilters.categories.delete(category);
                    button.classList.remove('active');
                } else {
                    activeFilters.categories.add(category);
                    button.classList.add('active');
                }
                
                // If no filters active, activate "all"
                if (activeFilters.categories.size === 0) {
                    document.querySelector('.filter-btn[data-category="all"]').classList.add('active');
                }
            }
            
            applyAllFilters();
        }
        
        // Apply all active filters
        function applyAllFilters() {
            let filtered = stores;
            
            // Apply category filters
            if (activeFilters.categories.size > 0) {
                filtered = filtered.filter(store => 
                    activeFilters.categories.has(store.category)
                );
            }
            
            // Update displays with filtered results
            updateStoreList(filtered);
            updateMapMarkers(filtered);
        }

        // Update user UI
        function updateUserUI(isLoggedIn) {
            const loginSection = document.getElementById('loginSection');
            const userSection = document.getElementById('userSection');
            const userAvatar = document.getElementById('userAvatar');
            const displayModeSection = document.getElementById('displayModeSection');

            if (isLoggedIn && currentUser) {
                loginSection.style.display = 'none';
                userSection.style.display = 'flex';
                displayModeSection.style.display = 'block'; // Ë°®Á§∫„É¢„Éº„Éâ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
                
                // Set avatar initial
                const name = currentUser.user_metadata?.full_name || currentUser.email;
                userAvatar.textContent = name.charAt(0).toUpperCase();
            } else {
                loginSection.style.display = 'block';
                userSection.style.display = 'none';
                displayModeSection.style.display = 'none'; // Ë°®Á§∫„É¢„Éº„Éâ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈùûË°®Á§∫
                
                // „É≠„Ç∞„Ç¢„Ç¶„ÉàÊôÇ„ÅØÈÄöÂ∏∏Ë°®Á§∫„Å´Êàª„Åô
                currentDisplayMode = 'normal';
            }
        }

        // Handle login
        async function handleLogin() {
            try {
                console.log('üîê „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜÈñãÂßã');
                
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.href
                    }
                });

                if (error) throw error;

            } catch (error) {
                console.error('‚ùå „É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
                showNotification('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                console.log('üîì „É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜÈñãÂßã');
                
                const { error } = await supabase.auth.signOut();
                if (error) throw error;

                showNotification('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü', 'success');

            } catch (error) {
                console.error('‚ùå „É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
                showNotification('„É≠„Ç∞„Ç¢„Ç¶„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // Open review modal
        function openReviewModal(storeId, storeName) {
            if (!currentUser) {
                showNotification('„É¨„Éì„É•„Éº„ÇíÊäïÁ®ø„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô', 'error');
                return;
            }

            const modal = document.getElementById('reviewModal');
            const title = document.getElementById('reviewModalTitle');
            const body = document.getElementById('reviewModalBody');

            title.innerHTML = `<i class="fas fa-heart"></i> ${storeName} „ÅÆ„É¨„Éì„É•„Éº`;
            
            body.innerHTML = `
                <div class="review-form">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-comment-alt"></i>
                            „Ç≥„É°„É≥„Éà
                        </label>
                        <textarea class="form-textarea" id="reviewComment" placeholder="„Åì„ÅÆ„ÅäÂ∫ó„ÅÆ„Ç∞„É´„ÉÜ„É≥„Éï„É™„ÉºÂØæÂøú„Å´„Å§„ÅÑ„Å¶„ÄÅ„Åø„Çì„Å™„Å´„Ç∑„Çß„Ç¢„Åó„Åæ„Åó„Çá„ÅÜ‚ô™" required></textarea>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="reviewVisited">
                            <label for="reviewVisited">ÂÆüÈöõ„Å´Ë®™Âïè„Åó„Åæ„Åó„Åü</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn-primary" onclick="submitReview(${storeId})">
                            <i class="fas fa-heart"></i> „É¨„Éì„É•„Éº„ÇíÊäïÁ®ø
                        </button>
                        <button class="btn-secondary" onclick="closeReviewModal()">
                            „Ç≠„É£„É≥„Çª„É´
                        </button>
                    </div>
                    <div id="reviewMessage"></div>
                </div>
            `;

            modal.style.display = 'flex';
        }

        // Close review modal
        function closeReviewModal() {
            document.getElementById('reviewModal').style.display = 'none';
        }

        // Submit review
        async function submitReview(storeId) {
            const comment = document.getElementById('reviewComment').value.trim();
            const visited = document.getElementById('reviewVisited').checked;
            const messageDiv = document.getElementById('reviewMessage');

            if (!comment) {
                messageDiv.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-circle"></i>„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                return;
            }

            try {
                const { error } = await supabase
                    .from('store_reviews')
                    .insert({
                        store_id: storeId,
                        user_id: currentUser.id,
                        comment: comment,
                        visited: visited,
                        rating: 5 // „Éá„Éï„Ç©„É´„ÉàË©ï‰æ°
                    });

                if (error) throw error;

                messageDiv.innerHTML = '<div class="success-message"><i class="fas fa-check-circle"></i>„É¨„Éì„É•„Éº„ÇíÊäïÁ®ø„Åó„Åæ„Åó„ÅüÔºÅ</div>';
                
                // Reload reviews
                await loadReviews();
                updateStats();
                
                setTimeout(() => {
                    closeReviewModal();
                    showNotification('„É¨„Éì„É•„Éº„ÅÆÊäïÁ®ø„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ', 'success');
                }, 2000);

            } catch (error) {
                console.error('‚ùå „É¨„Éì„É•„ÉºÊäïÁ®ø„Ç®„É©„Éº:', error);
                messageDiv.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-circle"></i>„É¨„Éì„É•„Éº„ÅÆÊäïÁ®ø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
            }
        }

        // Show floating notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `floating-notification ${type === 'error' ? 'error-message' : 'success-message'}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                ${message}
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 4000);
        }

        // Location service functions
        function initLocationService() {
            if (typeof window.locationService === 'undefined') {
                console.warn('‚ö†Ô∏è LocationService not available');
                return;
            }
            console.log('üìç LocationServiceÂàùÊúüÂåñÂÆå‰∫Ü');
        }

        // Pin mode functions
        function togglePinMode() {
            pinModeActive = !pinModeActive;
            const pinBtn = document.getElementById('pinModeBtn');
            
            if (pinModeActive) {
                pinBtn.classList.add('active');
                map.getContainer().style.cursor = 'crosshair';
                showNotification('üìå Âú∞Âõ≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éî„É≥„ÇíÁ´ã„Å¶„Å¶„Åè„Å†„Åï„ÅÑ', 'info');
            } else {
                pinBtn.classList.remove('active');
                map.getContainer().style.cursor = '';
                showNotification('„Éî„É≥„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü', 'info');
            }
        }

        // Create user pin marker
        function createUserPin(lat, lng) {
            // Remove existing user pin
            if (userPin) {
                map.removeLayer(userPin);
            }

            const iconHtml = `<div class="user-pin-marker"></div>`;
            
            const customIcon = L.divIcon({
                html: iconHtml,
                className: 'user-pin-wrapper',
                iconSize: [32, 32],
                iconAnchor: [16, 30]
            });

            userPin = L.marker([lat, lng], { 
                icon: customIcon,
                zIndexOffset: 1100
            }).addTo(map);

            const popupContent = `
                <div class="pin-popup">
                    <h4>üìå ÊåáÂÆöÂú∞ÁÇπ</h4>
                    <p>„Åì„ÅÆÂú∞ÁÇπ„Åã„ÇâËøë„ÅÑÂ∫óËàóÈ†Ü„Å´Ë°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô</p>
                    <button onclick="removeUserPin()" style="
                        background: #ff4757;
                        color: white;
                        border: none;
                        padding: 6px 12px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 12px;
                        margin-top: 8px;
                    ">„Éî„É≥„ÇíÂâäÈô§</button>
                </div>
            `;
            userPin.bindPopup(popupContent);

            return userPin;
        }

        // Remove user pin
        function removeUserPin() {
            if (userPin) {
                map.removeLayer(userPin);
                userPin = null;
                updateStoreList(stores); // Reset to original order
                showNotification('„Éî„É≥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
            }
        }

        // Show stores near user pin
        function showStoresNearUserPin(lat, lng) {
            if (!window.locationService) {
                console.warn('LocationService not available for user pin');
                return;
            }

            try {
                const pinLocation = { lat, lng };
                
                // Calculate distances and sort
                const storesWithDistance = locationService.addDistanceToStores(stores, pinLocation);
                const sortedStores = locationService.sortByDistance(storesWithDistance);
                
                // Update display
                updateStoreList(sortedStores);
                updateMapMarkers(sortedStores);
                
                console.log(`‚úÖ ÊåáÂÆöÂú∞ÁÇπÂë®Ëæ∫„ÅÆÂ∫óËàó ${sortedStores.length}‰ª∂„ÇíË∑ùÈõ¢È†Ü„ÅßË°®Á§∫`);
                
            } catch (error) {
                console.error('‚ùå „Éî„É≥Âë®Ëæ∫Â∫óËàóË°®Á§∫„Ç®„É©„Éº:', error);
            }
        }

        // Auto-detect user location on app startup
        async function autoDetectLocation() {
            if (typeof window.locationService === 'undefined') {
                console.warn('‚ö†Ô∏è LocationService not available for auto-detection');
                return;
            }

            // Check if geolocation is supported
            if (!locationService.isSupported()) {
                console.log('üìç ‰ΩçÁΩÆÊÉÖÂ†±API„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            try {
                console.log('üìç Ëá™ÂãïÁèæÂú®Âú∞ÂèñÂæó„ÇíÈñãÂßãÔºàÈùô„Åã„Å´ÂÆüË°åÔºâ...');
                
                // ÂàùÂõû„É≠„Ç∞„Ç§„É≥ÊôÇ„ÅÆ„Åø„ÄÅ‰ΩçÁΩÆÊÉÖÂ†±Ë®±ÂèØ„Çí‰øÉ„Åô
                const hasLocationPermission = localStorage.getItem('locationPermissionGranted');
                if (!hasLocationPermission) {
                    showNotification('üìç ÁèæÂú®Âú∞„ÇíÂèñÂæó„Åó„Å¶ÊúÄÂØÑ„Çä„ÅÆÂ∫óËàó„ÇíË°®Á§∫„Åó„Åæ„Åô', 'info');
                }
                
                // Try to get current position with a shorter timeout for initial load
                const location = await locationService.getCurrentPosition({
                    timeout: 8000, // 8Áßí„Åß„Çø„Ç§„É†„Ç¢„Ç¶„Éà
                    enableHighAccuracy: false // ÂàùÊúüÂèñÂæó„ÅØ‰ΩéÁ≤æÂ∫¶„Åß„ÇÇÈÄüÂ∫¶ÂÑ™ÂÖà
                });
                
                if (location) {
                    console.log('‚úÖ Ëá™ÂãïÁèæÂú®Âú∞ÂèñÂæóÊàêÂäü:', location);
                    
                    // ‰ΩçÁΩÆÊÉÖÂ†±Ë®±ÂèØ„ÇíË®òÈå≤
                    localStorage.setItem('locationPermissionGranted', 'true');
                    
                    // Create and add current location marker
                    if (window.currentLocationMarker) {
                        map.removeLayer(window.currentLocationMarker);
                        if (window.currentLocationMarker.accuracyCircle) {
                            map.removeLayer(window.currentLocationMarker.accuracyCircle);
                        }
                    }
                    
                    const marker = locationService.createCurrentLocationMarker(location);
                    window.currentLocationMarker = marker;
                    
                    marker.addTo(map);
                    if (marker.accuracyCircle) {
                        marker.accuracyCircle.addTo(map);
                    }
                    
                    // Move map to current location
                    map.setView([location.lat, location.lng], 14);
                    
                    // Update store list with distance sorting
                    updateStoreList(stores);
                    
                    // Ëá™ÂãïÂèñÂæóÊôÇ„ÅØÈÄöÁü•„ÇíË°®Á§∫„Åó„Å™„ÅÑÔºàÈùô„Åã„Å´ÂÆüË°åÔºâ
                    console.log('‚úÖ Ëá™ÂãïÁèæÂú®Âú∞ÂèñÂæóÂÆå‰∫ÜÔºöÂ∫óËàó„É™„Çπ„Éà„ÇíË∑ùÈõ¢È†Ü„ÅßÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                }
                
            } catch (error) {
                console.log('üìç Ëá™ÂãïÁèæÂú®Âú∞ÂèñÂæó„Çí„Çπ„Ç≠„ÉÉ„Éó:', error.message);
                // Don't show error notification for auto-detection failure
                // User can still manually get location if needed
            }
        }


        async function getCurrentLocation() {
            if (typeof window.locationService === 'undefined') {
                showNotification('‰ΩçÁΩÆÊÉÖÂ†±„Çµ„Éº„Éì„Çπ„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì', 'error');
                return;
            }

            try {
                showNotification('ÁèæÂú®Âú∞„ÇíÂèñÂæó‰∏≠...', 'info');
                
                const location = await locationService.getCurrentPosition();
                
                if (location) {
                    // ÁèæÂú®Âú∞„Éû„Éº„Ç´„Éº„Çí‰ΩúÊàê„ÉªËøΩÂä†
                    if (window.currentLocationMarker) {
                        map.removeLayer(window.currentLocationMarker);
                        if (window.currentLocationMarker.accuracyCircle) {
                            map.removeLayer(window.currentLocationMarker.accuracyCircle);
                        }
                    }
                    
                    const marker = locationService.createCurrentLocationMarker(location);
                    window.currentLocationMarker = marker;
                    
                    marker.addTo(map);
                    if (marker.accuracyCircle) {
                        marker.accuracyCircle.addTo(map);
                    }
                    
                    // ÁèæÂú®Âú∞„Å´„Éû„ÉÉ„Éó„ÇíÁßªÂãï
                    map.setView([location.lat, location.lng], 15);
                    
                    showNotification('ÁèæÂú®Âú∞„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü', 'success');
                } else {
                    showNotification('ÁèæÂú®Âú∞„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } catch (error) {
                console.error('‚ùå ÁèæÂú®Âú∞ÂèñÂæó„Ç®„É©„Éº:', error);
                showNotification('ÁèæÂú®Âú∞„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }


        // Utility functions
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize when DOM is loaded
        // DOMContentLoaded removed - initApp called after auth check

        // Handle modal clicks outside content
        document.getElementById('reviewModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeReviewModal();
            }
        });

        // Store detail modal event listeners
        document.getElementById('storeDetailModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeStoreDetailModal();
            }
        });

        // Lightbox modal event listeners
        document.getElementById('lightboxModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeLightbox();
            }
        });

        // Global variables for lightbox
        let currentImages = [];
        let currentImageIndex = 0;
        
        // Helper functions for store details
        function formatBusinessHours(hours) {
            if (!hours) return 'Âñ∂Ê•≠ÊôÇÈñìÊÉÖÂ†±„Å™„Åó';
            // Parse business hours if it's in a structured format
            if (typeof hours === 'object') {
                return Object.entries(hours)
                    .map(([day, time]) => `${day}: ${time}`)
                    .join('<br>');
            }
            return hours;
        }
        
        
        function isOpenNow(hours) {
            // Simple check for current time
            const now = new Date();
            const currentHour = now.getHours();
            const currentDay = now.getDay();
            
            // This is a simplified check - would need proper parsing of hours format
            if (!hours) return null;
            
            // Return null if we can't determine
            return null;
        }

        // Show store detail modal
        function showStoreDetail(storeId) {
            const store = stores.find(s => s.id === storeId);
            if (!store) {
                console.error('Store not found:', storeId);
                return;
            }

            // Set title with category badge
            const categoryStyle = getCategoryMarkerStyle(store.category);
            document.getElementById('storeDetailTitle').innerHTML = `
                <div class="modal-store-name">${escapeHtml(store.name)}</div>
                <div class="modal-category-badge">${escapeHtml(store.category)}</div>
            `;

            // Create images array
            currentImages = [];
            if (store.image_url) currentImages.push(store.image_url);
            if (store.image_url_2) currentImages.push(store.image_url_2);
            if (store.image_url_3) currentImages.push(store.image_url_3);
            // ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊóß„Éï„Ç£„Éº„É´„Éâ„ÇÇÂØæÂøú
            if (store.imageUrl) currentImages.push(store.imageUrl);
            if (store.imageUrl2) currentImages.push(store.imageUrl2);
            if (store.imageUrl3) currentImages.push(store.imageUrl3);

            // Build store detail content
            const detailBody = document.getElementById('storeDetailBody');
            detailBody.innerHTML = `
                <div class="store-images-container">
                    <div class="main-image" onclick="openLightbox(0)">
                        ${currentImages[0] ? 
                            `<img src="${currentImages[0]}" alt="${store.name}">` : 
                            '<div class="image-placeholder">ÁîªÂÉè„Å™„Åó</div>'
                        }
                    </div>
                    <div class="secondary-images">
                        <div class="secondary-image" onclick="openLightbox(1)">
                            ${currentImages[1] ? 
                                `<img src="${currentImages[1]}" alt="${store.name}">` : 
                                '<div class="image-placeholder">ÁîªÂÉè„Å™„Åó</div>'
                            }
                        </div>
                        <div class="secondary-image" onclick="openLightbox(2)">
                            ${currentImages[2] ? 
                                `<img src="${currentImages[2]}" alt="${store.name}">` : 
                                '<div class="image-placeholder">ÁîªÂÉè„Å™„Åó</div>'
                            }
                        </div>
                    </div>
                </div>

                <div class="store-detail-info">
                    <div class="store-detail-section">
                        <h4><i class="fas fa-map-marker-alt"></i> ‰ΩèÊâÄ</h4>
                        <p>${store.address || '‰ΩèÊâÄÊÉÖÂ†±„Å™„Åó'}</p>
                        ${store.lat && store.lng && window.locationService && locationService.getCurrentLocation() ? `
                            <p style="color: #4CAF50; font-size: 14px; margin-top: 8px;">
                                <i class="fas fa-route"></i> 
                                ÁèæÂú®Âú∞„Åã„Çâ ${locationService.formatDistance(
                                    locationService.calculateDistance(
                                        locationService.getCurrentLocation().lat,
                                        locationService.getCurrentLocation().lng,
                                        store.lat,
                                        store.lng
                                    )
                                )}
                            </p>
                        ` : ''}
                    </div>

                    <div class="store-detail-section">
                        <h4><i class="fas fa-clock"></i> Âñ∂Ê•≠ÊôÇÈñì</h4>
                        <p>${formatBusinessHours(store.hours || store.business_hours)}</p>
                    </div>

                    ${store.closed || store.holiday ? `
                        <div class="store-detail-section">
                            <h4><i class="fas fa-calendar-times"></i> ÂÆö‰ºëÊó•</h4>
                            <p>${store.closed || store.holiday}</p>
                        </div>
                    ` : ''}
                    
                    ${store.phone ? `
                        <div class="store-detail-section">
                            <h4><i class="fas fa-phone"></i> ÈõªË©±Áï™Âè∑</h4>
                            <p><a href="tel:${store.phone}" style="color: #4CAF50; text-decoration: none;">${store.phone}</a></p>
                        </div>
                    ` : ''}

                    ${store.description ? `
                        <div class="store-detail-section">
                            <h4><i class="fas fa-info-circle"></i> Ë©≥Á¥∞</h4>
                            <p>${store.description}</p>
                        </div>
                    ` : ''}

                    ${store.nacoComment ? `
                        <div class="store-detail-section">
                            <h4><i class="fas fa-user-circle"></i> naco„Åï„Çì„ÅÆ„Ç≥„É°„É≥„Éà</h4>
                            <p style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary);">${store.nacoComment}</p>
                        </div>
                    ` : ''}

                    <div class="store-actions">
                        ${store.lat && store.lng ? `
                            <button class="store-action-btn" onclick="showOnMap(${store.id}); closeStoreDetailModal();">
                                <i class="fas fa-map"></i> Âú∞Âõ≥„ÅßË°®Á§∫
                            </button>
                        ` : ''}
                        
                        ${store.website ? `
                            <a href="${store.website}" target="_blank" class="store-action-btn">
                                <i class="fas fa-globe"></i> „Ç¶„Çß„Éñ„Çµ„Ç§„Éà
                            </a>
                        ` : ''}
                        
                        ${store.instagram ? `
                            <a href="${store.instagram}" target="_blank" class="store-action-btn">
                                <i class="fab fa-instagram"></i> Instagram
                            </a>
                        ` : ''}
                        
                        ${store.googleMapsUrl || (store.lat && store.lng) ? `
                            <a href="${store.googleMapsUrl || `https://www.google.com/maps?q=${store.lat},${store.lng}`}" target="_blank" class="store-action-btn">
                                <i class="fas fa-directions"></i> Google Maps
                            </a>
                        ` : ''}

                        <button class="store-action-btn" onclick="openReviewModal(${store.id})">
                            <i class="fas fa-star"></i> „É¨„Éì„É•„Éº
                        </button>
                    </div>
                </div>
            `;

            // Show modal with animation
            const modal = document.getElementById('storeDetailModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        // Close store detail modal
        function closeStoreDetailModal() {
            const modal = document.getElementById('storeDetailModal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // Open lightbox
        function openLightbox(imageIndex) {
            if (!currentImages || currentImages.length === 0) return;
            
            currentImageIndex = imageIndex;
            const image = currentImages[currentImageIndex];
            
            if (image) {
                document.getElementById('lightboxImage').src = image;
                document.getElementById('lightboxCounter').textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
                document.getElementById('lightboxModal').style.display = 'flex';
            }
        }

        // Close lightbox
        function closeLightbox() {
            document.getElementById('lightboxModal').style.display = 'none';
        }

        // Navigate to previous image
        function prevImage() {
            if (currentImages.length === 0) return;
            currentImageIndex = currentImageIndex > 0 ? currentImageIndex - 1 : currentImages.length - 1;
            document.getElementById('lightboxImage').src = currentImages[currentImageIndex];
            document.getElementById('lightboxCounter').textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
        }

        // Navigate to next image
        function nextImage() {
            if (currentImages.length === 0) return;
            currentImageIndex = currentImageIndex < currentImages.length - 1 ? currentImageIndex + 1 : 0;
            document.getElementById('lightboxImage').src = currentImages[currentImageIndex];
            document.getElementById('lightboxCounter').textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
        }

        // Keyboard navigation for lightbox
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('lightboxModal').style.display === 'flex') {
                switch(e.key) {
                    case 'Escape':
                        closeLightbox();
                        break;
                    case 'ArrowLeft':
                        prevImage();
                        break;
                    case 'ArrowRight':
                        nextImage();
                        break;
                }
            }
        });

        // ÈÅÖÂª∂Ë™≠„ÅøËæº„ÅøÁîªÂÉè„Çí‰ΩúÊàê
        function createLazyImage(src, alt, className = '') {
            const imgId = 'lazy-img-' + Math.random().toString(36).substr(2, 9);
            
            // DOM„ÅåÊõ¥Êñ∞„Åï„Çå„ÅüÂæå„Å´ÈÅÖÂª∂Ë™≠„ÅøËæº„Åø„ÇíÁôªÈå≤
            setTimeout(() => {
                const img = document.getElementById(imgId);
                if (img) {
                    performanceManager.registerLazyImage(img, src, alt);
                }
            }, 100);
            
            return `<img id="${imgId}" alt="${escapeHtml(alt)}" class="${className} lazy-image">`;
        }

        // Make functions globally available for onclick handlers
        window.openReviewModal = openReviewModal;
        window.closeReviewModal = closeReviewModal;
        window.submitReview = submitReview;
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        window.selectStore = selectStore;
        window.showOnMap = showOnMap;
        window.createLazyImage = createLazyImage;
        
        // „Éö„Éº„Ç∏„Ç¢„É≥„É≠„Éº„ÉâÊôÇ„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        window.addEventListener('beforeunload', () => {
            if (window.performanceManager) {
                performanceManager.cleanup();
            }
        });
    </script>
</body>
</html>