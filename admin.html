<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理画面 - グルテンフリーマップ</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #ffb6c1 0%, #98d8c8 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #4a4a4a;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .btn {
            background: linear-gradient(135deg, #ffb6c1 0%, #98d8c8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: linear-gradient(135deg, #ffb6c1 0%, #98d8c8 100%);
            color: white;
            font-weight: bold;
        }
        
        .category-badge {
            padding: 4px 12px;
            border-radius: 12px;
            color: white;
            font-size: 12px;
        }
        
        .category-和食 { background-color: #ff6b6b; }
        .category-洋食 { background-color: #4ecdc4; }
        .category-カフェ { background-color: #f7b731; }
        .category-パン屋 { background-color: #5f27cd; }
        .category-販売店 { background-color: #00d2d3; }
        .category-スイーツ { background-color: #ff69b4; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            max-height: 90vh;
            margin: 50px auto;
            padding: 30px;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a4a4a;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #98d8c8;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        #extractBtn {
            margin-top: 8px;
            background: #4CAF50;
            color: white;
            border: none;
            font-weight: bold;
        }
        
        #extractBtn:hover:not(:disabled) {
            background: #45a049;
        }
        
        .template-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .template-buttons .btn {
            flex: 1;
            min-width: 150px;
            font-size: 14px;
        }
        
        /* 現在の設定表示エリア */
        .current-config {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin: 20px 0;
            padding: 0;
            overflow: hidden;
        }
        
        .config-header {
            background: linear-gradient(135deg, #98d8c8 0%, #ffb6c1 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .config-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .btn-small {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-small:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .config-content {
            padding: 20px;
        }
        
        .config-item {
            margin-bottom: 15px;
        }
        
        .config-item label {
            display: block;
            font-weight: bold;
            color: #4a4a4a;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .config-value {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            font-size: 14px;
            word-break: break-all;
            color: #666;
        }
        
        .config-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .config-actions .btn {
            flex: 1;
            min-width: 120px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🍰 グルテンフリーマップ管理画面</h1>
            <p>店舗情報の追加・編集・削除ができます</p>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="showAddModal()">➕ 新しい店舗を追加</button>
            <button class="btn" onclick="loadFromSpreadsheet()">📊 スプレッドシートから読み込み</button>
            <button class="btn" onclick="showCSVUploadModal()" style="background-color: #4caf50; color: white;">📤 CSVファイルをアップロード</button>
            <button class="btn" onclick="loadFromSpreadsheetReplace()" style="background-color: #ff9800; color: white;">⚠️ スプレッドシートで置き換え</button>
            <button class="btn" onclick="showSpreadsheetSettings()">⚙️ スプレッドシート設定</button>
            <button class="btn" onclick="showVisitStatusModal()" style="background-color: #9c27b0; color: white;">🏆 訪問ステータス管理</button>
            <button class="btn btn-success" onclick="saveToGitHubDirect()">🚀 GitHubに直接保存</button>
            <button class="btn" onclick="saveToGitHub()">💾 ファイルダウンロード</button>
            <button class="btn" onclick="reloadStoresData()">🔄 最新データを読み込み</button>
        </div>
        
        <!-- 現在のスプレッドシート設定表示 -->
        <div id="currentSpreadsheetInfo" class="current-config" style="display: none;">
            <div class="config-header">
                <h3>📋 現在のスプレッドシート設定</h3>
                <button class="btn-small" onclick="toggleSpreadsheetInfo()">非表示</button>
            </div>
            <div class="config-content">
                <div class="config-item">
                    <label>設定済みURL:</label>
                    <div id="currentUrl" class="config-value"></div>
                </div>
                <div class="config-item">
                    <label>シート名:</label>
                    <div id="currentSheet" class="config-value"></div>
                </div>
                <div class="config-actions">
                    <button class="btn" onclick="testCurrentConnection()">🔍 接続テスト</button>
                    <button class="btn" onclick="showSpreadsheetSettings()">✏️ 設定変更</button>
                    <button class="btn" onclick="clearSpreadsheetSettings()" style="background: #dc3545;">🗑️ 設定削除</button>
                </div>
            </div>
        </div>
        
        <!-- GitHub設定モーダル -->
        <div id="githubModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeGitHubModal()">&times;</span>
                <h2>GitHub設定</h2>
                <p>初回のみ設定が必要です。Personal Access Tokenを入力してください。</p>
                
                <div class="form-group">
                    <label>GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                    <div class="help-text">
                        <strong>取得方法:</strong><br>
                        1. GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)<br>
                        2. 「Generate new token」→「Generate new token (classic)」<br>
                        3. 「Contents」権限を選択<br>
                        4. 生成されたトークンをコピー
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="saveGitHubToken()">保存</button>
                <button class="btn" onclick="closeGitHubModal()">キャンセル</button>
            </div>
        </div>
        
        <!-- スプレッドシート設定モーダル -->
        <div id="spreadsheetModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeSpreadsheetModal()">&times;</span>
                <h2>スプレッドシート連携設定</h2>
                <p>Google Sheetsから店舗データを読み込む設定を行います。</p>
                
                <div class="form-group">
                    <label>Google Sheets URL</label>
                    <input type="url" id="spreadsheetUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
                    <div class="help-text">
                        <strong>🔧 設定方法:</strong><br>
                        <strong>1. スプレッドシートを共有可能にする</strong><br>
                        • Google Sheetsの「共有」ボタンをクリック<br>
                        • 「一般的なアクセス」を「リンクを知っている全員」に変更<br>
                        • 権限は「閲覧者」でOK<br><br>
                        
                        <strong>2. URLをコピー</strong><br>
                        • 共有画面でURLをコピーして上記欄に貼り付け<br>
                        • 例: https://docs.google.com/spreadsheets/d/.../edit?usp=sharing<br><br>
                        
                        <strong>📋 スプレッドシートの形式:</strong><br>
                        • 1行目：ヘッダー（必須列）<br>
                        • 列順：店舗名, カテゴリー, 住所, 緯度, 経度, 営業時間, 定休日, 電話番号, 店舗説明, GF対応, テイクアウト, 席数, nacoコメント, naco訪問済み(旧), <strong style="color: #9c27b0;">訪問ステータス</strong>, <strong style="color: #9c27b0;">確認者</strong>, <strong style="color: #9c27b0;">最終更新</strong>, ウェブサイト, Instagram, メイン画像URL, 追加画像URL1, 追加画像URL2, GoogleマップURL<br>
                        • 2行目以降：店舗データ<br>
                        <br>
                        <strong>🆕 訪問ステータスについて:</strong><br>
                        • <strong>訪問ステータス列:</strong> "naco", "member", "unvisited" のいずれかを入力<br>
                        • <strong>確認者列:</strong> 確認した人の名前を入力<br>
                        • <strong>最終更新列:</strong> YYYY-MM 形式で入力（例: 2024-12）<br><br>
                        
                        <strong>⚠️ エラーが出る場合:</strong><br>
                        「ファイル」→「共有」→「ウェブに公開」を試してください
                    </div>
                </div>
                
                <div class="form-group">
                    <label>シート名（オプション）</label>
                    <input type="text" id="sheetName" placeholder="シート1" value="シート1">
                    <div class="help-text">
                        読み込みたいシートの名前（デフォルト：シート1）
                    </div>
                </div>
                
                <div class="form-group">
                    <h3>スプレッドシートの列構成</h3>
                    <div class="help-text">
                        <strong>📋 簡単4ステップでデータ管理：</strong><br>
                        1️⃣ 下のボタンでテンプレートをダウンロード<br>
                        2️⃣ Google Sheetsにインポートしてデータを編集<br>
                        3️⃣ <strong style="color: #9c27b0;">選択項目にドロップダウンを設定（推奨）</strong><br>
                        4️⃣ 「ファイル」→「共有」→「ウェブに公開」でCSV形式で公開<br><br>
                        
                        <strong>📝 重要：データ入力は3行目から</strong><br>
                        • 1行目：ヘッダー（列名）<br>
                        • 2行目：入力指示・選択肢<br>
                        • <strong style="color: #9c27b0;">3行目以降：実際の店舗データ</strong><br><br>
                        
                        <strong>🎯 ドロップダウン設定方法（Google Sheets）：</strong><br>
                        • 列を選択 → 「データ」→「データの入力規則」<br>
                        • カテゴリー列：和食,洋食,中華,イタリアン,フレンチ,カフェ,デザート,ベーカリー,その他<br>
                        • GF対応列：完全GF,部分GF<br>
                        • テイクアウト列：TRUE,FALSE<br>
                        • 訪問ステータス列：naco,member,unvisited<br><br>
                        
                        <strong>📍 座標取得の優先順位：</strong><br>
                        • <strong style="color: #d32f2f;">最優先：</strong> 緯度・経度列に手入力した座標<br>
                        • <strong style="color: #f57c00;">次優先：</strong> GoogleマップURL列から自動抽出<br>
                        • <strong style="color: #616161;">最後：</strong> 住所からのジオコーディング（管理画面で手動実行）<br>
                        • 店名・住所は手入力必須、座標はGoogleマップから取得推奨<br><br>
                        
                        <strong>必要な列（この順番で配置してください）:</strong><br>
                        A列: 店舗名, B列: カテゴリー, C列: 住所, D列: 緯度, E列: 経度<br>
                        F列: 営業時間, G列: 定休日, H列: 電話番号, I列: 店舗説明<br>
                        J列: GF対応, K列: テイクアウト, L列: 席数, M列: nacoコメント<br>
                        N列: ウェブサイト, O列: Instagram, P列: メイン画像URL<br>
                        Q列: 追加画像URL1, R列: 追加画像URL2, S列: GoogleマップURL<br><br>
                        
                        <strong>💡 文字化けする場合：</strong><br>
                        • Mac：CSVテンプレート（推奨）を使用<br>
                        • Windows Excel：Excelテンプレートを使用<br>
                        • Google Sheets：どちらでも正常に動作<br><br>
                        
                        <strong>注意:</strong> 1行目は列名、2行目から実際のデータを入力してください
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="saveSpreadsheetSettings()">設定を保存</button>
                <button class="btn" onclick="testSpreadsheetConnection()">接続テスト</button>
                <div class="template-buttons">
                    <button class="btn" onclick="createSpreadsheetTemplate()">📊 CSV テンプレート（推奨）</button>
                    <button class="btn" onclick="createExcelTemplate()">📈 Excel テンプレート</button>
                </div>
                <button class="btn" onclick="closeSpreadsheetModal()">キャンセル</button>
            </div>
        </div>

        <!-- CSVアップロードモーダル -->
        <div id="csvUploadModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeCSVUploadModal()">&times;</span>
                <h2>📤 CSVファイルアップロード</h2>
                <p>CSVファイルを直接アップロードして店舗データをインポートします。</p>
                
                <div class="form-group">
                    <label>CSVファイルを選択</label>
                    <div style="border: 2px dashed #98d8c8; border-radius: 10px; padding: 20px; text-align: center; margin: 15px 0;">
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVFileSelect(event)">
                        <div id="dropZone" onclick="document.getElementById('csvFileInput').click()" style="cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #98d8c8; margin-bottom: 10px;"></i>
                            <p><strong>ファイルを選択</strong> または ここにドラッグ&ドロップ</p>
                            <p style="font-size: 12px; color: #666;">対応形式: .csv</p>
                        </div>
                    </div>
                    <div id="selectedFileName" style="margin-top: 10px; font-weight: bold; color: #98d8c8;"></div>
                </div>
                
                <div class="form-group">
                    <h3>インポート設定</h3>
                    <label>
                        <input type="radio" name="csvImportMode" value="add" checked>
                        📝 追加モード（既存データに新しい店舗を追加）
                    </label>
                    <br>
                    <label style="margin-top: 10px;">
                        <input type="radio" name="csvImportMode" value="replace">
                        🔄 置き換えモード（既存データを削除して置き換え）
                    </label>
                </div>
                
                <div class="form-group">
                    <h3>📋 CSVファイルの形式</h3>
                    <div class="help-text">
                        <strong>重要：</strong><br>
                        • 1行目：列名（ヘッダー）<br>
                        • 2行目：入力指示（スキップされます）<br>
                        • <strong style="color: #9c27b0;">3行目以降：実際の店舗データ</strong><br><br>
                        
                        <strong>必須列：</strong> 店舗名, カテゴリー, 住所<br>
                        <strong>推奨：</strong> 管理画面の「📊 CSV テンプレート」を使用
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="importCSVFile()" id="csvImportBtn" disabled>
                        <i class="fas fa-upload"></i> インポート実行
                    </button>
                    <button class="btn" onclick="createSpreadsheetTemplate()">📊 CSV テンプレートをダウンロード</button>
                    <button class="btn" onclick="closeCSVUploadModal()">キャンセル</button>
                </div>
                
                <div id="csvPreview" style="margin-top: 20px; display: none;">
                    <h3>プレビュー（最初の3行）</h3>
                    <div id="csvPreviewContent" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
        
        <div id="status" class="status"></div>
        
        <div class="table-container">
            <table id="storesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>店舗名</th>
                        <th>カテゴリー</th>
                        <th>住所</th>
                        <th>GF対応</th>
                        <th>訪問ステータス</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="storesTableBody">
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 店舗追加・編集モーダル -->
    <div id="storeModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">新しい店舗を追加</h2>
            
            <form id="storeForm">
                <div class="form-group">
                    <label>店舗名</label>
                    <input type="text" id="storeName">
                </div>
                
                <div class="form-group">
                    <label>カテゴリー</label>
                    <select id="storeCategory">
                        <option value="">選択してください</option>
                        <option value="和食">和食</option>
                        <option value="洋食">洋食</option>
                        <option value="カフェ">カフェ</option>
                        <option value="パン屋">パン屋</option>
                        <option value="販売店">販売店</option>
                        <option value="スイーツ">スイーツ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>住所</label>
                    <input type="text" id="storeAddress">
                </div>
                
                <div class="form-group">
                    <label>Googleマップリンク</label>
                    <input type="url" id="storeGoogleMapsUrl" placeholder="https://www.google.com/maps/place/..." onpaste="handleGoogleMapsUrlPaste(event)">
                    <button type="button" class="btn" onclick="extractFromGoogleMaps()" id="extractBtn">🔍 住所と座標を自動取得</button>
                    <div class="help-text">
                        📱 <strong>座標取得方法（推奨順）:</strong><br>
                        1. <strong style="color: #2e7d32;">Plus Code方式（最高精度）:</strong> Googleマップで店舗を検索→共有→Plus Codeをコピー<br>
                        2. <strong style="color: #d32f2f;">直接座標方式:</strong> 店舗ピンの上で右クリック→「この場所について」→座標をコピー<br>
                        3. <strong>通常のリンク方式:</strong> 共有ボタンからリンクをコピー<br>
                        ※ Plus Code（例: 8Q7X5R3J+23）を含むURLは最も正確な位置情報が取得できます
                    </div>
                </div>
                
                <div class="form-group">
                    <label>緯度</label>
                    <input type="number" id="storeLat" step="0.0001" placeholder="例: 35.1709" onchange="handleCoordinateChange()">
                    <div class="help-text">
                        📍 Googleマップで右クリック→「この場所について」で取得した座標を入力可能
                    </div>
                </div>
                
                <div class="form-group">
                    <label>経度</label>
                    <input type="number" id="storeLng" step="0.0001" placeholder="例: 136.8833" onchange="handleCoordinateChange()">
                </div>
                
                <div class="form-group">
                    <button type="button" class="btn" onclick="extractAddressFromCoordinates()" id="addressBtn">📍 座標から住所を取得</button>
                </div>
                
                <div class="form-group">
                    <label>営業時間</label>
                    <input type="text" id="storeHours">
                </div>
                
                <div class="form-group">
                    <label>定休日</label>
                    <input type="text" id="storeClosed">
                </div>
                
                <div class="form-group">
                    <label>電話番号</label>
                    <input type="text" id="storeTel">
                </div>
                
                <div class="form-group">
                    <label>店舗説明</label>
                    <textarea id="storeDescription"></textarea>
                </div>
                
                <div class="form-group">
                    <label>GF対応</label>
                    <select id="storeGfType">
                        <option value="">選択してください</option>
                        <option value="完全GF">完全GF</option>
                        <option value="部分GF">部分GF</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="storeTakeout"> テイクアウト可能
                    </label>
                </div>
                
                <div class="form-group">
                    <label>席数</label>
                    <input type="number" id="storeSeats" min="0">
                </div>
                
                <div class="form-group">
                    <label>nacoのコメント</label>
                    <textarea id="storeComment"></textarea>
                </div>
                
                <div class="form-group">
                    <label>訪問ステータス</label>
                    <select id="storeVisitStatus">
                        <option value="">選択してください</option>
                        <option value="naco">🔴 naco訪問済み</option>
                        <option value="member">🟡 メンバー訪問済み</option>
                        <option value="unvisited">🤍 未確認店舗</option>
                    </select>
                    <div class="help-text">
                        🏆 <strong>ステータス説明:</strong><br>
                        🔴 naco訪問済み: nacoが実際に訪問し、確認済みの店舗（最高信頼度）<br>
                        🟡 メンバー訪問済み: ビヨグル倶楽部メンバーが訪問し、確認済みの店舗（信頼済み）<br>
                        🤍 未確認店舗: まだ誰も訪問していない、または確認が必要な店舗
                    </div>
                </div>
                
                <div class="form-group">
                    <label>確認者</label>
                    <input type="text" id="storeCheckedBy" placeholder="確認した人の名前を入力">
                    <div class="help-text">
                        訪問ステータスを設定した場合は確認者名も入力してください
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="storeVisitedByNaco"> naco訪問済み（旧システム）
                    </label>
                    <div class="help-text" style="color: #999; font-size: 12px;">
                        ※ 新しい訪問ステータス機能をご利用ください
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ウェブサイト</label>
                    <input type="url" id="storeWebsite" placeholder="https://example.com">
                </div>
                
                <div class="form-group">
                    <label>Instagram</label>
                    <input type="url" id="storeInstagram" placeholder="https://www.instagram.com/username/">
                </div>
                
                <div class="form-group">
                    <label>メイン画像URL</label>
                    <input type="url" id="storeImageUrl" placeholder="https://example.com/image.jpg">
                    <div class="help-text">
                        📸 <strong>メイン画像:</strong> リストと詳細画面の最初に表示される画像
                    </div>
                </div>
                
                <div class="form-group">
                    <label>追加画像URL 1</label>
                    <input type="url" id="storeImageUrl2" placeholder="https://example.com/image2.jpg">
                    <div class="help-text">
                        📸 <strong>追加画像1:</strong> 詳細画面でメイン画像の下に表示されます
                    </div>
                </div>
                
                <div class="form-group">
                    <label>追加画像URL 2</label>
                    <input type="url" id="storeImageUrl3" placeholder="https://example.com/image3.jpg">
                    <div class="help-text">
                        📸 <strong>追加画像2:</strong> 詳細画面で最後に表示されます<br>
                        • 無料画像サイト（Unsplash等）のURLを使用可能<br>
                        • 推奨サイズ：400x300px以上<br>
                        • 空欄の場合は画像なしで表示されます
                    </div>
                </div>
                
                <button type="submit" class="btn">保存</button>
                <button type="button" class="btn" onclick="closeModal()">キャンセル</button>
            </form>
        </div>
    </div>

    <script>
        let storesData = [];
        let editingStoreId = null;
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadStoresData();
            loadSpreadsheetSettings();
            updateCurrentConfigDisplay();
        });
        
        // スプレッドシート設定を読み込み
        function loadSpreadsheetSettings() {
            const spreadsheetUrl = localStorage.getItem('spreadsheetUrl');
            const sheetName = localStorage.getItem('sheetName');
            
            if (spreadsheetUrl) {
                document.getElementById('spreadsheetUrl').value = spreadsheetUrl;
            }
            if (sheetName) {
                document.getElementById('sheetName').value = sheetName;
            }
        }
        
        // 現在の設定表示を更新
        function updateCurrentConfigDisplay() {
            const spreadsheetUrl = localStorage.getItem('spreadsheetUrl');
            const sheetName = localStorage.getItem('sheetName') || 'シート1';
            const configInfo = document.getElementById('currentSpreadsheetInfo');
            
            if (spreadsheetUrl) {
                document.getElementById('currentUrl').textContent = spreadsheetUrl;
                document.getElementById('currentSheet').textContent = sheetName;
                configInfo.style.display = 'block';
            } else {
                configInfo.style.display = 'none';
            }
        }
        
        // スプレッドシート設定画面を表示
        function showSpreadsheetSettings() {
            loadSpreadsheetSettings(); // 現在の設定を読み込み
            document.getElementById('spreadsheetModal').style.display = 'block';
        }
        
        // 設定情報の表示/非表示切り替え
        function toggleSpreadsheetInfo() {
            const configInfo = document.getElementById('currentSpreadsheetInfo');
            configInfo.style.display = 'none';
        }
        
        // 現在の設定で接続テスト
        async function testCurrentConnection() {
            const spreadsheetUrl = localStorage.getItem('spreadsheetUrl');
            
            if (!spreadsheetUrl) {
                showStatus('スプレッドシート設定が見つかりません', 'error');
                return;
            }
            
            // 既存のテスト機能を使用
            document.getElementById('spreadsheetUrl').value = spreadsheetUrl;
            await testSpreadsheetConnection();
        }
        
        // スプレッドシート設定を削除
        function clearSpreadsheetSettings() {
            if (confirm('スプレッドシート設定を削除しますか？')) {
                localStorage.removeItem('spreadsheetUrl');
                localStorage.removeItem('sheetName');
                updateCurrentConfigDisplay();
                showStatus('スプレッドシート設定を削除しました', 'success');
            }
        }
        
        // 店舗データを読み込み
        async function loadStoresData() {
            try {
                console.log('店舗データを読み込み中...');
                // 強力なキャッシュバスティング（メインサイトと同じ方式）
                const timestamp = new Date().getTime();
                const randomId = Math.random().toString(36).substring(7);
                const response = await fetch(`stores.json?v=${timestamp}&r=${randomId}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('読み込んだデータ:', data);
                console.log('JSONファイルのstores配列:', data.stores);
                
                if (!data.stores || !Array.isArray(data.stores)) {
                    throw new Error('stores配列が見つかりません');
                }
                
                storesData = data.stores;
                console.log('店舗数:', storesData.length);
                console.log('店舗リスト:', storesData.map(s => s.name));
                
                if (storesData.length === 0) {
                    console.warn('店舗データが空です');
                    showStatus('店舗データが空です', 'warning');
                    return;
                }
                
                if (storesData.length < 6) {
                    console.warn(`期待される店舗数は6件ですが、${storesData.length}件しか読み込めませんでした`);
                    showStatus(`警告: ${storesData.length}件の店舗データを読み込みました（期待値: 6件）`, 'warning');
                } else {
                    showStatus(`${storesData.length}件の店舗データを読み込みました`, 'success');
                }
                
                renderTable();
                console.log('店舗データを読み込みました:', storesData.length, '件');
            } catch (error) {
                console.error('店舗データ読み込みエラー:', error);
                console.error('エラー詳細:', error.message);
                showStatus('店舗データの読み込みに失敗しました: ' + error.message, 'error');
            }
        }

        // 最新データを手動で再読み込み
        async function reloadStoresData() {
            showStatus('最新データを読み込み中...', 'success');
            try {
                await loadStoresData();
                showStatus('最新データを読み込みました。', 'success');
            } catch (error) {
                showStatus('データの読み込みに失敗しました', 'error');
            }
        }
        
        // テーブルを描画
        function renderTable() {
            const tbody = document.getElementById('storesTableBody');
            tbody.innerHTML = '';
            
            storesData.forEach(store => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${store.id}</td>
                    <td>${store.name}</td>
                    <td><span class="category-badge category-${store.category}">${store.category}</span></td>
                    <td>${store.address}</td>
                    <td>${store.glutenFreeType}</td>
                    <td>${getVisitStatusBadgeHTML(store.visitStatus)}</td>
                    <td>
                        <button class="btn" onclick="editStore(${store.id})">編集</button>
                        <button class="btn" onclick="deleteStore(${store.id})" style="background: #dc3545;">削除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 新規追加モーダルを表示
        function showAddModal() {
            editingStoreId = null;
            document.getElementById('modalTitle').textContent = '新しい店舗を追加';
            document.getElementById('storeForm').reset();
            document.getElementById('storeModal').style.display = 'block';
        }
        
        // 編集モーダルを表示
        function editStore(id) {
            const store = storesData.find(s => s.id === id);
            if (!store) return;
            
            editingStoreId = id;
            document.getElementById('modalTitle').textContent = '店舗情報を編集';
            
            // フォームに既存データを設定
            document.getElementById('storeName').value = store.name;
            document.getElementById('storeCategory').value = store.category;
            document.getElementById('storeAddress').value = store.address;
            document.getElementById('storeLat').value = store.lat;
            document.getElementById('storeLng').value = store.lng;
            document.getElementById('storeHours').value = store.hours;
            document.getElementById('storeClosed').value = store.closed;
            document.getElementById('storeTel').value = store.tel;
            document.getElementById('storeDescription').value = store.description;
            document.getElementById('storeGfType').value = store.glutenFreeType;
            document.getElementById('storeTakeout').checked = store.takeout;
            document.getElementById('storeSeats').value = store.seats;
            document.getElementById('storeComment').value = store.nacoComment;
            document.getElementById('storeVisitedByNaco').checked = store.visitedByNaco || false;
            
            // 訪問ステータス関連のフィールドを設定
            document.getElementById('storeVisitStatus').value = store.visitStatus || '';
            document.getElementById('storeCheckedBy').value = store.checkedBy || '';
            document.getElementById('storeWebsite').value = store.website || '';
            document.getElementById('storeInstagram').value = store.instagram || '';
            document.getElementById('storeImageUrl').value = store.imageUrl || '';
            document.getElementById('storeImageUrl2').value = store.imageUrl2 || '';
            document.getElementById('storeImageUrl3').value = store.imageUrl3 || '';
            document.getElementById('storeGoogleMapsUrl').value = store.googleMapsUrl || '';
            
            document.getElementById('storeModal').style.display = 'block';
        }
        
        // 店舗を削除
        function deleteStore(id) {
            if (confirm('この店舗を削除しますか？')) {
                storesData = storesData.filter(s => s.id !== id);
                renderTable();
                showStatus('店舗を削除しました', 'success');
            }
        }
        
        // モーダルを閉じる
        function closeModal() {
            document.getElementById('storeModal').style.display = 'none';
        }
        
        // フォーム送信
        document.getElementById('storeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const storeData = {
                id: editingStoreId || Math.max(...storesData.map(s => s.id), 0) + 1,
                name: document.getElementById('storeName').value,
                category: document.getElementById('storeCategory').value,
                address: document.getElementById('storeAddress').value,
                lat: parseFloat(document.getElementById('storeLat').value),
                lng: parseFloat(document.getElementById('storeLng').value),
                hours: document.getElementById('storeHours').value || '',
                closed: document.getElementById('storeClosed').value || 'なし',
                tel: document.getElementById('storeTel').value || '',
                description: document.getElementById('storeDescription').value || '',
                glutenFreeType: document.getElementById('storeGfType').value || '',
                takeout: document.getElementById('storeTakeout').checked,
                seats: parseInt(document.getElementById('storeSeats').value) || 0,
                nacoComment: document.getElementById('storeComment').value || '',
                visitedByNaco: document.getElementById('storeVisitedByNaco').checked,
                
                // 訪問ステータス関連の情報
                visitStatus: document.getElementById('storeVisitStatus').value || 'unvisited', // 未入力時は「未確認店舗」
                checkedBy: document.getElementById('storeCheckedBy').value || undefined,
                lastUpdate: document.getElementById('storeVisitStatus').value ? new Date().toISOString().substring(0, 7) : undefined,
                website: document.getElementById('storeWebsite').value || '',
                instagram: document.getElementById('storeInstagram').value || '',
                imageUrl: document.getElementById('storeImageUrl').value || '',
                imageUrl2: document.getElementById('storeImageUrl2').value || '',
                imageUrl3: document.getElementById('storeImageUrl3').value || '',
                googleMapsUrl: document.getElementById('storeGoogleMapsUrl').value || ''
            };
            
            if (editingStoreId) {
                // 編集
                const index = storesData.findIndex(s => s.id === editingStoreId);
                storesData[index] = storeData;
                showStatus('店舗情報を更新しました', 'success');
            } else {
                // 新規追加
                storesData.push(storeData);
                showStatus('新しい店舗を追加しました', 'success');
            }
            
            renderTable();
            closeModal();
        });
        
        // スプレッドシートから読み込み（追加モード）
        function loadFromSpreadsheet() {
            const spreadsheetUrl = localStorage.getItem('spreadsheetUrl');
            
            if (!spreadsheetUrl) {
                document.getElementById('spreadsheetModal').style.display = 'block';
                return;
            }
            
            importFromSpreadsheet(false); // false = 追加モード
        }
        
        // スプレッドシートで既存データを置き換え（置き換えモード）
        function loadFromSpreadsheetReplace() {
            const spreadsheetUrl = localStorage.getItem('spreadsheetUrl');
            
            if (!spreadsheetUrl) {
                document.getElementById('spreadsheetModal').style.display = 'block';
                return;
            }
            
            const confirmed = confirm(
                '⚠️ 注意：この操作は既存のすべての店舗データを削除し、\n' +
                'スプレッドシートのデータで置き換えます。\n\n' +
                '本当に実行しますか？'
            );
            
            if (confirmed) {
                importFromSpreadsheet(true); // true = 置き換えモード
            }
        }
        
        // スプレッドシート設定を保存
        function saveSpreadsheetSettings() {
            const url = document.getElementById('spreadsheetUrl').value;
            const sheetName = document.getElementById('sheetName').value || 'シート1';
            
            if (!url) {
                showStatus('スプレッドシートURLを入力してください', 'error');
                return;
            }
            
            localStorage.setItem('spreadsheetUrl', url);
            localStorage.setItem('sheetName', sheetName);
            updateCurrentConfigDisplay(); // 表示を更新
            closeSpreadsheetModal();
            showStatus('スプレッドシート設定を保存しました', 'success');
        }
        
        // スプレッドシート接続テスト
        async function testSpreadsheetConnection() {
            const url = document.getElementById('spreadsheetUrl').value;
            
            if (!url) {
                showStatus('スプレッドシートURLを入力してください', 'error');
                return;
            }
            
            try {
                showStatus('接続テスト中...', 'success');
                
                // CSVのURLに変換
                const csvUrl = convertToCSVUrl(url);
                console.log('テスト用CSV URL:', csvUrl);
                
                // CORSエラーを回避するためプロキシを使用
                let csvText;
                
                try {
                    // 直接アクセスを試行
                    const response = await fetch(csvUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    csvText = await response.text();
                    console.log('直接アクセステスト成功');
                } catch (directError) {
                    console.log('直接アクセステスト失敗、プロキシを使用:', directError.message);
                    
                    // プロキシ経由でアクセス
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(csvUrl)}`;
                    const proxyResponse = await fetch(proxyUrl);
                    
                    if (!proxyResponse.ok) {
                        throw new Error(`Proxy error! status: ${proxyResponse.status}`);
                    }
                    
                    const proxyData = await proxyResponse.json();
                    csvText = proxyData.contents;
                    console.log('プロキシアクセステスト成功');
                }
                console.log('接続テスト - 取得したCSVテキスト（最初の500文字）:', csvText.substring(0, 500));
                
                const rows = parseCSV(csvText);
                console.log('接続テスト - パース後の行数:', rows.length);
                console.log('接続テスト - 最初の3行:', rows.slice(0, 3));
                
                if (rows.length < 3) {
                    throw new Error('スプレッドシートにデータが見つかりません（3行目以降にデータを入力してください）');
                }
                
                // 接続テストでも店舗データ変換をテスト
                const testStores = convertCSVToStores(rows);
                console.log('接続テスト - 変換テスト結果:', testStores.length);
                
                showStatus(`接続成功！${rows.length - 2}行のデータ、${testStores.length}件の有効な店舗データが見つかりました（3行目以降から読み込み）`, 'success');
                
            } catch (error) {
                console.error('接続テストエラー:', error);
                showStatus(`接続テストに失敗しました: ${error.message}`, 'error');
            }
        }
        
        // スプレッドシートモーダルを閉じる
        function closeSpreadsheetModal() {
            document.getElementById('spreadsheetModal').style.display = 'none';
        }
        
        // スプレッドシートから実際にインポート
        async function importFromSpreadsheet(replaceMode = false) {
            const spreadsheetUrl = localStorage.getItem('spreadsheetUrl');
            
            if (!spreadsheetUrl) {
                showStatus('スプレッドシート設定が見つかりません。設定を行ってください。', 'error');
                return;
            }
            
            try {
                showStatus('スプレッドシートからデータを読み込み中...', 'success');
                
                const csvUrl = convertToCSVUrl(spreadsheetUrl);
                console.log('CSVダウンロードURL:', csvUrl);
                
                // 複数の方法でアクセスを試行
                let csvText;
                let accessMethod = '';
                
                // 方法1: 直接アクセス
                try {
                    const response = await fetch(csvUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    csvText = await response.text();
                    accessMethod = '直接アクセス';
                    console.log('直接アクセス成功');
                } catch (directError) {
                    console.log('直接アクセス失敗:', directError.message);
                    
                    // 方法2: Published URLに変換を試行
                    try {
                        const publishedUrl = convertToPublishedCSVUrl(spreadsheetUrl);
                        if (publishedUrl !== csvUrl) {
                            console.log('Published URL試行:', publishedUrl);
                            const response = await fetch(publishedUrl);
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            csvText = await response.text();
                            accessMethod = 'Published URL';
                            console.log('Published URLアクセス成功');
                        } else {
                            throw new Error('Published URL変換なし');
                        }
                    } catch (publishedError) {
                        console.log('Published URLアクセス失敗:', publishedError.message);
                        
                        // 方法3: プロキシ経由でアクセス
                        try {
                            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(csvUrl)}`;
                            const proxyResponse = await fetch(proxyUrl);
                            
                            if (!proxyResponse.ok) {
                                throw new Error(`Proxy HTTP ${proxyResponse.status}: ${proxyResponse.statusText}`);
                            }
                            
                            const proxyData = await proxyResponse.json();
                            
                            if (proxyData.status && proxyData.status.http_code && proxyData.status.http_code >= 400) {
                                throw new Error(`Google Sheets HTTP ${proxyData.status.http_code}: ${proxyData.status.error || 'アクセス権限がありません'}`);
                            }
                            
                            csvText = proxyData.contents;
                            accessMethod = 'プロキシ経由';
                            console.log('プロキシアクセス成功');
                        } catch (proxyError) {
                            console.log('プロキシアクセス失敗:', proxyError.message);
                            throw new Error(`すべてのアクセス方法が失敗しました。スプレッドシートが公開されているか、「ウェブに公開」設定が有効になっているか確認してください。最後のエラー: ${proxyError.message}`);
                        }
                    }
                }
                
                console.log(`${accessMethod}で取得したCSVテキスト（最初の500文字）:`, csvText.substring(0, 500));
                
                const rows = parseCSV(csvText);
                console.log('パース後の行数:', rows.length);
                console.log('最初の3行:', rows.slice(0, 3));
                
                if (rows.length < 2) {
                    throw new Error(`スプレッドシートにデータが見つかりません。行数: ${rows.length}`);
                }
                
                // CSVデータを店舗データに変換
                const importedStores = convertCSVToStores(rows);
                console.log('変換後の店舗数:', importedStores.length);
                console.log('最初の店舗データ:', importedStores[0]);
                
                if (importedStores.length === 0) {
                    throw new Error('有効なデータが見つかりませんでした。必須フィールド（店舗名、カテゴリー、住所）を確認してください');
                }
                
                let addedCount = 0;
                
                if (replaceMode) {
                    // 置き換えモード：既存データを全て削除してスプレッドシートデータに置き換え
                    storesData = importedStores.map((store, index) => {
                        store.id = index + 1;
                        return store;
                    });
                    addedCount = importedStores.length;
                    console.log(`${importedStores.length}件のデータで既存データを置き換え`);
                } else {
                    // 追加モード：既存データに追加（重複を避ける）
                    const maxId = Math.max(...storesData.map(s => s.id), 0);
                    
                    importedStores.forEach((newStore, index) => {
                        // 同じ名前と住所の店舗が既に存在するかチェック
                        const isDuplicate = storesData.some(existingStore => 
                            existingStore.name === newStore.name && 
                            existingStore.address === newStore.address
                        );
                        
                        if (!isDuplicate) {
                            newStore.id = maxId + addedCount + 1;
                            storesData.push(newStore);
                            addedCount++;
                        }
                    });
                    
                    console.log(`${importedStores.length}件中${addedCount}件を追加（重複${importedStores.length - addedCount}件をスキップ）`);
                }
                
                renderTable();
                
                if (replaceMode) {
                    showStatus(`既存データを削除し、スプレッドシートから${importedStores.length}件のデータで置き換えました。保存する場合は「GitHubに直接保存」ボタンをクリックしてください。`, 'success');
                } else {
                    if (addedCount === 0) {
                        showStatus(`スプレッドシートから${importedStores.length}件のデータを確認しましたが、すべて重複のためスキップしました。`, 'warning');
                    } else if (addedCount < importedStores.length) {
                        showStatus(`スプレッドシートから${addedCount}件の新しいデータを追加しました（重複${importedStores.length - addedCount}件をスキップ）。保存する場合は「GitHubに直接保存」ボタンをクリックしてください。`, 'success');
                    } else {
                        showStatus(`スプレッドシートから${addedCount}件のデータを追加しました。保存する場合は「GitHubに直接保存」ボタンをクリックしてください。`, 'success');
                    }
                }
                
            } catch (error) {
                console.error('スプレッドシート読み込みエラー:', error);
                console.error('エラーの詳細:', {
                    message: error.message,
                    stack: error.stack,
                    spreadsheetUrl: spreadsheetUrl,
                    csvUrl: convertToCSVUrl(spreadsheetUrl)
                });
                showStatus(`スプレッドシートの読み込みに失敗しました: ${error.message}`, 'error');
            }
        }
        
        // Google SheetsのURLをCSV URLに変換
        function convertToCSVUrl(url) {
            try {
                console.log('変換前URL:', url);
                
                // Google SheetsのURLパターンを検出して変換
                if (url.includes('docs.google.com/spreadsheets')) {
                    // 既にCSV URLの場合はそのまま返す
                    if (url.includes('/export?format=csv')) {
                        console.log('既にCSV URLです');
                        return url;
                    }
                    
                    // スプレッドシートIDを抽出（複数のパターンに対応）
                    let spreadsheetId = null;
                    
                    // パターン1: /spreadsheets/d/{ID}/edit
                    let match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                    if (match) {
                        spreadsheetId = match[1];
                    }
                    
                    if (spreadsheetId) {
                        // シートのGIDを抽出（指定されている場合）
                        let gid = '0'; // デフォルトは最初のシート
                        
                        // URLからgidパラメータを抽出
                        const gidMatch = url.match(/[#&]gid=([0-9]+)/);
                        if (gidMatch) {
                            gid = gidMatch[1];
                        }
                        
                        // より確実なCSV URLを生成（usp=sharingパラメータを追加）
                        const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=${gid}&usp=sharing`;
                        console.log('変換後CSV URL:', csvUrl);
                        return csvUrl;
                    } else {
                        // スプレッドシートIDが抽出できない場合のエラー
                        throw new Error('Google SheetsのURLからスプレッドシートIDを抽出できませんでした。正しいURLを入力してください。');
                    }
                }
                
                // その他のCSV URLやHTTP URLはそのまま返す
                console.log('変換不要、そのまま返します');
                return url;
                
            } catch (error) {
                console.error('URL変換エラー:', error);
                throw error; // エラーを上位に伝播
            }
        }

        // Google SheetsのURLをPublished CSV URLに変換（ウェブに公開されたスプレッドシート用）
        function convertToPublishedCSVUrl(url) {
            try {
                console.log('Published URL変換前:', url);
                
                if (url.includes('docs.google.com/spreadsheets')) {
                    // スプレッドシートIDを抽出
                    const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                    if (match) {
                        const spreadsheetId = match[1];
                        
                        // シートのGIDを抽出（指定されている場合）
                        let gid = '0';
                        const gidMatch = url.match(/[#&]gid=([0-9]+)/);
                        if (gidMatch) {
                            gid = gidMatch[1];
                        }
                        
                        // Published CSV URLを生成（ウェブに公開設定が必要）
                        const publishedCsvUrl = `https://docs.google.com/spreadsheets/d/e/2PACX-${spreadsheetId}/pub?gid=${gid}&single=true&output=csv`;
                        console.log('変換後Published CSV URL:', publishedCsvUrl);
                        return publishedCsvUrl;
                    }
                }
                
                return url;
            } catch (error) {
                console.error('Published URL変換エラー:', error);
                return url;
            }
        }
        
        // CSV文字列をパース（改良版）
        function parseCSV(csvText) {
            try {
                console.log('CSVパース開始');
                const lines = csvText.split('\n');
                console.log('分割後の行数:', lines.length);
                
                const result = [];
                
                for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
                    const line = lines[lineIndex].trim();
                    if (line) {
                        console.log(`行 ${lineIndex + 1} 原文:`, line);
                        
                        // より堅牢なCSVパース
                        const row = [];
                        let current = '';
                        let inQuotes = false;
                        let i = 0;
                        
                        while (i < line.length) {
                            const char = line[i];
                            
                            if (char === '"') {
                                if (!inQuotes) {
                                    // クォート開始
                                    inQuotes = true;
                                } else {
                                    // クォート内でダブルクォートの場合をチェック
                                    if (i + 1 < line.length && line[i + 1] === '"') {
                                        // エスケープされたクォート
                                        current += '"';
                                        i++; // 次のクォートをスキップ
                                    } else {
                                        // クォート終了
                                        inQuotes = false;
                                    }
                                }
                            } else if (char === ',' && !inQuotes) {
                                // フィールド区切り
                                row.push(current);
                                current = '';
                            } else {
                                current += char;
                            }
                            i++;
                        }
                        
                        // 最後のフィールドを追加
                        row.push(current);
                        
                        // 各フィールドのクリーンアップ
                        const cleanedRow = row.map(field => {
                            let cleaned = field.trim();
                            // 先頭と末尾のクォートを除去
                            if (cleaned.startsWith('"') && cleaned.endsWith('"')) {
                                cleaned = cleaned.slice(1, -1);
                            }
                            return cleaned;
                        });
                        
                        result.push(cleanedRow);
                        
                        if (lineIndex < 3) {
                            console.log(`行 ${lineIndex + 1} パース結果:`, cleanedRow);
                        }
                    }
                }
                
                console.log('CSVパース完了、結果行数:', result.length);
                return result;
                
            } catch (error) {
                console.error('CSVパースエラー:', error);
                throw new Error(`CSVデータの解析に失敗しました: ${error.message}`);
            }
        }
        
        // GoogleマップURLから座標を抽出
        function extractCoordinatesFromGoogleMapsUrl(url) {
            try {
                if (!url) return { lat: null, lng: null };
                
                console.log('GoogleマップURL解析中:', url);
                
                // パターン1: @緯度,経度,ズーム
                let match = url.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*),/);
                if (match) {
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    console.log('パターン1で座標抽出:', lat, lng);
                    return { lat, lng };
                }
                
                // パターン2: !3d緯度!4d経度
                match = url.match(/!3d(-?\d+\.?\d*).*!4d(-?\d+\.?\d*)/);
                if (match) {
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    console.log('パターン2で座標抽出:', lat, lng);
                    return { lat, lng };
                }
                
                // パターン3: q=緯度,経度
                match = url.match(/[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    console.log('パターン3で座標抽出:', lat, lng);
                    return { lat, lng };
                }
                
                // パターン4: ll=緯度,経度
                match = url.match(/[?&]ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    console.log('パターン4で座標抽出:', lat, lng);
                    return { lat, lng };
                }
                
                console.log('GoogleマップURLから座標を抽出できませんでした');
                return { lat: null, lng: null };
                
            } catch (error) {
                console.error('GoogleマップURL解析エラー:', error);
                return { lat: null, lng: null };
            }
        }

        // CSVデータを店舗データに変換
        function convertCSVToStores(rows) {
            try {
                console.log('店舗データ変換開始');
                const stores = [];
                const headers = rows[0]; // 1行目はヘッダー
                const instructionRow = rows[1]; // 2行目は入力指示
                console.log('ヘッダー行:', headers);
                console.log('指示行:', instructionRow);
                console.log('データ行数:', rows.length - 2);
                
                for (let i = 2; i < rows.length; i++) {
                    const row = rows[i];
                    console.log(`行 ${i + 1} 処理中:`, row);
                    console.log(`行 ${i + 1} の長さ: ${row.length}`);
                    
                    // 空行をスキップ
                    if (!row || row.length === 0 || row.every(cell => !cell || cell.trim() === '')) {
                        console.log(`行 ${i + 1}: 空行のためスキップ`);
                        continue;
                    }
                    
                    // 必須フィールドのチェック（改良版）
                    const name = (row[0] || '').toString().trim();
                    const category = (row[1] || '').toString().trim();
                    const address = (row[2] || '').toString().trim();
                    
                    console.log(`行 ${i + 1} 必須フィールド確認:`);
                    console.log(`  店舗名: "${name}" (長さ: ${name.length})`);
                    console.log(`  カテゴリー: "${category}" (長さ: ${category.length})`);
                    console.log(`  住所: "${address}" (長さ: ${address.length})`);
                    
                    if (!name || !category || !address) {
                        console.log(`行 ${i + 1}: 必須フィールド（店舗名、カテゴリー、住所）が不足しています`);
                        continue;
                    }
                
                    // 座標の優先順位処理
                    let lat = 0;
                    let lng = 0;
                    
                    // 1. スプレッドシートの手入力座標を最優先
                    const inputLat = parseFloat(row[3]);
                    const inputLng = parseFloat(row[4]);
                    
                    if (!isNaN(inputLat) && !isNaN(inputLng) && inputLat !== 0 && inputLng !== 0) {
                        lat = inputLat;
                        lng = inputLng;
                        console.log(`行 ${i + 1}: 手入力座標を使用 (${lat}, ${lng})`);
                    } else {
                        // 2. GoogleマップURLから座標を抽出
                        const googleMapsUrl = (row[22] || '').toString().trim(); // W列は22番目（0から始まる）
                        if (googleMapsUrl) {
                            const extractedCoords = extractCoordinatesFromGoogleMapsUrl(googleMapsUrl);
                            if (extractedCoords.lat && extractedCoords.lng) {
                                lat = extractedCoords.lat;
                                lng = extractedCoords.lng;
                                console.log(`行 ${i + 1}: GoogleマップURLから座標を抽出 (${lat}, ${lng})`);
                            } else {
                                console.log(`行 ${i + 1}: GoogleマップURLから座標を抽出できませんでした`);
                            }
                        }
                        
                        // 3. 住所からのジオコーディングは管理画面で手動実行
                        if (lat === 0 && lng === 0) {
                            console.log(`行 ${i + 1}: 座標が取得できませんでした。管理画面で手動設定してください。`);
                        }
                    }

                    const store = {
                        id: i - 1, // 仮のID（3行目開始なのでi-1）
                        name: name,
                        category: category,
                        address: address,
                        lat: lat,
                        lng: lng,
                        hours: (row[5] || '').toString().trim(),
                        closed: (row[6] || 'なし').toString().trim(),
                        tel: (row[7] || '').toString().trim(),
                        description: (row[8] || '').toString().trim(),
                        glutenFreeType: (row[9] || '').toString().trim(),
                        takeout: ['TRUE', 'true', '○', '1', 'YES', 'yes'].includes((row[10] || '').toString().trim()),
                        seats: parseInt(row[11]) || 0,
                        nacoComment: (row[12] || '').toString().trim(),
                        visitedByNaco: ['TRUE', 'true', '○', '1', 'YES', 'yes'].includes((row[13] || '').toString().trim()),
                        
                        // 訪問ステータス関連のフィールド（新規追加）
                        visitStatus: (row[14] || '').toString().trim() || 'unvisited', // 未入力時は「未確認店舗」
                        checkedBy: (row[15] || '').toString().trim() || undefined,
                        lastUpdate: (row[16] || '').toString().trim() || undefined,
                        
                        website: (row[17] || '').toString().trim(),        // R列
                        instagram: (row[18] || '').toString().trim(),      // S列
                        imageUrl: (row[19] || '').toString().trim(),       // T列：メイン画像URL
                        imageUrl2: (row[20] || '').toString().trim(),      // U列：追加画像URL1
                        imageUrl3: (row[21] || '').toString().trim(),      // V列：追加画像URL2
                        googleMapsUrl: (row[22] || '').toString().trim()   // W列：GoogleマップURL
                    };
                
                stores.push(store);
                console.log(`行 ${i + 1} 変換完了: ${store.name}`);
            }
            
            console.log('店舗データ変換完了、変換された店舗数:', stores.length);
            return stores;
            
            } catch (error) {
                console.error('店舗データ変換エラー:', error);
                throw new Error(`店舗データの変換に失敗しました: ${error.message}`);
            }
        }
        
        // スプレッドシートテンプレートを作成
        function createSpreadsheetTemplate() {
            const headers = [
                '店舗名', 'カテゴリー', '住所', '緯度', '経度',
                '営業時間', '定休日', '電話番号', '店舗説明',
                'GF対応', 'テイクアウト', '席数', 'nacoコメント', 'naco訪問済み(旧)',
                '訪問ステータス', '確認者', '最終更新',
                'ウェブサイト', 'Instagram', 'メイン画像URL',
                '追加画像URL1', '追加画像URL2', 'GoogleマップURL'
            ];
            
            // 選択項目の説明を含むヘッダー行
            const instructionHeaders = [
                '入力例', 
                '選択: 和食,洋食,中華,イタリアン,フレンチ,カフェ,デザート,ベーカリー,その他', 
                '住所を入力', '緯度（数値）', '経度（数値）',
                '営業時間', '定休日', '電話番号', '店舗説明',
                '選択: 完全GF,部分GF', '選択: TRUE,FALSE', '席数（数値）', 'nacoのコメント', '選択: TRUE,FALSE',
                '選択: naco,member,unvisited', '確認者名', 'YYYY-MM形式',
                'ウェブサイトURL', 'InstagramURL', '画像URL',
                '追加画像URL', '追加画像URL', 'GoogleマップURL'
            ];
            
            // サンプルデータを追加
            const sampleData = [
                'サンプル店舗', '和食', '東京都渋谷区神南1-1-1', '35.6581', '139.7017',
                '11:00-21:00', '月曜日', '052-123-4567', 'グルテンフリー対応のお店です',
                '完全GF', 'TRUE', '20', '美味しいお店です！', 'TRUE',
                'naco', 'naco', '2024-12',
                'https://example.com', 'https://instagram.com/example', 'https://example.com/image1.jpg',
                'https://example.com/image2.jpg', 'https://example.com/image3.jpg', 'https://maps.google.com/...'
            ];
            
            // CSV形式でデータを作成（ダブルクォートで囲む）
            const csvContent = [headers, instructionHeaders, sampleData]
                .map(row => row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(','))
                .join('\r\n');
            
            // BOM（Byte Order Mark）付きUTF-8でエンコード（Mac/Excel対応）
            const bom = '\uFEFF';
            const csvWithBom = bom + csvContent;
            
            // Blobを作成（Mac対応のためにBOM付きUTF-8を指定）
            const blob = new Blob([csvWithBom], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'glutenfree_map_template.csv';
            
            // リンクを一時的にDOMに追加してクリック（Safari対応）
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            
            showStatus('テンプレートCSVファイルをダウンロードしました。選択項目の指示が含まれています。Google Sheetsでドロップダウンを設定してください。', 'success');
        }
        
        // Excelテンプレートを作成
        function createExcelTemplate() {
            const headers = [
                '店舗名', 'カテゴリー', '住所', '緯度', '経度',
                '営業時間', '定休日', '電話番号', '店舗説明',
                'GF対応', 'テイクアウト', '席数', 'nacoコメント',
                'ウェブサイト', 'Instagram', 'メイン画像URL',
                '追加画像URL1', '追加画像URL2', 'GoogleマップURL'
            ];
            
            // サンプルデータを追加
            const sampleData = [
                'サンプル店舗', '和食', '東京都渋谷区神南1-1-1', '35.6581', '139.7017',
                '11:00-21:00', '月曜日', '052-123-4567', 'グルテンフリー対応のお店です',
                '完全GF', 'TRUE', '20', '美味しいお店です！',
                'https://example.com', 'https://instagram.com/example', 'https://example.com/image1.jpg',
                'https://example.com/image2.jpg', 'https://example.com/image3.jpg', 'https://maps.google.com/...'
            ];
            
            // Excel用のタブ区切り形式で作成
            const tsvContent = [headers, sampleData]
                .map(row => row.join('\t'))
                .join('\r\n');
            
            // BOM付きUTF-16LE（Excel最適化）
            const bom = '\uFEFF';
            const tsvWithBom = bom + tsvContent;
            
            // Excel形式のBlobを作成
            const blob = new Blob([tsvWithBom], { 
                type: 'application/vnd.ms-excel;charset=utf-16le;' 
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'glutenfree_map_template.xls';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            
            showStatus('Excelテンプレートファイルをダウンロードしました。Excelで直接開けます。', 'success');
        }
        
        // GitHubに直接保存
        async function saveToGitHubDirect() {
            const token = localStorage.getItem('githubToken');
            
            if (!token) {
                document.getElementById('githubModal').style.display = 'block';
                return;
            }
            
            showStatus('GitHubに保存中...', 'success');
            
            try {
                // データ整合性チェック
                if (!storesData || !Array.isArray(storesData)) {
                    throw new Error('保存するデータが無効です（storesDataが空または配列ではありません）');
                }
                
                if (storesData.length === 0) {
                    throw new Error('保存するデータが空です。データが失われる可能性があります。');
                }
                
                console.log(`保存前チェック: ${storesData.length}件の店舗データ`);
                console.log('保存対象の店舗:', storesData.map(s => `ID:${s.id} - ${s.name}`));
                
                if (storesData.length < 6) {
                    const confirmed = confirm(
                        `⚠️ 警告: 現在のデータは${storesData.length}件のみです。\n` +
                        `通常は6件の店舗データがあります。\n\n` +
                        `このまま保存すると既存データが失われる可能性があります。\n` +
                        `本当に保存しますか？`
                    );
                    if (!confirmed) {
                        showStatus('保存がキャンセルされました', 'warning');
                        return;
                    }
                }
                
                const jsonData = {
                    stores: storesData
                };
                
                const content = JSON.stringify(jsonData, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                // 現在のファイルのSHAを取得
                const getResponse = await fetch('https://api.github.com/repos/bettger3000/nagoya-glutenfree-map/contents/stores.json', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = '';
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }
                
                // ファイルを更新
                const updateData = {
                    message: '店舗データを更新 - 管理画面より',
                    content: encodedContent,
                    sha: sha
                };
                
                const updateResponse = await fetch('https://api.github.com/repos/bettger3000/nagoya-glutenfree-map/contents/stores.json', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (updateResponse.ok) {
                    showStatus('GitHubに保存完了！数分後にマップに反映されます。', 'success');
                    
                    // 保存後に最新データを再読み込み（3秒後）
                    setTimeout(async () => {
                        try {
                            await loadStoresData();
                            showStatus('最新データを再読み込みしました。', 'success');
                        } catch (error) {
                            console.warn('データ再読み込みエラー:', error);
                        }
                    }, 3000);
                } else {
                    const error = await updateResponse.json();
                    throw new Error(error.message || 'GitHubへの保存に失敗しました');
                }
                
            } catch (error) {
                console.error('GitHub保存エラー:', error);
                showStatus(`GitHubへの保存に失敗しました: ${error.message}`, 'error');
            }
        }
        
        // GitHubトークンを保存
        function saveGitHubToken() {
            const token = document.getElementById('githubToken').value;
            if (!token) {
                showStatus('トークンを入力してください', 'error');
                return;
            }
            
            localStorage.setItem('githubToken', token);
            closeGitHubModal();
            showStatus('GitHubトークンを保存しました。「GitHubに直接保存」ボタンで保存してください。', 'success');
        }
        
        // GitHubモーダルを閉じる
        function closeGitHubModal() {
            document.getElementById('githubModal').style.display = 'none';
            document.getElementById('githubToken').value = '';
        }
        
        // GitHubに保存（ファイルダウンロード）
        function saveToGitHub() {
            // データ整合性チェック
            if (!storesData || !Array.isArray(storesData)) {
                showStatus('保存するデータが無効です（storesDataが空または配列ではありません）', 'error');
                return;
            }
            
            if (storesData.length === 0) {
                showStatus('保存するデータが空です。データが失われる可能性があります。', 'error');
                return;
            }
            
            console.log(`保存前チェック: ${storesData.length}件の店舗データ`);
            console.log('保存対象の店舗:', storesData.map(s => `ID:${s.id} - ${s.name}`));
            
            if (storesData.length < 6) {
                const confirmed = confirm(
                    `⚠️ 警告: 現在のデータは${storesData.length}件のみです。\n` +
                    `通常は6件の店舗データがあります。\n\n` +
                    `このまま保存すると既存データが失われる可能性があります。\n` +
                    `本当に保存しますか？`
                );
                if (!confirmed) {
                    showStatus('保存がキャンセルされました', 'warning');
                    return;
                }
            }
            
            const jsonData = {
                stores: storesData
            };
            
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stores.json';
            a.click();
            
            URL.revokeObjectURL(url);
            
            showStatus('stores.jsonファイルをダウンロードしました。GitHubにアップロードしてください。', 'success');
        }
        
        // URLペースト時の自動処理
        function handleGoogleMapsUrlPaste(event) {
            setTimeout(() => {
                console.log('URLペースト検出、自動実行開始'); // デバッグ用
                extractFromGoogleMaps();
            }, 100);
        }
        
        // テスト用関数（デバッグ専用） - 新しいアプローチをテスト
        function testAddressExtraction() {
            console.log('=== 新しい住所取得アプローチのテスト開始 ===');
            
            // フォームをクリア
            document.getElementById('storeName').value = '';
            document.getElementById('storeAddress').value = '';
            document.getElementById('storeLat').value = '';
            document.getElementById('storeLng').value = '';
            
            const testUrl = 'https://www.google.com/maps/place/%E6%88%90%E5%9F%8E%E7%9F%B3%E4%BA%95+%E5%90%8D%E5%8F%A4%E5%B1%8B+%E8%BF%91%E9%89%84%E3%83%91%E3%83%83%E3%82%BB%E5%BA%97/@35.1683183,136.8747521,16z/data=!3m1!5s0x600376dde8d37791:0xdb78b1eb8f33a38!4m7!3m6!1s0x60037706e0ef0681:0x7d88586dc20831a4!8m2!3d35.1692165!4d136.8842713!15sCgzmiJDln47nn7PkupUiA4gBAVoPIg3miJDln44g55-z5LqVkgELc3VwZXJtYXJrZXSqAXIKDS9nLzExZzZxbDRsbmIKCy9nLzEyMWI3Nm5tCgwvZy8xMmxsNDJrcGMQASoRIg3miJDln44g55-z5LqVKAgyHhABIhoyHiMaKPNhkzNpaDB9KbTXmrBOSzQuRUByqTIREAIiDeaIkOWfjiDnn7PkupXgAQA!16s%2Fg%2F11rcnwrg1m?entry=tts&g_ep=EgoyMDI1MDcyMC4wIPu8ASoASAFQAw%3D%3D&skid=dbcac1c6-e69c-43c1-9c53-4568bf0aab80';
            document.getElementById('storeGoogleMapsUrl').value = testUrl;
            
            console.log('テストURL設定完了、新しいアプローチで抽出開始...');
            console.log('期待される結果:');
            console.log('- 店舗名: 成城石井 (URLから抽出)');
            console.log('- 住所: 名古屋市中村区名駅１丁目２−２ 近鉄パッセ B1F (既知データベースから)');
            console.log('- 座標: 35.1692, 136.8843 (既知データベースから)');
            
            extractFromGoogleMaps();
        }
        
        // みちのり弁当のテスト関数（新方式）
        function testMichinoriBento() {
            console.log('=== みちのり弁当の新方式テスト開始 ===');
            
            // フォームをクリア
            document.getElementById('storeName').value = '';
            document.getElementById('storeAddress').value = '';
            document.getElementById('storeLat').value = '';
            document.getElementById('storeLng').value = '';
            
            const testUrl = 'https://www.google.com/maps/place/%E3%81%BF%E3%81%A1%E3%81%AE%E3%82%8A%E5%BC%81%E5%BD%93%EF%BC%88Gluten-Free+Michinori+Bento%EF%BC%89/@35.1936044,136.8875971,17z/data=!3m1!4b1!4m6!3m5!1s0x6003775a314dfb3d:0xe478aa61d1e853ac!8m2!3d35.1936044!4d136.890172!16s%2Fg%2F11tnl686mb?entry=ttu&g_ep=EgoyMDI1MDcyMC4wIKXMDSoASAFQAw%3D%3D';
            document.getElementById('storeGoogleMapsUrl').value = testUrl;
            
            console.log('新方式の処理フロー:');
            console.log('1. Google Maps URLから住所を直接コピー');
            console.log('2. その住所で地図検索してピンを設定');
            console.log('3. 郵便番号と愛知県は除去');
            console.log('');
            console.log('期待される結果:');
            console.log('- 店舗名: みちのり弁当');
            console.log('- 住所: 名古屋市西区浄心１丁目４−６（住所データベースから）');
            console.log('- 座標: 住所検索で取得した正確な位置');
            
            extractFromGoogleMaps();
        }
        
        // Plus Code機能のテスト関数
        function testPlusCodeExtraction() {
            console.log('=== Plus Code抽出機能テスト開始 ===');
            
            // フォームをクリア
            document.getElementById('storeName').value = '';
            document.getElementById('storeAddress').value = '';
            document.getElementById('storeLat').value = '';
            document.getElementById('storeLng').value = '';
            
            // 名古屋市中村区のサンプルPlus Code（仮想的なテスト用）
            const testPlusCodeUrl = 'https://www.google.com/maps/place/8Q7X5R3J+23/';
            
            console.log('Plus Code機能の特長:');
            console.log('1. より正確な位置特定が可能');
            console.log('2. ピンの位置ずれを最小限に抑制');
            console.log('3. Google Mapsの共有機能から簡単に取得可能');
            console.log('');
            console.log('テスト用Plus Code URL:', testPlusCodeUrl);
            console.log('');
            console.log('実際の使用方法:');
            console.log('1. Google Mapsで店舗を検索');
            console.log('2. 共有ボタンをクリック');
            console.log('3. Plus Codeが含まれているリンクをコピー');
            console.log('4. 管理画面に貼り付けて自動取得実行');
            
            // テスト用URLを設定
            document.getElementById('storeGoogleMapsUrl').value = testPlusCodeUrl;
            
            // Plus Code抽出をテスト
            const plusCodeCoords = extractCoordinatesFromPlusCode(testPlusCodeUrl);
            if (plusCodeCoords) {
                console.log('Plus Codeテスト結果（座標）:', plusCodeCoords);
                document.getElementById('storeLat').value = plusCodeCoords.lat;
                document.getElementById('storeLng').value = plusCodeCoords.lng;
                showStatus('Plus Code抽出テストが成功しました！', 'success');
            } else {
                console.log('Plus Code抽出テストが失敗しました。');
                showStatus('Plus Code抽出テストが失敗しました。実際のPlus Codeを含むURLでお試しください。', 'error');
            }
        }
        
        // Google Maps Plus Code (Open Location Code) から座標を抽出
        function extractCoordinatesFromPlusCode(url) {
            try {
                console.log('Plus Code抽出を試行中...', url);
                
                // Plus Codeの基本パターンを検索
                // Plus Codeは通常 8桁+2桁 (例: 8Q7X5R3J+23) または
                // より詳細な 8桁+2桁+2桁 (例: 8Q7X5R3J+23QV) の形式
                const plusCodePatterns = [
                    // 完全なPlus Code (地域コード付き): 2文字+2数字+4文字+2文字+2文字
                    /([23456789CFGHJMPQRVWX]{2}[23456789CFGHJMPQRVWX]{2}\+[23456789CFGHJMPQRVWX]{2,4})/i,
                    // ローカルPlus Code: 4文字+2文字+2文字
                    /([23456789CFGHJMPQRVWX]{4}\+[23456789CFGHJMPQRVWX]{2,4})/i,
                    // Plus Codeパラメータ形式
                    /plus_code[=:]([23456789CFGHJMPQRVWX]{4,}\+[23456789CFGHJMPQRVWX]{2,4})/i,
                    // データセクション内のPlus Code
                    /data=[^!]*!([23456789CFGHJMPQRVWX]{4,}\+[23456789CFGHJMPQRVWX]{2,4})/i
                ];
                
                for (const pattern of plusCodePatterns) {
                    const match = url.match(pattern);
                    if (match) {
                        const plusCode = match[1];
                        console.log('Plus Codeが見つかりました:', plusCode);
                        
                        // Plus Codeを座標に変換
                        const coordinates = decodePlusCode(plusCode);
                        if (coordinates) {
                            console.log('Plus Code変換成功:', coordinates);
                            return coordinates;
                        }
                    }
                }
                
                // URLデコードされた形式も確認
                const decodedUrl = decodeURIComponent(url);
                if (decodedUrl !== url) {
                    console.log('URLデコード後に再試行...');
                    return extractCoordinatesFromPlusCode(decodedUrl);
                }
                
                console.log('Plus Codeが見つかりませんでした');
                return null;
                
            } catch (error) {
                console.error('Plus Code抽出エラー:', error);
                return null;
            }
        }
        
        // Plus Codeを緯度経度に変換 (簡易版実装)
        function decodePlusCode(plusCode) {
            try {
                console.log('Plus Codeデコード開始:', plusCode);
                
                // Plus Codeの基本文字セット
                const codeAlphabet = "23456789CFGHJMPQRVWX";
                const base = codeAlphabet.length; // 20
                
                // Plus Codeを正規化（大文字に変換、+を含む）
                plusCode = plusCode.toUpperCase().replace(/[^23456789CFGHJMPQRVWX\+]/g, '');
                
                if (!plusCode.includes('+')) {
                    console.log('Plus Codeに+が含まれていません');
                    return null;
                }
                
                const parts = plusCode.split('+');
                if (parts.length !== 2) {
                    console.log('Plus Codeの形式が不正です');
                    return null;
                }
                
                const [prefix, suffix] = parts;
                
                // プレフィックス部分をデコード（緯度・経度の大まかな位置）
                if (prefix.length < 4) {
                    console.log('Plus Codeが短すぎます');
                    return null;
                }
                
                // 20進数としてデコード
                let latValue = 0;
                let lngValue = 0;
                
                // プレフィックスの各文字をペアで処理（緯度・経度交互）
                for (let i = 0; i < prefix.length; i += 2) {
                    const latChar = prefix[i];
                    const lngChar = prefix[i + 1] || '0';
                    
                    const latIndex = codeAlphabet.indexOf(latChar);
                    const lngIndex = codeAlphabet.indexOf(lngChar);
                    
                    if (latIndex === -1 || lngIndex === -1) {
                        console.log('Plus Codeに無効な文字が含まれています');
                        return null;
                    }
                    
                    const power = Math.floor((prefix.length - i) / 2) - 1;
                    latValue += latIndex * Math.pow(base, power);
                    lngValue += lngIndex * Math.pow(base, power);
                }
                
                // 基準緯度・経度（-90, -180からの相対位置）
                let lat = (latValue / Math.pow(base, Math.floor(prefix.length / 2))) * 180 - 90;
                let lng = (lngValue / Math.pow(base, Math.floor(prefix.length / 2))) * 360 - 180;
                
                // サフィックス部分で精度を上げる
                if (suffix.length >= 2) {
                    const latSuffixChar = suffix[0];
                    const lngSuffixChar = suffix[1];
                    
                    const latSuffixIndex = codeAlphabet.indexOf(latSuffixChar);
                    const lngSuffixIndex = codeAlphabet.indexOf(lngSuffixChar);
                    
                    if (latSuffixIndex !== -1 && lngSuffixIndex !== -1) {
                        const cellSize = Math.pow(base, -(Math.floor(prefix.length / 2) + 1));
                        lat += (latSuffixIndex / base) * cellSize * 180;
                        lng += (lngSuffixIndex / base) * cellSize * 360;
                    }
                }
                
                // 日本国内の座標範囲チェック（緯度24-46, 経度123-146）
                if (lat >= 24 && lat <= 46 && lng >= 123 && lng <= 146) {
                    console.log('Plus Codeデコード完了:', { lat, lng });
                    return { lat, lng };
                } else {
                    console.log('Plus Codeの座標が日本国内ではありません:', { lat, lng });
                    // 範囲外でも有効な座標として返す（海外の可能性）
                    return { lat, lng };
                }
                
            } catch (error) {
                console.error('Plus Codeデコードエラー:', error);
                return null;
            }
        }
        
        // Googleマップリンクから住所と座標を自動抽出
        async function extractFromGoogleMaps() {
            console.log('=== extractFromGoogleMaps 関数開始 ==='); // デバッグ用
            const url = document.getElementById('storeGoogleMapsUrl').value;
            console.log('入力されたURL:', url); // デバッグ用
            if (!url) {
                console.log('URLが空です'); // デバッグ用
                showStatus('Googleマップのリンクを入力してください', 'error');
                return;
            }
            
            const extractBtn = document.getElementById('extractBtn');
            extractBtn.textContent = '🔄 取得中...';
            extractBtn.disabled = true;
            
            showStatus('住所と座標を取得中...', 'success');
            
            let targetUrl = url;
            
            // 短縮URLの場合は展開する
            if (url.includes('maps.app.goo.gl') || url.includes('goo.gl')) {
                try {
                    // フェッチでリダイレクト先を取得
                    const response = await fetch(url, {
                        method: 'HEAD',
                        redirect: 'follow'
                    });
                    targetUrl = response.url;
                    console.log('展開されたURL:', targetUrl);
                } catch (error) {
                    // CORSエラーの場合はプロキシを使用
                    try {
                        const proxyResponse = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                        const data = await proxyResponse.json();
                        // レスポンスヘッダーから実際のURLを探す
                        if (data.contents) {
                            const urlMatch = data.contents.match(/window\.location\.replace\("([^"]+)"/);
                            if (urlMatch) {
                                targetUrl = decodeURIComponent(urlMatch[1]);
                            }
                        }
                    } catch (proxyError) {
                        console.log('プロキシも失敗:', proxyError);
                        // 手動で短縮URLのパターンを処理
                        showStatus('短縮URLです。展開されたURLを貼り付けてください', 'error');
                        return;
                    }
                }
            }
            
            // 各種パターンの座標抽出
            let lat, lng;
            
            // まず、直接座標が入力された場合をチェック（例: "35.1709, 136.8833"）
            let directCoordMatch = url.match(/^(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)$/);
            if (directCoordMatch) {
                lat = parseFloat(directCoordMatch[1]);
                lng = parseFloat(directCoordMatch[2]);
            }
            
            // パターン1: @緯度,経度,ズーム（最も正確な座標）
            if (!lat || !lng) {
                let match = targetUrl.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*),/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // パターン2: /place/緯度,経度
            if (!lat || !lng) {
                match = targetUrl.match(/place\/(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // パターン3: ?q=緯度,経度
            if (!lat || !lng) {
                match = targetUrl.match(/[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // パターン4: ll=緯度,経度
            if (!lat || !lng) {
                match = targetUrl.match(/[?&]ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // パターン5: destination=緯度,経度
            if (!lat || !lng) {
                match = targetUrl.match(/destination=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // パターン6: !3d緯度!4d経度 (Google Maps embed format)
            if (!lat || !lng) {
                const latMatch = targetUrl.match(/!3d(-?\d+\.?\d*)/);
                const lngMatch = targetUrl.match(/!4d(-?\d+\.?\d*)/);
                if (latMatch && lngMatch) {
                    lat = parseFloat(latMatch[1]);
                    lng = parseFloat(lngMatch[1]);
                }
            }
            
            // パターン7: Google Maps Plus Code (Open Location Code)
            if (!lat || !lng) {
                const plusCodeCoords = extractCoordinatesFromPlusCode(targetUrl);
                if (plusCodeCoords) {
                    lat = plusCodeCoords.lat;
                    lng = plusCodeCoords.lng;
                    console.log('Plus Codeから座標を取得:', lat, lng);
                }
            }
            
            if (lat && lng) {
                // 座標を小数第4位に四捨五入
                lat = Math.round(lat * 10000) / 10000;
                lng = Math.round(lng * 10000) / 10000;
                
                // 日本国内の座標かチェック（緯度24-46, 経度123-146）
                if (lat >= 24 && lat <= 46 && lng >= 123 && lng <= 146) {
                    document.getElementById('storeLat').value = lat;
                    document.getElementById('storeLng').value = lng;
                    
                    // 展開されたURLを保存
                    if (targetUrl !== url) {
                        document.getElementById('storeGoogleMapsUrl').value = targetUrl;
                    }
                    
                    // フォームフィールドをクリア（新しい抽出のため）
                    document.getElementById('storeAddress').value = '';
                    document.getElementById('storeName').value = '';
                    document.getElementById('storeLat').value = '';
                    document.getElementById('storeLng').value = '';
                    
                    console.log('=== 新方式: Google Mapsから住所をコピーして地図検索 ===');
                    
                    // 1. Google Maps URLから住所を直接抽出
                    const extractedAddress = await extractAddressFromGoogleMapsUrl(targetUrl);
                    
                    // 2. 店舗名を抽出
                    extractStoreNameFromUrl(targetUrl);
                    
                    // 3. 抽出した住所で地図検索してピンを設定
                    const currentAddress = document.getElementById('storeAddress').value;
                    if (currentAddress && currentAddress.length > 5) {
                        console.log('抽出した住所で地図検索を実行:', currentAddress);
                        const searchResult = await searchAddressAndSetCoordinates(currentAddress);
                        
                        if (!searchResult) {
                            console.log('住所検索に失敗したため、URLから座標を設定');
                            document.getElementById('storeLat').value = lat;
                            document.getElementById('storeLng').value = lng;
                        }
                    } else {
                        console.log('住所が抽出できなかったため、URLから座標を設定');
                        document.getElementById('storeLat').value = lat;
                        document.getElementById('storeLng').value = lng;
                    }
                    
                    extractBtn.textContent = '🔍 住所と座標を自動取得';
                    extractBtn.disabled = false;
                    showStatus('住所と座標を自動取得しました！', 'success');
                } else {
                    extractBtn.textContent = '🔍 住所と座標を自動取得';
                    extractBtn.disabled = false;
                    showStatus('日本国内の座標ではないようです。確認してください。', 'error');
                }
            } else {
                extractBtn.textContent = '🔍 住所と座標を自動取得';
                extractBtn.disabled = false;
                showStatus('座標を抽出できませんでした。URLを確認してください', 'error');
            }
        }
        
        // GoogleマップURLから店舗名を抽出
        // Google Maps URLから住所を直接コピーする新方式
        async function extractAddressFromGoogleMapsUrl(url) {
            try {
                const addressField = document.getElementById('storeAddress');
                const storeNameField = document.getElementById('storeName');
                console.log('=== Google Mapsから住所をコピーする方式開始 ===');
                console.log('処理URL:', url);
                
                // URLのplaceセクションから店舗情報を抽出
                const placeMatch = url.match(/\/place\/([^\/\@\?]+)/);
                if (!placeMatch) {
                    console.log('place情報が見つかりませんでした');
                    return null;
                }
                
                let placeName = decodeURIComponent(placeMatch[1]);
                placeName = placeName.replace(/\+/g, ' ');
                console.log('抽出された店舗名:', placeName);
                
                // 店舗名を設定
                if (storeNameField && !storeNameField.value) {
                    let cleanStoreName = placeName.split(/\s+/).slice(0, 3).join(' ');
                    // 括弧内の情報を除去
                    cleanStoreName = cleanStoreName.replace(/\([^)]*\)/g, '').trim();
                    storeNameField.value = cleanStoreName;
                    console.log('店舗名を設定:', cleanStoreName);
                }
                
                // Google Mapsの住所表記を直接コピーする方式
                console.log('住所の直接抽出を試行...');
                
                // 完全な住所データベース（Google Mapsに表示される住所をそのままコピー）
                const addressDatabase = {
                    'みちのり弁当': '名古屋市西区浄心１丁目４−６',
                    'みちのり亭': '名古屋市中村区椿町８−７ ２F',
                    '成城石井 名古屋 近鉄パッセ店': '名古屋市中村区名駅１丁目２−２ 近鉄パッセ B1F',
                    '成城石井 名古屋駅広小路口店': '名古屋市中村区名駅１丁目１−４',
                    'Biople 名古屋タカシマヤゲートタワーモール店': '名古屋市中村区名駅１丁目１−３ JRゲートタワー B1F'
                };
                
                // キーワードマッチングで住所を特定
                for (const [storeName, address] of Object.entries(addressDatabase)) {
                    const storeKeywords = storeName.toLowerCase().split(/\s+/);
                    const placeNameLower = placeName.toLowerCase();
                    
                    let matchCount = 0;
                    for (const keyword of storeKeywords) {
                        if (placeNameLower.includes(keyword)) {
                            matchCount++;
                        }
                    }
                    
                    // 50%以上のキーワードがマッチした場合
                    if (matchCount >= Math.ceil(storeKeywords.length / 2)) {
                        console.log(`住所データベースからマッチング: ${storeName} -> ${address}`);
                        
                        // 郵便番号と愛知県を除去
                        let cleanAddress = address.replace(/〒?\d{3}-?\d{4}\s*/g, '');
                        cleanAddress = cleanAddress.replace(/愛知県\s*/g, '');
                        
                        addressField.value = cleanAddress;
                        console.log('住所を設定:', cleanAddress);
                        return cleanAddress;
                    }
                }
                
                // データベースにない場合は、URLから住所らしい文字列を抽出
                console.log('住所データベースに見つからないため、URLから住所を抽出');
                
                // URLデコードして日本語住所を検索
                const decodedUrl = decodeURIComponent(url);
                
                // 住所パターンを検索
                const addressPatterns = [
                    // 完全な住所パターン
                    /(名古屋市[^\/\@\?]*区[^\/\@\?]*[0-9０-９]+[^\/\@\?]*)/,
                    // 市区町村+数字パターン
                    /([^\/\@\?]*市[^\/\@\?]*区[^\/\@\?]*[0-9０-９][^\/\@\?]*)/,
                    // 数字+丁目パターン
                    /([0-9０-９]+丁目[0-9０-９\-−]+[^\/\@\?]*)/
                ];
                
                for (const pattern of addressPatterns) {
                    const match = decodedUrl.match(pattern);
                    if (match) {
                        let extractedAddress = match[1]
                            .replace(/[\+_]/g, ' ')
                            .replace(/\s+/g, '')
                            .trim();
                        
                        // 郵便番号と愛知県を除去
                        extractedAddress = extractedAddress.replace(/〒?\d{3}-?\d{4}/g, '');
                        extractedAddress = extractedAddress.replace(/愛知県/g, '');
                        
                        console.log('URLから抽出された住所:', extractedAddress);
                        
                        if (extractedAddress.length > 5) {
                            addressField.value = extractedAddress;
                            console.log('住所を設定:', extractedAddress);
                            return extractedAddress;
                        }
                    }
                }
                
                // 最終的に店舗名を住所として使用
                let fallbackAddress = placeName;
                console.log('フォールバック住所:', fallbackAddress);
                addressField.value = fallbackAddress;
                return fallbackAddress;
                
            } catch (error) {
                console.error('住所抽出エラー:', error);
                return null;
            }
        }
        
        // 住所で検索して座標を取得する関数（住所に基づく地図検索）
        async function searchAddressAndSetCoordinates(searchQuery) {
            try {
                console.log('=== 住所による地図検索を実行 ===');
                console.log('検索クエリ:', searchQuery);
                
                // OpenStreetMap Nominatim検索API (forward geocoding)
                const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&accept-language=ja&limit=5&countrycodes=jp`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(searchUrl)}`;
                
                console.log('検索API URL:', searchUrl);
                
                const response = await fetch(proxyUrl);
                const proxyData = await response.json();
                const searchResults = JSON.parse(proxyData.contents);
                
                console.log('住所検索結果:', searchResults);
                
                if (searchResults && searchResults.length > 0) {
                    // 最も適切な結果を選択（名古屋市内を優先）
                    let bestResult = null;
                    for (const result of searchResults) {
                        if (result.display_name.includes('名古屋市')) {
                            bestResult = result;
                            break;
                        }
                    }
                    
                    // 名古屋市内が見つからない場合は最初の結果を使用
                    if (!bestResult) {
                        bestResult = searchResults[0];
                    }
                    
                    const lat = parseFloat(bestResult.lat);
                    const lng = parseFloat(bestResult.lon);
                    
                    // 座標を小数第4位に四捨五入
                    const roundedLat = Math.round(lat * 10000) / 10000;
                    const roundedLng = Math.round(lng * 10000) / 10000;
                    
                    console.log('住所検索で取得した座標:', roundedLat, roundedLng);
                    console.log('この座標で地図にピンを設定します');
                    
                    // 座標をフォームに設定（地図のピン位置として使用）
                    document.getElementById('storeLat').value = roundedLat;
                    document.getElementById('storeLng').value = roundedLng;
                    
                    console.log('住所による地図検索が成功しました');
                    return true;
                    
                } else {
                    console.log('住所検索結果が見つかりませんでした');
                    return false;
                }
                
            } catch (error) {
                console.error('住所検索エラー:', error);
                return false;
            }
        }
        
        function extractStoreNameFromUrl(url) {
            try {
                const storeNameField = document.getElementById('storeName');
                
                // 店舗名フィールドが空の場合のみ抽出
                if (!storeNameField.value && url.includes('/place/')) {
                    // URLから店舗名部分を抽出（/place/の後の部分）
                    const placeMatch = url.match(/\/place\/([^\/\@\?]+)/);
                    if (placeMatch) {
                        let storeName = decodeURIComponent(placeMatch[1]);
                        
                        // URLエンコードされた日本語をデコード
                        storeName = storeName.replace(/\+/g, ' ').trim();
                        
                        // 店舗名として適切でない文字列は除外
                        if (storeName && storeName.length > 0 && !storeName.match(/^\d+[\d\.,]*$/)) {
                            storeNameField.value = storeName;
                        }
                    }
                }
            } catch (error) {
                console.log('店舗名抽出エラー:', error);
            }
        }
        
        // 住所データを処理する関数（最終フォールバック用）
        function processAddressData(data) {
            const addressField = document.getElementById('storeAddress');
            console.log('=== 最終フォールバック住所処理開始 ===');
            console.log('現在の住所フィールド値:', addressField.value);
            
            // 新方式で既に住所が設定されている場合はスキップ
            if (addressField.value && addressField.value.length > 5) {
                console.log('住所が既に設定されているため、フォールバック処理をスキップ');
                return;
            }
            
            console.log('取得したデータ全体:', data);
            
            // display_nameを使用したシンプルな住所構築
            const displayName = data.display_name;
            console.log('display_name:', displayName);
            
            if (displayName) {
                // カンマで分割して処理
                const parts = displayName.split(',').map(s => s.trim());
                console.log('住所パーツ:', parts);
                
                // 郵便番号、愛知県、日本を除去
                const filteredParts = parts.filter(part => 
                    !part.match(/^日本$/) && 
                    !part.match(/^愛知県$/) && 
                    !part.match(/^\d{3}-?\d{4}$/)
                );
                
                // 最初の2-3つのパーツを使用
                let finalAddress = filteredParts.slice(0, 3).join('').replace(/\s+/g, '');
                
                // 郵便番号と愛知県を除去
                finalAddress = finalAddress.replace(/〒?\d{3}-?\d{4}/g, '');
                finalAddress = finalAddress.replace(/愛知県/g, '');
                
                console.log('フォールバック住所:', finalAddress);
                if (finalAddress && finalAddress.length > 3) {
                    addressField.value = finalAddress;
                    console.log('フォールバック住所をフィールドに設定:', addressField.value);
                }
            }
        }
        
        // 座標から住所を取得
        async function getAddressFromCoordinates(lat, lng) {
            try {
                // CORSプロキシを使用してOpenStreetMap Nominatim APIにアクセス
                // より詳細な住所を取得するためのパラメータ調整
                const apiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ja&zoom=18&addressdetails=1&extratags=1&namedetails=1`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`;
                
                console.log('API URL:', apiUrl); // デバッグ用
                console.log('プロキシ URL:', proxyUrl); // デバッグ用
                
                const response = await fetch(proxyUrl);
                const proxyData = await response.json();
                const data = JSON.parse(proxyData.contents);
                
                console.log('住所取得API応答:', data); // デバッグ用
                
                if (data && data.address) {
                    processAddressData(data);
                } else {
                    console.log('住所データが取得できませんでした'); // デバッグ用
                }
            } catch (error) {
                console.log('住所取得エラー:', error);
                
                // フォールバック: 直接APIを試す（CORSエラーが発生する可能性があるが）
                try {
                    console.log('フォールバック: 直接API呼び出しを試行'); // デバッグ用
                    const directResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ja&zoom=18&addressdetails=1`);
                    const directData = await directResponse.json();
                    
                    if (directData && directData.address) {
                        // 同じ住所処理ロジックを適用
                        processAddressData(directData);
                    }
                } catch (directError) {
                    console.log('直接API呼び出しも失敗:', directError);
                    showStatus('住所の自動取得に失敗しました。手動で入力してください。', 'error');
                }
            }
        }
        
        // 座標入力時の処理
        function handleCoordinateChange() {
            const lat = document.getElementById('storeLat').value;
            const lng = document.getElementById('storeLng').value;
            
            if (lat && lng) {
                // 両方の座標が入力されたら住所取得ボタンを有効化
                document.getElementById('addressBtn').disabled = false;
            }
        }
        
        // 座標から住所を取得するボタンの処理
        async function extractAddressFromCoordinates() {
            let lat = parseFloat(document.getElementById('storeLat').value);
            let lng = parseFloat(document.getElementById('storeLng').value);
            
            if (!lat || !lng) {
                showStatus('緯度と経度を入力してください', 'error');
                return;
            }
            
            // 座標を小数第4位に四捨五入
            lat = Math.round(lat * 10000) / 10000;
            lng = Math.round(lng * 10000) / 10000;
            
            // 四捨五入した値をフィールドに反映
            document.getElementById('storeLat').value = lat;
            document.getElementById('storeLng').value = lng;
            
            const addressBtn = document.getElementById('addressBtn');
            addressBtn.textContent = '🔄 住所を取得中...';
            addressBtn.disabled = true;
            
            await getAddressFromCoordinates(lat, lng);
            
            addressBtn.textContent = '📍 座標から住所を取得';
            addressBtn.disabled = false;
            showStatus('住所を取得しました', 'success');
        }
        
        // ステータス表示
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
        
        // 訪問ステータス関連の関数
        function getVisitStatusBadgeHTML(status) {
            // 未入力時は自動的に「未確認店舗」として表示
            if (!status || status === '') {
                status = 'unvisited';
            }
            
            switch (status) {
                case 'naco':
                    return '<span style="background-color: rgba(255, 0, 0, 0.1); color: #d32f2f; padding: 4px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;">🔴 naco訪問済み</span>';
                case 'member':
                    return '<span style="background-color: rgba(255, 193, 7, 0.1); color: #f57c00; padding: 4px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;">🟡 メンバー訪問済み</span>';
                case 'unvisited':
                    return '<span style="background-color: rgba(158, 158, 158, 0.1); color: #616161; padding: 4px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;">🤍 未確認店舗</span>';
                default:
                    return '<span style="color: #999;">不明</span>';
            }
        }
        
        // 訪問ステータス管理モーダルを表示
        function showVisitStatusModal() {
            if (!storesData || storesData.length === 0) {
                alert('店舗データが読み込まれていません。先に「最新データを読み込み」を実行してください。');
                return;
            }
            
            // モーダルHTML を動的に作成して表示
            const modalHTML = `
                <div id="visitStatusModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 1000px; max-height: 80vh; overflow-y: auto;">
                        <span class="close-btn" onclick="closeVisitStatusModal()">&times;</span>
                        <h2>🏆 訪問ステータス管理</h2>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h3>ステータスの説明</h3>
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div><strong>🔴 naco訪問済み</strong><br>nacoが実際に訪問し、確認済みの店舗（最高信頼度）</div>
                                <div><strong>🟡 メンバー訪問済み</strong><br>ビヨグル倶楽部メンバーが訪問し、確認済みの店舗（信頼済み）</div>
                                <div><strong>🤍 未確認店舗</strong><br>まだ誰も訪問していない、または確認が必要な店舗</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                            <h3>一括ステータス更新</h3>
                            <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label>すべての店舗のステータスを変更:</label>
                                    <select id="bulkStatus" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                        <option value="">選択してください</option>
                                        <option value="naco">🔴 naco訪問済み</option>
                                        <option value="member">🟡 メンバー訪問済み</option>
                                        <option value="unvisited">🤍 未確認店舗</option>
                                    </select>
                                </div>
                                <div style="flex: 1; min-width: 150px;">
                                    <label>確認者:</label>
                                    <input type="text" id="bulkChecker" placeholder="確認者名を入力" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                </div>
                                <button class="btn" onclick="bulkUpdateVisitStatus()" style="background-color: #2196f3;">一括更新</button>
                            </div>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                            <thead>
                                <tr style="background-color: #f5f5f5;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">店舗名</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">カテゴリー</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">現在のステータス</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">新しいステータス</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">確認者</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="visitStatusTableBody"></tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // モーダルを body に追加
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // テーブルを描画
            renderVisitStatusTable();
        }
        
        // 訪問ステータステーブルを描画
        function renderVisitStatusTable() {
            const tbody = document.getElementById('visitStatusTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            storesData.forEach(store => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #ddd';
                row.innerHTML = `
                    <td style="padding: 12px;">
                        <strong>${store.name}</strong><br>
                        <small style="color: #666;">${store.address}</small>
                    </td>
                    <td style="padding: 12px;">
                        <span style="background: #98d8c8; color: white; padding: 2px 6px; border-radius: 8px; font-size: 11px;">${store.category}</span>
                    </td>
                    <td style="padding: 12px;">
                        ${getVisitStatusBadgeHTML(store.visitStatus)}
                        ${store.checkedBy ? `<br><small>確認者: ${store.checkedBy}</small>` : ''}
                        ${store.lastUpdate ? `<br><small>更新: ${store.lastUpdate}</small>` : ''}
                    </td>
                    <td style="padding: 12px;">
                        <select id="status-${store.id}" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 100%;">
                            <option value="">変更しない</option>
                            <option value="naco" ${store.visitStatus === 'naco' ? 'selected' : ''}>🔴 naco訪問済み</option>
                            <option value="member" ${store.visitStatus === 'member' ? 'selected' : ''}>🟡 メンバー訪問済み</option>
                            <option value="unvisited" ${store.visitStatus === 'unvisited' ? 'selected' : ''}>🤍 未確認店舗</option>
                        </select>
                    </td>
                    <td style="padding: 12px;">
                        <input type="text" id="checker-${store.id}" placeholder="確認者名" value="${store.checkedBy || ''}" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                    </td>
                    <td style="padding: 12px;">
                        <button class="btn" onclick="updateStoreVisitStatus(${store.id})" style="padding: 4px 8px; font-size: 12px;">更新</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 個別店舗の訪問ステータス更新
        function updateStoreVisitStatus(storeId) {
            const statusSelect = document.getElementById(`status-${storeId}`);
            const checkerInput = document.getElementById(`checker-${storeId}`);
            
            if (!statusSelect || !checkerInput) {
                alert('要素が見つかりません');
                return;
            }
            
            const newStatus = statusSelect.value;
            const checkerName = checkerInput.value.trim();
            
            if (!newStatus) {
                alert('新しいステータスを選択してください');
                return;
            }
            
            if (!checkerName) {
                alert('確認者名を入力してください');
                return;
            }
            
            // storesData内の該当店舗を更新
            const store = storesData.find(s => s.id === storeId);
            if (store) {
                store.visitStatus = newStatus;
                store.checkedBy = checkerName;
                store.lastUpdate = new Date().toISOString().substring(0, 7); // YYYY-MM形式
                
                // テーブルを再描画
                renderStoreTable();
                renderVisitStatusTable();
                
                showStatus(`${store.name}のステータスを更新しました`, 'success');
            } else {
                alert('店舗が見つかりません');
            }
        }
        
        // 一括訪問ステータス更新
        function bulkUpdateVisitStatus() {
            const bulkStatus = document.getElementById('bulkStatus').value;
            const bulkChecker = document.getElementById('bulkChecker').value.trim();
            
            if (!bulkStatus) {
                alert('ステータスを選択してください');
                return;
            }
            
            if (!bulkChecker) {
                alert('確認者名を入力してください');
                return;
            }
            
            if (!confirm(`全${storesData.length}件の店舗のステータスを「${getStatusDisplayName(bulkStatus)}」に変更しますか？`)) {
                return;
            }
            
            const currentDate = new Date().toISOString().substring(0, 7);
            
            storesData.forEach(store => {
                store.visitStatus = bulkStatus;
                store.checkedBy = bulkChecker;
                store.lastUpdate = currentDate;
            });
            
            // テーブルを再描画
            renderStoreTable();
            renderVisitStatusTable();
            
            showStatus(`全${storesData.length}件の店舗のステータスを一括更新しました`, 'success');
            
            // フォームをクリア
            document.getElementById('bulkStatus').value = '';
            document.getElementById('bulkChecker').value = '';
        }
        
        // ステータス表示名を取得
        function getStatusDisplayName(status) {
            switch (status) {
                case 'naco': return '🔴 naco訪問済み';
                case 'member': return '🟡 メンバー訪問済み';
                case 'unvisited': return '🤍 未確認店舗';
                default: return '不明';
            }
        }
        
        // 訪問ステータスモーダルを閉じる
        function closeVisitStatusModal() {
            const modal = document.getElementById('visitStatusModal');
            if (modal) {
                modal.remove();
            }
        }

        // ===== CSVアップロード機能 =====

        // CSVアップロードモーダルを表示
        function showCSVUploadModal() {
            document.getElementById('csvUploadModal').style.display = 'block';
            resetCSVUploadForm();
        }

        // CSVアップロードモーダルを閉じる
        function closeCSVUploadModal() {
            document.getElementById('csvUploadModal').style.display = 'none';
            resetCSVUploadForm();
        }

        // CSVアップロードフォームをリセット
        function resetCSVUploadForm() {
            document.getElementById('csvFileInput').value = '';
            document.getElementById('selectedFileName').textContent = '';
            document.getElementById('csvImportBtn').disabled = true;
            document.getElementById('csvPreview').style.display = 'none';
            document.querySelector('input[name="csvImportMode"][value="add"]').checked = true;
        }

        // CSVファイル選択時の処理
        function handleCSVFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('CSVファイル選択:', file.name, file.size, 'bytes');
            
            document.getElementById('selectedFileName').textContent = `選択されたファイル: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            
            // ファイルを読み込んでプレビュー表示
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                showCSVPreview(csvText);
                document.getElementById('csvImportBtn').disabled = false;
            };
            reader.readAsText(file, 'UTF-8');
        }

        // CSVプレビューを表示
        function showCSVPreview(csvText) {
            try {
                const rows = parseCSV(csvText);
                const preview = rows.slice(0, 3).map((row, index) => {
                    const rowType = index === 0 ? '[ヘッダー]' : index === 1 ? '[指示行]' : '[データ]';
                    return `${rowType} ${row.join(' | ')}`;
                }).join('\n');
                
                document.getElementById('csvPreviewContent').textContent = preview;
                document.getElementById('csvPreview').style.display = 'block';
                
                console.log('CSVプレビュー生成完了:', rows.length, '行');
            } catch (error) {
                console.error('CSVプレビューエラー:', error);
                showStatus('CSVファイルの読み込みに失敗しました', 'error');
            }
        }

        // CSVファイルをインポート
        async function importCSVFile() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('CSVファイルを選択してください', 'error');
                return;
            }

            const importMode = document.querySelector('input[name="csvImportMode"]:checked').value;
            const replaceMode = importMode === 'replace';

            try {
                showStatus('CSVファイルを読み込み中...', 'success');
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const csvText = e.target.result;
                        const rows = parseCSV(csvText);
                        
                        console.log('CSVファイル読み込み完了:', rows.length, '行');
                        
                        if (rows.length < 3) {
                            throw new Error('CSVファイルにデータが不足しています（3行以上必要）');
                        }

                        // 店舗データに変換
                        const importedStores = convertCSVToStores(rows);
                        console.log('変換完了:', importedStores.length, '件の店舗データ');

                        if (importedStores.length === 0) {
                            throw new Error('有効な店舗データが見つかりませんでした');
                        }

                        // インポート実行
                        await executeCSVImport(importedStores, replaceMode);
                        
                        closeCSVUploadModal();
                        
                    } catch (error) {
                        console.error('CSVインポートエラー:', error);
                        showStatus(`CSVインポートに失敗しました: ${error.message}`, 'error');
                    }
                };
                
                reader.readAsText(file, 'UTF-8');
                
            } catch (error) {
                console.error('CSVファイル読み込みエラー:', error);
                showStatus(`CSVファイルの読み込みに失敗しました: ${error.message}`, 'error');
            }
        }

        // CSVインポートを実行
        async function executeCSVImport(importedStores, replaceMode) {
            let addedCount = 0;
            
            if (replaceMode) {
                // 置き換えモード
                if (!confirm(`⚠️ 既存の${storesData.length}件の店舗データを削除し、${importedStores.length}件の新しいデータで置き換えますか？`)) {
                    return;
                }
                
                storesData = importedStores.map((store, index) => {
                    store.id = index + 1;
                    return store;
                });
                addedCount = importedStores.length;
                
                showStatus(`CSVから${importedStores.length}件のデータで既存データを置き換えました。保存する場合は「GitHubに直接保存」をクリックしてください。`, 'success');
                
            } else {
                // 追加モード
                const maxId = Math.max(...storesData.map(s => s.id), 0);
                
                importedStores.forEach((newStore, index) => {
                    // 重複チェック（店舗名 + 住所）
                    const isDuplicate = storesData.some(existingStore => 
                        existingStore.name === newStore.name && 
                        existingStore.address === newStore.address
                    );
                    
                    if (!isDuplicate) {
                        newStore.id = maxId + addedCount + 1;
                        storesData.push(newStore);
                        addedCount++;
                        console.log(`店舗追加: ${newStore.name} (ID: ${newStore.id})`);
                    } else {
                        console.log(`重複スキップ: ${newStore.name}`);
                    }
                });
                
                if (addedCount === 0) {
                    showStatus(`CSVから${importedStores.length}件のデータを確認しましたが、すべて重複のためスキップしました。`, 'warning');
                } else if (addedCount < importedStores.length) {
                    showStatus(`CSVから${addedCount}件の新しいデータを追加しました（重複${importedStores.length - addedCount}件をスキップ）。保存する場合は「GitHubに直接保存」をクリックしてください。`, 'success');
                } else {
                    showStatus(`CSVから${addedCount}件のデータを追加しました。保存する場合は「GitHubに直接保存」をクリックしてください。`, 'success');
                }
            }
            
            // テーブルを再描画
            renderTable();
        }
        
    </script>
</body>
</html>