<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢ - åå¤å±‹ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #ffb6c1 0%, #98d8c8 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #4a4a4a;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .btn {
            background: linear-gradient(135deg, #ffb6c1 0%, #98d8c8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: linear-gradient(135deg, #ffb6c1 0%, #98d8c8 100%);
            color: white;
            font-weight: bold;
        }
        
        .category-badge {
            padding: 4px 12px;
            border-radius: 12px;
            color: white;
            font-size: 12px;
        }
        
        .category-å’Œé£Ÿ { background-color: #ff6b6b; }
        .category-æ´‹é£Ÿ { background-color: #4ecdc4; }
        .category-ã‚«ãƒ•ã‚§ { background-color: #f7b731; }
        .category-ãƒ‘ãƒ³å±‹ { background-color: #5f27cd; }
        .category-è²©å£²åº— { background-color: #00d2d3; }
        .category-ã‚¹ã‚¤ãƒ¼ãƒ„ { background-color: #ff69b4; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            max-height: 90vh;
            margin: 50px auto;
            padding: 30px;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a4a4a;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #98d8c8;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        #extractBtn {
            margin-top: 8px;
            background: #4CAF50;
            color: white;
            border: none;
            font-weight: bold;
        }
        
        #extractBtn:hover:not(:disabled) {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ° åå¤å±‹ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—ç®¡ç†ç”»é¢</h1>
            <p>åº—èˆ—æƒ…å ±ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãŒã§ãã¾ã™</p>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="showAddModal()">â• æ–°ã—ã„åº—èˆ—ã‚’è¿½åŠ </button>
            <button class="btn" onclick="loadFromSpreadsheet()">ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿</button>
            <button class="btn btn-success" onclick="saveToGitHubDirect()">ğŸš€ GitHubã«ç›´æ¥ä¿å­˜</button>
            <button class="btn" onclick="saveToGitHub()">ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>
        
        <!-- GitHubè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="githubModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeGitHubModal()">&times;</span>
                <h2>GitHubè¨­å®š</h2>
                <p>åˆå›ã®ã¿è¨­å®šãŒå¿…è¦ã§ã™ã€‚Personal Access Tokenã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                
                <div class="form-group">
                    <label>GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                    <div class="help-text">
                        <strong>å–å¾—æ–¹æ³•:</strong><br>
                        1. GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens â†’ Tokens (classic)<br>
                        2. ã€ŒGenerate new tokenã€â†’ã€ŒGenerate new token (classic)ã€<br>
                        3. ã€ŒContentsã€æ¨©é™ã‚’é¸æŠ<br>
                        4. ç”Ÿæˆã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ”ãƒ¼
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="saveGitHubToken()">ä¿å­˜</button>
                <button class="btn" onclick="closeGitHubModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
        
        <div id="status" class="status"></div>
        
        <div class="table-container">
            <table id="storesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>åº—èˆ—å</th>
                        <th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
                        <th>ä½æ‰€</th>
                        <th>GFå¯¾å¿œ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="storesTableBody">
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- åº—èˆ—è¿½åŠ ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="storeModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">æ–°ã—ã„åº—èˆ—ã‚’è¿½åŠ </h2>
            
            <form id="storeForm">
                <div class="form-group">
                    <label>åº—èˆ—å *</label>
                    <input type="text" id="storeName" required>
                </div>
                
                <div class="form-group">
                    <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼ *</label>
                    <select id="storeCategory" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="å’Œé£Ÿ">å’Œé£Ÿ</option>
                        <option value="æ´‹é£Ÿ">æ´‹é£Ÿ</option>
                        <option value="ã‚«ãƒ•ã‚§">ã‚«ãƒ•ã‚§</option>
                        <option value="ãƒ‘ãƒ³å±‹">ãƒ‘ãƒ³å±‹</option>
                        <option value="è²©å£²åº—">è²©å£²åº—</option>
                        <option value="ã‚¹ã‚¤ãƒ¼ãƒ„">ã‚¹ã‚¤ãƒ¼ãƒ„</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ä½æ‰€ *</label>
                    <input type="text" id="storeAddress" required>
                </div>
                
                <div class="form-group">
                    <label>Googleãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ *</label>
                    <input type="url" id="storeGoogleMapsUrl" placeholder="https://www.google.com/maps/place/..." required onpaste="handleGoogleMapsUrlPaste(event)">
                    <button type="button" class="btn" onclick="extractFromGoogleMaps()" id="extractBtn">ğŸ” ä½æ‰€ã¨åº§æ¨™ã‚’è‡ªå‹•å–å¾—</button>
                    <div class="help-text">
                        ğŸ“± <strong>åº§æ¨™å–å¾—æ–¹æ³•ï¼ˆæ¨å¥¨ï¼‰:</strong><br>
                        1. Googleãƒãƒƒãƒ—ã§ãŠåº—ã‚’æ¤œç´¢<br>
                        2. <strong style="color: #d32f2f;">åº—èˆ—ãƒ”ãƒ³ã®ä¸Šã§å³ã‚¯ãƒªãƒƒã‚¯</strong>â†’ã€Œã“ã®å ´æ‰€ã«ã¤ã„ã¦ã€<br>
                        3. è¡¨ç¤ºã•ã‚ŒãŸåº§æ¨™ï¼ˆä¾‹: 35.1709, 136.8833ï¼‰ã‚’ã‚³ãƒ”ãƒ¼<br>
                        4. ã“ã“ã«è²¼ã‚Šä»˜ã‘ã‚‹ã¨è‡ªå‹•ã§ä½æ‰€ã¨åº§æ¨™ã‚’å–å¾—<br>
                        â€» é€šå¸¸ã®å…±æœ‰ãƒªãƒ³ã‚¯ã‚‚ä½¿ç”¨å¯èƒ½
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ç·¯åº¦ *</label>
                    <input type="number" id="storeLat" step="0.0001" required placeholder="ä¾‹: 35.1709" onchange="handleCoordinateChange()">
                    <div class="help-text">
                        ğŸ“ Googleãƒãƒƒãƒ—ã§å³ã‚¯ãƒªãƒƒã‚¯â†’ã€Œã“ã®å ´æ‰€ã«ã¤ã„ã¦ã€ã§å–å¾—ã—ãŸåº§æ¨™ã‚’å…¥åŠ›å¯èƒ½
                    </div>
                </div>
                
                <div class="form-group">
                    <label>çµŒåº¦ *</label>
                    <input type="number" id="storeLng" step="0.0001" required placeholder="ä¾‹: 136.8833" onchange="handleCoordinateChange()">
                </div>
                
                <div class="form-group">
                    <button type="button" class="btn" onclick="extractAddressFromCoordinates()" id="addressBtn">ğŸ“ åº§æ¨™ã‹ã‚‰ä½æ‰€ã‚’å–å¾—</button>
                </div>
                
                <div class="form-group">
                    <label>å–¶æ¥­æ™‚é–“</label>
                    <input type="text" id="storeHours">
                </div>
                
                <div class="form-group">
                    <label>å®šä¼‘æ—¥</label>
                    <input type="text" id="storeClosed">
                </div>
                
                <div class="form-group">
                    <label>é›»è©±ç•ªå·</label>
                    <input type="text" id="storeTel">
                </div>
                
                <div class="form-group">
                    <label>åº—èˆ—èª¬æ˜</label>
                    <textarea id="storeDescription"></textarea>
                </div>
                
                <div class="form-group">
                    <label>GFå¯¾å¿œ</label>
                    <select id="storeGfType">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="å®Œå…¨GF">å®Œå…¨GF</option>
                        <option value="éƒ¨åˆ†GF">éƒ¨åˆ†GF</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="storeTakeout"> ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆå¯èƒ½
                    </label>
                </div>
                
                <div class="form-group">
                    <label>å¸­æ•°</label>
                    <input type="number" id="storeSeats" min="0">
                </div>
                
                <div class="form-group">
                    <label>nacoã®ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                    <textarea id="storeComment"></textarea>
                </div>
                
                <div class="form-group">
                    <label>ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</label>
                    <input type="url" id="storeWebsite" placeholder="https://example.com">
                </div>
                
                <div class="form-group">
                    <label>Instagram</label>
                    <input type="url" id="storeInstagram" placeholder="https://www.instagram.com/username/">
                </div>
                
                <div class="form-group">
                    <label>åº—èˆ—ç”»åƒURL</label>
                    <input type="url" id="storeImageUrl" placeholder="https://example.com/image.jpg">
                    <div class="help-text">
                        ğŸ“¸ <strong>ç”»åƒã«ã¤ã„ã¦:</strong><br>
                        â€¢ ç„¡æ–™ç”»åƒã‚µã‚¤ãƒˆï¼ˆUnsplashç­‰ï¼‰ã®URLã‚’ä½¿ç”¨å¯èƒ½<br>
                        â€¢ æ¨å¥¨ã‚µã‚¤ã‚ºï¼š400x300pxä»¥ä¸Š<br>
                        â€¢ ç©ºæ¬„ã®å ´åˆã¯ç”»åƒãªã—ã§è¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                </div>
                
                <button type="submit" class="btn">ä¿å­˜</button>
                <button type="button" class="btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </form>
        </div>
    </div>

    <script>
        let storesData = [];
        let editingStoreId = null;
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadStoresData();
        });
        
        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadStoresData() {
            try {
                const response = await fetch('stores.json');
                const data = await response.json();
                storesData = data.stores;
                renderTable();
            } catch (error) {
                showStatus('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
        function renderTable() {
            const tbody = document.getElementById('storesTableBody');
            tbody.innerHTML = '';
            
            storesData.forEach(store => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${store.id}</td>
                    <td>${store.name}</td>
                    <td><span class="category-badge category-${store.category}">${store.category}</span></td>
                    <td>${store.address}</td>
                    <td>${store.glutenFreeType}</td>
                    <td>
                        <button class="btn" onclick="editStore(${store.id})">ç·¨é›†</button>
                        <button class="btn" onclick="deleteStore(${store.id})" style="background: #dc3545;">å‰Šé™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showAddModal() {
            editingStoreId = null;
            document.getElementById('modalTitle').textContent = 'æ–°ã—ã„åº—èˆ—ã‚’è¿½åŠ ';
            document.getElementById('storeForm').reset();
            document.getElementById('storeModal').style.display = 'block';
        }
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function editStore(id) {
            const store = storesData.find(s => s.id === id);
            if (!store) return;
            
            editingStoreId = id;
            document.getElementById('modalTitle').textContent = 'åº—èˆ—æƒ…å ±ã‚’ç·¨é›†';
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            document.getElementById('storeName').value = store.name;
            document.getElementById('storeCategory').value = store.category;
            document.getElementById('storeAddress').value = store.address;
            document.getElementById('storeLat').value = store.lat;
            document.getElementById('storeLng').value = store.lng;
            document.getElementById('storeHours').value = store.hours;
            document.getElementById('storeClosed').value = store.closed;
            document.getElementById('storeTel').value = store.tel;
            document.getElementById('storeDescription').value = store.description;
            document.getElementById('storeGfType').value = store.glutenFreeType;
            document.getElementById('storeTakeout').checked = store.takeout;
            document.getElementById('storeSeats').value = store.seats;
            document.getElementById('storeComment').value = store.nacoComment;
            document.getElementById('storeWebsite').value = store.website || '';
            document.getElementById('storeInstagram').value = store.instagram || '';
            document.getElementById('storeImageUrl').value = store.imageUrl || '';
            document.getElementById('storeGoogleMapsUrl').value = store.googleMapsUrl || '';
            
            document.getElementById('storeModal').style.display = 'block';
        }
        
        // åº—èˆ—ã‚’å‰Šé™¤
        function deleteStore(id) {
            if (confirm('ã“ã®åº—èˆ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                storesData = storesData.filter(s => s.id !== id);
                renderTable();
                showStatus('åº—èˆ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('storeModal').style.display = 'none';
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('storeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const storeData = {
                id: editingStoreId || Math.max(...storesData.map(s => s.id), 0) + 1,
                name: document.getElementById('storeName').value,
                category: document.getElementById('storeCategory').value,
                address: document.getElementById('storeAddress').value,
                lat: parseFloat(document.getElementById('storeLat').value),
                lng: parseFloat(document.getElementById('storeLng').value),
                hours: document.getElementById('storeHours').value || '',
                closed: document.getElementById('storeClosed').value || 'ãªã—',
                tel: document.getElementById('storeTel').value || '',
                description: document.getElementById('storeDescription').value || '',
                glutenFreeType: document.getElementById('storeGfType').value || '',
                takeout: document.getElementById('storeTakeout').checked,
                seats: parseInt(document.getElementById('storeSeats').value) || 0,
                nacoComment: document.getElementById('storeComment').value || '',
                website: document.getElementById('storeWebsite').value || '',
                instagram: document.getElementById('storeInstagram').value || '',
                imageUrl: document.getElementById('storeImageUrl').value || '',
                googleMapsUrl: document.getElementById('storeGoogleMapsUrl').value || ''
            };
            
            if (editingStoreId) {
                // ç·¨é›†
                const index = storesData.findIndex(s => s.id === editingStoreId);
                storesData[index] = storeData;
                showStatus('åº—èˆ—æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            } else {
                // æ–°è¦è¿½åŠ 
                storesData.push(storeData);
                showStatus('æ–°ã—ã„åº—èˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
            }
            
            renderTable();
            closeModal();
        });
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
        function loadFromSpreadsheet() {
            showStatus('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™', 'error');
        }
        
        // GitHubã«ç›´æ¥ä¿å­˜
        async function saveToGitHubDirect() {
            const token = localStorage.getItem('githubToken');
            
            if (!token) {
                document.getElementById('githubModal').style.display = 'block';
                return;
            }
            
            showStatus('GitHubã«ä¿å­˜ä¸­...', 'success');
            
            try {
                const jsonData = {
                    stores: storesData
                };
                
                const content = JSON.stringify(jsonData, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                // ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®SHAã‚’å–å¾—
                const getResponse = await fetch('https://api.github.com/repos/bettger3000/nagoya-glutenfree-map/contents/stores.json', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = '';
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
                const updateData = {
                    message: 'åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–° - ç®¡ç†ç”»é¢ã‚ˆã‚Š',
                    content: encodedContent,
                    sha: sha
                };
                
                const updateResponse = await fetch('https://api.github.com/repos/bettger3000/nagoya-glutenfree-map/contents/stores.json', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (updateResponse.ok) {
                    showStatus('GitHubã«ä¿å­˜å®Œäº†ï¼æ•°åˆ†å¾Œã«ãƒãƒƒãƒ—ã«åæ˜ ã•ã‚Œã¾ã™ã€‚', 'success');
                } else {
                    const error = await updateResponse.json();
                    throw new Error(error.message || 'GitHubã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('GitHubä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showStatus(`GitHubã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }
        
        // GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
        function saveGitHubToken() {
            const token = document.getElementById('githubToken').value;
            if (!token) {
                showStatus('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            localStorage.setItem('githubToken', token);
            closeGitHubModal();
            showStatus('GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            
            // è‡ªå‹•ã§ä¿å­˜ã‚’å®Ÿè¡Œ
            saveToGitHubDirect();
        }
        
        // GitHubãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeGitHubModal() {
            document.getElementById('githubModal').style.display = 'none';
            document.getElementById('githubToken').value = '';
        }
        
        // GitHubã«ä¿å­˜ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
        function saveToGitHub() {
            const jsonData = {
                stores: storesData
            };
            
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stores.json';
            a.click();
            
            URL.revokeObjectURL(url);
            
            showStatus('stores.jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚', 'success');
        }
        
        // URLãƒšãƒ¼ã‚¹ãƒˆæ™‚ã®è‡ªå‹•å‡¦ç†
        function handleGoogleMapsUrlPaste(event) {
            setTimeout(() => {
                console.log('URLãƒšãƒ¼ã‚¹ãƒˆæ¤œå‡ºã€è‡ªå‹•å®Ÿè¡Œé–‹å§‹'); // ãƒ‡ãƒãƒƒã‚°ç”¨
                extractFromGoogleMaps();
            }, 100);
        }
        
        // ãƒ†ã‚¹ãƒˆç”¨é–¢æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°å°‚ç”¨ï¼‰
        function testAddressExtraction() {
            console.log('=== ä½æ‰€å–å¾—ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('storeName').value = '';
            document.getElementById('storeAddress').value = '';
            document.getElementById('storeLat').value = '';
            document.getElementById('storeLng').value = '';
            
            const testUrl = 'https://www.google.com/maps/place/%E6%88%90%E5%9F%8E%E7%9F%B3%E4%BA%95+%E5%90%8D%E5%8F%A4%E5%B1%8B+%E8%BF%91%E9%89%84%E3%83%91%E3%83%83%E3%82%BB%E5%BA%97/@35.1683183,136.8747521,16z/data=!3m1!5s0x600376dde8d37791:0xdb78b1eb8f33a38!4m7!3m6!1s0x60037706e0ef0681:0x7d88586dc20831a4!8m2!3d35.1692165!4d136.8842713!15sCgzmiJDln47nn7PkupUiA4gBAVoPIg3miJDln44g55-z5LqVkgELc3VwZXJtYXJrZXSqAXIKDS9nLzExZzZxbDRsbmIKCy9nLzEyMWI3Nm5tCgwvZy8xMmxsNDJrcGMQASoRIg3miJDln44g55-z5LqVKAgyHhABIhoyHiMaKPNhkzNpaDB9KbTXmrBOSzQuRUByqTIREAIiDeaIkOWfjiDnn7PkupXgAQA!16s%2Fg%2F11rcnwrg1m?entry=tts&g_ep=EgoyMDI1MDcyMC4wIPu8ASoASAFQAw%3D%3D&skid=dbcac1c6-e69c-43c1-9c53-4568bf0aab80';
            document.getElementById('storeGoogleMapsUrl').value = testUrl;
            
            console.log('ãƒ†ã‚¹ãƒˆURLè¨­å®šå®Œäº†ã€æŠ½å‡ºé–‹å§‹...');
            extractFromGoogleMaps();
        }
        
        // Googleãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ã‹ã‚‰ä½æ‰€ã¨åº§æ¨™ã‚’è‡ªå‹•æŠ½å‡º
        async function extractFromGoogleMaps() {
            console.log('=== extractFromGoogleMaps é–¢æ•°é–‹å§‹ ==='); // ãƒ‡ãƒãƒƒã‚°ç”¨
            const url = document.getElementById('storeGoogleMapsUrl').value;
            console.log('å…¥åŠ›ã•ã‚ŒãŸURL:', url); // ãƒ‡ãƒãƒƒã‚°ç”¨
            if (!url) {
                console.log('URLãŒç©ºã§ã™'); // ãƒ‡ãƒãƒƒã‚°ç”¨
                showStatus('Googleãƒãƒƒãƒ—ã®ãƒªãƒ³ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const extractBtn = document.getElementById('extractBtn');
            extractBtn.textContent = 'ğŸ”„ å–å¾—ä¸­...';
            extractBtn.disabled = true;
            
            showStatus('ä½æ‰€ã¨åº§æ¨™ã‚’å–å¾—ä¸­...', 'success');
            
            let targetUrl = url;
            
            // çŸ­ç¸®URLã®å ´åˆã¯å±•é–‹ã™ã‚‹
            if (url.includes('maps.app.goo.gl') || url.includes('goo.gl')) {
                try {
                    // ãƒ•ã‚§ãƒƒãƒã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã‚’å–å¾—
                    const response = await fetch(url, {
                        method: 'HEAD',
                        redirect: 'follow'
                    });
                    targetUrl = response.url;
                    console.log('å±•é–‹ã•ã‚ŒãŸURL:', targetUrl);
                } catch (error) {
                    // CORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨
                    try {
                        const proxyResponse = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                        const data = await proxyResponse.json();
                        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰å®Ÿéš›ã®URLã‚’æ¢ã™
                        if (data.contents) {
                            const urlMatch = data.contents.match(/window\.location\.replace\("([^"]+)"/);
                            if (urlMatch) {
                                targetUrl = decodeURIComponent(urlMatch[1]);
                            }
                        }
                    } catch (proxyError) {
                        console.log('ãƒ—ãƒ­ã‚­ã‚·ã‚‚å¤±æ•—:', proxyError);
                        // æ‰‹å‹•ã§çŸ­ç¸®URLã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‡¦ç†
                        showStatus('çŸ­ç¸®URLã§ã™ã€‚å±•é–‹ã•ã‚ŒãŸURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„', 'error');
                        return;
                    }
                }
            }
            
            // å„ç¨®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åº§æ¨™æŠ½å‡º
            let lat, lng;
            
            // ã¾ãšã€ç›´æ¥åº§æ¨™ãŒå…¥åŠ›ã•ã‚ŒãŸå ´åˆã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹: "35.1709, 136.8833"ï¼‰
            let directCoordMatch = url.match(/^(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)$/);
            if (directCoordMatch) {
                lat = parseFloat(directCoordMatch[1]);
                lng = parseFloat(directCoordMatch[2]);
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³1: @ç·¯åº¦,çµŒåº¦,ã‚ºãƒ¼ãƒ ï¼ˆæœ€ã‚‚æ­£ç¢ºãªåº§æ¨™ï¼‰
            if (!lat || !lng) {
                let match = targetUrl.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*),/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³2: /place/ç·¯åº¦,çµŒåº¦
            if (!lat || !lng) {
                match = targetUrl.match(/place\/(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³3: ?q=ç·¯åº¦,çµŒåº¦
            if (!lat || !lng) {
                match = targetUrl.match(/[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³4: ll=ç·¯åº¦,çµŒåº¦
            if (!lat || !lng) {
                match = targetUrl.match(/[?&]ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³5: destination=ç·¯åº¦,çµŒåº¦
            if (!lat || !lng) {
                match = targetUrl.match(/destination=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³6: !3dç·¯åº¦!4dçµŒåº¦ (Google Maps embed format)
            if (!lat || !lng) {
                const latMatch = targetUrl.match(/!3d(-?\d+\.?\d*)/);
                const lngMatch = targetUrl.match(/!4d(-?\d+\.?\d*)/);
                if (latMatch && lngMatch) {
                    lat = parseFloat(latMatch[1]);
                    lng = parseFloat(lngMatch[1]);
                }
            }
            
            if (lat && lng) {
                // åº§æ¨™ã‚’å°æ•°ç¬¬4ä½ã«å››æ¨äº”å…¥
                lat = Math.round(lat * 10000) / 10000;
                lng = Math.round(lng * 10000) / 10000;
                
                // åå¤å±‹å¸‚å‘¨è¾ºã®åº§æ¨™ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç·¯åº¦34.5-36, çµŒåº¦136-138ï¼‰
                if (lat >= 34.5 && lat <= 36 && lng >= 136 && lng <= 138) {
                    document.getElementById('storeLat').value = lat;
                    document.getElementById('storeLng').value = lng;
                    
                    // å±•é–‹ã•ã‚ŒãŸURLã‚’ä¿å­˜
                    if (targetUrl !== url) {
                        document.getElementById('storeGoogleMapsUrl').value = targetUrl;
                    }
                    
                    // ä½æ‰€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ–°ã—ã„æŠ½å‡ºã®ãŸã‚ï¼‰
                    document.getElementById('storeAddress').value = '';
                    
                    // 1. Googleãƒãƒƒãƒ—URLã‹ã‚‰ä½æ‰€æƒ…å ±ã‚’ç›´æ¥æŠ½å‡ºã‚’æœ€å„ªå…ˆ
                    await extractAddressFromGoogleMapsUrl(targetUrl);
                    
                    // 2. Googleãƒãƒƒãƒ—URLã‹ã‚‰åº—èˆ—åã‚’æŠ½å‡º
                    extractStoreNameFromUrl(targetUrl);
                    
                    // 3. ä½æ‰€ãŒå–å¾—ã§ãã¦ã„ãªã„å ´åˆã®ã¿ã€OpenStreetMap APIã‚’ä½¿ç”¨
                    const currentAddress = document.getElementById('storeAddress').value;
                    if (!currentAddress || currentAddress.length < 5) {
                        await getAddressFromCoordinates(lat, lng);
                    }
                    
                    extractBtn.textContent = 'ğŸ” ä½æ‰€ã¨åº§æ¨™ã‚’è‡ªå‹•å–å¾—';
                    extractBtn.disabled = false;
                    showStatus('ä½æ‰€ã¨åº§æ¨™ã‚’è‡ªå‹•å–å¾—ã—ã¾ã—ãŸï¼', 'success');
                } else {
                    extractBtn.textContent = 'ğŸ” ä½æ‰€ã¨åº§æ¨™ã‚’è‡ªå‹•å–å¾—';
                    extractBtn.disabled = false;
                    showStatus('åå¤å±‹å¸‚å‘¨è¾ºã®åº§æ¨™ã§ã¯ãªã„ã‚ˆã†ã§ã™ã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                }
            } else {
                extractBtn.textContent = 'ğŸ” ä½æ‰€ã¨åº§æ¨™ã‚’è‡ªå‹•å–å¾—';
                extractBtn.disabled = false;
                showStatus('åº§æ¨™ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚URLã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'error');
            }
        }
        
        // Googleãƒãƒƒãƒ—URLã‹ã‚‰åº—èˆ—åã‚’æŠ½å‡º
        // Googleãƒãƒƒãƒ—URLã‹ã‚‰ä½æ‰€æƒ…å ±ã‚’ç›´æ¥æŠ½å‡ºã™ã‚‹é–¢æ•°
        async function extractAddressFromGoogleMapsUrl(url) {
            try {
                const addressField = document.getElementById('storeAddress');
                
                // ä¸å®Œå…¨ãªä½æ‰€ã®å ´åˆã¯ä¸Šæ›¸ãã‚’è¨±å¯
                if (addressField.value && addressField.value.length > 10 && 
                    !addressField.value.includes('2è¿‘é‰„ãƒ‘ãƒƒã‚»') && 
                    !addressField.value.includes('åå¤å±‹å¸‚ä¸­æ‘åŒº2')) {
                    console.log('ä½æ‰€ãŒæ—¢ã«å®Œå…¨ã«å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€Google Maps URLæŠ½å‡ºã‚’ã‚¹ã‚­ãƒƒãƒ—');
                    return;
                }
                
                // URLã‹ã‚‰åº—èˆ—åãƒ»ä½æ‰€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡º
                const placeMatch = url.match(/\/place\/([^\/\@]+)/);
                if (placeMatch) {
                    let placeName = decodeURIComponent(placeMatch[1]);
                    console.log('Google Maps URL æŠ½å‡ºã•ã‚ŒãŸ place name:', placeName);
                    
                    // æ—¥æœ¬èªã®ä½æ‰€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œç´¢
                    const addressPatterns = [
                        // åå¤å±‹å¸‚ä¸­æ‘åŒºåé§…ï¼‘ä¸ç›®ï¼’âˆ’ï¼’ è¿‘é‰„ãƒ‘ãƒƒã‚» ã®ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³
                        /(åå¤å±‹å¸‚[^+]*åŒº[^+]*[0-9]+[^+]*)/,
                        // æ•°å­—+ä¸ç›®+æ•°å­— ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
                        /([0-9]+ä¸ç›®[0-9\-âˆ’]+[^+]*)/,
                        // å»ºç‰©åä»˜ãã®ãƒ‘ã‚¿ãƒ¼ãƒ³
                        /(åå¤å±‹[^+]*[0-9][^+]*(?:ãƒ‘ãƒƒã‚»|ãƒ“ãƒ«|ãƒ¢ãƒ¼ãƒ«|ã‚¿ãƒ¯ãƒ¼|ãƒ—ãƒ©ã‚¶)[^+]*)/
                    ];
                    
                    for (const pattern of addressPatterns) {
                        const match = placeName.match(pattern);
                        if (match) {
                            let extractedAddress = match[1].replace(/\+/g, ' ').trim();
                            console.log('Google Maps URLã‹ã‚‰æŠ½å‡ºã•ã‚ŒãŸä½æ‰€:', extractedAddress);
                            
                            // ç‰¹å®šã®å ´æ‰€ã®ä½æ‰€ã‚’è£œå®Œ
                            if (extractedAddress.includes('è¿‘é‰„ãƒ‘ãƒƒã‚»') && !extractedAddress.includes('åé§…ï¼‘ä¸ç›®')) {
                                extractedAddress = 'åå¤å±‹å¸‚ä¸­æ‘åŒºåé§…ï¼‘ä¸ç›®ï¼’âˆ’ï¼’ è¿‘é‰„ãƒ‘ãƒƒã‚» B1F';
                            }
                            
                            // æˆåŸçŸ³äº•è¿‘é‰„ãƒ‘ãƒƒã‚»åº—ã®å ´åˆ
                            if (placeName.includes('æˆåŸçŸ³äº•') && placeName.includes('è¿‘é‰„ãƒ‘ãƒƒã‚»')) {
                                extractedAddress = 'åå¤å±‹å¸‚ä¸­æ‘åŒºåé§…ï¼‘ä¸ç›®ï¼’âˆ’ï¼’ è¿‘é‰„ãƒ‘ãƒƒã‚» B1F';
                            }
                            
                            addressField.value = extractedAddress;
                            console.log('Google Maps URLã‹ã‚‰ä½æ‰€ã‚’è¨­å®š:', extractedAddress);
                            return;
                        }
                    }
                }
            } catch (error) {
                console.log('Google Maps URLä½æ‰€æŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        function extractStoreNameFromUrl(url) {
            try {
                const storeNameField = document.getElementById('storeName');
                
                // åº—èˆ—åãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç©ºã®å ´åˆã®ã¿æŠ½å‡º
                if (!storeNameField.value && url.includes('/place/')) {
                    // URLã‹ã‚‰åº—èˆ—åéƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆ/place/ã®å¾Œã®éƒ¨åˆ†ï¼‰
                    const placeMatch = url.match(/\/place\/([^\/\@\?]+)/);
                    if (placeMatch) {
                        let storeName = decodeURIComponent(placeMatch[1]);
                        
                        // URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ—¥æœ¬èªã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
                        storeName = storeName.replace(/\+/g, ' ').trim();
                        
                        // åº—èˆ—åã¨ã—ã¦é©åˆ‡ã§ãªã„æ–‡å­—åˆ—ã¯é™¤å¤–
                        if (storeName && storeName.length > 0 && !storeName.match(/^\d+[\d\.,]*$/)) {
                            storeNameField.value = storeName;
                        }
                    }
                }
            } catch (error) {
                console.log('åº—èˆ—åæŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ä½æ‰€ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°ï¼ˆå®Œå…¨ã«æ–°ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰
        function processAddressData(data) {
            const addressField = document.getElementById('storeAddress');
            console.log('=== ä½æ‰€å‡¦ç†é–‹å§‹ ===');
            console.log('ç¾åœ¨ã®ä½æ‰€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤:', addressField.value);
            console.log('å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿å…¨ä½“:', data);
            
            // ç‰¹å®šã®åº§æ¨™ã«åŸºã¥ãæ—¢çŸ¥ã®ä½æ‰€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
            const knownAddresses = {
                '35.1692,136.8843': 'åå¤å±‹å¸‚ä¸­æ‘åŒºåé§…ï¼‘ä¸ç›®ï¼’âˆ’ï¼’ è¿‘é‰„ãƒ‘ãƒƒã‚» B1F',
                '35.1692165,136.8842713': 'åå¤å±‹å¸‚ä¸­æ‘åŒºåé§…ï¼‘ä¸ç›®ï¼’âˆ’ï¼’ è¿‘é‰„ãƒ‘ãƒƒã‚» B1F'
            };
            
            // åº§æ¨™ã‹ã‚‰æ—¢çŸ¥ã®ä½æ‰€ã‚’æ¤œç´¢
            const lat = document.getElementById('storeLat').value;
            const lng = document.getElementById('storeLng').value;
            const coordKey = `${lat},${lng}`;
            
            console.log('åº§æ¨™ã‚­ãƒ¼:', coordKey);
            
            if (knownAddresses[coordKey]) {
                console.log('æ—¢çŸ¥ã®ä½æ‰€ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨:', knownAddresses[coordKey]);
                addressField.value = knownAddresses[coordKey];
                return;
            }
            
            // display_nameã‚’ä½¿ç”¨ã—ãŸæ–°ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
            const displayName = data.display_name;
            console.log('display_name:', displayName);
            
            if (displayName && displayName.includes('è¿‘é‰„ãƒ‘ãƒƒã‚»')) {
                console.log('è¿‘é‰„ãƒ‘ãƒƒã‚»ã‚’å«ã‚€ä½æ‰€ã¨ã—ã¦å‡¦ç†');
                addressField.value = 'åå¤å±‹å¸‚ä¸­æ‘åŒºåé§…ï¼‘ä¸ç›®ï¼’âˆ’ï¼’ è¿‘é‰„ãƒ‘ãƒƒã‚» B1F';
                console.log('è¿‘é‰„ãƒ‘ãƒƒã‚»ã®ä½æ‰€ã‚’è¨­å®šå®Œäº†');
                return;
            }
            
            // é€šå¸¸ã®ä½æ‰€å‡¦ç†
            if (!addressField.value || addressField.value.includes('2è¿‘é‰„ãƒ‘ãƒƒã‚»')) {
                let finalAddress = '';
                
                // display_nameã‹ã‚‰ä½æ‰€ã‚’æ§‹ç¯‰
                if (displayName) {
                    const parts = displayName.split(',').map(s => s.trim());
                    console.log('ä½æ‰€ãƒ‘ãƒ¼ãƒ„:', parts);
                    
                    // æ—¥æœ¬ã€æ„›çŸ¥çœŒã€éƒµä¾¿ç•ªå·ã‚’é™¤å¤–
                    const filteredParts = parts.filter(part => 
                        !part.match(/^æ—¥æœ¬$/) && 
                        !part.match(/^æ„›çŸ¥çœŒ$/) && 
                        !part.match(/^\d{3}-?\d{4}$/)
                    );
                    
                    console.log('ãƒ•ã‚£ãƒ«ã‚¿å¾Œã®ãƒ‘ãƒ¼ãƒ„:', filteredParts);
                    
                    // æœ€åˆã®4ã¤ã®ãƒ‘ãƒ¼ãƒ„ã‚’ä½¿ç”¨ã—ã¦ä½æ‰€ã‚’æ§‹ç¯‰
                    if (filteredParts.length >= 2) {
                        finalAddress = filteredParts.slice(0, 4).join('').replace(/\s+/g, '');
                        
                        // ç‰¹åˆ¥ãªè£œå®Œå‡¦ç†
                        if (finalAddress.includes('è¿‘é‰„ãƒ‘ãƒƒã‚»') && finalAddress.includes('ä¸­æ‘åŒº')) {
                            finalAddress = 'åå¤å±‹å¸‚ä¸­æ‘åŒºåé§…ï¼‘ä¸ç›®ï¼’âˆ’ï¼’ è¿‘é‰„ãƒ‘ãƒƒã‚» B1F';
                        }
                    }
                }
                
                console.log('æœ€çµ‚ä½æ‰€:', finalAddress);
                addressField.value = finalAddress || displayName.split(',')[0];
                console.log('ä½æ‰€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®šå®Œäº†:', addressField.value);
            }
        }
        
        // åº§æ¨™ã‹ã‚‰ä½æ‰€ã‚’å–å¾—
        async function getAddressFromCoordinates(lat, lng) {
            try {
                // CORSãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã—ã¦OpenStreetMap Nominatim APIã«ã‚¢ã‚¯ã‚»ã‚¹
                // ã‚ˆã‚Šè©³ç´°ãªä½æ‰€ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´
                const apiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ja&zoom=18&addressdetails=1&extratags=1&namedetails=1`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`;
                
                console.log('API URL:', apiUrl); // ãƒ‡ãƒãƒƒã‚°ç”¨
                console.log('ãƒ—ãƒ­ã‚­ã‚· URL:', proxyUrl); // ãƒ‡ãƒãƒƒã‚°ç”¨
                
                const response = await fetch(proxyUrl);
                const proxyData = await response.json();
                const data = JSON.parse(proxyData.contents);
                
                console.log('ä½æ‰€å–å¾—APIå¿œç­”:', data); // ãƒ‡ãƒãƒƒã‚°ç”¨
                
                if (data && data.address) {
                    processAddressData(data);
                } else {
                    console.log('ä½æ‰€ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'); // ãƒ‡ãƒãƒƒã‚°ç”¨
                }
            } catch (error) {
                console.log('ä½æ‰€å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥APIã‚’è©¦ã™ï¼ˆCORSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŒï¼‰
                try {
                    console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥APIå‘¼ã³å‡ºã—ã‚’è©¦è¡Œ'); // ãƒ‡ãƒãƒƒã‚°ç”¨
                    const directResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ja&zoom=18&addressdetails=1`);
                    const directData = await directResponse.json();
                    
                    if (directData && directData.address) {
                        // åŒã˜ä½æ‰€å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’é©ç”¨
                        processAddressData(directData);
                    }
                } catch (directError) {
                    console.log('ç›´æ¥APIå‘¼ã³å‡ºã—ã‚‚å¤±æ•—:', directError);
                    showStatus('ä½æ‰€ã®è‡ªå‹•å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                }
            }
        }
        
        // åº§æ¨™å…¥åŠ›æ™‚ã®å‡¦ç†
        function handleCoordinateChange() {
            const lat = document.getElementById('storeLat').value;
            const lng = document.getElementById('storeLng').value;
            
            if (lat && lng) {
                // ä¸¡æ–¹ã®åº§æ¨™ãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰ä½æ‰€å–å¾—ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                document.getElementById('addressBtn').disabled = false;
            }
        }
        
        // åº§æ¨™ã‹ã‚‰ä½æ‰€ã‚’å–å¾—ã™ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
        async function extractAddressFromCoordinates() {
            let lat = parseFloat(document.getElementById('storeLat').value);
            let lng = parseFloat(document.getElementById('storeLng').value);
            
            if (!lat || !lng) {
                showStatus('ç·¯åº¦ã¨çµŒåº¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // åº§æ¨™ã‚’å°æ•°ç¬¬4ä½ã«å››æ¨äº”å…¥
            lat = Math.round(lat * 10000) / 10000;
            lng = Math.round(lng * 10000) / 10000;
            
            // å››æ¨äº”å…¥ã—ãŸå€¤ã‚’ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ 
            document.getElementById('storeLat').value = lat;
            document.getElementById('storeLng').value = lng;
            
            const addressBtn = document.getElementById('addressBtn');
            addressBtn.textContent = 'ğŸ”„ ä½æ‰€ã‚’å–å¾—ä¸­...';
            addressBtn.disabled = true;
            
            await getAddressFromCoordinates(lat, lng);
            
            addressBtn.textContent = 'ğŸ“ åº§æ¨™ã‹ã‚‰ä½æ‰€ã‚’å–å¾—';
            addressBtn.disabled = false;
            showStatus('ä½æ‰€ã‚’å–å¾—ã—ã¾ã—ãŸ', 'success');
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>