<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢ - ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #ffb6c1 0%, #98d8c8 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #4a4a4a;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .btn {
            background: linear-gradient(135deg, #ffb6c1 0%, #98d8c8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: linear-gradient(135deg, #ffb6c1 0%, #98d8c8 100%);
            color: white;
            font-weight: bold;
        }
        
        .category-badge {
            padding: 4px 12px;
            border-radius: 12px;
            color: white;
            font-size: 12px;
        }
        
        .category-å’Œé£Ÿ { background-color: #ff6b6b; }
        .category-æ´‹é£Ÿ { background-color: #4ecdc4; }
        .category-ã‚«ãƒ•ã‚§ { background-color: #f7b731; }
        .category-ãƒ‘ãƒ³å±‹ { background-color: #5f27cd; }
        .category-è²©å£²åº— { background-color: #00d2d3; }
        .category-ã‚¹ã‚¤ãƒ¼ãƒ„ { background-color: #ff69b4; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            max-height: 90vh;
            margin: 50px auto;
            padding: 30px;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a4a4a;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #98d8c8;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        #extractBtn {
            margin-top: 8px;
            background: #4CAF50;
            color: white;
            border: none;
            font-weight: bold;
        }
        
        #extractBtn:hover:not(:disabled) {
            background: #45a049;
        }
        
        .template-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .template-buttons .btn {
            flex: 1;
            min-width: 150px;
            font-size: 14px;
        }
        
        /* ç¾åœ¨ã®è¨­å®šè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .current-config {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin: 20px 0;
            padding: 0;
            overflow: hidden;
        }
        
        .config-header {
            background: linear-gradient(135deg, #98d8c8 0%, #ffb6c1 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .config-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .btn-small {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-small:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .config-content {
            padding: 20px;
        }
        
        .config-item {
            margin-bottom: 15px;
        }
        
        .config-item label {
            display: block;
            font-weight: bold;
            color: #4a4a4a;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .config-value {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            font-size: 14px;
            word-break: break-all;
            color: #666;
        }
        
        .config-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .config-actions .btn {
            flex: 1;
            min-width: 120px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ° ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—ç®¡ç†ç”»é¢</h1>
            <p>åº—èˆ—æƒ…å ±ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãŒã§ãã¾ã™</p>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="showAddModal()">â• æ–°ã—ã„åº—èˆ—ã‚’è¿½åŠ </button>
            <button class="btn" onclick="loadFromSpreadsheet()">ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿</button>
            <button class="btn" onclick="showCSVUploadModal()" style="background-color: #4caf50; color: white;">ğŸ“¤ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            <button class="btn" onclick="loadFromSpreadsheetReplace()" style="background-color: #ff9800; color: white;">âš ï¸ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ç½®ãæ›ãˆ</button>
            <button class="btn" onclick="showSpreadsheetSettings()">âš™ï¸ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®š</button>
            <button class="btn" onclick="showVisitStatusModal()" style="background-color: #9c27b0; color: white;">ğŸ† è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†</button>
            <button class="btn btn-success" onclick="saveToGitHubDirect()">ğŸš€ GitHubã«ç›´æ¥ä¿å­˜</button>
            <button class="btn" onclick="saveToGitHub()">ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button class="btn" onclick="reloadStoresData()">ğŸ”„ æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿</button>
        </div>
        
        <!-- ç¾åœ¨ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šè¡¨ç¤º -->
        <div id="currentSpreadsheetInfo" class="current-config" style="display: none;">
            <div class="config-header">
                <h3>ğŸ“‹ ç¾åœ¨ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®š</h3>
                <button class="btn-small" onclick="toggleSpreadsheetInfo()">éè¡¨ç¤º</button>
            </div>
            <div class="config-content">
                <div class="config-item">
                    <label>è¨­å®šæ¸ˆã¿URL:</label>
                    <div id="currentUrl" class="config-value"></div>
                </div>
                <div class="config-item">
                    <label>ã‚·ãƒ¼ãƒˆå:</label>
                    <div id="currentSheet" class="config-value"></div>
                </div>
                <div class="config-actions">
                    <button class="btn" onclick="testCurrentConnection()">ğŸ” æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                    <button class="btn" onclick="showSpreadsheetSettings()">âœï¸ è¨­å®šå¤‰æ›´</button>
                    <button class="btn" onclick="clearSpreadsheetSettings()" style="background: #dc3545;">ğŸ—‘ï¸ è¨­å®šå‰Šé™¤</button>
                </div>
            </div>
        </div>
        
        <!-- GitHubè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="githubModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeGitHubModal()">&times;</span>
                <h2>GitHubè¨­å®š</h2>
                <p>åˆå›ã®ã¿è¨­å®šãŒå¿…è¦ã§ã™ã€‚Personal Access Tokenã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                
                <div class="form-group">
                    <label>GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                    <div class="help-text">
                        <strong>å–å¾—æ–¹æ³•:</strong><br>
                        1. GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens â†’ Tokens (classic)<br>
                        2. ã€ŒGenerate new tokenã€â†’ã€ŒGenerate new token (classic)ã€<br>
                        3. ã€ŒContentsã€æ¨©é™ã‚’é¸æŠ<br>
                        4. ç”Ÿæˆã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ”ãƒ¼
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="saveGitHubToken()">ä¿å­˜</button>
                <button class="btn" onclick="closeGitHubModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
        
        <!-- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="spreadsheetModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeSpreadsheetModal()">&times;</span>
                <h2>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºè¨­å®š</h2>
                <p>Google Sheetsã‹ã‚‰åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚</p>
                
                <div class="form-group">
                    <label>Google Sheets URL</label>
                    <input type="url" id="spreadsheetUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
                    <div class="help-text">
                        <strong>ğŸ”§ è¨­å®šæ–¹æ³•:</strong><br>
                        <strong>1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å…±æœ‰å¯èƒ½ã«ã™ã‚‹</strong><br>
                        â€¢ Google Sheetsã®ã€Œå…±æœ‰ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
                        â€¢ ã€Œä¸€èˆ¬çš„ãªã‚¢ã‚¯ã‚»ã‚¹ã€ã‚’ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ã€ã«å¤‰æ›´<br>
                        â€¢ æ¨©é™ã¯ã€Œé–²è¦§è€…ã€ã§OK<br><br>
                        
                        <strong>2. URLã‚’ã‚³ãƒ”ãƒ¼</strong><br>
                        â€¢ å…±æœ‰ç”»é¢ã§URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä¸Šè¨˜æ¬„ã«è²¼ã‚Šä»˜ã‘<br>
                        â€¢ ä¾‹: https://docs.google.com/spreadsheets/d/.../edit?usp=sharing<br><br>
                        
                        <strong>ğŸ“‹ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å½¢å¼:</strong><br>
                        â€¢ 1è¡Œç›®ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå¿…é ˆåˆ—ï¼‰<br>
                        â€¢ åˆ—é †ï¼šåº—èˆ—å, ã‚«ãƒ†ã‚´ãƒªãƒ¼, ä½æ‰€, ç·¯åº¦, çµŒåº¦, å–¶æ¥­æ™‚é–“, å®šä¼‘æ—¥, é›»è©±ç•ªå·, åº—èˆ—èª¬æ˜, GFå¯¾å¿œ, ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ, å¸­æ•°, nacoã‚³ãƒ¡ãƒ³ãƒˆ, nacoè¨ªå•æ¸ˆã¿(æ—§), <strong style="color: #9c27b0;">è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</strong>, <strong style="color: #9c27b0;">ç¢ºèªè€…</strong>, <strong style="color: #9c27b0;">æœ€çµ‚æ›´æ–°</strong>, ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ, Instagram, ãƒ¡ã‚¤ãƒ³ç”»åƒURL, è¿½åŠ ç”»åƒURL1, è¿½åŠ ç”»åƒURL2, Googleãƒãƒƒãƒ—URL<br>
                        â€¢ 2è¡Œç›®ä»¥é™ï¼šåº—èˆ—ãƒ‡ãƒ¼ã‚¿<br>
                        <br>
                        <strong>ğŸ†• è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã¤ã„ã¦:</strong><br>
                        â€¢ <strong>è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ—:</strong> "naco", "member", "unvisited" ã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›<br>
                        â€¢ <strong>ç¢ºèªè€…åˆ—:</strong> ç¢ºèªã—ãŸäººã®åå‰ã‚’å…¥åŠ›<br>
                        â€¢ <strong>æœ€çµ‚æ›´æ–°åˆ—:</strong> YYYY-MM å½¢å¼ã§å…¥åŠ›ï¼ˆä¾‹: 2024-12ï¼‰<br><br>
                        
                        <strong>âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆ:</strong><br>
                        ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€â†’ã€Œå…±æœ‰ã€â†’ã€Œã‚¦ã‚§ãƒ–ã«å…¬é–‹ã€ã‚’è©¦ã—ã¦ãã ã•ã„
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ã‚·ãƒ¼ãƒˆåï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                    <input type="text" id="sheetName" placeholder="ã‚·ãƒ¼ãƒˆ1" value="ã‚·ãƒ¼ãƒˆ1">
                    <div class="help-text">
                        èª­ã¿è¾¼ã¿ãŸã„ã‚·ãƒ¼ãƒˆã®åå‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šã‚·ãƒ¼ãƒˆ1ï¼‰
                    </div>
                </div>
                
                <div class="form-group">
                    <h3>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆ—æ§‹æˆ</h3>
                    <div class="help-text">
                        <strong>ğŸ“‹ ç°¡å˜4ã‚¹ãƒ†ãƒƒãƒ—ã§ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼š</strong><br>
                        1ï¸âƒ£ ä¸‹ã®ãƒœã‚¿ãƒ³ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰<br>
                        2ï¸âƒ£ Google Sheetsã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†<br>
                        3ï¸âƒ£ <strong style="color: #9c27b0;">é¸æŠé …ç›®ã«ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¨­å®šï¼ˆæ¨å¥¨ï¼‰</strong><br>
                        4ï¸âƒ£ ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€â†’ã€Œå…±æœ‰ã€â†’ã€Œã‚¦ã‚§ãƒ–ã«å…¬é–‹ã€ã§CSVå½¢å¼ã§å…¬é–‹<br><br>
                        
                        <strong>ğŸ“ é‡è¦ï¼šãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã¯3è¡Œç›®ã‹ã‚‰</strong><br>
                        â€¢ 1è¡Œç›®ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆåˆ—åï¼‰<br>
                        â€¢ 2è¡Œç›®ï¼šå…¥åŠ›æŒ‡ç¤ºãƒ»é¸æŠè‚¢<br>
                        â€¢ <strong style="color: #9c27b0;">3è¡Œç›®ä»¥é™ï¼šå®Ÿéš›ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿</strong><br><br>
                        
                        <strong>ğŸ¯ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¨­å®šæ–¹æ³•ï¼ˆGoogle Sheetsï¼‰ï¼š</strong><br>
                        â€¢ åˆ—ã‚’é¸æŠ â†’ ã€Œãƒ‡ãƒ¼ã‚¿ã€â†’ã€Œãƒ‡ãƒ¼ã‚¿ã®å…¥åŠ›è¦å‰‡ã€<br>
                        â€¢ ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ—ï¼šå’Œé£Ÿ,æ´‹é£Ÿ,ä¸­è¯,ã‚¤ã‚¿ãƒªã‚¢ãƒ³,ãƒ•ãƒ¬ãƒ³ãƒ,ã‚«ãƒ•ã‚§,ãƒ‡ã‚¶ãƒ¼ãƒˆ,ãƒ™ãƒ¼ã‚«ãƒªãƒ¼,ãã®ä»–<br>
                        â€¢ GFå¯¾å¿œåˆ—ï¼šå®Œå…¨GF,éƒ¨åˆ†GF<br>
                        â€¢ ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆåˆ—ï¼šTRUE,FALSE<br>
                        â€¢ è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ—ï¼šnaco,member,unvisited<br><br>
                        
                        <strong>ğŸ“ åº§æ¨™å–å¾—ã®å„ªå…ˆé †ä½ï¼š</strong><br>
                        â€¢ <strong style="color: #d32f2f;">æœ€å„ªå…ˆï¼š</strong> ç·¯åº¦ãƒ»çµŒåº¦åˆ—ã«æ‰‹å…¥åŠ›ã—ãŸåº§æ¨™<br>
                        â€¢ <strong style="color: #f57c00;">æ¬¡å„ªå…ˆï¼š</strong> Googleãƒãƒƒãƒ—URLåˆ—ã‹ã‚‰è‡ªå‹•æŠ½å‡º<br>
                        â€¢ <strong style="color: #616161;">æœ€å¾Œï¼š</strong> ä½æ‰€ã‹ã‚‰ã®ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆç®¡ç†ç”»é¢ã§æ‰‹å‹•å®Ÿè¡Œï¼‰<br>
                        â€¢ åº—åãƒ»ä½æ‰€ã¯æ‰‹å…¥åŠ›å¿…é ˆã€åº§æ¨™ã¯Googleãƒãƒƒãƒ—ã‹ã‚‰å–å¾—æ¨å¥¨<br><br>
                        
                        <strong>å¿…è¦ãªåˆ—ï¼ˆã“ã®é †ç•ªã§é…ç½®ã—ã¦ãã ã•ã„ï¼‰:</strong><br>
                        Aåˆ—: åº—èˆ—å, Båˆ—: ã‚«ãƒ†ã‚´ãƒªãƒ¼, Cåˆ—: ä½æ‰€, Dåˆ—: ç·¯åº¦, Eåˆ—: çµŒåº¦<br>
                        Fåˆ—: å–¶æ¥­æ™‚é–“, Gåˆ—: å®šä¼‘æ—¥, Håˆ—: é›»è©±ç•ªå·, Iåˆ—: åº—èˆ—èª¬æ˜<br>
                        Jåˆ—: GFå¯¾å¿œ, Kåˆ—: ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ, Låˆ—: å¸­æ•°, Måˆ—: nacoã‚³ãƒ¡ãƒ³ãƒˆ<br>
                        Nåˆ—: ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ, Oåˆ—: Instagram, Påˆ—: ãƒ¡ã‚¤ãƒ³ç”»åƒURL<br>
                        Qåˆ—: è¿½åŠ ç”»åƒURL1, Råˆ—: è¿½åŠ ç”»åƒURL2, Såˆ—: Googleãƒãƒƒãƒ—URL<br><br>
                        
                        <strong>ğŸ’¡ æ–‡å­—åŒ–ã‘ã™ã‚‹å ´åˆï¼š</strong><br>
                        â€¢ Macï¼šCSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆæ¨å¥¨ï¼‰ã‚’ä½¿ç”¨<br>
                        â€¢ Windows Excelï¼šExcelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨<br>
                        â€¢ Google Sheetsï¼šã©ã¡ã‚‰ã§ã‚‚æ­£å¸¸ã«å‹•ä½œ<br><br>
                        
                        <strong>æ³¨æ„:</strong> 1è¡Œç›®ã¯åˆ—åã€2è¡Œç›®ã‹ã‚‰å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="saveSpreadsheetSettings()">è¨­å®šã‚’ä¿å­˜</button>
                <button class="btn" onclick="testSpreadsheetConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                <div class="template-buttons">
                    <button class="btn" onclick="createSpreadsheetTemplate()">ğŸ“Š CSV ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆæ¨å¥¨ï¼‰</button>
                    <button class="btn" onclick="createExcelTemplate()">ğŸ“ˆ Excel ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
                </div>
                <button class="btn" onclick="closeSpreadsheetModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>

        <!-- CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="csvUploadModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeCSVUploadModal()">&times;</span>
                <h2>ğŸ“¤ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚</p>
                
                <div class="form-group">
                    <label>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                    <div style="border: 2px dashed #98d8c8; border-radius: 10px; padding: 20px; text-align: center; margin: 15px 0;">
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVFileSelect(event)">
                        <div id="dropZone" onclick="document.getElementById('csvFileInput').click()" style="cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #98d8c8; margin-bottom: 10px;"></i>
                            <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</strong> ã¾ãŸã¯ ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                            <p style="font-size: 12px; color: #666;">å¯¾å¿œå½¢å¼: .csv</p>
                        </div>
                    </div>
                    <div id="selectedFileName" style="margin-top: 10px; font-weight: bold; color: #98d8c8;"></div>
                </div>
                
                <div class="form-group">
                    <h3>ã‚¤ãƒ³ãƒãƒ¼ãƒˆè¨­å®š</h3>
                    <label>
                        <input type="radio" name="csvImportMode" value="add" checked>
                        ğŸ“ è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«æ–°ã—ã„åº—èˆ—ã‚’è¿½åŠ ï¼‰
                    </label>
                    <br>
                    <label style="margin-top: 10px;">
                        <input type="radio" name="csvImportMode" value="replace">
                        ğŸ”„ ç½®ãæ›ãˆãƒ¢ãƒ¼ãƒ‰ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ç½®ãæ›ãˆï¼‰
                    </label>
                </div>
                
                <div class="form-group">
                    <h3>ğŸ“‹ CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼</h3>
                    <div class="help-text">
                        <strong>é‡è¦ï¼š</strong><br>
                        â€¢ 1è¡Œç›®ï¼šåˆ—åï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰<br>
                        â€¢ 2è¡Œç›®ï¼šå…¥åŠ›æŒ‡ç¤ºï¼ˆã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ï¼‰<br>
                        â€¢ <strong style="color: #9c27b0;">3è¡Œç›®ä»¥é™ï¼šå®Ÿéš›ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿</strong><br><br>
                        
                        <strong>å¿…é ˆåˆ—ï¼š</strong> åº—èˆ—å, ã‚«ãƒ†ã‚´ãƒªãƒ¼, ä½æ‰€<br>
                        <strong>æ¨å¥¨ï¼š</strong> ç®¡ç†ç”»é¢ã®ã€ŒğŸ“Š CSV ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€ã‚’ä½¿ç”¨
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="importCSVFile()" id="csvImportBtn" disabled>
                        <i class="fas fa-upload"></i> ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
                    </button>
                    <button class="btn" onclick="createSpreadsheetTemplate()">ğŸ“Š CSV ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <button class="btn" onclick="closeCSVUploadModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
                
                <div id="csvPreview" style="margin-top: 20px; display: none;">
                    <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€åˆã®3è¡Œï¼‰</h3>
                    <div id="csvPreviewContent" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
        
        <div id="status" class="status"></div>
        
        <div class="table-container">
            <table id="storesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>åº—èˆ—å</th>
                        <th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
                        <th>ä½æ‰€</th>
                        <th>GFå¯¾å¿œ</th>
                        <th>è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="storesTableBody">
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- åº—èˆ—è¿½åŠ ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="storeModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">æ–°ã—ã„åº—èˆ—ã‚’è¿½åŠ </h2>
            
            <form id="storeForm">
                <div class="form-group">
                    <label>åº—èˆ—å</label>
                    <input type="text" id="storeName">
                </div>
                
                <div class="form-group">
                    <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                    <select id="storeCategory">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="å’Œé£Ÿ">å’Œé£Ÿ</option>
                        <option value="æ´‹é£Ÿ">æ´‹é£Ÿ</option>
                        <option value="ã‚«ãƒ•ã‚§">ã‚«ãƒ•ã‚§</option>
                        <option value="ãƒ‘ãƒ³å±‹">ãƒ‘ãƒ³å±‹</option>
                        <option value="è²©å£²åº—">è²©å£²åº—</option>
                        <option value="ã‚¹ã‚¤ãƒ¼ãƒ„">ã‚¹ã‚¤ãƒ¼ãƒ„</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ä½æ‰€</label>
                    <input type="text" id="storeAddress">
                </div>
                
                <div class="form-group">
                    <label>Googleãƒãƒƒãƒ—ãƒªãƒ³ã‚¯</label>
                    <input type="url" id="storeGoogleMapsUrl" placeholder="https://www.google.com/maps/place/..." onpaste="handleGoogleMapsUrlPaste(event)">
                    <button type="button" class="btn" onclick="extractFromGoogleMaps()" id="extractBtn">ğŸ” ä½æ‰€ã¨åº§æ¨™ã‚’è‡ªå‹•å–å¾—</button>
                    <div class="help-text">
                        ğŸ“± <strong>åº§æ¨™å–å¾—æ–¹æ³•ï¼ˆæ¨å¥¨é †ï¼‰:</strong><br>
                        1. <strong style="color: #2e7d32;">Plus Codeæ–¹å¼ï¼ˆæœ€é«˜ç²¾åº¦ï¼‰:</strong> Googleãƒãƒƒãƒ—ã§åº—èˆ—ã‚’æ¤œç´¢â†’å…±æœ‰â†’Plus Codeã‚’ã‚³ãƒ”ãƒ¼<br>
                        2. <strong style="color: #d32f2f;">ç›´æ¥åº§æ¨™æ–¹å¼:</strong> åº—èˆ—ãƒ”ãƒ³ã®ä¸Šã§å³ã‚¯ãƒªãƒƒã‚¯â†’ã€Œã“ã®å ´æ‰€ã«ã¤ã„ã¦ã€â†’åº§æ¨™ã‚’ã‚³ãƒ”ãƒ¼<br>
                        3. <strong>é€šå¸¸ã®ãƒªãƒ³ã‚¯æ–¹å¼:</strong> å…±æœ‰ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼<br>
                        â€» Plus Codeï¼ˆä¾‹: 8Q7X5R3J+23ï¼‰ã‚’å«ã‚€URLã¯æœ€ã‚‚æ­£ç¢ºãªä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã™
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ç·¯åº¦</label>
                    <input type="number" id="storeLat" step="0.0001" placeholder="ä¾‹: 35.1709" onchange="handleCoordinateChange()">
                    <div class="help-text">
                        ğŸ“ Googleãƒãƒƒãƒ—ã§å³ã‚¯ãƒªãƒƒã‚¯â†’ã€Œã“ã®å ´æ‰€ã«ã¤ã„ã¦ã€ã§å–å¾—ã—ãŸåº§æ¨™ã‚’å…¥åŠ›å¯èƒ½
                    </div>
                </div>
                
                <div class="form-group">
                    <label>çµŒåº¦</label>
                    <input type="number" id="storeLng" step="0.0001" placeholder="ä¾‹: 136.8833" onchange="handleCoordinateChange()">
                </div>
                
                <div class="form-group">
                    <button type="button" class="btn" onclick="extractAddressFromCoordinates()" id="addressBtn">ğŸ“ åº§æ¨™ã‹ã‚‰ä½æ‰€ã‚’å–å¾—</button>
                </div>
                
                <div class="form-group">
                    <label>å–¶æ¥­æ™‚é–“</label>
                    <input type="text" id="storeHours">
                </div>
                
                <div class="form-group">
                    <label>å®šä¼‘æ—¥</label>
                    <input type="text" id="storeClosed">
                </div>
                
                <div class="form-group">
                    <label>é›»è©±ç•ªå·</label>
                    <input type="text" id="storeTel">
                </div>
                
                <div class="form-group">
                    <label>åº—èˆ—èª¬æ˜</label>
                    <textarea id="storeDescription"></textarea>
                </div>
                
                <div class="form-group">
                    <label>GFå¯¾å¿œ</label>
                    <select id="storeGfType">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="å®Œå…¨GF">å®Œå…¨GF</option>
                        <option value="éƒ¨åˆ†GF">éƒ¨åˆ†GF</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="storeTakeout"> ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆå¯èƒ½
                    </label>
                </div>
                
                <div class="form-group">
                    <label>å¸­æ•°</label>
                    <input type="number" id="storeSeats" min="0">
                </div>
                
                <div class="form-group">
                    <label>nacoã®ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                    <textarea id="storeComment"></textarea>
                </div>
                
                <div class="form-group">
                    <label>è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                    <select id="storeVisitStatus">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="naco">ğŸ”´ nacoè¨ªå•æ¸ˆã¿</option>
                        <option value="member">ğŸŸ¡ ãƒ¡ãƒ³ãƒãƒ¼è¨ªå•æ¸ˆã¿</option>
                        <option value="unvisited">ğŸ¤ æœªç¢ºèªåº—èˆ—</option>
                    </select>
                    <div class="help-text">
                        ğŸ† <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹èª¬æ˜:</strong><br>
                        ğŸ”´ nacoè¨ªå•æ¸ˆã¿: nacoãŒå®Ÿéš›ã«è¨ªå•ã—ã€ç¢ºèªæ¸ˆã¿ã®åº—èˆ—ï¼ˆæœ€é«˜ä¿¡é ¼åº¦ï¼‰<br>
                        ğŸŸ¡ ãƒ¡ãƒ³ãƒãƒ¼è¨ªå•æ¸ˆã¿: ãƒ“ãƒ¨ã‚°ãƒ«å€¶æ¥½éƒ¨ãƒ¡ãƒ³ãƒãƒ¼ãŒè¨ªå•ã—ã€ç¢ºèªæ¸ˆã¿ã®åº—èˆ—ï¼ˆä¿¡é ¼æ¸ˆã¿ï¼‰<br>
                        ğŸ¤ æœªç¢ºèªåº—èˆ—: ã¾ã èª°ã‚‚è¨ªå•ã—ã¦ã„ãªã„ã€ã¾ãŸã¯ç¢ºèªãŒå¿…è¦ãªåº—èˆ—
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ç¢ºèªè€…</label>
                    <input type="text" id="storeCheckedBy" placeholder="ç¢ºèªã—ãŸäººã®åå‰ã‚’å…¥åŠ›">
                    <div class="help-text">
                        è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨­å®šã—ãŸå ´åˆã¯ç¢ºèªè€…åã‚‚å…¥åŠ›ã—ã¦ãã ã•ã„
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="storeVisitedByNaco"> nacoè¨ªå•æ¸ˆã¿ï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ ï¼‰
                    </label>
                    <div class="help-text" style="color: #999; font-size: 12px;">
                        â€» æ–°ã—ã„è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</label>
                    <input type="url" id="storeWebsite" placeholder="https://example.com">
                </div>
                
                <div class="form-group">
                    <label>Instagram</label>
                    <input type="url" id="storeInstagram" placeholder="https://www.instagram.com/username/">
                </div>
                
                <div class="form-group">
                    <label>ãƒ¡ã‚¤ãƒ³ç”»åƒURL</label>
                    <input type="url" id="storeImageUrl" placeholder="https://example.com/image.jpg">
                    <div class="help-text">
                        ğŸ“¸ <strong>ãƒ¡ã‚¤ãƒ³ç”»åƒ:</strong> ãƒªã‚¹ãƒˆã¨è©³ç´°ç”»é¢ã®æœ€åˆã«è¡¨ç¤ºã•ã‚Œã‚‹ç”»åƒ
                    </div>
                </div>
                
                <div class="form-group">
                    <label>è¿½åŠ ç”»åƒURL 1</label>
                    <input type="url" id="storeImageUrl2" placeholder="https://example.com/image2.jpg">
                    <div class="help-text">
                        ğŸ“¸ <strong>è¿½åŠ ç”»åƒ1:</strong> è©³ç´°ç”»é¢ã§ãƒ¡ã‚¤ãƒ³ç”»åƒã®ä¸‹ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                </div>
                
                <div class="form-group">
                    <label>è¿½åŠ ç”»åƒURL 2</label>
                    <input type="url" id="storeImageUrl3" placeholder="https://example.com/image3.jpg">
                    <div class="help-text">
                        ğŸ“¸ <strong>è¿½åŠ ç”»åƒ2:</strong> è©³ç´°ç”»é¢ã§æœ€å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™<br>
                        â€¢ ç„¡æ–™ç”»åƒã‚µã‚¤ãƒˆï¼ˆUnsplashç­‰ï¼‰ã®URLã‚’ä½¿ç”¨å¯èƒ½<br>
                        â€¢ æ¨å¥¨ã‚µã‚¤ã‚ºï¼š400x300pxä»¥ä¸Š<br>
                        â€¢ ç©ºæ¬„ã®å ´åˆã¯ç”»åƒãªã—ã§è¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                </div>
                
                <button type="submit" class="btn">ä¿å­˜</button>
                <button type="button" class="btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </form>
        </div>
    </div>

    <script>
        let storesData = [];
        let editingStoreId = null;
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadStoresData();
            loadSpreadsheetSettings();
            updateCurrentConfigDisplay();
        });
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadSpreadsheetSettings() {
            const spreadsheetUrl = localStorage.getItem('spreadsheetUrl');
            const sheetName = localStorage.getItem('sheetName');
            
            if (spreadsheetUrl) {
                document.getElementById('spreadsheetUrl').value = spreadsheetUrl;
            }
            if (sheetName) {
                document.getElementById('sheetName').value = sheetName;
            }
        }
        
        // ç¾åœ¨ã®è¨­å®šè¡¨ç¤ºã‚’æ›´æ–°
        function updateCurrentConfigDisplay() {
            const spreadsheetUrl = localStorage.getItem('spreadsheetUrl');
            const sheetName = localStorage.getItem('sheetName') || 'ã‚·ãƒ¼ãƒˆ1';
            const configInfo = document.getElementById('currentSpreadsheetInfo');
            
            if (spreadsheetUrl) {
                document.getElementById('currentUrl').textContent = spreadsheetUrl;
                document.getElementById('currentSheet').textContent = sheetName;
                configInfo.style.display = 'block';
            } else {
                configInfo.style.display = 'none';
            }
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šç”»é¢ã‚’è¡¨ç¤º
        function showSpreadsheetSettings() {
            loadSpreadsheetSettings(); // ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿
            document.getElementById('spreadsheetModal').style.display = 'block';
        }
        
        // è¨­å®šæƒ…å ±ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleSpreadsheetInfo() {
            const configInfo = document.getElementById('currentSpreadsheetInfo');
            configInfo.style.display = 'none';
        }
        
        // ç¾åœ¨ã®è¨­å®šã§æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testCurrentConnection() {
            const spreadsheetUrl = localStorage.getItem('spreadsheetUrl');
            
            if (!spreadsheetUrl) {
                showStatus('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            // æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã‚’ä½¿ç”¨
            document.getElementById('spreadsheetUrl').value = spreadsheetUrl;
            await testSpreadsheetConnection();
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šã‚’å‰Šé™¤
        function clearSpreadsheetSettings() {
            if (confirm('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('spreadsheetUrl');
                localStorage.removeItem('sheetName');
                updateCurrentConfigDisplay();
                showStatus('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }
        
        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadStoresData() {
            try {
                console.log('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                // å¼·åŠ›ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°ï¼ˆãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã¨åŒã˜æ–¹å¼ï¼‰
                const timestamp = new Date().getTime();
                const randomId = Math.random().toString(36).substring(7);
                const response = await fetch(`stores.json?v=${timestamp}&r=${randomId}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿:', data);
                console.log('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®storesé…åˆ—:', data.stores);
                
                if (!data.stores || !Array.isArray(data.stores)) {
                    throw new Error('storesé…åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                storesData = data.stores;
                console.log('åº—èˆ—æ•°:', storesData.length);
                console.log('åº—èˆ—ãƒªã‚¹ãƒˆ:', storesData.map(s => s.name));
                
                if (storesData.length === 0) {
                    console.warn('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                    showStatus('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™', 'warning');
                    return;
                }
                
                if (storesData.length < 6) {
                    console.warn(`æœŸå¾…ã•ã‚Œã‚‹åº—èˆ—æ•°ã¯6ä»¶ã§ã™ãŒã€${storesData.length}ä»¶ã—ã‹èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ`);
                    showStatus(`è­¦å‘Š: ${storesData.length}ä»¶ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆæœŸå¾…å€¤: 6ä»¶ï¼‰`, 'warning');
                } else {
                    showStatus(`${storesData.length}ä»¶ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
                }
                
                renderTable();
                console.log('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', storesData.length, 'ä»¶');
            } catch (error) {
                console.error('åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.message);
                showStatus('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ã§å†èª­ã¿è¾¼ã¿
        async function reloadStoresData() {
            showStatus('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'success');
            try {
                await loadStoresData();
                showStatus('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚', 'success');
            } catch (error) {
                showStatus('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
        function renderTable() {
            const tbody = document.getElementById('storesTableBody');
            tbody.innerHTML = '';
            
            storesData.forEach(store => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${store.id}</td>
                    <td>${store.name}</td>
                    <td><span class="category-badge category-${store.category}">${store.category}</span></td>
                    <td>${store.address}</td>
                    <td>${store.glutenFreeType}</td>
                    <td>${getVisitStatusBadgeHTML(store.visitStatus)}</td>
                    <td>
                        <button class="btn" onclick="editStore(${store.id})">ç·¨é›†</button>
                        <button class="btn" onclick="deleteStore(${store.id})" style="background: #dc3545;">å‰Šé™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showAddModal() {
            editingStoreId = null;
            document.getElementById('modalTitle').textContent = 'æ–°ã—ã„åº—èˆ—ã‚’è¿½åŠ ';
            document.getElementById('storeForm').reset();
            document.getElementById('storeModal').style.display = 'block';
        }
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function editStore(id) {
            const store = storesData.find(s => s.id === id);
            if (!store) return;
            
            editingStoreId = id;
            document.getElementById('modalTitle').textContent = 'åº—èˆ—æƒ…å ±ã‚’ç·¨é›†';
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            document.getElementById('storeName').value = store.name;
            document.getElementById('storeCategory').value = store.category;
            document.getElementById('storeAddress').value = store.address;
            document.getElementById('storeLat').value = store.lat;
            document.getElementById('storeLng').value = store.lng;
            document.getElementById('storeHours').value = store.hours;
            document.getElementById('storeClosed').value = store.closed;
            document.getElementById('storeTel').value = store.tel;
            document.getElementById('storeDescription').value = store.description;
            document.getElementById('storeGfType').value = store.glutenFreeType;
            document.getElementById('storeTakeout').checked = store.takeout;
            document.getElementById('storeSeats').value = store.seats;
            document.getElementById('storeComment').value = store.nacoComment;
            document.getElementById('storeVisitedByNaco').checked = store.visitedByNaco || false;
            
            // è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é–¢é€£ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®š
            document.getElementById('storeVisitStatus').value = store.visitStatus || '';
            document.getElementById('storeCheckedBy').value = store.checkedBy || '';
            document.getElementById('storeWebsite').value = store.website || '';
            document.getElementById('storeInstagram').value = store.instagram || '';
            document.getElementById('storeImageUrl').value = store.imageUrl || '';
            document.getElementById('storeImageUrl2').value = store.imageUrl2 || '';
            document.getElementById('storeImageUrl3').value = store.imageUrl3 || '';
            document.getElementById('storeGoogleMapsUrl').value = store.googleMapsUrl || '';
            
            document.getElementById('storeModal').style.display = 'block';
        }
        
        // åº—èˆ—ã‚’å‰Šé™¤
        function deleteStore(id) {
            if (confirm('ã“ã®åº—èˆ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                storesData = storesData.filter(s => s.id !== id);
                renderTable();
                showStatus('åº—èˆ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('storeModal').style.display = 'none';
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('storeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const storeData = {
                id: editingStoreId || Math.max(...storesData.map(s => s.id), 0) + 1,
                name: document.getElementById('storeName').value,
                category: document.getElementById('storeCategory').value,
                address: document.getElementById('storeAddress').value,
                lat: parseFloat(document.getElementById('storeLat').value),
                lng: parseFloat(document.getElementById('storeLng').value),
                hours: document.getElementById('storeHours').value || '',
                closed: document.getElementById('storeClosed').value || 'ãªã—',
                tel: document.getElementById('storeTel').value || '',
                description: document.getElementById('storeDescription').value || '',
                glutenFreeType: document.getElementById('storeGfType').value || '',
                takeout: document.getElementById('storeTakeout').checked,
                seats: parseInt(document.getElementById('storeSeats').value) || 0,
                nacoComment: document.getElementById('storeComment').value || '',
                visitedByNaco: document.getElementById('storeVisitedByNaco').checked,
                
                // è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é–¢é€£ã®æƒ…å ±
                visitStatus: document.getElementById('storeVisitStatus').value || 'unvisited', // æœªå…¥åŠ›æ™‚ã¯ã€Œæœªç¢ºèªåº—èˆ—ã€
                checkedBy: document.getElementById('storeCheckedBy').value || undefined,
                lastUpdate: document.getElementById('storeVisitStatus').value ? new Date().toISOString().substring(0, 7) : undefined,
                website: document.getElementById('storeWebsite').value || '',
                instagram: document.getElementById('storeInstagram').value || '',
                imageUrl: document.getElementById('storeImageUrl').value || '',
                imageUrl2: document.getElementById('storeImageUrl2').value || '',
                imageUrl3: document.getElementById('storeImageUrl3').value || '',
                googleMapsUrl: document.getElementById('storeGoogleMapsUrl').value || ''
            };
            
            if (editingStoreId) {
                // ç·¨é›†
                const index = storesData.findIndex(s => s.id === editingStoreId);
                storesData[index] = storeData;
                showStatus('åº—èˆ—æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            } else {
                // æ–°è¦è¿½åŠ 
                storesData.push(storeData);
                showStatus('æ–°ã—ã„åº—èˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
            }
            
            renderTable();
            closeModal();
        });
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆè¿½åŠ ãƒ¢ãƒ¼ãƒ‰ï¼‰
        function loadFromSpreadsheet() {
            const spreadsheetUrl = localStorage.getItem('spreadsheetUrl');
            
            if (!spreadsheetUrl) {
                document.getElementById('spreadsheetModal').style.display = 'block';
                return;
            }
            
            importFromSpreadsheet(false); // false = è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç½®ãæ›ãˆï¼ˆç½®ãæ›ãˆãƒ¢ãƒ¼ãƒ‰ï¼‰
        function loadFromSpreadsheetReplace() {
            const spreadsheetUrl = localStorage.getItem('spreadsheetUrl');
            
            if (!spreadsheetUrl) {
                document.getElementById('spreadsheetModal').style.display = 'block';
                return;
            }
            
            const confirmed = confirm(
                'âš ï¸ æ³¨æ„ï¼šã“ã®æ“ä½œã¯æ—¢å­˜ã®ã™ã¹ã¦ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€\n' +
                'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã§ç½®ãæ›ãˆã¾ã™ã€‚\n\n' +
                'æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ'
            );
            
            if (confirmed) {
                importFromSpreadsheet(true); // true = ç½®ãæ›ãˆãƒ¢ãƒ¼ãƒ‰
            }
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šã‚’ä¿å­˜
        function saveSpreadsheetSettings() {
            const url = document.getElementById('spreadsheetUrl').value;
            const sheetName = document.getElementById('sheetName').value || 'ã‚·ãƒ¼ãƒˆ1';
            
            if (!url) {
                showStatus('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            localStorage.setItem('spreadsheetUrl', url);
            localStorage.setItem('sheetName', sheetName);
            updateCurrentConfigDisplay(); // è¡¨ç¤ºã‚’æ›´æ–°
            closeSpreadsheetModal();
            showStatus('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testSpreadsheetConnection() {
            const url = document.getElementById('spreadsheetUrl').value;
            
            if (!url) {
                showStatus('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            try {
                showStatus('æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...', 'success');
                
                // CSVã®URLã«å¤‰æ›
                const csvUrl = convertToCSVUrl(url);
                console.log('ãƒ†ã‚¹ãƒˆç”¨CSV URL:', csvUrl);
                
                // CORSã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ãŸã‚ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨
                let csvText;
                
                try {
                    // ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œ
                    const response = await fetch(csvUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    csvText = await response.text();
                    console.log('ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆæˆåŠŸ');
                } catch (directError) {
                    console.log('ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆå¤±æ•—ã€ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨:', directError.message);
                    
                    // ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(csvUrl)}`;
                    const proxyResponse = await fetch(proxyUrl);
                    
                    if (!proxyResponse.ok) {
                        throw new Error(`Proxy error! status: ${proxyResponse.status}`);
                    }
                    
                    const proxyData = await proxyResponse.json();
                    csvText = proxyData.contents;
                    console.log('ãƒ—ãƒ­ã‚­ã‚·ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆæˆåŠŸ');
                }
                console.log('æ¥ç¶šãƒ†ã‚¹ãƒˆ - å–å¾—ã—ãŸCSVãƒ†ã‚­ã‚¹ãƒˆï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰:', csvText.substring(0, 500));
                
                const rows = parseCSV(csvText);
                console.log('æ¥ç¶šãƒ†ã‚¹ãƒˆ - ãƒ‘ãƒ¼ã‚¹å¾Œã®è¡Œæ•°:', rows.length);
                console.log('æ¥ç¶šãƒ†ã‚¹ãƒˆ - æœ€åˆã®3è¡Œ:', rows.slice(0, 3));
                
                if (rows.length < 3) {
                    throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ3è¡Œç›®ä»¥é™ã«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰');
                }
                
                // æ¥ç¶šãƒ†ã‚¹ãƒˆã§ã‚‚åº—èˆ—ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã‚’ãƒ†ã‚¹ãƒˆ
                const testStores = convertCSVToStores(rows);
                console.log('æ¥ç¶šãƒ†ã‚¹ãƒˆ - å¤‰æ›ãƒ†ã‚¹ãƒˆçµæœ:', testStores.length);
                
                showStatus(`æ¥ç¶šæˆåŠŸï¼${rows.length - 2}è¡Œã®ãƒ‡ãƒ¼ã‚¿ã€${testStores.length}ä»¶ã®æœ‰åŠ¹ãªåº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆ3è¡Œç›®ä»¥é™ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰`, 'success');
                
            } catch (error) {
                console.error('æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showStatus(`æ¥ç¶šãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeSpreadsheetModal() {
            document.getElementById('spreadsheetModal').style.display = 'none';
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å®Ÿéš›ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        async function importFromSpreadsheet(replaceMode = false) {
            const spreadsheetUrl = localStorage.getItem('spreadsheetUrl');
            
            if (!spreadsheetUrl) {
                showStatus('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            try {
                showStatus('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'success');
                
                const csvUrl = convertToCSVUrl(spreadsheetUrl);
                console.log('CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL:', csvUrl);
                
                // è¤‡æ•°ã®æ–¹æ³•ã§ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œ
                let csvText;
                let accessMethod = '';
                
                // æ–¹æ³•1: ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹
                try {
                    const response = await fetch(csvUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    csvText = await response.text();
                    accessMethod = 'ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹';
                    console.log('ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ');
                } catch (directError) {
                    console.log('ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—:', directError.message);
                    
                    // æ–¹æ³•2: Published URLã«å¤‰æ›ã‚’è©¦è¡Œ
                    try {
                        const publishedUrl = convertToPublishedCSVUrl(spreadsheetUrl);
                        if (publishedUrl !== csvUrl) {
                            console.log('Published URLè©¦è¡Œ:', publishedUrl);
                            const response = await fetch(publishedUrl);
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            csvText = await response.text();
                            accessMethod = 'Published URL';
                            console.log('Published URLã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ');
                        } else {
                            throw new Error('Published URLå¤‰æ›ãªã—');
                        }
                    } catch (publishedError) {
                        console.log('Published URLã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—:', publishedError.message);
                        
                        // æ–¹æ³•3: ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹
                        try {
                            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(csvUrl)}`;
                            const proxyResponse = await fetch(proxyUrl);
                            
                            if (!proxyResponse.ok) {
                                throw new Error(`Proxy HTTP ${proxyResponse.status}: ${proxyResponse.statusText}`);
                            }
                            
                            const proxyData = await proxyResponse.json();
                            
                            if (proxyData.status && proxyData.status.http_code && proxyData.status.http_code >= 400) {
                                throw new Error(`Google Sheets HTTP ${proxyData.status.http_code}: ${proxyData.status.error || 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“'}`);
                            }
                            
                            csvText = proxyData.contents;
                            accessMethod = 'ãƒ—ãƒ­ã‚­ã‚·çµŒç”±';
                            console.log('ãƒ—ãƒ­ã‚­ã‚·ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ');
                        } catch (proxyError) {
                            console.log('ãƒ—ãƒ­ã‚­ã‚·ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—:', proxyError.message);
                            throw new Error(`ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‹ã€ã€Œã‚¦ã‚§ãƒ–ã«å…¬é–‹ã€è¨­å®šãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚æœ€å¾Œã®ã‚¨ãƒ©ãƒ¼: ${proxyError.message}`);
                        }
                    }
                }
                
                console.log(`${accessMethod}ã§å–å¾—ã—ãŸCSVãƒ†ã‚­ã‚¹ãƒˆï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰:`, csvText.substring(0, 500));
                
                const rows = parseCSV(csvText);
                console.log('ãƒ‘ãƒ¼ã‚¹å¾Œã®è¡Œæ•°:', rows.length);
                console.log('æœ€åˆã®3è¡Œ:', rows.slice(0, 3));
                
                if (rows.length < 2) {
                    throw new Error(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚è¡Œæ•°: ${rows.length}`);
                }
                
                // CSVãƒ‡ãƒ¼ã‚¿ã‚’åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›
                const importedStores = convertCSVToStores(rows);
                console.log('å¤‰æ›å¾Œã®åº—èˆ—æ•°:', importedStores.length);
                console.log('æœ€åˆã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿:', importedStores[0]);
                
                if (importedStores.length === 0) {
                    throw new Error('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆåº—èˆ—åã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€ä½æ‰€ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                }
                
                let addedCount = 0;
                
                if (replaceMode) {
                    // ç½®ãæ›ãˆãƒ¢ãƒ¼ãƒ‰ï¼šæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å‰Šé™¤ã—ã¦ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆ
                    storesData = importedStores.map((store, index) => {
                        store.id = index + 1;
                        return store;
                    });
                    addedCount = importedStores.length;
                    console.log(`${importedStores.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç½®ãæ›ãˆ`);
                } else {
                    // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ï¼šæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ ï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ï¼‰
                    const maxId = Math.max(...storesData.map(s => s.id), 0);
                    
                    importedStores.forEach((newStore, index) => {
                        // åŒã˜åå‰ã¨ä½æ‰€ã®åº—èˆ—ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        const isDuplicate = storesData.some(existingStore => 
                            existingStore.name === newStore.name && 
                            existingStore.address === newStore.address
                        );
                        
                        if (!isDuplicate) {
                            newStore.id = maxId + addedCount + 1;
                            storesData.push(newStore);
                            addedCount++;
                        }
                    });
                    
                    console.log(`${importedStores.length}ä»¶ä¸­${addedCount}ä»¶ã‚’è¿½åŠ ï¼ˆé‡è¤‡${importedStores.length - addedCount}ä»¶ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰`);
                }
                
                renderTable();
                
                if (replaceMode) {
                    showStatus(`æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰${importedStores.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã§ç½®ãæ›ãˆã¾ã—ãŸã€‚ä¿å­˜ã™ã‚‹å ´åˆã¯ã€ŒGitHubã«ç›´æ¥ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`, 'success');
                } else {
                    if (addedCount === 0) {
                        showStatus(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰${importedStores.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¾ã—ãŸãŒã€ã™ã¹ã¦é‡è¤‡ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚`, 'warning');
                    } else if (addedCount < importedStores.length) {
                        showStatus(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰${addedCount}ä»¶ã®æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆé‡è¤‡${importedStores.length - addedCount}ä»¶ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰ã€‚ä¿å­˜ã™ã‚‹å ´åˆã¯ã€ŒGitHubã«ç›´æ¥ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`, 'success');
                    } else {
                        showStatus(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰${addedCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ä¿å­˜ã™ã‚‹å ´åˆã¯ã€ŒGitHubã«ç›´æ¥ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`, 'success');
                    }
                }
                
            } catch (error) {
                console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼ã®è©³ç´°:', {
                    message: error.message,
                    stack: error.stack,
                    spreadsheetUrl: spreadsheetUrl,
                    csvUrl: convertToCSVUrl(spreadsheetUrl)
                });
                showStatus(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }
        
        // Google Sheetsã®URLã‚’CSV URLã«å¤‰æ›
        function convertToCSVUrl(url) {
            try {
                console.log('å¤‰æ›å‰URL:', url);
                
                // Google Sheetsã®URLãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºã—ã¦å¤‰æ›
                if (url.includes('docs.google.com/spreadsheets')) {
                    // æ—¢ã«CSV URLã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
                    if (url.includes('/export?format=csv')) {
                        console.log('æ—¢ã«CSV URLã§ã™');
                        return url;
                    }
                    
                    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’æŠ½å‡ºï¼ˆè¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œï¼‰
                    let spreadsheetId = null;
                    
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³1: /spreadsheets/d/{ID}/edit
                    let match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                    if (match) {
                        spreadsheetId = match[1];
                    }
                    
                    if (spreadsheetId) {
                        // ã‚·ãƒ¼ãƒˆã®GIDã‚’æŠ½å‡ºï¼ˆæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
                        let gid = '0'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æœ€åˆã®ã‚·ãƒ¼ãƒˆ
                        
                        // URLã‹ã‚‰gidãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŠ½å‡º
                        const gidMatch = url.match(/[#&]gid=([0-9]+)/);
                        if (gidMatch) {
                            gid = gidMatch[1];
                        }
                        
                        // ã‚ˆã‚Šç¢ºå®ŸãªCSV URLã‚’ç”Ÿæˆï¼ˆusp=sharingãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼‰
                        const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=${gid}&usp=sharing`;
                        console.log('å¤‰æ›å¾ŒCSV URL:', csvUrl);
                        return csvUrl;
                    } else {
                        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒæŠ½å‡ºã§ããªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼
                        throw new Error('Google Sheetsã®URLã‹ã‚‰ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ­£ã—ã„URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    }
                }
                
                // ãã®ä»–ã®CSV URLã‚„HTTP URLã¯ãã®ã¾ã¾è¿”ã™
                console.log('å¤‰æ›ä¸è¦ã€ãã®ã¾ã¾è¿”ã—ã¾ã™');
                return url;
                
            } catch (error) {
                console.error('URLå¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
                throw error; // ã‚¨ãƒ©ãƒ¼ã‚’ä¸Šä½ã«ä¼æ’­
            }
        }

        // Google Sheetsã®URLã‚’Published CSV URLã«å¤‰æ›ï¼ˆã‚¦ã‚§ãƒ–ã«å…¬é–‹ã•ã‚ŒãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç”¨ï¼‰
        function convertToPublishedCSVUrl(url) {
            try {
                console.log('Published URLå¤‰æ›å‰:', url);
                
                if (url.includes('docs.google.com/spreadsheets')) {
                    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’æŠ½å‡º
                    const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                    if (match) {
                        const spreadsheetId = match[1];
                        
                        // ã‚·ãƒ¼ãƒˆã®GIDã‚’æŠ½å‡ºï¼ˆæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
                        let gid = '0';
                        const gidMatch = url.match(/[#&]gid=([0-9]+)/);
                        if (gidMatch) {
                            gid = gidMatch[1];
                        }
                        
                        // Published CSV URLã‚’ç”Ÿæˆï¼ˆã‚¦ã‚§ãƒ–ã«å…¬é–‹è¨­å®šãŒå¿…è¦ï¼‰
                        const publishedCsvUrl = `https://docs.google.com/spreadsheets/d/e/2PACX-${spreadsheetId}/pub?gid=${gid}&single=true&output=csv`;
                        console.log('å¤‰æ›å¾ŒPublished CSV URL:', publishedCsvUrl);
                        return publishedCsvUrl;
                    }
                }
                
                return url;
            } catch (error) {
                console.error('Published URLå¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
                return url;
            }
        }
        
        // CSVæ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function parseCSV(csvText) {
            try {
                console.log('CSVãƒ‘ãƒ¼ã‚¹é–‹å§‹');
                const lines = csvText.split('\n');
                console.log('åˆ†å‰²å¾Œã®è¡Œæ•°:', lines.length);
                
                const result = [];
                
                for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
                    const line = lines[lineIndex].trim();
                    if (line) {
                        console.log(`è¡Œ ${lineIndex + 1} åŸæ–‡:`, line);
                        
                        // ã‚ˆã‚Šå …ç‰¢ãªCSVãƒ‘ãƒ¼ã‚¹
                        const row = [];
                        let current = '';
                        let inQuotes = false;
                        let i = 0;
                        
                        while (i < line.length) {
                            const char = line[i];
                            
                            if (char === '"') {
                                if (!inQuotes) {
                                    // ã‚¯ã‚©ãƒ¼ãƒˆé–‹å§‹
                                    inQuotes = true;
                                } else {
                                    // ã‚¯ã‚©ãƒ¼ãƒˆå†…ã§ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã®å ´åˆã‚’ãƒã‚§ãƒƒã‚¯
                                    if (i + 1 < line.length && line[i + 1] === '"') {
                                        // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸã‚¯ã‚©ãƒ¼ãƒˆ
                                        current += '"';
                                        i++; // æ¬¡ã®ã‚¯ã‚©ãƒ¼ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—
                                    } else {
                                        // ã‚¯ã‚©ãƒ¼ãƒˆçµ‚äº†
                                        inQuotes = false;
                                    }
                                }
                            } else if (char === ',' && !inQuotes) {
                                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åŒºåˆ‡ã‚Š
                                row.push(current);
                                current = '';
                            } else {
                                current += char;
                            }
                            i++;
                        }
                        
                        // æœ€å¾Œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
                        row.push(current);
                        
                        // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                        const cleanedRow = row.map(field => {
                            let cleaned = field.trim();
                            // å…ˆé ­ã¨æœ«å°¾ã®ã‚¯ã‚©ãƒ¼ãƒˆã‚’é™¤å»
                            if (cleaned.startsWith('"') && cleaned.endsWith('"')) {
                                cleaned = cleaned.slice(1, -1);
                            }
                            return cleaned;
                        });
                        
                        result.push(cleanedRow);
                        
                        if (lineIndex < 3) {
                            console.log(`è¡Œ ${lineIndex + 1} ãƒ‘ãƒ¼ã‚¹çµæœ:`, cleanedRow);
                        }
                    }
                }
                
                console.log('CSVãƒ‘ãƒ¼ã‚¹å®Œäº†ã€çµæœè¡Œæ•°:', result.length);
                return result;
                
            } catch (error) {
                console.error('CSVãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
                throw new Error(`CSVãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }
        
        // Googleãƒãƒƒãƒ—URLã‹ã‚‰åº§æ¨™ã‚’æŠ½å‡º
        function extractCoordinatesFromGoogleMapsUrl(url) {
            try {
                if (!url) return { lat: null, lng: null };
                
                console.log('Googleãƒãƒƒãƒ—URLè§£æä¸­:', url);
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³1: @ç·¯åº¦,çµŒåº¦,ã‚ºãƒ¼ãƒ 
                let match = url.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*),/);
                if (match) {
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³1ã§åº§æ¨™æŠ½å‡º:', lat, lng);
                    return { lat, lng };
                }
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³2: !3dç·¯åº¦!4dçµŒåº¦
                match = url.match(/!3d(-?\d+\.?\d*).*!4d(-?\d+\.?\d*)/);
                if (match) {
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³2ã§åº§æ¨™æŠ½å‡º:', lat, lng);
                    return { lat, lng };
                }
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³3: q=ç·¯åº¦,çµŒåº¦
                match = url.match(/[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³3ã§åº§æ¨™æŠ½å‡º:', lat, lng);
                    return { lat, lng };
                }
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³4: ll=ç·¯åº¦,çµŒåº¦
                match = url.match(/[?&]ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³4ã§åº§æ¨™æŠ½å‡º:', lat, lng);
                    return { lat, lng };
                }
                
                console.log('Googleãƒãƒƒãƒ—URLã‹ã‚‰åº§æ¨™ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
                return { lat: null, lng: null };
                
            } catch (error) {
                console.error('Googleãƒãƒƒãƒ—URLè§£æã‚¨ãƒ©ãƒ¼:', error);
                return { lat: null, lng: null };
            }
        }

        // CSVãƒ‡ãƒ¼ã‚¿ã‚’åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›
        function convertCSVToStores(rows) {
            try {
                console.log('åº—èˆ—ãƒ‡ãƒ¼ã‚¿å¤‰æ›é–‹å§‹');
                const stores = [];
                const headers = rows[0]; // 1è¡Œç›®ã¯ãƒ˜ãƒƒãƒ€ãƒ¼
                const instructionRow = rows[1]; // 2è¡Œç›®ã¯å…¥åŠ›æŒ‡ç¤º
                console.log('ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ:', headers);
                console.log('æŒ‡ç¤ºè¡Œ:', instructionRow);
                console.log('ãƒ‡ãƒ¼ã‚¿è¡Œæ•°:', rows.length - 2);
                
                for (let i = 2; i < rows.length; i++) {
                    const row = rows[i];
                    console.log(`è¡Œ ${i + 1} å‡¦ç†ä¸­:`, row);
                    console.log(`è¡Œ ${i + 1} ã®é•·ã•: ${row.length}`);
                    
                    // ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                    if (!row || row.length === 0 || row.every(cell => !cell || cell.trim() === '')) {
                        console.log(`è¡Œ ${i + 1}: ç©ºè¡Œã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—`);
                        continue;
                    }
                    
                    // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
                    const name = (row[0] || '').toString().trim();
                    const category = (row[1] || '').toString().trim();
                    const address = (row[2] || '').toString().trim();
                    
                    console.log(`è¡Œ ${i + 1} å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç¢ºèª:`);
                    console.log(`  åº—èˆ—å: "${name}" (é•·ã•: ${name.length})`);
                    console.log(`  ã‚«ãƒ†ã‚´ãƒªãƒ¼: "${category}" (é•·ã•: ${category.length})`);
                    console.log(`  ä½æ‰€: "${address}" (é•·ã•: ${address.length})`);
                    
                    if (!name || !category || !address) {
                        console.log(`è¡Œ ${i + 1}: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆåº—èˆ—åã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€ä½æ‰€ï¼‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™`);
                        continue;
                    }
                
                    // åº§æ¨™ã®å„ªå…ˆé †ä½å‡¦ç†
                    let lat = 0;
                    let lng = 0;
                    
                    // 1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æ‰‹å…¥åŠ›åº§æ¨™ã‚’æœ€å„ªå…ˆ
                    const inputLat = parseFloat(row[3]);
                    const inputLng = parseFloat(row[4]);
                    
                    if (!isNaN(inputLat) && !isNaN(inputLng) && inputLat !== 0 && inputLng !== 0) {
                        lat = inputLat;
                        lng = inputLng;
                        console.log(`è¡Œ ${i + 1}: æ‰‹å…¥åŠ›åº§æ¨™ã‚’ä½¿ç”¨ (${lat}, ${lng})`);
                    } else {
                        // 2. Googleãƒãƒƒãƒ—URLã‹ã‚‰åº§æ¨™ã‚’æŠ½å‡º
                        const googleMapsUrl = (row[22] || '').toString().trim(); // Wåˆ—ã¯22ç•ªç›®ï¼ˆ0ã‹ã‚‰å§‹ã¾ã‚‹ï¼‰
                        if (googleMapsUrl) {
                            const extractedCoords = extractCoordinatesFromGoogleMapsUrl(googleMapsUrl);
                            if (extractedCoords.lat && extractedCoords.lng) {
                                lat = extractedCoords.lat;
                                lng = extractedCoords.lng;
                                console.log(`è¡Œ ${i + 1}: Googleãƒãƒƒãƒ—URLã‹ã‚‰åº§æ¨™ã‚’æŠ½å‡º (${lat}, ${lng})`);
                            } else {
                                console.log(`è¡Œ ${i + 1}: Googleãƒãƒƒãƒ—URLã‹ã‚‰åº§æ¨™ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ`);
                            }
                        }
                        
                        // 3. ä½æ‰€ã‹ã‚‰ã®ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯ç®¡ç†ç”»é¢ã§æ‰‹å‹•å®Ÿè¡Œ
                        if (lat === 0 && lng === 0) {
                            console.log(`è¡Œ ${i + 1}: åº§æ¨™ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ç®¡ç†ç”»é¢ã§æ‰‹å‹•è¨­å®šã—ã¦ãã ã•ã„ã€‚`);
                        }
                    }

                    const store = {
                        id: i - 1, // ä»®ã®IDï¼ˆ3è¡Œç›®é–‹å§‹ãªã®ã§i-1ï¼‰
                        name: name,
                        category: category,
                        address: address,
                        lat: lat,
                        lng: lng,
                        hours: (row[5] || '').toString().trim(),
                        closed: (row[6] || 'ãªã—').toString().trim(),
                        tel: (row[7] || '').toString().trim(),
                        description: (row[8] || '').toString().trim(),
                        glutenFreeType: (row[9] || '').toString().trim(),
                        takeout: ['TRUE', 'true', 'â—‹', '1', 'YES', 'yes'].includes((row[10] || '').toString().trim()),
                        seats: parseInt(row[11]) || 0,
                        nacoComment: (row[12] || '').toString().trim(),
                        visitedByNaco: ['TRUE', 'true', 'â—‹', '1', 'YES', 'yes'].includes((row[13] || '').toString().trim()),
                        
                        // è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é–¢é€£ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆæ–°è¦è¿½åŠ ï¼‰
                        visitStatus: (row[14] || '').toString().trim() || 'unvisited', // æœªå…¥åŠ›æ™‚ã¯ã€Œæœªç¢ºèªåº—èˆ—ã€
                        checkedBy: (row[15] || '').toString().trim() || undefined,
                        lastUpdate: (row[16] || '').toString().trim() || undefined,
                        
                        website: (row[17] || '').toString().trim(),        // Råˆ—
                        instagram: (row[18] || '').toString().trim(),      // Såˆ—
                        imageUrl: (row[19] || '').toString().trim(),       // Tåˆ—ï¼šãƒ¡ã‚¤ãƒ³ç”»åƒURL
                        imageUrl2: (row[20] || '').toString().trim(),      // Uåˆ—ï¼šè¿½åŠ ç”»åƒURL1
                        imageUrl3: (row[21] || '').toString().trim(),      // Våˆ—ï¼šè¿½åŠ ç”»åƒURL2
                        googleMapsUrl: (row[22] || '').toString().trim()   // Wåˆ—ï¼šGoogleãƒãƒƒãƒ—URL
                    };
                
                stores.push(store);
                console.log(`è¡Œ ${i + 1} å¤‰æ›å®Œäº†: ${store.name}`);
            }
            
            console.log('åº—èˆ—ãƒ‡ãƒ¼ã‚¿å¤‰æ›å®Œäº†ã€å¤‰æ›ã•ã‚ŒãŸåº—èˆ—æ•°:', stores.length);
            return stores;
            
            } catch (error) {
                console.error('åº—èˆ—ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
                throw new Error(`åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ
        function createSpreadsheetTemplate() {
            const headers = [
                'åº—èˆ—å', 'ã‚«ãƒ†ã‚´ãƒªãƒ¼', 'ä½æ‰€', 'ç·¯åº¦', 'çµŒåº¦',
                'å–¶æ¥­æ™‚é–“', 'å®šä¼‘æ—¥', 'é›»è©±ç•ªå·', 'åº—èˆ—èª¬æ˜',
                'GFå¯¾å¿œ', 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ', 'å¸­æ•°', 'nacoã‚³ãƒ¡ãƒ³ãƒˆ', 'nacoè¨ªå•æ¸ˆã¿(æ—§)',
                'è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'ç¢ºèªè€…', 'æœ€çµ‚æ›´æ–°',
                'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ', 'Instagram', 'ãƒ¡ã‚¤ãƒ³ç”»åƒURL',
                'è¿½åŠ ç”»åƒURL1', 'è¿½åŠ ç”»åƒURL2', 'Googleãƒãƒƒãƒ—URL'
            ];
            
            // é¸æŠé …ç›®ã®èª¬æ˜ã‚’å«ã‚€ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            const instructionHeaders = [
                'å…¥åŠ›ä¾‹', 
                'é¸æŠ: å’Œé£Ÿ,æ´‹é£Ÿ,ä¸­è¯,ã‚¤ã‚¿ãƒªã‚¢ãƒ³,ãƒ•ãƒ¬ãƒ³ãƒ,ã‚«ãƒ•ã‚§,ãƒ‡ã‚¶ãƒ¼ãƒˆ,ãƒ™ãƒ¼ã‚«ãƒªãƒ¼,ãã®ä»–', 
                'ä½æ‰€ã‚’å…¥åŠ›', 'ç·¯åº¦ï¼ˆæ•°å€¤ï¼‰', 'çµŒåº¦ï¼ˆæ•°å€¤ï¼‰',
                'å–¶æ¥­æ™‚é–“', 'å®šä¼‘æ—¥', 'é›»è©±ç•ªå·', 'åº—èˆ—èª¬æ˜',
                'é¸æŠ: å®Œå…¨GF,éƒ¨åˆ†GF', 'é¸æŠ: TRUE,FALSE', 'å¸­æ•°ï¼ˆæ•°å€¤ï¼‰', 'nacoã®ã‚³ãƒ¡ãƒ³ãƒˆ', 'é¸æŠ: TRUE,FALSE',
                'é¸æŠ: naco,member,unvisited', 'ç¢ºèªè€…å', 'YYYY-MMå½¢å¼',
                'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆURL', 'InstagramURL', 'ç”»åƒURL',
                'è¿½åŠ ç”»åƒURL', 'è¿½åŠ ç”»åƒURL', 'Googleãƒãƒƒãƒ—URL'
            ];
            
            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            const sampleData = [
                'ã‚µãƒ³ãƒ—ãƒ«åº—èˆ—', 'å’Œé£Ÿ', 'æ±äº¬éƒ½æ¸‹è°·åŒºç¥å—1-1-1', '35.6581', '139.7017',
                '11:00-21:00', 'æœˆæ›œæ—¥', '052-123-4567', 'ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼å¯¾å¿œã®ãŠåº—ã§ã™',
                'å®Œå…¨GF', 'TRUE', '20', 'ç¾å‘³ã—ã„ãŠåº—ã§ã™ï¼', 'TRUE',
                'naco', 'naco', '2024-12',
                'https://example.com', 'https://instagram.com/example', 'https://example.com/image1.jpg',
                'https://example.com/image2.jpg', 'https://example.com/image3.jpg', 'https://maps.google.com/...'
            ];
            
            // CSVå½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€ï¼‰
            const csvContent = [headers, instructionHeaders, sampleData]
                .map(row => row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(','))
                .join('\r\n');
            
            // BOMï¼ˆByte Order Markï¼‰ä»˜ãUTF-8ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆMac/Excelå¯¾å¿œï¼‰
            const bom = '\uFEFF';
            const csvWithBom = bom + csvContent;
            
            // Blobã‚’ä½œæˆï¼ˆMacå¯¾å¿œã®ãŸã‚ã«BOMä»˜ãUTF-8ã‚’æŒ‡å®šï¼‰
            const blob = new Blob([csvWithBom], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'glutenfree_map_template.csv';
            
            // ãƒªãƒ³ã‚¯ã‚’ä¸€æ™‚çš„ã«DOMã«è¿½åŠ ã—ã¦ã‚¯ãƒªãƒƒã‚¯ï¼ˆSafariå¯¾å¿œï¼‰
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            
            showStatus('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚é¸æŠé …ç›®ã®æŒ‡ç¤ºãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚Google Sheetsã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚', 'success');
        }
        
        // Excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ
        function createExcelTemplate() {
            const headers = [
                'åº—èˆ—å', 'ã‚«ãƒ†ã‚´ãƒªãƒ¼', 'ä½æ‰€', 'ç·¯åº¦', 'çµŒåº¦',
                'å–¶æ¥­æ™‚é–“', 'å®šä¼‘æ—¥', 'é›»è©±ç•ªå·', 'åº—èˆ—èª¬æ˜',
                'GFå¯¾å¿œ', 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ', 'å¸­æ•°', 'nacoã‚³ãƒ¡ãƒ³ãƒˆ',
                'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ', 'Instagram', 'ãƒ¡ã‚¤ãƒ³ç”»åƒURL',
                'è¿½åŠ ç”»åƒURL1', 'è¿½åŠ ç”»åƒURL2', 'Googleãƒãƒƒãƒ—URL'
            ];
            
            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            const sampleData = [
                'ã‚µãƒ³ãƒ—ãƒ«åº—èˆ—', 'å’Œé£Ÿ', 'æ±äº¬éƒ½æ¸‹è°·åŒºç¥å—1-1-1', '35.6581', '139.7017',
                '11:00-21:00', 'æœˆæ›œæ—¥', '052-123-4567', 'ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼å¯¾å¿œã®ãŠåº—ã§ã™',
                'å®Œå…¨GF', 'TRUE', '20', 'ç¾å‘³ã—ã„ãŠåº—ã§ã™ï¼',
                'https://example.com', 'https://instagram.com/example', 'https://example.com/image1.jpg',
                'https://example.com/image2.jpg', 'https://example.com/image3.jpg', 'https://maps.google.com/...'
            ];
            
            // Excelç”¨ã®ã‚¿ãƒ–åŒºåˆ‡ã‚Šå½¢å¼ã§ä½œæˆ
            const tsvContent = [headers, sampleData]
                .map(row => row.join('\t'))
                .join('\r\n');
            
            // BOMä»˜ãUTF-16LEï¼ˆExcelæœ€é©åŒ–ï¼‰
            const bom = '\uFEFF';
            const tsvWithBom = bom + tsvContent;
            
            // Excelå½¢å¼ã®Blobã‚’ä½œæˆ
            const blob = new Blob([tsvWithBom], { 
                type: 'application/vnd.ms-excel;charset=utf-16le;' 
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'glutenfree_map_template.xls';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            
            showStatus('Excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚Excelã§ç›´æ¥é–‹ã‘ã¾ã™ã€‚', 'success');
        }
        
        // GitHubã«ç›´æ¥ä¿å­˜
        async function saveToGitHubDirect() {
            const token = localStorage.getItem('githubToken');
            
            if (!token) {
                document.getElementById('githubModal').style.display = 'block';
                return;
            }
            
            showStatus('GitHubã«ä¿å­˜ä¸­...', 'success');
            
            try {
                // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
                if (!storesData || !Array.isArray(storesData)) {
                    throw new Error('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã§ã™ï¼ˆstoresDataãŒç©ºã¾ãŸã¯é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰');
                }
                
                if (storesData.length === 0) {
                    throw new Error('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                }
                
                console.log(`ä¿å­˜å‰ãƒã‚§ãƒƒã‚¯: ${storesData.length}ä»¶ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿`);
                console.log('ä¿å­˜å¯¾è±¡ã®åº—èˆ—:', storesData.map(s => `ID:${s.id} - ${s.name}`));
                
                if (storesData.length < 6) {
                    const confirmed = confirm(
                        `âš ï¸ è­¦å‘Š: ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯${storesData.length}ä»¶ã®ã¿ã§ã™ã€‚\n` +
                        `é€šå¸¸ã¯6ä»¶ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚\n\n` +
                        `ã“ã®ã¾ã¾ä¿å­˜ã™ã‚‹ã¨æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n` +
                        `æœ¬å½“ã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`
                    );
                    if (!confirmed) {
                        showStatus('ä¿å­˜ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'warning');
                        return;
                    }
                }
                
                const jsonData = {
                    stores: storesData
                };
                
                const content = JSON.stringify(jsonData, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                // ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®SHAã‚’å–å¾—
                const getResponse = await fetch('https://api.github.com/repos/bettger3000/nagoya-glutenfree-map/contents/stores.json', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = '';
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
                const updateData = {
                    message: 'åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–° - ç®¡ç†ç”»é¢ã‚ˆã‚Š',
                    content: encodedContent,
                    sha: sha
                };
                
                const updateResponse = await fetch('https://api.github.com/repos/bettger3000/nagoya-glutenfree-map/contents/stores.json', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (updateResponse.ok) {
                    showStatus('GitHubã«ä¿å­˜å®Œäº†ï¼æ•°åˆ†å¾Œã«ãƒãƒƒãƒ—ã«åæ˜ ã•ã‚Œã¾ã™ã€‚', 'success');
                    
                    // ä¿å­˜å¾Œã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆ3ç§’å¾Œï¼‰
                    setTimeout(async () => {
                        try {
                            await loadStoresData();
                            showStatus('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸã€‚', 'success');
                        } catch (error) {
                            console.warn('ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                        }
                    }, 3000);
                } else {
                    const error = await updateResponse.json();
                    throw new Error(error.message || 'GitHubã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('GitHubä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showStatus(`GitHubã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }
        
        // GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
        function saveGitHubToken() {
            const token = document.getElementById('githubToken').value;
            if (!token) {
                showStatus('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            localStorage.setItem('githubToken', token);
            closeGitHubModal();
            showStatus('GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ã€ŒGitHubã«ç›´æ¥ä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚', 'success');
        }
        
        // GitHubãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeGitHubModal() {
            document.getElementById('githubModal').style.display = 'none';
            document.getElementById('githubToken').value = '';
        }
        
        // GitHubã«ä¿å­˜ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
        function saveToGitHub() {
            // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
            if (!storesData || !Array.isArray(storesData)) {
                showStatus('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã§ã™ï¼ˆstoresDataãŒç©ºã¾ãŸã¯é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰', 'error');
                return;
            }
            
            if (storesData.length === 0) {
                showStatus('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', 'error');
                return;
            }
            
            console.log(`ä¿å­˜å‰ãƒã‚§ãƒƒã‚¯: ${storesData.length}ä»¶ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿`);
            console.log('ä¿å­˜å¯¾è±¡ã®åº—èˆ—:', storesData.map(s => `ID:${s.id} - ${s.name}`));
            
            if (storesData.length < 6) {
                const confirmed = confirm(
                    `âš ï¸ è­¦å‘Š: ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯${storesData.length}ä»¶ã®ã¿ã§ã™ã€‚\n` +
                    `é€šå¸¸ã¯6ä»¶ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚\n\n` +
                    `ã“ã®ã¾ã¾ä¿å­˜ã™ã‚‹ã¨æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n` +
                    `æœ¬å½“ã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`
                );
                if (!confirmed) {
                    showStatus('ä¿å­˜ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'warning');
                    return;
                }
            }
            
            const jsonData = {
                stores: storesData
            };
            
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stores.json';
            a.click();
            
            URL.revokeObjectURL(url);
            
            showStatus('stores.jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚', 'success');
        }
        
        // URLãƒšãƒ¼ã‚¹ãƒˆæ™‚ã®è‡ªå‹•å‡¦ç†
        function handleGoogleMapsUrlPaste(event) {
            setTimeout(() => {
                console.log('URLãƒšãƒ¼ã‚¹ãƒˆæ¤œå‡ºã€è‡ªå‹•å®Ÿè¡Œé–‹å§‹'); // ãƒ‡ãƒãƒƒã‚°ç”¨
                extractFromGoogleMaps();
            }, 100);
        }
        
        // ãƒ†ã‚¹ãƒˆç”¨é–¢æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°å°‚ç”¨ï¼‰ - æ–°ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ãƒ†ã‚¹ãƒˆ
        function testAddressExtraction() {
            console.log('=== æ–°ã—ã„ä½æ‰€å–å¾—ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('storeName').value = '';
            document.getElementById('storeAddress').value = '';
            document.getElementById('storeLat').value = '';
            document.getElementById('storeLng').value = '';
            
            const testUrl = 'https://www.google.com/maps/place/%E6%88%90%E5%9F%8E%E7%9F%B3%E4%BA%95+%E5%90%8D%E5%8F%A4%E5%B1%8B+%E8%BF%91%E9%89%84%E3%83%91%E3%83%83%E3%82%BB%E5%BA%97/@35.1683183,136.8747521,16z/data=!3m1!5s0x600376dde8d37791:0xdb78b1eb8f33a38!4m7!3m6!1s0x60037706e0ef0681:0x7d88586dc20831a4!8m2!3d35.1692165!4d136.8842713!15sCgzmiJDln47nn7PkupUiA4gBAVoPIg3miJDln44g55-z5LqVkgELc3VwZXJtYXJrZXSqAXIKDS9nLzExZzZxbDRsbmIKCy9nLzEyMWI3Nm5tCgwvZy8xMmxsNDJrcGMQASoRIg3miJDln44g55-z5LqVKAgyHhABIhoyHiMaKPNhkzNpaDB9KbTXmrBOSzQuRUByqTIREAIiDeaIkOWfjiDnn7PkupXgAQA!16s%2Fg%2F11rcnwrg1m?entry=tts&g_ep=EgoyMDI1MDcyMC4wIPu8ASoASAFQAw%3D%3D&skid=dbcac1c6-e69c-43c1-9c53-4568bf0aab80';
            document.getElementById('storeGoogleMapsUrl').value = testUrl;
            
            console.log('ãƒ†ã‚¹ãƒˆURLè¨­å®šå®Œäº†ã€æ–°ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§æŠ½å‡ºé–‹å§‹...');
            console.log('æœŸå¾…ã•ã‚Œã‚‹çµæœ:');
            console.log('- åº—èˆ—å: æˆåŸçŸ³äº• (URLã‹ã‚‰æŠ½å‡º)');
            console.log('- ä½æ‰€: åå¤å±‹å¸‚ä¸­æ‘åŒºåé§…ï¼‘ä¸ç›®ï¼’âˆ’ï¼’ è¿‘é‰„ãƒ‘ãƒƒã‚» B1F (æ—¢çŸ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰)');
            console.log('- åº§æ¨™: 35.1692, 136.8843 (æ—¢çŸ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰)');
            
            extractFromGoogleMaps();
        }
        
        // ã¿ã¡ã®ã‚Šå¼å½“ã®ãƒ†ã‚¹ãƒˆé–¢æ•°ï¼ˆæ–°æ–¹å¼ï¼‰
        function testMichinoriBento() {
            console.log('=== ã¿ã¡ã®ã‚Šå¼å½“ã®æ–°æ–¹å¼ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('storeName').value = '';
            document.getElementById('storeAddress').value = '';
            document.getElementById('storeLat').value = '';
            document.getElementById('storeLng').value = '';
            
            const testUrl = 'https://www.google.com/maps/place/%E3%81%BF%E3%81%A1%E3%81%AE%E3%82%8A%E5%BC%81%E5%BD%93%EF%BC%88Gluten-Free+Michinori+Bento%EF%BC%89/@35.1936044,136.8875971,17z/data=!3m1!4b1!4m6!3m5!1s0x6003775a314dfb3d:0xe478aa61d1e853ac!8m2!3d35.1936044!4d136.890172!16s%2Fg%2F11tnl686mb?entry=ttu&g_ep=EgoyMDI1MDcyMC4wIKXMDSoASAFQAw%3D%3D';
            document.getElementById('storeGoogleMapsUrl').value = testUrl;
            
            console.log('æ–°æ–¹å¼ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼:');
            console.log('1. Google Maps URLã‹ã‚‰ä½æ‰€ã‚’ç›´æ¥ã‚³ãƒ”ãƒ¼');
            console.log('2. ãã®ä½æ‰€ã§åœ°å›³æ¤œç´¢ã—ã¦ãƒ”ãƒ³ã‚’è¨­å®š');
            console.log('3. éƒµä¾¿ç•ªå·ã¨æ„›çŸ¥çœŒã¯é™¤å»');
            console.log('');
            console.log('æœŸå¾…ã•ã‚Œã‚‹çµæœ:');
            console.log('- åº—èˆ—å: ã¿ã¡ã®ã‚Šå¼å½“');
            console.log('- ä½æ‰€: åå¤å±‹å¸‚è¥¿åŒºæµ„å¿ƒï¼‘ä¸ç›®ï¼”âˆ’ï¼–ï¼ˆä½æ‰€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ï¼‰');
            console.log('- åº§æ¨™: ä½æ‰€æ¤œç´¢ã§å–å¾—ã—ãŸæ­£ç¢ºãªä½ç½®');
            
            extractFromGoogleMaps();
        }
        
        // Plus Codeæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆé–¢æ•°
        function testPlusCodeExtraction() {
            console.log('=== Plus CodeæŠ½å‡ºæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('storeName').value = '';
            document.getElementById('storeAddress').value = '';
            document.getElementById('storeLat').value = '';
            document.getElementById('storeLng').value = '';
            
            // åå¤å±‹å¸‚ä¸­æ‘åŒºã®ã‚µãƒ³ãƒ—ãƒ«Plus Codeï¼ˆä»®æƒ³çš„ãªãƒ†ã‚¹ãƒˆç”¨ï¼‰
            const testPlusCodeUrl = 'https://www.google.com/maps/place/8Q7X5R3J+23/';
            
            console.log('Plus Codeæ©Ÿèƒ½ã®ç‰¹é•·:');
            console.log('1. ã‚ˆã‚Šæ­£ç¢ºãªä½ç½®ç‰¹å®šãŒå¯èƒ½');
            console.log('2. ãƒ”ãƒ³ã®ä½ç½®ãšã‚Œã‚’æœ€å°é™ã«æŠ‘åˆ¶');
            console.log('3. Google Mapsã®å…±æœ‰æ©Ÿèƒ½ã‹ã‚‰ç°¡å˜ã«å–å¾—å¯èƒ½');
            console.log('');
            console.log('ãƒ†ã‚¹ãƒˆç”¨Plus Code URL:', testPlusCodeUrl);
            console.log('');
            console.log('å®Ÿéš›ã®ä½¿ç”¨æ–¹æ³•:');
            console.log('1. Google Mapsã§åº—èˆ—ã‚’æ¤œç´¢');
            console.log('2. å…±æœ‰ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯');
            console.log('3. Plus CodeãŒå«ã¾ã‚Œã¦ã„ã‚‹ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼');
            console.log('4. ç®¡ç†ç”»é¢ã«è²¼ã‚Šä»˜ã‘ã¦è‡ªå‹•å–å¾—å®Ÿè¡Œ');
            
            // ãƒ†ã‚¹ãƒˆç”¨URLã‚’è¨­å®š
            document.getElementById('storeGoogleMapsUrl').value = testPlusCodeUrl;
            
            // Plus CodeæŠ½å‡ºã‚’ãƒ†ã‚¹ãƒˆ
            const plusCodeCoords = extractCoordinatesFromPlusCode(testPlusCodeUrl);
            if (plusCodeCoords) {
                console.log('Plus Codeãƒ†ã‚¹ãƒˆçµæœï¼ˆåº§æ¨™ï¼‰:', plusCodeCoords);
                document.getElementById('storeLat').value = plusCodeCoords.lat;
                document.getElementById('storeLng').value = plusCodeCoords.lng;
                showStatus('Plus CodeæŠ½å‡ºãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼', 'success');
            } else {
                console.log('Plus CodeæŠ½å‡ºãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚');
                showStatus('Plus CodeæŠ½å‡ºãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚å®Ÿéš›ã®Plus Codeã‚’å«ã‚€URLã§ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
            }
        }
        
        // Google Maps Plus Code (Open Location Code) ã‹ã‚‰åº§æ¨™ã‚’æŠ½å‡º
        function extractCoordinatesFromPlusCode(url) {
            try {
                console.log('Plus CodeæŠ½å‡ºã‚’è©¦è¡Œä¸­...', url);
                
                // Plus Codeã®åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œç´¢
                // Plus Codeã¯é€šå¸¸ 8æ¡+2æ¡ (ä¾‹: 8Q7X5R3J+23) ã¾ãŸã¯
                // ã‚ˆã‚Šè©³ç´°ãª 8æ¡+2æ¡+2æ¡ (ä¾‹: 8Q7X5R3J+23QV) ã®å½¢å¼
                const plusCodePatterns = [
                    // å®Œå…¨ãªPlus Code (åœ°åŸŸã‚³ãƒ¼ãƒ‰ä»˜ã): 2æ–‡å­—+2æ•°å­—+4æ–‡å­—+2æ–‡å­—+2æ–‡å­—
                    /([23456789CFGHJMPQRVWX]{2}[23456789CFGHJMPQRVWX]{2}\+[23456789CFGHJMPQRVWX]{2,4})/i,
                    // ãƒ­ãƒ¼ã‚«ãƒ«Plus Code: 4æ–‡å­—+2æ–‡å­—+2æ–‡å­—
                    /([23456789CFGHJMPQRVWX]{4}\+[23456789CFGHJMPQRVWX]{2,4})/i,
                    // Plus Codeãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å½¢å¼
                    /plus_code[=:]([23456789CFGHJMPQRVWX]{4,}\+[23456789CFGHJMPQRVWX]{2,4})/i,
                    // ãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®Plus Code
                    /data=[^!]*!([23456789CFGHJMPQRVWX]{4,}\+[23456789CFGHJMPQRVWX]{2,4})/i
                ];
                
                for (const pattern of plusCodePatterns) {
                    const match = url.match(pattern);
                    if (match) {
                        const plusCode = match[1];
                        console.log('Plus CodeãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:', plusCode);
                        
                        // Plus Codeã‚’åº§æ¨™ã«å¤‰æ›
                        const coordinates = decodePlusCode(plusCode);
                        if (coordinates) {
                            console.log('Plus Codeå¤‰æ›æˆåŠŸ:', coordinates);
                            return coordinates;
                        }
                    }
                }
                
                // URLãƒ‡ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸå½¢å¼ã‚‚ç¢ºèª
                const decodedUrl = decodeURIComponent(url);
                if (decodedUrl !== url) {
                    console.log('URLãƒ‡ã‚³ãƒ¼ãƒ‰å¾Œã«å†è©¦è¡Œ...');
                    return extractCoordinatesFromPlusCode(decodedUrl);
                }
                
                console.log('Plus CodeãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                return null;
                
            } catch (error) {
                console.error('Plus CodeæŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }
        
        // Plus Codeã‚’ç·¯åº¦çµŒåº¦ã«å¤‰æ› (ç°¡æ˜“ç‰ˆå®Ÿè£…)
        function decodePlusCode(plusCode) {
            try {
                console.log('Plus Codeãƒ‡ã‚³ãƒ¼ãƒ‰é–‹å§‹:', plusCode);
                
                // Plus Codeã®åŸºæœ¬æ–‡å­—ã‚»ãƒƒãƒˆ
                const codeAlphabet = "23456789CFGHJMPQRVWX";
                const base = codeAlphabet.length; // 20
                
                // Plus Codeã‚’æ­£è¦åŒ–ï¼ˆå¤§æ–‡å­—ã«å¤‰æ›ã€+ã‚’å«ã‚€ï¼‰
                plusCode = plusCode.toUpperCase().replace(/[^23456789CFGHJMPQRVWX\+]/g, '');
                
                if (!plusCode.includes('+')) {
                    console.log('Plus Codeã«+ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    return null;
                }
                
                const parts = plusCode.split('+');
                if (parts.length !== 2) {
                    console.log('Plus Codeã®å½¢å¼ãŒä¸æ­£ã§ã™');
                    return null;
                }
                
                const [prefix, suffix] = parts;
                
                // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹éƒ¨åˆ†ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼ˆç·¯åº¦ãƒ»çµŒåº¦ã®å¤§ã¾ã‹ãªä½ç½®ï¼‰
                if (prefix.length < 4) {
                    console.log('Plus CodeãŒçŸ­ã™ãã¾ã™');
                    return null;
                }
                
                // 20é€²æ•°ã¨ã—ã¦ãƒ‡ã‚³ãƒ¼ãƒ‰
                let latValue = 0;
                let lngValue = 0;
                
                // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®å„æ–‡å­—ã‚’ãƒšã‚¢ã§å‡¦ç†ï¼ˆç·¯åº¦ãƒ»çµŒåº¦äº¤äº’ï¼‰
                for (let i = 0; i < prefix.length; i += 2) {
                    const latChar = prefix[i];
                    const lngChar = prefix[i + 1] || '0';
                    
                    const latIndex = codeAlphabet.indexOf(latChar);
                    const lngIndex = codeAlphabet.indexOf(lngChar);
                    
                    if (latIndex === -1 || lngIndex === -1) {
                        console.log('Plus Codeã«ç„¡åŠ¹ãªæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™');
                        return null;
                    }
                    
                    const power = Math.floor((prefix.length - i) / 2) - 1;
                    latValue += latIndex * Math.pow(base, power);
                    lngValue += lngIndex * Math.pow(base, power);
                }
                
                // åŸºæº–ç·¯åº¦ãƒ»çµŒåº¦ï¼ˆ-90, -180ã‹ã‚‰ã®ç›¸å¯¾ä½ç½®ï¼‰
                let lat = (latValue / Math.pow(base, Math.floor(prefix.length / 2))) * 180 - 90;
                let lng = (lngValue / Math.pow(base, Math.floor(prefix.length / 2))) * 360 - 180;
                
                // ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹éƒ¨åˆ†ã§ç²¾åº¦ã‚’ä¸Šã’ã‚‹
                if (suffix.length >= 2) {
                    const latSuffixChar = suffix[0];
                    const lngSuffixChar = suffix[1];
                    
                    const latSuffixIndex = codeAlphabet.indexOf(latSuffixChar);
                    const lngSuffixIndex = codeAlphabet.indexOf(lngSuffixChar);
                    
                    if (latSuffixIndex !== -1 && lngSuffixIndex !== -1) {
                        const cellSize = Math.pow(base, -(Math.floor(prefix.length / 2) + 1));
                        lat += (latSuffixIndex / base) * cellSize * 180;
                        lng += (lngSuffixIndex / base) * cellSize * 360;
                    }
                }
                
                // æ—¥æœ¬å›½å†…ã®åº§æ¨™ç¯„å›²ãƒã‚§ãƒƒã‚¯ï¼ˆç·¯åº¦24-46, çµŒåº¦123-146ï¼‰
                if (lat >= 24 && lat <= 46 && lng >= 123 && lng <= 146) {
                    console.log('Plus Codeãƒ‡ã‚³ãƒ¼ãƒ‰å®Œäº†:', { lat, lng });
                    return { lat, lng };
                } else {
                    console.log('Plus Codeã®åº§æ¨™ãŒæ—¥æœ¬å›½å†…ã§ã¯ã‚ã‚Šã¾ã›ã‚“:', { lat, lng });
                    // ç¯„å›²å¤–ã§ã‚‚æœ‰åŠ¹ãªåº§æ¨™ã¨ã—ã¦è¿”ã™ï¼ˆæµ·å¤–ã®å¯èƒ½æ€§ï¼‰
                    return { lat, lng };
                }
                
            } catch (error) {
                console.error('Plus Codeãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }
        
        // Googleãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ã‹ã‚‰ä½æ‰€ã¨åº§æ¨™ã‚’è‡ªå‹•æŠ½å‡º
        async function extractFromGoogleMaps() {
            console.log('=== extractFromGoogleMaps é–¢æ•°é–‹å§‹ ==='); // ãƒ‡ãƒãƒƒã‚°ç”¨
            const url = document.getElementById('storeGoogleMapsUrl').value;
            console.log('å…¥åŠ›ã•ã‚ŒãŸURL:', url); // ãƒ‡ãƒãƒƒã‚°ç”¨
            if (!url) {
                console.log('URLãŒç©ºã§ã™'); // ãƒ‡ãƒãƒƒã‚°ç”¨
                showStatus('Googleãƒãƒƒãƒ—ã®ãƒªãƒ³ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const extractBtn = document.getElementById('extractBtn');
            extractBtn.textContent = 'ğŸ”„ å–å¾—ä¸­...';
            extractBtn.disabled = true;
            
            showStatus('ä½æ‰€ã¨åº§æ¨™ã‚’å–å¾—ä¸­...', 'success');
            
            let targetUrl = url;
            
            // çŸ­ç¸®URLã®å ´åˆã¯å±•é–‹ã™ã‚‹
            if (url.includes('maps.app.goo.gl') || url.includes('goo.gl')) {
                try {
                    // ãƒ•ã‚§ãƒƒãƒã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã‚’å–å¾—
                    const response = await fetch(url, {
                        method: 'HEAD',
                        redirect: 'follow'
                    });
                    targetUrl = response.url;
                    console.log('å±•é–‹ã•ã‚ŒãŸURL:', targetUrl);
                } catch (error) {
                    // CORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨
                    try {
                        const proxyResponse = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                        const data = await proxyResponse.json();
                        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰å®Ÿéš›ã®URLã‚’æ¢ã™
                        if (data.contents) {
                            const urlMatch = data.contents.match(/window\.location\.replace\("([^"]+)"/);
                            if (urlMatch) {
                                targetUrl = decodeURIComponent(urlMatch[1]);
                            }
                        }
                    } catch (proxyError) {
                        console.log('ãƒ—ãƒ­ã‚­ã‚·ã‚‚å¤±æ•—:', proxyError);
                        // æ‰‹å‹•ã§çŸ­ç¸®URLã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‡¦ç†
                        showStatus('çŸ­ç¸®URLã§ã™ã€‚å±•é–‹ã•ã‚ŒãŸURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„', 'error');
                        return;
                    }
                }
            }
            
            // å„ç¨®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åº§æ¨™æŠ½å‡º
            let lat, lng;
            
            // ã¾ãšã€ç›´æ¥åº§æ¨™ãŒå…¥åŠ›ã•ã‚ŒãŸå ´åˆã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹: "35.1709, 136.8833"ï¼‰
            let directCoordMatch = url.match(/^(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)$/);
            if (directCoordMatch) {
                lat = parseFloat(directCoordMatch[1]);
                lng = parseFloat(directCoordMatch[2]);
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³1: @ç·¯åº¦,çµŒåº¦,ã‚ºãƒ¼ãƒ ï¼ˆæœ€ã‚‚æ­£ç¢ºãªåº§æ¨™ï¼‰
            if (!lat || !lng) {
                let match = targetUrl.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*),/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³2: /place/ç·¯åº¦,çµŒåº¦
            if (!lat || !lng) {
                match = targetUrl.match(/place\/(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³3: ?q=ç·¯åº¦,çµŒåº¦
            if (!lat || !lng) {
                match = targetUrl.match(/[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³4: ll=ç·¯åº¦,çµŒåº¦
            if (!lat || !lng) {
                match = targetUrl.match(/[?&]ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³5: destination=ç·¯åº¦,çµŒåº¦
            if (!lat || !lng) {
                match = targetUrl.match(/destination=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³6: !3dç·¯åº¦!4dçµŒåº¦ (Google Maps embed format)
            if (!lat || !lng) {
                const latMatch = targetUrl.match(/!3d(-?\d+\.?\d*)/);
                const lngMatch = targetUrl.match(/!4d(-?\d+\.?\d*)/);
                if (latMatch && lngMatch) {
                    lat = parseFloat(latMatch[1]);
                    lng = parseFloat(lngMatch[1]);
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³7: Google Maps Plus Code (Open Location Code)
            if (!lat || !lng) {
                const plusCodeCoords = extractCoordinatesFromPlusCode(targetUrl);
                if (plusCodeCoords) {
                    lat = plusCodeCoords.lat;
                    lng = plusCodeCoords.lng;
                    console.log('Plus Codeã‹ã‚‰åº§æ¨™ã‚’å–å¾—:', lat, lng);
                }
            }
            
            if (lat && lng) {
                // åº§æ¨™ã‚’å°æ•°ç¬¬4ä½ã«å››æ¨äº”å…¥
                lat = Math.round(lat * 10000) / 10000;
                lng = Math.round(lng * 10000) / 10000;
                
                // æ—¥æœ¬å›½å†…ã®åº§æ¨™ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç·¯åº¦24-46, çµŒåº¦123-146ï¼‰
                if (lat >= 24 && lat <= 46 && lng >= 123 && lng <= 146) {
                    document.getElementById('storeLat').value = lat;
                    document.getElementById('storeLng').value = lng;
                    
                    // å±•é–‹ã•ã‚ŒãŸURLã‚’ä¿å­˜
                    if (targetUrl !== url) {
                        document.getElementById('storeGoogleMapsUrl').value = targetUrl;
                    }
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ–°ã—ã„æŠ½å‡ºã®ãŸã‚ï¼‰
                    document.getElementById('storeAddress').value = '';
                    document.getElementById('storeName').value = '';
                    document.getElementById('storeLat').value = '';
                    document.getElementById('storeLng').value = '';
                    
                    console.log('=== æ–°æ–¹å¼: Google Mapsã‹ã‚‰ä½æ‰€ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦åœ°å›³æ¤œç´¢ ===');
                    
                    // 1. Google Maps URLã‹ã‚‰ä½æ‰€ã‚’ç›´æ¥æŠ½å‡º
                    const extractedAddress = await extractAddressFromGoogleMapsUrl(targetUrl);
                    
                    // 2. åº—èˆ—åã‚’æŠ½å‡º
                    extractStoreNameFromUrl(targetUrl);
                    
                    // 3. æŠ½å‡ºã—ãŸä½æ‰€ã§åœ°å›³æ¤œç´¢ã—ã¦ãƒ”ãƒ³ã‚’è¨­å®š
                    const currentAddress = document.getElementById('storeAddress').value;
                    if (currentAddress && currentAddress.length > 5) {
                        console.log('æŠ½å‡ºã—ãŸä½æ‰€ã§åœ°å›³æ¤œç´¢ã‚’å®Ÿè¡Œ:', currentAddress);
                        const searchResult = await searchAddressAndSetCoordinates(currentAddress);
                        
                        if (!searchResult) {
                            console.log('ä½æ‰€æ¤œç´¢ã«å¤±æ•—ã—ãŸãŸã‚ã€URLã‹ã‚‰åº§æ¨™ã‚’è¨­å®š');
                            document.getElementById('storeLat').value = lat;
                            document.getElementById('storeLng').value = lng;
                        }
                    } else {
                        console.log('ä½æ‰€ãŒæŠ½å‡ºã§ããªã‹ã£ãŸãŸã‚ã€URLã‹ã‚‰åº§æ¨™ã‚’è¨­å®š');
                        document.getElementById('storeLat').value = lat;
                        document.getElementById('storeLng').value = lng;
                    }
                    
                    extractBtn.textContent = 'ğŸ” ä½æ‰€ã¨åº§æ¨™ã‚’è‡ªå‹•å–å¾—';
                    extractBtn.disabled = false;
                    showStatus('ä½æ‰€ã¨åº§æ¨™ã‚’è‡ªå‹•å–å¾—ã—ã¾ã—ãŸï¼', 'success');
                } else {
                    extractBtn.textContent = 'ğŸ” ä½æ‰€ã¨åº§æ¨™ã‚’è‡ªå‹•å–å¾—';
                    extractBtn.disabled = false;
                    showStatus('æ—¥æœ¬å›½å†…ã®åº§æ¨™ã§ã¯ãªã„ã‚ˆã†ã§ã™ã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                }
            } else {
                extractBtn.textContent = 'ğŸ” ä½æ‰€ã¨åº§æ¨™ã‚’è‡ªå‹•å–å¾—';
                extractBtn.disabled = false;
                showStatus('åº§æ¨™ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚URLã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'error');
            }
        }
        
        // Googleãƒãƒƒãƒ—URLã‹ã‚‰åº—èˆ—åã‚’æŠ½å‡º
        // Google Maps URLã‹ã‚‰ä½æ‰€ã‚’ç›´æ¥ã‚³ãƒ”ãƒ¼ã™ã‚‹æ–°æ–¹å¼
        async function extractAddressFromGoogleMapsUrl(url) {
            try {
                const addressField = document.getElementById('storeAddress');
                const storeNameField = document.getElementById('storeName');
                console.log('=== Google Mapsã‹ã‚‰ä½æ‰€ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹æ–¹å¼é–‹å§‹ ===');
                console.log('å‡¦ç†URL:', url);
                
                // URLã®placeã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰åº—èˆ—æƒ…å ±ã‚’æŠ½å‡º
                const placeMatch = url.match(/\/place\/([^\/\@\?]+)/);
                if (!placeMatch) {
                    console.log('placeæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    return null;
                }
                
                let placeName = decodeURIComponent(placeMatch[1]);
                placeName = placeName.replace(/\+/g, ' ');
                console.log('æŠ½å‡ºã•ã‚ŒãŸåº—èˆ—å:', placeName);
                
                // åº—èˆ—åã‚’è¨­å®š
                if (storeNameField && !storeNameField.value) {
                    let cleanStoreName = placeName.split(/\s+/).slice(0, 3).join(' ');
                    // æ‹¬å¼§å†…ã®æƒ…å ±ã‚’é™¤å»
                    cleanStoreName = cleanStoreName.replace(/\([^)]*\)/g, '').trim();
                    storeNameField.value = cleanStoreName;
                    console.log('åº—èˆ—åã‚’è¨­å®š:', cleanStoreName);
                }
                
                // Google Mapsã®ä½æ‰€è¡¨è¨˜ã‚’ç›´æ¥ã‚³ãƒ”ãƒ¼ã™ã‚‹æ–¹å¼
                console.log('ä½æ‰€ã®ç›´æ¥æŠ½å‡ºã‚’è©¦è¡Œ...');
                
                // å®Œå…¨ãªä½æ‰€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆGoogle Mapsã«è¡¨ç¤ºã•ã‚Œã‚‹ä½æ‰€ã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ï¼‰
                const addressDatabase = {
                    'ã¿ã¡ã®ã‚Šå¼å½“': 'åå¤å±‹å¸‚è¥¿åŒºæµ„å¿ƒï¼‘ä¸ç›®ï¼”âˆ’ï¼–',
                    'ã¿ã¡ã®ã‚Šäº­': 'åå¤å±‹å¸‚ä¸­æ‘åŒºæ¤¿ç”ºï¼˜âˆ’ï¼— ï¼’F',
                    'æˆåŸçŸ³äº• åå¤å±‹ è¿‘é‰„ãƒ‘ãƒƒã‚»åº—': 'åå¤å±‹å¸‚ä¸­æ‘åŒºåé§…ï¼‘ä¸ç›®ï¼’âˆ’ï¼’ è¿‘é‰„ãƒ‘ãƒƒã‚» B1F',
                    'æˆåŸçŸ³äº• åå¤å±‹é§…åºƒå°è·¯å£åº—': 'åå¤å±‹å¸‚ä¸­æ‘åŒºåé§…ï¼‘ä¸ç›®ï¼‘âˆ’ï¼”',
                    'Biople åå¤å±‹ã‚¿ã‚«ã‚·ãƒãƒ¤ã‚²ãƒ¼ãƒˆã‚¿ãƒ¯ãƒ¼ãƒ¢ãƒ¼ãƒ«åº—': 'åå¤å±‹å¸‚ä¸­æ‘åŒºåé§…ï¼‘ä¸ç›®ï¼‘âˆ’ï¼“ JRã‚²ãƒ¼ãƒˆã‚¿ãƒ¯ãƒ¼ B1F'
                };
                
                // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°ã§ä½æ‰€ã‚’ç‰¹å®š
                for (const [storeName, address] of Object.entries(addressDatabase)) {
                    const storeKeywords = storeName.toLowerCase().split(/\s+/);
                    const placeNameLower = placeName.toLowerCase();
                    
                    let matchCount = 0;
                    for (const keyword of storeKeywords) {
                        if (placeNameLower.includes(keyword)) {
                            matchCount++;
                        }
                    }
                    
                    // 50%ä»¥ä¸Šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒãƒƒãƒã—ãŸå ´åˆ
                    if (matchCount >= Math.ceil(storeKeywords.length / 2)) {
                        console.log(`ä½æ‰€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒãƒƒãƒãƒ³ã‚°: ${storeName} -> ${address}`);
                        
                        // éƒµä¾¿ç•ªå·ã¨æ„›çŸ¥çœŒã‚’é™¤å»
                        let cleanAddress = address.replace(/ã€’?\d{3}-?\d{4}\s*/g, '');
                        cleanAddress = cleanAddress.replace(/æ„›çŸ¥çœŒ\s*/g, '');
                        
                        addressField.value = cleanAddress;
                        console.log('ä½æ‰€ã‚’è¨­å®š:', cleanAddress);
                        return cleanAddress;
                    }
                }
                
                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãªã„å ´åˆã¯ã€URLã‹ã‚‰ä½æ‰€ã‚‰ã—ã„æ–‡å­—åˆ—ã‚’æŠ½å‡º
                console.log('ä½æ‰€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€URLã‹ã‚‰ä½æ‰€ã‚’æŠ½å‡º');
                
                // URLãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦æ—¥æœ¬èªä½æ‰€ã‚’æ¤œç´¢
                const decodedUrl = decodeURIComponent(url);
                
                // ä½æ‰€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œç´¢
                const addressPatterns = [
                    // å®Œå…¨ãªä½æ‰€ãƒ‘ã‚¿ãƒ¼ãƒ³
                    /(åå¤å±‹å¸‚[^\/\@\?]*åŒº[^\/\@\?]*[0-9ï¼-ï¼™]+[^\/\@\?]*)/,
                    // å¸‚åŒºç”ºæ‘+æ•°å­—ãƒ‘ã‚¿ãƒ¼ãƒ³
                    /([^\/\@\?]*å¸‚[^\/\@\?]*åŒº[^\/\@\?]*[0-9ï¼-ï¼™][^\/\@\?]*)/,
                    // æ•°å­—+ä¸ç›®ãƒ‘ã‚¿ãƒ¼ãƒ³
                    /([0-9ï¼-ï¼™]+ä¸ç›®[0-9ï¼-ï¼™\-âˆ’]+[^\/\@\?]*)/
                ];
                
                for (const pattern of addressPatterns) {
                    const match = decodedUrl.match(pattern);
                    if (match) {
                        let extractedAddress = match[1]
                            .replace(/[\+_]/g, ' ')
                            .replace(/\s+/g, '')
                            .trim();
                        
                        // éƒµä¾¿ç•ªå·ã¨æ„›çŸ¥çœŒã‚’é™¤å»
                        extractedAddress = extractedAddress.replace(/ã€’?\d{3}-?\d{4}/g, '');
                        extractedAddress = extractedAddress.replace(/æ„›çŸ¥çœŒ/g, '');
                        
                        console.log('URLã‹ã‚‰æŠ½å‡ºã•ã‚ŒãŸä½æ‰€:', extractedAddress);
                        
                        if (extractedAddress.length > 5) {
                            addressField.value = extractedAddress;
                            console.log('ä½æ‰€ã‚’è¨­å®š:', extractedAddress);
                            return extractedAddress;
                        }
                    }
                }
                
                // æœ€çµ‚çš„ã«åº—èˆ—åã‚’ä½æ‰€ã¨ã—ã¦ä½¿ç”¨
                let fallbackAddress = placeName;
                console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½æ‰€:', fallbackAddress);
                addressField.value = fallbackAddress;
                return fallbackAddress;
                
            } catch (error) {
                console.error('ä½æ‰€æŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }
        
        // ä½æ‰€ã§æ¤œç´¢ã—ã¦åº§æ¨™ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆä½æ‰€ã«åŸºã¥ãåœ°å›³æ¤œç´¢ï¼‰
        async function searchAddressAndSetCoordinates(searchQuery) {
            try {
                console.log('=== ä½æ‰€ã«ã‚ˆã‚‹åœ°å›³æ¤œç´¢ã‚’å®Ÿè¡Œ ===');
                console.log('æ¤œç´¢ã‚¯ã‚¨ãƒª:', searchQuery);
                
                // OpenStreetMap Nominatimæ¤œç´¢API (forward geocoding)
                const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&accept-language=ja&limit=5&countrycodes=jp`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(searchUrl)}`;
                
                console.log('æ¤œç´¢API URL:', searchUrl);
                
                const response = await fetch(proxyUrl);
                const proxyData = await response.json();
                const searchResults = JSON.parse(proxyData.contents);
                
                console.log('ä½æ‰€æ¤œç´¢çµæœ:', searchResults);
                
                if (searchResults && searchResults.length > 0) {
                    // æœ€ã‚‚é©åˆ‡ãªçµæœã‚’é¸æŠï¼ˆåå¤å±‹å¸‚å†…ã‚’å„ªå…ˆï¼‰
                    let bestResult = null;
                    for (const result of searchResults) {
                        if (result.display_name.includes('åå¤å±‹å¸‚')) {
                            bestResult = result;
                            break;
                        }
                    }
                    
                    // åå¤å±‹å¸‚å†…ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€åˆã®çµæœã‚’ä½¿ç”¨
                    if (!bestResult) {
                        bestResult = searchResults[0];
                    }
                    
                    const lat = parseFloat(bestResult.lat);
                    const lng = parseFloat(bestResult.lon);
                    
                    // åº§æ¨™ã‚’å°æ•°ç¬¬4ä½ã«å››æ¨äº”å…¥
                    const roundedLat = Math.round(lat * 10000) / 10000;
                    const roundedLng = Math.round(lng * 10000) / 10000;
                    
                    console.log('ä½æ‰€æ¤œç´¢ã§å–å¾—ã—ãŸåº§æ¨™:', roundedLat, roundedLng);
                    console.log('ã“ã®åº§æ¨™ã§åœ°å›³ã«ãƒ”ãƒ³ã‚’è¨­å®šã—ã¾ã™');
                    
                    // åº§æ¨™ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è¨­å®šï¼ˆåœ°å›³ã®ãƒ”ãƒ³ä½ç½®ã¨ã—ã¦ä½¿ç”¨ï¼‰
                    document.getElementById('storeLat').value = roundedLat;
                    document.getElementById('storeLng').value = roundedLng;
                    
                    console.log('ä½æ‰€ã«ã‚ˆã‚‹åœ°å›³æ¤œç´¢ãŒæˆåŠŸã—ã¾ã—ãŸ');
                    return true;
                    
                } else {
                    console.log('ä½æ‰€æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    return false;
                }
                
            } catch (error) {
                console.error('ä½æ‰€æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }
        
        function extractStoreNameFromUrl(url) {
            try {
                const storeNameField = document.getElementById('storeName');
                
                // åº—èˆ—åãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç©ºã®å ´åˆã®ã¿æŠ½å‡º
                if (!storeNameField.value && url.includes('/place/')) {
                    // URLã‹ã‚‰åº—èˆ—åéƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆ/place/ã®å¾Œã®éƒ¨åˆ†ï¼‰
                    const placeMatch = url.match(/\/place\/([^\/\@\?]+)/);
                    if (placeMatch) {
                        let storeName = decodeURIComponent(placeMatch[1]);
                        
                        // URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ—¥æœ¬èªã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
                        storeName = storeName.replace(/\+/g, ' ').trim();
                        
                        // åº—èˆ—åã¨ã—ã¦é©åˆ‡ã§ãªã„æ–‡å­—åˆ—ã¯é™¤å¤–
                        if (storeName && storeName.length > 0 && !storeName.match(/^\d+[\d\.,]*$/)) {
                            storeNameField.value = storeName;
                        }
                    }
                }
            } catch (error) {
                console.log('åº—èˆ—åæŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ä½æ‰€ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°ï¼ˆæœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
        function processAddressData(data) {
            const addressField = document.getElementById('storeAddress');
            console.log('=== æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½æ‰€å‡¦ç†é–‹å§‹ ===');
            console.log('ç¾åœ¨ã®ä½æ‰€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤:', addressField.value);
            
            // æ–°æ–¹å¼ã§æ—¢ã«ä½æ‰€ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (addressField.value && addressField.value.length > 5) {
                console.log('ä½æ‰€ãŒæ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }
            
            console.log('å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿å…¨ä½“:', data);
            
            // display_nameã‚’ä½¿ç”¨ã—ãŸã‚·ãƒ³ãƒ—ãƒ«ãªä½æ‰€æ§‹ç¯‰
            const displayName = data.display_name;
            console.log('display_name:', displayName);
            
            if (displayName) {
                // ã‚«ãƒ³ãƒã§åˆ†å‰²ã—ã¦å‡¦ç†
                const parts = displayName.split(',').map(s => s.trim());
                console.log('ä½æ‰€ãƒ‘ãƒ¼ãƒ„:', parts);
                
                // éƒµä¾¿ç•ªå·ã€æ„›çŸ¥çœŒã€æ—¥æœ¬ã‚’é™¤å»
                const filteredParts = parts.filter(part => 
                    !part.match(/^æ—¥æœ¬$/) && 
                    !part.match(/^æ„›çŸ¥çœŒ$/) && 
                    !part.match(/^\d{3}-?\d{4}$/)
                );
                
                // æœ€åˆã®2-3ã¤ã®ãƒ‘ãƒ¼ãƒ„ã‚’ä½¿ç”¨
                let finalAddress = filteredParts.slice(0, 3).join('').replace(/\s+/g, '');
                
                // éƒµä¾¿ç•ªå·ã¨æ„›çŸ¥çœŒã‚’é™¤å»
                finalAddress = finalAddress.replace(/ã€’?\d{3}-?\d{4}/g, '');
                finalAddress = finalAddress.replace(/æ„›çŸ¥çœŒ/g, '');
                
                console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½æ‰€:', finalAddress);
                if (finalAddress && finalAddress.length > 3) {
                    addressField.value = finalAddress;
                    console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½æ‰€ã‚’ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š:', addressField.value);
                }
            }
        }
        
        // åº§æ¨™ã‹ã‚‰ä½æ‰€ã‚’å–å¾—
        async function getAddressFromCoordinates(lat, lng) {
            try {
                // CORSãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã—ã¦OpenStreetMap Nominatim APIã«ã‚¢ã‚¯ã‚»ã‚¹
                // ã‚ˆã‚Šè©³ç´°ãªä½æ‰€ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´
                const apiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ja&zoom=18&addressdetails=1&extratags=1&namedetails=1`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`;
                
                console.log('API URL:', apiUrl); // ãƒ‡ãƒãƒƒã‚°ç”¨
                console.log('ãƒ—ãƒ­ã‚­ã‚· URL:', proxyUrl); // ãƒ‡ãƒãƒƒã‚°ç”¨
                
                const response = await fetch(proxyUrl);
                const proxyData = await response.json();
                const data = JSON.parse(proxyData.contents);
                
                console.log('ä½æ‰€å–å¾—APIå¿œç­”:', data); // ãƒ‡ãƒãƒƒã‚°ç”¨
                
                if (data && data.address) {
                    processAddressData(data);
                } else {
                    console.log('ä½æ‰€ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'); // ãƒ‡ãƒãƒƒã‚°ç”¨
                }
            } catch (error) {
                console.log('ä½æ‰€å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥APIã‚’è©¦ã™ï¼ˆCORSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŒï¼‰
                try {
                    console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥APIå‘¼ã³å‡ºã—ã‚’è©¦è¡Œ'); // ãƒ‡ãƒãƒƒã‚°ç”¨
                    const directResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ja&zoom=18&addressdetails=1`);
                    const directData = await directResponse.json();
                    
                    if (directData && directData.address) {
                        // åŒã˜ä½æ‰€å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’é©ç”¨
                        processAddressData(directData);
                    }
                } catch (directError) {
                    console.log('ç›´æ¥APIå‘¼ã³å‡ºã—ã‚‚å¤±æ•—:', directError);
                    showStatus('ä½æ‰€ã®è‡ªå‹•å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                }
            }
        }
        
        // åº§æ¨™å…¥åŠ›æ™‚ã®å‡¦ç†
        function handleCoordinateChange() {
            const lat = document.getElementById('storeLat').value;
            const lng = document.getElementById('storeLng').value;
            
            if (lat && lng) {
                // ä¸¡æ–¹ã®åº§æ¨™ãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰ä½æ‰€å–å¾—ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                document.getElementById('addressBtn').disabled = false;
            }
        }
        
        // åº§æ¨™ã‹ã‚‰ä½æ‰€ã‚’å–å¾—ã™ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
        async function extractAddressFromCoordinates() {
            let lat = parseFloat(document.getElementById('storeLat').value);
            let lng = parseFloat(document.getElementById('storeLng').value);
            
            if (!lat || !lng) {
                showStatus('ç·¯åº¦ã¨çµŒåº¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // åº§æ¨™ã‚’å°æ•°ç¬¬4ä½ã«å››æ¨äº”å…¥
            lat = Math.round(lat * 10000) / 10000;
            lng = Math.round(lng * 10000) / 10000;
            
            // å››æ¨äº”å…¥ã—ãŸå€¤ã‚’ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ 
            document.getElementById('storeLat').value = lat;
            document.getElementById('storeLng').value = lng;
            
            const addressBtn = document.getElementById('addressBtn');
            addressBtn.textContent = 'ğŸ”„ ä½æ‰€ã‚’å–å¾—ä¸­...';
            addressBtn.disabled = true;
            
            await getAddressFromCoordinates(lat, lng);
            
            addressBtn.textContent = 'ğŸ“ åº§æ¨™ã‹ã‚‰ä½æ‰€ã‚’å–å¾—';
            addressBtn.disabled = false;
            showStatus('ä½æ‰€ã‚’å–å¾—ã—ã¾ã—ãŸ', 'success');
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
        
        // è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é–¢é€£ã®é–¢æ•°
        function getVisitStatusBadgeHTML(status) {
            // æœªå…¥åŠ›æ™‚ã¯è‡ªå‹•çš„ã«ã€Œæœªç¢ºèªåº—èˆ—ã€ã¨ã—ã¦è¡¨ç¤º
            if (!status || status === '') {
                status = 'unvisited';
            }
            
            switch (status) {
                case 'naco':
                    return '<span style="background-color: rgba(255, 0, 0, 0.1); color: #d32f2f; padding: 4px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;">ğŸ”´ nacoè¨ªå•æ¸ˆã¿</span>';
                case 'member':
                    return '<span style="background-color: rgba(255, 193, 7, 0.1); color: #f57c00; padding: 4px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;">ğŸŸ¡ ãƒ¡ãƒ³ãƒãƒ¼è¨ªå•æ¸ˆã¿</span>';
                case 'unvisited':
                    return '<span style="background-color: rgba(158, 158, 158, 0.1); color: #616161; padding: 4px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;">ğŸ¤ æœªç¢ºèªåº—èˆ—</span>';
                default:
                    return '<span style="color: #999;">ä¸æ˜</span>';
            }
        }
        
        // è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showVisitStatusModal() {
            if (!storesData || storesData.length === 0) {
                alert('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ã€Œæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«HTML ã‚’å‹•çš„ã«ä½œæˆã—ã¦è¡¨ç¤º
            const modalHTML = `
                <div id="visitStatusModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 1000px; max-height: 80vh; overflow-y: auto;">
                        <span class="close-btn" onclick="closeVisitStatusModal()">&times;</span>
                        <h2>ğŸ† è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†</h2>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h3>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®èª¬æ˜</h3>
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div><strong>ğŸ”´ nacoè¨ªå•æ¸ˆã¿</strong><br>nacoãŒå®Ÿéš›ã«è¨ªå•ã—ã€ç¢ºèªæ¸ˆã¿ã®åº—èˆ—ï¼ˆæœ€é«˜ä¿¡é ¼åº¦ï¼‰</div>
                                <div><strong>ğŸŸ¡ ãƒ¡ãƒ³ãƒãƒ¼è¨ªå•æ¸ˆã¿</strong><br>ãƒ“ãƒ¨ã‚°ãƒ«å€¶æ¥½éƒ¨ãƒ¡ãƒ³ãƒãƒ¼ãŒè¨ªå•ã—ã€ç¢ºèªæ¸ˆã¿ã®åº—èˆ—ï¼ˆä¿¡é ¼æ¸ˆã¿ï¼‰</div>
                                <div><strong>ğŸ¤ æœªç¢ºèªåº—èˆ—</strong><br>ã¾ã èª°ã‚‚è¨ªå•ã—ã¦ã„ãªã„ã€ã¾ãŸã¯ç¢ºèªãŒå¿…è¦ãªåº—èˆ—</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                            <h3>ä¸€æ‹¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°</h3>
                            <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label>ã™ã¹ã¦ã®åº—èˆ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´:</label>
                                    <select id="bulkStatus" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                        <option value="naco">ğŸ”´ nacoè¨ªå•æ¸ˆã¿</option>
                                        <option value="member">ğŸŸ¡ ãƒ¡ãƒ³ãƒãƒ¼è¨ªå•æ¸ˆã¿</option>
                                        <option value="unvisited">ğŸ¤ æœªç¢ºèªåº—èˆ—</option>
                                    </select>
                                </div>
                                <div style="flex: 1; min-width: 150px;">
                                    <label>ç¢ºèªè€…:</label>
                                    <input type="text" id="bulkChecker" placeholder="ç¢ºèªè€…åã‚’å…¥åŠ›" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                </div>
                                <button class="btn" onclick="bulkUpdateVisitStatus()" style="background-color: #2196f3;">ä¸€æ‹¬æ›´æ–°</button>
                            </div>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                            <thead>
                                <tr style="background-color: #f5f5f5;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">åº—èˆ—å</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">ç¢ºèªè€…</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="visitStatusTableBody"></tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ body ã«è¿½åŠ 
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
            renderVisitStatusTable();
        }
        
        // è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
        function renderVisitStatusTable() {
            const tbody = document.getElementById('visitStatusTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            storesData.forEach(store => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #ddd';
                row.innerHTML = `
                    <td style="padding: 12px;">
                        <strong>${store.name}</strong><br>
                        <small style="color: #666;">${store.address}</small>
                    </td>
                    <td style="padding: 12px;">
                        <span style="background: #98d8c8; color: white; padding: 2px 6px; border-radius: 8px; font-size: 11px;">${store.category}</span>
                    </td>
                    <td style="padding: 12px;">
                        ${getVisitStatusBadgeHTML(store.visitStatus)}
                        ${store.checkedBy ? `<br><small>ç¢ºèªè€…: ${store.checkedBy}</small>` : ''}
                        ${store.lastUpdate ? `<br><small>æ›´æ–°: ${store.lastUpdate}</small>` : ''}
                    </td>
                    <td style="padding: 12px;">
                        <select id="status-${store.id}" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 100%;">
                            <option value="">å¤‰æ›´ã—ãªã„</option>
                            <option value="naco" ${store.visitStatus === 'naco' ? 'selected' : ''}>ğŸ”´ nacoè¨ªå•æ¸ˆã¿</option>
                            <option value="member" ${store.visitStatus === 'member' ? 'selected' : ''}>ğŸŸ¡ ãƒ¡ãƒ³ãƒãƒ¼è¨ªå•æ¸ˆã¿</option>
                            <option value="unvisited" ${store.visitStatus === 'unvisited' ? 'selected' : ''}>ğŸ¤ æœªç¢ºèªåº—èˆ—</option>
                        </select>
                    </td>
                    <td style="padding: 12px;">
                        <input type="text" id="checker-${store.id}" placeholder="ç¢ºèªè€…å" value="${store.checkedBy || ''}" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                    </td>
                    <td style="padding: 12px;">
                        <button class="btn" onclick="updateStoreVisitStatus(${store.id})" style="padding: 4px 8px; font-size: 12px;">æ›´æ–°</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // å€‹åˆ¥åº—èˆ—ã®è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStoreVisitStatus(storeId) {
            const statusSelect = document.getElementById(`status-${storeId}`);
            const checkerInput = document.getElementById(`checker-${storeId}`);
            
            if (!statusSelect || !checkerInput) {
                alert('è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const newStatus = statusSelect.value;
            const checkerName = checkerInput.value.trim();
            
            if (!newStatus) {
                alert('æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!checkerName) {
                alert('ç¢ºèªè€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // storesDataå†…ã®è©²å½“åº—èˆ—ã‚’æ›´æ–°
            const store = storesData.find(s => s.id === storeId);
            if (store) {
                store.visitStatus = newStatus;
                store.checkedBy = checkerName;
                store.lastUpdate = new Date().toISOString().substring(0, 7); // YYYY-MMå½¢å¼
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
                renderStoreTable();
                renderVisitStatusTable();
                
                showStatus(`${store.name}ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
            } else {
                alert('åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }
        
        // ä¸€æ‹¬è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function bulkUpdateVisitStatus() {
            const bulkStatus = document.getElementById('bulkStatus').value;
            const bulkChecker = document.getElementById('bulkChecker').value.trim();
            
            if (!bulkStatus) {
                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!bulkChecker) {
                alert('ç¢ºèªè€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!confirm(`å…¨${storesData.length}ä»¶ã®åº—èˆ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${getStatusDisplayName(bulkStatus)}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            const currentDate = new Date().toISOString().substring(0, 7);
            
            storesData.forEach(store => {
                store.visitStatus = bulkStatus;
                store.checkedBy = bulkChecker;
                store.lastUpdate = currentDate;
            });
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
            renderStoreTable();
            renderVisitStatusTable();
            
            showStatus(`å…¨${storesData.length}ä»¶ã®åº—èˆ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¸€æ‹¬æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('bulkStatus').value = '';
            document.getElementById('bulkChecker').value = '';
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºåã‚’å–å¾—
        function getStatusDisplayName(status) {
            switch (status) {
                case 'naco': return 'ğŸ”´ nacoè¨ªå•æ¸ˆã¿';
                case 'member': return 'ğŸŸ¡ ãƒ¡ãƒ³ãƒãƒ¼è¨ªå•æ¸ˆã¿';
                case 'unvisited': return 'ğŸ¤ æœªç¢ºèªåº—èˆ—';
                default: return 'ä¸æ˜';
            }
        }
        
        // è¨ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeVisitStatusModal() {
            const modal = document.getElementById('visitStatusModal');
            if (modal) {
                modal.remove();
            }
        }

        // ===== CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ =====

        // CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showCSVUploadModal() {
            document.getElementById('csvUploadModal').style.display = 'block';
            resetCSVUploadForm();
        }

        // CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeCSVUploadModal() {
            document.getElementById('csvUploadModal').style.display = 'none';
            resetCSVUploadForm();
        }

        // CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        function resetCSVUploadForm() {
            document.getElementById('csvFileInput').value = '';
            document.getElementById('selectedFileName').textContent = '';
            document.getElementById('csvImportBtn').disabled = true;
            document.getElementById('csvPreview').style.display = 'none';
            document.querySelector('input[name="csvImportMode"][value="add"]').checked = true;
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
        function handleCSVFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('CSVãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ:', file.name, file.size, 'bytes');
            
            document.getElementById('selectedFileName').textContent = `é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                showCSVPreview(csvText);
                document.getElementById('csvImportBtn').disabled = false;
            };
            reader.readAsText(file, 'UTF-8');
        }

        // CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        function showCSVPreview(csvText) {
            try {
                const rows = parseCSV(csvText);
                const preview = rows.slice(0, 3).map((row, index) => {
                    const rowType = index === 0 ? '[ãƒ˜ãƒƒãƒ€ãƒ¼]' : index === 1 ? '[æŒ‡ç¤ºè¡Œ]' : '[ãƒ‡ãƒ¼ã‚¿]';
                    return `${rowType} ${row.join(' | ')}`;
                }).join('\n');
                
                document.getElementById('csvPreviewContent').textContent = preview;
                document.getElementById('csvPreview').style.display = 'block';
                
                console.log('CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆå®Œäº†:', rows.length, 'è¡Œ');
            } catch (error) {
                console.error('CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        async function importCSVFile() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const importMode = document.querySelector('input[name="csvImportMode"]:checked').value;
            const replaceMode = importMode === 'replace';

            try {
                showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'success');
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const csvText = e.target.result;
                        const rows = parseCSV(csvText);
                        
                        console.log('CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:', rows.length, 'è¡Œ');
                        
                        if (rows.length < 3) {
                            throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆ3è¡Œä»¥ä¸Šå¿…è¦ï¼‰');
                        }

                        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›
                        const importedStores = convertCSVToStores(rows);
                        console.log('å¤‰æ›å®Œäº†:', importedStores.length, 'ä»¶ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿');

                        if (importedStores.length === 0) {
                            throw new Error('æœ‰åŠ¹ãªåº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                        }

                        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
                        await executeCSVImport(importedStores, replaceMode);
                        
                        closeCSVUploadModal();
                        
                    } catch (error) {
                        console.error('CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                        showStatus(`CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
                    }
                };
                
                reader.readAsText(file, 'UTF-8');
                
            } catch (error) {
                console.error('CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showStatus(`CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }

        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œ
        async function executeCSVImport(importedStores, replaceMode) {
            let addedCount = 0;
            
            if (replaceMode) {
                // ç½®ãæ›ãˆãƒ¢ãƒ¼ãƒ‰
                if (!confirm(`âš ï¸ æ—¢å­˜ã®${storesData.length}ä»¶ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€${importedStores.length}ä»¶ã®æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§ç½®ãæ›ãˆã¾ã™ã‹ï¼Ÿ`)) {
                    return;
                }
                
                storesData = importedStores.map((store, index) => {
                    store.id = index + 1;
                    return store;
                });
                addedCount = importedStores.length;
                
                showStatus(`CSVã‹ã‚‰${importedStores.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç½®ãæ›ãˆã¾ã—ãŸã€‚ä¿å­˜ã™ã‚‹å ´åˆã¯ã€ŒGitHubã«ç›´æ¥ä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`, 'success');
                
            } else {
                // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
                const maxId = Math.max(...storesData.map(s => s.id), 0);
                
                importedStores.forEach((newStore, index) => {
                    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåº—èˆ—å + ä½æ‰€ï¼‰
                    const isDuplicate = storesData.some(existingStore => 
                        existingStore.name === newStore.name && 
                        existingStore.address === newStore.address
                    );
                    
                    if (!isDuplicate) {
                        newStore.id = maxId + addedCount + 1;
                        storesData.push(newStore);
                        addedCount++;
                        console.log(`åº—èˆ—è¿½åŠ : ${newStore.name} (ID: ${newStore.id})`);
                    } else {
                        console.log(`é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—: ${newStore.name}`);
                    }
                });
                
                if (addedCount === 0) {
                    showStatus(`CSVã‹ã‚‰${importedStores.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¾ã—ãŸãŒã€ã™ã¹ã¦é‡è¤‡ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚`, 'warning');
                } else if (addedCount < importedStores.length) {
                    showStatus(`CSVã‹ã‚‰${addedCount}ä»¶ã®æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆé‡è¤‡${importedStores.length - addedCount}ä»¶ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰ã€‚ä¿å­˜ã™ã‚‹å ´åˆã¯ã€ŒGitHubã«ç›´æ¥ä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`, 'success');
                } else {
                    showStatus(`CSVã‹ã‚‰${addedCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ä¿å­˜ã™ã‚‹å ´åˆã¯ã€ŒGitHubã«ç›´æ¥ä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`, 'success');
                }
            }
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
            renderTable();
        }
        
    </script>
</body>
</html>