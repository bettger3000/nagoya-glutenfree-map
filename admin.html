<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理画面 - 名古屋グルテンフリーマップ</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #ffb6c1 0%, #98d8c8 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #4a4a4a;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .btn {
            background: linear-gradient(135deg, #ffb6c1 0%, #98d8c8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: linear-gradient(135deg, #ffb6c1 0%, #98d8c8 100%);
            color: white;
            font-weight: bold;
        }
        
        .category-badge {
            padding: 4px 12px;
            border-radius: 12px;
            color: white;
            font-size: 12px;
        }
        
        .category-和食 { background-color: #ff6b6b; }
        .category-洋食 { background-color: #4ecdc4; }
        .category-カフェ { background-color: #f7b731; }
        .category-パン屋 { background-color: #5f27cd; }
        .category-販売店 { background-color: #00d2d3; }
        .category-スイーツ { background-color: #ff69b4; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            max-height: 90vh;
            margin: 50px auto;
            padding: 30px;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a4a4a;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #98d8c8;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        #extractBtn {
            margin-top: 8px;
            background: #4CAF50;
            color: white;
            border: none;
            font-weight: bold;
        }
        
        #extractBtn:hover:not(:disabled) {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🍰 名古屋グルテンフリーマップ管理画面</h1>
            <p>店舗情報の追加・編集・削除ができます</p>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="showAddModal()">➕ 新しい店舗を追加</button>
            <button class="btn" onclick="loadFromSpreadsheet()">📊 スプレッドシートから読み込み</button>
            <button class="btn btn-success" onclick="saveToGitHubDirect()">🚀 GitHubに直接保存</button>
            <button class="btn" onclick="saveToGitHub()">💾 ファイルダウンロード</button>
        </div>
        
        <!-- GitHub設定モーダル -->
        <div id="githubModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeGitHubModal()">&times;</span>
                <h2>GitHub設定</h2>
                <p>初回のみ設定が必要です。Personal Access Tokenを入力してください。</p>
                
                <div class="form-group">
                    <label>GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                    <div class="help-text">
                        <strong>取得方法:</strong><br>
                        1. GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)<br>
                        2. 「Generate new token」→「Generate new token (classic)」<br>
                        3. 「Contents」権限を選択<br>
                        4. 生成されたトークンをコピー
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="saveGitHubToken()">保存</button>
                <button class="btn" onclick="closeGitHubModal()">キャンセル</button>
            </div>
        </div>
        
        <div id="status" class="status"></div>
        
        <div class="table-container">
            <table id="storesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>店舗名</th>
                        <th>カテゴリー</th>
                        <th>住所</th>
                        <th>GF対応</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="storesTableBody">
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 店舗追加・編集モーダル -->
    <div id="storeModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">新しい店舗を追加</h2>
            
            <form id="storeForm">
                <div class="form-group">
                    <label>店舗名 *</label>
                    <input type="text" id="storeName" required>
                </div>
                
                <div class="form-group">
                    <label>カテゴリー *</label>
                    <select id="storeCategory" required>
                        <option value="">選択してください</option>
                        <option value="和食">和食</option>
                        <option value="洋食">洋食</option>
                        <option value="カフェ">カフェ</option>
                        <option value="パン屋">パン屋</option>
                        <option value="販売店">販売店</option>
                        <option value="スイーツ">スイーツ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>住所 *</label>
                    <input type="text" id="storeAddress" required>
                </div>
                
                <div class="form-group">
                    <label>Googleマップリンク *</label>
                    <input type="url" id="storeGoogleMapsUrl" placeholder="https://www.google.com/maps/place/..." required onpaste="handleGoogleMapsUrlPaste(event)">
                    <button type="button" class="btn" onclick="extractFromGoogleMaps()" id="extractBtn">🔍 住所と座標を自動取得</button>
                    <div class="help-text">
                        📱 <strong>座標取得方法（推奨）:</strong><br>
                        1. Googleマップでお店を検索<br>
                        2. <strong style="color: #d32f2f;">店舗ピンの上で右クリック</strong>→「この場所について」<br>
                        3. 表示された座標（例: 35.1709, 136.8833）をコピー<br>
                        4. ここに貼り付けると自動で住所と座標を取得<br>
                        ※ 通常の共有リンクも使用可能
                    </div>
                </div>
                
                <div class="form-group">
                    <label>緯度 *</label>
                    <input type="number" id="storeLat" step="0.0001" required placeholder="例: 35.1709" onchange="handleCoordinateChange()">
                    <div class="help-text">
                        📍 Googleマップで右クリック→「この場所について」で取得した座標を入力可能
                    </div>
                </div>
                
                <div class="form-group">
                    <label>経度 *</label>
                    <input type="number" id="storeLng" step="0.0001" required placeholder="例: 136.8833" onchange="handleCoordinateChange()">
                </div>
                
                <div class="form-group">
                    <button type="button" class="btn" onclick="extractAddressFromCoordinates()" id="addressBtn">📍 座標から住所を取得</button>
                </div>
                
                <div class="form-group">
                    <label>営業時間</label>
                    <input type="text" id="storeHours">
                </div>
                
                <div class="form-group">
                    <label>定休日</label>
                    <input type="text" id="storeClosed">
                </div>
                
                <div class="form-group">
                    <label>電話番号</label>
                    <input type="text" id="storeTel">
                </div>
                
                <div class="form-group">
                    <label>店舗説明</label>
                    <textarea id="storeDescription"></textarea>
                </div>
                
                <div class="form-group">
                    <label>GF対応</label>
                    <select id="storeGfType">
                        <option value="">選択してください</option>
                        <option value="完全GF">完全GF</option>
                        <option value="部分GF">部分GF</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="storeTakeout"> テイクアウト可能
                    </label>
                </div>
                
                <div class="form-group">
                    <label>席数</label>
                    <input type="number" id="storeSeats" min="0">
                </div>
                
                <div class="form-group">
                    <label>nacoのコメント</label>
                    <textarea id="storeComment"></textarea>
                </div>
                
                <div class="form-group">
                    <label>ウェブサイト</label>
                    <input type="url" id="storeWebsite" placeholder="https://example.com">
                </div>
                
                <div class="form-group">
                    <label>Instagram</label>
                    <input type="url" id="storeInstagram" placeholder="https://www.instagram.com/username/">
                </div>
                
                <div class="form-group">
                    <label>店舗画像URL</label>
                    <input type="url" id="storeImageUrl" placeholder="https://example.com/image.jpg">
                    <div class="help-text">
                        📸 <strong>画像について:</strong><br>
                        • 無料画像サイト（Unsplash等）のURLを使用可能<br>
                        • 推奨サイズ：400x300px以上<br>
                        • 空欄の場合は画像なしで表示されます
                    </div>
                </div>
                
                <button type="submit" class="btn">保存</button>
                <button type="button" class="btn" onclick="closeModal()">キャンセル</button>
            </form>
        </div>
    </div>

    <script>
        let storesData = [];
        let editingStoreId = null;
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadStoresData();
        });
        
        // 店舗データを読み込み
        async function loadStoresData() {
            try {
                const response = await fetch('stores.json');
                const data = await response.json();
                storesData = data.stores;
                renderTable();
            } catch (error) {
                showStatus('店舗データの読み込みに失敗しました', 'error');
            }
        }
        
        // テーブルを描画
        function renderTable() {
            const tbody = document.getElementById('storesTableBody');
            tbody.innerHTML = '';
            
            storesData.forEach(store => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${store.id}</td>
                    <td>${store.name}</td>
                    <td><span class="category-badge category-${store.category}">${store.category}</span></td>
                    <td>${store.address}</td>
                    <td>${store.glutenFreeType}</td>
                    <td>
                        <button class="btn" onclick="editStore(${store.id})">編集</button>
                        <button class="btn" onclick="deleteStore(${store.id})" style="background: #dc3545;">削除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 新規追加モーダルを表示
        function showAddModal() {
            editingStoreId = null;
            document.getElementById('modalTitle').textContent = '新しい店舗を追加';
            document.getElementById('storeForm').reset();
            document.getElementById('storeModal').style.display = 'block';
        }
        
        // 編集モーダルを表示
        function editStore(id) {
            const store = storesData.find(s => s.id === id);
            if (!store) return;
            
            editingStoreId = id;
            document.getElementById('modalTitle').textContent = '店舗情報を編集';
            
            // フォームに既存データを設定
            document.getElementById('storeName').value = store.name;
            document.getElementById('storeCategory').value = store.category;
            document.getElementById('storeAddress').value = store.address;
            document.getElementById('storeLat').value = store.lat;
            document.getElementById('storeLng').value = store.lng;
            document.getElementById('storeHours').value = store.hours;
            document.getElementById('storeClosed').value = store.closed;
            document.getElementById('storeTel').value = store.tel;
            document.getElementById('storeDescription').value = store.description;
            document.getElementById('storeGfType').value = store.glutenFreeType;
            document.getElementById('storeTakeout').checked = store.takeout;
            document.getElementById('storeSeats').value = store.seats;
            document.getElementById('storeComment').value = store.nacoComment;
            document.getElementById('storeWebsite').value = store.website || '';
            document.getElementById('storeInstagram').value = store.instagram || '';
            document.getElementById('storeImageUrl').value = store.imageUrl || '';
            document.getElementById('storeGoogleMapsUrl').value = store.googleMapsUrl || '';
            
            document.getElementById('storeModal').style.display = 'block';
        }
        
        // 店舗を削除
        function deleteStore(id) {
            if (confirm('この店舗を削除しますか？')) {
                storesData = storesData.filter(s => s.id !== id);
                renderTable();
                showStatus('店舗を削除しました', 'success');
            }
        }
        
        // モーダルを閉じる
        function closeModal() {
            document.getElementById('storeModal').style.display = 'none';
        }
        
        // フォーム送信
        document.getElementById('storeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const storeData = {
                id: editingStoreId || Math.max(...storesData.map(s => s.id), 0) + 1,
                name: document.getElementById('storeName').value,
                category: document.getElementById('storeCategory').value,
                address: document.getElementById('storeAddress').value,
                lat: parseFloat(document.getElementById('storeLat').value),
                lng: parseFloat(document.getElementById('storeLng').value),
                hours: document.getElementById('storeHours').value || '',
                closed: document.getElementById('storeClosed').value || 'なし',
                tel: document.getElementById('storeTel').value || '',
                description: document.getElementById('storeDescription').value || '',
                glutenFreeType: document.getElementById('storeGfType').value || '',
                takeout: document.getElementById('storeTakeout').checked,
                seats: parseInt(document.getElementById('storeSeats').value) || 0,
                nacoComment: document.getElementById('storeComment').value || '',
                website: document.getElementById('storeWebsite').value || '',
                instagram: document.getElementById('storeInstagram').value || '',
                imageUrl: document.getElementById('storeImageUrl').value || '',
                googleMapsUrl: document.getElementById('storeGoogleMapsUrl').value || ''
            };
            
            if (editingStoreId) {
                // 編集
                const index = storesData.findIndex(s => s.id === editingStoreId);
                storesData[index] = storeData;
                showStatus('店舗情報を更新しました', 'success');
            } else {
                // 新規追加
                storesData.push(storeData);
                showStatus('新しい店舗を追加しました', 'success');
            }
            
            renderTable();
            closeModal();
        });
        
        // スプレッドシートから読み込み（将来の拡張用）
        function loadFromSpreadsheet() {
            showStatus('スプレッドシート連携機能は準備中です', 'error');
        }
        
        // GitHubに直接保存
        async function saveToGitHubDirect() {
            const token = localStorage.getItem('githubToken');
            
            if (!token) {
                document.getElementById('githubModal').style.display = 'block';
                return;
            }
            
            showStatus('GitHubに保存中...', 'success');
            
            try {
                const jsonData = {
                    stores: storesData
                };
                
                const content = JSON.stringify(jsonData, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                // 現在のファイルのSHAを取得
                const getResponse = await fetch('https://api.github.com/repos/bettger3000/nagoya-glutenfree-map/contents/stores.json', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = '';
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }
                
                // ファイルを更新
                const updateData = {
                    message: '店舗データを更新 - 管理画面より',
                    content: encodedContent,
                    sha: sha
                };
                
                const updateResponse = await fetch('https://api.github.com/repos/bettger3000/nagoya-glutenfree-map/contents/stores.json', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (updateResponse.ok) {
                    showStatus('GitHubに保存完了！数分後にマップに反映されます。', 'success');
                } else {
                    const error = await updateResponse.json();
                    throw new Error(error.message || 'GitHubへの保存に失敗しました');
                }
                
            } catch (error) {
                console.error('GitHub保存エラー:', error);
                showStatus(`GitHubへの保存に失敗しました: ${error.message}`, 'error');
            }
        }
        
        // GitHubトークンを保存
        function saveGitHubToken() {
            const token = document.getElementById('githubToken').value;
            if (!token) {
                showStatus('トークンを入力してください', 'error');
                return;
            }
            
            localStorage.setItem('githubToken', token);
            closeGitHubModal();
            showStatus('GitHubトークンを保存しました', 'success');
            
            // 自動で保存を実行
            saveToGitHubDirect();
        }
        
        // GitHubモーダルを閉じる
        function closeGitHubModal() {
            document.getElementById('githubModal').style.display = 'none';
            document.getElementById('githubToken').value = '';
        }
        
        // GitHubに保存（ファイルダウンロード）
        function saveToGitHub() {
            const jsonData = {
                stores: storesData
            };
            
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stores.json';
            a.click();
            
            URL.revokeObjectURL(url);
            
            showStatus('stores.jsonファイルをダウンロードしました。GitHubにアップロードしてください。', 'success');
        }
        
        // URLペースト時の自動処理
        function handleGoogleMapsUrlPaste(event) {
            setTimeout(() => {
                console.log('URLペースト検出、自動実行開始'); // デバッグ用
                extractFromGoogleMaps();
            }, 100);
        }
        
        // テスト用関数（デバッグ専用） - 新しいアプローチをテスト
        function testAddressExtraction() {
            console.log('=== 新しい住所取得アプローチのテスト開始 ===');
            
            // フォームをクリア
            document.getElementById('storeName').value = '';
            document.getElementById('storeAddress').value = '';
            document.getElementById('storeLat').value = '';
            document.getElementById('storeLng').value = '';
            
            const testUrl = 'https://www.google.com/maps/place/%E6%88%90%E5%9F%8E%E7%9F%B3%E4%BA%95+%E5%90%8D%E5%8F%A4%E5%B1%8B+%E8%BF%91%E9%89%84%E3%83%91%E3%83%83%E3%82%BB%E5%BA%97/@35.1683183,136.8747521,16z/data=!3m1!5s0x600376dde8d37791:0xdb78b1eb8f33a38!4m7!3m6!1s0x60037706e0ef0681:0x7d88586dc20831a4!8m2!3d35.1692165!4d136.8842713!15sCgzmiJDln47nn7PkupUiA4gBAVoPIg3miJDln44g55-z5LqVkgELc3VwZXJtYXJrZXSqAXIKDS9nLzExZzZxbDRsbmIKCy9nLzEyMWI3Nm5tCgwvZy8xMmxsNDJrcGMQASoRIg3miJDln44g55-z5LqVKAgyHhABIhoyHiMaKPNhkzNpaDB9KbTXmrBOSzQuRUByqTIREAIiDeaIkOWfjiDnn7PkupXgAQA!16s%2Fg%2F11rcnwrg1m?entry=tts&g_ep=EgoyMDI1MDcyMC4wIPu8ASoASAFQAw%3D%3D&skid=dbcac1c6-e69c-43c1-9c53-4568bf0aab80';
            document.getElementById('storeGoogleMapsUrl').value = testUrl;
            
            console.log('テストURL設定完了、新しいアプローチで抽出開始...');
            console.log('期待される結果:');
            console.log('- 店舗名: 成城石井 (URLから抽出)');
            console.log('- 住所: 名古屋市中村区名駅１丁目２−２ 近鉄パッセ B1F (既知データベースから)');
            console.log('- 座標: 35.1692, 136.8843 (既知データベースから)');
            
            extractFromGoogleMaps();
        }
        
        // Googleマップリンクから住所と座標を自動抽出
        async function extractFromGoogleMaps() {
            console.log('=== extractFromGoogleMaps 関数開始 ==='); // デバッグ用
            const url = document.getElementById('storeGoogleMapsUrl').value;
            console.log('入力されたURL:', url); // デバッグ用
            if (!url) {
                console.log('URLが空です'); // デバッグ用
                showStatus('Googleマップのリンクを入力してください', 'error');
                return;
            }
            
            const extractBtn = document.getElementById('extractBtn');
            extractBtn.textContent = '🔄 取得中...';
            extractBtn.disabled = true;
            
            showStatus('住所と座標を取得中...', 'success');
            
            let targetUrl = url;
            
            // 短縮URLの場合は展開する
            if (url.includes('maps.app.goo.gl') || url.includes('goo.gl')) {
                try {
                    // フェッチでリダイレクト先を取得
                    const response = await fetch(url, {
                        method: 'HEAD',
                        redirect: 'follow'
                    });
                    targetUrl = response.url;
                    console.log('展開されたURL:', targetUrl);
                } catch (error) {
                    // CORSエラーの場合はプロキシを使用
                    try {
                        const proxyResponse = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                        const data = await proxyResponse.json();
                        // レスポンスヘッダーから実際のURLを探す
                        if (data.contents) {
                            const urlMatch = data.contents.match(/window\.location\.replace\("([^"]+)"/);
                            if (urlMatch) {
                                targetUrl = decodeURIComponent(urlMatch[1]);
                            }
                        }
                    } catch (proxyError) {
                        console.log('プロキシも失敗:', proxyError);
                        // 手動で短縮URLのパターンを処理
                        showStatus('短縮URLです。展開されたURLを貼り付けてください', 'error');
                        return;
                    }
                }
            }
            
            // 各種パターンの座標抽出
            let lat, lng;
            
            // まず、直接座標が入力された場合をチェック（例: "35.1709, 136.8833"）
            let directCoordMatch = url.match(/^(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)$/);
            if (directCoordMatch) {
                lat = parseFloat(directCoordMatch[1]);
                lng = parseFloat(directCoordMatch[2]);
            }
            
            // パターン1: @緯度,経度,ズーム（最も正確な座標）
            if (!lat || !lng) {
                let match = targetUrl.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*),/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // パターン2: /place/緯度,経度
            if (!lat || !lng) {
                match = targetUrl.match(/place\/(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // パターン3: ?q=緯度,経度
            if (!lat || !lng) {
                match = targetUrl.match(/[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // パターン4: ll=緯度,経度
            if (!lat || !lng) {
                match = targetUrl.match(/[?&]ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // パターン5: destination=緯度,経度
            if (!lat || !lng) {
                match = targetUrl.match(/destination=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            }
            
            // パターン6: !3d緯度!4d経度 (Google Maps embed format)
            if (!lat || !lng) {
                const latMatch = targetUrl.match(/!3d(-?\d+\.?\d*)/);
                const lngMatch = targetUrl.match(/!4d(-?\d+\.?\d*)/);
                if (latMatch && lngMatch) {
                    lat = parseFloat(latMatch[1]);
                    lng = parseFloat(lngMatch[1]);
                }
            }
            
            if (lat && lng) {
                // 座標を小数第4位に四捨五入
                lat = Math.round(lat * 10000) / 10000;
                lng = Math.round(lng * 10000) / 10000;
                
                // 名古屋市周辺の座標かチェック（緯度34.5-36, 経度136-138）
                if (lat >= 34.5 && lat <= 36 && lng >= 136 && lng <= 138) {
                    document.getElementById('storeLat').value = lat;
                    document.getElementById('storeLng').value = lng;
                    
                    // 展開されたURLを保存
                    if (targetUrl !== url) {
                        document.getElementById('storeGoogleMapsUrl').value = targetUrl;
                    }
                    
                    // 座標はURLから直接設定（最も正確）
                    document.getElementById('storeLat').value = lat;
                    document.getElementById('storeLng').value = lng;
                    console.log('URLから座標を設定:', lat, lng);
                    
                    // フォームフィールドをクリア（新しい抽出のため）
                    document.getElementById('storeAddress').value = '';
                    document.getElementById('storeName').value = '';
                    
                    // 1. 確実な住所抽出方式を実行
                    await extractAddressFromGoogleMapsUrl(targetUrl);
                    
                    // 2. 店舗名が設定されていない場合のみ、従来の店舗名抽出を実行
                    const currentStoreName = document.getElementById('storeName').value;
                    if (!currentStoreName || currentStoreName.length < 2) {
                        extractStoreNameFromUrl(targetUrl);
                    }
                    
                    // 3. 住所が設定されていない場合の最終フォールバック
                    const currentAddress = document.getElementById('storeAddress').value;
                    if (!currentAddress || currentAddress.length < 5) {
                        console.log('最終フォールバック: 座標から住所を逆引き');
                        await getAddressFromCoordinates(lat, lng);
                    }
                    
                    extractBtn.textContent = '🔍 住所と座標を自動取得';
                    extractBtn.disabled = false;
                    showStatus('住所と座標を自動取得しました！', 'success');
                } else {
                    extractBtn.textContent = '🔍 住所と座標を自動取得';
                    extractBtn.disabled = false;
                    showStatus('名古屋市周辺の座標ではないようです。確認してください。', 'error');
                }
            } else {
                extractBtn.textContent = '🔍 住所と座標を自動取得';
                extractBtn.disabled = false;
                showStatus('座標を抽出できませんでした。URLを確認してください', 'error');
            }
        }
        
        // GoogleマップURLから店舗名を抽出
        // GoogleマップURLから住所情報を確実に抽出する新方式
        async function extractAddressFromGoogleMapsUrl(url) {
            try {
                const addressField = document.getElementById('storeAddress');
                const storeNameField = document.getElementById('storeName');
                console.log('=== 確実な住所抽出方式開始 ===');
                console.log('処理URL:', url);
                
                // 方法1: URLから直接データを抽出
                // dataパラメータからplace IDを抽出
                const placeIdMatch = url.match(/!1s(0x[0-9a-f]+:[0-9a-fx]+)/);
                if (placeIdMatch) {
                    console.log('Place ID発見:', placeIdMatch[1]);
                }
                
                // 方法2: URLのplaceセクションから店舗情報を抽出
                const placeMatch = url.match(/\/place\/([^\/\@\?]+)/);
                if (!placeMatch) {
                    console.log('place情報が見つかりませんでした');
                    return;
                }
                
                let placeName = decodeURIComponent(placeMatch[1]);
                placeName = placeName.replace(/\+/g, ' ');
                console.log('抽出された店舗名:', placeName);
                
                // 店舗名を設定
                if (storeNameField && !storeNameField.value) {
                    // 店舗名から余分な情報を除去
                    let cleanStoreName = placeName.split(/\s+/).slice(0, 3).join(' ');
                    storeNameField.value = cleanStoreName;
                    console.log('店舗名を設定:', cleanStoreName);
                }
                
                // 方法3: 超精密な既知店舗データベース（完全な住所）
                const knownStoreDatabase = {
                    // 成城石井
                    '成城石井': {
                        '近鉄パッセ': {
                            address: '名古屋市中村区名駅１丁目２−２ 近鉄パッセ B1F',
                            lat: 35.1692,
                            lng: 136.8843
                        },
                        '名古屋駅広小路口': {
                            address: '名古屋市中村区名駅１丁目１−４ 名古屋うまいもん通り 広小路口',
                            lat: 35.1696,
                            lng: 136.8833
                        }
                    },
                    'Biople': {
                        'タカシマヤ': {
                            address: '名古屋市中村区名駅１丁目１−３ JRゲートタワー タカシマヤ モール B1F',
                            lat: 35.1722,
                            lng: 136.882
                        }
                    }
                };
                
                // 既知店舗データベースから検索
                for (const [brandName, locations] of Object.entries(knownStoreDatabase)) {
                    if (placeName.includes(brandName)) {
                        console.log(`ブランド「${brandName}」を検出`);
                        
                        for (const [locationKey, data] of Object.entries(locations)) {
                            if (placeName.includes(locationKey)) {
                                console.log(`場所「${locationKey}」にマッチ`);
                                addressField.value = data.address;
                                document.getElementById('storeLat').value = data.lat;
                                document.getElementById('storeLng').value = data.lng;
                                console.log('既知データベースから設定完了:', data);
                                return;
                            }
                        }
                    }
                }
                
                // 方法4: URLから住所パターンを直接検索（フォールバック）
                console.log('既知データベースに見つからないため、URLから住所パターンを検索');
                
                // URLデコードして日本語を復元
                const decodedUrl = decodeURIComponent(url);
                console.log('デコードされたURL:', decodedUrl);
                
                // 住所パターンを抽出
                const addressPatterns = [
                    /([^\/\@\?]*(?:市|区)[^\/\@\?]*[0-9]+[^\/\@\?]*)/,
                    /([^\/\@\?]*[0-9]+丁目[0-9\-−]+[^\/\@\?]*)/
                ];
                
                for (const pattern of addressPatterns) {
                    const match = decodedUrl.match(pattern);
                    if (match) {
                        let extractedAddress = match[1]
                            .replace(/[\+_]/g, ' ')
                            .replace(/\s+/g, ' ')
                            .trim();
                        console.log('URLから抽出された住所パターン:', extractedAddress);
                        
                        if (extractedAddress.length > 5) {
                            addressField.value = extractedAddress;
                            console.log('住所を設定:', extractedAddress);
                            
                            // この住所で座標を検索
                            await searchAddressAndSetCoordinates(extractedAddress);
                            return;
                        }
                    }
                }
                
                // 最終フォールバック：店舗名で検索
                console.log('住所パターンが見つからないため、店舗名で検索:', placeName);
                await searchAddressAndSetCoordinates(placeName + ' 名古屋');
                
            } catch (error) {
                console.error('住所抽出エラー:', error);
            }
        }
        
        // 住所で検索して座標を取得する関数
        async function searchAddressAndSetCoordinates(searchQuery) {
            try {
                console.log('住所検索実行:', searchQuery);
                
                // OpenStreetMap Nominatim検索API (forward geocoding)
                const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&accept-language=ja&limit=1&countrycodes=jp`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(searchUrl)}`;
                
                console.log('検索API URL:', searchUrl);
                console.log('プロキシ URL:', proxyUrl);
                
                const response = await fetch(proxyUrl);
                const proxyData = await response.json();
                const searchResults = JSON.parse(proxyData.contents);
                
                console.log('検索結果:', searchResults);
                
                if (searchResults && searchResults.length > 0) {
                    const result = searchResults[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    
                    // 座標を小数第4位に四捨五入
                    const roundedLat = Math.round(lat * 10000) / 10000;
                    const roundedLng = Math.round(lng * 10000) / 10000;
                    
                    console.log('検索で取得した座標:', roundedLat, roundedLng);
                    
                    // 座標をフォームに設定
                    document.getElementById('storeLat').value = roundedLat;
                    document.getElementById('storeLng').value = roundedLng;
                    
                    // 住所も設定（検索結果から整形された住所を使用）
                    if (result.display_name) {
                        let displayAddress = result.display_name;
                        // 日本、愛知県、郵便番号を除去
                        displayAddress = displayAddress.replace(/,\s*(日本|愛知県|\d{3}-?\d{4})/g, '');
                        displayAddress = displayAddress.split(',')[0].trim(); // 最初の部分のみ使用
                        
                        console.log('検索結果から設定する住所:', displayAddress);
                        document.getElementById('storeAddress').value = displayAddress;
                    }
                    
                    return true;
                } else {
                    console.log('検索結果が見つかりませんでした');
                    return false;
                }
                
            } catch (error) {
                console.log('住所検索エラー:', error);
                return false;
            }
        }
        
        function extractStoreNameFromUrl(url) {
            try {
                const storeNameField = document.getElementById('storeName');
                
                // 店舗名フィールドが空の場合のみ抽出
                if (!storeNameField.value && url.includes('/place/')) {
                    // URLから店舗名部分を抽出（/place/の後の部分）
                    const placeMatch = url.match(/\/place\/([^\/\@\?]+)/);
                    if (placeMatch) {
                        let storeName = decodeURIComponent(placeMatch[1]);
                        
                        // URLエンコードされた日本語をデコード
                        storeName = storeName.replace(/\+/g, ' ').trim();
                        
                        // 店舗名として適切でない文字列は除外
                        if (storeName && storeName.length > 0 && !storeName.match(/^\d+[\d\.,]*$/)) {
                            storeNameField.value = storeName;
                        }
                    }
                }
            } catch (error) {
                console.log('店舗名抽出エラー:', error);
            }
        }
        
        // 住所データを処理する関数（フォールバック用）
        function processAddressData(data) {
            const addressField = document.getElementById('storeAddress');
            console.log('=== フォールバック住所処理開始 ===');
            console.log('現在の住所フィールド値:', addressField.value);
            
            // 新しいアプローチで既に住所が設定されている場合はスキップ
            if (addressField.value && addressField.value.length > 10) {
                console.log('住所が既に設定されているため、フォールバック処理をスキップ');
                return;
            }
            
            console.log('取得したデータ全体:', data);
            
            // display_nameを使用したシンプルな住所抽出
            const displayName = data.display_name;
            console.log('display_name:', displayName);
            
            if (displayName) {
                const parts = displayName.split(',').map(s => s.trim());
                console.log('住所パーツ:', parts);
                
                // 日本、愛知県、郵便番号を除外
                const filteredParts = parts.filter(part => 
                    !part.match(/^日本$/) && 
                    !part.match(/^愛知県$/) && 
                    !part.match(/^\d{3}-?\d{4}$/)
                );
                
                console.log('フィルタ後のパーツ:', filteredParts);
                
                // 最初の2-3つのパーツを使用して住所を構築
                if (filteredParts.length >= 1) {
                    let finalAddress = filteredParts.slice(0, 3).join('').replace(/\s+/g, '');
                    
                    console.log('フォールバック住所:', finalAddress);
                    addressField.value = finalAddress;
                    console.log('フォールバック住所をフィールドに設定:', addressField.value);
                }
            }
        }
        
        // 座標から住所を取得
        async function getAddressFromCoordinates(lat, lng) {
            try {
                // CORSプロキシを使用してOpenStreetMap Nominatim APIにアクセス
                // より詳細な住所を取得するためのパラメータ調整
                const apiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ja&zoom=18&addressdetails=1&extratags=1&namedetails=1`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`;
                
                console.log('API URL:', apiUrl); // デバッグ用
                console.log('プロキシ URL:', proxyUrl); // デバッグ用
                
                const response = await fetch(proxyUrl);
                const proxyData = await response.json();
                const data = JSON.parse(proxyData.contents);
                
                console.log('住所取得API応答:', data); // デバッグ用
                
                if (data && data.address) {
                    processAddressData(data);
                } else {
                    console.log('住所データが取得できませんでした'); // デバッグ用
                }
            } catch (error) {
                console.log('住所取得エラー:', error);
                
                // フォールバック: 直接APIを試す（CORSエラーが発生する可能性があるが）
                try {
                    console.log('フォールバック: 直接API呼び出しを試行'); // デバッグ用
                    const directResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ja&zoom=18&addressdetails=1`);
                    const directData = await directResponse.json();
                    
                    if (directData && directData.address) {
                        // 同じ住所処理ロジックを適用
                        processAddressData(directData);
                    }
                } catch (directError) {
                    console.log('直接API呼び出しも失敗:', directError);
                    showStatus('住所の自動取得に失敗しました。手動で入力してください。', 'error');
                }
            }
        }
        
        // 座標入力時の処理
        function handleCoordinateChange() {
            const lat = document.getElementById('storeLat').value;
            const lng = document.getElementById('storeLng').value;
            
            if (lat && lng) {
                // 両方の座標が入力されたら住所取得ボタンを有効化
                document.getElementById('addressBtn').disabled = false;
            }
        }
        
        // 座標から住所を取得するボタンの処理
        async function extractAddressFromCoordinates() {
            let lat = parseFloat(document.getElementById('storeLat').value);
            let lng = parseFloat(document.getElementById('storeLng').value);
            
            if (!lat || !lng) {
                showStatus('緯度と経度を入力してください', 'error');
                return;
            }
            
            // 座標を小数第4位に四捨五入
            lat = Math.round(lat * 10000) / 10000;
            lng = Math.round(lng * 10000) / 10000;
            
            // 四捨五入した値をフィールドに反映
            document.getElementById('storeLat').value = lat;
            document.getElementById('storeLng').value = lng;
            
            const addressBtn = document.getElementById('addressBtn');
            addressBtn.textContent = '🔄 住所を取得中...';
            addressBtn.disabled = true;
            
            await getAddressFromCoordinates(lat, lng);
            
            addressBtn.textContent = '📍 座標から住所を取得';
            addressBtn.disabled = false;
            showStatus('住所を取得しました', 'success');
        }
        
        // ステータス表示
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>