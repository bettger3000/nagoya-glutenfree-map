<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>店舗管理ツール - グルテンフリーマップ</title>
    <style>
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #F8C8DC, #E8B4FF);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #F8C8DC, #E8B4FF);
            padding: 20px;
            text-align: center;
            color: #2D2D2D;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .tab.active {
            background: white;
            border-bottom: 3px solid #F8C8DC;
            color: #2D2D2D;
            font-weight: bold;
        }
        .tab:hover:not(.active) {
            background: #e9ecef;
        }
        .tab-content {
            display: none;
            padding: 20px;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2D2D2D;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #F8C8DC;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #E8B4FF;
            box-shadow: 0 0 0 3px rgba(232, 180, 255, 0.2);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .btn {
            background: #F8C8DC;
            color: #2D2D2D;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #E8B4FF;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn.secondary {
            background: #6c757d;
            color: white;
        }
        .btn.secondary:hover {
            background: #5a6268;
        }
        .btn.danger {
            background: #dc3545;
            color: white;
        }
        .btn.danger:hover {
            background: #c82333;
        }
        .stores-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .stores-table th, .stores-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .stores-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2D2D2D;
        }
        .stores-table tr:hover {
            background: #f8f9fa;
        }
        .coordinate-display {
            font-family: monospace;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #28a745; }
        .status-missing { background: #dc3545; }
        .status-partial { background: #ffc107; }
        .log-area {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        .coordinate-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #F8C8DC;
            border-radius: 25px;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .bulk-actions {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #F8C8DC, #E8B4FF);
            width: 0%;
            transition: width 0.3s ease;
        }
        .map-preview {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            border: 2px solid #F8C8DC;
            margin-top: 15px;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🍞 店舗管理ツール</h1>
            <p>グルテンフリーマップの店舗データを管理します</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('add-store')">📝 新店舗追加</button>
            <button class="tab" onclick="switchTab('manage-coordinates')">🗺️ 座標管理</button>
            <button class="tab" onclick="switchTab('bulk-operations')">⚙️ 一括操作</button>
        </div>
        
        <!-- 新店舗追加タブ -->
        <div id="add-store" class="tab-content active">
            <h2>新店舗を追加</h2>
            <form id="addStoreForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="storeName">店舗名 *</label>
                        <input type="text" id="storeName" required>
                    </div>
                    <div class="form-group">
                        <label for="storeCategory">カテゴリ *</label>
                        <select id="storeCategory" required>
                            <option value="">選択してください</option>
                            <option value="カフェ">カフェ</option>
                            <option value="洋食">洋食</option>
                            <option value="和食">和食</option>
                            <option value="スイーツ">スイーツ</option>
                            <option value="ベーカリー">ベーカリー</option>
                            <option value="販売店">販売店</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="storeAddress">住所 *</label>
                    <input type="text" id="storeAddress" placeholder="例: 東京都渋谷区神南1-1-1" required>
                    <button type="button" class="btn" onclick="geocodeAddress()" style="margin-top: 10px;">
                        📍 住所から座標を自動取得
                    </button>
                </div>
                
                <div class="coordinate-form" id="coordinateForm" style="display: none;">
                    <h4>📍 座標情報</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="storeLatitude">緯度</label>
                            <input type="number" id="storeLatitude" step="0.0001" readonly>
                        </div>
                        <div class="form-group">
                            <label for="storeLongitude">経度</label>
                            <input type="number" id="storeLongitude" step="0.0001" readonly>
                        </div>
                    </div>
                    <div id="mapPreview" class="map-preview"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="storeHours">営業時間</label>
                        <input type="text" id="storeHours" placeholder="例: 10:00-18:00">
                    </div>
                    <div class="form-group">
                        <label for="storeClosed">定休日</label>
                        <input type="text" id="storeClosed" placeholder="例: 月曜日">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="storeDescription">説明</label>
                    <textarea id="storeDescription" rows="3" placeholder="店舗の特徴やおすすめ情報"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="storeWebsite">ウェブサイト</label>
                        <input type="url" id="storeWebsite" placeholder="https://">
                    </div>
                    <div class="form-group">
                        <label for="storeInstagram">Instagram</label>
                        <input type="url" id="storeInstagram" placeholder="https://instagram.com/">
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h4>📸 店舗画像（最大3枚）</h4>
                    <div class="form-group">
                        <label for="imageUrl1">画像1 URL</label>
                        <input type="url" id="imageUrl1" placeholder="https://example.com/image1.jpg">
                    </div>
                    <div class="form-group">
                        <label for="imageUrl2">画像2 URL</label>
                        <input type="url" id="imageUrl2" placeholder="https://example.com/image2.jpg">
                    </div>
                    <div class="form-group">
                        <label for="imageUrl3">画像3 URL</label>
                        <input type="url" id="imageUrl3" placeholder="https://example.com/image3.jpg">
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn">✨ 店舗を追加</button>
                    <button type="button" class="btn secondary" onclick="resetForm()">🔄 リセット</button>
                </div>
            </form>
        </div>
        
        <!-- 座標管理タブ -->
        <div id="manage-coordinates" class="tab-content">
            <h2>店舗座標管理</h2>
            <input type="text" class="search-box" id="storeSearch" placeholder="🔍 店舗名で検索..." onkeyup="filterStores()">
            
            <div class="bulk-actions">
                <strong>一括操作:</strong>
                <button class="btn" onclick="autoGeocodeAll()">📍 全店舗の座標を自動取得</button>
                <button class="btn secondary" onclick="exportCoordinates()">📋 座標データをエクスポート</button>
                <div class="progress-bar" id="bulkProgress" style="display: none;">
                    <div class="progress-fill" id="bulkProgressFill"></div>
                </div>
            </div>
            
            <div id="storesTableContainer">
                <table class="stores-table" id="storesTable">
                    <thead>
                        <tr>
                            <th>状態</th>
                            <th>店舗名</th>
                            <th>住所</th>
                            <th>座標</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="storesTableBody">
                        <!-- 動的に生成 -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 一括操作タブ -->
        <div id="bulk-operations" class="tab-content">
            <h2>一括操作</h2>
            
            <div class="bulk-actions">
                <h3>📊 統計情報</h3>
                <div id="statsDisplay">
                    <!-- 統計情報を表示 -->
                </div>
            </div>
            
            <div class="bulk-actions">
                <h3>🔧 メンテナンス操作</h3>
                <button class="btn" onclick="validateAllCoordinates()">✅ 全座標を検証</button>
                <button class="btn" onclick="fixDuplicateCoordinates()">🔄 重複座標を修正</button>
                <button class="btn secondary" onclick="backupDatabase()">💾 データベースバックアップ</button>
            </div>
            
            <div class="log-area" id="operationLog" style="display: none;">
                <!-- 操作ログ -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Supabase設定
        const SUPABASE_URL = 'https://lywfaolwvkewuouvkzlk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5d2Zhb2x3dmtld3VvdXZremxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDg2NjcsImV4cCI6MjA2OTk4NDY2N30.wBGCHOLbP6ew7Bnvxrq0sKSm1EnHk5NNE1sWWH7ff60';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let stores = [];
        let previewMap = null;
        
        // タブ切り替え
        function switchTab(tabName) {
            // すべてのタブとコンテンツを非アクティブに
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 選択されたタブとコンテンツをアクティブに
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // 座標管理タブが開かれた時に店舗一覧を読み込み
            if (tabName === 'manage-coordinates') {
                loadStores();
            } else if (tabName === 'bulk-operations') {
                loadStats();
            }
        }
        
        // 住所から座標を取得（Nominatim API使用）
        async function geocodeAddress() {
            const address = document.getElementById('storeAddress').value;
            if (!address) {
                alert('住所を入力してください');
                return;
            }
            
            try {
                log('住所から座標を取得中: ' + address);
                
                // Nominatim API（OpenStreetMap）を使用
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ' Japan')}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    document.getElementById('storeLatitude').value = lat;
                    document.getElementById('storeLongitude').value = lng;
                    
                    // 座標フォームを表示
                    document.getElementById('coordinateForm').style.display = 'block';
                    
                    // プレビューマップを表示
                    showPreviewMap(lat, lng);
                    
                    log(`✅ 座標取得成功: [${lat}, ${lng}]`);
                } else {
                    alert('住所から座標を取得できませんでした。手動で入力してください。');
                    log('❌ 座標取得失敗: 住所が見つかりません');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                alert('座標取得中にエラーが発生しました。');
                log('❌ 座標取得エラー: ' + error.message);
            }
        }
        
        // プレビューマップを表示
        function showPreviewMap(lat, lng) {
            const mapContainer = document.getElementById('mapPreview');
            
            // 既存のマップを削除
            if (previewMap) {
                previewMap.remove();
            }
            
            // 新しいマップを作成
            previewMap = L.map('mapPreview').setView([lat, lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(previewMap);
            
            // マーカーを追加
            L.marker([lat, lng]).addTo(previewMap)
                .bindPopup('新店舗の位置')
                .openPopup();
        }
        
        // 新店舗追加フォーム送信
        document.getElementById('addStoreForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('storeName').value,
                category: document.getElementById('storeCategory').value,
                address: document.getElementById('storeAddress').value,
                latitude: document.getElementById('storeLatitude').value || null,
                longitude: document.getElementById('storeLongitude').value || null,
                hours: document.getElementById('storeHours').value || null,
                closed: document.getElementById('storeClosed').value || null,
                description: document.getElementById('storeDescription').value || null,
                website: document.getElementById('storeWebsite').value || null,
                instagram: document.getElementById('storeInstagram').value || null,
                imageUrl: document.getElementById('imageUrl1').value || null,
                imageUrl2: document.getElementById('imageUrl2').value || null,
                imageUrl3: document.getElementById('imageUrl3').value || null
            };
            
            try {
                log('新店舗を追加中: ' + formData.name);
                
                const { data, error } = await supabase
                    .from('stores')
                    .insert([formData])
                    .select();
                
                if (error) throw error;
                
                alert('店舗を追加しました！');
                log('✅ 店舗追加成功: ' + formData.name);
                resetForm();
            } catch (error) {
                console.error('Store addition error:', error);
                alert('店舗追加中にエラーが発生しました: ' + error.message);
                log('❌ 店舗追加エラー: ' + error.message);
            }
        });
        
        // フォームリセット
        function resetForm() {
            document.getElementById('addStoreForm').reset();
            document.getElementById('coordinateForm').style.display = 'none';
            
            if (previewMap) {
                previewMap.remove();
                previewMap = null;
            }
        }
        
        // 店舗一覧を読み込み
        async function loadStores() {
            try {
                log('店舗一覧を読み込み中...');
                
                const { data, error } = await supabase
                    .from('stores')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                
                stores = data;
                displayStores(stores);
                log(`✅ ${stores.length}件の店舗を読み込み完了`);
            } catch (error) {
                console.error('Load stores error:', error);
                log('❌ 店舗読み込みエラー: ' + error.message);
            }
        }
        
        // 店舗一覧を表示
        function displayStores(storesToShow) {
            const tbody = document.getElementById('storesTableBody');
            tbody.innerHTML = '';
            
            storesToShow.forEach(store => {
                const row = document.createElement('tr');
                
                // 座標の状態を判定
                const hasCoordinates = store.latitude && store.longitude;
                const statusClass = hasCoordinates ? 'status-ok' : 'status-missing';
                const statusText = hasCoordinates ? '完了' : '未設定';
                
                row.innerHTML = `
                    <td><span class="status-indicator ${statusClass}"></span>${statusText}</td>
                    <td><strong>${store.name}</strong><br><small>${store.category || '未分類'}</small></td>
                    <td>${store.address || '住所未設定'}</td>
                    <td class="coordinate-display">
                        ${hasCoordinates ? `${store.latitude}, ${store.longitude}` : '未設定'}
                    </td>
                    <td>
                        <button class="btn" onclick="editStoreCoordinates(${store.id})" style="font-size: 12px; padding: 6px 12px;">編集</button>
                        ${!hasCoordinates ? `<button class="btn" onclick="geocodeStore(${store.id})" style="font-size: 12px; padding: 6px 12px;">自動取得</button>` : ''}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // 店舗フィルタリング
        function filterStores() {
            const searchTerm = document.getElementById('storeSearch').value.toLowerCase();
            const filteredStores = stores.filter(store => 
                store.name.toLowerCase().includes(searchTerm) ||
                (store.address && store.address.toLowerCase().includes(searchTerm))
            );
            displayStores(filteredStores);
        }
        
        // 個別店舗の座標を自動取得
        async function geocodeStore(storeId) {
            const store = stores.find(s => s.id === storeId);
            if (!store || !store.address) {
                alert('住所が設定されていません');
                return;
            }
            
            try {
                log(`座標自動取得: ${store.name}`);
                
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(store.address + ' Japan')}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    const { error } = await supabase
                        .from('stores')
                        .update({ latitude: lat, longitude: lng })
                        .eq('id', storeId);
                    
                    if (error) throw error;
                    
                    log(`✅ ${store.name}の座標を更新: [${lat}, ${lng}]`);
                    loadStores(); // 一覧を更新
                } else {
                    log(`❌ ${store.name}: 座標取得失敗`);
                    alert('住所から座標を取得できませんでした');
                }
            } catch (error) {
                console.error('Geocode error:', error);
                log(`❌ ${store.name}: エラー - ${error.message}`);
            }
        }
        
        // 統計情報を読み込み
        async function loadStats() {
            try {
                const { data, error } = await supabase
                    .from('stores')
                    .select('latitude, longitude, category');
                
                if (error) throw error;
                
                const total = data.length;
                const withCoordinates = data.filter(s => s.latitude && s.longitude).length;
                const withoutCoordinates = total - withCoordinates;
                
                const categoryStats = {};
                data.forEach(store => {
                    const category = store.category || '未分類';
                    categoryStats[category] = (categoryStats[category] || 0) + 1;
                });
                
                let statsHtml = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                        <div style="text-align: center; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #2D2D2D;">${total}</div>
                            <div>総店舗数</div>
                        </div>
                        <div style="text-align: center; background: #d4edda; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #155724;">${withCoordinates}</div>
                            <div>座標設定済み</div>
                        </div>
                        <div style="text-align: center; background: #f8d7da; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #721c24;">${withoutCoordinates}</div>
                            <div>座標未設定</div>
                        </div>
                    </div>
                    <h4>カテゴリ別統計</h4>
                    <ul>
                `;
                
                Object.entries(categoryStats).forEach(([category, count]) => {
                    statsHtml += `<li>${category}: ${count}件</li>`;
                });
                
                statsHtml += '</ul>';
                
                document.getElementById('statsDisplay').innerHTML = statsHtml;
            } catch (error) {
                console.error('Stats error:', error);
                log('❌ 統計情報取得エラー: ' + error.message);
            }
        }
        
        // ログ出力
        function log(message) {
            console.log(message);
            const logArea = document.getElementById('operationLog');
            if (logArea) {
                const timestamp = new Date().toLocaleTimeString();
                logArea.textContent += `[${timestamp}] ${message}\n`;
                logArea.style.display = 'block';
                logArea.scrollTop = logArea.scrollHeight;
            }
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            log('店舗管理ツールを初期化中...');
        });
    </script>
</body>
</html>