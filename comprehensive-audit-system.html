<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿ç›£æŸ»ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn.success { background: #28a745; }
        .btn.warning { background: #ffc107; color: #212529; }
        .btn.danger { background: #dc3545; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-number.error { color: #dc3545; }
        .stat-number.warning { color: #ffc107; }
        .stat-number.success { color: #28a745; }
        
        .filters {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .store-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .store-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            background: white;
        }
        .store-card.error { border-color: #dc3545; background: #fff5f5; }
        .store-card.warning { border-color: #ffc107; background: #fffbf0; }
        .store-card.success { border-color: #28a745; background: #f8fff8; }
        
        .store-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .store-name {
            font-weight: bold;
            font-size: 1.1em;
        }
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status-badge.error { background: #dc3545; color: white; }
        .status-badge.warning { background: #ffc107; color: #212529; }
        .status-badge.success { background: #28a745; color: white; }
        
        .data-section {
            margin-bottom: 15px;
        }
        .data-label {
            font-weight: bold;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 3px;
        }
        .data-value {
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .data-value.error { background: #f8d7da; color: #721c24; }
        .data-value.warning { background: #fff3cd; color: #856404; }
        
        .issues-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        .issues-list li {
            padding: 5px;
            margin: 3px 0;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .issues-list li.error { background: #f8d7da; color: #721c24; }
        .issues-list li.warning { background: #fff3cd; color: #856404; }
        
        .quick-actions {
            margin-top: 15px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .quick-actions button {
            font-size: 0.8em;
            padding: 5px 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .loading i {
            font-size: 2em;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .search-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
            max-width: 300px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ” å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿ç›£æŸ»ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>å…¨ã¦ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€åº§æ¨™ãƒ»ä½æ‰€ãƒ»URLæƒ…å ±ã®æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚</p>
        
        <div class="controls">
            <button class="btn" onclick="startFullAudit()">
                <i class="fas fa-play"></i> å®Œå…¨ç›£æŸ»é–‹å§‹
            </button>
            <button class="btn warning" onclick="showProblematicOnly()">
                <i class="fas fa-exclamation-triangle"></i> å•é¡Œã®ã‚ã‚‹åº—èˆ—ã®ã¿
            </button>
            <button class="btn success" onclick="showValidOnly()">
                <i class="fas fa-check"></i> æ­£å¸¸ãªåº—èˆ—ã®ã¿
            </button>
            <button class="btn" onclick="exportResults()">
                <i class="fas fa-download"></i> çµæœã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
        </div>
        
        <div class="filters">
            <label>ğŸ” åº—èˆ—æ¤œç´¢:</label>
            <input type="text" id="searchInput" class="search-input" placeholder="åº—åã§æ¤œç´¢..." onkeyup="filterStores()">
            <label>ğŸ“‚ ã‚«ãƒ†ã‚´ãƒª:</label>
            <select id="categoryFilter" onchange="filterStores()">
                <option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option>
            </select>
        </div>
        
        <div id="stats" class="stats" style="display: none;"></div>
        
        <div id="results">
            <div class="loading">
                <i class="fas fa-cog"></i>
                <p>ã€Œå®Œå…¨ç›£æŸ»é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://lywfaolwvkewuouvkzlk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5d2Zhb2x3dmtld3VvdXZremxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDg2NjcsImV4cCI6MjA2OTk4NDY2N30.wBGCHOLbP6ew7Bnvxrq0sKSm1EnHk5NNE1sWWH7ff60';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let allStores = [];
        let auditResults = [];
        let filteredResults = [];
        
        // åå¤å±‹å¸‚ã®ç¯„å›²
        const NAGOYA_BOUNDS = {
            north: 35.3, south: 35.0, east: 137.0, west: 136.7
        };
        
        async function startFullAudit() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="loading">
                    <i class="fas fa-cog"></i>
                    <p>å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>
                </div>
            `;
            
            try {
                const { data: stores, error } = await supabase
                    .from('stores')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                
                allStores = stores || [];
                
                resultsDiv.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-cog"></i>
                        <p>${allStores.length}åº—èˆ—ã‚’åˆ†æä¸­... (${getCurrentTime()})</p>
                    </div>
                `;
                
                // å„åº—èˆ—ã‚’åˆ†æ
                auditResults = [];
                for (let i = 0; i < allStores.length; i++) {
                    const store = allStores[i];
                    const analysis = await auditStore(store);
                    auditResults.push({ store, analysis });
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
                    if (i % 5 === 0 || i === allStores.length - 1) {
                        resultsDiv.innerHTML = `
                            <div class="loading">
                                <i class="fas fa-cog"></i>
                                <p>åˆ†æä¸­: ${i + 1}/${allStores.length} (${Math.round((i + 1) / allStores.length * 100)}%)</p>
                            </div>
                        `;
                        await new Promise(resolve => setTimeout(resolve, 10)); // UIæ›´æ–°
                    }
                }
                
                // çµæœã‚’è¡¨ç¤º
                displayResults();
                populateCategoryFilter();
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        async function auditStore(store) {
            const issues = [];
            let severity = 'success'; // success, warning, error
            
            // åº§æ¨™åˆ†æ
            const coordinateAnalysis = analyzeCoordinates(store);
            if (coordinateAnalysis.issues.length > 0) {
                issues.push(...coordinateAnalysis.issues);
                if (coordinateAnalysis.severity === 'error') severity = 'error';
                else if (coordinateAnalysis.severity === 'warning' && severity !== 'error') severity = 'warning';
            }
            
            // URLåˆ†æ
            const urlAnalysis = analyzeUrls(store);
            if (urlAnalysis.issues.length > 0) {
                issues.push(...urlAnalysis.issues);
                if (urlAnalysis.severity === 'warning' && severity === 'success') severity = 'warning';
            }
            
            // ä½æ‰€åˆ†æ
            const addressAnalysis = analyzeAddress(store);
            if (addressAnalysis.issues.length > 0) {
                issues.push(...addressAnalysis.issues);
                if (addressAnalysis.severity === 'warning' && severity === 'success') severity = 'warning';
            }
            
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            const duplicateAnalysis = checkDuplicates(store);
            if (duplicateAnalysis.issues.length > 0) {
                issues.push(...duplicateAnalysis.issues);
                if (duplicateAnalysis.severity === 'warning' && severity === 'success') severity = 'warning';
            }
            
            return {
                severity,
                issues,
                coordinateAnalysis,
                urlAnalysis,
                addressAnalysis,
                duplicateAnalysis,
                recommendedActions: generateRecommendations(store, issues)
            };
        }
        
        function analyzeCoordinates(store) {
            const lat = parseFloat(store.latitude);
            const lng = parseFloat(store.longitude);
            const issues = [];
            let severity = 'success';
            
            // åº§æ¨™ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
            if (!store.latitude || !store.longitude) {
                issues.push({ type: 'error', message: 'åº§æ¨™ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“' });
                severity = 'error';
            }
            // åº§æ¨™ã®æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯
            else if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
                issues.push({ type: 'error', message: 'ç„¡åŠ¹ãªåº§æ¨™å€¤ã§ã™' });
                severity = 'error';
            }
            // åå¤å±‹å¸‚å†…ã‹ãƒã‚§ãƒƒã‚¯
            else if (lat < NAGOYA_BOUNDS.south || lat > NAGOYA_BOUNDS.north || 
                     lng < NAGOYA_BOUNDS.west || lng > NAGOYA_BOUNDS.east) {
                issues.push({ type: 'warning', message: 'åå¤å±‹å¸‚å¤–ã®åº§æ¨™ã§ã™' });
                if (severity !== 'error') severity = 'warning';
            }
            
            // URLåº§æ¨™ã¨ã®æ¯”è¼ƒ
            const extractedCoords = extractCoordinatesFromGoogleMaps(store);
            if (extractedCoords && isValidCoordinate(lat, lng)) {
                const distance = calculateDistance(lat, lng, extractedCoords.lat, extractedCoords.lng);
                if (distance > 1) { // 1kmä»¥ä¸Šé›¢ã‚Œã¦ã„ã‚‹
                    issues.push({ 
                        type: 'warning', 
                        message: `URLåº§æ¨™ã¨${distance.toFixed(1)}kmé›¢ã‚Œã¦ã„ã¾ã™` 
                    });
                    if (severity !== 'error') severity = 'warning';
                }
            }
            
            return { issues, severity, extractedCoords };
        }
        
        function analyzeUrls(store) {
            const issues = [];
            let severity = 'success';
            const urlFields = ['google_maps_url', 'maps_url', 'url', 'link', 'google_maps', 'map_link', 'website'];
            
            let hasGoogleMapsUrl = false;
            urlFields.forEach(field => {
                if (store[field] && store[field].includes('google')) {
                    hasGoogleMapsUrl = true;
                    
                    // URLã®æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯
                    try {
                        new URL(store[field]);
                    } catch {
                        issues.push({ type: 'warning', message: `${field}ãŒç„¡åŠ¹ãªURLã§ã™` });
                        if (severity !== 'error') severity = 'warning';
                    }
                }
            });
            
            if (!hasGoogleMapsUrl) {
                issues.push({ type: 'warning', message: 'Googleãƒãƒƒãƒ—URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
                if (severity !== 'error') severity = 'warning';
            }
            
            return { issues, severity };
        }
        
        function analyzeAddress(store) {
            const issues = [];
            let severity = 'success';
            
            if (!store.address || store.address.trim() === '') {
                issues.push({ type: 'warning', message: 'ä½æ‰€ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“' });
                severity = 'warning';
            } else {
                // ä½æ‰€ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
                if (!store.address.includes('åå¤å±‹') && !store.address.includes('æ„›çŸ¥')) {
                    issues.push({ type: 'warning', message: 'åå¤å±‹å¸‚å¤–ã®ä½æ‰€ã§ã™' });
                    severity = 'warning';
                }
            }
            
            return { issues, severity };
        }
        
        function checkDuplicates(store) {
            const issues = [];
            let severity = 'success';
            
            // åŒã˜åå‰ã®åº—èˆ—ã‚’ãƒã‚§ãƒƒã‚¯
            const sameNameStores = allStores.filter(s => 
                s.id !== store.id && 
                s.name && store.name &&
                s.name.toLowerCase().trim() === store.name.toLowerCase().trim()
            );
            
            if (sameNameStores.length > 0) {
                issues.push({ 
                    type: 'warning', 
                    message: `åŒåã®åº—èˆ—ãŒä»–ã«${sameNameStores.length}ä»¶ã‚ã‚Šã¾ã™` 
                });
                severity = 'warning';
            }
            
            return { issues, severity };
        }
        
        function generateRecommendations(store, issues) {
            const recommendations = [];
            
            issues.forEach(issue => {
                if (issue.message.includes('åº§æ¨™ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“')) {
                    recommendations.push('Googleãƒãƒƒãƒ—URLã‹ã‚‰åº§æ¨™ã‚’è‡ªå‹•æŠ½å‡º');
                }
                if (issue.message.includes('ç„¡åŠ¹ãªåº§æ¨™å€¤')) {
                    recommendations.push('ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’å†å–å¾—');
                }
                if (issue.message.includes('kmé›¢ã‚Œã¦ã„ã¾ã™')) {
                    recommendations.push('URLåº§æ¨™ã§æ›´æ–°ã™ã‚‹ã“ã¨ã‚’æ¤œè¨');
                }
                if (issue.message.includes('ä½æ‰€ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“')) {
                    recommendations.push('Googleãƒãƒƒãƒ—APIã§ä½æ‰€ã‚’å–å¾—');
                }
            });
            
            return [...new Set(recommendations)]; // é‡è¤‡å‰Šé™¤
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ç¾¤
        function extractCoordinatesFromGoogleMaps(store) {
            const urlFields = ['google_maps_url', 'maps_url', 'url', 'link', 'google_maps', 'map_link', 'website'];
            let mapUrl = null;
            
            for (const field of urlFields) {
                if (store[field] && typeof store[field] === 'string' && store[field].includes('google')) {
                    mapUrl = store[field];
                    break;
                }
            }
            
            if (!mapUrl) {
                for (const [key, value] of Object.entries(store)) {
                    if (typeof value === 'string' && (
                        value.includes('maps.google') || 
                        value.includes('goo.gl/maps') ||
                        (value.includes('@') && value.includes(','))
                    )) {
                        mapUrl = value;
                        break;
                    }
                }
            }
            
            if (!mapUrl) return null;
            
            const patterns = [
                /@(-?\d+\.?\d*),(-?\d+\.?\d*),/,
                /!3d(-?\d+\.?\d*).*!4d(-?\d+\.?\d*)/,
                /ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/,
                /q=(-?\d+\.?\d*),(-?\d+\.?\d*)/,
                /center=(-?\d+\.?\d*),(-?\d+\.?\d*)/
            ];
            
            for (const pattern of patterns) {
                const match = mapUrl.match(pattern);
                if (match) {
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    
                    if (isValidCoordinate(lat, lng)) {
                        return { lat, lng };
                    }
                }
            }
            
            return null;
        }
        
        function isValidCoordinate(lat, lng) {
            return !isNaN(lat) && !isNaN(lng) && 
                   lat >= -90 && lat <= 90 && 
                   lng >= -180 && lng <= 180 &&
                   lat !== 0 && lng !== 0;
        }
        
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // åœ°çƒã®åŠå¾„ (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function getCurrentTime() {
            return new Date().toLocaleTimeString('ja-JP');
        }
        
        function displayResults() {
            const stats = calculateStats();
            displayStats(stats);
            
            filteredResults = auditResults;
            renderStoreCards();
        }
        
        function calculateStats() {
            const total = auditResults.length;
            const errorCount = auditResults.filter(r => r.analysis.severity === 'error').length;
            const warningCount = auditResults.filter(r => r.analysis.severity === 'warning').length;
            const successCount = total - errorCount - warningCount;
            
            const noCoordinates = auditResults.filter(r => 
                !r.store.latitude || !r.store.longitude).length;
            const outsideNagoya = auditResults.filter(r => {
                const lat = parseFloat(r.store.latitude);
                const lng = parseFloat(r.store.longitude);
                return isValidCoordinate(lat, lng) && 
                       (lat < NAGOYA_BOUNDS.south || lat > NAGOYA_BOUNDS.north ||
                        lng < NAGOYA_BOUNDS.west || lng > NAGOYA_BOUNDS.east);
            }).length;
            
            return {
                total, errorCount, warningCount, successCount,
                noCoordinates, outsideNagoya
            };
        }
        
        function displayStats(stats) {
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">ç·åº—èˆ—æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number success">${stats.successCount}</div>
                    <div class="stat-label">æ­£å¸¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number warning">${stats.warningCount}</div>
                    <div class="stat-label">è¦æ³¨æ„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number error">${stats.errorCount}</div>
                    <div class="stat-label">ã‚¨ãƒ©ãƒ¼</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number error">${stats.noCoordinates}</div>
                    <div class="stat-label">åº§æ¨™ãªã—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number warning">${stats.outsideNagoya}</div>
                    <div class="stat-label">å¸‚å¤–åº§æ¨™</div>
                </div>
            `;
            
            document.getElementById('stats').innerHTML = statsHtml;
            document.getElementById('stats').style.display = 'grid';
        }
        
        function renderStoreCards() {
            const resultsDiv = document.getElementById('results');
            
            if (filteredResults.length === 0) {
                resultsDiv.innerHTML = '<div class="loading"><p>è©²å½“ã™ã‚‹åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
                return;
            }
            
            const cardsHtml = filteredResults.map(result => createStoreCard(result)).join('');
            resultsDiv.innerHTML = `<div class="store-grid">${cardsHtml}</div>`;
        }
        
        function createStoreCard({ store, analysis }) {
            const severityIcon = {
                success: 'âœ…',
                warning: 'âš ï¸',
                error: 'âŒ'
            };
            
            const issuesHtml = analysis.issues.length > 0 ? `
                <div class="data-section">
                    <div class="data-label">ğŸš¨ å•é¡Œç‚¹:</div>
                    <ul class="issues-list">
                        ${analysis.issues.map(issue => 
                            `<li class="${issue.type}">${issue.message}</li>`
                        ).join('')}
                    </ul>
                </div>
            ` : '';
            
            const recommendationsHtml = analysis.recommendedActions.length > 0 ? `
                <div class="data-section">
                    <div class="data-label">ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</div>
                    <ul class="issues-list">
                        ${analysis.recommendedActions.map(action => 
                            `<li style="background: #e8f5e8; color: #155724;">${action}</li>`
                        ).join('')}
                    </ul>
                </div>
            ` : '';
            
            return `
                <div class="store-card ${analysis.severity}">
                    <div class="store-header">
                        <div class="store-name">${store.name || 'åº—åãªã—'}</div>
                        <div class="status-badge ${analysis.severity}">
                            ${severityIcon[analysis.severity]} ${analysis.severity.toUpperCase()}
                        </div>
                    </div>
                    
                    <div class="data-section">
                        <div class="data-label">ğŸ“ ä½æ‰€:</div>
                        <div class="data-value">${store.address || 'ä½æ‰€ãªã—'}</div>
                    </div>
                    
                    <div class="data-section">
                        <div class="data-label">ğŸ—ºï¸ åº§æ¨™:</div>
                        <div class="data-value ${!store.latitude || !store.longitude ? 'error' : ''}">
                            ç·¯åº¦: ${store.latitude || 'ãªã—'} / çµŒåº¦: ${store.longitude || 'ãªã—'}
                        </div>
                        ${analysis.coordinateAnalysis.extractedCoords ? `
                            <div class="data-value" style="background: #d4edda; color: #155724; margin-top: 5px;">
                                URLåº§æ¨™: ${analysis.coordinateAnalysis.extractedCoords.lat}, ${analysis.coordinateAnalysis.extractedCoords.lng}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="data-section">
                        <div class="data-label">ğŸ“‚ ã‚«ãƒ†ã‚´ãƒª:</div>
                        <div class="data-value">${store.category || 'ã‚«ãƒ†ã‚´ãƒªãªã—'}</div>
                    </div>
                    
                    ${issuesHtml}
                    ${recommendationsHtml}
                    
                    <div class="quick-actions">
                        <button class="btn" onclick="inspectStore('${store.id}')">
                            <i class="fas fa-search"></i> è©³ç´°èª¿æŸ»
                        </button>
                        <button class="btn success" onclick="fixStore('${store.id}')">
                            <i class="fas fa-wrench"></i> ä¿®æ­£
                        </button>
                        <button class="btn warning" onclick="viewOnMap('${store.id}')">
                            <i class="fas fa-map"></i> åœ°å›³ã§ç¢ºèª
                        </button>
                    </div>
                </div>
            `;
        }
        
        function populateCategoryFilter() {
            const categories = [...new Set(allStores.map(s => s.category).filter(Boolean))];
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }
        
        function filterStores() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            filteredResults = auditResults.filter(result => {
                const matchesSearch = !searchTerm || 
                    result.store.name?.toLowerCase().includes(searchTerm) ||
                    result.store.address?.toLowerCase().includes(searchTerm);
                
                const matchesCategory = !categoryFilter || result.store.category === categoryFilter;
                
                return matchesSearch && matchesCategory;
            });
            
            renderStoreCards();
        }
        
        function showProblematicOnly() {
            filteredResults = auditResults.filter(r => r.analysis.severity !== 'success');
            renderStoreCards();
        }
        
        function showValidOnly() {
            filteredResults = auditResults.filter(r => r.analysis.severity === 'success');
            renderStoreCards();
        }
        
        function inspectStore(storeId) {
            const result = auditResults.find(r => r.store.id == storeId);
            if (result) {
                alert(`åº—èˆ—è©³ç´°:\n${JSON.stringify(result.store, null, 2)}\n\nåˆ†æçµæœ:\n${JSON.stringify(result.analysis, null, 2)}`);
            }
        }
        
        function fixStore(storeId) {
            alert(`åº—èˆ—ID: ${storeId} ã®ä¿®æ­£æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™`);
        }
        
        function viewOnMap(storeId) {
            const store = auditResults.find(r => r.store.id == storeId)?.store;
            if (store && store.latitude && store.longitude) {
                const url = `https://www.google.com/maps?q=${store.latitude},${store.longitude}`;
                window.open(url, '_blank');
            } else {
                alert('åº§æ¨™ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
            }
        }
        
        function exportResults() {
            const data = auditResults.map(r => ({
                åº—å: r.store.name,
                ä½æ‰€: r.store.address,
                ã‚«ãƒ†ã‚´ãƒª: r.store.category,
                ç·¯åº¦: r.store.latitude,
                çµŒåº¦: r.store.longitude,
                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: r.analysis.severity,
                å•é¡Œæ•°: r.analysis.issues.length,
                å•é¡Œå†…å®¹: r.analysis.issues.map(i => i.message).join('; ')
            }));
            
            const csv = convertToCSV(data);
            downloadCSV(csv, `åº—èˆ—ç›£æŸ»çµæœ_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const cell = row[header] || '';
                        return typeof cell === 'string' && cell.includes(',') ? `"${cell}"` : cell;
                    }).join(',')
                )
            ].join('\n');
            return csvContent;
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>