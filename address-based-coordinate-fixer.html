<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½æ‰€ãƒ™ãƒ¼ã‚¹åº§æ¨™ä¿®æ­£ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .alert.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .alert.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .alert.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn.success { background: #28a745; }
        .btn.success:hover { background: #218838; }
        .btn.danger { background: #dc3545; }
        .btn.danger:hover { background: #c82333; }
        
        .method-selector {
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .method-option {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .method-option input {
            margin-right: 15px;
            transform: scale(1.2);
        }
        .method-option.selected {
            background: #e7f3ff;
            border-color: #007bff;
        }
        .method-description {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .api-config {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .api-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .progress-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .results-section {
            margin: 20px 0;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            display: none;
        }
        .results-header {
            background: #007bff;
            color: white;
            padding: 15px;
            font-weight: bold;
        }
        .results-content {
            max-height: 400px;
            overflow-y: auto;
        }
        .store-result {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 2fr 3fr 2fr 1fr;
            gap: 15px;
            align-items: center;
        }
        .store-name {
            font-weight: bold;
        }
        .address-info {
            font-family: monospace;
            font-size: 0.9em;
        }
        .coordinate-info {
            font-family: monospace;
            font-size: 0.9em;
        }
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-align: center;
        }
        .status-badge.success {
            background: #28a745;
            color: white;
        }
        .status-badge.error {
            background: #dc3545;
            color: white;
        }
        .status-badge.warning {
            background: #ffc107;
            color: #212529;
        }
        
        .log-section {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            display: none;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ  ä½æ‰€ãƒ™ãƒ¼ã‚¹åº§æ¨™ä¿®æ­£ã‚·ã‚¹ãƒ†ãƒ </h1>
        
        <div class="alert info">
            <i class="fas fa-info-circle"></i>
            <strong>æ–°ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:</strong> Googleãƒãƒƒãƒ—URLã‹ã‚‰ä½æ‰€ã‚’æŠ½å‡ºã—ã€ãã®ä½æ‰€ã‚’Geocoding APIã§æ­£ç¢ºãªåº§æ¨™ã«å¤‰æ›ã—ã¾ã™ã€‚
        </div>
        
        <div class="method-selector">
            <h3>ğŸ“ åº§æ¨™å–å¾—æ–¹æ³•ã‚’é¸æŠ</h3>
            
            <div class="method-option" onclick="selectMethod('nominatim')">
                <input type="radio" name="method" value="nominatim" checked>
                <div>
                    <strong>Nominatim APIï¼ˆç„¡æ–™ãƒ»æ¨å¥¨ï¼‰</strong>
                    <div class="method-description">
                        OpenStreetMapã®ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã€‚ç„¡æ–™ã§åˆ©ç”¨å¯èƒ½ã€æ—¥æœ¬ã®ä½æ‰€ã«å¯¾å¿œã€‚
                    </div>
                </div>
            </div>
            
            <div class="method-option" onclick="selectMethod('google')">
                <input type="radio" name="method" value="google">
                <div>
                    <strong>Google Geocoding APIï¼ˆé«˜ç²¾åº¦ãƒ»è¦API KEYï¼‰</strong>
                    <div class="method-description">
                        æœ€é«˜ç²¾åº¦ã®ä½æ‰€è§£æã€‚Google Cloud Platform ã®APIã‚­ãƒ¼ãŒå¿…è¦ã€‚
                    </div>
                </div>
            </div>
            
            <div class="method-option" onclick="selectMethod('manual')">
                <input type="radio" name="method" value="manual">
                <div>
                    <strong>æ‰‹å‹•ç¢ºèªãƒ¢ãƒ¼ãƒ‰</strong>
                    <div class="method-description">
                        å„åº—èˆ—ã®ä½æ‰€ã‚’ç¢ºèªã—ã¦æ‰‹å‹•ã§åº§æ¨™ã‚’è¨­å®šã€‚ç¢ºå®Ÿã ãŒæ™‚é–“ãŒã‹ã‹ã‚‹ã€‚
                    </div>
                </div>
            </div>
        </div>
        
        <div class="api-config" id="googleApiConfig" style="display: none;">
            <h4>ğŸ”‘ Google Geocoding APIè¨­å®š</h4>
            <p>Google Cloud Consoleã§Geocoding APIã‚’æœ‰åŠ¹ã«ã—ã¦ã€APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <input type="text" id="googleApiKey" class="api-input" placeholder="Google Cloud Platform API Key ã‚’å…¥åŠ›">
            <p><small>APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•: <a href="https://developers.google.com/maps/documentation/geocoding/get-api-key" target="_blank">Google Maps Platform</a></small></p>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="startAddressExtraction()">
                <i class="fas fa-search"></i> 1. ä½æ‰€æŠ½å‡ºé–‹å§‹
            </button>
            
            <button class="btn" id="geocodeBtn" onclick="startGeocoding()" disabled>
                <i class="fas fa-map-marker-alt"></i> 2. ä½æ‰€â†’åº§æ¨™å¤‰æ›
            </button>
            
            <button class="btn danger" id="updateBtn" onclick="updateCoordinates()" disabled>
                <i class="fas fa-database"></i> 3. åº§æ¨™æ›´æ–°å®Ÿè¡Œ
            </button>
            
            <button class="btn success" onclick="verifyResults()" id="verifyBtn" style="display: none;">
                <i class="fas fa-check"></i> 4. çµæœç¢ºèª
            </button>
        </div>
        
        <div class="progress-section" id="progressSection">
            <h4>é€²è¡ŒçŠ¶æ³</h4>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText">å¾…æ©Ÿä¸­...</div>
        </div>
        
        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <i class="fas fa-list"></i> ä½æ‰€æŠ½å‡ºãƒ»åº§æ¨™å¤‰æ›çµæœ
            </div>
            <div class="results-content" id="resultsContent"></div>
        </div>
        
        <div class="log-section" id="logSection">
            <div id="logContent">ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°:\n</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://lywfaolwvkewuouvkzlk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5d2Zhb2x3dmtld3VvdXZremxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDg2NjcsImV4cCI6MjA2OTk4NDY2N30.wBGCHOLbP6ew7Bnvxrq0sKSm1EnHk5NNE1sWWH7ff60';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let allStores = [];
        let addressData = [];
        let coordinateData = [];
        let selectedMethod = 'nominatim';
        
        function log(message) {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            logContent.textContent += `[${timestamp}] ${message}\n`;
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function detectMichinoriBento(store) {
            // ã¿ã¡ã®ã‚Šå¼å½“ã‚’ç¢ºå®Ÿã«æ¤œçŸ¥ã™ã‚‹ãŸã‚ã®å¤šé‡ãƒã‚§ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ 
            const detectionRules = [
                {
                    name: 'exact_name_match',
                    check: () => store.name === 'ã¿ã¡ã®ã‚Šå¼å½“',
                    priority: 100
                },
                {
                    name: 'name_contains_michinori_bento',
                    check: () => store.name && store.name.includes('ã¿ã¡ã®ã‚Šå¼å½“'),
                    priority: 95
                },
                {
                    name: 'name_michinori_and_bento',
                    check: () => store.name && store.name.includes('ã¿ã¡ã®ã‚Š') && store.name.includes('å¼å½“'),
                    priority: 90
                },
                {
                    name: 'name_michinori_exclude_tei',
                    check: () => store.name && store.name.includes('ã¿ã¡ã®ã‚Š') && !store.name.includes('äº­'),
                    priority: 85
                },
                {
                    name: 'address_joshin_4_6',
                    check: () => store.address && store.address.includes('æµ„å¿ƒ1ä¸ç›®4-6'),
                    priority: 95
                },
                {
                    name: 'address_joshin_nishiku',
                    check: () => store.address && store.address.includes('è¥¿åŒº') && store.address.includes('æµ„å¿ƒ'),
                    priority: 80
                },
                {
                    name: 'category_bento_related',
                    check: () => store.category && (store.category.includes('å¼å½“') || store.category.includes('å’Œé£Ÿ')),
                    priority: 20
                },
                {
                    name: 'description_gluten_free',
                    check: () => store.description && (
                        store.description.includes('ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼') || 
                        store.description.includes('å°éº¦ä¸ä½¿ç”¨') ||
                        store.description.includes('naco')
                    ),
                    priority: 30
                },
                {
                    name: 'url_contains_gf_michinori',
                    check: () => {
                        const allValues = Object.values(store).join(' ');
                        return allValues.includes('gf-michinori') || allValues.includes('michinori');
                    },
                    priority: 70
                },
                {
                    name: 'phone_or_contact_info',
                    check: () => {
                        const allValues = Object.values(store).join(' ');
                        return allValues.includes('052-508-6615') || allValues.includes('0525086615');
                    },
                    priority: 90
                }
            ];
            
            let maxPriority = 0;
            let matchedRule = null;
            let matchedRules = [];
            
            // å…¨ãƒ«ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
            detectionRules.forEach(rule => {
                try {
                    if (rule.check()) {
                        matchedRules.push(rule.name);
                        if (rule.priority > maxPriority) {
                            maxPriority = rule.priority;
                            matchedRule = rule.name;
                        }
                    }
                } catch (error) {
                    // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ãªå ´åˆãŒã‚ã‚‹ãŸã‚ï¼‰
                }
            });
            
            // åˆ¤å®šé–¾å€¤ï¼šå„ªå…ˆåº¦80ä»¥ä¸Šã¾ãŸã¯è¤‡æ•°ãƒ«ãƒ¼ãƒ«ãƒãƒƒãƒã§ç¢ºå®š
            const isMatch = maxPriority >= 80 || matchedRules.length >= 3;
            
            if (isMatch) {
                log(`ğŸ¯ ã¿ã¡ã®ã‚Šå¼å½“æ¤œçŸ¥æˆåŠŸ: åº—å="${store.name}", æœ€é«˜å„ªå…ˆåº¦=${maxPriority}, ãƒãƒƒãƒãƒ«ãƒ¼ãƒ«=[${matchedRules.join(', ')}]`);
            }
            
            return {
                isMatch: isMatch,
                method: matchedRule || 'multiple_rules',
                priority: maxPriority,
                matchedRules: matchedRules
            };
        }
        
        function updateProgress(current, total, message) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const percentage = total > 0 ? (current / total) * 100 : 0;
            
            progressFill.style.width = percentage + '%';
            progressText.textContent = `${message} (${current}/${total}) - ${percentage.toFixed(1)}%`;
        }
        
        function selectMethod(method) {
            selectedMethod = method;
            
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³æ›´æ–°
            document.querySelectorAll('input[name="method"]').forEach(radio => {
                radio.checked = radio.value === method;
            });
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤ºæ›´æ–°
            document.querySelectorAll('.method-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Google APIè¨­å®šè¡¨ç¤ºåˆ¶å¾¡
            const googleApiConfig = document.getElementById('googleApiConfig');
            if (method === 'google') {
                googleApiConfig.style.display = 'block';
            } else {
                googleApiConfig.style.display = 'none';
            }
            
            log(`åº§æ¨™å–å¾—æ–¹æ³•ã‚’ã€Œ${method}ã€ã«è¨­å®šã—ã¾ã—ãŸ`);
        }
        
        async function startAddressExtraction() {
            log('ä½æ‰€æŠ½å‡ºå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...');
            
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('logSection').style.display = 'block';
            
            try {
                // å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿å–å¾—
                updateProgress(0, 0, 'ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­');
                const { data: stores, error } = await supabase
                    .from('stores')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                
                allStores = stores || [];
                log(`${allStores.length}åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`);
                
                // å„åº—èˆ—ã®ä½æ‰€æŠ½å‡º
                addressData = [];
                
                for (let i = 0; i < allStores.length; i++) {
                    const store = allStores[i];
                    updateProgress(i + 1, allStores.length, 'ä½æ‰€æŠ½å‡ºä¸­');
                    
                    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½æ‰€ã‚’å„ªå…ˆä½¿ç”¨
                    let address = store.address;
                    let addressSource = 'database';
                    
                    // ã¿ã¡ã®ã‚Šå¼å½“ã‚’ç¢ºå®Ÿã«æ¤œçŸ¥ã™ã‚‹ãŸã‚ã®å¤šé‡ãƒã‚§ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ 
                    const isMichinoriBento = detectMichinoriBento(store);
                    
                    if (isMichinoriBento.isMatch) {
                        address = 'æ„›çŸ¥çœŒåå¤å±‹å¸‚è¥¿åŒºæµ„å¿ƒ1ä¸ç›®4-6';
                        addressSource = 'michinori_detection';
                        log(`ğŸ¯ ã¿ã¡ã®ã‚Šå¼å½“ã‚’ç¢ºå®Ÿã«æ¤œçŸ¥: ${store.name} (æ¤œçŸ¥æ–¹æ³•: ${isMichinoriBento.method})`);
                    } else {
                        // ãã®ä»–ã®ç‰¹å®šåº—èˆ—ã®æ—¢çŸ¥ä½æ‰€ã‚’ä½¿ç”¨
                        const knownAddresses = {
                            'ã¿ã¡ã®ã‚Šäº­': 'æ„›çŸ¥çœŒåå¤å±‹å¸‚ä¸­æ‘åŒºæ¤¿ç”º8-7-2F'
                        };
                        
                        for (const [storeName, knownAddress] of Object.entries(knownAddresses)) {
                            if (store.name && store.name.includes(storeName)) {
                                address = knownAddress;
                                addressSource = 'known_address';
                                log(`æ—¢çŸ¥ä½æ‰€ã‚’ä½¿ç”¨: ${store.name} -> ${address}`);
                                break;
                            }
                        }
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä½æ‰€ãŒãªã„å ´åˆã€URLã‹ã‚‰æŠ½å‡ºã‚’è©¦è¡Œ
                    if (!address || address.trim() === '') {
                        const extractedAddress = extractAddressFromGoogleMaps(store);
                        if (extractedAddress) {
                            address = extractedAddress;
                            addressSource = 'url_extraction';
                        }
                    }
                    
                    addressData.push({
                        store: store,
                        address: address,
                        addressSource: addressSource,
                        status: address ? 'success' : 'error'
                    });
                    
                    if (address) {
                        log(`âœ“ ${store.name}: ä½æ‰€å–å¾—æˆåŠŸ - ${address}`);
                    } else {
                        log(`âœ— ${store.name}: ä½æ‰€å–å¾—å¤±æ•—`);
                    }
                    
                    // UIæ›´æ–°ã®ãŸã‚ã®å°ä¼‘æ­¢
                    if (i % 10 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                
                const successCount = addressData.filter(item => item.status === 'success').length;
                log(`ä½æ‰€æŠ½å‡ºå®Œäº†: ${successCount}/${allStores.length}åº—èˆ—ã§ä½æ‰€ã‚’å–å¾—`);
                
                // çµæœè¡¨ç¤º
                displayAddressResults();
                
                // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’æœ‰åŠ¹åŒ–
                document.getElementById('geocodeBtn').disabled = false;
                
            } catch (error) {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        function extractAddressFromGoogleMaps(store) {
            const urlFields = ['google_maps_url', 'maps_url', 'url', 'link', 'google_maps', 'map_link', 'website'];
            let mapUrl = null;
            
            // Googleãƒãƒƒãƒ—URLã‚’æ¢ã™
            for (const field of urlFields) {
                if (store[field] && typeof store[field] === 'string' && 
                    (store[field].includes('google') || store[field].includes('maps'))) {
                    mapUrl = store[field];
                    break;
                }
            }
            
            if (!mapUrl) {
                for (const [key, value] of Object.entries(store)) {
                    if (typeof value === 'string' && (
                        value.includes('maps.google') || 
                        value.includes('goo.gl/maps')
                    )) {
                        mapUrl = value;
                        break;
                    }
                }
            }
            
            if (!mapUrl) return null;
            
            // URLãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ä½æ‰€ã‚‰ã—ãéƒ¨åˆ†ã‚’æŠ½å‡º
            try {
                const decodedUrl = decodeURIComponent(mapUrl);
                
                // place/ ã®å¾Œã®éƒ¨åˆ†ã‚’æŠ½å‡º
                const placeMatch = decodedUrl.match(/\/place\/([^\/\?]+)/);
                if (placeMatch) {
                    const placeName = placeMatch[1].replace(/\+/g, ' ');
                    // ä½æ‰€ã‚‰ã—ãæ–‡å­—åˆ—ã‚’æŠ½å‡ºï¼ˆæ—¥æœ¬èªã€æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã‚’å«ã‚€ï¼‰
                    if (/[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¯]/.test(placeName)) {
                        return placeName;
                    }
                }
                
                // query parameter ã‹ã‚‰æŠ½å‡º
                const queryMatch = decodedUrl.match(/[?&]q=([^&]+)/);
                if (queryMatch) {
                    const query = queryMatch[1].replace(/\+/g, ' ');
                    if (/[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¯]/.test(query)) {
                        return query;
                    }
                }
                
            } catch (e) {
                // URLãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
            }
            
            return null;
        }
        
        function displayAddressResults() {
            const resultsContent = document.getElementById('resultsContent');
            let resultsHtml = '';
            
            addressData.forEach((item, index) => {
                const store = item.store;
                const statusClass = item.status;
                const statusText = {
                    'success': 'æˆåŠŸ',
                    'error': 'ã‚¨ãƒ©ãƒ¼'
                }[item.status];
                
                resultsHtml += `
                    <div class="store-result">
                        <div class="store-name">${store.name}</div>
                        <div class="address-info">
                            ${item.address || 'ä½æ‰€ãªã—'}
                            <br><small>ã‚½ãƒ¼ã‚¹: ${item.addressSource === 'database' ? 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹' : 'URLæŠ½å‡º'}</small>
                        </div>
                        <div class="coordinate-info">
                            å¤‰æ›å¾…ã¡...
                        </div>
                        <div class="status-badge ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                `;
            });
            
            resultsContent.innerHTML = resultsHtml;
            document.getElementById('resultsSection').style.display = 'block';
        }
        
        async function startGeocoding() {
            if (selectedMethod === 'google') {
                const apiKey = document.getElementById('googleApiKey').value.trim();
                if (!apiKey) {
                    alert('Google API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
            }
            
            log(`${selectedMethod}ã‚’ä½¿ç”¨ã—ã¦ä½æ‰€â†’åº§æ¨™å¤‰æ›ã‚’é–‹å§‹ã—ã¾ã™...`);
            
            coordinateData = [];
            const validAddressData = addressData.filter(item => item.status === 'success');
            
            for (let i = 0; i < validAddressData.length; i++) {
                const item = validAddressData[i];
                updateProgress(i + 1, validAddressData.length, 'åº§æ¨™å¤‰æ›ä¸­');
                
                try {
                    let coordinates = null;
                    
                    // ã¾ãšã¿ã¡ã®ã‚Šå¼å½“ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
                    const michinoriDetection = detectMichinoriBento(item.store);
                    if (michinoriDetection.isMatch) {
                        // ã¿ã¡ã®ã‚Šå¼å½“ã¯ç¢ºå®Ÿã«æ­£ç¢ºãªåº§æ¨™ã‚’è¨­å®š
                        coordinates = { 
                            lat: 35.193814797252664, 
                            lng: 136.89012908157014 
                        };
                        log(`ğŸ¯ ã¿ã¡ã®ã‚Šå¼å½“æ¤œçŸ¥ã«ã‚ˆã‚Šæ­£ç¢ºãªåº§æ¨™ã‚’è¨­å®š: (${coordinates.lat}, ${coordinates.lng})`);
                    } else {
                        // ãã®ä»–ã®åº—èˆ—ã¯é€šå¸¸ã®å‡¦ç†
                        if (selectedMethod === 'nominatim') {
                            coordinates = await geocodeWithNominatim(item.address, item.store);
                        } else if (selectedMethod === 'google') {
                            const apiKey = document.getElementById('googleApiKey').value.trim();
                            coordinates = await geocodeWithGoogle(item.address, apiKey);
                        }
                    }
                    
                    if (coordinates) {
                        coordinateData.push({
                            store: item.store,
                            address: item.address,
                            coordinates: coordinates,
                            status: 'success'
                        });
                        log(`âœ“ ${item.store.name}: åº§æ¨™å–å¾—æˆåŠŸ (${coordinates.lat}, ${coordinates.lng})`);
                    } else {
                        // åº§æ¨™å–å¾—å¤±æ•—æ™‚ã¯æ¨å®šã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
                        const estimatedCoords = estimateCoordinatesFromAddress(item.address, item.store);
                        if (estimatedCoords) {
                            coordinateData.push({
                                store: item.store,
                                address: item.address,
                                coordinates: estimatedCoords,
                                status: 'success'
                            });
                            log(`ğŸ“ ${item.store.name}: æ¨å®šåº§æ¨™ã‚’ä½¿ç”¨ (${estimatedCoords.lat}, ${estimatedCoords.lng})`);
                        } else {
                            coordinateData.push({
                                store: item.store,
                                address: item.address,
                                coordinates: null,
                                status: 'error'
                            });
                            log(`âœ— ${item.store.name}: åº§æ¨™å–å¾—å¤±æ•—`);
                        }
                    }
                    
                    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                } catch (error) {
                    log(`âœ— ${item.store.name}: ã‚¨ãƒ©ãƒ¼ - ${error.message}`);
                    coordinateData.push({
                        store: item.store,
                        address: item.address,
                        coordinates: null,
                        status: 'error'
                    });
                }
                
                // çµæœã‚’å³åº§ã«è¡¨ç¤ºæ›´æ–°
                updateResultsDisplay();
            }
            
            const successCount = coordinateData.filter(item => item.status === 'success').length;
            log(`åº§æ¨™å¤‰æ›å®Œäº†: ${successCount}/${validAddressData.length}ä»¶ã§æˆåŠŸ`);
            
            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’æœ‰åŠ¹åŒ–
            if (successCount > 0) {
                document.getElementById('updateBtn').disabled = false;
            }
        }
        
        async function geocodeWithNominatim(address, store = null) {
            // CORSå›é¿ã®ãŸã‚ã€JSONPé¢¨ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¾ãŸã¯ãƒ—ãƒ­ã‚­ã‚·ä½¿ç”¨
            try {
                // æ–¹æ³•1: allorigins.win ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒ“ã‚¹ä½¿ç”¨
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=jp&limit=1`)}`;
                
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    throw new Error(`Proxy HTTP ${response.status}`);
                }
                
                const proxyData = await response.json();
                const data = JSON.parse(proxyData.contents);
                
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                
                return null;
                
            } catch (error) {
                // ãƒ—ãƒ­ã‚­ã‚·ãŒå¤±æ•—ã—ãŸå ´åˆã€åº§æ¨™æ¨å®šã‚·ã‚¹ãƒ†ãƒ ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                log(`Nominatimå¤±æ•—ã€åº§æ¨™æ¨å®šã‚’ä½¿ç”¨: ${error.message}`);
                // ç¾åœ¨å‡¦ç†ä¸­ã®åº—èˆ—æƒ…å ±ã‚‚æ¸¡ã—ã¦ã¿ã¡ã®ã‚Šå¼å½“ã‚’ç¢ºå®Ÿã«æ¤œçŸ¥
                return estimateCoordinatesFromAddress(address, store);
            }
        }
        
        function estimateCoordinatesFromAddress(address, store = null) {
            // ã¿ã¡ã®ã‚Šå¼å½“ã‚’ç¢ºå®Ÿã«æ¤œçŸ¥ã—ã¦æ­£ç¢ºãªåº§æ¨™ã‚’è¿”ã™
            if (store) {
                const michinoriDetection = detectMichinoriBento(store);
                if (michinoriDetection.isMatch) {
                    log(`ğŸ¯ ã¿ã¡ã®ã‚Šå¼å½“ã®æ­£ç¢ºãªåº§æ¨™ã‚’ä½¿ç”¨: (${35.193814797252664}, ${136.89012908157014})`);
                    return { 
                        lat: 35.193814797252664, 
                        lng: 136.89012908157014 
                    };
                }
            }
            
            // ãã®ä»–ã®ç‰¹å®šåº—èˆ—ã®æ­£ç¢ºãªåº§æ¨™
            const knownStores = {
                'ã¿ã¡ã®ã‚Šå¼å½“': { lat: 35.193814797252664, lng: 136.89012908157014 },
                'ã¿ã¡ã®ã‚Šäº­': { lat: 35.1694, lng: 136.8790 }
            };
            
            // æ—¢çŸ¥ã®åº—èˆ—ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆä½æ‰€ãƒ™ãƒ¼ã‚¹ï¼‰
            for (const [storeName, coords] of Object.entries(knownStores)) {
                if (address.includes(storeName)) {
                    log(`æ—¢çŸ¥åº—èˆ—ã®åº§æ¨™ã‚’ä½¿ç”¨: ${storeName}`);
                    return coords;
                }
            }
            
            // åå¤å±‹å¸‚ã®ä¸»è¦åœ°åŸŸã®åº§æ¨™ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
            const nagoyaAreas = {
                // åŒºåˆ¥åº§æ¨™
                'ä¸­æ‘åŒº': { lat: 35.1694, lng: 136.8754 },
                'è¥¿åŒº': { lat: 35.1890, lng: 136.8954 },
                'ä¸­åŒº': { lat: 35.1681, lng: 136.9066 },
                'æ˜­å’ŒåŒº': { lat: 35.1475, lng: 136.9342 },
                'ç‘ç©‚åŒº': { lat: 35.1314, lng: 136.9342 },
                'ç†±ç”°åŒº': { lat: 35.1263, lng: 136.9066 },
                'ä¸­å·åŒº': { lat: 35.1475, lng: 136.8398 },
                'æ¸¯åŒº': { lat: 35.1090, lng: 136.8842 },
                'å—åŒº': { lat: 35.0951, lng: 136.9342 },
                'å®ˆå±±åŒº': { lat: 35.2095, lng: 137.0135 },
                'ç·‘åŒº': { lat: 35.0719, lng: 136.9551 },
                'åæ±åŒº': { lat: 35.2017, lng: 137.0246 },
                'å¤©ç™½åŒº': { lat: 35.1408, lng: 137.0135 },
                'æ±åŒº': { lat: 35.1790, lng: 136.9342 },
                'åŒ—åŒº': { lat: 35.1950, lng: 136.9066 },
                'åƒç¨®åŒº': { lat: 35.1734, lng: 136.9551 },
                
                // ä¸»è¦é§…ãƒ»ã‚¨ãƒªã‚¢
                'åå¤å±‹é§…': { lat: 35.1706, lng: 136.8814 },
                'æ „': { lat: 35.1681, lng: 136.9066 },
                'é‡‘å±±': { lat: 35.1439, lng: 136.9006 },
                'æµ„å¿ƒ': { lat: 35.193814797252664, lng: 136.89012908157014 }, // ã¿ã¡ã®ã‚Šå¼å½“ã®æ­£ç¢ºãªä½ç½®
                'ä»Šæ± ': { lat: 35.1590, lng: 136.9342 },
                'è—¤ãŒä¸˜': { lat: 35.2017, lng: 137.0470 },
                'å…«äº‹': { lat: 35.1408, lng: 136.9551 },
                'æ–°ç‘æ©‹': { lat: 35.1263, lng: 136.9342 },
                'å¤§æ›½æ ¹': { lat: 35.1845, lng: 136.9290 },
                
                // è©³ç´°åœ°åŸŸï¼ˆç”ºåãƒ¬ãƒ™ãƒ«ï¼‰
                'æµ„å¿ƒ1ä¸ç›®': { lat: 35.193814797252664, lng: 136.89012908157014 }, // ã¿ã¡ã®ã‚Šå¼å½“ã®ä½æ‰€
                'æ¤¿ç”º': { lat: 35.1694, lng: 136.8790 }, // ã¿ã¡ã®ã‚Šäº­ã®ä½æ‰€
                'æ–°æ „ç”º': { lat: 35.1681, lng: 136.9066 },
                'éŒ¦': { lat: 35.1681, lng: 136.9066 },
                'ä¸¸ã®å†…': { lat: 35.1681, lng: 136.9066 }
            };
            
            // ä½æ‰€ã‹ã‚‰åœ°åŸŸã‚’ç‰¹å®š
            for (const [area, coords] of Object.entries(nagoyaAreas)) {
                if (address.includes(area)) {
                    log(`åº§æ¨™æ¨å®š: ${area}ã‚¨ãƒªã‚¢ã®åº§æ¨™ã‚’ä½¿ç”¨`);
                    return {
                        lat: coords.lat + (Math.random() - 0.5) * 0.01, // å¾®å°ãªãƒ©ãƒ³ãƒ€ãƒ èª¿æ•´
                        lng: coords.lng + (Math.random() - 0.5) * 0.01
                    };
                }
            }
            
            // ç•ªåœ°æƒ…å ±ã‹ã‚‰åº§æ¨™å¾®èª¿æ•´ã‚’è©¦è¡Œ
            const addressMatch = address.match(/(\d+)-(\d+)-(\d+)/);
            if (addressMatch) {
                const [, num1, num2, num3] = addressMatch;
                // ç•ªåœ°ã‚’ä½¿ã£ã¦å¾®èª¿æ•´ï¼ˆç°¡æ˜“çš„ãªæ–¹æ³•ï¼‰
                const latOffset = (parseInt(num1) % 10) * 0.001;
                const lngOffset = (parseInt(num2) % 10) * 0.001;
                
                log(`ç•ªåœ°æƒ…å ±ã‚’ä½¿ç”¨ã—ãŸåº§æ¨™å¾®èª¿æ•´`);
                return {
                    lat: 35.1694 + latOffset,
                    lng: 136.8754 + lngOffset
                };
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: åå¤å±‹é§…å‘¨è¾º
            log(`ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº§æ¨™ã‚’ä½¿ç”¨ï¼ˆåå¤å±‹é§…å‘¨è¾ºï¼‰`);
            return {
                lat: 35.1706,
                lng: 136.8814
            };
        }
        
        async function geocodeWithGoogle(address, apiKey) {
            const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&region=jp&key=${apiKey}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.status === 'OK' && data.results.length > 0) {
                const location = data.results[0].geometry.location;
                return {
                    lat: location.lat,
                    lng: location.lng
                };
            }
            
            throw new Error(`Geocoding failed: ${data.status}`);
        }
        
        function updateResultsDisplay() {
            const resultsContent = document.getElementById('resultsContent');
            let resultsHtml = '';
            
            addressData.forEach((item, index) => {
                const store = item.store;
                const coordItem = coordinateData.find(c => c.store.id === store.id);
                
                let coordinateDisplay = 'å¤‰æ›å¾…ã¡...';
                let statusClass = item.status;
                let statusText = 'å‡¦ç†ä¸­';
                
                if (coordItem) {
                    statusClass = coordItem.status;
                    statusText = coordItem.status === 'success' ? 'æˆåŠŸ' : 'ã‚¨ãƒ©ãƒ¼';
                    
                    if (coordItem.coordinates) {
                        coordinateDisplay = `${coordItem.coordinates.lat.toFixed(6)}, ${coordItem.coordinates.lng.toFixed(6)}`;
                    } else {
                        coordinateDisplay = 'å–å¾—å¤±æ•—';
                    }
                } else if (item.status === 'error') {
                    statusText = 'ä½æ‰€ãªã—';
                    coordinateDisplay = 'å¤‰æ›ä¸å¯';
                }
                
                resultsHtml += `
                    <div class="store-result">
                        <div class="store-name">${store.name}</div>
                        <div class="address-info">
                            ${item.address || 'ä½æ‰€ãªã—'}
                            <br><small>ã‚½ãƒ¼ã‚¹: ${item.addressSource === 'database' ? 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹' : 'URLæŠ½å‡º'}</small>
                        </div>
                        <div class="coordinate-info">
                            ${coordinateDisplay}
                        </div>
                        <div class="status-badge ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                `;
            });
            
            resultsContent.innerHTML = resultsHtml;
        }
        
        async function updateCoordinates() {
            const validCoordinateData = coordinateData.filter(item => item.status === 'success');
            
            if (!confirm(`${validCoordinateData.length}åº—èˆ—ã®åº§æ¨™ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            log('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åº§æ¨™æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã™...');
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < validCoordinateData.length; i++) {
                const item = validCoordinateData[i];
                updateProgress(i + 1, validCoordinateData.length, 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ä¸­');
                
                try {
                    const { data, error } = await supabase
                        .from('stores')
                        .update({
                            latitude: item.coordinates.lat.toString(),
                            longitude: item.coordinates.lng.toString()
                        })
                        .eq('id', item.store.id)
                        .select();
                    
                    if (error) throw error;
                    
                    successCount++;
                    log(`âœ“ ${item.store.name}: åº§æ¨™æ›´æ–°æˆåŠŸ`);
                    
                } catch (error) {
                    errorCount++;
                    log(`âœ— ${item.store.name}: æ›´æ–°å¤±æ•— - ${error.message}`);
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            log(`=== æ›´æ–°å®Œäº† ===`);
            log(`æˆåŠŸ: ${successCount}ä»¶`);
            log(`å¤±æ•—: ${errorCount}ä»¶`);
            
            if (successCount > 0) {
                document.getElementById('verifyBtn').style.display = 'inline-block';
                
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert success';
                alertDiv.innerHTML = `
                    <i class="fas fa-check"></i>
                    <strong>æ›´æ–°å®Œäº†!</strong> ${successCount}åº—èˆ—ã®åº§æ¨™ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚
                `;
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.controls'));
            }
        }
        
        async function verifyResults() {
            log('=== çµæœæ¤œè¨¼é–‹å§‹ ===');
            
            try {
                const { data: stores, error } = await supabase
                    .from('stores')
                    .select('id, name, latitude, longitude')
                    .order('name');
                
                if (error) throw error;
                
                let validCount = 0;
                let invalidCount = 0;
                
                stores.forEach(store => {
                    const lat = parseFloat(store.latitude);
                    const lng = parseFloat(store.longitude);
                    
                    if (isValidCoordinate(lat, lng)) {
                        validCount++;
                    } else {
                        invalidCount++;
                        log(`âš ï¸ ${store.name}: åº§æ¨™ãŒç„¡åŠ¹`);
                    }
                });
                
                log(`=== æ¤œè¨¼çµæœ ===`);
                log(`æœ‰åŠ¹ãªåº§æ¨™: ${validCount}ä»¶`);
                log(`ç„¡åŠ¹ãªåº§æ¨™: ${invalidCount}ä»¶`);
                
                if (invalidCount === 0) {
                    log('ğŸ‰ å…¨åº—èˆ—ã®åº§æ¨™ãŒæ­£å¸¸ã§ã™ï¼');
                }
                
            } catch (error) {
                log(`âŒ æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        function isValidCoordinate(lat, lng) {
            return !isNaN(lat) && !isNaN(lng) && 
                   lat >= -90 && lat <= 90 && 
                   lng >= -180 && lng <= 180 &&
                   lat !== 0 && lng !== 0;
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ä½æ‰€ãƒ™ãƒ¼ã‚¹åº§æ¨™ä¿®æ­£ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
            log('åº§æ¨™å–å¾—æ–¹æ³•ã‚’é¸æŠã—ã¦ã€Œ1. ä½æ‰€æŠ½å‡ºé–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠçŠ¶æ…‹ã‚’è¨­å®š
            document.querySelector('.method-option').classList.add('selected');
        });
    </script>
</body>
</html>